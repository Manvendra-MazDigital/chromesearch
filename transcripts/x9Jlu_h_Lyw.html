<p class="speaker"><span class="line" data-starttime="0"><span class="speakerName">Loreena Lee</span>: All right. </span><span class="line" data-startTime="1">Hi, everyone. </span><span class="line" data-startTime="1">Good afternoon. </span><span class="line" data-startTime="3">My name is Loreena Lee. </span><span class="line" data-startTime="4">I'm an engineer on </span><span class="line" data-startTime="4">the Gmail team. </span><span class="line" data-startTime="5">I've been working recently on </span><span class="line" data-startTime="5">performance mostly and taking </span><span class="line" data-startTime="10">a good look at how much memory </span><span class="line" data-startTime="10">Gmail's been using. </span></p>

<p class="speaker"><span class="line" data-starttime="13"><span class="speakerName">John McCutchan</span>: Hi, everyone. </span><span class="line" data-startTime="13">I'm John McCutchan. </span><span class="line" data-startTime="14">I'm part of Chrome Dev Rel. </span><span class="line" data-startTime="15">And my focus is also on </span><span class="line" data-startTime="15">performance and memory usage. </span></p>

<p class="speaker"><span class="line" data-starttime="19"><span class="speakerName">Loreena Lee</span>: So today we're </span><span class="line" data-startTime="19">going to cover everything from </span><span class="line" data-startTime="21">memory management basics </span><span class="line" data-startTime="21">to garbage collection. </span> <span class="line" data-startTime="24">And we're going to introduce </span><span class="line" data-startTime="24">some tools and techniques to </span><span class="line" data-startTime="26">help you understand how much </span><span class="line" data-startTime="26">memory your app is using. </span> <span class="line" data-startTime="29">So why is this important? </span><span class="line" data-startTime="37">A lot of times when people talk </span><span class="line" data-startTime="37">about performance versus </span><span class="line" data-startTime="39">memory, performance wins </span><span class="line" data-startTime="39">9 times out of 10. </span> <span class="line" data-startTime="43">And this is the trade-off </span><span class="line" data-startTime="43">that people usually say, </span><span class="line" data-startTime="46">performance versus memory? </span><span class="line" data-startTime="47">Let's go ahead and </span><span class="line" data-startTime="47">use more memory. </span></p>

<p class="speaker"><span class="line" data-starttime="49"><span class="speakerName">John McCutchan</span>: So the idea </span><span class="line" data-startTime="49">being that the more memory you </span><span class="line" data-startTime="51">use the better the </span><span class="line" data-startTime="51">performance is? </span></p>

<p class="speaker"><span class="line" data-starttime="53"><span class="speakerName">Loreena Lee</span>: Right. </span> <span class="line" data-startTime="53">So generally, if your caching </span><span class="line" data-startTime="53">more, you're keeping more </span><span class="line" data-startTime="56">resident memory, you have less </span><span class="line" data-startTime="56">fetches to disk, so your </span><span class="line" data-startTime="58">performance is usually </span><span class="line" data-startTime="58">improved. </span> <span class="line" data-startTime="60">And so people were starting </span><span class="line" data-startTime="60">to say that Gmail was </span><span class="line" data-startTime="62">using a lot of memory. </span> <span class="line" data-startTime="63">We started hearing a lot of </span><span class="line" data-startTime="63">anecdotes of people having a </span><span class="line" data-startTime="66">Gmail tab that's using </span><span class="line" data-startTime="66">a whole gig of mem. </span> <span class="line" data-startTime="69">And that seems kind of a lot. </span></p>

<p><span class="line" data-startTime="70">But a lot about the same time </span><span class="line" data-startTime="70">were like, well, who cares? </span><span class="line" data-startTime="72">You have a ton of memory. </span> <span class="line" data-startTime="73">Memory's cheap. </span> <span class="line" data-startTime="74">Why not just use it? </span><span class="line" data-startTime="76">But the time of our users </span><span class="line" data-startTime="76">is very important. </span> <span class="line" data-startTime="79">So if they're spending two to </span><span class="line" data-startTime="79">three seconds waiting for </span><span class="line" data-startTime="82">their app to be responsive, </span><span class="line" data-startTime="82">that's not good. </span> <span class="line" data-startTime="85">We don't want to waste </span><span class="line" data-startTime="85">their time. </span> <span class="line" data-startTime="87">So we'll start using a little </span><span class="line" data-startTime="87">bit more memory, start caching </span><span class="line" data-startTime="90">a little bit more, help them </span><span class="line" data-startTime="90">to get things to be more </span><span class="line" data-startTime="93">responsive. </span> <span class="line" data-startTime="94">But at the same time, what's </span><span class="line" data-startTime="94">worse than having your users </span><span class="line" data-startTime="97">wait two to three seconds? </span><span class="line" data-startTime="100">Having your app crash. </span> <span class="line" data-startTime="102">So this is the "He's </span><span class="line" data-startTime="102">Dead, Jim" sad tab. </span> <span class="line" data-startTime="104">And a lot of you have probably </span><span class="line" data-startTime="104">seen this before. </span></p>

<p><span class="line" data-startTime="106">This is the Chrome sad tab. </span> <span class="line" data-startTime="108">And the "He's dead, Jim" variety </span><span class="line" data-startTime="108">almost always comes as </span><span class="line" data-startTime="111">an out of memory situation. </span> <span class="line" data-startTime="113">So we were starting to hear more </span><span class="line" data-startTime="113">and more stories about </span><span class="line" data-startTime="115">Gmail running out of memory and </span><span class="line" data-startTime="115">people getting sad tabs </span><span class="line" data-startTime="117">because of Gmail. </span> <span class="line" data-startTime="119">But we didn't really have </span><span class="line" data-startTime="119">any data to know </span><span class="line" data-startTime="121">how common this was. </span> <span class="line" data-startTime="123">Our colleagues were telling us, </span><span class="line" data-startTime="123">oh, my Gmail ran out of </span><span class="line" data-startTime="125">memory again, caused my </span><span class="line" data-startTime="125">browser to crash. </span> <span class="line" data-startTime="127">But we didn't know if this is </span><span class="line" data-startTime="127">something that was only </span><span class="line" data-startTime="131">happening to people we knew. </span></p>

<p><span class="line" data-startTime="132">Our power users were having </span><span class="line" data-startTime="132">this situation, but our </span><span class="line" data-startTime="136">parents weren't really </span><span class="line" data-startTime="136">complaining. </span> <span class="line" data-startTime="137">But they only get a couple </span><span class="line" data-startTime="137">mails a day or a </span><span class="line" data-startTime="140">week, in some cases. </span> <span class="line" data-startTime="141">They probably spend a few </span><span class="line" data-startTime="141">minutes on Gmail. </span> <span class="line" data-startTime="143">Whereas people at Google tend </span><span class="line" data-startTime="143">to spend all day, getting </span><span class="line" data-startTime="147">several hundred messages </span><span class="line" data-startTime="147">a day. </span></p>

<p class="speaker"><span class="line" data-starttime="148"><span class="speakerName">John McCutchan</span>: Yeah. </span><span class="line" data-startTime="149">A few emails a minute. </span></p>

<p class="speaker"><span class="line" data-starttime="152"><span class="speakerName">Loreena Lee</span>: But we didn't </span><span class="line" data-startTime="152">have any scientific data. </span> <span class="line" data-startTime="154">We only had anecdotes. </span> <span class="line" data-startTime="155">We had a bunch of tools that </span><span class="line" data-startTime="155">didn't necessarily scale up to </span><span class="line" data-startTime="159">things like applications </span><span class="line" data-startTime="159">as big as Gmail. </span> <span class="line" data-startTime="162">We didn't really know how to </span><span class="line" data-startTime="162">track what was leaking. </span> <span class="line" data-startTime="165">We didn't know how to </span><span class="line" data-startTime="165">find the problems. </span> <span class="line" data-startTime="168">And so we kind of were starting </span><span class="line" data-startTime="168">from nothing. </span> <span class="line" data-startTime="171">So I'm talking a little bit </span><span class="line" data-startTime="171">about Gmail right now. </span> <span class="line" data-startTime="173">But really, this problem </span><span class="line" data-startTime="173">is universal. </span> <span class="line" data-startTime="175">Running out of memory </span><span class="line" data-startTime="175">is something that </span><span class="line" data-startTime="177">everyone can encounter. </span></p>

<p><span class="line" data-startTime="179">And you should care. </span> <span class="line" data-startTime="180">Because I don't know how much </span><span class="line" data-startTime="180">you know about the Chrome </span><span class="line" data-startTime="183">process model, but this isn't </span><span class="line" data-startTime="183">just Gmail's problem. </span> <span class="line" data-startTime="188">So if you see here, I have </span><span class="line" data-startTime="188">a ton of tabs open. </span> <span class="line" data-startTime="190">And Chrome will normally try to </span><span class="line" data-startTime="190">open all of these tabs in </span><span class="line" data-startTime="193">their own renderer process, but </span><span class="line" data-startTime="194">that's not always possible. </span> <span class="line" data-startTime="196">So Chrome has a hard </span><span class="line" data-startTime="196">limit on how many </span><span class="line" data-startTime="198">processes it will fork. </span> <span class="line" data-startTime="199">And once you've exhausted that </span><span class="line" data-startTime="199">limit, it will start putting </span><span class="line" data-startTime="202">multiple tabs in a process. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="204"><span class="speakerName">John McCutchan</span>: So do you mean </span><span class="line" data-startTime="204">if Gmail uses a lot of memory </span><span class="line" data-startTime="208">or some pages a lot of memory, </span><span class="line" data-startTime="208">it might kill five pages? </span></p>

<p class="speaker"><span class="line" data-starttime="210"><span class="speakerName">Loreena Lee</span>: Right. </span><span class="line" data-startTime="211">So if all of these pages are </span><span class="line" data-startTime="211">in the same process, that's </span><span class="line" data-startTime="214">why a lot of times if you do </span><span class="line" data-startTime="214">see this out of memory </span><span class="line" data-startTime="216">situation with the sad tab </span><span class="line" data-startTime="216">you'll notice several of them </span><span class="line" data-startTime="219">at the same time. </span><span class="line" data-startTime="220">It's not just one tab </span><span class="line" data-startTime="220">that's crashing. </span><span class="line" data-startTime="222">It's all of them that are </span><span class="line" data-startTime="222">in that same process. </span><span class="line" data-startTime="225">So this is something that </span><span class="line" data-startTime="225">everyone needs to care about, </span><span class="line" data-startTime="226">not just Gmail, not just your </span><span class="line" data-startTime="226">app, but anyone who ends up in </span><span class="line" data-startTime="230">the same process as your </span><span class="line" data-startTime="230">app will care as well. </span><span class="line" data-startTime="232">Just like anyone who ends up in </span><span class="line" data-startTime="232">the same process as Gmail </span><span class="line" data-startTime="234">will probably be glad that we </span><span class="line" data-startTime="234">are making some effort to </span><span class="line" data-startTime="237">reduce the amount of memory </span><span class="line" data-startTime="237">that we're using. </span></p>

<p class="speaker"><span class="line" data-starttime="242"><span class="speakerName">John McCutchan</span>: All right. </span> <span class="line" data-startTime="242">But before we can tackle </span><span class="line" data-startTime="242">Gmail's problem, it's </span><span class="line" data-startTime="245">important that we go back to </span><span class="line" data-startTime="245">basics and understand both the </span><span class="line" data-startTime="248">conceptual concepts for memory </span><span class="line" data-startTime="248">management in JavaScript as </span><span class="line" data-startTime="253">well as the practical with </span><span class="line" data-startTime="253">V8 in particular. </span> <span class="line" data-startTime="257">So let's first talk about a high </span><span class="line" data-startTime="257">level understanding of </span><span class="line" data-startTime="260">how memory is managed </span><span class="line" data-startTime="260">inside JavaScript. </span> <span class="line" data-startTime="263">So the questions I want you to </span><span class="line" data-startTime="263">be able to answer after this </span><span class="line" data-startTime="267">set of slides is, what types </span><span class="line" data-startTime="267">of values are there in </span><span class="line" data-startTime="269">JavaScript? </span><span class="line" data-startTime="270">How are they organized </span><span class="line" data-startTime="270">in memory? </span><span class="line" data-startTime="272">What is garbage? </span><span class="line" data-startTime="273">And what is a leak? </span><span class="line" data-startTime="274">These are really basic </span><span class="line" data-startTime="274">questions. </span> <span class="line" data-startTime="276">And I'm sure a lot of you know </span><span class="line" data-startTime="276">the answers to these already. </span></p>

<p><span class="line" data-startTime="279">But it's important that we have </span><span class="line" data-startTime="279">really good definitions </span><span class="line" data-startTime="281">of what these are so that we </span><span class="line" data-startTime="281">can understand both the </span><span class="line" data-startTime="284">problem and the tools. </span> <span class="line" data-startTime="287">So JavaScript has very </span><span class="line" data-startTime="287">few value types. </span> <span class="line" data-startTime="290">There's booleans, there's </span><span class="line" data-startTime="290">numbers, there's strings, </span><span class="line" data-startTime="294">there's objects, and then </span><span class="line" data-startTime="294">there's external data. </span> <span class="line" data-startTime="296">And so you'll know that there's </span><span class="line" data-startTime="296">no arrays here. </span> <span class="line" data-startTime="299">And that's actually because </span><span class="line" data-startTime="299">JavaScript as a language </span><span class="line" data-startTime="301">doesn't have arrays. </span> <span class="line" data-startTime="302">They're built on top of the </span><span class="line" data-startTime="302">objects inside JavaScript. </span></p>

<p><span class="line" data-startTime="305">The keys are just the indexes </span><span class="line" data-startTime="305">into the array. </span> <span class="line" data-startTime="309">But this is it. </span> <span class="line" data-startTime="309">This is all that </span><span class="line" data-startTime="309">JavaScript has. </span> <span class="line" data-startTime="313">And the way they're organized </span><span class="line" data-startTime="313">in memory is in a graph. </span> <span class="line" data-startTime="317">You'll see here this </span><span class="line" data-startTime="317">blue node here. </span> <span class="line" data-startTime="319">And this is a root node. </span> <span class="line" data-startTime="320">This is outside of your </span><span class="line" data-startTime="320">application's control, think </span><span class="line" data-startTime="323">document or window. </span> <span class="line" data-startTime="325">This is created by </span><span class="line" data-startTime="325">the browser. </span> <span class="line" data-startTime="327">It's in there as long as your </span><span class="line" data-startTime="327">page is loaded, and you really </span><span class="line" data-startTime="330">can't do anything with it </span><span class="line" data-startTime="330">other than maybe add </span><span class="line" data-startTime="332">properties to it. </span> <span class="line" data-startTime="334">From root nodes, there's </span><span class="line" data-startTime="334">object nodes. </span></p>

<p><span class="line" data-startTime="336">And these are JavaScript </span><span class="line" data-startTime="336">objects. </span> <span class="line" data-startTime="338">And they're the only nodes which </span><span class="line" data-startTime="338">can actually reference </span><span class="line" data-startTime="340">other values inside the graph. </span> <span class="line" data-startTime="343">Terminating the graph are scaler </span><span class="line" data-startTime="343">nodes, like a boolean </span><span class="line" data-startTime="349">or a number. </span> <span class="line" data-startTime="351">These values cannot reference </span><span class="line" data-startTime="351">other values inside the graph. </span> <span class="line" data-startTime="354">So this is it. </span> <span class="line" data-startTime="355">This is how memory is organized </span><span class="line" data-startTime="355">inside JavaScript, </span><span class="line" data-startTime="358">and this is what you, as a </span><span class="line" data-startTime="358">programmer, can observe. </span> <span class="line" data-startTime="361">You have root notes, which are </span><span class="line" data-startTime="361">outside of your control, </span><span class="line" data-startTime="364">objects, which you can extend </span><span class="line" data-startTime="364">and reference other values, </span><span class="line" data-startTime="366">and then the scalar </span><span class="line" data-startTime="366">nodes, which can't </span><span class="line" data-startTime="369">reference anything else. </span> <span class="line" data-startTime="372">So another property that </span><span class="line" data-startTime="372">values can have </span><span class="line" data-startTime="374">are retaining paths. </span> <span class="line" data-startTime="375">And this is a path from the root </span><span class="line" data-startTime="375">node to the value itself. </span></p>

<p><span class="line" data-startTime="379">And so, every value can have one </span><span class="line" data-startTime="379">or more retaining paths. </span> <span class="line" data-startTime="383">And if we look at the green </span><span class="line" data-startTime="383">value on the graph, you can </span><span class="line" data-startTime="385">actually see that there's one </span><span class="line" data-startTime="385">retaining path that starts at </span><span class="line" data-startTime="388">the root node and extends </span><span class="line" data-startTime="388">along the red edge. </span> <span class="line" data-startTime="392">And there's a second retaining </span><span class="line" data-startTime="392">that starts at the root node </span><span class="line" data-startTime="395">and then extends along </span><span class="line" data-startTime="395">these two red edges. </span> <span class="line" data-startTime="397">Both of these are retaining </span><span class="line" data-startTime="397">paths for the green node. </span> <span class="line" data-startTime="399">It keeps the green </span><span class="line" data-startTime="399">node in memory. </span> <span class="line" data-startTime="401">Without a retaining path, the </span><span class="line" data-startTime="401">value becomes garbage. </span></p>

<p><span class="line" data-startTime="404">And we'll get into </span><span class="line" data-startTime="404">that in a moment. </span> <span class="line" data-startTime="408">So again, this is a fairly </span><span class="line" data-startTime="408">basic operation. </span> <span class="line" data-startTime="412">But it's important to understand </span><span class="line" data-startTime="412">exactly how you can </span><span class="line" data-startTime="414">remove a value from the graph. </span> <span class="line" data-startTime="416">So if we want to remove the red </span><span class="line" data-startTime="416">value from the graph, we </span><span class="line" data-startTime="419">could cut this edge right here, </span><span class="line" data-startTime="419">from the root node to </span><span class="line" data-startTime="422">the first green node. </span> <span class="line" data-startTime="423">And then the red value </span><span class="line" data-startTime="423">is garbage. </span> <span class="line" data-startTime="426">If we cut this edge, </span><span class="line" data-startTime="426">it's also garbage. </span> <span class="line" data-startTime="430">Or we cut this edge. </span> <span class="line" data-startTime="431">Any of those three edges </span><span class="line" data-startTime="431">cut would make </span><span class="line" data-startTime="433">the red node garbage. </span> <span class="line" data-startTime="436">So what exactly is garbage? </span><span class="line" data-startTime="438">Well, it's all values which </span><span class="line" data-startTime="438">cannot be reached </span><span class="line" data-startTime="440">from the root node. </span> <span class="line" data-startTime="441">Or said another way, it's </span><span class="line" data-startTime="441">all values that </span><span class="line" data-startTime="443">lack a retaining path. </span> <span class="line" data-startTime="444">If something doesn't have a </span><span class="line" data-startTime="444">retaining path, then it </span><span class="line" data-startTime="447">becomes garbage, like </span><span class="line" data-startTime="447">these nodes here. </span></p>

<p><span class="line" data-startTime="451">You'll see that there is no </span><span class="line" data-startTime="451">path from the root node to </span><span class="line" data-startTime="454">these values, so these values </span><span class="line" data-startTime="454">are actually garbage. </span> <span class="line" data-startTime="456">At some point, they </span><span class="line" data-startTime="456">were on the graph, </span><span class="line" data-startTime="458">and now they're not. </span> <span class="line" data-startTime="459">And at the next garbage </span><span class="line" data-startTime="459">collection process, they'll be </span><span class="line" data-startTime="462">cleaned up, which actually </span><span class="line" data-startTime="462">brings us to garbage </span><span class="line" data-startTime="465">collection. </span> <span class="line" data-startTime="466">So the first step in a garbage </span><span class="line" data-startTime="466">collection pass is to find all </span><span class="line" data-startTime="470">the live values. </span> <span class="line" data-startTime="471">And then the second is to return </span><span class="line" data-startTime="471">the memory used by the </span><span class="line" data-startTime="475">dead values back to the system </span><span class="line" data-startTime="475">so that they can be recycled </span><span class="line" data-startTime="477">later on, as we see here. </span> <span class="line" data-startTime="483">So another property that every </span><span class="line" data-startTime="483">value inside JavaScript has is </span><span class="line" data-startTime="486">its retained size. </span> <span class="line" data-startTime="487">So the retained size, you can </span><span class="line" data-startTime="487">conceptually think about this </span><span class="line" data-startTime="490">as the amount of memory that </span><span class="line" data-startTime="490">would be freed if the value </span><span class="line" data-startTime="493">became garbage. </span></p>

<p><span class="line" data-startTime="494">And so that's the size of </span><span class="line" data-startTime="494">the value and all of its </span><span class="line" data-startTime="497">descendants which lack </span><span class="line" data-startTime="497">retaining paths. </span> <span class="line" data-startTime="499">So if we look at the yellow </span><span class="line" data-startTime="499">node on the graph, its </span><span class="line" data-startTime="503">retained size is its size plus </span><span class="line" data-startTime="503">the size of the green node. </span> <span class="line" data-startTime="506">And if we pull back, the </span><span class="line" data-startTime="506">retained sides of this new </span><span class="line" data-startTime="509">yellow node is both of the green </span><span class="line" data-startTime="509">node size plus itself. </span> <span class="line" data-startTime="512">And if we go all the way back to </span><span class="line" data-startTime="512">the root node, the retained </span><span class="line" data-startTime="515">size is all memory being </span><span class="line" data-startTime="515">used by JavaScript. </span> <span class="line" data-startTime="520">So now let's talk </span><span class="line" data-startTime="520">about a leak. </span> <span class="line" data-startTime="522">A leak is when you, the </span><span class="line" data-startTime="522">programmer, have mistakenly </span><span class="line" data-startTime="526">left a retaining path some </span><span class="line" data-startTime="526">value inside the graph. </span></p>

<p><span class="line" data-startTime="529">You think that the value has no </span><span class="line" data-startTime="529">path, starting from a root </span><span class="line" data-startTime="532">node, getting to it, and that </span><span class="line" data-startTime="532">it'll be collected at the next </span><span class="line" data-startTime="535">garbage collection cycle. </span> <span class="line" data-startTime="537">But you've accidentally </span><span class="line" data-startTime="537">left a retaining path. </span> <span class="line" data-startTime="540">So it's a program error, as </span><span class="line" data-startTime="540">all memory leaks are. </span> <span class="line" data-startTime="543">If we look at this really simple </span><span class="line" data-startTime="543">example that's kind of </span><span class="line" data-startTime="546">Gmail themed, we have an email </span><span class="line" data-startTime="546">object and we have the message </span><span class="line" data-startTime="549">field inside of it. </span> <span class="line" data-startTime="551">And we assign that to be </span><span class="line" data-startTime="551">a div node in the dom. </span></p>

<p><span class="line" data-startTime="554">We then want to display these </span><span class="line" data-startTime="554">email messages, so we add that </span><span class="line" data-startTime="557">div node into a display </span><span class="line" data-startTime="557">list as well. </span> <span class="line" data-startTime="562">So this is what the object </span><span class="line" data-startTime="562">graph looks like after </span><span class="line" data-startTime="564">running this code. </span> <span class="line" data-startTime="565">Somewhere, starting at the root </span><span class="line" data-startTime="565">node, there's paths to </span><span class="line" data-startTime="568">both email and display. </span> <span class="line" data-startTime="570">And then off of email, there's </span><span class="line" data-startTime="570">a path to message. </span> <span class="line" data-startTime="573">And there's a special </span><span class="line" data-startTime="573">kind of edge from </span><span class="line" data-startTime="576">message to the Div Node. </span> <span class="line" data-startTime="577">And this is pinning a native </span><span class="line" data-startTime="577">object, an external object </span><span class="line" data-startTime="580">that's not directly related </span><span class="line" data-startTime="580">to JavaScript. </span> <span class="line" data-startTime="584">But this is the way it looks. </span> <span class="line" data-startTime="585">You follow the other path. </span></p>

<p><span class="line" data-startTime="586">You go from display, and then </span><span class="line" data-startTime="586">you have this list of div </span><span class="line" data-startTime="589">elements, terminating with the </span><span class="line" data-startTime="589">div node that we just created </span><span class="line" data-startTime="592">on the previous slide. </span></p>

<p class="speaker"><span class="line" data-starttime="593"><span class="speakerName">Loreena Lee</span>: So everything </span><span class="line" data-startTime="593">here, the green nodes are </span><span class="line" data-startTime="595">JavaScript objects, and the </span><span class="line" data-startTime="595">yellow are actual dom nodes? </span></p>

<p class="speaker"><span class="line" data-starttime="598"><span class="speakerName">John McCutchan</span>: Yes. </span> <span class="line" data-startTime="598">Yeah. </span> <span class="line" data-startTime="598">They're external to </span><span class="line" data-startTime="598">the JavaScript. </span> <span class="line" data-startTime="602">So at some point later on, </span><span class="line" data-startTime="602">we're done looking at </span><span class="line" data-startTime="604">messages, and we want to just </span><span class="line" data-startTime="604">clean out the display list. </span> <span class="line" data-startTime="606">So the programmer writes </span><span class="line" data-startTime="606">removeAllChildren, Children </span><span class="line" data-startTime="608">and you think, OK, all those </span><span class="line" data-startTime="608">div nodes are gone. </span> <span class="line" data-startTime="611">But whoops, we've actually </span><span class="line" data-startTime="611">cached a reference from the </span><span class="line" data-startTime="615">message object to </span><span class="line" data-startTime="615">the div node. </span> <span class="line" data-startTime="617">So until the email itself is </span><span class="line" data-startTime="617">removed from the system, which </span><span class="line" data-startTime="621">could take forever and might not </span><span class="line" data-startTime="621">ever happen, this div node </span><span class="line" data-startTime="624">will be pinned in memory, </span><span class="line" data-startTime="624">and we've leaked it. </span> <span class="line" data-startTime="629">So in general, the really basics </span><span class="line" data-startTime="629">of memory management in </span><span class="line" data-startTime="633">JavaScript are that </span><span class="line" data-startTime="633">the values are all </span><span class="line" data-startTime="635">organized inside this graph. </span></p>

<p><span class="line" data-startTime="637">And they have retaining paths. </span> <span class="line" data-startTime="639">And any value that </span><span class="line" data-startTime="639">lacks a retaining </span><span class="line" data-startTime="641">path has become garbage. </span> <span class="line" data-startTime="644">And then there's </span><span class="line" data-startTime="644">retained sizes. </span> <span class="line" data-startTime="645">And that's the amount of memory </span><span class="line" data-startTime="645">that you're going to </span><span class="line" data-startTime="646">free up when the value itself </span><span class="line" data-startTime="646">becomes garbage. </span> <span class="line" data-startTime="652">So let's go from the general to </span><span class="line" data-startTime="652">the specific and talk about </span><span class="line" data-startTime="656">the way V8 manages </span><span class="line" data-startTime="656">memory and what </span><span class="line" data-startTime="659">happens during a GC Pause. </span> <span class="line" data-startTime="662">The first question you want to </span><span class="line" data-startTime="662">ask yourself is, what's the </span><span class="line" data-startTime="664">cost in allocating memory </span><span class="line" data-startTime="664">in JavaScript? </span><span class="line" data-startTime="667">And it's not the call to new. </span></p>

<p><span class="line" data-startTime="669">Typically, the call to new </span><span class="line" data-startTime="669">is incredibly fast. </span> <span class="line" data-startTime="674">It's very, very quick, until </span><span class="line" data-startTime="674">you've exhausted a memory </span><span class="line" data-startTime="677">pool, and we'll get to </span><span class="line" data-startTime="677">this in a moment of </span><span class="line" data-startTime="679">what's actually happening. </span> <span class="line" data-startTime="681">But at that point, the runtime </span><span class="line" data-startTime="681">is forced to do a garbage </span><span class="line" data-startTime="683">collection. </span> <span class="line" data-startTime="683">And this is where all </span><span class="line" data-startTime="683">the time is spent. </span> <span class="line" data-startTime="686">And it can actually </span><span class="line" data-startTime="686">take milliseconds. </span> <span class="line" data-startTime="688">So if you're writing a game, you </span><span class="line" data-startTime="688">have 16 milliseconds to do </span><span class="line" data-startTime="692">everything inside </span><span class="line" data-startTime="692">of your frame. </span> <span class="line" data-startTime="693">And a garbage collection pause </span><span class="line" data-startTime="693">might pause your application </span><span class="line" data-startTime="696">for 5, maybe 10 milliseconds, </span><span class="line" data-startTime="696">which for Gmail might be OK, </span><span class="line" data-startTime="700">but for some applications </span><span class="line" data-startTime="700">it's really too long. </span> <span class="line" data-startTime="704">So it's important to be aware </span><span class="line" data-startTime="704">at the pattern at which your </span><span class="line" data-startTime="707">application is allocating </span><span class="line" data-startTime="707">objects and understand how it </span><span class="line" data-startTime="712">interacts with the garbage </span><span class="line" data-startTime="712">collector. </span> <span class="line" data-startTime="714">And this is what we're going </span><span class="line" data-startTime="714">to talk about right now. </span></p>

<p><span class="line" data-startTime="717">V8 manages memory in </span><span class="line" data-startTime="717">two generations. </span> <span class="line" data-startTime="720">There's the young generation and </span><span class="line" data-startTime="720">then the old generation. </span> <span class="line" data-startTime="722">And by young and old, I mean </span><span class="line" data-startTime="722">how long has the JavaScript </span><span class="line" data-startTime="727">value existed for. </span> <span class="line" data-startTime="729">And over time, young values get </span><span class="line" data-startTime="729">promoted to old values. </span> <span class="line" data-startTime="734">So after a few garbage </span><span class="line" data-startTime="734">collections, if the value </span><span class="line" data-startTime="736">survives, meaning that there's a </span><span class="line" data-startTime="736">retaining path and it's kept </span><span class="line" data-startTime="740">in memory, eventually the value </span><span class="line" data-startTime="740">gets promoted into the </span><span class="line" data-startTime="743">old generation. </span> <span class="line" data-startTime="745">So what are the properties of </span><span class="line" data-startTime="745">the young generation in V8? </span><span class="line" data-startTime="749">Well, it offers really fast </span><span class="line" data-startTime="749">allocation, fast collection, </span><span class="line" data-startTime="753">and it's frequently collected. </span> <span class="line" data-startTime="755">In fact, when you're using the </span><span class="line" data-startTime="755">Timeline tool and you see the </span><span class="line" data-startTime="758">GC Event on it, this is a young </span><span class="line" data-startTime="758">generation collection. </span></p>

<p><span class="line" data-startTime="768">In contrast, the old generation </span><span class="line" data-startTime="768">offers fast </span><span class="line" data-startTime="771">allocation, but the collection </span><span class="line" data-startTime="771">is much slower. </span> <span class="line" data-startTime="775">The good thing is that it's very </span><span class="line" data-startTime="775">infrequently collected. </span> <span class="line" data-startTime="778">And some of the old generation's </span><span class="line" data-startTime="778">collection occurs </span><span class="line" data-startTime="780">in parallel with your </span><span class="line" data-startTime="780">page's execution. </span> <span class="line" data-startTime="783">Whereas a young generation </span><span class="line" data-startTime="783">collection, is really just </span><span class="line" data-startTime="786">everything is stopped, the </span><span class="line" data-startTime="786">collection occurs, and then </span><span class="line" data-startTime="789">your page resumes. </span> <span class="line" data-startTime="790">Old generation mixes a little </span><span class="line" data-startTime="790">bit of collection with your </span><span class="line" data-startTime="795">page's execution. </span> <span class="line" data-startTime="798">So I want to focus mostly on </span><span class="line" data-startTime="798">young generation, because this </span><span class="line" data-startTime="801">is where you're going to feel </span><span class="line" data-startTime="801">the pain inside your </span><span class="line" data-startTime="804">application. </span> <span class="line" data-startTime="805">And it's going to happen </span><span class="line" data-startTime="805">fairly regularly. </span> <span class="line" data-startTime="810">It's important to understand </span><span class="line" data-startTime="810">why collecting the young </span><span class="line" data-startTime="813">generation is faster. </span></p>

<p><span class="line" data-startTime="815">And intuitively, you have to </span><span class="line" data-startTime="815">understand that the cost of </span><span class="line" data-startTime="819">the GC Pause is actually </span><span class="line" data-startTime="819">proportional to the number of </span><span class="line" data-startTime="822">live objects. </span> <span class="line" data-startTime="823">And because the objects are </span><span class="line" data-startTime="823">split into the young and the </span><span class="line" data-startTime="826">old generation, the </span><span class="line" data-startTime="826">young generation, </span><span class="line" data-startTime="828">actually not much survives. </span> <span class="line" data-startTime="831">After a garbage collection, </span><span class="line" data-startTime="831">most of the values in the </span><span class="line" data-startTime="833">young generation </span><span class="line" data-startTime="833">don't make it. </span> <span class="line" data-startTime="836">They have no retaining path, </span><span class="line" data-startTime="836">because they were used just </span><span class="line" data-startTime="838">briefly, and they're gone, </span><span class="line" data-startTime="838">and they're not </span><span class="line" data-startTime="840">really in the graph. </span> <span class="line" data-startTime="841">Whereas by their nature, objects </span><span class="line" data-startTime="841">in the old generation </span><span class="line" data-startTime="845">have survived quite </span><span class="line" data-startTime="845">a long time. </span> <span class="line" data-startTime="847">So you can't expect that when a </span><span class="line" data-startTime="847">collection is triggered for </span><span class="line" data-startTime="850">the old generation </span><span class="line" data-startTime="850">that many of them </span><span class="line" data-startTime="851">are going to disappear. </span> <span class="line" data-startTime="853">So knowing that the cost of the </span><span class="line" data-startTime="853">garbage collection pause </span><span class="line" data-startTime="856">really comes down to the number </span><span class="line" data-startTime="856">of live objects, it </span><span class="line" data-startTime="859">becomes quite clear why </span><span class="line" data-startTime="859">collecting the young </span><span class="line" data-startTime="861">generations so much faster. </span></p>

<p><span class="line" data-startTime="864">So let's look at the young </span><span class="line" data-startTime="864">generation in action. </span> <span class="line" data-startTime="867">The young generation </span><span class="line" data-startTime="867">is split into two </span><span class="line" data-startTime="869">semispaces, equally sized. </span> <span class="line" data-startTime="872">There's the To Space </span><span class="line" data-startTime="872">and the From Space. </span> <span class="line" data-startTime="874">The To Space is where values </span><span class="line" data-startTime="874">that you allocate when your </span><span class="line" data-startTime="878">page executes, like, new Foo, </span><span class="line" data-startTime="878">it's coming out of To Space. </span> <span class="line" data-startTime="882">The From Space actually just </span><span class="line" data-startTime="882">sits there not being used </span><span class="line" data-startTime="886">until later on. </span> <span class="line" data-startTime="887">And we'll see what </span><span class="line" data-startTime="887">happens with it. </span> <span class="line" data-startTime="892">So assuming that To Space </span><span class="line" data-startTime="892">started off empty and your </span><span class="line" data-startTime="895">page starts allocated </span><span class="line" data-startTime="895">some objects. </span> <span class="line" data-startTime="897">It does new A and then new B, </span><span class="line" data-startTime="897">new C, and new D. Everything </span><span class="line" data-startTime="902">up until this point has been </span><span class="line" data-startTime="902">really fast, and there's been </span><span class="line" data-startTime="904">no interruption in your </span><span class="line" data-startTime="904">page's execution. </span></p>

<p><span class="line" data-startTime="908">But then, your page calls </span><span class="line" data-startTime="908">new E. And actually, </span><span class="line" data-startTime="911">it's just too big. </span> <span class="line" data-startTime="912">It doesn't fit into </span><span class="line" data-startTime="912">the To Space. </span> <span class="line" data-startTime="915">We've hit that threshold where </span><span class="line" data-startTime="915">we've moved incrementally </span><span class="line" data-startTime="918">closer to this GC Pause, </span><span class="line" data-startTime="918">and now we've </span><span class="line" data-startTime="920">actually triggered it. </span> <span class="line" data-startTime="922">So what happens is new </span><span class="line" data-startTime="922">E doesn't happen. </span> <span class="line" data-startTime="925">It's kind of paused. </span> <span class="line" data-startTime="927">So we're still in this state </span><span class="line" data-startTime="927">where we just have A, B, C, </span><span class="line" data-startTime="929">and D inside of our To Space. </span> <span class="line" data-startTime="932">The page is paused, everything </span><span class="line" data-startTime="932">halts, and the </span><span class="line" data-startTime="934">collection is triggered. </span> <span class="line" data-startTime="938">The first step in a young </span><span class="line" data-startTime="938">generation collection is that </span><span class="line" data-startTime="941">the From and the To Space </span><span class="line" data-startTime="941">and just swapped. </span> <span class="line" data-startTime="943">The labels to them are </span><span class="line" data-startTime="943">flipped internally. </span></p>

<p><span class="line" data-startTime="946">And then the live values </span><span class="line" data-startTime="946">are found. </span> <span class="line" data-startTime="949">And I'm not really going into </span><span class="line" data-startTime="949">details about exactly how the </span><span class="line" data-startTime="951">live values are found, but </span><span class="line" data-startTime="951">this is the next step. </span> <span class="line" data-startTime="954">Everything that still has a </span><span class="line" data-startTime="954">retaining path, still on the </span><span class="line" data-startTime="957">graph is discovered and </span><span class="line" data-startTime="957">marked for copy. </span> <span class="line" data-startTime="963">So you can see here that </span><span class="line" data-startTime="963">A and C are marked. </span> <span class="line" data-startTime="965">And B and D have not been </span><span class="line" data-startTime="965">marked, so they're garbage. </span> <span class="line" data-startTime="969">They're not going anywhere. </span> <span class="line" data-startTime="972">And then this is where most </span><span class="line" data-startTime="972">of the time goes. </span> <span class="line" data-startTime="973">It's when the live values are </span><span class="line" data-startTime="973">copied from the From Space to </span><span class="line" data-startTime="978">the To Space. </span></p>

<p><span class="line" data-startTime="980">So here we are. </span> <span class="line" data-startTime="981">We've done the copy. </span> <span class="line" data-startTime="982">We've done the collection. </span> <span class="line" data-startTime="983">We've just copied the live </span><span class="line" data-startTime="983">objects from one </span><span class="line" data-startTime="986">semispace to the next. </span> <span class="line" data-startTime="989">And the From Space is just </span><span class="line" data-startTime="989">recycled at this point. </span> <span class="line" data-startTime="992">There's no other work </span><span class="line" data-startTime="992">done to it. </span> <span class="line" data-startTime="993">It's just ready for use next </span><span class="line" data-startTime="993">time there's a collection that </span><span class="line" data-startTime="996">needs to happen. </span> <span class="line" data-startTime="998">At this point, your page </span><span class="line" data-startTime="998">is resumed, and </span><span class="line" data-startTime="1000">the E object is allocated. </span> <span class="line" data-startTime="1005">What you have to understand is </span><span class="line" data-startTime="1005">that each allocation moves you </span><span class="line" data-startTime="1008">closer to a collection. </span> <span class="line" data-startTime="1010">And so, when Loreena was talking </span><span class="line" data-startTime="1010">earlier about this </span><span class="line" data-startTime="1012">trade-off between more memory </span><span class="line" data-startTime="1012">and performance, you start to </span><span class="line" data-startTime="1016">see why that doesn't hold </span><span class="line" data-startTime="1016">up inside JavaScript. </span> <span class="line" data-startTime="1018">Because the more memory you use, </span><span class="line" data-startTime="1018">the faster you're going </span><span class="line" data-startTime="1020">to get to this pause, and that's </span><span class="line" data-startTime="1020">actually where you're </span><span class="line" data-startTime="1023">going to lose performance. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="1024"><span class="speakerName">Loreena Lee</span>: Right. </span><span class="line" data-startTime="1024">And not only that, but the more </span><span class="line" data-startTime="1024">memory you're using, the </span><span class="line" data-startTime="1026">longer the pause will take. </span></p>

<p class="speaker"><span class="line" data-starttime="1027"><span class="speakerName">John McCutchan</span>: Yes. </span></p>

<p class="speaker"><span class="line" data-starttime="1027"><span class="speakerName">Loreena Lee</span>: The larger the </span><span class="line" data-startTime="1027">heap, the longer the </span><span class="line" data-startTime="1029">collection will take. </span></p>

<p class="speaker"><span class="line" data-starttime="1030"><span class="speakerName">John McCutchan</span>: Yep. </span><span class="line" data-startTime="1030">Exactly. </span><span class="line" data-startTime="1031">And so, when the collection </span><span class="line" data-startTime="1031">occurs, your </span><span class="line" data-startTime="1033">application is paused. </span><span class="line" data-startTime="1034">You get higher latency. </span><span class="line" data-startTime="1036">Let's say the user clicks, </span><span class="line" data-startTime="1036">and then right then </span><span class="line" data-startTime="1038">a collection occurs. </span><span class="line" data-startTime="1039">Well, the click isn't going to </span><span class="line" data-startTime="1039">register for a while, because </span><span class="line" data-startTime="1041">we've got to go and do </span><span class="line" data-startTime="1041">a big collection. </span><span class="line" data-startTime="1043">So this leads to dropped </span><span class="line" data-startTime="1043">frames and poor user </span><span class="line" data-startTime="1046">interaction, in general, </span><span class="line" data-startTime="1046">and unhappy users. </span><span class="line" data-startTime="1049">And unhappy users don't come </span><span class="line" data-startTime="1049">back to your site. </span><span class="line" data-startTime="1052">They'll go somewhere else </span><span class="line" data-startTime="1052">with better performance. </span></p>

<p class="speaker"><span class="line" data-starttime="1055"><span class="speakerName">Loreena Lee</span>: All right. </span> <span class="line" data-startTime="1056">So now we've heard a little bit </span><span class="line" data-startTime="1056">about what happens when </span><span class="line" data-startTime="1059">you have a GC Pause and </span><span class="line" data-startTime="1059">how it all works. </span> <span class="line" data-startTime="1061">But let's see how we can now </span><span class="line" data-startTime="1061">take what we learned and apply </span><span class="line" data-startTime="1064">some tools and techniques to </span><span class="line" data-startTime="1064">figure out how we can fix it. </span> <span class="line" data-startTime="1068">So I mentioned that we were </span><span class="line" data-startTime="1068">starting out from nothing in </span><span class="line" data-startTime="1069">Gmail, and we really had no </span><span class="line" data-startTime="1069">idea how problematic the </span><span class="line" data-startTime="1072">memory situation as. </span> <span class="line" data-startTime="1074">We heard our colleagues telling </span><span class="line" data-startTime="1074">us on a daily basis </span><span class="line" data-startTime="1076">that they were having </span><span class="line" data-startTime="1076">lots of issues. </span> <span class="line" data-startTime="1078">But we didn't know exactly. </span> <span class="line" data-startTime="1079">So we wanted to start and take </span><span class="line" data-startTime="1079">some field measurements. </span></p>

<p><span class="line" data-startTime="1082">We wanted to know how bad </span><span class="line" data-startTime="1082">it was for all of you. </span> <span class="line" data-startTime="1085">So we used the </span><span class="line" data-startTime="1085">performance.memory API. </span> <span class="line" data-startTime="1087">And what we do is we take </span><span class="line" data-startTime="1087">measurements every 30 minutes. </span> <span class="line" data-startTime="1091">We store them in our logs, we </span><span class="line" data-startTime="1091">aggregate them, and we can </span><span class="line" data-startTime="1093">graph them. </span> <span class="line" data-startTime="1094">We can kind of see what's the </span><span class="line" data-startTime="1094">difference between our power </span><span class="line" data-startTime="1097">users, the 99th percentile, </span><span class="line" data-startTime="1097">versus our median and the </span><span class="line" data-startTime="1100">people who just spend a few </span><span class="line" data-startTime="1100">minutes a day here and there. </span> <span class="line" data-startTime="1105">So what the performance.memory </span><span class="line" data-startTime="1105">API does is it </span><span class="line" data-startTime="1107">returns three values. </span> <span class="line" data-startTime="1108">It tells you the jsHeapSizeLimit </span><span class="line" data-startTime="1108">which is the </span><span class="line" data-startTime="1111">total amount of memory available </span><span class="line" data-startTime="1111">for JavaScript. </span> <span class="line" data-startTime="1114">So this is the upper limit. </span></p>

<p><span class="line" data-startTime="1117">And then it tells you the </span><span class="line" data-startTime="1117">totalJSHeapSize, which is the </span><span class="line" data-startTime="1119">amount of memory that has been </span><span class="line" data-startTime="1119">allocated so far, including </span><span class="line" data-startTime="1122">the free space. </span> <span class="line" data-startTime="1122">So this is including memory that </span><span class="line" data-startTime="1122">has already been GCed. </span></p>

<p class="speaker"><span class="line" data-starttime="1125"><span class="speakerName">John McCutchan</span>: So could you </span><span class="line" data-startTime="1125">predict an "I'm dead, Jim" </span><span class="line" data-startTime="1129">situation by seeing when </span><span class="line" data-startTime="1129">totalJSHeapSize hits the </span><span class="line" data-startTime="1132">jsHeapSizeLimit? </span></p>

<p class="speaker"><span class="line" data-starttime="1133"><span class="speakerName">Loreena Lee</span>: Right. </span><span class="line" data-startTime="1133">Right. </span><span class="line" data-startTime="1134">As that totalJSHeapSize gets </span><span class="line" data-startTime="1134">closer and closer, you know </span><span class="line" data-startTime="1136">that at some point you're going </span><span class="line" data-startTime="1136">to trigger this out of </span><span class="line" data-startTime="1139">memory situation. </span></p>

<p class="speaker"><span class="line" data-starttime="1139"><span class="speakerName">John McCutchan</span>: OK. </span></p>

<p class="speaker"><span class="line" data-starttime="1142"><span class="speakerName">Loreena Lee</span>: And then the third </span><span class="line" data-startTime="1142">value that returns is </span><span class="line" data-startTime="1143">the usedJSHeapSize. </span> <span class="line" data-startTime="1144">And that tells you the amount </span><span class="line" data-startTime="1144">of memory that's </span><span class="line" data-startTime="1146">currently in use. </span> <span class="line" data-startTime="1147">So this is the amount of memory </span><span class="line" data-startTime="1147">that's being used by </span><span class="line" data-startTime="1149">live objects in the graph. </span> <span class="line" data-startTime="1155">We were taking these </span><span class="line" data-startTime="1155">measurements from a </span><span class="line" data-startTime="1156">select set of users. </span> <span class="line" data-startTime="1159">Gmail has a lot of users, so </span><span class="line" data-startTime="1159">we were able to get quite a </span><span class="line" data-startTime="1161">bit of data from these users. </span> <span class="line" data-startTime="1164">And what we did was </span><span class="line" data-startTime="1164">we took one user. </span> <span class="line" data-startTime="1166">We just sort of followed </span><span class="line" data-startTime="1166">that user. </span></p>

<p><span class="line" data-startTime="1167">We took a user who we knew was </span><span class="line" data-startTime="1167">using a lot of memory, who was </span><span class="line" data-startTime="1170">nearing this upper limit, </span><span class="line" data-startTime="1170">and we followed </span><span class="line" data-startTime="1172">them for three days. </span> <span class="line" data-startTime="1173">So we wanted to see what the </span><span class="line" data-startTime="1173">correlation was between the </span><span class="line" data-startTime="1176">memory data we were collecting </span><span class="line" data-startTime="1176">as well as the latency data we </span><span class="line" data-startTime="1178">were collecting. </span> <span class="line" data-startTime="1179">And what we found a little bit </span><span class="line" data-startTime="1179">against what our common belief </span><span class="line" data-startTime="1182">of the performance versus </span><span class="line" data-startTime="1182">memory trade-off was. </span> <span class="line" data-startTime="1184">What we found was that as the </span><span class="line" data-startTime="1184">user's heap memory footprint </span><span class="line" data-startTime="1189">grew, their client </span><span class="line" data-startTime="1189">side latencies </span><span class="line" data-startTime="1192">were increasing also. </span> <span class="line" data-startTime="1194">So over to the right </span><span class="line" data-startTime="1194">of each of these </span><span class="line" data-startTime="1195">graphs is by day three. </span></p>

<p><span class="line" data-startTime="1197">By day three, their heap size </span><span class="line" data-startTime="1197">was getting very large. </span> <span class="line" data-startTime="1201">It was well over a gig. </span> <span class="line" data-startTime="1202">And their latencies, the </span><span class="line" data-startTime="1202">variance between of the </span><span class="line" data-startTime="1205">latencies as well as the actual </span><span class="line" data-startTime="1205">values of the latency </span><span class="line" data-startTime="1208">were much much, much higher. </span> <span class="line" data-startTime="1209">And so, given what you've </span><span class="line" data-startTime="1209">just heard about garbage </span><span class="line" data-startTime="1212">collection, you can see that </span><span class="line" data-startTime="1212">once the heap was large, these </span><span class="line" data-startTime="1215">GC pauses were taking more </span><span class="line" data-startTime="1215">and more amount of time. </span> <span class="line" data-startTime="1218">And so that's what you see is </span><span class="line" data-startTime="1218">happening in these latencies. </span> <span class="line" data-startTime="1221">So some of those outliers were </span><span class="line" data-startTime="1221">probably several second long </span><span class="line" data-startTime="1223">garbage collection pauses. </span> <span class="line" data-startTime="1225">And those are things that we </span><span class="line" data-startTime="1225">want to definitely avoid. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="1227"><span class="speakerName">John McCutchan</span>: Yeah. </span></p>

<p class="speaker"><span class="line" data-starttime="1228"><span class="speakerName">Loreena Lee</span>: So after seeing </span><span class="line" data-startTime="1228">this data, we were more </span><span class="line" data-startTime="1230">motivated than ever to get </span><span class="line" data-startTime="1230">things under control. </span> <span class="line" data-startTime="1234">So we turned to the Chrome </span><span class="line" data-startTime="1234">Developer Tools. </span> <span class="line" data-startTime="1236">And If you haven't used </span><span class="line" data-startTime="1236">the tools before &mdash; </span><span class="line" data-startTime="1239">I hope everyone in this room has </span><span class="line" data-startTime="1239">at least fiddled with them </span><span class="line" data-startTime="1241">a little bit &mdash; they're really, </span><span class="line" data-startTime="1241">really powerful. </span> <span class="line" data-startTime="1243">And they're getting better </span><span class="line" data-startTime="1243">and better every day. </span> <span class="line" data-startTime="1244">When we were first starting </span><span class="line" data-startTime="1244">out, some of these tools </span><span class="line" data-startTime="1246">didn't really scale to </span><span class="line" data-startTime="1246">applications of Gmail size. </span> <span class="line" data-startTime="1249">But since then, we've forged </span><span class="line" data-startTime="1249">a relationship with the </span><span class="line" data-startTime="1251">DevTools, and things </span><span class="line" data-startTime="1251">have gotten </span><span class="line" data-startTime="1253">much, much, much better. </span> <span class="line" data-startTime="1255">Now we actually find that almost </span><span class="line" data-startTime="1255">anything we need to </span><span class="line" data-startTime="1258">answer to we can find </span><span class="line" data-startTime="1258">in the DevTools. </span> <span class="line" data-startTime="1260">So to get to the DevTools, this </span><span class="line" data-startTime="1260">is what we affectionately </span><span class="line" data-startTime="1264">call the hot dog menu, the </span><span class="line" data-startTime="1264">three bars you see in the </span><span class="line" data-startTime="1266">upper right-hand corner of your </span><span class="line" data-startTime="1266">Chrome browser window. </span></p>

<p><span class="line" data-startTime="1269">The hotdog menu, Tools, </span><span class="line" data-startTime="1269">and Developer Tools. </span></p>

<p class="speaker"><span class="line" data-starttime="1272"><span class="speakerName">John McCutchan</span>: It's not </span><span class="line" data-startTime="1272">the hamburger menu? </span></p>

<p class="speaker"><span class="line" data-starttime="1273"><span class="speakerName">Loreena Lee</span>: There's </span><span class="line" data-startTime="1273">hot debate. </span></p>

<p class="speaker"><span class="line" data-starttime="1275"><span class="speakerName">John McCutchan</span>: Yeah. </span></p>

<p class="speaker"><span class="line" data-starttime="1277"><span class="speakerName">Loreena Lee</span>: So once you open </span><span class="line" data-startTime="1277">up these tools, you'll see a </span><span class="line" data-startTime="1279">powerful set of tools. </span> <span class="line" data-startTime="1281">Inside here, we have </span><span class="line" data-startTime="1281">a CPU profiler. </span> <span class="line" data-startTime="1283">We have a heap profiler. </span> <span class="line" data-startTime="1284">We have Timeline tools that can </span><span class="line" data-startTime="1284">tell you about your events </span><span class="line" data-startTime="1287">that are happening in your </span><span class="line" data-startTime="1287">page, such as the garbage </span><span class="line" data-startTime="1289">collection events. </span> <span class="line" data-startTime="1290">Also, things like paint </span><span class="line" data-startTime="1290">time, rendering time. </span> <span class="line" data-startTime="1293">All of these things you can </span><span class="line" data-startTime="1293">see in the DevTools. </span></p>

<p><span class="line" data-startTime="1296">There's an interactive </span><span class="line" data-startTime="1296">JavaScript console. </span> <span class="line" data-startTime="1297">It can interact with </span><span class="line" data-startTime="1297">your application. </span> <span class="line" data-startTime="1300">So they're really powerful. </span> <span class="line" data-startTime="1301">But right now we're going to </span><span class="line" data-startTime="1301">talk about the part of the </span><span class="line" data-startTime="1303">DevTools that we use to diagnose </span><span class="line" data-startTime="1303">these memory issues. </span> <span class="line" data-startTime="1308">The first thing I like to do is </span><span class="line" data-startTime="1308">go to the Memory Timeline. </span> <span class="line" data-startTime="1311">And this is in the Timeline </span><span class="line" data-startTime="1311">panel of your DevTools. </span> <span class="line" data-startTime="1314">And what you can do here is you </span><span class="line" data-startTime="1314">can see at the top there's </span><span class="line" data-startTime="1317">actually multiple tabs here. </span> <span class="line" data-startTime="1319">There's an Events Timeline that </span><span class="line" data-startTime="1319">can show you the garbage </span><span class="line" data-startTime="1322">collection pauses, like the </span><span class="line" data-startTime="1322">screenshot you saw earlier. </span> <span class="line" data-startTime="1324">And then here, we're </span><span class="line" data-startTime="1324">the Memory Panel </span><span class="line" data-startTime="1326">and the Memory Timeline. </span></p>

<p><span class="line" data-startTime="1328">At the top there, you </span><span class="line" data-startTime="1328">see the blue. </span> <span class="line" data-startTime="1331">And that's overall memory. </span> <span class="line" data-startTime="1332">And then down below, you have </span><span class="line" data-startTime="1332">the ability to see three </span><span class="line" data-startTime="1336">different counts. </span> <span class="line" data-startTime="1337">And right now I only have the </span><span class="line" data-startTime="1337">dom node count enabled. </span> <span class="line" data-startTime="1339">But you can see the document </span><span class="line" data-startTime="1339">count, the dom node count, and </span><span class="line" data-startTime="1342">the event listener account. </span> <span class="line" data-startTime="1343">And so these will tell you over </span><span class="line" data-startTime="1343">the timeline you recorded </span><span class="line" data-startTime="1347">how many of each of these things </span><span class="line" data-startTime="1347">is currently live. </span> <span class="line" data-startTime="1352">So what you do is you take an </span><span class="line" data-startTime="1352">action or a sequence of </span><span class="line" data-startTime="1355">actions that you identify </span><span class="line" data-startTime="1355">as possibly suspicious. </span> <span class="line" data-startTime="1357">You think that there </span><span class="line" data-startTime="1357">may be a leak in </span><span class="line" data-startTime="1359">performing these actions. </span> <span class="line" data-startTime="1362">You start the timeline. </span></p>

<p><span class="line" data-startTime="1362">You can perform these actions </span><span class="line" data-startTime="1362">a number of times. </span> <span class="line" data-startTime="1365">And so in this case, we </span><span class="line" data-startTime="1365">performed them six times. </span> <span class="line" data-startTime="1368">And then there's a little </span><span class="line" data-startTime="1368">garbage can </span><span class="line" data-startTime="1370">button at the bottom. </span> <span class="line" data-startTime="1371">You can click that button, and </span><span class="line" data-startTime="1371">that'll force a full garbage </span><span class="line" data-startTime="1374">collection. </span> <span class="line" data-startTime="1376">And if you suspect that this </span><span class="line" data-startTime="1376">action should not leave any </span><span class="line" data-startTime="1379">dom nodes behind but that </span><span class="line" data-startTime="1379">number of nodes is not </span><span class="line" data-startTime="1383">dropping back down to your </span><span class="line" data-startTime="1383">baseline, you have a pretty </span><span class="line" data-startTime="1385">good indication that </span><span class="line" data-startTime="1385">there's a leak. </span> <span class="line" data-startTime="1387">So here we did the experiment </span><span class="line" data-startTime="1387">twice, just make sure. </span> <span class="line" data-startTime="1390">And we see that each time we </span><span class="line" data-startTime="1390">forced a GC, that number of </span><span class="line" data-startTime="1393">dom nodes is not dropping back </span><span class="line" data-startTime="1393">down to the baseline. </span></p>

<p><span class="line" data-startTime="1396">So we're pretty sure </span><span class="line" data-startTime="1396">we have a leak. </span> <span class="line" data-startTime="1397">This is an action that we've </span><span class="line" data-startTime="1397">identified that should be </span><span class="line" data-startTime="1399">clean, but it's obviously not. </span></p>

<p class="speaker"><span class="line" data-starttime="1402"><span class="speakerName">John McCutchan</span>: By clean, you </span><span class="line" data-startTime="1402">mean there should be nothing </span><span class="line" data-startTime="1404">in the graph afterwards? </span></p>

<p class="speaker"><span class="line" data-starttime="1405"><span class="speakerName">Loreena Lee</span>: We expect that the </span><span class="line" data-startTime="1405">actions should not leave </span><span class="line" data-startTime="1407">behind any dom nodes. </span> <span class="line" data-startTime="1408">We think that we've cleaned </span><span class="line" data-startTime="1408">up after ourselves. </span> <span class="line" data-startTime="1411">So we obviously have not. </span> <span class="line" data-startTime="1412">So now what? </span><span class="line" data-startTime="1414">I'm really excited to introduce </span><span class="line" data-startTime="1414">the Object Tracker. </span> <span class="line" data-startTime="1417">And this is brand new. </span> <span class="line" data-startTime="1418">This is currently only enabled </span><span class="line" data-startTime="1418">in Chrome Canary </span><span class="line" data-startTime="1421">that you can get now. </span> <span class="line" data-startTime="1422">But you need to enable the </span><span class="line" data-startTime="1422">DevTools Experiments. </span> <span class="line" data-startTime="1425">And we'll give you instructions </span><span class="line" data-startTime="1425">on how to do </span><span class="line" data-startTime="1427">that, DevTools Experiments, and </span><span class="line" data-startTime="1427">then the Object Tracker. </span> <span class="line" data-startTime="1431">And this is really cool because </span><span class="line" data-startTime="1431">it combines the best </span><span class="line" data-startTime="1432">of both worlds. </span> <span class="line" data-startTime="1434">This combines the timeline </span><span class="line" data-startTime="1434">functionality, like the one I </span><span class="line" data-startTime="1436">just showed, with the heap </span><span class="line" data-startTime="1436">profiler that is already </span><span class="line" data-startTime="1440">existing in current </span><span class="line" data-startTime="1440">stable channel. </span> <span class="line" data-startTime="1443">And that heap profiler will tell </span><span class="line" data-startTime="1443">you all the objects that </span><span class="line" data-startTime="1445">are in the heap at </span><span class="line" data-startTime="1445">any given time. </span></p>

<p><span class="line" data-startTime="1447">When you collect a snapshot, </span><span class="line" data-startTime="1447">it'll show you everything </span><span class="line" data-startTime="1449">that's in the heap that's </span><span class="line" data-startTime="1449">live at a given time. </span> <span class="line" data-startTime="1452">But here now, you can start </span><span class="line" data-startTime="1452">recording, and it'll take </span><span class="line" data-startTime="1456">snapshots periodically through </span><span class="line" data-startTime="1456">that recording. </span> <span class="line" data-startTime="1458">And it'll tell you what objects </span><span class="line" data-startTime="1458">were live in that </span><span class="line" data-startTime="1462">recording at any given time, </span><span class="line" data-startTime="1462">or I should say, that were </span><span class="line" data-startTime="1468">allocated during that time. </span> <span class="line" data-startTime="1470">So let's look a little </span><span class="line" data-startTime="1470">bit more in detail. </span></p>

<p><span class="line" data-startTime="1473">Here at the top, you see </span><span class="line" data-startTime="1473">some color-coded bars. </span> <span class="line" data-startTime="1475">These identify new objects </span><span class="line" data-startTime="1475">that were found that were </span><span class="line" data-startTime="1478">allocated during the timeline. </span> <span class="line" data-startTime="1479">So I said that we take periodic </span><span class="line" data-startTime="1479">snapshots while we're </span><span class="line" data-startTime="1482">doing this. </span> <span class="line" data-startTime="1483">And as you take a snapshot, it </span><span class="line" data-startTime="1483">does a full profile snapshot, </span><span class="line" data-startTime="1487">heap profile. </span> <span class="line" data-startTime="1488">And it'll look for new objects </span><span class="line" data-startTime="1488">that weren't there the </span><span class="line" data-startTime="1492">previous time. </span> <span class="line" data-startTime="1494">So here, you see that there </span><span class="line" data-startTime="1494">are 10 bars, and there's </span><span class="line" data-startTime="1497">different colors. </span> <span class="line" data-startTime="1499">The blue bars indicate new </span><span class="line" data-startTime="1499">objects that were found during </span><span class="line" data-startTime="1502">that time that are still live </span><span class="line" data-startTime="1502">at the end of the timeline. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="1506"><span class="speakerName">John McCutchan</span>: At the </span><span class="line" data-startTime="1506">end of the capture. </span></p>

<p class="speaker"><span class="line" data-starttime="1507"><span class="speakerName">Loreena Lee</span>: At the end </span><span class="line" data-startTime="1507">of the capture. </span> <span class="line" data-startTime="1508">So the end of this timeframe </span><span class="line" data-startTime="1508">that the whole </span><span class="line" data-startTime="1511">recording was taken. </span> <span class="line" data-startTime="1513">The gray bars show that there </span><span class="line" data-startTime="1513">were new objects that were </span><span class="line" data-startTime="1515">found at that point in time, </span><span class="line" data-startTime="1515">but they've since </span><span class="line" data-startTime="1519">been garbage collected. </span> <span class="line" data-startTime="1520">So by the end of the capture, </span><span class="line" data-startTime="1520">those objects that are in gray </span><span class="line" data-startTime="1524">now have been collected. </span> <span class="line" data-startTime="1527">You can also narrow in on any </span><span class="line" data-startTime="1527">of those bars to get more </span><span class="line" data-startTime="1530">information about what exactly </span><span class="line" data-startTime="1530">was in that difference. </span></p>

<p class="speaker"><span class="line" data-starttime="1533"><span class="speakerName">John McCutchan</span>: Yeah. </span></p>

<p class="speaker"><span class="line" data-starttime="1535"><span class="speakerName">Loreena Lee</span>: And then down below </span><span class="line" data-startTime="1535">is the heap contents. </span></p>

<p class="speaker"><span class="line" data-starttime="1540"><span class="speakerName">John McCutchan</span>: The heap </span><span class="line" data-startTime="1540">contents is connected to the </span><span class="line" data-startTime="1543">time window that you've </span><span class="line" data-startTime="1543">selected. </span></p>

<p class="speaker"><span class="line" data-starttime="1544"><span class="speakerName">Loreena Lee</span>: Right. </span></p>

<p class="speaker"><span class="line" data-starttime="1545"><span class="speakerName">John McCutchan</span>: So it's only </span><span class="line" data-startTime="1545">going to show objects that are </span><span class="line" data-startTime="1547">alive that are within the time </span><span class="line" data-startTime="1547">range that you've picked. </span></p>

<p class="speaker"><span class="line" data-starttime="1550"><span class="speakerName">Loreena Lee</span>: Right. </span> <span class="line" data-startTime="1551">OK. </span> <span class="line" data-startTime="1552">I know it's hard to tell from </span><span class="line" data-startTime="1552">screenshots, so you probably </span><span class="line" data-startTime="1555">want to see a demo. </span> <span class="line" data-startTime="1558">Let's see. </span> <span class="line" data-startTime="1558">So we wrote a simple mail-like </span><span class="line" data-startTime="1558">app, since we're talking about </span><span class="line" data-startTime="1561">Gmail here. </span> <span class="line" data-startTime="1562">In Gmail, we cached messages </span><span class="line" data-startTime="1562">for better performance. </span> <span class="line" data-startTime="1566">In this little demo, we have </span><span class="line" data-startTime="1566">a cache of size 5. </span> <span class="line" data-startTime="1570">That means that, in theory, no </span><span class="line" data-startTime="1570">more than 5 messages should be </span><span class="line" data-startTime="1573">in memory at any given time. </span> <span class="line" data-startTime="1574">So let's take a look. </span> <span class="line" data-startTime="1577">OK. </span> <span class="line" data-startTime="1579">So first we're going to start </span><span class="line" data-startTime="1579">off with our timeline. </span> <span class="line" data-startTime="1582">And you see that I'm </span><span class="line" data-startTime="1582">on the memory here. </span></p>

<p><span class="line" data-startTime="1584">And let's go ahead and we'll </span><span class="line" data-startTime="1584">just look at dom node count to </span><span class="line" data-startTime="1587">not confuse ourselves. </span> <span class="line" data-startTime="1589">And let's see. </span> <span class="line" data-startTime="1590">I said we have a cache </span><span class="line" data-startTime="1590">of size 5. </span> <span class="line" data-startTime="1593">One thing we should always </span><span class="line" data-startTime="1593">do is refresh. </span> <span class="line" data-startTime="1595">Make sure you're starting </span><span class="line" data-startTime="1595">with a clean slate. </span> <span class="line" data-startTime="1598">And we'll go ahead and read </span><span class="line" data-startTime="1598">those 5 messages. </span> <span class="line" data-startTime="1602">So we've now filled </span><span class="line" data-startTime="1602">up our cache. </span> <span class="line" data-startTime="1604">Let's read 5 more, and we'll do </span><span class="line" data-startTime="1604">a full garbage collection. </span></p>

<p class="speaker"><span class="line" data-starttime="1609"><span class="speakerName">John McCutchan</span>: Are we going </span><span class="line" data-startTime="1609">to start recording? </span></p>

<p class="speaker"><span class="line" data-starttime="1611"><span class="speakerName">Loreena Lee</span>: Oh, yes. </span><span class="line" data-startTime="1612">We do need to be recording. </span><span class="line" data-startTime="1613">OK. </span><span class="line" data-startTime="1614">So the cache is full. </span><span class="line" data-startTime="1615">Let's read 5 messages, let's </span><span class="line" data-startTime="1615">collect garbage, and let's </span><span class="line" data-startTime="1621">stop the recording. </span><span class="line" data-startTime="1623">So you see the blue bar at the </span><span class="line" data-startTime="1623">top shows you how much memory </span><span class="line" data-startTime="1627">is being used. </span><span class="line" data-startTime="1628">And we see this stairstep. </span><span class="line" data-startTime="1631">This is when I clicked </span><span class="line" data-startTime="1631">the next message. </span><span class="line" data-startTime="1634">You see there'll </span><span class="line" data-startTime="1634">be five steps. </span><span class="line" data-startTime="1637">And you know, I'm pretty sure </span><span class="line" data-startTime="1637">I clicked that garbage can </span><span class="line" data-startTime="1640">button, but I'm not seeing the </span><span class="line" data-startTime="1640">dom node count drop down. </span></p>

<p class="speaker"><span class="line" data-starttime="1643"><span class="speakerName">John McCutchan</span>: Yeah. </span></p>

<p class="speaker"><span class="line" data-starttime="1643"><span class="speakerName">Loreena Lee</span>: So let's try it </span><span class="line" data-startTime="1643">again, just to make sure. </span> <span class="line" data-startTime="1645">I'll record. </span> <span class="line" data-startTime="1647">Read 5 more messages. </span> <span class="line" data-startTime="1652">Click that. </span> <span class="line" data-startTime="1654">I'll expand it. </span> <span class="line" data-startTime="1658">It's dropping down, but </span><span class="line" data-startTime="1658">not quite as far as </span><span class="line" data-startTime="1660">I expected it to. </span> <span class="line" data-startTime="1661">I expected it to be down </span><span class="line" data-startTime="1661">to the baseline. </span> <span class="line" data-startTime="1664">Our cache was already full, and </span><span class="line" data-startTime="1664">we've still got some dom </span><span class="line" data-startTime="1666">nodes here. </span> <span class="line" data-startTime="1667">So now we're going to go over </span><span class="line" data-startTime="1667">to the Profile Panel, see if </span><span class="line" data-startTime="1671">we can figure out </span><span class="line" data-startTime="1671">what's going on. </span> <span class="line" data-startTime="1674">Let's refresh, start </span><span class="line" data-startTime="1674">from the beginning. </span> <span class="line" data-startTime="1676">So this new Object Tracker, the </span><span class="line" data-startTime="1676">last one here, it's called </span><span class="line" data-startTime="1679">Track Allocations. </span> <span class="line" data-startTime="1680">So this will run the heap </span><span class="line" data-startTime="1680">profiler continuously and </span><span class="line" data-startTime="1684">collect these snapshots </span><span class="line" data-startTime="1684">periodically while we're </span><span class="line" data-startTime="1686">interacting with our app. </span></p>

<p><span class="line" data-startTime="1688">So we'll start this. </span> <span class="line" data-startTime="1690">And let's go ahead and </span><span class="line" data-startTime="1690">read 10 messages. </span> <span class="line" data-startTime="1696">7, 8, 9, 10. </span> <span class="line" data-startTime="1699">And we'll go ahead </span><span class="line" data-startTime="1699">and stop it. </span> <span class="line" data-startTime="1703">So once the snapshot is </span><span class="line" data-startTime="1703">loaded, we should </span><span class="line" data-startTime="1705">see these 10 bars. </span> <span class="line" data-startTime="1706">1, 2, 3, 4, 5, 6, 7, 8, 9, 10. </span> <span class="line" data-startTime="1709">We know our cache is </span><span class="line" data-startTime="1709">of size 5, right? </span><span class="line" data-startTime="1714">So here we see the total. </span> <span class="line" data-startTime="1716">Let's scroll this up so </span><span class="line" data-startTime="1716">you guys can see it </span><span class="line" data-startTime="1718">a little bit better. </span> <span class="line" data-startTime="1721">So we see these last 5 messages </span><span class="line" data-startTime="1721">that we read, and </span><span class="line" data-startTime="1723">those are all blue. </span></p>

<p><span class="line" data-startTime="1724">So we know that these are still </span><span class="line" data-startTime="1724">objects that are live in </span><span class="line" data-startTime="1727">the graph at the end of this </span><span class="line" data-startTime="1727">whole timeline capture. </span> <span class="line" data-startTime="1730">But now we have this one blue </span><span class="line" data-startTime="1730">bar, this third one </span><span class="line" data-startTime="1733">here, and it's blue. </span> <span class="line" data-startTime="1734">I'm expecting that we only have </span><span class="line" data-startTime="1734">5 messages in our cache, </span><span class="line" data-startTime="1737">and I see that there's </span><span class="line" data-startTime="1737">something </span><span class="line" data-startTime="1738">strange going on here. </span> <span class="line" data-startTime="1740">If we look at this message Aux </span><span class="line" data-startTime="1740">Data, which is our message </span><span class="line" data-startTime="1745">headers, we actually can </span><span class="line" data-startTime="1745">look here we can </span><span class="line" data-startTime="1747">see the object count. </span> <span class="line" data-startTime="1748">And there's 6. </span> <span class="line" data-startTime="1749">That confuses me, because I </span><span class="line" data-startTime="1749">expected that we had a cache </span><span class="line" data-startTime="1751">of size 5, so I don't know why </span><span class="line" data-startTime="1751">we still have this sixth </span><span class="line" data-startTime="1754">message that didn't </span><span class="line" data-startTime="1754">get collected. </span></p>

<p><span class="line" data-startTime="1756">So we can actually zoom in </span><span class="line" data-startTime="1756">on any of these bars. </span> <span class="line" data-startTime="1760">And we can see exactly </span><span class="line" data-startTime="1760">the objects that were </span><span class="line" data-startTime="1763">found in the diff. </span> <span class="line" data-startTime="1764">Basically, this is a diff </span><span class="line" data-startTime="1764">between this blue bar and the </span><span class="line" data-startTime="1766">previous snapshot. </span> <span class="line" data-startTime="1768">We see that these objects </span><span class="line" data-startTime="1768">are still live. </span> <span class="line" data-startTime="1770">They're showing up here because </span><span class="line" data-startTime="1770">they're still live in </span><span class="line" data-startTime="1771">the heap at the end of </span><span class="line" data-startTime="1771">this full timeline. </span> <span class="line" data-startTime="1775">So if I look at one of </span><span class="line" data-startTime="1775">these first ones &mdash; </span><span class="line" data-startTime="1777">That's probably not a good one </span><span class="line" data-startTime="1777">because it's got some extra </span><span class="line" data-startTime="1779">code in there. </span> <span class="line" data-startTime="1780">If I look at one of these here </span><span class="line" data-startTime="1780">that's all grey, we'll see </span><span class="line" data-startTime="1782">nothing here. </span> <span class="line" data-startTime="1783">And this means that everything </span><span class="line" data-startTime="1783">that was found in this diff of </span><span class="line" data-startTime="1786">snapshot, this snapshot that </span><span class="line" data-startTime="1786">was taken here, any new </span><span class="line" data-startTime="1789">allocations here have since been </span><span class="line" data-startTime="1789">very garbage collected. </span></p>

<p><span class="line" data-startTime="1791">And that's what we expect. </span> <span class="line" data-startTime="1792">But here we have this blue </span><span class="line" data-startTime="1792">bar, which confuses us. </span> <span class="line" data-startTime="1795">So let's take a look. </span> <span class="line" data-startTime="1796">We see that there's a message </span><span class="line" data-startTime="1796">Aux.Data here. </span> <span class="line" data-startTime="1798">We have a html div element </span><span class="line" data-startTime="1798">that's sticking around. </span> <span class="line" data-startTime="1801">And so we want to kind of see </span><span class="line" data-startTime="1801">what's retaining this. </span> <span class="line" data-startTime="1804">What's the retaining path </span><span class="line" data-startTime="1804">to these objects? </span><span class="line" data-startTime="1809">So we see here that the </span><span class="line" data-startTime="1809">retaining path has this saved </span><span class="line" data-startTime="1813">messages array. </span> <span class="line" data-startTime="1814">So this is index 0 in the </span><span class="line" data-startTime="1814">saved messages array. </span> <span class="line" data-startTime="1817">And what we see here is that </span><span class="line" data-startTime="1817">we actually have some extra </span><span class="line" data-startTime="1820">array that's not a cache that's </span><span class="line" data-startTime="1820">holding on to this </span><span class="line" data-startTime="1822">extra message, and </span><span class="line" data-startTime="1822">that's causing </span><span class="line" data-startTime="1824">it to not be collected. </span></p>

<p><span class="line" data-startTime="1826">And so we can actually go back </span><span class="line" data-startTime="1826">to the source and look and see </span><span class="line" data-startTime="1829">what this saved messages array </span><span class="line" data-startTime="1829">is in this case and go ahead </span><span class="line" data-startTime="1832">and make sure that we free </span><span class="line" data-startTime="1832">that reference up. </span> <span class="line" data-startTime="1833">And that will cause this </span><span class="line" data-startTime="1833">to get collected. </span></p>

<p class="speaker"><span class="line" data-starttime="1835"><span class="speakerName">John McCutchan</span>: Yeah. </span><span class="line" data-startTime="1835">You can use the view of the </span><span class="line" data-startTime="1835">retaining path down here as a </span><span class="line" data-startTime="1840">clue to where in your source </span><span class="line" data-startTime="1840">code this object was allocated </span><span class="line" data-startTime="1844">and where it probably should </span><span class="line" data-startTime="1844">be cleaned up. </span></p>

<p class="speaker"><span class="line" data-starttime="1846"><span class="speakerName">Loreena Lee</span>: Right. </span><span class="line" data-startTime="1847">Right. </span><span class="line" data-startTime="1849">So that's the Object Tracker. </span><span class="line" data-startTime="1857">Let's go back and see was </span><span class="line" data-startTime="1857">this really worth it. </span><span class="line" data-startTime="1859">This is kind of a lot of work, </span><span class="line" data-startTime="1859">especially if you think about </span><span class="line" data-startTime="1861">an application of Gmail size. </span><span class="line" data-startTime="1863">The JavaScript is actually huge, </span><span class="line" data-startTime="1863">so going through and </span><span class="line" data-startTime="1865">performing these techniques </span><span class="line" data-startTime="1865">actually can take some time. </span><span class="line" data-startTime="1868">But was it really worth it? </span><span class="line" data-startTime="1870">And I'd say a resounding yes. </span><span class="line" data-startTime="1872">This is the data that we </span><span class="line" data-startTime="1872">collected using the </span><span class="line" data-startTime="1875">performance memory API that </span><span class="line" data-startTime="1875">I mentioned earlier. </span><span class="line" data-startTime="1877">This is actually a </span><span class="line" data-startTime="1877">graph of about a </span><span class="line" data-startTime="1878">10month period in 2012. </span><span class="line" data-startTime="1880">If you look far to the left, </span><span class="line" data-startTime="1880">you can see that memory was </span><span class="line" data-startTime="1882">actually really far </span><span class="line" data-startTime="1882">out of control. </span></p>

<p class="speaker"><span class="line" data-starttime="1884"><span class="speakerName">John McCutchan</span>: And the </span><span class="line" data-startTime="1884">scale here is just </span><span class="line" data-startTime="1886">relative to the median? </span></p>

<p class="speaker"><span class="line" data-starttime="1887"><span class="speakerName">Loreena Lee</span>: Right. </span><span class="line" data-startTime="1888">Well, it's relative to </span><span class="line" data-startTime="1888">itself, I guess. </span><span class="line" data-startTime="1891">Yeah. </span><span class="line" data-startTime="1892">So the green line on the bottom </span><span class="line" data-startTime="1892">is actually the median. </span><span class="line" data-startTime="1894">And the blue line up at the top </span><span class="line" data-startTime="1894">is the 99th percentile. </span><span class="line" data-startTime="1897">So the blue line represents </span><span class="line" data-startTime="1897">mostly our power users. </span><span class="line" data-startTime="1900">And you can see that for our </span><span class="line" data-startTime="1900">power users we've actually </span><span class="line" data-startTime="1902">reduced memory in this 10-month </span><span class="line" data-startTime="1902">period by 80%, or </span><span class="line" data-startTime="1907">more, actually. </span><span class="line" data-startTime="1908">And for our median users &mdash; </span><span class="line" data-startTime="1910">it's hard to tell on </span><span class="line" data-startTime="1910">this graph, just </span><span class="line" data-startTime="1911">because of the scale &mdash; </span><span class="line" data-startTime="1912">we actually reduced the amount </span><span class="line" data-startTime="1912">of memory that our median </span><span class="line" data-startTime="1915">users was using by over 50%. </span></p>

<p class="speaker"><span class="line" data-starttime="1917"><span class="speakerName">John McCutchan</span>: Nice. </span></p>

<p class="speaker"><span class="line" data-starttime="1918"><span class="speakerName">Loreena Lee</span>: And you'll </span><span class="line" data-startTime="1918">see there's these two </span><span class="line" data-startTime="1920">peaks on the blue line. </span><span class="line" data-startTime="1921">And they're there on the other </span><span class="line" data-startTime="1921">lines as well, but the scale </span><span class="line" data-startTime="1924">is not quite as obvious. </span><span class="line" data-startTime="1925">And what these are actually </span><span class="line" data-startTime="1925">showing us is two regressions </span><span class="line" data-startTime="1928">that we found that were in </span><span class="line" data-startTime="1928">Chrome itself, not in Gmail. </span></p>

<p class="speaker"><span class="line" data-starttime="1931"><span class="speakerName">John McCutchan</span>: So you </span><span class="line" data-startTime="1931">found bugs in V8? </span></p>

<p class="speaker"><span class="line" data-starttime="1933"><span class="speakerName">Loreena Lee</span>: We actually did </span><span class="line" data-startTime="1933">find some bugs in V8. </span><span class="line" data-startTime="1935">And then these particular </span><span class="line" data-startTime="1935">cases, they were </span><span class="line" data-startTime="1937">fragmentation bugs. </span><span class="line" data-startTime="1938">So the garbage collector was </span><span class="line" data-startTime="1938">actually collecting garbage, </span><span class="line" data-startTime="1940">but it was so fragmented and </span><span class="line" data-startTime="1940">in these tiny little chunks </span><span class="line" data-startTime="1943">that Gmail wasn't able to use </span><span class="line" data-startTime="1943">them for new allocations. </span><span class="line" data-startTime="1946">So what we noticed here was that </span><span class="line" data-startTime="1946">we mentioned there were </span><span class="line" data-startTime="1948">three values that are being </span><span class="line" data-startTime="1948">reported by the </span><span class="line" data-startTime="1950">performance.memory API. </span><span class="line" data-startTime="1952">One of them was totalJSHeapSize, </span><span class="line" data-startTime="1952">which was the </span><span class="line" data-startTime="1955">memory in use plus </span><span class="line" data-startTime="1955">the free space. </span><span class="line" data-startTime="1957">And then there was the </span><span class="line" data-startTime="1957">usedJSHeapSize, which was the </span><span class="line" data-startTime="1961">live objects. </span><span class="line" data-startTime="1962">And we noticed that the </span><span class="line" data-startTime="1962">gap between these </span><span class="line" data-startTime="1963">two lines was growing. </span><span class="line" data-startTime="1964">So that's how we've realized </span><span class="line" data-startTime="1964">that it wasn't actually a </span><span class="line" data-startTime="1966">Gmail problem that was causing </span><span class="line" data-startTime="1966">these two peaks. </span></p>

<p class="speaker"><span class="line" data-starttime="1969"><span class="speakerName">John McCutchan</span>: Yeah. </span></p>

<p class="speaker"><span class="line" data-starttime="1969"><span class="speakerName">Loreena Lee</span>: So once those were </span><span class="line" data-startTime="1969">fixed, we got things back </span><span class="line" data-startTime="1971">under control. </span><span class="line" data-startTime="1972">And we're in a pretty good </span><span class="line" data-startTime="1972">place right now. </span></p>

<p class="speaker"><span class="line" data-starttime="1975"><span class="speakerName">John McCutchan</span>: Looks like it. </span></p>

<p class="speaker"><span class="line" data-starttime="1978"><span class="speakerName">Loreena Lee</span>: Really, what we're </span><span class="line" data-startTime="1978">asking of everybody in </span><span class="line" data-startTime="1981">this room, and hopefully beyond, </span><span class="line" data-startTime="1981">is to think about how </span><span class="line" data-startTime="1986">your memory usage is affecting </span><span class="line" data-startTime="1986">your performance. </span><span class="line" data-startTime="1989">And we recall that the higher </span><span class="line" data-startTime="1989">the memory footprint, the </span><span class="line" data-startTime="1993">longer the latencies were and </span><span class="line" data-startTime="1993">the wider the variance. </span><span class="line" data-startTime="1996">And so, really, these </span><span class="line" data-startTime="1996">GC pauses can be </span><span class="line" data-startTime="1998">an performance killer. </span><span class="line" data-startTime="2002">So ask yourself these questions </span><span class="line" data-startTime="2002">about your app. </span><span class="line" data-startTime="2005">How much memory is </span><span class="line" data-startTime="2005">your page using? </span><span class="line" data-startTime="2007">Are you using an amount of </span><span class="line" data-startTime="2007">memory that is reasonable for </span><span class="line" data-startTime="2010">the size of your app? </span><span class="line" data-startTime="2010">If you have a small, not so </span><span class="line" data-startTime="2010">interactive app, and you're </span><span class="line" data-startTime="2013">using hundreds of megabytes of </span><span class="line" data-startTime="2013">memory, you're probably not </span><span class="line" data-startTime="2016">using things most efficiently. </span></p>

<p class="speaker"><span class="line" data-starttime="2019"><span class="speakerName">John McCutchan</span>: Even for Gmail, </span><span class="line" data-startTime="2019">you were able to reduce </span><span class="line" data-startTime="2020">memory usage for the 99th </span><span class="line" data-startTime="2020">percentile by 80% without </span><span class="line" data-startTime="2024">impacting performance, </span><span class="line" data-startTime="2024">I imagine. </span></p>

<p class="speaker"><span class="line" data-starttime="2026"><span class="speakerName">Loreena Lee</span>: Well, without </span><span class="line" data-startTime="2026">negatively impacting </span><span class="line" data-startTime="2027">performance. </span></p>

<p class="speaker"><span class="line" data-starttime="2028"><span class="speakerName">John McCutchan</span>: Yes. </span><span class="line" data-startTime="2028">[INAUDIBLE] </span></p>

<p class="speaker"><span class="line" data-starttime="2028"><span class="speakerName">Loreena Lee</span>: We actually did </span><span class="line" data-startTime="2028">see a modest improvement in </span><span class="line" data-startTime="2031">our latencies. </span><span class="line" data-startTime="2032">And so it really does </span><span class="line" data-startTime="2032">make a difference. </span><span class="line" data-startTime="2034">For Gmail, latencies are </span><span class="line" data-startTime="2034">hard to tell sometimes. </span><span class="line" data-startTime="2037">But for the 99th percentile, </span><span class="line" data-startTime="2037">seeing a 10% improvement in </span><span class="line" data-startTime="2040">latency is a big deal for us. </span></p>

<p class="speaker"><span class="line" data-starttime="2042"><span class="speakerName">John McCutchan</span>: Yeah. </span></p>

<p class="speaker"><span class="line" data-starttime="2044"><span class="speakerName">Loreena Lee</span>: So is your </span><span class="line" data-startTime="2044">page leak-free? </span><span class="line" data-startTime="2046">When you first load your page, </span><span class="line" data-startTime="2046">versus after a day, after two </span><span class="line" data-startTime="2049">days, after a week, is </span><span class="line" data-startTime="2049">the memory staying in </span><span class="line" data-startTime="2054">a reasonable size? </span><span class="line" data-startTime="2055">Is it growing over time? </span><span class="line" data-startTime="2056">Or are you leaking memory </span><span class="line" data-startTime="2056">that you shouldn't be? </span><span class="line" data-startTime="2060">And how frequently </span><span class="line" data-startTime="2060">are you GCing? </span><span class="line" data-startTime="2061">We showed you some tools that </span><span class="line" data-startTime="2061">you can use to figure out how </span><span class="line" data-startTime="2064">frequently you are GCing and </span><span class="line" data-startTime="2064">if those GC pauses are </span><span class="line" data-startTime="2067">affecting your performance. </span></p>

<p class="speaker"><span class="line" data-starttime="2067"><span class="speakerName">John McCutchan</span>: Yeah. </span><span class="line" data-startTime="2068">If you're seeing a lot of GCs, </span><span class="line" data-startTime="2068">that probably indicates that </span><span class="line" data-startTime="2073">you're just allocating a ton of </span><span class="line" data-startTime="2073">objects inside JavaScript, </span><span class="line" data-startTime="2076">which you likely don't </span><span class="line" data-startTime="2076">need to be doing. </span><span class="line" data-startTime="2078">So that's just another indicator </span><span class="line" data-startTime="2078">that maybe there's a </span><span class="line" data-startTime="2081">different way to structure your </span><span class="line" data-startTime="2081">page or your site so that </span><span class="line" data-startTime="2084">the performance impact of </span><span class="line" data-startTime="2084">GCs can be lessened. </span></p>

<p class="speaker"><span class="line" data-starttime="2088"><span class="speakerName">Loreena Lee</span>: Right. </span><span class="line" data-startTime="2092">And then we showed you </span><span class="line" data-startTime="2092">a bunch of tools. </span><span class="line" data-startTime="2094">The Chrome Developer Tools </span><span class="line" data-startTime="2094">really are getting better and </span><span class="line" data-startTime="2097">better every day. </span><span class="line" data-startTime="2097">We have some really great </span><span class="line" data-startTime="2097">documentation on </span><span class="line" data-startTime="2099">developers.google.com that </span><span class="line" data-startTime="2099">you can check out. </span><span class="line" data-startTime="2102">There's a lot of tutorials on </span><span class="line" data-startTime="2102">there that you can use to get </span><span class="line" data-startTime="2104">an introduction to </span><span class="line" data-startTime="2104">these tools. </span><span class="line" data-startTime="2106">We'll actually also be </span><span class="line" data-startTime="2106">publishing an article that </span><span class="line" data-startTime="2109">goes with this talk, so you can </span><span class="line" data-startTime="2109">get more information on </span><span class="line" data-startTime="2111">how to enable the Object </span><span class="line" data-startTime="2111">Tracker and try it out. </span><span class="line" data-startTime="2114">We'll also send you a </span><span class="line" data-startTime="2114">link to our demo, so </span><span class="line" data-startTime="2117">you can follow along. </span></p>

<p class="speaker"><span class="line" data-starttime="2120"><span class="speakerName">John McCutchan</span>: Yeah. </span><span class="line" data-startTime="2120">You can try this out yourself. </span><span class="line" data-startTime="2121">You can try the continuous </span><span class="line" data-startTime="2121">snapshot technique. </span><span class="line" data-startTime="2124">And the article will be </span><span class="line" data-startTime="2124">available next week. </span></p>

<p class="speaker"><span class="line" data-starttime="2127"><span class="speakerName">Loreena Lee</span>: And then, there's </span><span class="line" data-startTime="2127">the heap profiler. </span> <span class="line" data-startTime="2129">There's the Object Tracker </span><span class="line" data-startTime="2129">that we just showed. </span> <span class="line" data-startTime="2131">And play around with </span><span class="line" data-startTime="2131">everything. </span> <span class="line" data-startTime="2133">The Timeline is really cool. </span> <span class="line" data-startTime="2134">You can see, really, </span><span class="line" data-startTime="2134">everything that </span><span class="line" data-startTime="2136">your page is doing. </span> <span class="line" data-startTime="2136">When you refresh it, </span><span class="line" data-startTime="2136">you can see how the </span><span class="line" data-startTime="2138">page actually displays. </span> <span class="line" data-startTime="2140">There's a lot of great talks </span><span class="line" data-startTime="2140">this week that you guys should </span><span class="line" data-startTime="2142">try to attend as many as you </span><span class="line" data-startTime="2142">can just to get more </span><span class="line" data-startTime="2145">information. </span> <span class="line" data-startTime="2147">All right. </span> <span class="line" data-startTime="2148">That's it. </span> <span class="line" data-startTime="2149">Thank you. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="2149"><span class="speakerName">John McCutchan</span>: Thanks, </span><span class="line" data-startTime="2149">everyone. </span><span class="line" data-startTime="2156">So for reference, there's a </span><span class="line" data-startTime="2156">link to the demo source. </span><span class="line" data-startTime="2161">You can just hit it </span><span class="line" data-startTime="2161">with your browser. </span><span class="line" data-startTime="2163">And here are the instructions </span><span class="line" data-startTime="2163">on how to enable this Object </span><span class="line" data-startTime="2167">Tracker today. </span><span class="line" data-startTime="2171">We can take questions. </span><span class="line" data-startTime="2172">And be sure to rate the </span><span class="line" data-startTime="2172">talk using the app. </span></p>

<p class="speaker"><span class="line" data-starttime="2178"><span class="speakerName">Audience</span>: Hi. </span><span class="line" data-startTime="2181">Well, in an ideal world, your </span><span class="line" data-startTime="2181">application should not have </span><span class="line" data-startTime="2185">memory leaks. </span><span class="line" data-startTime="2185">But there's no ideal </span><span class="line" data-startTime="2185">world yet. </span><span class="line" data-startTime="2187">And so my question is, is it </span><span class="line" data-startTime="2187">possible to have some kind of </span><span class="line" data-startTime="2192">listener with JavaScript that, </span><span class="line" data-startTime="2192">once your application is about </span><span class="line" data-startTime="2197">to hit a memory leak, with </span><span class="line" data-startTime="2197">JavaScript you will know about </span><span class="line" data-startTime="2201">it, and instead of showing this </span><span class="line" data-startTime="2201">or that Jim page, you can </span><span class="line" data-startTime="2205">take some actions before </span><span class="line" data-startTime="2205">actually losing everything? </span></p>

<p class="speaker"><span class="line" data-starttime="2209"><span class="speakerName">John McCutchan</span>: For those of </span><span class="line" data-startTime="2209">you who couldn't hear, the </span><span class="line" data-startTime="2210">question was, could there be an </span><span class="line" data-startTime="2210">event channel that signals </span><span class="line" data-startTime="2214">that a memory leak </span><span class="line" data-startTime="2214">has occurred? </span><span class="line" data-startTime="2215">Is that correct? </span></p>

<p class="speaker"><span class="line" data-starttime="2217"><span class="speakerName">Audience</span>: Is about to occur. </span></p>

<p class="speaker"><span class="line" data-starttime="2218"><span class="speakerName">John McCutchan</span>: Or </span><span class="line" data-startTime="2218">about to occur. </span><span class="line" data-startTime="2219">Yes. </span><span class="line" data-startTime="2220">The issue with that is that </span><span class="line" data-startTime="2220">there is no way to know the </span><span class="line" data-startTime="2223">intention of the programmer. </span><span class="line" data-startTime="2226">V8 can't possibly conclude that, </span><span class="line" data-startTime="2226">oh, this reference in </span><span class="line" data-startTime="2229">the graph that's keeping this </span><span class="line" data-startTime="2229">value here is an error. </span><span class="line" data-startTime="2233">Because maybe you actually </span><span class="line" data-startTime="2233">intended that </span><span class="line" data-startTime="2236">reference to be there. </span><span class="line" data-startTime="2237">Although it would be nice to </span><span class="line" data-startTime="2237">maybe have some event channels </span><span class="line" data-startTime="2241">that tell you when you're </span><span class="line" data-startTime="2241">getting close &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="2243"><span class="speakerName">Audience</span>: Yeah. </span><span class="line" data-startTime="2243">Yeah.  &mdash; to the heap </span><span class="line" data-startTime="2243">size or something. </span><span class="line" data-startTime="2244">Yeah. </span></p>

<p class="speaker"><span class="line" data-starttime="2246"><span class="speakerName">Loreena Lee</span>: You could </span><span class="line" data-startTime="2246">definitely have some sort of </span><span class="line" data-startTime="2248">listener that would poll this </span><span class="line" data-startTime="2248">performance.memory API and </span><span class="line" data-startTime="2251">sort of see that the limit </span><span class="line" data-startTime="2251">is being approached. </span><span class="line" data-startTime="2255">But there's not really any way </span><span class="line" data-startTime="2255">that you could say, hey, you </span><span class="line" data-startTime="2258">know, you've been holding onto </span><span class="line" data-startTime="2258">this thing for a long time. </span><span class="line" data-startTime="2260">Are you sure you wanted to? </span><span class="line" data-startTime="2261">That's actually really, </span><span class="line" data-startTime="2261">really tricky. </span></p>

<p class="speaker"><span class="line" data-starttime="2263"><span class="speakerName">Audience</span>: Oh. </span><span class="line" data-startTime="2263">OK. </span><span class="line" data-startTime="2264">OK, thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="2264"><span class="speakerName">John McCutchan</span>: Thank you. </span></p>

<p class="speaker"><span class="line" data-starttime="2267"><span class="speakerName">Audience</span>: So in terms of that </span><span class="line" data-startTime="2267">process that you guys went </span><span class="line" data-startTime="2269">through last year, obviously </span><span class="line" data-startTime="2269">the example you showed here </span><span class="line" data-startTime="2272">was ridiculously simple. </span><span class="line" data-startTime="2274">So there's kind of like, OK, </span><span class="line" data-startTime="2274">we have a memory leak. </span><span class="line" data-startTime="2277">What did you find were the </span><span class="line" data-startTime="2277">common actual sources of the </span><span class="line" data-startTime="2281">memory leaks, like the </span><span class="line" data-startTime="2281">coding patterns that </span><span class="line" data-startTime="2284">were causing them? </span><span class="line" data-startTime="2285">And in a code base like Gmail, </span><span class="line" data-startTime="2285">which is hundreds of thousands </span><span class="line" data-startTime="2289">of lines of code, how would </span><span class="line" data-startTime="2289">you just narrow it down? </span><span class="line" data-startTime="2292">You have these objects, but then </span><span class="line" data-startTime="2292">you need to know where </span><span class="line" data-startTime="2294">these objects are getting </span><span class="line" data-startTime="2294">allocated and where the bad </span><span class="line" data-startTime="2297">stuff is actually happening. </span></p>

<p class="speaker"><span class="line" data-starttime="2299"><span class="speakerName">Loreena Lee</span>: Right. </span><span class="line" data-startTime="2299">So we had the heap profiler. </span><span class="line" data-startTime="2301">And the Object Tracker </span><span class="line" data-startTime="2301">is brand new. </span><span class="line" data-startTime="2302">So it would have been </span><span class="line" data-startTime="2302">really awesome to </span><span class="line" data-startTime="2303">have that last year. </span></p>

<p class="speaker"><span class="line" data-starttime="2304"><span class="speakerName">Audience</span>: Yeah. </span><span class="line" data-startTime="2305">Yeah. </span></p>

<p class="speaker"><span class="line" data-starttime="2305"><span class="speakerName">Loreena Lee</span>: That would have </span><span class="line" data-startTime="2305">made things a lot easier. </span></p>

<p class="speaker"><span class="line" data-starttime="2306"><span class="speakerName">Audience</span>: For sure. </span></p>

<p class="speaker"><span class="line" data-starttime="2307"><span class="speakerName">Loreena Lee</span>: But using the </span><span class="line" data-startTime="2307">heap profiler, there's a </span><span class="line" data-startTime="2309">technique that you can take </span><span class="line" data-startTime="2309">multiple snapshots and compare </span><span class="line" data-startTime="2312">them to each other. </span> <span class="line" data-startTime="2312">So we performed some actions, </span><span class="line" data-startTime="2312">and we saw that memory was </span><span class="line" data-startTime="2315">growing when we did something </span><span class="line" data-startTime="2315">as simple </span><span class="line" data-startTime="2317">as compose and discard. </span> <span class="line" data-startTime="2318">If you compose a message and you </span><span class="line" data-startTime="2318">discard it, once the Undo </span><span class="line" data-startTime="2322">[? butterbar ?] </span><span class="line" data-startTime="2322">disappears, we really expected </span><span class="line" data-startTime="2322">that there should be nothing </span><span class="line" data-startTime="2325">left over from that action. </span> <span class="line" data-startTime="2326">And so we could perform </span><span class="line" data-startTime="2326">something like that and then </span><span class="line" data-startTime="2329">do these comparisons between </span><span class="line" data-startTime="2329">multiple heap profiles, heap </span><span class="line" data-startTime="2333">snapshots, and see </span><span class="line" data-startTime="2333">what's lingering. </span></p>

<p><span class="line" data-startTime="2337">And in those cases, we could </span><span class="line" data-startTime="2337">find certain objects, and we </span><span class="line" data-startTime="2340">could look for those particular </span><span class="line" data-startTime="2340">objects that were </span><span class="line" data-startTime="2343">being left behind. </span> <span class="line" data-startTime="2344">So that was one of them. </span> <span class="line" data-startTime="2346">I would say we have a few </span><span class="line" data-startTime="2346">different categories of bugs </span><span class="line" data-startTime="2349">that we found. </span> <span class="line" data-startTime="2350">One of them was things like </span><span class="line" data-startTime="2350">infinitely growing caches, so </span><span class="line" data-startTime="2355">things where we were saving </span><span class="line" data-startTime="2355">references to things that we </span><span class="line" data-startTime="2357">didn't mean to. </span> <span class="line" data-startTime="2359">One case, we had a list of </span><span class="line" data-startTime="2359">callbacks that were supposed </span><span class="line" data-startTime="2361">to be invoked when a particular </span><span class="line" data-startTime="2361">action occurred. </span> <span class="line" data-startTime="2365">And that action never occurred, </span><span class="line" data-startTime="2365">so we had an </span><span class="line" data-startTime="2366">infinitely growing list </span><span class="line" data-startTime="2366">of callbacks. </span> <span class="line" data-startTime="2370">There was also a bunch of </span><span class="line" data-startTime="2370">cases where we had event </span><span class="line" data-startTime="2373">listeners attached to </span><span class="line" data-startTime="2373">particular objects. </span></p>

<p><span class="line" data-startTime="2375">And the event listener </span><span class="line" data-startTime="2375">was acting as a </span><span class="line" data-startTime="2378">reference on those objects. </span> <span class="line" data-startTime="2381">The reason why I didn't </span><span class="line" data-startTime="2381">mention it here </span><span class="line" data-startTime="2382">is the Closure team &mdash; </span><span class="line" data-startTime="2384">we use the Closure Compiler &mdash; </span><span class="line" data-startTime="2387">they've gone through some really </span><span class="line" data-startTime="2387">amazing hoops to try to </span><span class="line" data-startTime="2389">eliminate this particular </span><span class="line" data-startTime="2389">coding problem. </span> <span class="line" data-startTime="2393">And so if you do use Closure and </span><span class="line" data-startTime="2393">you do have this problem </span><span class="line" data-startTime="2396">where you have event listeners </span><span class="line" data-startTime="2396">that are causing references to </span><span class="line" data-startTime="2398">particular objects sticking </span><span class="line" data-startTime="2398">around, newer versions of </span><span class="line" data-startTime="2402">Closure should eliminate </span><span class="line" data-startTime="2402">that problem for you. </span></p>

<p class="speaker"><span class="line" data-starttime="2404"><span class="speakerName">Audience</span>: OK. </span><span class="line" data-startTime="2404">Great, thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="2405"><span class="speakerName">John McCutchan</span>: Thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="2407"><span class="speakerName">Audience</span>: What would be the </span><span class="line" data-startTime="2407">ideal size for the young space </span><span class="line" data-startTime="2411">to avoid frequent GC pause? </span><span class="line" data-startTime="2413">How would you determine that? </span></p>

<p class="speaker"><span class="line" data-starttime="2415"><span class="speakerName">John McCutchan</span>: Well, the ideal </span><span class="line" data-startTime="2415">size would be infinite. </span><span class="line" data-startTime="2418">You could just have it </span><span class="line" data-startTime="2418">grow forever, and </span><span class="line" data-startTime="2420">you'd never GC pause. </span><span class="line" data-startTime="2422">It's actually very difficult to </span><span class="line" data-startTime="2422">find that sweet spot of a </span><span class="line" data-startTime="2427">practical number. </span><span class="line" data-startTime="2430">So that's a difficult </span><span class="line" data-startTime="2430">question. </span><span class="line" data-startTime="2434">There's not a straightforward </span><span class="line" data-startTime="2434">answer to it, I suppose. </span></p>

<p class="speaker"><span class="line" data-starttime="2436"><span class="speakerName">Audience</span>: OK. </span><span class="line" data-startTime="2436">So if I can actually </span><span class="line" data-startTime="2436">tack this on. </span></p>

<p class="speaker"><span class="line" data-starttime="2439"><span class="speakerName">John McCutchan</span>: Sure. </span></p>

<p class="speaker"><span class="line" data-starttime="2440"><span class="speakerName">Audience</span>: In the GC pause that </span><span class="line" data-startTime="2440">you showed, freeing up two </span><span class="line" data-startTime="2443">objects had enough room for E. </span><span class="line" data-startTime="2443">If there wasn't enough room </span><span class="line" data-startTime="2447">for E, in that case would </span><span class="line" data-startTime="2447">that flush to old? </span></p>

<p class="speaker"><span class="line" data-starttime="2452"><span class="speakerName">John McCutchan</span>: No. </span><span class="line" data-startTime="2453">Young generation. </span><span class="line" data-startTime="2454">Collection occurs without an </span><span class="line" data-startTime="2454">old generation collection. </span></p>

<p class="speaker"><span class="line" data-starttime="2457"><span class="speakerName">Audience</span>: But if the flushing </span><span class="line" data-startTime="2457">two objects didn't have enough </span><span class="line" data-startTime="2460">room for E? </span></p>

<p class="speaker"><span class="line" data-starttime="2460"><span class="speakerName">John McCutchan</span>: Oh, I see. </span><span class="line" data-startTime="2461">Yeah. </span><span class="line" data-startTime="2462">At that point, you would fall </span><span class="line" data-startTime="2462">back to we have to do a full </span><span class="line" data-startTime="2466">collection and try </span><span class="line" data-startTime="2466">and free memory. </span><span class="line" data-startTime="2469">Yes. </span></p>

<p class="speaker"><span class="line" data-starttime="2469"><span class="speakerName">Audience</span>: OK. </span><span class="line" data-startTime="2469">Good. </span><span class="line" data-startTime="2470">Thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="2472"><span class="speakerName">John McCutchan</span>: Thanks. </span><span class="line" data-startTime="2473">Yeah. </span><span class="line" data-startTime="2473">Hey. </span></p>

<p class="speaker"><span class="line" data-starttime="2473"><span class="speakerName">Audience</span>: So some of the graphs </span><span class="line" data-startTime="2473">you showed with the </span><span class="line" data-startTime="2476">Gmail performance with the </span><span class="line" data-startTime="2476">different percentiles, that's </span><span class="line" data-startTime="2479">actually awesome. </span><span class="line" data-startTime="2482">So do you have any tips for </span><span class="line" data-startTime="2482">building tools like that? </span><span class="line" data-startTime="2485">Are there any tools that you </span><span class="line" data-startTime="2485">know of that can help monitor </span><span class="line" data-startTime="2488">your users in production? </span></p>

<p class="speaker"><span class="line" data-starttime="2491"><span class="speakerName">Loreena Lee</span>: You can actually </span><span class="line" data-startTime="2491">just call the </span><span class="line" data-startTime="2492">performance.memory API </span><span class="line" data-startTime="2492">from your application </span><span class="line" data-startTime="2495">at any given time. </span><span class="line" data-startTime="2496">[INAUDIBLE]. </span></p>

<p class="speaker"><span class="line" data-starttime="2496"><span class="speakerName">Audience</span>: And that's for memory </span><span class="line" data-startTime="2496">and UI latency as well? </span></p>

<p class="speaker"><span class="line" data-starttime="2501"><span class="speakerName">Loreena Lee</span>: The latency is a </span><span class="line" data-startTime="2501">totally separate tracker. </span><span class="line" data-startTime="2503">We have a separate tracker. </span><span class="line" data-startTime="2505">We're actually out of </span><span class="line" data-startTime="2505">time, but we're </span><span class="line" data-startTime="2506">happy to stick around. </span><span class="line" data-startTime="2509">We'll probably head upstairs </span><span class="line" data-startTime="2509">to the Chrome </span><span class="line" data-startTime="2511">office hours area. </span></p>

<p class="speaker"><span class="line" data-starttime="2514"><span class="speakerName">John McCutchan</span>: So anyone who </span><span class="line" data-startTime="2514">still has questions, you can </span><span class="line" data-startTime="2516">just meet up upstairs in like </span><span class="line" data-startTime="2516">10 minutes, and we'll take </span><span class="line" data-startTime="2519">questions there. </span></p>

<p class="speaker"><span class="line" data-starttime="2520"><span class="speakerName">Loreena Lee</span>: But the short </span><span class="line" data-startTime="2520">answer is that latency we </span><span class="line" data-startTime="2522">track completely separately. </span></p>

<p class="speaker"><span class="line" data-starttime="2524"><span class="speakerName">John McCutchan</span>: Thank </span><span class="line" data-startTime="2524">you, everyone. </span></p>

<p class="speaker"><span class="line" data-starttime="2525"><span class="speakerName">Loreena Lee</span>: Thank you. </span></p>