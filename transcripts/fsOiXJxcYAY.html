<style>* {font-family: "Open Sans", sans-serif}
a {color: #77aaff}
a.video {border-bottom: 1px solid #ddd; display: block; margin: 0 0 2em 0; padding: 0 0 2em 0}
h2 {color: #444; font-size: 18px;}
span.speakerName {color: black; font-weight: 900;}
body {padding: 2em}
p {color: #444; margin: 0; text-indent: 1.5em;}
p.speaker {margin: 1em 0 0 0; text-indent: 0;}
div#transcript > p:first-child {text-indent: 0;}
</style>

<h1>Google I/O 2013 &mdash; Speed, Efficiency, and Control- Advanced Packet Routing Techniques</h1>

<h2>Sunil James, John Carmie</h2>

<a class="video" href="http://youtu.be/fsOiXJxcYAY">youtu.be/fsOiXJxcYAY</a><div id="transcript"><p class="speaker"><span class="line" data-starttime="1"><span class="speakerName">Sunil James</span>: Good morning, </span><span class="line" data-startTime="1">everybody. </span> <span class="line" data-startTime="3">My name's Sunil James, and I'm </span><span class="line" data-startTime="3">a product manager with Google </span><span class="line" data-startTime="6">Cloud Platform. </span> <span class="line" data-startTime="7">With me is John Cormie, </span><span class="line" data-startTime="7">a senior </span><span class="line" data-startTime="9">engineer also on the team. </span> <span class="line" data-startTime="11">And today, we're going to be </span><span class="line" data-startTime="11">introducing to you a brand new </span><span class="line" data-startTime="13">feature in Google Compute Engine </span><span class="line" data-startTime="13">that delivers to you </span><span class="line" data-startTime="16">greater network control </span><span class="line" data-startTime="16">than ever before. </span> <span class="line" data-startTime="19">So let's get to it. </span> <span class="line" data-startTime="22">So I know this is supposed to </span><span class="line" data-startTime="22">be an advanced session. </span> <span class="line" data-startTime="25">But I thought it wise to take </span><span class="line" data-startTime="25">just a few minutes to walk you </span><span class="line" data-startTime="28">through some of the </span><span class="line" data-startTime="28">basics of what GCE </span><span class="line" data-startTime="29">networking has to offer. </span> <span class="line" data-startTime="34">So first, Google Computer Engine </span><span class="line" data-startTime="34">allows you to create a </span><span class="line" data-startTime="37">private layer three network </span><span class="line" data-startTime="37">within the context of the </span><span class="line" data-startTime="40">broader Google Cloud </span><span class="line" data-startTime="40">that can cut across </span><span class="line" data-startTime="41">multiple GCE regions. </span></p>

<p><span class="line" data-startTime="44">By default, a GCE region is </span><span class="line" data-startTime="44">sized to a /16 insider </span><span class="line" data-startTime="48">notation, which is about 65,000 </span><span class="line" data-startTime="48">RFC 1918 IP addresses. </span> <span class="line" data-startTime="53">Second, GCE gives you the </span><span class="line" data-startTime="53">ability to attach a static, </span><span class="line" data-startTime="57">public IP address to any given </span><span class="line" data-startTime="57">instance within your network. </span> <span class="line" data-startTime="61">These IPs are portable across </span><span class="line" data-startTime="61">zones within a region. </span> <span class="line" data-startTime="67">Third, as part of the underlying </span><span class="line" data-startTime="67">network fabric, GCE </span><span class="line" data-startTime="71">delivers to you industrial grade </span><span class="line" data-startTime="71">firewall technology that </span><span class="line" data-startTime="74">enables you to define which </span><span class="line" data-startTime="74">incoming connections are </span><span class="line" data-startTime="77">accepted by which instances. </span> <span class="line" data-startTime="79">And by the way, this fabric is </span><span class="line" data-startTime="79">the same exact fabric, same </span><span class="line" data-startTime="83">global, high bandwidth, low </span><span class="line" data-startTime="83">latency backbone network </span><span class="line" data-startTime="86">that's used by all the other </span><span class="line" data-startTime="86">Google created Google products </span><span class="line" data-startTime="89">that you probably use </span><span class="line" data-startTime="89">every single day. </span> <span class="line" data-startTime="96">So we launched GCE last year. </span> <span class="line" data-startTime="99">And we've spent a lot of time </span><span class="line" data-startTime="99">talking to developers, talking </span><span class="line" data-startTime="102">to customers, trying to </span><span class="line" data-startTime="102">understand what they want to </span><span class="line" data-startTime="105">do, what they want to achieve. </span></p>

<p><span class="line" data-startTime="108">And from the networking </span><span class="line" data-startTime="108">standpoint, it's a </span><span class="line" data-startTime="111">long list of things. </span> <span class="line" data-startTime="112">And we're going to be working </span><span class="line" data-startTime="112">very hard to deliver month </span><span class="line" data-startTime="115">over month over the coming </span><span class="line" data-startTime="115">months a great set of </span><span class="line" data-startTime="117">networking capabilities. </span> <span class="line" data-startTime="118">But to start off with for today, </span><span class="line" data-startTime="118">I want to talk about </span><span class="line" data-startTime="121">some of the nearer term or </span><span class="line" data-startTime="121">most pressing issues that </span><span class="line" data-startTime="124">customers have said they'd like </span><span class="line" data-startTime="124">to be able to tackle. </span> <span class="line" data-startTime="127">First, we've had customers say </span><span class="line" data-startTime="127">to us, I'd really like to be </span><span class="line" data-startTime="130">able to create and enable </span><span class="line" data-startTime="130">hybrid cloud. </span> <span class="line" data-startTime="133">I'd like to be able to connect </span><span class="line" data-startTime="133">my existing data centers with </span><span class="line" data-startTime="136">my private GCE networks so </span><span class="line" data-startTime="136">that I can actually move </span><span class="line" data-startTime="138">workloads between two without </span><span class="line" data-startTime="138">necessarily breaking the </span><span class="line" data-startTime="142">security barrier that exist </span><span class="line" data-startTime="142">with my existing WAN. </span> <span class="line" data-startTime="146">Another use case has been, I'd </span><span class="line" data-startTime="146">really like to be able to have </span><span class="line" data-startTime="149">the ability to have all my </span><span class="line" data-startTime="149">private VMs share just one, </span><span class="line" data-startTime="154">static IP address. </span></p>

<p><span class="line" data-startTime="155">Just give me a NAT </span><span class="line" data-startTime="155">opportunity. </span> <span class="line" data-startTime="156">Or give me a NAT instance, </span><span class="line" data-startTime="156">for example. </span> <span class="line" data-startTime="158">And then third, we've had </span><span class="line" data-startTime="158">customers who say, I want to </span><span class="line" data-startTime="160">be able to instrument proxies </span><span class="line" data-startTime="160">within the context of my </span><span class="line" data-startTime="163">networks so that I can do </span><span class="line" data-startTime="163">things like enforce AUP </span><span class="line" data-startTime="165">policies and things </span><span class="line" data-startTime="165">of that sort. </span> <span class="line" data-startTime="169">So we've digested all </span><span class="line" data-startTime="169">of this feedback. </span> <span class="line" data-startTime="170">And we're really proud and </span><span class="line" data-startTime="170">really excited to give you </span><span class="line" data-startTime="173">guys a chance to take a look at </span><span class="line" data-startTime="173">the set of advanced routing </span><span class="line" data-startTime="176">capabilities that GCE is </span><span class="line" data-startTime="176">bringing to market today. </span> <span class="line" data-startTime="184">So the work that we've done </span><span class="line" data-startTime="184">with the advanced routing </span><span class="line" data-startTime="187">extends upon a set of networking </span><span class="line" data-startTime="187">technologies that </span><span class="line" data-startTime="189">have been in GCE </span><span class="line" data-startTime="189">since day one. </span> <span class="line" data-startTime="193">The diagram on this slide </span><span class="line" data-startTime="193">describe some of the basic </span><span class="line" data-startTime="196">components within the GCE </span><span class="line" data-startTime="196">network, starting with that </span><span class="line" data-startTime="199">red object, which is a massively </span><span class="line" data-startTime="199">scalable, virtual </span><span class="line" data-startTime="203">router that sits at the core of </span><span class="line" data-startTime="203">every single GCE network. </span> <span class="line" data-startTime="206">Every single VM in your network </span><span class="line" data-startTime="206">is directly connected </span><span class="line" data-startTime="210">to this router. </span></p>

<p><span class="line" data-startTime="210">So when a VM needs to send a </span><span class="line" data-startTime="210">packet, the router takes a </span><span class="line" data-startTime="213">look at the VMs [INAUDIBLE] a </span><span class="line" data-startTime="213">routing table, as indicated by </span><span class="line" data-startTime="216">those tan boxes, and then </span><span class="line" data-startTime="216">determines what the </span><span class="line" data-startTime="218">next hop should be. </span> <span class="line" data-startTime="220">Starting today, we're beginning </span><span class="line" data-startTime="220">to give you greater </span><span class="line" data-startTime="225">ability to actually configure </span><span class="line" data-startTime="225">this router than ever before. </span> <span class="line" data-startTime="229">And that's what GCE advanced </span><span class="line" data-startTime="229">routing's all about. </span> <span class="line" data-startTime="236">As you'll see in the rest of </span><span class="line" data-startTime="236">this presentation, we've </span><span class="line" data-startTime="238">extended the routing </span><span class="line" data-startTime="238">capabilities so that you can </span><span class="line" data-startTime="240">do many of the things that </span><span class="line" data-startTime="240">I was talking about </span><span class="line" data-startTime="242">beforehand and more. </span> <span class="line" data-startTime="244">But a few procedural items just </span><span class="line" data-startTime="244">make sure we're all on </span><span class="line" data-startTime="246">the same page. </span> <span class="line" data-startTime="246">So first, each cloud project you </span><span class="line" data-startTime="246">create includes one routes </span><span class="line" data-startTime="250">collection that contains all the </span><span class="line" data-startTime="250">routes applicable to the </span><span class="line" data-startTime="253">GCE network's provision as </span><span class="line" data-startTime="253">part of that project. </span></p>

<p><span class="line" data-startTime="256">Second, each GCE network has two </span><span class="line" data-startTime="256">default routes, one that </span><span class="line" data-startTime="260">automatically routes traffic to </span><span class="line" data-startTime="260">the internet, and one that </span><span class="line" data-startTime="263">routes VM to VM traffic within </span><span class="line" data-startTime="263">your network itself. </span> <span class="line" data-startTime="269">So let's talk about some of the </span><span class="line" data-startTime="269">components of what is in </span><span class="line" data-startTime="272">GCE advanced routing. </span> <span class="line" data-startTime="273">First off, we have </span><span class="line" data-startTime="273">route names. </span> <span class="line" data-startTime="276">So route name is the user </span><span class="line" data-startTime="276">friendly name of a route. </span> <span class="line" data-startTime="278">In this case, we named the route </span><span class="line" data-startTime="278">vpn-route to indicate a </span><span class="line" data-startTime="281">route for VPN traffic. </span> <span class="line" data-startTime="283">Second, we have network. </span> <span class="line" data-startTime="285">Network is the name of the GCE </span><span class="line" data-startTime="285">network to which the route is </span><span class="line" data-startTime="288">applicable to. </span> <span class="line" data-startTime="291">Third, we have destination </span><span class="line" data-startTime="291">range. </span> <span class="line" data-startTime="293">This is the set of IP addresses </span><span class="line" data-startTime="293">to which the route's </span><span class="line" data-startTime="295">going to apply. </span></p>

<p><span class="line" data-startTime="298">Fourth, we have instance tags. </span> <span class="line" data-startTime="300">So instance tags tell the </span><span class="line" data-startTime="300">virtual router which VMs a </span><span class="line" data-startTime="304">route needs to apply to. </span> <span class="line" data-startTime="305">So if a route has no tags, for </span><span class="line" data-startTime="305">example, it then applies to </span><span class="line" data-startTime="308">all the VMs within the </span><span class="line" data-startTime="308">network itself. </span> <span class="line" data-startTime="313">Next hop, it directs the </span><span class="line" data-startTime="313">router to send matching </span><span class="line" data-startTime="316">traffic to a designated </span><span class="line" data-startTime="316">VM or a gateway. </span> <span class="line" data-startTime="318">Next hop VMs can be </span><span class="line" data-startTime="318">identified both by </span><span class="line" data-startTime="320">name and by IP address. </span> <span class="line" data-startTime="323">And then lastly, priority value, </span><span class="line" data-startTime="323">which is used to help </span><span class="line" data-startTime="325">break ties. </span></p>

<p><span class="line" data-startTime="328">Rather, I'm sorry, priority </span><span class="line" data-startTime="328">value, which is used to help </span><span class="line" data-startTime="330">break ties when there are more </span><span class="line" data-startTime="330">than one most specific </span><span class="line" data-startTime="334">matching route. </span> <span class="line" data-startTime="335">So lower priority value </span><span class="line" data-startTime="335">actually equals higher </span><span class="line" data-startTime="338">priority, like when you're </span><span class="line" data-startTime="338">prioritizing </span><span class="line" data-startTime="340">bugs, if you will. </span> <span class="line" data-startTime="344">So when a packet leaves a VM, </span><span class="line" data-startTime="344">the virtual router employees </span><span class="line" data-startTime="347">the following logic </span><span class="line" data-startTime="347">to decide how to </span><span class="line" data-startTime="349">route the packet itself. </span> <span class="line" data-startTime="351">First, GCE only keeps the most </span><span class="line" data-startTime="351">specific routes that match a </span><span class="line" data-startTime="354">packet's destination. </span> <span class="line" data-startTime="356">Next, it looks at the remaining </span><span class="line" data-startTime="356">routes, and then </span><span class="line" data-startTime="359">only keeps those with the lowest </span><span class="line" data-startTime="359">priority value, which </span><span class="line" data-startTime="362">as we mentioned earlier indicate </span><span class="line" data-startTime="362">highest priority. </span></p>

<p><span class="line" data-startTime="366">And then lastly, if there are </span><span class="line" data-startTime="366">any remaining ties, the </span><span class="line" data-startTime="369">virtual router then computes a </span><span class="line" data-startTime="369">hash based on the fields you </span><span class="line" data-startTime="371">see in the slide to select </span><span class="line" data-startTime="371">the next hop. </span> <span class="line" data-startTime="375">If the next hop is found, the </span><span class="line" data-startTime="375">virtual router then forwards </span><span class="line" data-startTime="378">the packet along. </span> <span class="line" data-startTime="379">If it's not, the virtual </span><span class="line" data-startTime="379">router's going to drop that </span><span class="line" data-startTime="381">packet and reply back with an </span><span class="line" data-startTime="381">ICP destination or network </span><span class="line" data-startTime="384">unreachable error. </span> <span class="line" data-startTime="393">And one last thing I'd like to </span><span class="line" data-startTime="393">mention to you is that before </span><span class="line" data-startTime="396">you can employee a VM as a </span><span class="line" data-startTime="396">forwarding device, you must </span><span class="line" data-startTime="400">upon creating that VM set the </span><span class="line" data-startTime="400">can_ip_forward flag as shown </span><span class="line" data-startTime="404">in the example GCE [INAUDIBLE] </span><span class="line" data-startTime="404">command that's </span><span class="line" data-startTime="406">on the screen here. </span> <span class="line" data-startTime="407">The reason for this is because </span><span class="line" data-startTime="407">GCE's default security posture </span><span class="line" data-startTime="411">prevents VMs from spoofing </span><span class="line" data-startTime="411">the source IP address </span><span class="line" data-startTime="413">of egressing packets. </span> <span class="line" data-startTime="415">As such, enabling this flag </span><span class="line" data-startTime="415">actually allows the VM to </span><span class="line" data-startTime="418">forward packets with a source IP </span><span class="line" data-startTime="418">address other than its own, </span><span class="line" data-startTime="420">which is exactly the </span><span class="line" data-startTime="420">functionality we need </span><span class="line" data-startTime="422">here in this case. </span> <span class="line" data-startTime="426">Now, I know that these </span><span class="line" data-startTime="429">capabilities are really powerful. </span></p>

<p><span class="line" data-startTime="430">But I know that they're also </span><span class="line" data-startTime="430">sometimes really complex. </span> <span class="line" data-startTime="433">And so personally, I find </span><span class="line" data-startTime="433">it helpful to visualize </span><span class="line" data-startTime="437">this kind of stuff. </span> <span class="line" data-startTime="437">So maybe John, you can walk us </span><span class="line" data-startTime="437">through some examples to </span><span class="line" data-startTime="440">describe what we've </span><span class="line" data-startTime="440">been having here. </span></p>

<p class="speaker"><span class="line" data-starttime="441"><span class="speakerName">John Carmie</span>: Yeah. </span> <span class="line" data-startTime="442">Thanks, Sunil. </span> <span class="line" data-startTime="443">Thank you. </span> <span class="line" data-startTime="444">All right, so for each one of </span><span class="line" data-startTime="444">those things that Sunil just </span><span class="line" data-startTime="447">told you about, we're going to </span><span class="line" data-startTime="447">illustrate it with an example. </span> <span class="line" data-startTime="450">The first thing I want to show </span><span class="line" data-startTime="450">you an example of is </span><span class="line" data-startTime="452">constructing the </span><span class="line" data-startTime="452">routing table. </span> <span class="line" data-startTime="455">All right, so here on the white </span><span class="line" data-startTime="455">board, I've drawn a </span><span class="line" data-startTime="458">network in Compute Engine. </span> <span class="line" data-startTime="460">And we have the project's route </span><span class="line" data-startTime="460">collection of to the </span><span class="line" data-startTime="462">right hand side there. </span> <span class="line" data-startTime="464">The components are the route </span><span class="line" data-startTime="464">name, one through three, the </span><span class="line" data-startTime="466">tags, which are represented as </span><span class="line" data-startTime="466">little tag shaped colors, and </span><span class="line" data-startTime="470">the network, which is </span><span class="line" data-startTime="470">the third column. </span></p>

<p><span class="line" data-startTime="472">So the routing table for an </span><span class="line" data-startTime="472">instance, remember, is a </span><span class="line" data-startTime="476">subset of this project's </span><span class="line" data-startTime="476">route collection. </span> <span class="line" data-startTime="478">And the system constructs it </span><span class="line" data-startTime="478">by selecting rows from that </span><span class="line" data-startTime="482">table where the network matches </span><span class="line" data-startTime="482">and the tags match. </span> <span class="line" data-startTime="486">You need to know that if there </span><span class="line" data-startTime="486">are no tags on a route, it </span><span class="line" data-startTime="488">means it matches any VM. </span> <span class="line" data-startTime="490">So let's look at one example, </span><span class="line" data-startTime="490">that top VM there, number one. </span> <span class="line" data-startTime="493">It gets route one because route </span><span class="line" data-startTime="493">one has no tags, and so </span><span class="line" data-startTime="496">it matches any VM. </span> <span class="line" data-startTime="497">It gets route three because </span><span class="line" data-startTime="497">it shares the </span><span class="line" data-startTime="499">green tag in common. </span> <span class="line" data-startTime="501">It does not get route two </span><span class="line" data-startTime="501">because it doesn't share any </span><span class="line" data-startTime="503">tag in common. </span> <span class="line" data-startTime="504">If you're familiar with Compute </span><span class="line" data-startTime="504">Engine firewalls, this </span><span class="line" data-startTime="507">is all very similar. </span></p>

<p><span class="line" data-startTime="510">All right, now that we have </span><span class="line" data-startTime="510">a routing table, imagine a </span><span class="line" data-startTime="514">packet leaves the VM. </span> <span class="line" data-startTime="515">And the system's got to pick </span><span class="line" data-startTime="515">the next hop for it. </span> <span class="line" data-startTime="518">It's going to consult this </span><span class="line" data-startTime="518">routing table and walk through </span><span class="line" data-startTime="520">that route selection recipe that </span><span class="line" data-startTime="520">Sunil just told us about. </span> <span class="line" data-startTime="524">There are three steps. </span> <span class="line" data-startTime="525">And I'm going to illustrate two </span><span class="line" data-startTime="525">of those with examples. </span> <span class="line" data-startTime="528">The first thing the system does, </span><span class="line" data-startTime="528">recall, is it's going to </span><span class="line" data-startTime="530">pick the most specific routes, </span><span class="line" data-startTime="530">the most specific matching </span><span class="line" data-startTime="534">routes from the instances </span><span class="line" data-startTime="534">table. </span> <span class="line" data-startTime="538">So for again, the visual </span><span class="line" data-startTime="538">thinkers out there, this is </span><span class="line" data-startTime="541">how I think about most </span><span class="line" data-startTime="541">specific matches. </span></p>

<p><span class="line" data-startTime="543">In this example, we have </span><span class="line" data-startTime="543">a packet destined for </span><span class="line" data-startTime="545">10.120.1.2. </span> <span class="line" data-startTime="547">It's that star at the </span><span class="line" data-startTime="547">bottom there. </span> <span class="line" data-startTime="549">And the routing table is </span><span class="line" data-startTime="549">the four routes in </span><span class="line" data-startTime="553">the upper right corner. </span> <span class="line" data-startTime="556">First, I want to tell you a </span><span class="line" data-startTime="556">little bit about the notation </span><span class="line" data-startTime="558">if it's not familiar. </span> <span class="line" data-startTime="559">For example, 10.120.0.0/16. </span> <span class="line" data-startTime="562">That's how we denote </span><span class="line" data-startTime="562">an IP prefix. </span> <span class="line" data-startTime="565">The thing on the left-hand </span><span class="line" data-startTime="565">side of the </span><span class="line" data-startTime="566">slash is the IP prefix. </span> <span class="line" data-startTime="568">And the thing on the right hand </span><span class="line" data-startTime="568">side tells you how many </span><span class="line" data-startTime="569">bits of that address </span><span class="line" data-startTime="569">are significant. </span> <span class="line" data-startTime="572">So 10.120.0.0/16 means anything </span><span class="line" data-startTime="576">that starts with 10.120. </span> <span class="line" data-startTime="581">Now, I like to think of the IP </span><span class="line" data-startTime="581">address space as a giant </span><span class="line" data-startTime="584">binary tree. </span> <span class="line" data-startTime="585">And the root of that tree </span><span class="line" data-startTime="585">is the top of that </span><span class="line" data-startTime="587">black triangle there. </span> <span class="line" data-startTime="588">The leaves, all 2 to the 32 of </span><span class="line" data-startTime="588">them, are the IP addresses </span><span class="line" data-startTime="591">themselves. </span></p>

<p><span class="line" data-startTime="592">And they run along the bottom. </span> <span class="line" data-startTime="593">And the interior nodes </span><span class="line" data-startTime="593">are IP prefixes. </span> <span class="line" data-startTime="596">And that's where we can hang </span><span class="line" data-startTime="596">routes off in our table. </span> <span class="line" data-startTime="600">So there's four routes </span><span class="line" data-startTime="600">in this example. </span> <span class="line" data-startTime="603">And you can see visually that </span><span class="line" data-startTime="603">for this destination, three of </span><span class="line" data-startTime="607">them match &mdash; black, red, and </span><span class="line" data-startTime="607">blue &mdash; because their </span><span class="line" data-startTime="610">destination lies within the </span><span class="line" data-startTime="610">sub-trees of those routes. </span> <span class="line" data-startTime="614">It does not much green because </span><span class="line" data-startTime="614">it doesn't lie within the </span><span class="line" data-startTime="616">green subtree. </span> <span class="line" data-startTime="618">OK, so we have three matches. </span> <span class="line" data-startTime="619">But we only care about </span><span class="line" data-startTime="619">the most specific. </span> <span class="line" data-startTime="622">Now again, you can see visually </span><span class="line" data-startTime="622">that the most </span><span class="line" data-startTime="626">specific routes are the </span><span class="line" data-startTime="626">smallest subtrees. </span> <span class="line" data-startTime="628">And so we actually have a </span><span class="line" data-startTime="628">tie for most specific </span><span class="line" data-startTime="630">between red and blue. </span> <span class="line" data-startTime="632">Even though black matches, </span><span class="line" data-startTime="632">it's less specific </span><span class="line" data-startTime="634">than red and blue. </span> <span class="line" data-startTime="635">And so it doesn't apply. </span></p>

<p><span class="line" data-startTime="637">All right, so now we have the </span><span class="line" data-startTime="637">most specific matches. </span> <span class="line" data-startTime="641">The next step of the route </span><span class="line" data-startTime="641">selection recipe is the </span><span class="line" data-startTime="644">priority selection. </span> <span class="line" data-startTime="646">That's pretty straightforward. </span> <span class="line" data-startTime="648">We discard routes of lower </span><span class="line" data-startTime="648">priority, so I'm not going to </span><span class="line" data-startTime="650">illustrate that. </span> <span class="line" data-startTime="651">We'll jump to the third step, </span><span class="line" data-startTime="651">which is flow hashing. </span> <span class="line" data-startTime="655">So there can only </span><span class="line" data-startTime="655">be one next hop. </span> <span class="line" data-startTime="657">And so if you have ties left </span><span class="line" data-startTime="657">that are equally specific and </span><span class="line" data-startTime="662">equal priority, we have to </span><span class="line" data-startTime="662">pick one of them somehow. </span> <span class="line" data-startTime="665">And so as Sunil said earlier, </span><span class="line" data-startTime="665">the system computes a hash of </span><span class="line" data-startTime="668">the destination packet. </span> <span class="line" data-startTime="669">And you can see this at the </span><span class="line" data-startTime="669">bottom of the slide. </span></p>

<p><span class="line" data-startTime="672">H is the hash function. </span> <span class="line" data-startTime="673">And it operates on all the parts </span><span class="line" data-startTime="673">of that packet leaving </span><span class="line" data-startTime="676">the VM &mdash; source IP, the source </span><span class="line" data-startTime="676">port if there is one, the </span><span class="line" data-startTime="680">destination IP, the destination </span><span class="line" data-startTime="680">port if there is </span><span class="line" data-startTime="683">one, and the protocol. </span> <span class="line" data-startTime="684">And so out of the hash function, </span><span class="line" data-startTime="684">we get a number. </span> <span class="line" data-startTime="689">And we use that number to index </span><span class="line" data-startTime="689">into any remaining ties. </span> <span class="line" data-startTime="692">And whichever route that picks, </span><span class="line" data-startTime="692">that's where the packet </span><span class="line" data-startTime="695">goes as the next hop. </span> <span class="line" data-startTime="698">OK, so now you understand </span><span class="line" data-startTime="698">the algorithm and the </span><span class="line" data-startTime="700">mechanics of this. </span> <span class="line" data-startTime="701">But like, why? </span><span class="line" data-startTime="703">Why do we do this? </span><span class="line" data-startTime="703">What is the hash good for? </span><span class="line" data-startTime="705">Well, the answer is scale. </span></p>

<p><span class="line" data-startTime="707">And I'm going to illustrate </span><span class="line" data-startTime="707">it with this example. </span> <span class="line" data-startTime="710">So in this example network, </span><span class="line" data-startTime="710">the administrator has </span><span class="line" data-startTime="713">configured it so that all </span><span class="line" data-startTime="713">traffic going to the internet </span><span class="line" data-startTime="716">needs to pass through a gateway </span><span class="line" data-startTime="716">VM, say for some </span><span class="line" data-startTime="719">security or policy reason. </span> <span class="line" data-startTime="721">Now, this works fine for a </span><span class="line" data-startTime="721">while, but the number of VMs </span><span class="line" data-startTime="726">in his or her network is </span><span class="line" data-startTime="726">growing over time. </span> <span class="line" data-startTime="728">And so eventually, we get to a </span><span class="line" data-startTime="728">point where no one gateway can </span><span class="line" data-startTime="730">handle the number of </span><span class="line" data-startTime="730">packets that are </span><span class="line" data-startTime="732">flowing to the internet. </span></p>

<p><span class="line" data-startTime="734">And so yeah, you can buy a </span><span class="line" data-startTime="734">bigger VM for the gateway to </span><span class="line" data-startTime="738">have more power to process </span><span class="line" data-startTime="738">those packets. </span> <span class="line" data-startTime="740">But eventually, you're buying </span><span class="line" data-startTime="740">our biggest VM, and you can't </span><span class="line" data-startTime="743">scale up anymore. </span> <span class="line" data-startTime="744">You have to scale out. </span> <span class="line" data-startTime="745">And so as you can see in this </span><span class="line" data-startTime="745">picture, we've scaled out by </span><span class="line" data-startTime="747">adding a second gateway. </span> <span class="line" data-startTime="749">But the second gateway only </span><span class="line" data-startTime="749">helps you if you can </span><span class="line" data-startTime="751">distribute load across </span><span class="line" data-startTime="751">gateways. </span></p>

<p><span class="line" data-startTime="753">And so that's where this </span><span class="line" data-startTime="753">hash function comes in. </span> <span class="line" data-startTime="755">What the hash function does </span><span class="line" data-startTime="755">is assigns flows to </span><span class="line" data-startTime="758">next hops at random. </span> <span class="line" data-startTime="760">And so as the number of flows </span><span class="line" data-startTime="760">grows large, you are </span><span class="line" data-startTime="765">distributing your load more or </span><span class="line" data-startTime="765">less evenly across gateways. </span> <span class="line" data-startTime="768">Not perfectly evenly, because </span><span class="line" data-startTime="768">everyone is kind of </span><span class="line" data-startTime="770">a random coin flip. </span> <span class="line" data-startTime="771">But as the number of flows </span><span class="line" data-startTime="771">gets large, it's </span><span class="line" data-startTime="773">more or less even. </span> <span class="line" data-startTime="774">And so that's load balancing </span><span class="line" data-startTime="774">of flows leaving the VMs. </span> <span class="line" data-startTime="779">Now, note that we don't assign </span><span class="line" data-startTime="779">packets to gateways randomly. </span> <span class="line" data-startTime="783">We assign flows randomly. </span> <span class="line" data-startTime="785">And so that's important because </span><span class="line" data-startTime="785">for protocols like </span><span class="line" data-startTime="789">TCP, if you're processing </span><span class="line" data-startTime="789">packets in parallel, they can </span><span class="line" data-startTime="792">get out of order. </span></p>

<p><span class="line" data-startTime="792">And that slows you down. </span> <span class="line" data-startTime="796">All right, so we've done </span><span class="line" data-startTime="796">a lot of talking </span><span class="line" data-startTime="798">about advanced routing. </span> <span class="line" data-startTime="800">I'm really excited to be </span><span class="line" data-startTime="800">able to show it to you </span><span class="line" data-startTime="802">today in our demo. </span> <span class="line" data-startTime="805">What we're going to do is build </span><span class="line" data-startTime="805">a site to site VPN using </span><span class="line" data-startTime="808">Compute Engine, open source </span><span class="line" data-startTime="808">software, and </span><span class="line" data-startTime="811">the new routing feature. </span> <span class="line" data-startTime="813">But you know, we're engineers. </span> <span class="line" data-startTime="815">We're not cowboys or cowgirls. </span> <span class="line" data-startTime="817">We have to design our </span><span class="line" data-startTime="817">network first. </span> <span class="line" data-startTime="818">So first thing we're going to </span><span class="line" data-startTime="818">do is jump on the whiteboard </span><span class="line" data-startTime="821">and sketch out a </span><span class="line" data-startTime="821">network design. </span> <span class="line" data-startTime="823">And you know, it's going to take </span><span class="line" data-startTime="823">a few iterations to get </span><span class="line" data-startTime="825">something workable. </span> <span class="line" data-startTime="826">And I hope those iterations will </span><span class="line" data-startTime="826">motivate why routes are </span><span class="line" data-startTime="828">important and a good </span><span class="line" data-startTime="828">and useful thing. </span> <span class="line" data-startTime="831">OK, after we have the design, </span><span class="line" data-startTime="831">we're going to use the gcutil </span><span class="line" data-startTime="834">command line tool to show you </span><span class="line" data-startTime="834">the resources in GCE that </span><span class="line" data-startTime="839">we've already created to model </span><span class="line" data-startTime="839">this network design. </span></p>

<p><span class="line" data-startTime="843">Finally, we're going to SSH into </span><span class="line" data-startTime="843">VMs, send some packets, </span><span class="line" data-startTime="847">and see them moving through our </span><span class="line" data-startTime="847">network in the way we've </span><span class="line" data-startTime="849">configured using the trace </span><span class="line" data-startTime="849">route tool and </span><span class="line" data-startTime="851">the TCP dump tool. </span> <span class="line" data-startTime="857">OK, so first the design phase. </span> <span class="line" data-startTime="859">Here's an existing, </span><span class="line" data-startTime="859">hypothetical, on premises, </span><span class="line" data-startTime="862">back office application that we </span><span class="line" data-startTime="862">want to move to the cloud. </span> <span class="line" data-startTime="866">There's a couple parts. </span> <span class="line" data-startTime="867">There's the front end here, </span><span class="line" data-startTime="867">those office FE machines. </span> <span class="line" data-startTime="871">Those are the database </span><span class="line" data-startTime="871">clients. </span> <span class="line" data-startTime="872">And there's the back end, </span><span class="line" data-startTime="872">the database itself. </span></p>

<p><span class="line" data-startTime="875">All these parts live </span><span class="line" data-startTime="875">on a private </span><span class="line" data-startTime="877">RFC1918 real world network. </span> <span class="line" data-startTime="882">What I want you to notice </span><span class="line" data-startTime="882">about this very simple </span><span class="line" data-startTime="884">application is that there's </span><span class="line" data-startTime="884">actually two layers of </span><span class="line" data-startTime="887">security here. </span> <span class="line" data-startTime="888">The first layer is the </span><span class="line" data-startTime="888">application layer. </span> <span class="line" data-startTime="890">And what I mean by that is those </span><span class="line" data-startTime="890">database clients need to </span><span class="line" data-startTime="896">have a username and password </span><span class="line" data-startTime="896">to log into the database. </span> <span class="line" data-startTime="898">And that secret credential is </span><span class="line" data-startTime="898">embedded in them, say it's in </span><span class="line" data-startTime="900">a config file that's maybe </span><span class="line" data-startTime="900">only readable by some </span><span class="line" data-startTime="902">user on that box. </span> <span class="line" data-startTime="905">The second layer of </span><span class="line" data-startTime="905">security is the </span><span class="line" data-startTime="906">network layer of security. </span> <span class="line" data-startTime="908">None of these pieces </span><span class="line" data-startTime="908">are connected </span><span class="line" data-startTime="909">to the public internet. </span> <span class="line" data-startTime="910">And so if you want to access </span><span class="line" data-startTime="910">them, you have to be </span><span class="line" data-startTime="913">physically connected </span><span class="line" data-startTime="913">to that network. </span></p>

<p><span class="line" data-startTime="915">Now, notice these </span><span class="line" data-startTime="915">two layers are </span><span class="line" data-startTime="916">independent and kind of redundant. </span> <span class="line" data-startTime="919">They back each other up. </span> <span class="line" data-startTime="920">So if know the username and </span><span class="line" data-startTime="920">password to the database, but </span><span class="line" data-startTime="923">you aren't connected to the </span><span class="line" data-startTime="923">network, you're out of luck. </span> <span class="line" data-startTime="925">You can't access the data. </span> <span class="line" data-startTime="926">And conversely, if you somehow </span><span class="line" data-startTime="926">break into the office building </span><span class="line" data-startTime="930">and connect to the network, </span><span class="line" data-startTime="930">but you don't know the </span><span class="line" data-startTime="931">username and password, </span><span class="line" data-startTime="931">again you're stuck. </span> <span class="line" data-startTime="935">So these kind of overlapping </span><span class="line" data-startTime="935">or independent, redundant </span><span class="line" data-startTime="938">security layers, that's </span><span class="line" data-startTime="938">something we're going to try </span><span class="line" data-startTime="941">and preserve as we move </span><span class="line" data-startTime="941">to the cloud. </span> <span class="line" data-startTime="943">Now, one constraint. </span> <span class="line" data-startTime="944">We're not going to </span><span class="line" data-startTime="944">move the whole </span><span class="line" data-startTime="945">application to the cloud. </span> <span class="line" data-startTime="946">We're just going to move </span><span class="line" data-startTime="946">the front ends. </span> <span class="line" data-startTime="949">Say, for whatever reason, just </span><span class="line" data-startTime="949">to make it interesting, we'll </span><span class="line" data-startTime="950">keep OfficeDB &mdash; </span><span class="line" data-startTime="952">it has to stay in office-net. </span> <span class="line" data-startTime="958">All right, so here's our first </span><span class="line" data-startTime="958">shot at doing this. </span> <span class="line" data-startTime="961">Let's be totally naive, just </span><span class="line" data-startTime="961">do the simplest thing that </span><span class="line" data-startTime="963">could possibly work. </span></p>

<p><span class="line" data-startTime="965">We'll take those database </span><span class="line" data-startTime="965">clients, spin up VMs for them. </span> <span class="line" data-startTime="968">Well, first we have to </span><span class="line" data-startTime="968">create a network. </span> <span class="line" data-startTime="969">So we'll create a network, </span><span class="line" data-startTime="969">cloud-net, in Compute Engine. </span> <span class="line" data-startTime="972">We'll take our address space, </span><span class="line" data-startTime="972">our RFC1918, it's in the 10. </span> <span class="line" data-startTime="979">range. </span> <span class="line" data-startTime="979">And we'll split it. </span> <span class="line" data-startTime="980">We'll give half the address </span><span class="line" data-startTime="980">space to the cloud, and keep </span><span class="line" data-startTime="982">half in office-net. </span> <span class="line" data-startTime="985">We'll spin up some VMs to </span><span class="line" data-startTime="985">represent those database </span><span class="line" data-startTime="987">clients, give them public </span><span class="line" data-startTime="987">IP addresses. </span> <span class="line" data-startTime="989">And well, since they need to </span><span class="line" data-startTime="989">talk to OfficeDB, we better </span><span class="line" data-startTime="992">put that on the public </span><span class="line" data-startTime="992">internet, too. </span> <span class="line" data-startTime="994">And so now, great, everyone </span><span class="line" data-startTime="994">can talk to each other. </span> <span class="line" data-startTime="995">And we're done. </span> <span class="line" data-startTime="997">Well, no. </span> <span class="line" data-startTime="999">This is a nonstarter for me from </span><span class="line" data-startTime="999">a security perspective </span><span class="line" data-startTime="1001">because we've thrown away our </span><span class="line" data-startTime="1001">network layer of security. </span> <span class="line" data-startTime="1004">Now, anyone at any coffee shop </span><span class="line" data-startTime="1004">Wi-Fi connection can access </span><span class="line" data-startTime="1008">our resources over </span><span class="line" data-startTime="1008">the internet. </span></p>

<p><span class="line" data-startTime="1011">And so we've thrown away that </span><span class="line" data-startTime="1011">network layer of security. </span> <span class="line" data-startTime="1016">All right, so let's try again </span><span class="line" data-startTime="1016">and sprinkle some VPN magic on </span><span class="line" data-startTime="1020">this design and see </span><span class="line" data-startTime="1020">if that helps us. </span> <span class="line" data-startTime="1023">We'll take OfficeDB off the </span><span class="line" data-startTime="1023">public internet, put it back </span><span class="line" data-startTime="1025">in office-net. </span> <span class="line" data-startTime="1026">That was a bad idea. </span> <span class="line" data-startTime="1027">Let's not do that. </span> <span class="line" data-startTime="1028">Put it back in office-net </span><span class="line" data-startTime="1028">behind the firewall. </span> <span class="line" data-startTime="1033">And we'll keep those front end </span><span class="line" data-startTime="1033">VMs on the public network. </span> <span class="line" data-startTime="1036">And we'll spin up VPN tunnels </span><span class="line" data-startTime="1036">that connect them to the </span><span class="line" data-startTime="1041">router of office-net. </span> <span class="line" data-startTime="1043">Say IPsec is your </span><span class="line" data-startTime="1043">VPN connection. </span> <span class="line" data-startTime="1048">By the way, this is possible </span><span class="line" data-startTime="1048">without advanced routing. </span></p>

<p><span class="line" data-startTime="1050">You could have done </span><span class="line" data-startTime="1050">this a week ago </span><span class="line" data-startTime="1052">before we launched it. </span> <span class="line" data-startTime="1054">But I see three problems with </span><span class="line" data-startTime="1054">this design that I want to </span><span class="line" data-startTime="1057">share with you. </span> <span class="line" data-startTime="1059">First problem I see is that if </span><span class="line" data-startTime="1059">you have n of those front end </span><span class="line" data-startTime="1062">VMs, n of those database </span><span class="line" data-startTime="1062">clients, you need n tunnels. </span> <span class="line" data-startTime="1065">This is more of a remote </span><span class="line" data-startTime="1065">access than a </span><span class="line" data-startTime="1068">site to site VPN. </span> <span class="line" data-startTime="1069">And so for each of those </span><span class="line" data-startTime="1069">tunnels, that's an entry in </span><span class="line" data-startTime="1071">that router's config file. </span> <span class="line" data-startTime="1073">And as that config file grows </span><span class="line" data-startTime="1073">larger with all those tunnels, </span><span class="line" data-startTime="1075">your network administrator's </span><span class="line" data-startTime="1075">starting </span><span class="line" data-startTime="1077">to get sad and grumpy. </span> <span class="line" data-startTime="1078">So that's a problem. </span> <span class="line" data-startTime="1080">n tunnels is a lot to manage. </span> <span class="line" data-startTime="1082">Oh, and moreover, every time you </span><span class="line" data-startTime="1082">want to scale up or down </span><span class="line" data-startTime="1085">those VMs in the cloud, which </span><span class="line" data-startTime="1085">is touted as one of the </span><span class="line" data-startTime="1087">benefits, you have to change </span><span class="line" data-startTime="1087">that config file to add or </span><span class="line" data-startTime="1090">remove tunnels. </span> <span class="line" data-startTime="1091">That's kind of a management </span><span class="line" data-startTime="1091">pain. </span> <span class="line" data-startTime="1092">That's the first </span><span class="line" data-startTime="1092">problem I see. </span></p>

<p><span class="line" data-startTime="1094">The second problem I see </span><span class="line" data-startTime="1094">is that those VMs </span><span class="line" data-startTime="1097">have to have special &mdash; </span><span class="line" data-startTime="1098">their operating system, their </span><span class="line" data-startTime="1098">guest OS &mdash; needs to be </span><span class="line" data-startTime="1100">specially configured </span><span class="line" data-startTime="1100">to use the VPN. </span> <span class="line" data-startTime="1102">Their local routing table needs </span><span class="line" data-startTime="1102">to know which packets go </span><span class="line" data-startTime="1104">over the VPN and which </span><span class="line" data-startTime="1104">packets don't. </span> <span class="line" data-startTime="1108">And so that's a pain to manage </span><span class="line" data-startTime="1108">because you have a bunch of </span><span class="line" data-startTime="1111">configurations spread out </span><span class="line" data-startTime="1111">over all these VMs. </span> <span class="line" data-startTime="1115">Oh, and you need root access to </span><span class="line" data-startTime="1115">set up those routing tables </span><span class="line" data-startTime="1118">because it's a privilege </span><span class="line" data-startTime="1118">operation. </span> <span class="line" data-startTime="1120">So another management pain </span><span class="line" data-startTime="1120">multiplied by n. </span> <span class="line" data-startTime="1123">The final problem I see with </span><span class="line" data-startTime="1123">this design is that, well, how </span><span class="line" data-startTime="1128">do those cloud FEVMs, those </span><span class="line" data-startTime="1128">database clients, actually </span><span class="line" data-startTime="1131">authenticate when they connect </span><span class="line" data-startTime="1131">to the router? </span><span class="line" data-startTime="1134">How does the router know </span><span class="line" data-startTime="1134">that they're allowed to </span><span class="line" data-startTime="1135">connect to the VPN? </span><span class="line" data-startTime="1137">Look, there must be some secret </span><span class="line" data-startTime="1137">key, or credential, or </span><span class="line" data-startTime="1140">something also embedded on </span><span class="line" data-startTime="1140">those clouds FE VMs that </span><span class="line" data-startTime="1144">allows them access </span><span class="line" data-startTime="1144">to that network. </span></p>

<p><span class="line" data-startTime="1146">And wow, that credential is </span><span class="line" data-startTime="1146">stored in the exact same place </span><span class="line" data-startTime="1150">as the application </span><span class="line" data-startTime="1150">layer credential. </span> <span class="line" data-startTime="1151">And so even though it seems like </span><span class="line" data-startTime="1151">we have a network layer </span><span class="line" data-startTime="1154">of security and an application </span><span class="line" data-startTime="1154">layer of security, they're not </span><span class="line" data-startTime="1157">really that independent because </span><span class="line" data-startTime="1157">the secrets are stored </span><span class="line" data-startTime="1159">in the exact same place. </span> <span class="line" data-startTime="1165">So here's our final design that </span><span class="line" data-startTime="1165">I want to propose to you </span><span class="line" data-startTime="1170">guys today. </span> <span class="line" data-startTime="1173">What we're going to do is take </span><span class="line" data-startTime="1173">the VPN logic and move it out </span><span class="line" data-startTime="1177">of those client VMs and into </span><span class="line" data-startTime="1177">the network and into a new, </span><span class="line" data-startTime="1181">designated, router VM that </span><span class="line" data-startTime="1181">you can see there </span><span class="line" data-startTime="1183">cloud-vpn-gateway on the left. </span> <span class="line" data-startTime="1185">And so he's going to terminate </span><span class="line" data-startTime="1185">the tunnel that </span><span class="line" data-startTime="1187">goes to office router. </span> <span class="line" data-startTime="1189">And we're going to use GCE </span><span class="line" data-startTime="1189">routes to direct traffic </span><span class="line" data-startTime="1192">destined for the VPN to that </span><span class="line" data-startTime="1192">designated VPN gateway VM. </span></p>

<p><span class="line" data-startTime="1197">Now, this addresses those three </span><span class="line" data-startTime="1197">problems I claim from </span><span class="line" data-startTime="1200">the last slide. </span> <span class="line" data-startTime="1201">First of all, now a number of </span><span class="line" data-startTime="1201">VPN tunnels scales with the </span><span class="line" data-startTime="1205">number of packets per second </span><span class="line" data-startTime="1205">that you want to send over it, </span><span class="line" data-startTime="1208">not the number of users. </span> <span class="line" data-startTime="1209">So you can probably get away </span><span class="line" data-startTime="1209">with fewer tunnels. </span> <span class="line" data-startTime="1212">The second problem it addresses </span><span class="line" data-startTime="1212">is that now those </span><span class="line" data-startTime="1214">client VMs can be </span><span class="line" data-startTime="1214">totally stock. </span> <span class="line" data-startTime="1216">They don't know anything </span><span class="line" data-startTime="1216">about the VPN. </span> <span class="line" data-startTime="1218">They can just dump packets on </span><span class="line" data-startTime="1218">the network, and the network </span><span class="line" data-startTime="1220">will figure out where they're </span><span class="line" data-startTime="1220">going based on </span><span class="line" data-startTime="1221">the destination address. </span> <span class="line" data-startTime="1223">The third problem this addresses </span><span class="line" data-startTime="1223">is that now the </span><span class="line" data-startTime="1226">secrets that allow you to </span><span class="line" data-startTime="1226">authenticate and construct </span><span class="line" data-startTime="1229">that VPN tunnel live in a </span><span class="line" data-startTime="1229">different place than the </span><span class="line" data-startTime="1231">application layer secrets. </span></p>

<p><span class="line" data-startTime="1233">And so you can also have some </span><span class="line" data-startTime="1233">policy to back this up and </span><span class="line" data-startTime="1235">make it even more independent. </span> <span class="line" data-startTime="1237">So say at Office Co, maybe </span><span class="line" data-startTime="1237">there's one group of </span><span class="line" data-startTime="1240">developers that work </span><span class="line" data-startTime="1240">on the application. </span> <span class="line" data-startTime="1241">And they have access to the </span><span class="line" data-startTime="1241">username and password. </span> <span class="line" data-startTime="1243">And they can log into the cloud </span><span class="line" data-startTime="1243">FE VM and the database. </span> <span class="line" data-startTime="1246">And maybe there's a separate </span><span class="line" data-startTime="1246">group of people, the network </span><span class="line" data-startTime="1248">administrators, that can </span><span class="line" data-startTime="1248">log into routers. </span> <span class="line" data-startTime="1250">And now, cloud VPN gateway </span><span class="line" data-startTime="1250">is one of those routers. </span> <span class="line" data-startTime="1253">And so maybe no one individual </span><span class="line" data-startTime="1253">has access to both secrets. </span> <span class="line" data-startTime="1258">So this is what I'm going </span><span class="line" data-startTime="1258">to demo today. </span></p>

<p><span class="line" data-startTime="1259">And we'll come back to this </span><span class="line" data-startTime="1259">picture as we go. </span> <span class="line" data-startTime="1268">Great. </span> <span class="line" data-startTime="1269">So during rehearsal, one of our </span><span class="line" data-startTime="1269">reviewers suggested that, </span><span class="line" data-startTime="1273">hey, to really model office-net, </span><span class="line" data-startTime="1273">you should drag a </span><span class="line" data-startTime="1275">rack full of gear up on stage, </span><span class="line" data-startTime="1275">servers and routers and </span><span class="line" data-startTime="1278">everything, and that'll be the </span><span class="line" data-startTime="1278">physical network that you're </span><span class="line" data-startTime="1281">going to connect to the cloud. </span> <span class="line" data-startTime="1282">That's great showmanship, but </span><span class="line" data-startTime="1282">I took the easy way out. </span> <span class="line" data-startTime="1286">And instead of doing that, we're </span><span class="line" data-startTime="1286">going to create just </span><span class="line" data-startTime="1290">separate networks in GCE </span><span class="line" data-startTime="1290">that's going to model </span><span class="line" data-startTime="1292">office-net. </span> <span class="line" data-startTime="1293">So we have two networks in </span><span class="line" data-startTime="1293">GCE, cloud-net, which </span><span class="line" data-startTime="1296">represents the expansion of </span><span class="line" data-startTime="1296">office-net, which is our </span><span class="line" data-startTime="1298">second network. </span> <span class="line" data-startTime="1300">And this is actually realistic </span><span class="line" data-startTime="1300">because two networks in GCE </span><span class="line" data-startTime="1304">are totally &mdash; </span><span class="line" data-startTime="1305">if they're separate networks, </span><span class="line" data-startTime="1305">they have no connectivity by </span><span class="line" data-startTime="1307">default between them. </span></p>

<p><span class="line" data-startTime="1308">So it's kind of the </span><span class="line" data-startTime="1308">same thing. </span> <span class="line" data-startTime="1311">What I want you to note about </span><span class="line" data-startTime="1311">this slide or this output of </span><span class="line" data-startTime="1315">gcutil is that the two address </span><span class="line" data-startTime="1315">spaces of the two networks are </span><span class="line" data-startTime="1318">non-overlapping. </span> <span class="line" data-startTime="1319">And so you can tell the </span><span class="line" data-startTime="1319">destination network for a </span><span class="line" data-startTime="1321">packet just by looking </span><span class="line" data-startTime="1321">at those first two </span><span class="line" data-startTime="1324">bytes of the address. </span> <span class="line" data-startTime="1327">OK, I've also created some </span><span class="line" data-startTime="1327">VMs to model this design. </span> <span class="line" data-startTime="1332">And here they are. </span> <span class="line" data-startTime="1334">We have cloud FE VM, </span><span class="line" data-startTime="1334">which remember is </span><span class="line" data-startTime="1338">this guy in the picture. </span> <span class="line" data-startTime="1342">We have 2 VPN gateways, cloud </span><span class="line" data-startTime="1342">VPN gateway and office VPN </span><span class="line" data-startTime="1345">gateway, that model this </span><span class="line" data-startTime="1345">guy and this guy. </span> <span class="line" data-startTime="1350">And finally, we have OfficeDB, </span><span class="line" data-startTime="1350">which is another VM running </span><span class="line" data-startTime="1353">over here in office-net. </span> <span class="line" data-startTime="1357">Two things you can't see here &mdash; </span><span class="line" data-startTime="1357">unfortunately gcutil </span><span class="line" data-startTime="1359">doesn't print them &mdash; </span><span class="line" data-startTime="1359">are the tags. </span> <span class="line" data-startTime="1362">So I've tagged both of these. </span> <span class="line" data-startTime="1364">I've tagged cloud FE FM and </span><span class="line" data-startTime="1364">OfficeDB with the VPN tag. </span> <span class="line" data-startTime="1367">And that's what we're going to </span><span class="line" data-startTime="1367">use to join routes and allow </span><span class="line" data-startTime="1370">them to use the VPN. </span></p>

<p><span class="line" data-startTime="1372">And the second thing I've done </span><span class="line" data-startTime="1372">is I've given &mdash; remember the </span><span class="line" data-startTime="1374">can_ip_forward flag? </span><span class="line" data-startTime="1376">I've set that on cloud </span><span class="line" data-startTime="1376">VPN gateway </span><span class="line" data-startTime="1377">and office VPN gateway. </span> <span class="line" data-startTime="1378">And that allows them to do their </span><span class="line" data-startTime="1378">job and forward packets. </span> <span class="line" data-startTime="1382">OK, so here's what's </span><span class="line" data-startTime="1382">new, list routes. </span> <span class="line" data-startTime="1387">This is the routes collection </span><span class="line" data-startTime="1387">for the project. </span> <span class="line" data-startTime="1390">And the defaults aren't </span><span class="line" data-startTime="1390">that interesting. </span> <span class="line" data-startTime="1392">I haven't changed those. </span> <span class="line" data-startTime="1393">What I want you to notice is </span><span class="line" data-startTime="1393">these two routes here that </span><span class="line" data-startTime="1396">make the VPN go, gateway to </span><span class="line" data-startTime="1396">office, and gateway to cloud. </span> <span class="line" data-startTime="1400">Excuse me. </span> <span class="line" data-startTime="1402">So what this rule says is that </span><span class="line" data-startTime="1402">if you're a VM on cloud-net </span><span class="line" data-startTime="1406">and you have the VPN tag, shows </span><span class="line" data-startTime="1406">you permission to access </span><span class="line" data-startTime="1409">the VPN, and you send the packet </span><span class="line" data-startTime="1409">that falls in this </span><span class="line" data-startTime="1412">destination range, don't </span><span class="line" data-startTime="1412">handle it normally. </span></p>

<p><span class="line" data-startTime="1415">Instead, forward it to this </span><span class="line" data-startTime="1415">special, designated VM for </span><span class="line" data-startTime="1419">processing, OK? </span><span class="line" data-startTime="1420">And this address space is the </span><span class="line" data-startTime="1420">address space of the peer </span><span class="line" data-startTime="1426">network on the other </span><span class="line" data-startTime="1426">side of the tunnel. </span> <span class="line" data-startTime="1429">So note the symmetry here. </span> <span class="line" data-startTime="1430">This gateway to cloud is </span><span class="line" data-startTime="1430">exactly the same in the </span><span class="line" data-startTime="1432">opposite direction. </span> <span class="line" data-startTime="1433">If you're a VM on office-net and </span><span class="line" data-startTime="1433">you have the VPN tag and </span><span class="line" data-startTime="1436">you're sending a packet to </span><span class="line" data-startTime="1436">cloud-net, then send it to </span><span class="line" data-startTime="1440">this special VM for </span><span class="line" data-startTime="1440">processing. </span> <span class="line" data-startTime="1445">OK, so those are the resources </span><span class="line" data-startTime="1445">I've created to model this </span><span class="line" data-startTime="1448">network design. </span></p>

<p><span class="line" data-startTime="1449">Let's jump on to cloud FE VM. </span> <span class="line" data-startTime="1451">I'm sorry. </span> <span class="line" data-startTime="1452">Let's jump on to the </span><span class="line" data-startTime="1452">VPN gateway. </span> <span class="line" data-startTime="1454">Remember, that's this </span><span class="line" data-startTime="1454">guy right here. </span> <span class="line" data-startTime="1457">And what I want to show you is </span><span class="line" data-startTime="1457">that I've already installed </span><span class="line" data-startTime="1460">and configured the strongSwan </span><span class="line" data-startTime="1460">one, VPN software. </span> <span class="line" data-startTime="1465">It's just sudo apt-get </span><span class="line" data-startTime="1465">install strongSwan. </span> <span class="line" data-startTime="1468">And I've already set it up </span><span class="line" data-startTime="1468">so that it's running. </span> <span class="line" data-startTime="1473">And the tunnel's established. </span> <span class="line" data-startTime="1475">And you can see that we've </span><span class="line" data-startTime="1475">joined these two halves of the </span><span class="line" data-startTime="1478">address space. </span> <span class="line" data-startTime="1479">OK, so the VPN's </span><span class="line" data-startTime="1479">up and running. </span> <span class="line" data-startTime="1483">We're going to do a quick </span><span class="line" data-startTime="1483">connectivity check here. </span> <span class="line" data-startTime="1485">I've now logged into </span><span class="line" data-startTime="1485">cloud FE VM. </span></p>

<p><span class="line" data-startTime="1487">That's this guy. </span> <span class="line" data-startTime="1488">This is our database client. </span> <span class="line" data-startTime="1489">What we're going to do is send </span><span class="line" data-startTime="1489">a ping request to OfficeDB to </span><span class="line" data-startTime="1494">check connectivity. </span> <span class="line" data-startTime="1496">Now remember that normally, by </span><span class="line" data-startTime="1496">default, two GCE networks have </span><span class="line" data-startTime="1499">no connectivity at all. </span> <span class="line" data-startTime="1500">And so the fact that we get </span><span class="line" data-startTime="1500">a response shows you that </span><span class="line" data-startTime="1507">something interesting and new </span><span class="line" data-startTime="1507">and special is happening. </span> <span class="line" data-startTime="1509">The two networks have </span><span class="line" data-startTime="1509">connectivity to each other. </span> <span class="line" data-startTime="1512">But hey, how do we know that </span><span class="line" data-startTime="1512">it's really happening in the </span><span class="line" data-startTime="1514">way that I'm claiming? </span><span class="line" data-startTime="1516">Well, let's use the trace route </span><span class="line" data-startTime="1516">tool to find the path </span><span class="line" data-startTime="1521">that that packet's taking. </span> <span class="line" data-startTime="1522">And as you can see, it's exactly </span><span class="line" data-startTime="1522">what we expect from </span><span class="line" data-startTime="1525">the whiteboard diagram. </span></p>

<p><span class="line" data-startTime="1526">The first hop is cloud </span><span class="line" data-startTime="1526">VPN gateway. </span> <span class="line" data-startTime="1528">So remember, the ping is </span><span class="line" data-startTime="1528">going here, first top. </span> <span class="line" data-startTime="1530">Second hop is the office </span><span class="line" data-startTime="1530">VPN gateway. </span> <span class="line" data-startTime="1532">And third hop is OfficeDB. </span> <span class="line" data-startTime="1535">They're there. </span> <span class="line" data-startTime="1539">OK, that's pretty cool. </span> <span class="line" data-startTime="1541">Let's jump on to OfficeDB and </span><span class="line" data-startTime="1541">see what it looks like from </span><span class="line" data-startTime="1545">the server's perspective. </span> <span class="line" data-startTime="1547">OK, so I'm going to </span><span class="line" data-startTime="1547">start a TCP dump. </span> <span class="line" data-startTime="1548">TCP dump's a tool that captures </span><span class="line" data-startTime="1548">packets the match a </span><span class="line" data-startTime="1551">certain expression in </span><span class="line" data-startTime="1551">a Unix machine and </span><span class="line" data-startTime="1556">print it to the screen. </span> <span class="line" data-startTime="1557">So I'm going to start that up. </span> <span class="line" data-startTime="1558">And while that's running, I'm </span><span class="line" data-startTime="1558">going to send that same </span><span class="line" data-startTime="1561">packet, that same </span><span class="line" data-startTime="1561">ping request. </span> <span class="line" data-startTime="1563">And so here here's what that </span><span class="line" data-startTime="1563">network flow looks like from </span><span class="line" data-startTime="1566">the server's perspective. </span></p>

<p><span class="line" data-startTime="1569">What I think is cool about this </span><span class="line" data-startTime="1569">dump is that the source </span><span class="line" data-startTime="1571">address and the destination </span><span class="line" data-startTime="1571">address are </span><span class="line" data-startTime="1573">just 10 space, right? </span><span class="line" data-startTime="1575">You don't see the addresses </span><span class="line" data-startTime="1575">of the VPN endpoints. </span> <span class="line" data-startTime="1578">And this is why people </span><span class="line" data-startTime="1578">like VPN. </span> <span class="line" data-startTime="1581">This is why people want VPN, </span><span class="line" data-startTime="1581">because we took an existing </span><span class="line" data-startTime="1584">application on one network and </span><span class="line" data-startTime="1584">we put it on two networks. </span> <span class="line" data-startTime="1586">And the application didn't </span><span class="line" data-startTime="1586">have to be rewritten or </span><span class="line" data-startTime="1588">changed in any way because </span><span class="line" data-startTime="1588">the packets </span><span class="line" data-startTime="1591">looked exactly the same. </span> <span class="line" data-startTime="1593">And if you've designed your VPN </span><span class="line" data-startTime="1593">right, you get some of the </span><span class="line" data-startTime="1595">security benefits, too, of being </span><span class="line" data-startTime="1595">on a private network, </span><span class="line" data-startTime="1598">like confidentiality </span><span class="line" data-startTime="1598">and authenticity. </span></p>

<p><span class="line" data-startTime="1602">So that's from a server's </span><span class="line" data-startTime="1602">perspective. </span> <span class="line" data-startTime="1604">Now, the final thing that I want </span><span class="line" data-startTime="1604">to show you, I think is </span><span class="line" data-startTime="1607">the coolest, is a </span><span class="line" data-startTime="1607">TCP dump from &mdash; </span><span class="line" data-startTime="1610">let me just clear this &mdash; </span><span class="line" data-startTime="1612">from the VPN gateway. </span> <span class="line" data-startTime="1613">So now, we're going to capture </span><span class="line" data-startTime="1613">packets on this guy. </span> <span class="line" data-startTime="1616">I'm going to send </span><span class="line" data-startTime="1616">that same ping. </span> <span class="line" data-startTime="1617">And we're going to see how </span><span class="line" data-startTime="1617">this guy handles it. </span> <span class="line" data-startTime="1625">OK, so wow. </span> <span class="line" data-startTime="1626">There's a lot going on here. </span> <span class="line" data-startTime="1627">I'm going to quickly step </span><span class="line" data-startTime="1627">through it for you. </span> <span class="line" data-startTime="1631">Oops. </span></p>

<p><span class="line" data-startTime="1633">Very unlucky. </span> <span class="line" data-startTime="1634">I captured a packet </span><span class="line" data-startTime="1634">I didn't want to. </span> <span class="line" data-startTime="1637">Try again. </span> <span class="line" data-startTime="1640">All right, so this very </span><span class="line" data-startTime="1640">first packet is </span><span class="line" data-startTime="1643">what's coolest to me. </span> <span class="line" data-startTime="1644">What's cool is that the </span><span class="line" data-startTime="1644">destination address is on a </span><span class="line" data-startTime="1650">completely different network </span><span class="line" data-startTime="1650">than this VM. </span> <span class="line" data-startTime="1652">So if this is the first time </span><span class="line" data-startTime="1652">you've see something like </span><span class="line" data-startTime="1654">this, you might ask, what is </span><span class="line" data-startTime="1654">this packet doing on my </span><span class="line" data-startTime="1657">network interface? </span><span class="line" data-startTime="1657">It's destined for someone </span><span class="line" data-startTime="1657">else, right? </span><span class="line" data-startTime="1659">Well, that's the routes </span><span class="line" data-startTime="1659">collection working. </span> <span class="line" data-startTime="1661">We created a route that said, </span><span class="line" data-startTime="1661">this packet destined for this </span><span class="line" data-startTime="1663">other guy should go to this </span><span class="line" data-startTime="1663">cloud VPN gateway VM instead. </span></p>

<p><span class="line" data-startTime="1668">And it is kind of weird to </span><span class="line" data-startTime="1668">have packets destined for </span><span class="line" data-startTime="1670">someone else show up on your </span><span class="line" data-startTime="1670">network interface. </span> <span class="line" data-startTime="1672">But that's the definition of </span><span class="line" data-startTime="1672">being a router, right? </span><span class="line" data-startTime="1675">People dump things </span><span class="line" data-startTime="1675">on your doorstep. </span> <span class="line" data-startTime="1677">And it's your job to figure out </span><span class="line" data-startTime="1677">what to do with them next. </span> <span class="line" data-startTime="1679">OK, well, what does this </span><span class="line" data-startTime="1679">VM do with it next? </span><span class="line" data-startTime="1683">You can see the answer to that </span><span class="line" data-startTime="1683">in the very next packet. </span> <span class="line" data-startTime="1686">What it does is it encrypts </span><span class="line" data-startTime="1686">that packet. </span> <span class="line" data-startTime="1688">You can see that. </span> <span class="line" data-startTime="1689">Now it's using the </span><span class="line" data-startTime="1689">IPsec protocol. </span> <span class="line" data-startTime="1691">It encapsulates it. </span> <span class="line" data-startTime="1692">So the source address has </span><span class="line" data-startTime="1692">changed to be its own. </span> <span class="line" data-startTime="1695">And the destination address has </span><span class="line" data-startTime="1695">changed to be the public </span><span class="line" data-startTime="1698">IP of the other end </span><span class="line" data-startTime="1698">of the VPN tunnel. </span> <span class="line" data-startTime="1701">And so that's the encapsulation </span><span class="line" data-startTime="1701">part. </span> <span class="line" data-startTime="1703">It's like an envelope, taking </span><span class="line" data-startTime="1703">that original packet and </span><span class="line" data-startTime="1705">putting it in a new, </span><span class="line" data-startTime="1705">larger packet. </span></p>

<p><span class="line" data-startTime="1707">You can see it's 132 bytes </span><span class="line" data-startTime="1707">instead of 64. </span> <span class="line" data-startTime="1711">And sending it to a </span><span class="line" data-startTime="1711">new destination </span><span class="line" data-startTime="1713">OK, the next time we hear </span><span class="line" data-startTime="1713">from this flow is a few </span><span class="line" data-startTime="1716">milliseconds later. </span> <span class="line" data-startTime="1718">And it's actually the ICMP </span><span class="line" data-startTime="1718">reply coming back. </span> <span class="line" data-startTime="1720">It's coming back from the IP </span><span class="line" data-startTime="1720">address at the other end of </span><span class="line" data-startTime="1723">the tunnel. </span> <span class="line" data-startTime="1724">It's also encrypted. </span> <span class="line" data-startTime="1725">It's also encapsulated. </span> <span class="line" data-startTime="1726">So Linux has built </span><span class="line" data-startTime="1726">in IPsec support. </span> <span class="line" data-startTime="1729">I've configured it to decrypt, </span><span class="line" data-startTime="1729">decapsulate that packet, and </span><span class="line" data-startTime="1732">dump it back on its own local </span><span class="line" data-startTime="1732">networking stack. </span> <span class="line" data-startTime="1734">And so this next entry shows </span><span class="line" data-startTime="1734">you that ICMP replied, </span><span class="line" data-startTime="1740">emerging from the tunnel </span><span class="line" data-startTime="1740">on this Linux machine. </span> <span class="line" data-startTime="1744">Well, I've configured the guest </span><span class="line" data-startTime="1744">OS, this Linux operating </span><span class="line" data-startTime="1747">system, to be also &mdash; to </span><span class="line" data-startTime="1747">think it's a router. </span> <span class="line" data-startTime="1749">And so it has its own IP </span><span class="line" data-startTime="1749">forward flags set. </span> <span class="line" data-startTime="1752">And so Linux knows that </span><span class="line" data-startTime="1752">it has access to </span><span class="line" data-startTime="1755">this destination network. </span></p>

<p><span class="line" data-startTime="1758">And so it sends it out for GCE </span><span class="line" data-startTime="1758">to deliver to the destination, </span><span class="line" data-startTime="1764">which is actually the </span><span class="line" data-startTime="1764">original pinger. </span> <span class="line" data-startTime="1767">This last packet is super cool, </span><span class="line" data-startTime="1767">too, because look at </span><span class="line" data-startTime="1769">this source address. </span> <span class="line" data-startTime="1770">This source address is a VM on </span><span class="line" data-startTime="1770">a totally different network. </span> <span class="line" data-startTime="1774">It's on office-net. </span> <span class="line" data-startTime="1776">And so this is why the </span><span class="line" data-startTime="1776">can_ip_forward flag is </span><span class="line" data-startTime="1778">important because this gateway </span><span class="line" data-startTime="1778">is actually sending a packet </span><span class="line" data-startTime="1781">where the source address </span><span class="line" data-startTime="1781">is not its own. </span> <span class="line" data-startTime="1783">It's like it's spoofing, </span><span class="line" data-startTime="1783">right? </span><span class="line" data-startTime="1784">But it's not for evil. </span> <span class="line" data-startTime="1785">It's for good. </span> <span class="line" data-startTime="1786">It's to make this transparent </span><span class="line" data-startTime="1786">VPN work. </span> <span class="line" data-startTime="1791">All right, that's everything </span><span class="line" data-startTime="1791">I wanted to </span><span class="line" data-startTime="1793">show you in the demo. </span> <span class="line" data-startTime="1795">I hope you guys think this </span><span class="line" data-startTime="1795">is as cool as I do. </span> <span class="line" data-startTime="1797">I'm going to send it back </span><span class="line" data-startTime="1797">to Sunil to summarize </span><span class="line" data-startTime="1800">and wrap this up. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="1803"><span class="speakerName">Sunil James</span>: Great. </span> <span class="line" data-startTime="1804">Thank you, John. </span> <span class="line" data-startTime="1805">So as you just said, we just </span><span class="line" data-startTime="1805">demonstrated to you guys how </span><span class="line" data-startTime="1807">to move a back office </span><span class="line" data-startTime="1807">application to the cloud while </span><span class="line" data-startTime="1809">retaining some of the security </span><span class="line" data-startTime="1809">properties of it being a </span><span class="line" data-startTime="1811">private physical network. </span> <span class="line" data-startTime="1813">Just to recap, we took the Linux </span><span class="line" data-startTime="1813">built-in IPsec stack </span><span class="line" data-startTime="1818">plus some open source VPN </span><span class="line" data-startTime="1818">software and GCE's advanced </span><span class="line" data-startTime="1821">routing capability to connect </span><span class="line" data-startTime="1821">together these two networks </span><span class="line" data-startTime="1823">and layer three so that by </span><span class="line" data-startTime="1823">specifying GCE route, that </span><span class="line" data-startTime="1826">directed traffic to the </span><span class="line" data-startTime="1826">designated gateway VM. </span> <span class="line" data-startTime="1829">Then, we set the can_ip_forward </span><span class="line" data-startTime="1829">flag on that VM </span><span class="line" data-startTime="1832">acting as the VPN gateway to </span><span class="line" data-startTime="1832">send forward packets and </span><span class="line" data-startTime="1835">receive packets for </span><span class="line" data-startTime="1835">forwarding. </span> <span class="line" data-startTime="1837">And then finally, we used trace </span><span class="line" data-startTime="1837">route and TCP dump to </span><span class="line" data-startTime="1840">show you guys packets flowing </span><span class="line" data-startTime="1840">from the origin VM through the </span><span class="line" data-startTime="1843">VPN gateway. </span></p>

<p><span class="line" data-startTime="1845">That was using routes. </span> <span class="line" data-startTime="1846">And then, through the VPN </span><span class="line" data-startTime="1846">tunnel across the public </span><span class="line" data-startTime="1848">internet, all the while </span><span class="line" data-startTime="1848">preserving the packet source </span><span class="line" data-startTime="1850">and destination IP addresses. </span> <span class="line" data-startTime="1853">So now, as you saw, this </span><span class="line" data-startTime="1853">was just a demo. </span> <span class="line" data-startTime="1855">And it's not meant to be a </span><span class="line" data-startTime="1855">comprehensive how to guide to </span><span class="line" data-startTime="1859">roll your own VPN, </span><span class="line" data-startTime="1859">necessarily. </span> <span class="line" data-startTime="1860">So before you go off and take </span><span class="line" data-startTime="1860">this demonstration as gospel, </span><span class="line" data-startTime="1865">I ask you to go talk to security </span><span class="line" data-startTime="1865">experts at your </span><span class="line" data-startTime="1867">organization, figure out </span><span class="line" data-startTime="1867">what makes the most </span><span class="line" data-startTime="1869">sense for your business. </span></p>

<p><span class="line" data-startTime="1871">So with that, I'm going to </span><span class="line" data-startTime="1871">take some questions. </span> <span class="line" data-startTime="1875">If you're thinking about </span><span class="line" data-startTime="1875">leaving, I'd suggest sticking </span><span class="line" data-startTime="1877">around for after the questions </span><span class="line" data-startTime="1877">because there's one more thing </span><span class="line" data-startTime="1879">that I'm going to show you after </span><span class="line" data-startTime="1879">we're done with that. </span> <span class="line" data-startTime="1880">So let me open it up </span><span class="line" data-startTime="1880">for questions. </span> <span class="line" data-startTime="1887">Yes? </span></p>

<p class="speaker"><span class="line" data-starttime="1888"><span class="speakerName">Audience</span>: Hi, I was </span><span class="line" data-startTime="1888">just wondering </span><span class="line" data-startTime="1888">if it's easily possible. </span><span class="line" data-startTime="1890">You were showing an example </span><span class="line" data-startTime="1890">where you have two gateways </span><span class="line" data-startTime="1892">handling traffic between the </span><span class="line" data-startTime="1892">cloud environment and the </span><span class="line" data-startTime="1897">internet, for example. </span><span class="line" data-startTime="1898">Is it easily possible for one of </span><span class="line" data-startTime="1898">these gateways to, say, I'm </span><span class="line" data-startTime="1902">serving more traffic </span><span class="line" data-startTime="1902">than I can handle. </span><span class="line" data-startTime="1904">I'll spin up another instance </span><span class="line" data-startTime="1904">of myself somewhere else. </span><span class="line" data-startTime="1907">And then, I either need to </span><span class="line" data-startTime="1907">reconfigure the routing tables </span><span class="line" data-startTime="1911">on the router to make that </span><span class="line" data-startTime="1911">gateway available, or I need </span><span class="line" data-startTime="1915">to have them pre-configured to </span><span class="line" data-startTime="1915">just see that new upcoming </span><span class="line" data-startTime="1919">instance and use it? </span></p>

<p class="speaker"><span class="line" data-starttime="1920"><span class="speakerName">John Carmie</span>: So that's </span><span class="line" data-startTime="1920">definitely possible. </span><span class="line" data-startTime="1922">You would have to write the </span><span class="line" data-startTime="1922">code that does that. </span><span class="line" data-startTime="1924">So the API to spin up a new </span><span class="line" data-startTime="1924">instance, it's an API. </span><span class="line" data-startTime="1927">It can do that. </span><span class="line" data-startTime="1928">And the API to control the </span><span class="line" data-startTime="1928">routing table, it can also </span><span class="line" data-startTime="1931">automate that. </span><span class="line" data-startTime="1931">So yeah, that's a great idea. </span></p>

<p class="speaker"><span class="line" data-starttime="1933"><span class="speakerName">Audience</span>: So that could </span><span class="line" data-startTime="1933">be changed on the fly. </span></p>

<p class="speaker"><span class="line" data-starttime="1934"><span class="speakerName">John Carmie</span>: Say again? </span></p>

<p class="speaker"><span class="line" data-starttime="1934"><span class="speakerName">Audience</span>: So the routing table </span><span class="line" data-startTime="1934">can be updated on the fly </span><span class="line" data-startTime="1936">without much latency? </span></p>

<p class="speaker"><span class="line" data-starttime="1937"><span class="speakerName">John Carmie</span>: Yes, yes. </span> <span class="line" data-startTime="1937">And so when you create a new </span><span class="line" data-startTime="1937">route, what happens is it's </span><span class="line" data-startTime="1940">kind of an async operation. </span> <span class="line" data-startTime="1941">You get back an operation </span><span class="line" data-startTime="1941">object. </span> <span class="line" data-startTime="1943">And then, you can pull that and </span><span class="line" data-startTime="1943">see when it's complete. </span> <span class="line" data-startTime="1945">And so once it's complete, that </span><span class="line" data-startTime="1945">means that everyone in </span><span class="line" data-startTime="1948">the network has got </span><span class="line" data-startTime="1948">that new route. </span> <span class="line" data-startTime="1949">And it's kind of in service </span><span class="line" data-startTime="1949">and ready to go. </span></p>

<p class="speaker"><span class="line" data-starttime="1951"><span class="speakerName">Audience</span>: And that runs on the </span><span class="line" data-startTime="1951">order of milliseconds, or does </span><span class="line" data-startTime="1953">that take a while? </span></p>

<p class="speaker"><span class="line" data-starttime="1956"><span class="speakerName">John Carmie</span>: I think it takes </span><span class="line" data-startTime="1956">a few seconds right now. </span><span class="line" data-startTime="1959">That's anecdotally. </span></p>

<p class="speaker"><span class="line" data-starttime="1960"><span class="speakerName">Audience</span>: Thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="1963"><span class="speakerName">Audience</span>: In a similar interest, </span><span class="line" data-startTime="1963">so you had your </span><span class="line" data-startTime="1966">dummy load balancing </span><span class="line" data-startTime="1966">example, which was </span><span class="line" data-startTime="1970">this hash based, simple. </span><span class="line" data-startTime="1974">Is there a lot of ability in </span><span class="line" data-startTime="1974">there to actually have it </span><span class="line" data-startTime="1976">automated and intelligent enough </span><span class="line" data-startTime="1976">to actually keep track </span><span class="line" data-startTime="1979">of the amount of flows that are </span><span class="line" data-startTime="1979">remaining constant servers </span><span class="line" data-startTime="1982">and do on automatic load </span><span class="line" data-startTime="1982">balancing that is actually </span><span class="line" data-startTime="1984">intelligent as the amount of </span><span class="line" data-startTime="1984">traffic changes on the </span><span class="line" data-startTime="1987">different servers? </span></p>

<p class="speaker"><span class="line" data-starttime="1990"><span class="speakerName">John Carmie</span>: Yes, so </span><span class="line" data-startTime="1990">you could do that. </span><span class="line" data-startTime="1993">But again, you would </span><span class="line" data-startTime="1993">have to write </span><span class="line" data-startTime="1994">that automation yourself. </span><span class="line" data-startTime="1995">So you could have counters on </span><span class="line" data-startTime="1995">your gateway VMs, monitoring </span><span class="line" data-startTime="1998">CPU, monitoring how many packets </span><span class="line" data-startTime="1998">per second they're </span><span class="line" data-startTime="2000">doing, and react to it by </span><span class="line" data-startTime="2000">spinning up new instances, and </span><span class="line" data-startTime="2003">then adding routes to add them </span><span class="line" data-startTime="2003">to the pool of gateways. </span></p>

<p class="speaker"><span class="line" data-starttime="2007"><span class="speakerName">Audience</span>: OK, the servers will </span><span class="line" data-startTime="2007">actually have to end up giving </span><span class="line" data-startTime="2009">feedback to the gateway. </span><span class="line" data-startTime="2011">You can't actually have the </span><span class="line" data-startTime="2011">gateway solitarily trying to </span><span class="line" data-startTime="2014">figure things out? </span></p>

<p class="speaker"><span class="line" data-starttime="2017"><span class="speakerName">John Carmie</span>: You could. </span><span class="line" data-startTime="2019">From inside GCE, you can make </span><span class="line" data-startTime="2019">calls to the control API and </span><span class="line" data-startTime="2022">add new instances and </span><span class="line" data-startTime="2022">create new routes. </span><span class="line" data-startTime="2025">So yeah, that's one </span><span class="line" data-startTime="2025">possible design. </span><span class="line" data-startTime="2027">Another possible would be to </span><span class="line" data-startTime="2027">monitor it from the outside </span><span class="line" data-startTime="2029">and spin up new resources </span><span class="line" data-startTime="2029">as needed. </span></p>

<p class="speaker"><span class="line" data-starttime="2031"><span class="speakerName">Audience</span>: Awesome, thank you. </span></p>

<p class="speaker"><span class="line" data-starttime="2033"><span class="speakerName">John Carmie</span>: Thank you. </span></p>

<p class="speaker"><span class="line" data-starttime="2034"><span class="speakerName">Audience</span>: Hi. </span><span class="line" data-startTime="2035">I guess along the same lines, </span><span class="line" data-startTime="2035">so you said we can do this </span><span class="line" data-startTime="2039">flow-based load balancing for </span><span class="line" data-startTime="2039">VPN gateways where my gateways </span><span class="line" data-startTime="2045">are on a VM. </span><span class="line" data-startTime="2046">What happens on the north-south </span><span class="line" data-startTime="2046">traffic where I'm </span><span class="line" data-startTime="2048">using the public IPs and </span><span class="line" data-startTime="2048">going out to the world? </span><span class="line" data-startTime="2051">Do I have that &mdash; </span><span class="line" data-startTime="2053">will the Google infrastructure </span><span class="line" data-startTime="2053">essentially take care of </span><span class="line" data-startTime="2055">spreading my flows or my load </span><span class="line" data-startTime="2055">across multiple gateways going </span><span class="line" data-startTime="2058">out to the internet? </span><span class="line" data-startTime="2060">And I don't have to worry about </span><span class="line" data-startTime="2060">it, or do I have to do </span><span class="line" data-startTime="2061">something special myself? </span></p>

<p class="speaker"><span class="line" data-starttime="2064"><span class="speakerName">John Carmie</span>: So the answer is </span><span class="line" data-startTime="2064">that the routing table doesn't </span><span class="line" data-startTime="2068">know whether it's </span><span class="line" data-startTime="2068">a VPN connection </span><span class="line" data-startTime="2069">or an internet gateway. </span><span class="line" data-startTime="2071">It's just thinking </span><span class="line" data-startTime="2071">about packets. </span><span class="line" data-startTime="2072">And so the same trick </span><span class="line" data-startTime="2072">works in both cases. </span><span class="line" data-startTime="2076">Does that answer </span><span class="line" data-startTime="2076">your question? </span><span class="line" data-startTime="2077">Or maybe I didn't understand. </span></p>

<p class="speaker"><span class="line" data-starttime="2078"><span class="speakerName">Audience</span>: No, I was wondering </span><span class="line" data-startTime="2078">that to go out to the </span><span class="line" data-startTime="2082">internet, do I need a separate </span><span class="line" data-startTime="2082">VM which is my gateway, and &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="2084"><span class="speakerName">John Carmie</span>: No. </span><span class="line" data-startTime="2085">Yeah, so this is </span><span class="line" data-startTime="2085">just an option. </span><span class="line" data-startTime="2086">You don't need to use </span><span class="line" data-startTime="2086">a separate VM </span><span class="line" data-startTime="2088">to get to the internet. </span><span class="line" data-startTime="2089">By default, you get </span><span class="line" data-startTime="2089">a route which is &mdash; </span><span class="line" data-startTime="2092">let me actually go back </span><span class="line" data-startTime="2092">and show you. </span></p>

<p class="speaker"><span class="line" data-starttime="2094"><span class="speakerName">Sunil James</span>: So it's </span><span class="line" data-startTime="2094">implicit, right? </span><span class="line" data-startTime="2095">It's one of the implicit </span><span class="line" data-startTime="2095">routes that </span><span class="line" data-startTime="2096">exists within our utility. </span></p>

<p class="speaker"><span class="line" data-starttime="2097"><span class="speakerName">John Carmie</span>: Yeah. </span></p>

<p class="speaker"><span class="line" data-starttime="2097"><span class="speakerName">Audience</span>: Yeah, it's </span><span class="line" data-startTime="2097">an implicit route. </span><span class="line" data-startTime="2098">But will the implicit route, </span><span class="line" data-startTime="2098">will whatever that gateway is </span><span class="line" data-startTime="2101">going to the internet, does </span><span class="line" data-startTime="2101">that actually load balance </span><span class="line" data-startTime="2103">across multiple devices if I'm </span><span class="line" data-startTime="2103">saturating the physical </span><span class="line" data-startTime="2107">whatever device it is? </span></p>

<p class="speaker"><span class="line" data-starttime="2110"><span class="speakerName">John Carmie</span>: Well, OK. </span><span class="line" data-startTime="2111">Let me first address </span><span class="line" data-startTime="2111">the route point. </span><span class="line" data-startTime="2114">So this default route is what </span><span class="line" data-startTime="2114">takes you &mdash; you can't see it </span><span class="line" data-startTime="2117">because I had to truncate to </span><span class="line" data-startTime="2117">make this fit on the screen. </span><span class="line" data-startTime="2120">But the next hop is actually an </span><span class="line" data-startTime="2120">object which is called the </span><span class="line" data-startTime="2123">default internet gateway. </span><span class="line" data-startTime="2125">And it's not a real </span><span class="line" data-startTime="2125">physical thing. </span><span class="line" data-startTime="2127">It's just something </span><span class="line" data-startTime="2127">that should be </span><span class="line" data-startTime="2128">in your mental model. </span><span class="line" data-startTime="2129">It's the thing that gets </span><span class="line" data-startTime="2129">you to the internet. </span><span class="line" data-startTime="2131">And you don't need to worry </span><span class="line" data-startTime="2131">about scaling it. </span><span class="line" data-startTime="2133">We worry about that </span><span class="line" data-startTime="2133">behind the scenes. </span><span class="line" data-startTime="2136">And so it's not one </span><span class="line" data-startTime="2136">physical device. </span><span class="line" data-startTime="2139">It scales up as needed. </span></p>

<p class="speaker"><span class="line" data-starttime="2141"><span class="speakerName">Audience</span>: As needed, OK. </span></p>

<p class="speaker"><span class="line" data-starttime="2142"><span class="speakerName">John Carmie</span>: And that's </span><span class="line" data-startTime="2142">part of the magic. </span><span class="line" data-startTime="2144">So you don't need to </span><span class="line" data-startTime="2144">worry about that. </span><span class="line" data-startTime="2145">If you're running your own </span><span class="line" data-startTime="2145">gateways, though, then as a </span><span class="line" data-startTime="2148">question over there pointed out, </span><span class="line" data-startTime="2148">yes, you do need to worry </span><span class="line" data-startTime="2150">about that. </span></p>

<p class="speaker"><span class="line" data-starttime="2154"><span class="speakerName">Audience</span>: So I realize </span><span class="line" data-startTime="2154">this demo falls </span><span class="line" data-startTime="2156">under just one project. </span><span class="line" data-startTime="2159">But given the example you could </span><span class="line" data-startTime="2159">run, could I use that to </span><span class="line" data-startTime="2162">establish connectivity between </span><span class="line" data-startTime="2162">two different projects? </span></p>

<p class="speaker"><span class="line" data-starttime="2164"><span class="speakerName">John Carmie</span>: Yes, yes. </span><span class="line" data-startTime="2165">Because from the VPN gateway's </span><span class="line" data-startTime="2165">perspective, it's just sending </span><span class="line" data-startTime="2169">packets to an IP address </span><span class="line" data-startTime="2169">out anywhere </span><span class="line" data-startTime="2172">on the public internet. </span><span class="line" data-startTime="2173">So it could be an instance </span><span class="line" data-startTime="2173">in a different project. </span><span class="line" data-startTime="2177">It could be an instance </span><span class="line" data-startTime="2177">running in a different </span><span class="line" data-startTime="2178">provider's cloud. </span><span class="line" data-startTime="2179">It could be an instance </span><span class="line" data-startTime="2179">running in </span><span class="line" data-startTime="2181">your home data center. </span><span class="line" data-startTime="2182">And it doesn't matter. </span></p>

<p class="speaker"><span class="line" data-starttime="2183"><span class="speakerName">Audience</span>: OK. </span><span class="line" data-startTime="2183">But in that case, it would </span><span class="line" data-startTime="2183">still have to transit </span><span class="line" data-startTime="2186">to some public IP. </span><span class="line" data-startTime="2188">I couldn't do say two different </span><span class="line" data-startTime="2188">projects, they're </span><span class="line" data-startTime="2191">all Google Compute projects. </span><span class="line" data-startTime="2193">But I want to establish </span><span class="line" data-startTime="2193">connectivity without </span><span class="line" data-startTime="2196">necessarily hitting outside to </span><span class="line" data-startTime="2196">make it faster or better. </span></p>

<p class="speaker"><span class="line" data-starttime="2198"><span class="speakerName">John Carmie</span>: OK, you're asking </span><span class="line" data-startTime="2198">whether it physically leaves </span><span class="line" data-startTime="2201">the Google infrastructure? </span></p>

<p class="speaker"><span class="line" data-starttime="2202"><span class="speakerName">Audience</span>: Maybe it </span><span class="line" data-startTime="2202">doesn't leave. </span><span class="line" data-startTime="2203">Maybe you've handled it. </span><span class="line" data-startTime="2204">I'm just curious. </span></p>

<p class="speaker"><span class="line" data-starttime="2205"><span class="speakerName">Sunil James</span>: Or another way to </span><span class="line" data-startTime="2205">position it is, is there a </span><span class="line" data-startTime="2207">short circuit path from </span><span class="line" data-startTime="2207">one project to </span><span class="line" data-startTime="2209">another to get to networks? </span><span class="line" data-startTime="2211">So I think the answer &mdash; </span><span class="line" data-startTime="2212">I'll take a stab at answering </span><span class="line" data-startTime="2212">this question. </span> <span class="line" data-startTime="2214">There's no short circuit path. </span> <span class="line" data-startTime="2215">It's still going to egress to </span><span class="line" data-startTime="2215">whatever egress point that </span><span class="line" data-startTime="2219">exists at the top of the tree </span><span class="line" data-startTime="2219">for the traffic that's being </span><span class="line" data-startTime="2223">sent out to the internet. </span> <span class="line" data-startTime="2224">So you do have to have it </span><span class="line" data-startTime="2224">communicating on a public IP. </span> <span class="line" data-startTime="2226">But that doesn't mean that it's </span><span class="line" data-startTime="2226">egressing the network. </span> <span class="line" data-startTime="2228">It's just going up to the </span><span class="line" data-startTime="2228">edge of our network, and </span><span class="line" data-startTime="2229">then right back down. </span></p>

<p class="speaker"><span class="line" data-starttime="2230"><span class="speakerName">Audience</span>: Oh, OK. </span><span class="line" data-startTime="2231">Thank you. </span></p>

<p class="speaker"><span class="line" data-starttime="2231"><span class="speakerName">Sunil James</span>: OK. </span> <span class="line" data-startTime="2234">So we'll be around to answer a </span><span class="line" data-startTime="2234">few more questions afterwards. </span> <span class="line" data-startTime="2237">But I wanted to just take, with </span><span class="line" data-startTime="2237">the two minutes left, </span><span class="line" data-startTime="2239">walk you through one more </span><span class="line" data-startTime="2239">thing that we're doing. </span> <span class="line" data-startTime="2242">So as I said before, we are part </span><span class="line" data-startTime="2242">of the Cloud Networking </span><span class="line" data-startTime="2246">team at Google Cloud Platform. </span> <span class="line" data-startTime="2248">And so we talked a little bit </span><span class="line" data-startTime="2248">earlier about all the things </span><span class="line" data-startTime="2251">that we've heard developers </span><span class="line" data-startTime="2251">asking for. </span> <span class="line" data-startTime="2254">This is a great starting </span><span class="line" data-startTime="2254">point. </span> <span class="line" data-startTime="2255">And it's only going to get </span><span class="line" data-startTime="2255">richer and better in terms of </span><span class="line" data-startTime="2257">the functionality of just </span><span class="line" data-startTime="2257">advanced routing. </span></p>

<p><span class="line" data-startTime="2258">But there are other things </span><span class="line" data-startTime="2258">that customers ask for. </span> <span class="line" data-startTime="2261">And so I'm really, really, </span><span class="line" data-startTime="2261">really excited to talk about </span><span class="line" data-startTime="2265">load balancing. </span> <span class="line" data-startTime="2266">So we're going to be bringing </span><span class="line" data-startTime="2266">you load balancing as part of </span><span class="line" data-startTime="2268">the native fabric for Google </span><span class="line" data-startTime="2268">Compute Engine. </span> <span class="line" data-startTime="2271">We're not releasing details </span><span class="line" data-startTime="2271">about the service yet. </span> <span class="line" data-startTime="2273">We're building it right now. </span> <span class="line" data-startTime="2275">If you're interested in learning </span><span class="line" data-startTime="2275">more about load </span><span class="line" data-startTime="2277">balancing, come up </span><span class="line" data-startTime="2277">and find me. </span> <span class="line" data-startTime="2278">Or go ahead and click </span><span class="line" data-startTime="2278">on that goo.gl link. </span> <span class="line" data-startTime="2281">I'll leave it up for you </span><span class="line" data-startTime="2281">guys to write down. </span></p>

<p><span class="line" data-startTime="2283">It'll take you to a forum where </span><span class="line" data-startTime="2283">you can answer some </span><span class="line" data-startTime="2285">questions about what you need </span><span class="line" data-startTime="2285">out of the service. </span> <span class="line" data-startTime="2287">And I'll follow up with </span><span class="line" data-startTime="2287">you personally. </span> <span class="line" data-startTime="2289">We can sit down and talk more </span><span class="line" data-startTime="2289">about what you need. </span> <span class="line" data-startTime="2291">Additionally, GCE has an early </span><span class="line" data-startTime="2291">access program whereby you can </span><span class="line" data-startTime="2295">get access to all the great, new </span><span class="line" data-startTime="2295">upcoming features within </span><span class="line" data-startTime="2298">Compute Engine, including load </span><span class="line" data-startTime="2298">balancing when it's available. </span> <span class="line" data-startTime="2302">So that's what we </span><span class="line" data-startTime="2302">wanted to say. </span></p>

<p><span class="line" data-startTime="2304">So thank you very much. </span></p>

<p class="speaker"><span class="line" data-starttime="2305"><span class="speakerName">John Carmie</span>: Thank you </span><span class="line" data-startTime="2305">so much, guys. </span><span class="line" data-startTime="2306">[APPLAUSE] </span></p></div>