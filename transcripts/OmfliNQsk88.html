<style>* {font-family: "Open Sans", sans-serif}
a {color: #77aaff}
a.video {border-bottom: 1px solid #ddd; display: block; margin: 0 0 2em 0; padding: 0 0 2em 0}
h2 {color: #444; font-size: 18px;}
span.speakerName {color: black; font-weight: 900;}
body {padding: 2em}
p {color: #444; margin: 0; text-indent: 1.5em;}
p.speaker {margin: 1em 0 0 0; text-indent: 0;}
div#transcript > p:first-child {text-indent: 0;}
</style>

<h1>Skia Path Ops : High Performance Set Operations for Geometry</h1>

<h2>Cary Clark</h2>

<a class="video" href="http://youtu.be/OmfliNQsk88">youtu.be/OmfliNQsk88</a><div id="transcript"><p><span class="line" data-startTime="0">[SIDE CONVERSATION] </span><span class="line" data-startTime="24">[MUSIC PLAYING] </span></p>

<p class="speaker"><span class="line" data-starttime="186"><span class="speakerName">Cary Clark</span>: Hi. </span> <span class="line" data-startTime="187">My name is Cary Clark, and I'm </span><span class="line" data-startTime="187">a member of the Skia team. </span> <span class="line" data-startTime="191">Skia provides the graphics </span><span class="line" data-startTime="191">for Android, the Android </span><span class="line" data-startTime="194">framework, and for Chrome. </span> <span class="line" data-startTime="197">Skia draws the rectangles, the </span><span class="line" data-startTime="197">bitmaps, the text, and paths. </span> <span class="line" data-startTime="201">That's what I'm going </span><span class="line" data-startTime="201">to talk about today, </span><span class="line" data-startTime="204">paths and path ops. </span> <span class="line" data-startTime="208">I started working at Apple a </span><span class="line" data-startTime="208">long time ago, and at that </span><span class="line" data-startTime="214">time, the Apple II really </span><span class="line" data-startTime="214">started my love of graphics. </span> <span class="line" data-startTime="219">The Apple II had a high </span><span class="line" data-startTime="219">resolution bitmap with a 280 </span><span class="line" data-startTime="223">by 192 screen &mdash; </span><span class="line" data-startTime="225">it had a pair of </span><span class="line" data-startTime="225">them, actually. </span> <span class="line" data-startTime="227">And with that, the world </span><span class="line" data-startTime="227">was my oyster. </span></p>

<p><span class="line" data-startTime="230">I could draw anything I wanted, </span><span class="line" data-startTime="231">and it was just amazing. </span> <span class="line" data-startTime="234">Unfortunately, the Apple II </span><span class="line" data-startTime="234">didn't really have any </span><span class="line" data-startTime="236">built-in graphics routines </span><span class="line" data-startTime="236">at that time. </span> <span class="line" data-startTime="240">Sometime later, when I was </span><span class="line" data-startTime="240">introduced to the Lisa and the </span><span class="line" data-startTime="244">Macintosh computers, I learned </span><span class="line" data-startTime="244">about QuickDraw, and QuickDraw </span><span class="line" data-startTime="248">is the software on a Macintosh, </span><span class="line" data-startTime="248">on the original </span><span class="line" data-startTime="252">Macintosh, that drew </span><span class="line" data-startTime="252">to the screen. </span> <span class="line" data-startTime="255">QuickDraw had arcs, and that was </span><span class="line" data-startTime="255">my first introduction into </span><span class="line" data-startTime="259">a computer that had a curved </span><span class="line" data-startTime="259">primitive, a circular arc. </span> <span class="line" data-startTime="266">A little while later, the </span><span class="line" data-startTime="266">Macintosh had the LaserWriter, </span><span class="line" data-startTime="269">which was a PostScript </span><span class="line" data-startTime="269">printer. </span> <span class="line" data-startTime="272">PostScript had a whole new class </span><span class="line" data-startTime="272">of curves called cubic </span><span class="line" data-startTime="275">beziers, which were pretty </span><span class="line" data-startTime="275">exotic, but they looked great, </span><span class="line" data-startTime="279">especially when they </span><span class="line" data-startTime="279">were scaled up. </span></p>

<p><span class="line" data-startTime="281">And it was pretty mind-blowing </span><span class="line" data-startTime="281">how well PostScript could take </span><span class="line" data-startTime="286">a document and rotate it </span><span class="line" data-startTime="286">or skew it or scale it. </span> <span class="line" data-startTime="293">In 1988, TrueType, and a little </span><span class="line" data-startTime="293">before that, QuickDraw </span><span class="line" data-startTime="297">GX came out. </span> <span class="line" data-startTime="298">I was fortunate enough to </span><span class="line" data-startTime="298">work on QuickDraw GX. </span> <span class="line" data-startTime="301">And at that time, I decided to </span><span class="line" data-startTime="301">add quadratics to QuickDraw </span><span class="line" data-startTime="306">instead of cubics or arcs. </span> <span class="line" data-startTime="310">The quadratic is a little bit </span><span class="line" data-startTime="310">simpler than a cube &mdash; it has </span><span class="line" data-startTime="313">one less control point, but </span><span class="line" data-startTime="313">it has a lot of the same </span><span class="line" data-startTime="316">properties, and I was happy </span><span class="line" data-startTime="316">that TrueType also chose </span><span class="line" data-startTime="321">quadratics and allowed me to </span><span class="line" data-startTime="321">have some validation that my </span><span class="line" data-startTime="324">choice was a good one. </span> <span class="line" data-startTime="328">Skia has all of these types. </span></p>

<p><span class="line" data-startTime="330">It has arcs, it has cubics, </span><span class="line" data-startTime="330">quadratics, and now it has </span><span class="line" data-startTime="333">conics, which are sections </span><span class="line" data-startTime="333">of a cone, which include </span><span class="line" data-startTime="337">quadratics. </span> <span class="line" data-startTime="339">And a path op is a way to take </span><span class="line" data-startTime="339">all of these curves and </span><span class="line" data-startTime="342">operate on them with </span><span class="line" data-startTime="342">set operations. </span> <span class="line" data-startTime="348">When QuickDraw was introduced </span><span class="line" data-startTime="348">back in the '80s, it had a way </span><span class="line" data-startTime="351">of describing an area of the </span><span class="line" data-startTime="351">screen that was called a </span><span class="line" data-startTime="353">region, and it was just a </span><span class="line" data-startTime="353">collection of rectangles, but </span><span class="line" data-startTime="357">it was the basis for the </span><span class="line" data-startTime="357">Macintosh windows and the </span><span class="line" data-startTime="360">windowing system. </span> <span class="line" data-startTime="362">A little while later with </span><span class="line" data-startTime="362">PostScript and QuickDraw GX </span><span class="line" data-startTime="366">and so forth, paths were </span><span class="line" data-startTime="366">introduced, and paths, like </span><span class="line" data-startTime="371">regions, describe an </span><span class="line" data-startTime="371">area of the screen. </span> <span class="line" data-startTime="373">But that area can include </span><span class="line" data-startTime="373">circles and triangles, and </span><span class="line" data-startTime="378">it's a control point </span><span class="line" data-startTime="378">based area. </span></p>

<p><span class="line" data-startTime="381">So instead of a set of </span><span class="line" data-startTime="381">rectangles, it's something </span><span class="line" data-startTime="383">that can have arbitrary curves </span><span class="line" data-startTime="383">and arbitrary lines. </span> <span class="line" data-startTime="389">QuickDraw used its </span><span class="line" data-startTime="389">rectangle-based path, its </span><span class="line" data-startTime="394">region, to build a </span><span class="line" data-startTime="394">windowing system. </span> <span class="line" data-startTime="397">And the windowing system allowed </span><span class="line" data-startTime="397">QuickDraw to draw to </span><span class="line" data-startTime="401">just the part of the window </span><span class="line" data-startTime="401">that was visible. </span> <span class="line" data-startTime="403">The way it did this is it had </span><span class="line" data-startTime="403">operations called region ops </span><span class="line" data-startTime="408">that could do things like </span><span class="line" data-startTime="408">intersect a pair of regions or </span><span class="line" data-startTime="411">take the difference of </span><span class="line" data-startTime="411">one from the other. </span> <span class="line" data-startTime="414">This was a very powerful concept </span><span class="line" data-startTime="414">that Bill Atkinson, </span><span class="line" data-startTime="417">the author of QuickDraw, </span><span class="line" data-startTime="417">invented. </span></p>

<p><span class="line" data-startTime="421">I liked it so much that I wanted </span><span class="line" data-startTime="421">to do the same thing </span><span class="line" data-startTime="424">for QuickDraw GX. </span> <span class="line" data-startTime="426">But instead of just making it </span><span class="line" data-startTime="426">work for rectangles, I wanted </span><span class="line" data-startTime="429">it to work for any arbitrary </span><span class="line" data-startTime="429">geometry and be able to rotate </span><span class="line" data-startTime="432">or skew a path and </span><span class="line" data-startTime="432">operate on it. </span> <span class="line" data-startTime="440">With ordinary paths &mdash; say, </span><span class="line" data-startTime="440">a pair of ovals &mdash; </span><span class="line" data-startTime="443">it's very difficult to translate </span><span class="line" data-startTime="443">those ovals from one </span><span class="line" data-startTime="446">graphic system to another. </span> <span class="line" data-startTime="448">For instance, Skia can describe </span><span class="line" data-startTime="448">a path with a pair of </span><span class="line" data-startTime="450">ovals, but to do a hardware </span><span class="line" data-startTime="450">acceleration and translate </span><span class="line" data-startTime="454">those ovals to something like </span><span class="line" data-startTime="454">OpenGL, it's difficult, </span><span class="line" data-startTime="459">because OpenGL doesn't have a </span><span class="line" data-startTime="459">primitive that will describe </span><span class="line" data-startTime="462">those curves. </span> <span class="line" data-startTime="464">Worse, if each oval individually </span><span class="line" data-startTime="464">is sent to </span><span class="line" data-startTime="469">OpenGL, the pair of curves may </span><span class="line" data-startTime="469">not blend together well. </span> <span class="line" data-startTime="474">If either one has transparency, </span><span class="line" data-startTime="474">then you'll see </span><span class="line" data-startTime="477">the transparent addition of the </span><span class="line" data-startTime="477">two rather than just the </span><span class="line" data-startTime="480">area that the two describe. </span> <span class="line" data-startTime="482">That's why OpenGL systems often </span><span class="line" data-startTime="482">create stencil buffers </span><span class="line" data-startTime="488">that have the bitmap that </span><span class="line" data-startTime="488">describes, in this case, a </span><span class="line" data-startTime="491">pair of ovals and uploads that </span><span class="line" data-startTime="491">rather than uploading the </span><span class="line" data-startTime="495">geometry of those </span><span class="line" data-startTime="495">pair of ovals. </span></p>

<p><span class="line" data-startTime="500">The Blink portion of Chrome that </span><span class="line" data-startTime="500">reads into the HTML web </span><span class="line" data-startTime="505">page can create some very </span><span class="line" data-startTime="505">complicated geometries. </span> <span class="line" data-startTime="509">CSS allows defining different </span><span class="line" data-startTime="509">gradients for different parts </span><span class="line" data-startTime="515">of a rounded rectangle, </span><span class="line" data-startTime="515">for instance. </span> <span class="line" data-startTime="517">So the clip might look </span><span class="line" data-startTime="517">something like this </span><span class="line" data-startTime="519">illustration. </span> <span class="line" data-startTime="520">That clip is only the portion </span><span class="line" data-startTime="520">of the gray &mdash; </span><span class="line" data-startTime="524">is the only portion that's </span><span class="line" data-startTime="524">actually drawn. </span> <span class="line" data-startTime="527">But the clip contains all the </span><span class="line" data-startTime="527">other shapes as well. </span> <span class="line" data-startTime="531">It's difficult to do an </span><span class="line" data-startTime="531">acceleration of just the </span><span class="line" data-startTime="535">portion that's being drawn when </span><span class="line" data-startTime="535">all the other geometries </span><span class="line" data-startTime="538">are present in the clip stack. </span> <span class="line" data-startTime="543">Blink also allows drawing the </span><span class="line" data-startTime="543">difference of a shape. </span> <span class="line" data-startTime="549">So when going from Skia to PDF, </span><span class="line" data-startTime="549">for instance, we have to </span><span class="line" data-startTime="556">draw the PDF data into an </span><span class="line" data-startTime="556">off-screen bitmap and render </span><span class="line" data-startTime="561">that instead of being able to </span><span class="line" data-startTime="561">calculate the geometry that </span><span class="line" data-startTime="564">would result from subtracting </span><span class="line" data-startTime="564">a rectangle </span><span class="line" data-startTime="567">from another rectangle. </span></p>

<p><span class="line" data-startTime="571">Shape ops tries to address </span><span class="line" data-startTime="571">this need. </span> <span class="line" data-startTime="574">Here, this simplify operation </span><span class="line" data-startTime="574">takes a pair of blue </span><span class="line" data-startTime="578">rectangles and will compute </span><span class="line" data-startTime="578">the area that would result </span><span class="line" data-startTime="583">from drawing both of them. </span> <span class="line" data-startTime="586">This is the simplest path op. </span> <span class="line" data-startTime="591">Path ops also have binary </span><span class="line" data-startTime="591">operations to compare paths. </span> <span class="line" data-startTime="596">So in this case, we're computing </span><span class="line" data-startTime="596">the intersection of </span><span class="line" data-startTime="598">a pair of rectangles from </span><span class="line" data-startTime="598">two separate rectangles. </span> <span class="line" data-startTime="605">The union operator looks a lot </span><span class="line" data-startTime="605">like the simplify operator. </span> <span class="line" data-startTime="609">It uses two paths, each with a </span><span class="line" data-startTime="609">single contour, instead of one </span><span class="line" data-startTime="613">path with two contours. </span> <span class="line" data-startTime="614">A contour is a closed portion </span><span class="line" data-startTime="614">of a path, so it's a </span><span class="line" data-startTime="620">continuous closed loop. </span> <span class="line" data-startTime="624">There's a pair of difference </span><span class="line" data-startTime="624">operators. </span> <span class="line" data-startTime="625">This difference operator </span><span class="line" data-startTime="625">subtracts the dark green </span><span class="line" data-startTime="628">rectangle from the blue one. </span></p>

<p><span class="line" data-startTime="630">There's a reverse difference </span><span class="line" data-startTime="630">that would subtract the blue </span><span class="line" data-startTime="633">rectangle from the </span><span class="line" data-startTime="633">dark green one. </span> <span class="line" data-startTime="637">For completeness, there's also </span><span class="line" data-startTime="637">exclusive or, although this </span><span class="line" data-startTime="640">one isn't used very much. </span> <span class="line" data-startTime="644">And finally, there's complement, </span><span class="line" data-startTime="644">which describes </span><span class="line" data-startTime="647">all of the area that's </span><span class="line" data-startTime="647">outside of a path. </span> <span class="line" data-startTime="651">As it turns out, there's </span><span class="line" data-startTime="651">no special function for </span><span class="line" data-startTime="653">complement because Skia's paths </span><span class="line" data-startTime="653">have a way of describing </span><span class="line" data-startTime="659">whether it's the fill </span><span class="line" data-startTime="659">or the inverse fill. </span> <span class="line" data-startTime="662">So the complement is just </span><span class="line" data-startTime="662">toggling those two attributes. </span> <span class="line" data-startTime="669">There's no reason to implement </span><span class="line" data-startTime="669">all of these path ops as </span><span class="line" data-startTime="672">separate functions since </span><span class="line" data-startTime="672">they're really </span><span class="line" data-startTime="674">all the same thing. </span> <span class="line" data-startTime="676">In this illustration, we have </span><span class="line" data-startTime="676">the paths A and B and their </span><span class="line" data-startTime="681">complements running down the </span><span class="line" data-startTime="681">column on the left and </span><span class="line" data-startTime="685">different path operations </span><span class="line" data-startTime="685">running in the </span><span class="line" data-startTime="688">row across the top. </span> <span class="line" data-startTime="690">So you can see that the </span><span class="line" data-startTime="690">intersection of A and B is the </span><span class="line" data-startTime="694">same as the difference of A </span><span class="line" data-startTime="694">complement B, or the exclusive </span><span class="line" data-startTime="701">or of A and B is the same as the </span><span class="line" data-startTime="701">union of A minus B and B </span><span class="line" data-startTime="706">minus A is also the difference </span><span class="line" data-startTime="706">between the </span><span class="line" data-startTime="712">intersection and the union. </span></p>

<p><span class="line" data-startTime="717">So what's all this good for? </span><span class="line" data-startTime="719">Back when fonts were originally </span><span class="line" data-startTime="719">ported to </span><span class="line" data-startTime="722">computers, a lot of times the </span><span class="line" data-startTime="722">complex characters were </span><span class="line" data-startTime="726">created by drawing individual </span><span class="line" data-startTime="726">characters on top of each </span><span class="line" data-startTime="729">other, like a slash on top of </span><span class="line" data-startTime="729">the letter O. If you drew the </span><span class="line" data-startTime="734">outline of those characters, </span><span class="line" data-startTime="734">you'd get an undesirable </span><span class="line" data-startTime="736">result as shown here because you </span><span class="line" data-startTime="736">would see both outlines at </span><span class="line" data-startTime="739">the same time where you'd really </span><span class="line" data-startTime="739">like to see only the </span><span class="line" data-startTime="744">portion described by the area </span><span class="line" data-startTime="744">of the two characters. </span> <span class="line" data-startTime="748">So the question is how do we </span><span class="line" data-startTime="748">get from there to here? </span><span class="line" data-startTime="752">When I first wrote this in the </span><span class="line" data-startTime="752">'80s, my approach was very </span><span class="line" data-startTime="756">similar to the way I drew </span><span class="line" data-startTime="756">these characters. </span> <span class="line" data-startTime="758">I would start by finding </span><span class="line" data-startTime="758">the maxima and </span><span class="line" data-startTime="760">minima of the curves. </span> <span class="line" data-startTime="763">Once they were split, I would </span><span class="line" data-startTime="763">then find all the vertical </span><span class="line" data-startTime="766">occurrences where either a new </span><span class="line" data-startTime="766">curve started, a new curve </span><span class="line" data-startTime="770">stopped, or a pair of </span><span class="line" data-startTime="770">intersections occurred. </span> <span class="line" data-startTime="776">Given all those vertical events, </span><span class="line" data-startTime="776">I would sort them and </span><span class="line" data-startTime="779">then walk across them </span><span class="line" data-startTime="779">horizontally and find every </span><span class="line" data-startTime="782">place where one of the </span><span class="line" data-startTime="782">curves intersected </span><span class="line" data-startTime="785">that horizontal line. </span></p>

<p><span class="line" data-startTime="787">Then I would have to </span><span class="line" data-startTime="787">sort those as well. </span> <span class="line" data-startTime="792">Finally, if a pair of curves or </span><span class="line" data-startTime="792">a line and a curve had the </span><span class="line" data-startTime="796">same y value for some given x </span><span class="line" data-startTime="796">value, I had to sort those to </span><span class="line" data-startTime="802">know which one would </span><span class="line" data-startTime="802">contribute to </span><span class="line" data-startTime="804">the final path first. </span> <span class="line" data-startTime="808">All of the sorting is required </span><span class="line" data-startTime="808">because of something called </span><span class="line" data-startTime="811">the winding number rule. </span> <span class="line" data-startTime="813">And the winding number rule says </span><span class="line" data-startTime="813">that the direction of the </span><span class="line" data-startTime="816">path describes whether it </span><span class="line" data-startTime="816">contributes or subtracts from </span><span class="line" data-startTime="821">the output. </span> <span class="line" data-startTime="823">So in this case, the down arrows </span><span class="line" data-startTime="823">contribute a plus 1 to </span><span class="line" data-startTime="827">the answer and the up </span><span class="line" data-startTime="827">arrows contribute a </span><span class="line" data-startTime="830">minus 1 to the answer. </span></p>

<p><span class="line" data-startTime="833">If I sum those numbers as I </span><span class="line" data-startTime="833">move across from left to </span><span class="line" data-startTime="835">right, every time that a 0 </span><span class="line" data-startTime="835">changes to a 1 or a 1 changes </span><span class="line" data-startTime="839">to a 0, that's a line </span><span class="line" data-startTime="839">that I keep. </span> <span class="line" data-startTime="843">If it changes from one positive </span><span class="line" data-startTime="843">number to another, </span><span class="line" data-startTime="846">those are lines I discard. </span> <span class="line" data-startTime="848">That will give me the desired </span><span class="line" data-startTime="848">output that I want. </span> <span class="line" data-startTime="854">This time around, it occurred </span><span class="line" data-startTime="854">to me that all that sorting </span><span class="line" data-startTime="857">was a lot of work and took a </span><span class="line" data-startTime="857">lot of time, and there was </span><span class="line" data-startTime="860">probably a simpler approach. </span> <span class="line" data-startTime="861">In fact, there are really only </span><span class="line" data-startTime="861">eight intersection points </span><span class="line" data-startTime="864">between these pairs of curves </span><span class="line" data-startTime="864">and lines that I </span><span class="line" data-startTime="867">actually care about. </span></p>

<p><span class="line" data-startTime="869">All the other sorting </span><span class="line" data-startTime="869">information is superfluous to </span><span class="line" data-startTime="871">the real answer. </span> <span class="line" data-startTime="874">If I look at any one of those </span><span class="line" data-startTime="874">intersections, instead of </span><span class="line" data-startTime="878">thinking about how the y-number </span><span class="line" data-startTime="878">is affected as I </span><span class="line" data-startTime="881">traverse across the entire shape </span><span class="line" data-startTime="881">from left to right, I </span><span class="line" data-startTime="884">can think about what the winding </span><span class="line" data-startTime="884">number contribution is </span><span class="line" data-startTime="887">at that intersection point as </span><span class="line" data-startTime="887">I move around in a circle. </span> <span class="line" data-startTime="892">If I know what the intersection </span><span class="line" data-startTime="892">is as each curve </span><span class="line" data-startTime="897">contributes to the answer, once </span><span class="line" data-startTime="897">again, when 0 moves to 1 </span><span class="line" data-startTime="902">or 1 moves to 0, those </span><span class="line" data-startTime="902">are lines I keep. </span></p>

<p><span class="line" data-startTime="905">But when it goes from one </span><span class="line" data-startTime="905">positive number to the next, </span><span class="line" data-startTime="907">those are lines I discard. </span> <span class="line" data-startTime="912">The great benefit of this is </span><span class="line" data-startTime="912">once I have one answer, that </span><span class="line" data-startTime="916">answer propagates around the </span><span class="line" data-startTime="916">rest of the curve so I don't </span><span class="line" data-startTime="919">need to keep computing the </span><span class="line" data-startTime="919">inside or outsideness of the </span><span class="line" data-startTime="924">shape, and I can keep all of </span><span class="line" data-startTime="924">the information all the way </span><span class="line" data-startTime="927">around to the point I run into </span><span class="line" data-startTime="927">another intersection. </span> <span class="line" data-startTime="933">But before I can get there, I </span><span class="line" data-startTime="933">have to be able to find the </span><span class="line" data-startTime="936">intersections. </span> <span class="line" data-startTime="938">So let's take a look at one </span><span class="line" data-startTime="938">of the curve types. </span> <span class="line" data-startTime="941">This is a quadratic bezier </span><span class="line" data-startTime="941">defined by a couple of control </span><span class="line" data-startTime="944">points on the ends and one </span><span class="line" data-startTime="944">control point in the middle. </span> <span class="line" data-startTime="949">The quadratic bezier is parallel </span><span class="line" data-startTime="949">to the end points. </span></p>

<p><span class="line" data-startTime="954">The tangents of the quadratic </span><span class="line" data-startTime="954">bezier from the first to the </span><span class="line" data-startTime="957">second point define how </span><span class="line" data-startTime="957">the curve groups. </span> <span class="line" data-startTime="963">A pair of quadratic beziers </span><span class="line" data-startTime="963">are portions of a pair of </span><span class="line" data-startTime="966">parabolas, so they can </span><span class="line" data-startTime="966">intersect in as </span><span class="line" data-startTime="968">many as four points. </span> <span class="line" data-startTime="971">So that's a clue as to what the </span><span class="line" data-startTime="971">answer's going to be to </span><span class="line" data-startTime="974">find the intersection of </span><span class="line" data-startTime="974">a pair of quadratics. </span> <span class="line" data-startTime="976">I'll need to be able to find </span><span class="line" data-startTime="976">at least four solutions. </span> <span class="line" data-startTime="979">So if there is a solution, it's </span><span class="line" data-startTime="979">going to have to be able </span><span class="line" data-startTime="981">to find four roots. </span> <span class="line" data-startTime="986">Back in the original </span><span class="line" data-startTime="986">illustration, I mentioned that </span><span class="line" data-startTime="988">I have to divide the curves </span><span class="line" data-startTime="988">into a pair &mdash; </span><span class="line" data-startTime="992">I had to divide the curves at a </span><span class="line" data-startTime="992">maxima and a minima before I </span><span class="line" data-startTime="995">could proceed. </span> <span class="line" data-startTime="997">This is because everything </span><span class="line" data-startTime="997">was sorted in y. </span> <span class="line" data-startTime="1000">The first time I did this, I </span><span class="line" data-startTime="1000">thought that also meant that </span><span class="line" data-startTime="1003">it simplified the solution </span><span class="line" data-startTime="1003">for the intersection </span><span class="line" data-startTime="1006">of a pair of curves. </span></p>

<p><span class="line" data-startTime="1008">I thought if there are four </span><span class="line" data-startTime="1008">intersections for a pair of </span><span class="line" data-startTime="1011">parabolas, surely there are </span><span class="line" data-startTime="1011">only two intersections if </span><span class="line" data-startTime="1014">they're subdivided so they </span><span class="line" data-startTime="1014">only increase in y. </span> <span class="line" data-startTime="1018">I was wrong. </span> <span class="line" data-startTime="1020">There are three intersections </span><span class="line" data-startTime="1020">for monotonically increasing </span><span class="line" data-startTime="1023">curves, and this was quite </span><span class="line" data-startTime="1023">embarrassing when I figured it </span><span class="line" data-startTime="1026">out for the first time </span><span class="line" data-startTime="1026">back in the '80s. </span> <span class="line" data-startTime="1029">So this time around, I decided </span><span class="line" data-startTime="1029">to be much more careful about </span><span class="line" data-startTime="1031">the mathematics and the geometry </span><span class="line" data-startTime="1031">so I wouldn't fall </span><span class="line" data-startTime="1035">into the same sort </span><span class="line" data-startTime="1035">of mistake again. </span> <span class="line" data-startTime="1040">So let's take a look at </span><span class="line" data-startTime="1040">intersecting a pair of curves. </span> <span class="line" data-startTime="1045">For these curves, I want to find </span><span class="line" data-startTime="1045">the intersection and I </span><span class="line" data-startTime="1048">want to do so by creating the </span><span class="line" data-startTime="1048">mathematics that will solve </span><span class="line" data-startTime="1053">the answer directly. </span> <span class="line" data-startTime="1055">Another approach would be to </span><span class="line" data-startTime="1055">subdivide the curves, but </span><span class="line" data-startTime="1057">we'll talk about that </span><span class="line" data-startTime="1057">in just a moment. </span> <span class="line" data-startTime="1062">If I look at what the solution </span><span class="line" data-startTime="1062">is without looking at how I'm </span><span class="line" data-startTime="1066">going to get there, I can </span><span class="line" data-startTime="1066">imagine that there's a value </span><span class="line" data-startTime="1069">called t which varies </span><span class="line" data-startTime="1069">from 0 to 1 as I </span><span class="line" data-startTime="1075">traverse across the curve. </span> <span class="line" data-startTime="1079">When t is equal to 0, </span><span class="line" data-startTime="1079">it's going to be at </span><span class="line" data-startTime="1083">the C0 and C0 prime. </span></p>

<p><span class="line" data-startTime="1085">When t is at 1, it's </span><span class="line" data-startTime="1085">going to be at C2. </span> <span class="line" data-startTime="1088">And anywhere in between, it's </span><span class="line" data-startTime="1088">going to describe a point </span><span class="line" data-startTime="1090">along the curve. </span> <span class="line" data-startTime="1093">So for these sample pieces of </span><span class="line" data-startTime="1093">data, the t is a 1.25 for one </span><span class="line" data-startTime="1098">curve and 0.623 for the other. </span> <span class="line" data-startTime="1101">And when I plug the t into some </span><span class="line" data-startTime="1101">equation, I'll get the </span><span class="line" data-startTime="1103">same intersection point </span><span class="line" data-startTime="1103">for both curves. </span> <span class="line" data-startTime="1108">In Skia, by the way, the y </span><span class="line" data-startTime="1108">point's down instead of up, so </span><span class="line" data-startTime="1112">things may look a little upside </span><span class="line" data-startTime="1112">down from the math </span><span class="line" data-startTime="1114">you're used to. </span> <span class="line" data-startTime="1118">So let's get back to solving </span><span class="line" data-startTime="1118">curves by subdividing. </span> <span class="line" data-startTime="1123">This solution is the one that I </span><span class="line" data-startTime="1123">used originally in the '80s, </span><span class="line" data-startTime="1126">and it's very popular today as </span><span class="line" data-startTime="1126">well, and there's been a lot </span><span class="line" data-startTime="1128">of work to optimize this such as </span><span class="line" data-startTime="1128">the work by T. W. Sederberg </span><span class="line" data-startTime="1132">at BYU using convex hulls </span><span class="line" data-startTime="1132">to optimize subdivision. </span></p>

<p><span class="line" data-startTime="1140">I found this solution ultimately </span><span class="line" data-startTime="1140">unworkable because </span><span class="line" data-startTime="1144">it falls down when two curves </span><span class="line" data-startTime="1144">are very close to the same. </span> <span class="line" data-startTime="1148">In this case, every time the </span><span class="line" data-startTime="1148">curves are subdivided, the </span><span class="line" data-startTime="1152">pair of curves are still </span><span class="line" data-startTime="1152">very close to the same. </span> <span class="line" data-startTime="1155">And even though they don't </span><span class="line" data-startTime="1155">touch each other, it's </span><span class="line" data-startTime="1158">impossible to tell without </span><span class="line" data-startTime="1158">further subdivision. </span> <span class="line" data-startTime="1161">So I found in this case that it </span><span class="line" data-startTime="1161">was a very long tail before </span><span class="line" data-startTime="1166">I would know whether or not </span><span class="line" data-startTime="1166">the solution was found. </span> <span class="line" data-startTime="1169">So this is a solution I </span><span class="line" data-startTime="1169">tried and abandoned. </span> <span class="line" data-startTime="1174">So going back to the math </span><span class="line" data-startTime="1174">approach, this is the </span><span class="line" data-startTime="1177">Bernstein equation for a </span><span class="line" data-startTime="1177">quadratic bezier, and it </span><span class="line" data-startTime="1181">simply describes the x and y </span><span class="line" data-startTime="1181">values for some value of t </span><span class="line" data-startTime="1184">from 0 to 1. </span></p>

<p><span class="line" data-startTime="1186">As I said before, if t is </span><span class="line" data-startTime="1186">0, the answer is C0. </span> <span class="line" data-startTime="1189">If t is 1, the answer is C2. </span> <span class="line" data-startTime="1192">And if the t is any </span><span class="line" data-startTime="1192">other value, it's </span><span class="line" data-startTime="1195">somewhere along the curve. </span> <span class="line" data-startTime="1198">The simplified form of the </span><span class="line" data-startTime="1198">equation collects the values </span><span class="line" data-startTime="1202">together so that now I have a </span><span class="line" data-startTime="1202">simple quadratic which is very </span><span class="line" data-startTime="1207">easy to solve. </span> <span class="line" data-startTime="1211">The implicit form of the </span><span class="line" data-startTime="1211">equation is a little more </span><span class="line" data-startTime="1213">complicated, but it describes an </span><span class="line" data-startTime="1213">entire parabola instead of </span><span class="line" data-startTime="1217">the quadratic section which is </span><span class="line" data-startTime="1217">a piece of that parabola. </span> <span class="line" data-startTime="1222">Even though the math looks </span><span class="line" data-startTime="1222">daunting, it turns out there's </span><span class="line" data-startTime="1225">enough common terms that it only </span><span class="line" data-startTime="1225">takes about 28 multiplies </span><span class="line" data-startTime="1228">and 11 adds to get from </span><span class="line" data-startTime="1228">the simple form to </span><span class="line" data-startTime="1231">the implicit form. </span> <span class="line" data-startTime="1235">Once I have both the implicit </span><span class="line" data-startTime="1235">and parametric forms of the </span><span class="line" data-startTime="1240">equation, I can plug </span><span class="line" data-startTime="1240">one into the other. </span> <span class="line" data-startTime="1243">So I can take the second </span><span class="line" data-startTime="1243">equation, which describes how </span><span class="line" data-startTime="1248">x and y are in terms of t, and </span><span class="line" data-startTime="1248">I can plug that answer into </span><span class="line" data-startTime="1252">the third equation to get rid </span><span class="line" data-startTime="1252">of the t altogether and have </span><span class="line" data-startTime="1257">something I can solve for t. </span></p>

<p><span class="line" data-startTime="1262">Once I have the quartic </span><span class="line" data-startTime="1262">equation, now I can find the </span><span class="line" data-startTime="1266">solution that will give me </span><span class="line" data-startTime="1266">the intersection of one </span><span class="line" data-startTime="1268">curve with the other. </span> <span class="line" data-startTime="1270">But this just gets me the t </span><span class="line" data-startTime="1270">values for the first curve. </span> <span class="line" data-startTime="1274">I have to do the reverse and </span><span class="line" data-startTime="1274">plug the second equation into </span><span class="line" data-startTime="1278">the first in order to get the </span><span class="line" data-startTime="1278">complement, in order to get </span><span class="line" data-startTime="1283">the t values for the </span><span class="line" data-startTime="1283">prime equation. </span> <span class="line" data-startTime="1286">Once I have the t values for </span><span class="line" data-startTime="1286">both equations, I can plug </span><span class="line" data-startTime="1289">them in and ensure that they </span><span class="line" data-startTime="1289">return the same x and y values </span><span class="line" data-startTime="1294">for each of the quadratics. </span> <span class="line" data-startTime="1298">Since I have a quadratic </span><span class="line" data-startTime="1298">solution that's robust and </span><span class="line" data-startTime="1300">works well, you might think I </span><span class="line" data-startTime="1300">would also be able to use that </span><span class="line" data-startTime="1303">same solution for cubics. </span> <span class="line" data-startTime="1305">After all, cubics are just </span><span class="line" data-startTime="1305">quadratics with one more </span><span class="line" data-startTime="1308">control point, so they can't be </span><span class="line" data-startTime="1308">that much more complicated. </span></p>

<p><span class="line" data-startTime="1313">Here's the Bernstein polynomial </span><span class="line" data-startTime="1313">for a cubic </span><span class="line" data-startTime="1316">equation, which looks a lot </span><span class="line" data-startTime="1316">like the quadratic one. </span> <span class="line" data-startTime="1319">It just has one more </span><span class="line" data-startTime="1319">term, and this has </span><span class="line" data-startTime="1321">cubes instead of squares. </span> <span class="line" data-startTime="1326">If I overlay a pair of cubics </span><span class="line" data-startTime="1326">on top of each other, I'll </span><span class="line" data-startTime="1330">find that they can have as many </span><span class="line" data-startTime="1330">as nine intersections, </span><span class="line" data-startTime="1334">and this ought to set off alarm </span><span class="line" data-startTime="1334">bells because it's going </span><span class="line" data-startTime="1337">to be very hard to find nine </span><span class="line" data-startTime="1337">roots for an equation. </span> <span class="line" data-startTime="1343">If I plug the equation into </span><span class="line" data-startTime="1343">Mathematica, I get a rather </span><span class="line" data-startTime="1346">daunting-looking result. </span> <span class="line" data-startTime="1349">And notice that this still has </span><span class="line" data-startTime="1349">everything in terms of x and </span><span class="line" data-startTime="1351">y, so this is not the </span><span class="line" data-startTime="1351">complete solution. </span></p>

<p><span class="line" data-startTime="1354">This is half of it &mdash; </span><span class="line" data-startTime="1355">I still have to plug all of the </span><span class="line" data-startTime="1355">x and y values from the </span><span class="line" data-startTime="1358">alternate equation into </span><span class="line" data-startTime="1358">this equation. </span> <span class="line" data-startTime="1361">So things are looking sad </span><span class="line" data-startTime="1361">for solving cubics with </span><span class="line" data-startTime="1364">mathematics. </span> <span class="line" data-startTime="1367">Sure enough, if I work all the </span><span class="line" data-startTime="1367">way through, I'll end up with </span><span class="line" data-startTime="1370">a ninth ordered equation </span><span class="line" data-startTime="1370">for which there </span><span class="line" data-startTime="1373">is no general solution. </span> <span class="line" data-startTime="1375">And even though there's a lot </span><span class="line" data-startTime="1375">of advancements in root </span><span class="line" data-startTime="1377">finding and computers are much </span><span class="line" data-startTime="1377">faster than they were 25 years </span><span class="line" data-startTime="1381">ago, people haven't got a whole </span><span class="line" data-startTime="1381">lot smarter, so this </span><span class="line" data-startTime="1384">sort of equation is impossible </span><span class="line" data-startTime="1384">to solve </span><span class="line" data-startTime="1388">directly in a robust manner. </span></p>

<p><span class="line" data-startTime="1393">So let's take a look </span><span class="line" data-startTime="1393">at the cubic again. </span> <span class="line" data-startTime="1396">This cubic intersects itself, so </span><span class="line" data-startTime="1396">not only do I need to find </span><span class="line" data-startTime="1400">how the cubic intersects another </span><span class="line" data-startTime="1400">cubic, but I need to </span><span class="line" data-startTime="1402">know its own intersection. </span> <span class="line" data-startTime="1404">This gives me a clue as to </span><span class="line" data-startTime="1404">how I might solve the </span><span class="line" data-startTime="1407">intersection. </span> <span class="line" data-startTime="1410">Rather than try to solve the </span><span class="line" data-startTime="1410">cubic directly, I can </span><span class="line" data-startTime="1413">approximate it with a series of </span><span class="line" data-startTime="1413">quadratics and then use my </span><span class="line" data-startTime="1416">quadratic intersection to find </span><span class="line" data-startTime="1416">the actual solution. </span> <span class="line" data-startTime="1420">Once I get the intersection </span><span class="line" data-startTime="1420">values in t with quadratics, I </span><span class="line" data-startTime="1423">can take those same t values </span><span class="line" data-startTime="1423">and apply them back to the </span><span class="line" data-startTime="1426">cubic and then check to </span><span class="line" data-startTime="1426">see if they return the </span><span class="line" data-startTime="1429">same x and y value. </span> <span class="line" data-startTime="1432">This turns out to be a pretty </span><span class="line" data-startTime="1432">robust solution </span><span class="line" data-startTime="1434">that works very well. </span> <span class="line" data-startTime="1439">So here's a pair of cubics </span><span class="line" data-startTime="1439">that intersect each other </span><span class="line" data-startTime="1442">connected to a line. </span></p>

<p><span class="line" data-startTime="1444">For lines in cubics and lines </span><span class="line" data-startTime="1444">and the lines and the lines in </span><span class="line" data-startTime="1447">quadratics, I can solve </span><span class="line" data-startTime="1447">those directly. </span> <span class="line" data-startTime="1450">I don't have to do </span><span class="line" data-startTime="1450">any special math. </span> <span class="line" data-startTime="1452">So this line does not intersect </span><span class="line" data-startTime="1452">cubic one &mdash; it just </span><span class="line" data-startTime="1456">misses touching it &mdash; </span><span class="line" data-startTime="1457">but the pair of cubics </span><span class="line" data-startTime="1457">intersect each other. </span> <span class="line" data-startTime="1462">When I approximate one cubic </span><span class="line" data-startTime="1462">with a quadratic, the </span><span class="line" data-startTime="1466">quadratic approximation is very </span><span class="line" data-startTime="1466">close, which is fine. </span> <span class="line" data-startTime="1470">It's just exactly what </span><span class="line" data-startTime="1470">I want it to be. </span> <span class="line" data-startTime="1473">The cubic continues off to the </span><span class="line" data-startTime="1473">right, and as the cubic </span><span class="line" data-startTime="1475">continues, the quadratic </span><span class="line" data-startTime="1475">approximation drifts a little </span><span class="line" data-startTime="1478">bit further away, </span><span class="line" data-startTime="1478">but not too far. </span></p>

<p><span class="line" data-startTime="1482">But for the first cubic, its </span><span class="line" data-startTime="1482">endpoints are far off the </span><span class="line" data-startTime="1485">screen, and so the quadratic </span><span class="line" data-startTime="1485">approximation at this point is </span><span class="line" data-startTime="1489">the furthest it ever gets </span><span class="line" data-startTime="1489">from the cubic. </span> <span class="line" data-startTime="1495">So even though the line does not </span><span class="line" data-startTime="1495">intersect the cubic, it's </span><span class="line" data-startTime="1499">also the case that the pair of </span><span class="line" data-startTime="1499">quadratics do not intersect </span><span class="line" data-startTime="1502">each other. </span> <span class="line" data-startTime="1504">So using a straightforward </span><span class="line" data-startTime="1504">solution, I miss this </span><span class="line" data-startTime="1506">intersection altogether, </span><span class="line" data-startTime="1506">and my path ops </span><span class="line" data-startTime="1508">produce the wrong result. </span></p>

<p><span class="line" data-startTime="1512">To find the intersection of the </span><span class="line" data-startTime="1512">cubics, I have to rely on </span><span class="line" data-startTime="1516">the convex hull. </span> <span class="line" data-startTime="1518">The convex hull is what happens </span><span class="line" data-startTime="1518">when you connect all </span><span class="line" data-startTime="1520">the control points of </span><span class="line" data-startTime="1520">the cubic together. </span> <span class="line" data-startTime="1522">It describes a polygon around </span><span class="line" data-startTime="1522">which the cubic is guaranteed </span><span class="line" data-startTime="1525">to be contained by. </span> <span class="line" data-startTime="1527">If I look at the very end of </span><span class="line" data-startTime="1527">the convex hull, these tiny </span><span class="line" data-startTime="1530">little line segments, then I can </span><span class="line" data-startTime="1530">find the intersections of </span><span class="line" data-startTime="1534">those lines with the opposing </span><span class="line" data-startTime="1534">cubic and use that to find the </span><span class="line" data-startTime="1538">intersections of the </span><span class="line" data-startTime="1538">pair of cubics. </span></p>

<p><span class="line" data-startTime="1540">Since I only have to do this </span><span class="line" data-startTime="1540">at the very ends of the </span><span class="line" data-startTime="1543">cubics, it's a trivial </span><span class="line" data-startTime="1543">computation, and it allows the </span><span class="line" data-startTime="1547">entire calculation </span><span class="line" data-startTime="1547">to be robust. </span> <span class="line" data-startTime="1552">Now that I have the </span><span class="line" data-startTime="1552">intersections of cubics, </span><span class="line" data-startTime="1554">quadratics, and lines, then I </span><span class="line" data-startTime="1554">can get back to performing my </span><span class="line" data-startTime="1557">path operations. </span> <span class="line" data-startTime="1560">As before, I'd like to find </span><span class="line" data-startTime="1560">all of the places where an </span><span class="line" data-startTime="1565">intersection travels, and I </span><span class="line" data-startTime="1565">would like compute all the </span><span class="line" data-startTime="1567">crossings in a circle. </span> <span class="line" data-startTime="1569">And as I move counterclockwise </span><span class="line" data-startTime="1569">around all of those crossings, </span><span class="line" data-startTime="1573">I'd like to accumulate the </span><span class="line" data-startTime="1573">winding number to know which </span><span class="line" data-startTime="1576">edges to keep and which </span><span class="line" data-startTime="1576">edges to discard. </span> <span class="line" data-startTime="1581">In this example, a triangle and </span><span class="line" data-startTime="1581">a pair of circles touch at </span><span class="line" data-startTime="1584">the same point, and there are </span><span class="line" data-startTime="1584">two lines and two quadratics </span><span class="line" data-startTime="1588">that all descend from that </span><span class="line" data-startTime="1588">point, and I need to sort them </span><span class="line" data-startTime="1592">as I move around </span><span class="line" data-startTime="1592">counterclockwise. </span> <span class="line" data-startTime="1596">When I sort the pair of lines, </span><span class="line" data-startTime="1596">the answer is straightforward. </span></p>

<p><span class="line" data-startTime="1599">The direction of the line allows </span><span class="line" data-startTime="1599">me to know which line </span><span class="line" data-startTime="1601">is to the left of the other </span><span class="line" data-startTime="1601">using a simple cross product. </span> <span class="line" data-startTime="1607">For the line in the quadratic, I </span><span class="line" data-startTime="1607">can't use that trick because </span><span class="line" data-startTime="1611">the initial tangent of </span><span class="line" data-startTime="1611">the quadratic is </span><span class="line" data-startTime="1613">the same as the line. </span> <span class="line" data-startTime="1615">But I can use the fact that the </span><span class="line" data-startTime="1615">quadratic curls away from </span><span class="line" data-startTime="1617">the line to know whether it </span><span class="line" data-startTime="1617">curls to the right or the left </span><span class="line" data-startTime="1620">of the line. </span> <span class="line" data-startTime="1622">For a pair of quadratics, the </span><span class="line" data-startTime="1622">answer is not so simple. </span> <span class="line" data-startTime="1626">This particular pair of </span><span class="line" data-startTime="1626">quadratics have exactly the </span><span class="line" data-startTime="1629">same implicit equation &mdash; </span><span class="line" data-startTime="1630">that is, they're part of the </span><span class="line" data-startTime="1630">same parabola, and for that </span><span class="line" data-startTime="1634">matter, they're the exact same </span><span class="line" data-startTime="1634">part of that same parabola, so </span><span class="line" data-startTime="1638">they have the same </span><span class="line" data-startTime="1638">curved shape. </span> <span class="line" data-startTime="1644">And if I take the derivative of </span><span class="line" data-startTime="1644">each curve, I won't get any </span><span class="line" data-startTime="1647">more information because the </span><span class="line" data-startTime="1647">derivative will be identical </span><span class="line" data-startTime="1650">for these two. </span></p>

<p><span class="line" data-startTime="1652">So even though it's clear by </span><span class="line" data-startTime="1652">looking at them that Q2 is to </span><span class="line" data-startTime="1656">the left of Q1, it's hard </span><span class="line" data-startTime="1656">to figure that out </span><span class="line" data-startTime="1659">mathematically. </span> <span class="line" data-startTime="1662">My solution for now is to take </span><span class="line" data-startTime="1662">the shorter of the two </span><span class="line" data-startTime="1667">tangents and bisect that with </span><span class="line" data-startTime="1667">the shorter of the start end </span><span class="line" data-startTime="1672">points and sort those </span><span class="line" data-startTime="1672">intersections. </span> <span class="line" data-startTime="1676">Empirically, this produces the </span><span class="line" data-startTime="1676">right result, although there </span><span class="line" data-startTime="1680">may be a better one. </span> <span class="line" data-startTime="1685">All of this sorting falls </span><span class="line" data-startTime="1685">apart when the </span><span class="line" data-startTime="1690">numerics become small. </span> <span class="line" data-startTime="1692">So here I have a line that </span><span class="line" data-startTime="1692">travels between two points off </span><span class="line" data-startTime="1696">screen, and here are the </span><span class="line" data-startTime="1696">approximations of that line as </span><span class="line" data-startTime="1701">represented by little circles. </span> <span class="line" data-startTime="1704">This grid represents the </span><span class="line" data-startTime="1704">floating point resolution </span><span class="line" data-startTime="1708">that's available to me, so if </span><span class="line" data-startTime="1708">my numbers are in doubles, </span><span class="line" data-startTime="1712">then each grid line represents </span><span class="line" data-startTime="1712">the smallest possible value </span><span class="line" data-startTime="1718">that that double </span><span class="line" data-startTime="1718">can represent. </span> <span class="line" data-startTime="1720">In other words, there's no way </span><span class="line" data-startTime="1720">to represent any value smaller </span><span class="line" data-startTime="1724">than the grid lines. </span></p>

<p><span class="line" data-startTime="1727">When I intersect a pair of </span><span class="line" data-startTime="1727">lines, I'm going to find at </span><span class="line" data-startTime="1730">best the number that is the </span><span class="line" data-startTime="1730">truncation of the actual </span><span class="line" data-startTime="1735">intersection. </span> <span class="line" data-startTime="1736">In other words, because double </span><span class="line" data-startTime="1736">precision is finite, </span><span class="line" data-startTime="1740">everything's going </span><span class="line" data-startTime="1740">to round down. </span> <span class="line" data-startTime="1745">Here's the second line that </span><span class="line" data-startTime="1745">intersects the original line. </span> <span class="line" data-startTime="1749">And once again, the intersection </span><span class="line" data-startTime="1749">as the best </span><span class="line" data-startTime="1752">possible approximation rounds </span><span class="line" data-startTime="1752">down, and it's represented by </span><span class="line" data-startTime="1755">the red circle. </span> <span class="line" data-startTime="1759">When I consider which of these </span><span class="line" data-startTime="1759">lines I would encounter first </span><span class="line" data-startTime="1763">when traveling from left to </span><span class="line" data-startTime="1763">right, I see visually that the </span><span class="line" data-startTime="1767">blue line is to the left </span><span class="line" data-startTime="1767">of the red line. </span> <span class="line" data-startTime="1770">But when I walk across and look </span><span class="line" data-startTime="1770">at the answers that I </span><span class="line" data-startTime="1774">received from the intersection, </span><span class="line" data-startTime="1774">I hit the red </span><span class="line" data-startTime="1776">dot before I hit the blue dot. </span></p>

<p><span class="line" data-startTime="1779">So basically, the </span><span class="line" data-startTime="1779">math lied to me. </span> <span class="line" data-startTime="1781">It gave me the wrong </span><span class="line" data-startTime="1781">intersection. </span> <span class="line" data-startTime="1785">As it turns out, this would not </span><span class="line" data-startTime="1785">be important because this </span><span class="line" data-startTime="1789">little triangular sliver, even </span><span class="line" data-startTime="1789">though it would be incorrectly </span><span class="line" data-startTime="1792">computed, is so small </span><span class="line" data-startTime="1792">it wouldn't draw. </span> <span class="line" data-startTime="1795">It would simply disappear. </span> <span class="line" data-startTime="1798">But if I'm doing the same work </span><span class="line" data-startTime="1798">with a curve instead a pair of </span><span class="line" data-startTime="1802">lines, then all of a sudden the </span><span class="line" data-startTime="1802">area described between the </span><span class="line" data-startTime="1806">blue line and the red curve can </span><span class="line" data-startTime="1806">become very large, and my </span><span class="line" data-startTime="1809">error likewise becomes </span><span class="line" data-startTime="1809">very large. </span> <span class="line" data-startTime="1811">And now my answer is </span><span class="line" data-startTime="1811">wrong for a large </span><span class="line" data-startTime="1813">portion of the path op. </span> <span class="line" data-startTime="1818">This means that for a lot of </span><span class="line" data-startTime="1818">computation, I need just to </span><span class="line" data-startTime="1822">decide that the answer </span><span class="line" data-startTime="1822">is just unknowable. </span></p>

<p><span class="line" data-startTime="1826">It may be unsortable, it may </span><span class="line" data-startTime="1826">be tiny, or it may be </span><span class="line" data-startTime="1829">unorderable, but I can't </span><span class="line" data-startTime="1829">necessarily compute what the </span><span class="line" data-startTime="1833">answer is for an intersection. </span> <span class="line" data-startTime="1836">To solve this in the general </span><span class="line" data-startTime="1836">case, I simply find another </span><span class="line" data-startTime="1840">intersection that I do know and </span><span class="line" data-startTime="1840">propagate that answer back </span><span class="line" data-startTime="1843">to the intersection </span><span class="line" data-startTime="1843">that I don't know. </span> <span class="line" data-startTime="1849">If a pair of shapes exactly </span><span class="line" data-startTime="1849">overlap each other as in the </span><span class="line" data-startTime="1853">case of this pair of rectangles, </span><span class="line" data-startTime="1853">the path op is </span><span class="line" data-startTime="1858">pretty straightforward </span><span class="line" data-startTime="1858">to compute. </span> <span class="line" data-startTime="1859">In this case, the dark green </span><span class="line" data-startTime="1859">rectangle is below the blue </span><span class="line" data-startTime="1863">one, and so I just want to </span><span class="line" data-startTime="1863">return the top of the blue one </span><span class="line" data-startTime="1866">as the answer. </span></p>

<p><span class="line" data-startTime="1869">A lot of the online references </span><span class="line" data-startTime="1869">that I researched suggest that </span><span class="line" data-startTime="1874">when points are difficult to </span><span class="line" data-startTime="1874">compute, that you could jiggle </span><span class="line" data-startTime="1878">the points in order to compute </span><span class="line" data-startTime="1878">the actual answer, but this is </span><span class="line" data-startTime="1882">a case where jiggling </span><span class="line" data-startTime="1882">is destructive. </span> <span class="line" data-startTime="1885">If I move the lower rectangle's </span><span class="line" data-startTime="1885">shapes around a </span><span class="line" data-startTime="1889">little bit to avoid having </span><span class="line" data-startTime="1889">coincident points, then my </span><span class="line" data-startTime="1894">answer will have extra little </span><span class="line" data-startTime="1894">spikes on them. </span> <span class="line" data-startTime="1897">All these spikes are so small </span><span class="line" data-startTime="1897">they may not draw. </span> <span class="line" data-startTime="1900">They prevent me from having a </span><span class="line" data-startTime="1900">convex result, which might be </span><span class="line" data-startTime="1903">a special operation or a special </span><span class="line" data-startTime="1903">optimization when the </span><span class="line" data-startTime="1908">shape is accelerated. </span> <span class="line" data-startTime="1909">Also, it prevents me from </span><span class="line" data-startTime="1909">knowing the actual balance of </span><span class="line" data-startTime="1913">the resulting shape, and it </span><span class="line" data-startTime="1913">makes the testing hard, </span><span class="line" data-startTime="1916">because I can't guarantee that </span><span class="line" data-startTime="1916">a tap on the shape won't </span><span class="line" data-startTime="1920">accidentally be inside one of </span><span class="line" data-startTime="1920">those little triangles. </span></p>

<p><span class="line" data-startTime="1923">So this is one reason why </span><span class="line" data-startTime="1923">jiggling, I think, is not a </span><span class="line" data-startTime="1926">robust solution to path ops. </span> <span class="line" data-startTime="1932">While I can't do jiggling, I </span><span class="line" data-startTime="1932">also can't do precise math </span><span class="line" data-startTime="1936">because there's enough error </span><span class="line" data-startTime="1936">term in all these calculations </span><span class="line" data-startTime="1940">that I always have to worry </span><span class="line" data-startTime="1940">about what the error is. </span> <span class="line" data-startTime="1944">So I spent a lot of time </span><span class="line" data-startTime="1944">thinking about the unit of </span><span class="line" data-startTime="1947">least precision, which </span><span class="line" data-startTime="1947">is the error term. </span> <span class="line" data-startTime="1951">When I compare numbers between </span><span class="line" data-startTime="1951">0 and 1, I can describe </span><span class="line" data-startTime="1954">exactly what that error is, and </span><span class="line" data-startTime="1954">the error I chose is the </span><span class="line" data-startTime="1958">smallest amount that a floating </span><span class="line" data-startTime="1958">point value can </span><span class="line" data-startTime="1961">represent, a 32-bit float </span><span class="line" data-startTime="1961">can represent. </span></p>

<p><span class="line" data-startTime="1965">This computation can be done all </span><span class="line" data-startTime="1965">in float space or in the </span><span class="line" data-startTime="1969">[INAUDIBLE] </span><span class="line" data-startTime="1969">registers or the [INAUDIBLE] </span><span class="line" data-startTime="1969">registers on an ARM chip, and </span><span class="line" data-startTime="1973">it's a fairly fast computation </span><span class="line" data-startTime="1973">to make. </span> <span class="line" data-startTime="1977">When the values are arbitrary, </span><span class="line" data-startTime="1977">as an ordinary x and y point </span><span class="line" data-startTime="1981">part of a Cartesian coordinate, </span><span class="line" data-startTime="1981">then the only </span><span class="line" data-startTime="1985">reasonable way to determine the </span><span class="line" data-startTime="1985">equality is to look at the </span><span class="line" data-startTime="1991">integer bit representation of </span><span class="line" data-startTime="1991">the floating point numbers. </span> <span class="line" data-startTime="1994">This is expensive because it </span><span class="line" data-startTime="1994">requires taking the original </span><span class="line" data-startTime="1998">float values and moving them out </span><span class="line" data-startTime="1998">of the float registers and </span><span class="line" data-startTime="2001">into the integer ALU before the </span><span class="line" data-startTime="2001">comparison can be done, </span><span class="line" data-startTime="2005">and that will always stall </span><span class="line" data-startTime="2005">the float pipeline. </span> <span class="line" data-startTime="2007">So whenever possible, I work in </span><span class="line" data-startTime="2007">t space between 0 and 1 and </span><span class="line" data-startTime="2012">avoid comparing x's and y's </span><span class="line" data-startTime="2012">as much as I possibly can. </span></p>

<p><span class="line" data-startTime="2018">I have a whole lot of epsilon </span><span class="line" data-startTime="2018">values that I currently use, </span><span class="line" data-startTime="2023">depending on the complexity </span><span class="line" data-startTime="2023">of the math. </span> <span class="line" data-startTime="2025">I hope over time to simplify </span><span class="line" data-startTime="2025">and reduce the number of </span><span class="line" data-startTime="2028">epsilons required to perform </span><span class="line" data-startTime="2028">this calculation. </span> <span class="line" data-startTime="2031">And a lot of these are seat of </span><span class="line" data-startTime="2031">the pants numbers, but they're </span><span class="line" data-startTime="2034">the best I know how to do. </span> <span class="line" data-startTime="2038">There's a lot of unanswered </span><span class="line" data-startTime="2038">questions in path ops. </span> <span class="line" data-startTime="2042">For instance, here's a shape </span><span class="line" data-startTime="2042">that has more than one </span><span class="line" data-startTime="2045">possible solution. </span> <span class="line" data-startTime="2046">When I simplify it, it I might </span><span class="line" data-startTime="2046">end up with an L-shaped </span><span class="line" data-startTime="2050">corner, or I might end </span><span class="line" data-startTime="2050">up with a small </span><span class="line" data-startTime="2052">rectangle in the middle. </span> <span class="line" data-startTime="2054">Both of these are equally valid </span><span class="line" data-startTime="2054">answers, and there's no </span><span class="line" data-startTime="2057">reason to prefer one over the </span><span class="line" data-startTime="2057">other, but one might be more </span><span class="line" data-startTime="2060">desirable for graphics </span><span class="line" data-startTime="2060">acceleration, for instance. </span></p>

<p><span class="line" data-startTime="2063">And currently, I don't have a </span><span class="line" data-startTime="2063">way for the algorithm or the </span><span class="line" data-startTime="2067">user to choose one </span><span class="line" data-startTime="2067">over the other. </span> <span class="line" data-startTime="2071">Similarly, I don't have a way of </span><span class="line" data-startTime="2071">choosing winding direction. </span> <span class="line" data-startTime="2075">So here are two shapes with </span><span class="line" data-startTime="2075">different winding. </span> <span class="line" data-startTime="2077">The top one winds to the right </span><span class="line" data-startTime="2077">on the outer contour, and the </span><span class="line" data-startTime="2083">bottom one winds to the left. </span> <span class="line" data-startTime="2085">While these draw equivalently </span><span class="line" data-startTime="2085">and are otherwise identical, </span><span class="line" data-startTime="2089">they might have different </span><span class="line" data-startTime="2089">results &mdash; for instance, if you </span><span class="line" data-startTime="2091">dash the shapes, because the </span><span class="line" data-startTime="2091">dashing is going to start at a </span><span class="line" data-startTime="2094">different point, and it's </span><span class="line" data-startTime="2094">going to travel </span><span class="line" data-startTime="2096">in a different direction. </span></p>

<p><span class="line" data-startTime="2098">This is another area where I </span><span class="line" data-startTime="2098">don't have a way to choose one </span><span class="line" data-startTime="2103">over the other nor know what </span><span class="line" data-startTime="2103">the user's real intent was. </span> <span class="line" data-startTime="2110">Finally, right now I </span><span class="line" data-startTime="2110">only compute areas. </span> <span class="line" data-startTime="2114">So for instance, given this </span><span class="line" data-startTime="2114">rotated rectangle and a </span><span class="line" data-startTime="2118">rectangular clip, I return a </span><span class="line" data-startTime="2118">parallelogram, which is the </span><span class="line" data-startTime="2123">area of the intersection. </span> <span class="line" data-startTime="2126">But there may be some reason </span><span class="line" data-startTime="2126">to return a pair of lines </span><span class="line" data-startTime="2128">instead because those lines </span><span class="line" data-startTime="2128">would be the part of the frame </span><span class="line" data-startTime="2132">that's visible inside </span><span class="line" data-startTime="2132">the clip. </span></p>

<p><span class="line" data-startTime="2135">This is another case where I </span><span class="line" data-startTime="2135">don't know what the user's </span><span class="line" data-startTime="2138">intent was, and I also don't </span><span class="line" data-startTime="2138">know if the lower answer is an </span><span class="line" data-startTime="2142">answer that's valuable. </span> <span class="line" data-startTime="2146">To this point, I'm only coding </span><span class="line" data-startTime="2146">the answers that actually have </span><span class="line" data-startTime="2150">a practical use. </span> <span class="line" data-startTime="2152">Once there's a need for this </span><span class="line" data-startTime="2152">sort of computation, it's an </span><span class="line" data-startTime="2155">easy thing to add, but I'll wait </span><span class="line" data-startTime="2155">until it shows up as an </span><span class="line" data-startTime="2158">optimization for Skia </span><span class="line" data-startTime="2158">before I add it. </span> <span class="line" data-startTime="2164">Here's the current </span><span class="line" data-startTime="2164">source code. </span> <span class="line" data-startTime="2166">Everything is public, open </span><span class="line" data-startTime="2166">source, and checked in, and </span><span class="line" data-startTime="2169">you can go get any of the path </span><span class="line" data-startTime="2169">ops code, the interfaces, or </span><span class="line" data-startTime="2173">the sources here. </span></p>

<p><span class="line" data-startTime="2176">And I'm going to spend a few </span><span class="line" data-startTime="2176">minutes talking about how I </span><span class="line" data-startTime="2179">debugged and wrote path ops </span><span class="line" data-startTime="2179">and show you a small demo. </span> <span class="line" data-startTime="2185">And I'm going to do </span><span class="line" data-startTime="2185">my updates later. </span> <span class="line" data-startTime="2190">When I generate path ops, I do </span><span class="line" data-startTime="2190">a lot of printfs, and the </span><span class="line" data-startTime="2194">printfs look a lot like this. </span> <span class="line" data-startTime="2197">And while these numbers are </span><span class="line" data-startTime="2197">helpful, sometimes they're </span><span class="line" data-startTime="2199">very hard to visualize, so I </span><span class="line" data-startTime="2199">wrote a way to visualize them. </span> <span class="line" data-startTime="2206">Oops &mdash; how do I get </span><span class="line" data-startTime="2206">there from here? </span><span class="line" data-startTime="2211">There we go. </span> <span class="line" data-startTime="2215">This is a web page that contains </span><span class="line" data-startTime="2215">a canvas, and the </span><span class="line" data-startTime="2220">canvas contains the printf </span><span class="line" data-startTime="2220">output that I showed earlier, </span><span class="line" data-startTime="2224">which is at the bottom </span><span class="line" data-startTime="2224">of the screen. </span> <span class="line" data-startTime="2227">The top part of the screen shows </span><span class="line" data-startTime="2227">visualizing that output </span><span class="line" data-startTime="2230">and visualizing pieces </span><span class="line" data-startTime="2230">of that output. </span></p>

<p><span class="line" data-startTime="2232">So for instance, all of these </span><span class="line" data-startTime="2232">little circles show the </span><span class="line" data-startTime="2236">winding values that are computed </span><span class="line" data-startTime="2236">for this shape. </span> <span class="line" data-startTime="2239">And if I look at a pair of these </span><span class="line" data-startTime="2239">shapes, a pair of these </span><span class="line" data-startTime="2242">tests, I can see at least one </span><span class="line" data-startTime="2242">place where I computed a </span><span class="line" data-startTime="2246">different answer on the </span><span class="line" data-startTime="2246">two different shapes. </span> <span class="line" data-startTime="2250">That's where the bug was that </span><span class="line" data-startTime="2250">I had to trace down here. </span> <span class="line" data-startTime="2255">This particular canvas allows me </span><span class="line" data-startTime="2255">to see a lot of information </span><span class="line" data-startTime="2260">about the path ops </span><span class="line" data-startTime="2260">that I compute. </span></p>

<p><span class="line" data-startTime="2262">For instance, I can see all of </span><span class="line" data-startTime="2262">the edges as they're first </span><span class="line" data-startTime="2268">computed, and then I can step </span><span class="line" data-startTime="2268">through each set of edges and </span><span class="line" data-startTime="2272">watch how they're processed. </span> <span class="line" data-startTime="2275">Or I can see the edges as </span><span class="line" data-startTime="2275">they're output so that I know </span><span class="line" data-startTime="2281">at what point in the code </span><span class="line" data-startTime="2281">each edge is generated. </span> <span class="line" data-startTime="2290">So here's the output that this </span><span class="line" data-startTime="2290">particular test generated, and </span><span class="line" data-startTime="2293">here's the output that the test </span><span class="line" data-startTime="2293">that failed generated. </span> <span class="line" data-startTime="2296">So I can compare the two and </span><span class="line" data-startTime="2296">have a pretty good idea where </span><span class="line" data-startTime="2300">things went wrong. </span> <span class="line" data-startTime="2304">Here's another example that </span><span class="line" data-startTime="2304">shows a pair of cubics, and it </span><span class="line" data-startTime="2309">also shows the quadratics that </span><span class="line" data-startTime="2309">were generated to approximate </span><span class="line" data-startTime="2312">those cubics. </span> <span class="line" data-startTime="2315">So this is actually showing </span><span class="line" data-startTime="2315">both the cubics and the </span><span class="line" data-startTime="2317">quadratics at the same time, </span><span class="line" data-startTime="2317">but I can look at just the </span><span class="line" data-startTime="2321">quadratics, or I can look at </span><span class="line" data-startTime="2321">just the cubics and make sure </span><span class="line" data-startTime="2324">that my answers are accurate. </span> <span class="line" data-startTime="2326">And as you can see here, there's </span><span class="line" data-startTime="2326">very little visible </span><span class="line" data-startTime="2329">difference between the quadratic </span><span class="line" data-startTime="2329">approximation and </span><span class="line" data-startTime="2331">the actual cubic curve. </span></p>

<p><span class="line" data-startTime="2338">This one is going to show </span><span class="line" data-startTime="2338">the actual data that a </span><span class="line" data-startTime="2342">web page passes me. </span> <span class="line" data-startTime="2344">So this comes off of </span><span class="line" data-startTime="2344">eldorado.com, and it contains </span><span class="line" data-startTime="2349">a parallelogram containing a </span><span class="line" data-startTime="2349">rounded rect that is also a </span><span class="line" data-startTime="2354">parallelogram, and this </span><span class="line" data-startTime="2354">is actual CSS data </span><span class="line" data-startTime="2356">that describes a clip. </span> <span class="line" data-startTime="2359">This particular data is </span><span class="line" data-startTime="2359">deceptive because even though </span><span class="line" data-startTime="2363">those lines look like they touch </span><span class="line" data-startTime="2363">each other, they don't. </span> <span class="line" data-startTime="2366">They're actually very close but </span><span class="line" data-startTime="2366">not the same, and makes </span><span class="line" data-startTime="2369">the math hard to figure out. </span> <span class="line" data-startTime="2372">And here are some other examples </span><span class="line" data-startTime="2372">of actual web pages </span><span class="line" data-startTime="2376">and the clips that they produce </span><span class="line" data-startTime="2376">that drive me crazy. </span></p>

<p><span class="line" data-startTime="2384">For any of these, I can show the </span><span class="line" data-startTime="2384">data that's generated, and </span><span class="line" data-startTime="2389">then I can also show </span><span class="line" data-startTime="2389">the printfs that </span><span class="line" data-startTime="2391">generated that data. </span> <span class="line" data-startTime="2393">And by advancing through the </span><span class="line" data-startTime="2393">data visually and advancing </span><span class="line" data-startTime="2397">through the text, I can then go </span><span class="line" data-startTime="2397">back to my C code and set </span><span class="line" data-startTime="2400">break points and figure out </span><span class="line" data-startTime="2400">where things went wrong. </span> <span class="line" data-startTime="2404">This has been a very helpful </span><span class="line" data-startTime="2404">tool for me. </span> <span class="line" data-startTime="2411">So now I'd like to show </span><span class="line" data-startTime="2411">you a quick demo </span><span class="line" data-startTime="2414">of path ops in action. </span> <span class="line" data-startTime="2420">So here we are running some of </span><span class="line" data-startTime="2420">the unit tests that I've </span><span class="line" data-startTime="2423">written for path ops. </span> <span class="line" data-startTime="2425">At this point I have around 73 </span><span class="line" data-startTime="2425">million tests, and we're </span><span class="line" data-startTime="2428">seeing a few of them here. </span></p>

<p><span class="line" data-startTime="2431">Each of these tests is drawing </span><span class="line" data-startTime="2431">the path ops and </span><span class="line" data-startTime="2433">computing the result. </span> <span class="line" data-startTime="2435">It's also using Skia to create </span><span class="line" data-startTime="2435">a region with the original </span><span class="line" data-startTime="2440">shapes and the result. </span> <span class="line" data-startTime="2442">Then I compare the bits drawn </span><span class="line" data-startTime="2442">by my path ops and the bits </span><span class="line" data-startTime="2446">drawn by the region and make </span><span class="line" data-startTime="2446">sure there's not any </span><span class="line" data-startTime="2450">conservable amount of error </span><span class="line" data-startTime="2450">between the two. </span> <span class="line" data-startTime="2454">This is part of the Skia Unit </span><span class="line" data-startTime="2454">Test Suite, and this is run </span><span class="line" data-startTime="2456">every time Skia is built on </span><span class="line" data-startTime="2456">all platforms, including </span><span class="line" data-startTime="2460">Android, Chrome OS, Mac, </span><span class="line" data-startTime="2460">Windows, and Linux in 32-bit </span><span class="line" data-startTime="2464">and 64-bit. </span> <span class="line" data-startTime="2467">So I've made sure that this </span><span class="line" data-startTime="2467">code is robust and works </span><span class="line" data-startTime="2469">across a lot of different </span><span class="line" data-startTime="2469">platforms. </span></p>

<p><span class="line" data-startTime="2474">So that's it for the </span><span class="line" data-startTime="2474">presentation. </span> <span class="line" data-startTime="2476">I hope you enjoyed it. </span> <span class="line" data-startTime="2477">Please write me if you </span><span class="line" data-startTime="2477">have any questions. </span> <span class="line" data-startTime="2479">Thank you. </span> <span class="line" data-startTime="2491">[MUSIC PLAYING] </span></p></div>