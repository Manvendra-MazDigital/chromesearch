<p class="speaker"><span class="line" data-starttime="1"><span class="speakerName">Ager</span>: So my name </span><span class="line" data-startTime="1">is Mads Ager. </span> <span class="line" data-startTime="3">I'm a software engineer </span><span class="line" data-startTime="3">at Google. </span> <span class="line" data-startTime="5">And I work </span><span class="line" data-startTime="5">on the V8 JavaScript engine. </span> <span class="line" data-startTime="8">And this talk is going </span><span class="line" data-startTime="8">to be about the internals of V8. </span> <span class="line" data-startTime="12">So what did we do, </span><span class="line" data-startTime="12">uh, to make V8 fast </span><span class="line" data-startTime="16">and what were our design, </span><span class="line" data-startTime="16">uh, decisions when making V8? </span><span class="line" data-startTime="20">So here's the agenda </span><span class="line" data-startTime="20">of the talk. </span> <span class="line" data-startTime="22">So the main part of the talk </span><span class="line" data-startTime="22">will be about the design goals </span><span class="line" data-startTime="26">and the overall goals </span><span class="line" data-startTime="26">that we had for V8. </span> <span class="line" data-startTime="30">And, um, the internals. </span></p>

<p><span class="line" data-startTime="32">So what did we actually do? </span><span class="line" data-startTime="34">Uh, what are the techniques </span><span class="line" data-startTime="34">that we used to make V8 fast? </span><span class="line" data-startTime="40">Um, and that involves </span><span class="line" data-startTime="40">things like hidden classes, </span><span class="line" data-startTime="44">uh, native code generation </span><span class="line" data-startTime="44">using inline caching, </span><span class="line" data-startTime="48">and precise generational </span><span class="line" data-startTime="48">garbage collection. </span> <span class="line" data-startTime="50">So that'll be the main part </span><span class="line" data-startTime="50">of the talk </span><span class="line" data-startTime="52">where I explain </span><span class="line" data-startTime="52">these &mdash; these things. </span> <span class="line" data-startTime="55">So, um, after that, </span><span class="line" data-startTime="55">I'll tell you something </span><span class="line" data-startTime="57">about a couple of recent </span><span class="line" data-startTime="57">developments in V8. </span> <span class="line" data-startTime="60">So the first one </span><span class="line" data-startTime="60">is that we implemented </span><span class="line" data-startTime="62">a new JavaScript regular </span><span class="line" data-startTime="62">expression engine </span><span class="line" data-startTime="64">completely from scratch. </span> <span class="line" data-startTime="65">And the other one </span><span class="line" data-startTime="65">is that we've built </span><span class="line" data-startTime="67">a new compile </span><span class="line" data-startTime="67">infrastructure. </span> <span class="line" data-startTime="68">I'm just going </span><span class="line" data-startTime="68">to briefly mention those </span><span class="line" data-startTime="70">and tell you a bit </span><span class="line" data-startTime="70">about them. </span> <span class="line" data-startTime="71">Um, and then I'll go </span><span class="line" data-startTime="71">into something </span><span class="line" data-startTime="73">that, um, I think </span><span class="line" data-startTime="73">is really important. </span> <span class="line" data-startTime="76">Uh, and I've called it </span><span class="line" data-startTime="76">object heap scalability here. </span></p>

<p><span class="line" data-startTime="79">Or JavaScript scalability. </span> <span class="line" data-startTime="81">And that's all about how well </span><span class="line" data-startTime="81">your JavaScript engine deals </span><span class="line" data-startTime="84">with running really, </span><span class="line" data-startTime="84">really big web applications </span><span class="line" data-startTime="87">where you have </span><span class="line" data-startTime="87">a lot of objects. </span> <span class="line" data-startTime="89">Uh, and therefore, </span><span class="line" data-startTime="89">extra pressure </span><span class="line" data-startTime="91">on your memory management </span><span class="line" data-startTime="91">system. </span> <span class="line" data-startTime="93">Um, and I think that </span><span class="line" data-startTime="93">this is really important. </span> <span class="line" data-startTime="95">And I think that it has been </span><span class="line" data-startTime="95">underemphasized so far. </span> <span class="line" data-startTime="98">Um, so I'm going to spend </span><span class="line" data-startTime="98">a bit of time </span><span class="line" data-startTime="101">talking about that. </span> <span class="line" data-startTime="102">And then at the end, </span><span class="line" data-startTime="102">I'm going to just, </span><span class="line" data-startTime="104">uh, tell you a bit about some </span><span class="line" data-startTime="104">of the performance bottlenecks </span><span class="line" data-startTime="108">that we have in V8 right now, </span><span class="line" data-startTime="108">uh, which will give you </span><span class="line" data-startTime="111">sort of an indication </span><span class="line" data-startTime="111">of the kind of things </span><span class="line" data-startTime="113">that we like to, uh, </span><span class="line" data-startTime="113">to work on in V8 </span><span class="line" data-startTime="116">to make it even faster. </span> <span class="line" data-startTime="120">Okay, so for this talk, </span><span class="line" data-startTime="121">the first question is really </span><span class="line" data-startTime="121">why did Google want </span><span class="line" data-startTime="124">to build a new JavaScript </span><span class="line" data-startTime="124">engine? </span><span class="line" data-startTime="128">And the answer </span><span class="line" data-startTime="128">is pretty simple. </span></p>

<p><span class="line" data-startTime="130">So we believe that </span><span class="line" data-startTime="132">in order </span><span class="line" data-startTime="132">to build, uh, the next wave </span><span class="line" data-startTime="135">of big, </span><span class="line" data-startTime="135">uh, web applications, </span><span class="line" data-startTime="138">you need better JavaScript </span><span class="line" data-startTime="138">performance. </span> <span class="line" data-startTime="141">Um, and at the time </span><span class="line" data-startTime="141">when the V8 project started, </span><span class="line" data-startTime="144">the existing </span><span class="line" data-startTime="144">JavaScript engines </span><span class="line" data-startTime="146">were not very fast. </span> <span class="line" data-startTime="148">So basically </span><span class="line" data-startTime="148">they were all interpreters </span><span class="line" data-startTime="151">working on abstract syntax trees </span><span class="line" data-startTime="151">or on bytecodes. </span> <span class="line" data-startTime="154">And they had, uh, poor memory </span><span class="line" data-startTime="154">management systems, </span><span class="line" data-startTime="158">which led </span><span class="line" data-startTime="158">to big pause times, </span><span class="line" data-startTime="161">um, and maybe even, </span><span class="line" data-startTime="161">uh, memory leaks. </span></p>

<p><span class="line" data-startTime="164">Um, so we wanted </span><span class="line" data-startTime="164">to try to change this picture. </span> <span class="line" data-startTime="167">We wanted to try to push, </span><span class="line" data-startTime="167">uh, JavaScript performance. </span> <span class="line" data-startTime="172">Uh, and we thought that </span><span class="line" data-startTime="172">the best way to do that </span><span class="line" data-startTime="173">was to build a completely </span><span class="line" data-startTime="173">new JavaScript engine </span><span class="line" data-startTime="175">from scratch so that we could do </span><span class="line" data-startTime="175">our own designs </span><span class="line" data-startTime="178">and start completely </span><span class="line" data-startTime="178">from scratch. </span> <span class="line" data-startTime="181">Um, so the overall goal </span><span class="line" data-startTime="181">for V8 </span><span class="line" data-startTime="185">is to push the performance bar </span><span class="line" data-startTime="185">for JavaScript. </span> <span class="line" data-startTime="187">Not only for Google Chrome </span><span class="line" data-startTime="187">and for V8, </span><span class="line" data-startTime="190">but we wanted to kind of try </span><span class="line" data-startTime="190">to push the industry </span><span class="line" data-startTime="193">and see if we can get, uh, </span><span class="line" data-startTime="193">better JavaScript performance </span><span class="line" data-startTime="196">in browsers in general, </span><span class="line" data-startTime="197">which will benefit </span><span class="line" data-startTime="197">all of us. </span></p>

<p><span class="line" data-startTime="199">It'll benefit Google </span><span class="line" data-startTime="199">because we can do better </span><span class="line" data-startTime="201">web applications. </span> <span class="line" data-startTime="202">And it'll benefit </span><span class="line" data-startTime="202">the users as well </span><span class="line" data-startTime="203">because, well, users like </span><span class="line" data-startTime="203">web applications as well. </span> <span class="line" data-startTime="210">So we wanted to build </span><span class="line" data-startTime="210">a really fast JavaScript engine. </span> <span class="line" data-startTime="214">So why is that a challenge? </span><span class="line" data-startTime="217">Well, JavaScript is a very, </span><span class="line" data-startTime="217">very dynamic language. </span> <span class="line" data-startTime="221">So objects are basically </span><span class="line" data-startTime="221">just HashMaps. </span> <span class="line" data-startTime="224">So you can add and remove </span><span class="line" data-startTime="224">properties, </span><span class="line" data-startTime="227">um, to and from objects </span><span class="line" data-startTime="227">on the fly </span><span class="line" data-startTime="231">in any order you like. </span> <span class="line" data-startTime="232">And you have, </span><span class="line" data-startTime="232">uh, no type structure. </span></p>

<p><span class="line" data-startTime="235">So if you want to do, </span><span class="line" data-startTime="235">uh, a property lookup </span><span class="line" data-startTime="238">on an object in JavaScript, </span><span class="line" data-startTime="240">you don't know anything </span><span class="line" data-startTime="240">statically about the object. </span> <span class="line" data-startTime="243">So if you have an object, </span><span class="line" data-startTime="244">you want to search </span><span class="line" data-startTime="244">for the X-property, </span><span class="line" data-startTime="246">you have to do exactly that. </span> <span class="line" data-startTime="247">You have to search. </span> <span class="line" data-startTime="248">So you have to look </span><span class="line" data-startTime="248">in your HashMap. </span> <span class="line" data-startTime="250">If it's not there, </span><span class="line" data-startTime="251">you need to traverse </span><span class="line" data-startTime="251">the prototype chain </span><span class="line" data-startTime="253">and look for it there. </span> <span class="line" data-startTime="254">And that's, like, </span><span class="line" data-startTime="254">really slow. </span> <span class="line" data-startTime="256">So if you compare that </span><span class="line" data-startTime="256">to static, </span><span class="line" data-startTime="257">object-oriented languages </span><span class="line" data-startTime="259">where you have a notion of type, </span><span class="line" data-startTime="259">where you have classes, </span><span class="line" data-startTime="263">if you do a property load </span><span class="line" data-startTime="263">in a language </span><span class="line" data-startTime="265">where you have a notion </span><span class="line" data-startTime="265">of class, </span><span class="line" data-startTime="268">well, then the class tells you </span><span class="line" data-startTime="268">the layout of your object. </span></p>

<p><span class="line" data-startTime="271">So if you want to access </span><span class="line" data-startTime="271">an X-property </span><span class="line" data-startTime="274">on an object </span><span class="line" data-startTime="274">that has a certain class, </span><span class="line" data-startTime="276">then the class tells you </span><span class="line" data-startTime="276">the index </span><span class="line" data-startTime="278">in your object </span><span class="line" data-startTime="278">for that property. </span> <span class="line" data-startTime="280">So you can generate </span><span class="line" data-startTime="280">just a few assembly line &mdash; </span><span class="line" data-startTime="282">assembly instructions </span><span class="line" data-startTime="282">that will load your property. </span> <span class="line" data-startTime="287">In JavaScript, if you just </span><span class="line" data-startTime="287">do it, uh, like naively &mdash; </span><span class="line" data-startTime="291">implement JavaScript &mdash; </span><span class="line" data-startTime="291">then you'll have a full search </span><span class="line" data-startTime="294">of &mdash; of a number </span><span class="line" data-startTime="294">of HashMaps in a chain. </span> <span class="line" data-startTime="297">And that's really slow. </span></p>

<p><span class="line" data-startTime="299">Um, right, so JavaScript </span><span class="line" data-startTime="299">is highly dynamic. </span> <span class="line" data-startTime="303">You can add properties </span><span class="line" data-startTime="303">to objects. </span> <span class="line" data-startTime="306">You can remove properties </span><span class="line" data-startTime="306">from objects. </span> <span class="line" data-startTime="308">Um, and, uh, </span><span class="line" data-startTime="308">you can actually change </span><span class="line" data-startTime="311">prototype chains </span><span class="line" data-startTime="311">as well dynamically. </span> <span class="line" data-startTime="315">So you can change basically </span><span class="line" data-startTime="315">everything, </span><span class="line" data-startTime="317">uh, in your program </span><span class="line" data-startTime="317">on the fly. </span> <span class="line" data-startTime="319">Also, JavaScript has a couple </span><span class="line" data-startTime="319">of language features, </span><span class="line" data-startTime="322">um, that &mdash; that could </span><span class="line" data-startTime="322">give you trouble as well. </span> <span class="line" data-startTime="327">So one of them is eval. </span> <span class="line" data-startTime="329">So eval is a function </span><span class="line" data-startTime="329">that you can call with a string </span><span class="line" data-startTime="333">to evaluate that string </span><span class="line" data-startTime="333">as JavaScript code. </span> <span class="line" data-startTime="337">And that's actually </span><span class="line" data-startTime="337">not so bad. </span> <span class="line" data-startTime="338">The problem with it is that </span><span class="line" data-startTime="338">it can also change </span><span class="line" data-startTime="341">the calling context. </span> <span class="line" data-startTime="343">And that means that, </span><span class="line" data-startTime="343">um, if you're trying </span><span class="line" data-startTime="346">to implement JavaScript, </span><span class="line" data-startTime="348">you really want to have </span><span class="line" data-startTime="348">some scope information. </span></p>

<p><span class="line" data-startTime="350">So if you look for &mdash; </span><span class="line" data-startTime="352">if you access </span><span class="line" data-startTime="352">a property X somewhere, </span><span class="line" data-startTime="354">you want to be able to &mdash; to see </span><span class="line" data-startTime="354">basically in your scopes </span><span class="line" data-startTime="357">where is X declared? </span><span class="line" data-startTime="359">But if you have a call to eval, </span><span class="line" data-startTime="359">basically, you don't know </span><span class="line" data-startTime="361">because eval can introduce </span><span class="line" data-startTime="361">new bindings dynamically. </span> <span class="line" data-startTime="364">So you could introduce </span><span class="line" data-startTime="364">a new X variable </span><span class="line" data-startTime="366">in, uh, the context </span><span class="line" data-startTime="366">where you're calling eval. </span> <span class="line" data-startTime="369">So basically, you just have </span><span class="line" data-startTime="369">to give up </span><span class="line" data-startTime="371">and say, statically, </span><span class="line" data-startTime="371">I don't know. </span></p>

<p><span class="line" data-startTime="373">Um, and there's similar issues </span><span class="line" data-startTime="373">with, uh, "with" statements </span><span class="line" data-startTime="377">in JavaScript. </span> <span class="line" data-startTime="378">So "with" statements are used </span><span class="line" data-startTime="378">to introduce a new object </span><span class="line" data-startTime="381">in your scope chain. </span> <span class="line" data-startTime="382">So if you want easy access </span><span class="line" data-startTime="382">to all the properties </span><span class="line" data-startTime="385">on the document object, </span><span class="line" data-startTime="386">you can say with document </span><span class="line" data-startTime="386">and then have a blog of code, </span><span class="line" data-startTime="390">where if you just write a name </span><span class="line" data-startTime="390">like "write" </span><span class="line" data-startTime="394">that will be looked up </span><span class="line" data-startTime="394">in the document object </span><span class="line" data-startTime="397">so that will actually be </span><span class="line" data-startTime="397">document.write. </span> <span class="line" data-startTime="400">And that's all fine. </span> <span class="line" data-startTime="401">But if you want to, uh, </span><span class="line" data-startTime="401">have scope information again, </span><span class="line" data-startTime="406">you have to give up </span><span class="line" data-startTime="406">inside of a "with" statement </span><span class="line" data-startTime="408">because you don't know. </span> <span class="line" data-startTime="410">Because it might look </span><span class="line" data-startTime="410">like a variable is declared </span><span class="line" data-startTime="412">and out of scope, </span><span class="line" data-startTime="413">but, uh, dynamically, </span><span class="line" data-startTime="413">you might introduce an object </span><span class="line" data-startTime="416">with your "with" statement </span><span class="line" data-startTime="418">that has that property name </span><span class="line" data-startTime="418">as well. </span></p>

<p><span class="line" data-startTime="420">And that's the one </span><span class="line" data-startTime="420">that you need to get. </span> <span class="line" data-startTime="421">So overall, </span><span class="line" data-startTime="421">JavaScript is very dynamic. </span> <span class="line" data-startTime="424">Um, and that makes it a bit </span><span class="line" data-startTime="424">of a challenge </span><span class="line" data-startTime="427">to implement it efficiently. </span> <span class="line" data-startTime="430">So let's talk </span><span class="line" data-startTime="430">about what we did for V8 </span><span class="line" data-startTime="433">and which design decisions </span><span class="line" data-startTime="433">we took. </span> <span class="line" data-startTime="436">So the goal for V8 was to create </span><span class="line" data-startTime="436">a JavaScript engine </span><span class="line" data-startTime="441">that would make, um, large </span><span class="line" data-startTime="441">object-oriented applications </span><span class="line" data-startTime="446">perform well. </span></p>

<p><span class="line" data-startTime="447">So if you have large </span><span class="line" data-startTime="447">object-oriented applications, </span><span class="line" data-startTime="449">you're going to use </span><span class="line" data-startTime="449">abstractions. </span> <span class="line" data-startTime="451">And if you use abstractions, </span><span class="line" data-startTime="453">you're going to have a lot </span><span class="line" data-startTime="453">of property accesses </span><span class="line" data-startTime="454">and you're going to have </span><span class="line" data-startTime="454">a lot of &mdash; of function calls. </span> <span class="line" data-startTime="457">And you're going to have </span><span class="line" data-startTime="457">a lot of objects. </span> <span class="line" data-startTime="460">So that means </span><span class="line" data-startTime="460">that in order to make </span><span class="line" data-startTime="462">these kind of applications </span><span class="line" data-startTime="462">run fast, </span><span class="line" data-startTime="464">you need fast property </span><span class="line" data-startTime="464">access, </span><span class="line" data-startTime="465">you need fast property </span><span class="line" data-startTime="465">calls, </span><span class="line" data-startTime="467">and you need fast and scalable </span><span class="line" data-startTime="467">memory management. </span> <span class="line" data-startTime="470">So you want to be able to handle </span><span class="line" data-startTime="470">a large number of objects, </span><span class="line" data-startTime="473">um, efficiently. </span></p>

<p><span class="line" data-startTime="478">So these goals led </span><span class="line" data-startTime="478">to three key components of V8. </span> <span class="line" data-startTime="482">So the first component </span><span class="line" data-startTime="484">is something called </span><span class="line" data-startTime="484">hidden classes </span><span class="line" data-startTime="486">and hidden class </span><span class="line" data-startTime="486">transitions. </span> <span class="line" data-startTime="488">Um, so hidden classes </span><span class="line" data-startTime="489">is basically our notion </span><span class="line" data-startTime="489">of types. </span> <span class="line" data-startTime="493">Um, so JavaScript does not have </span><span class="line" data-startTime="493">any types. </span> <span class="line" data-startTime="496">And we're not adding types </span><span class="line" data-startTime="496">to JavaScript </span><span class="line" data-startTime="497">or anything like that. </span> <span class="line" data-startTime="498">But internally </span><span class="line" data-startTime="498">in the JavaScript engine, </span><span class="line" data-startTime="500">we have a notion of type </span><span class="line" data-startTime="500">and that's our hidden class. </span> <span class="line" data-startTime="503">And I'll &mdash; I'll tell you more </span><span class="line" data-startTime="503">about that. </span> <span class="line" data-startTime="505">So once we have that, we &mdash; </span><span class="line" data-startTime="505">we, uh, we can use a technique </span><span class="line" data-startTime="508">called inline caching. </span> <span class="line" data-startTime="510">Um, so we generate native code </span><span class="line" data-startTime="510">for all of our JavaScript. </span> <span class="line" data-startTime="513">And we also generate code </span><span class="line" data-startTime="513">on the fly </span><span class="line" data-startTime="515">and use a technique </span><span class="line" data-startTime="515">called inline caching. </span> <span class="line" data-startTime="518">So these two things together, </span><span class="line" data-startTime="518">hidden classes </span><span class="line" data-startTime="520">and native code generation </span><span class="line" data-startTime="520">with inline caching, </span><span class="line" data-startTime="523">gives us fast property access </span><span class="line" data-startTime="523">and fast function calls. </span> <span class="line" data-startTime="526">So those are the two </span><span class="line" data-startTime="526">first items. </span> <span class="line" data-startTime="528">Um, so the second thing </span><span class="line" data-startTime="528">that we wanted </span><span class="line" data-startTime="530">was, uh, a fast memory </span><span class="line" data-startTime="530">management system. </span></p>

<p><span class="line" data-startTime="534">Um, so we use, </span><span class="line" data-startTime="535">uh, a generational garbage </span><span class="line" data-startTime="535">collector. </span> <span class="line" data-startTime="537">And it's pretty much standard, </span><span class="line" data-startTime="537">but it works really well. </span> <span class="line" data-startTime="540">Um, and that means that, </span><span class="line" data-startTime="542">uh, having a generational </span><span class="line" data-startTime="542">garbage collector, </span><span class="line" data-startTime="546">we scale well to dealing </span><span class="line" data-startTime="546">with a lot of objects. </span> <span class="line" data-startTime="549">And I'll tell you some more </span><span class="line" data-startTime="549">about that as well. </span> <span class="line" data-startTime="553">Okay, so let's, uh, </span><span class="line" data-startTime="553">let's dig in. </span> <span class="line" data-startTime="557">So to set the scene, </span><span class="line" data-startTime="557">let me start </span><span class="line" data-startTime="558">by telling you a bit </span><span class="line" data-startTime="558">about V8's memory model. </span> <span class="line" data-startTime="562">Um, so in V8, we use, </span><span class="line" data-startTime="562">uh, 32-bit tagged pointers. </span> <span class="line" data-startTime="566">Um, all of our objects </span><span class="line" data-startTime="566">in our heap </span><span class="line" data-startTime="569">are, uh, 4-byte aligned. </span> <span class="line" data-startTime="572">And that means </span><span class="line" data-startTime="572">that if you have a pointer </span><span class="line" data-startTime="574">to a JavaScript object, uh, </span><span class="line" data-startTime="574">the two least significant bits </span><span class="line" data-startTime="577">are going to be zero. </span></p>

<p><span class="line" data-startTime="579">So we can use that knowledge </span><span class="line" data-startTime="579">to actually, </span><span class="line" data-startTime="581">um, do pointer tagging. </span> <span class="line" data-startTime="583">Since we know that all pointers </span><span class="line" data-startTime="583">should have </span><span class="line" data-startTime="585">the two least significant bits, </span><span class="line" data-startTime="585">zero, </span><span class="line" data-startTime="587">we can actually put in </span><span class="line" data-startTime="587">ones there, </span><span class="line" data-startTime="590">uh, to &mdash; to give </span><span class="line" data-startTime="590">some extra information </span><span class="line" data-startTime="593">to our pointers. </span> <span class="line" data-startTime="594">And then we just make sure </span><span class="line" data-startTime="594">to strip them </span><span class="line" data-startTime="595">if we actually need </span><span class="line" data-startTime="595">the actual pointer. </span> <span class="line" data-startTime="598">Um, so what we use that for </span><span class="line" data-startTime="598">is allowing 32 &mdash; </span><span class="line" data-startTime="601">sor &mdash; sorry &mdash; </span><span class="line" data-startTime="601">31-bit signed integers </span><span class="line" data-startTime="604">to be immediate values. </span> <span class="line" data-startTime="605">And they're distinguished </span><span class="line" data-startTime="605">from real pointers by tagging. </span></p>

<p><span class="line" data-startTime="609">So if you'll, uh, load a pointer </span><span class="line" data-startTime="609">to a JavaScript object </span><span class="line" data-startTime="611">from a heap and the address </span><span class="line" data-startTime="611">is even &mdash; </span><span class="line" data-startTime="615">it's actually not a pointer. </span> <span class="line" data-startTime="617">It's an immediate </span><span class="line" data-startTime="617">integer value. </span> <span class="line" data-startTime="618">And you get the integer value </span><span class="line" data-startTime="618">by just shifting, </span><span class="line" data-startTime="621">uh, one bit right. </span> <span class="line" data-startTime="623">So basically shifting </span><span class="line" data-startTime="623">the zero away. </span> <span class="line" data-startTime="625">And that's going to be </span><span class="line" data-startTime="625">you're, uh, integer value. </span> <span class="line" data-startTime="628">So that means </span><span class="line" data-startTime="628">that we can have efficient, </span><span class="line" data-startTime="630">um, we can deal with integers </span><span class="line" data-startTime="630">efficiently, </span><span class="line" data-startTime="633">uh, because they're just </span><span class="line" data-startTime="633">immediate values </span><span class="line" data-startTime="634">and we don't have </span><span class="line" data-startTime="634">to do any heap allocation </span><span class="line" data-startTime="636">to handle integers. </span> <span class="line" data-startTime="637">Um, so on the other hand, </span><span class="line" data-startTime="639">if you load, um, a pointer </span><span class="line" data-startTime="639">to an object from our heap </span><span class="line" data-startTime="643">and it's odd, </span><span class="line" data-startTime="644">so it has the least significant </span><span class="line" data-startTime="644">bit of one, </span><span class="line" data-startTime="646">then it is an actual pointer. </span> <span class="line" data-startTime="648">And the pointer to the object </span><span class="line" data-startTime="648">is this value </span><span class="line" data-startTime="652">where you subtract one. </span></p>

<p><span class="line" data-startTime="653">So where you clear the tag. </span> <span class="line" data-startTime="656">Okay, so, um, </span><span class="line" data-startTime="660">our base JavaScript objects </span><span class="line" data-startTime="660">consist of three words. </span> <span class="line" data-startTime="665">The first word </span><span class="line" data-startTime="665">is a hidden class pointer. </span> <span class="line" data-startTime="669">Um, so this is our notion </span><span class="line" data-startTime="669">of type as I told you before. </span> <span class="line" data-startTime="672">And I'll &mdash; I'll get into details </span><span class="line" data-startTime="672">on that in a second. </span> <span class="line" data-startTime="676">Uh, and the two other pointers </span><span class="line" data-startTime="676">are used </span><span class="line" data-startTime="678">to point to where </span><span class="line" data-startTime="678">we actually hold </span><span class="line" data-startTime="680">the values of properties. </span> <span class="line" data-startTime="682">So we split the property's </span><span class="line" data-startTime="682">backing storage </span><span class="line" data-startTime="685">into two parts, </span><span class="line" data-startTime="686">one is for properties </span><span class="line" data-startTime="686">that are named by strings. </span> <span class="line" data-startTime="691">So like X, Y, and Z. </span> <span class="line" data-startTime="694">And the other one </span><span class="line" data-startTime="694">is for what we call "elements," </span><span class="line" data-startTime="696">which are basically properties </span><span class="line" data-startTime="696">which have integer names. </span> <span class="line" data-startTime="699">So 012 and so on. </span> <span class="line" data-startTime="702">Um, so all </span><span class="line" data-startTime="702">of our JavaScript objects </span><span class="line" data-startTime="704">are these three-word </span><span class="line" data-startTime="704">thingies. </span></p>

<p><span class="line" data-startTime="707">Okay, and the backing storage </span><span class="line" data-startTime="707">for properties and for elements </span><span class="line" data-startTime="710">can be in two </span><span class="line" data-startTime="710">different states, </span><span class="line" data-startTime="712">namely a fast case </span><span class="line" data-startTime="712">and a slow case. </span> <span class="line" data-startTime="714">So in the fast case, </span><span class="line" data-startTime="716">uh, a property's backing storage </span><span class="line" data-startTime="716">or an element's backing storage </span><span class="line" data-startTime="719">is just an array, </span><span class="line" data-startTime="720">where we can do </span><span class="line" data-startTime="720">direct indexing. </span> <span class="line" data-startTime="722">And in the slow case, </span><span class="line" data-startTime="722">it's going to be a dictionary </span><span class="line" data-startTime="725">or a HashMap. </span> <span class="line" data-startTime="728">Okay, so now we're ready </span><span class="line" data-startTime="728">to talk about hidden classes. </span> <span class="line" data-startTime="734">So, uh, as I told you, </span><span class="line" data-startTime="736">in static, object-oriented, </span><span class="line" data-startTime="736">uh, languages </span><span class="line" data-startTime="738">where you have classes, </span><span class="line" data-startTime="740">uh, you can do really fast </span><span class="line" data-startTime="740">property access </span><span class="line" data-startTime="744">because the class describes </span><span class="line" data-startTime="744">your object </span><span class="line" data-startTime="746">and you know exactly </span><span class="line" data-startTime="746">where to find the properties </span><span class="line" data-startTime="749">of your object. </span> <span class="line" data-startTime="750">So we wanted to have the same </span><span class="line" data-startTime="750">ability for JavaScript. </span></p>

<p><span class="line" data-startTime="753">We wanted to be able to do, </span><span class="line" data-startTime="753">like, a few, </span><span class="line" data-startTime="755">uh, assembly instructions </span><span class="line" data-startTime="755">to load a property. </span> <span class="line" data-startTime="758">Um, so to use these </span><span class="line" data-startTime="758">normal optimization techniques, </span><span class="line" data-startTime="761">we needed to introduce </span><span class="line" data-startTime="761">a notion of type. </span> <span class="line" data-startTime="764">And for that, we use </span><span class="line" data-startTime="764">hidden classes. </span> <span class="line" data-startTime="766">So hidden classes, </span><span class="line" data-startTime="766">uh, are classes, </span><span class="line" data-startTime="771">but they're only internal </span><span class="line" data-startTime="773">to the &mdash; </span><span class="line" data-startTime="773">to the JavaScript engine. </span> <span class="line" data-startTime="774">So it's something </span><span class="line" data-startTime="774">that we keep track of </span><span class="line" data-startTime="776">and users don't know about. </span> <span class="line" data-startTime="778">Um, and hidden classes </span><span class="line" data-startTime="778">group objects </span><span class="line" data-startTime="781">that have the exact same </span><span class="line" data-startTime="781">structure. </span> <span class="line" data-startTime="786">Okay, so talking </span><span class="line" data-startTime="786">about hidden classes, </span><span class="line" data-startTime="789">it's easiest to just, </span><span class="line" data-startTime="789">uh, have an example. </span></p>

<p><span class="line" data-startTime="793">So, um, in JavaScript, </span><span class="line" data-startTime="793">all objects are created </span><span class="line" data-startTime="797">from &mdash; from, uh, </span><span class="line" data-startTime="797">from functions. </span> <span class="line" data-startTime="800">Um, and here's </span><span class="line" data-startTime="800">a point function, </span><span class="line" data-startTime="802">which is a constructive </span><span class="line" data-startTime="802">function </span><span class="line" data-startTime="803">that we can use </span><span class="line" data-startTime="803">to construct points. </span> <span class="line" data-startTime="805">And it just takes two arguments </span><span class="line" data-startTime="805">and assigns them </span><span class="line" data-startTime="807">to the, uh, X and Y properties </span><span class="line" data-startTime="807">of the resulting object. </span> <span class="line" data-startTime="812">Okay, so the goal here </span><span class="line" data-startTime="812">is that any point </span><span class="line" data-startTime="816">that we construct </span><span class="line" data-startTime="816">should end up having, </span><span class="line" data-startTime="819">uh, the point map, basically, </span><span class="line" data-startTime="821">the point hidden class. </span></p>

<p><span class="line" data-startTime="823">So JavaScript objects created </span><span class="line" data-startTime="823">in the same way </span><span class="line" data-startTime="826">should end up having </span><span class="line" data-startTime="826">the same hidden class </span><span class="line" data-startTime="828">because they'll have </span><span class="line" data-startTime="828">the same internal structure. </span> <span class="line" data-startTime="833">Okay. </span> <span class="line" data-startTime="834">Um, so in this example, </span><span class="line" data-startTime="834">I'm going to create two points. </span> <span class="line" data-startTime="837">I'm going to show you </span><span class="line" data-startTime="837">how they end up </span><span class="line" data-startTime="838">having the same </span><span class="line" data-startTime="838">hidden class. </span> <span class="line" data-startTime="841">So since all JavaScript objects </span><span class="line" data-startTime="841">are created from functions, </span><span class="line" data-startTime="845">we create an initial class </span><span class="line" data-startTime="845">for each function. </span> <span class="line" data-startTime="849">So the point function here </span><span class="line" data-startTime="851">is going to have </span><span class="line" data-startTime="851">an initial class, </span><span class="line" data-startTime="853">which is called class zero, </span><span class="line" data-startTime="854">which I've put up there. </span> <span class="line" data-startTime="855">And this is the class &mdash; </span><span class="line" data-startTime="855">the hidden class &mdash; </span><span class="line" data-startTime="858">that we're going to give, </span><span class="line" data-startTime="858">uh, to all new objects created </span><span class="line" data-startTime="861">from the point function. </span></p>

<p><span class="line" data-startTime="863">So when we, uh, create </span><span class="line" data-startTime="863">our first point here, p1, </span><span class="line" data-startTime="868">that's this three-word thing </span><span class="line" data-startTime="870">that has a pointer </span><span class="line" data-startTime="870">to hidden class. </span> <span class="line" data-startTime="873">And since this object </span><span class="line" data-startTime="873">was created </span><span class="line" data-startTime="875">using the point function, </span><span class="line" data-startTime="877">it's initial class is going </span><span class="line" data-startTime="877">to be the initial class </span><span class="line" data-startTime="880">of the point function, </span><span class="line" data-startTime="880">class zero. </span> <span class="line" data-startTime="882">And then it has properties </span><span class="line" data-startTime="882">and elements as well. </span> <span class="line" data-startTime="884">And in the beginning, </span><span class="line" data-startTime="884">we're going to allocate </span><span class="line" data-startTime="886">a small piece of &mdash; </span><span class="line" data-startTime="886">of backing storage </span><span class="line" data-startTime="888">both for properties </span><span class="line" data-startTime="888">and for elements. </span> <span class="line" data-startTime="891">Um, so that's &mdash; </span><span class="line" data-startTime="891">that's the initial thing </span><span class="line" data-startTime="893">that you get </span><span class="line" data-startTime="893">when you say a new point. </span> <span class="line" data-startTime="895">And then we're going </span><span class="line" data-startTime="895">to start executing the body </span><span class="line" data-startTime="897">of the point function </span><span class="line" data-startTime="897">with this newly allocated object </span><span class="line" data-startTime="901">as the &mdash; this pointer. </span></p>

<p><span class="line" data-startTime="905">Okay, so the first thing </span><span class="line" data-startTime="905">that we're going to do </span><span class="line" data-startTime="907">is add an X-property </span><span class="line" data-startTime="907">to this object. </span> <span class="line" data-startTime="909">So adding a property </span><span class="line" data-startTime="909">to an object </span><span class="line" data-startTime="911">changes the structure </span><span class="line" data-startTime="911">of the object, </span><span class="line" data-startTime="913">which means that we need </span><span class="line" data-startTime="913">to change the hidden class </span><span class="line" data-startTime="915">of the object. </span> <span class="line" data-startTime="917">So when we assign X </span><span class="line" data-startTime="917">to this property, </span><span class="line" data-startTime="921">we need to create </span><span class="line" data-startTime="921">a new class. </span> <span class="line" data-startTime="923">And we do that by copying </span><span class="line" data-startTime="923">the original class, </span><span class="line" data-startTime="926">which is class zero, </span><span class="line" data-startTime="927">and then adding the knowledge </span><span class="line" data-startTime="927">to that class </span><span class="line" data-startTime="929">that we have an X-property. </span> <span class="line" data-startTime="931">and that &mdash; that property </span><span class="line" data-startTime="931">is at offset zero </span><span class="line" data-startTime="934">in our backing storage. </span></p>

<p><span class="line" data-startTime="935">And then we're going </span><span class="line" data-startTime="935">to put the value </span><span class="line" data-startTime="937">into the backing storage </span><span class="line" data-startTime="937">at offset zero. </span> <span class="line" data-startTime="940">And importantly, </span><span class="line" data-startTime="940">we're going to remember </span><span class="line" data-startTime="942">in class zero </span><span class="line" data-startTime="945">that if you have an object </span><span class="line" data-startTime="945">that has class zero </span><span class="line" data-startTime="948">and you add a property </span><span class="line" data-startTime="948">with the name X, </span><span class="line" data-startTime="951">then you need to transition </span><span class="line" data-startTime="951">to class one. </span> <span class="line" data-startTime="953">So that's what we call </span><span class="line" data-startTime="953">a hidden class transition. </span> <span class="line" data-startTime="957">Another similar thing happens </span><span class="line" data-startTime="957">when we add the Y-property. </span> <span class="line" data-startTime="961">So adding a new property </span><span class="line" data-startTime="961">to an object </span><span class="line" data-startTime="963">changes its structure. </span> <span class="line" data-startTime="964">And therefore it needs </span><span class="line" data-startTime="964">to change its hidden class. </span> <span class="line" data-startTime="968">So we create </span><span class="line" data-startTime="968">a new hidden class </span><span class="line" data-startTime="970">by copying class one. </span> <span class="line" data-startTime="972">We add the knowledge </span><span class="line" data-startTime="972">that we have a Y-property </span><span class="line" data-startTime="975">and that the value </span><span class="line" data-startTime="975">of the Y-property </span><span class="line" data-startTime="977">is at offset one </span><span class="line" data-startTime="977">in our backing storage. </span> <span class="line" data-startTime="979">We fill in value. </span></p>

<p><span class="line" data-startTime="981">And we, uh, update </span><span class="line" data-startTime="981">the hidden class pointer </span><span class="line" data-startTime="983">to point </span><span class="line" data-startTime="983">to this new class. </span> <span class="line" data-startTime="985">And again, we remember </span><span class="line" data-startTime="985">in class one </span><span class="line" data-startTime="987">that if you have an object </span><span class="line" data-startTime="987">that has class one </span><span class="line" data-startTime="990">and you add a Y-property </span><span class="line" data-startTime="990">to it, </span><span class="line" data-startTime="992">then you need to transition </span><span class="line" data-startTime="992">to class two. </span> <span class="line" data-startTime="995">Okay, so that finishes </span><span class="line" data-startTime="995">the construction </span><span class="line" data-startTime="998">of our first point. </span> <span class="line" data-startTime="999">So you see this is actually </span><span class="line" data-startTime="999">a pretty heavy weight </span><span class="line" data-startTime="1002">to construct the first object </span><span class="line" data-startTime="1002">from a constructive function </span><span class="line" data-startTime="1005">because we need to create </span><span class="line" data-startTime="1005">all of these new classes </span><span class="line" data-startTime="1008">by copying existing ones </span><span class="line" data-startTime="1008">and adding a bit of information. </span> <span class="line" data-startTime="1012">Um, but that only costs </span><span class="line" data-startTime="1012">on the first construction. </span></p>

<p><span class="line" data-startTime="1015">So on the next construction, </span><span class="line" data-startTime="1017">um, we're basically going </span><span class="line" data-startTime="1017">to do the same thing, </span><span class="line" data-startTime="1019">but we're going </span><span class="line" data-startTime="1019">to reuse our classes. </span> <span class="line" data-startTime="1022">So if we go to the construction </span><span class="line" data-startTime="1022">of, uh, of p2, </span><span class="line" data-startTime="1026">that will create </span><span class="line" data-startTime="1026">a new object, </span><span class="line" data-startTime="1028">which is this </span><span class="line" data-startTime="1028">three-way thing. </span> <span class="line" data-startTime="1030">The initial class </span><span class="line" data-startTime="1030">is going to be the class </span><span class="line" data-startTime="1033">associated </span><span class="line" data-startTime="1033">with the point function, </span><span class="line" data-startTime="1035">which is going to be c0. </span></p>

<p><span class="line" data-startTime="1037">Class zero. </span> <span class="line" data-startTime="1039">And then we're going </span><span class="line" data-startTime="1039">to execute the body </span><span class="line" data-startTime="1040">of the point function. </span> <span class="line" data-startTime="1042">So the first thing </span><span class="line" data-startTime="1042">we're going to do </span><span class="line" data-startTime="1043">is assign, um, is to add </span><span class="line" data-startTime="1043">an X-property to our object. </span> <span class="line" data-startTime="1048">So now this point </span><span class="line" data-startTime="1048">has class zero. </span> <span class="line" data-startTime="1052">And in class zero, </span><span class="line" data-startTime="1052">there's information </span><span class="line" data-startTime="1054">that if you have an object </span><span class="line" data-startTime="1054">that has class zero, </span><span class="line" data-startTime="1057">and you add a property </span><span class="line" data-startTime="1057">called X, </span><span class="line" data-startTime="1059">well, then you need </span><span class="line" data-startTime="1059">to transition to class one. </span> <span class="line" data-startTime="1061">So that's what we're going </span><span class="line" data-startTime="1061">to do. </span> <span class="line" data-startTime="1063">So for the assignment to X, </span><span class="line" data-startTime="1066">we're just going to update </span><span class="line" data-startTime="1066">the hidden class pointer </span><span class="line" data-startTime="1068">and put the value </span><span class="line" data-startTime="1068">in the backing storage. </span> <span class="line" data-startTime="1070">And similarly for Y, </span><span class="line" data-startTime="1072">we now have an object </span><span class="line" data-startTime="1072">of class one. </span></p>

<p><span class="line" data-startTime="1074">In class one, we know </span><span class="line" data-startTime="1074">that if you add a Y property, </span><span class="line" data-startTime="1077">you need to transition </span><span class="line" data-startTime="1077">to class two. </span> <span class="line" data-startTime="1079">So that's all we're going </span><span class="line" data-startTime="1079">to do. </span> <span class="line" data-startTime="1080">We're just going to update </span><span class="line" data-startTime="1080">the hidden class pointer </span><span class="line" data-startTime="1082">and, uh, add the value </span><span class="line" data-startTime="1082">to the backing storage. </span> <span class="line" data-startTime="1087">So now we've created </span><span class="line" data-startTime="1087">two point objects. </span> <span class="line" data-startTime="1090">They've been created </span><span class="line" data-startTime="1090">in exactly the same way. </span> <span class="line" data-startTime="1093">And they end up sharing </span><span class="line" data-startTime="1093">the hidden class, class two. </span> <span class="line" data-startTime="1097">And the important thing here </span><span class="line" data-startTime="1097">is that in class two, </span><span class="line" data-startTime="1100">we have a complete description </span><span class="line" data-startTime="1100">of our objects. </span></p>

<p><span class="line" data-startTime="1103">We know that all objects </span><span class="line" data-startTime="1103">that have class two </span><span class="line" data-startTime="1106">will have X at offset zero </span><span class="line" data-startTime="1106">in the backing storage </span><span class="line" data-startTime="1108">and Y at offset one. </span> <span class="line" data-startTime="1111">And we can use that </span><span class="line" data-startTime="1111">to optimize property accesses. </span> <span class="line" data-startTime="1117">So let me revisit </span><span class="line" data-startTime="1117">my previous statement. </span> <span class="line" data-startTime="1119">So I said that JavaScript </span><span class="line" data-startTime="1119">is really challenging </span><span class="line" data-startTime="1121">to implement because </span><span class="line" data-startTime="1121">it's really, really dynamic. </span> <span class="line" data-startTime="1125">And that's true. </span> <span class="line" data-startTime="1126">So in JavaScript, </span><span class="line" data-startTime="1126">you have a lot of features </span><span class="line" data-startTime="1128">that allow you to write </span><span class="line" data-startTime="1128">really, really dynamic code. </span> <span class="line" data-startTime="1132">But it turns out </span><span class="line" data-startTime="1132">that if you write, </span><span class="line" data-startTime="1135">uh, nice, </span><span class="line" data-startTime="1135">well-factored code, </span><span class="line" data-startTime="1139">in most cases, you'll have, </span><span class="line" data-startTime="1139">like, parts of your code </span><span class="line" data-startTime="1141">that deal with objects </span><span class="line" data-startTime="1141">that have a certain structure. </span> <span class="line" data-startTime="1144">So now that we have </span><span class="line" data-startTime="1144">hidden classes, </span><span class="line" data-startTime="1146">we can instrument </span><span class="line" data-startTime="1146">our JavaScript engine </span><span class="line" data-startTime="1148">to actually collect information </span><span class="line" data-startTime="1148">about the hidden classes </span><span class="line" data-startTime="1152">that hit certain access sites. </span></p>

<p><span class="line" data-startTime="1153">And it turns out that 90% </span><span class="line" data-startTime="1153">of the cases </span><span class="line" data-startTime="1155">or maybe even more, </span><span class="line" data-startTime="1155">uh, only objects </span><span class="line" data-startTime="1159">having the same hidden class </span><span class="line" data-startTime="1159">are ever seen. </span> <span class="line" data-startTime="1163">So that means that, </span><span class="line" data-startTime="1163">basically, you know something </span><span class="line" data-startTime="1166">about the structure </span><span class="line" data-startTime="1166">of your objects </span><span class="line" data-startTime="1168">when you've seen an object once </span><span class="line" data-startTime="1168">at an access site. </span> <span class="line" data-startTime="1171">And that's what we're, uh, </span><span class="line" data-startTime="1171">and that's what we're going </span><span class="line" data-startTime="1173">to do to, uh, to &mdash; </span><span class="line" data-startTime="1173">to optimize. </span> <span class="line" data-startTime="1176">Um, so basically, </span><span class="line" data-startTime="1176">at runtime, </span><span class="line" data-startTime="1179">JavaScript is not that </span><span class="line" data-startTime="1179">dynamic. </span> <span class="line" data-startTime="1181">You basically see things </span><span class="line" data-startTime="1181">that have the same structure </span><span class="line" data-startTime="1184">again and again and again </span><span class="line" data-startTime="1184">and again. </span> <span class="line" data-startTime="1186">So we can use that. </span> <span class="line" data-startTime="1188">Um, so the only problem here </span><span class="line" data-startTime="1192">is that when we generate </span><span class="line" data-startTime="1192">the JavaScript code &mdash; </span><span class="line" data-startTime="1195">sorry, the native code </span><span class="line" data-startTime="1195">for our JavaScript code, </span><span class="line" data-startTime="1199">um, we don't know </span><span class="line" data-startTime="1199">the hidden class </span><span class="line" data-startTime="1202">of an object </span><span class="line" data-startTime="1202">at an access site, </span><span class="line" data-startTime="1204">uh, because we have </span><span class="line" data-startTime="1204">no type information </span><span class="line" data-startTime="1206">in the language. </span></p>

<p><span class="line" data-startTime="1207">Um, so that means </span><span class="line" data-startTime="1207">that we only know something </span><span class="line" data-startTime="1209">about our objects </span><span class="line" data-startTime="1209">when we see the first object </span><span class="line" data-startTime="1211">at an access site. </span> <span class="line" data-startTime="1213">Um, so in order </span><span class="line" data-startTime="1213">to handle this, </span><span class="line" data-startTime="1216">we use runtime </span><span class="line" data-startTime="1216">code generation. </span> <span class="line" data-startTime="1218">And we use a technique called </span><span class="line" data-startTime="1218">inline caching. </span> <span class="line" data-startTime="1223">So here's </span><span class="line" data-startTime="1223">a very simple picture </span><span class="line" data-startTime="1225">of what inline caching </span><span class="line" data-startTime="1225">is like. </span> <span class="line" data-startTime="1226">So in the beginning, </span><span class="line" data-startTime="1228">we just generate native code </span><span class="line" data-startTime="1228">for our JavaScript code. </span> <span class="line" data-startTime="1230">And at all access sites, </span><span class="line" data-startTime="1230">we have absolutely no knowledge. </span> <span class="line" data-startTime="1233">So if we want to load </span><span class="line" data-startTime="1233">an X-property, </span><span class="line" data-startTime="1236">we're just going to call </span><span class="line" data-startTime="1236">a piece of code </span><span class="line" data-startTime="1237">that's going to do </span><span class="line" data-startTime="1237">a completely generic </span><span class="line" data-startTime="1239">full lookup, uh, through </span><span class="line" data-startTime="1239">our objects </span><span class="line" data-startTime="1242">to see if they can find &mdash; </span><span class="line" data-startTime="1243">uh, if it can find </span><span class="line" data-startTime="1243">the property. </span> <span class="line" data-startTime="1246">But once </span><span class="line" data-startTime="1246">we've done that once, </span><span class="line" data-startTime="1248">we have some extra </span><span class="line" data-startTime="1248">information. </span></p>

<p><span class="line" data-startTime="1250">We know the hidden class </span><span class="line" data-startTime="1250">of the object </span><span class="line" data-startTime="1252">that we've just looked at. </span> <span class="line" data-startTime="1253">And we know, um, </span><span class="line" data-startTime="1256">where we found the property </span><span class="line" data-startTime="1256">in this object. </span> <span class="line" data-startTime="1259">And based on that knowledge, </span><span class="line" data-startTime="1259">we can generate a small snippet </span><span class="line" data-startTime="1263">of new code that's going to be </span><span class="line" data-startTime="1263">really fast. </span> <span class="line" data-startTime="1267">Um, and it's going to assume </span><span class="line" data-startTime="1267">that the next time we get here, </span><span class="line" data-startTime="1270">we're going to see </span><span class="line" data-startTime="1270">the same hidden class again. </span> <span class="line" data-startTime="1274">So then we're going </span><span class="line" data-startTime="1274">to rewrite the code. </span> <span class="line" data-startTime="1275">So that at this access site, </span><span class="line" data-startTime="1277">we're not going to go </span><span class="line" data-startTime="1277">to the fully generic code. </span> <span class="line" data-startTime="1279">But we're actually going </span><span class="line" data-startTime="1279">to hit the fast lookup code. </span> <span class="line" data-startTime="1283">And the only thing </span><span class="line" data-startTime="1283">the fast lookup code has to do </span><span class="line" data-startTime="1285">is validate our assumptions. </span> <span class="line" data-startTime="1287">So it needs to check that </span><span class="line" data-startTime="1287">the next object that gets here </span><span class="line" data-startTime="1291">actually has the same </span><span class="line" data-startTime="1291">hidden class </span><span class="line" data-startTime="1292">as the first one. </span></p>

<p><span class="line" data-startTime="1293">And if it does, </span><span class="line" data-startTime="1294">then it knows exactly </span><span class="line" data-startTime="1294">where to load </span><span class="line" data-startTime="1296">the &mdash; the property value. </span> <span class="line" data-startTime="1299">Okay, and if the assumptions </span><span class="line" data-startTime="1299">are broken &mdash; </span><span class="line" data-startTime="1301">so if we get here </span><span class="line" data-startTime="1301">with another type of object &mdash; </span><span class="line" data-startTime="1304">well, then we bail out </span><span class="line" data-startTime="1304">and then we go </span><span class="line" data-startTime="1306">to the fully generic </span><span class="line" data-startTime="1306">lookup again. </span> <span class="line" data-startTime="1308">And again, that's the same </span><span class="line" data-startTime="1308">for all access sites. </span> <span class="line" data-startTime="1310">When we've seen the first, </span><span class="line" data-startTime="1310">uh, object at an access site, </span><span class="line" data-startTime="1314">we generate a new piece </span><span class="line" data-startTime="1314">of code </span><span class="line" data-startTime="1316">to do a fast lookup </span><span class="line" data-startTime="1316">the next time. </span> <span class="line" data-startTime="1318">Um, and that's </span><span class="line" data-startTime="1318">with the assumption </span><span class="line" data-startTime="1320">that we get the same </span><span class="line" data-startTime="1320">hidden class again. </span></p>

<p><span class="line" data-startTime="1323">If we don't, </span><span class="line" data-startTime="1323">then we bail out </span><span class="line" data-startTime="1325">and do a full generate lookup. </span> <span class="line" data-startTime="1328">Okay, so what does </span><span class="line" data-startTime="1328">the fast case look like? </span><span class="line" data-startTime="1331">So it looks like this. </span> <span class="line" data-startTime="1333">Um, and I've actually </span><span class="line" data-startTime="1333">given you </span><span class="line" data-startTime="1334">all of the information </span><span class="line" data-startTime="1334">that you need to &mdash; </span><span class="line" data-startTime="1337">to completely understand </span><span class="line" data-startTime="1337">what's going on here. </span> <span class="line" data-startTime="1338">So let me try to step &mdash; </span><span class="line" data-startTime="1338">step through it. </span> <span class="line" data-startTime="1340">So this is the &mdash; </span><span class="line" data-startTime="1340">the small snippet of code </span><span class="line" data-startTime="1343">that we generate to access </span><span class="line" data-startTime="1343">a property on an object. </span> <span class="line" data-startTime="1347">So the first couple </span><span class="line" data-startTime="1347">of lines here, </span><span class="line" data-startTime="1349">the first line </span><span class="line" data-startTime="1349">just loads the receiver </span><span class="line" data-startTime="1352">from the stack </span><span class="line" data-startTime="1352">into register eax, okay? </span><span class="line" data-startTime="1357">So as I told you, </span><span class="line" data-startTime="1357">we use tag pointers. </span> <span class="line" data-startTime="1363">So either &mdash; so now </span><span class="line" data-startTime="1363">we've loaded something. </span></p>

<p><span class="line" data-startTime="1366">Okay. So now we need to check </span><span class="line" data-startTime="1366">if it's an object </span><span class="line" data-startTime="1369">or if it's </span><span class="line" data-startTime="1369">an immediate value. </span> <span class="line" data-startTime="1372">Uh, maybe a small integer. </span> <span class="line" data-startTime="1374">So that's what the second line </span><span class="line" data-startTime="1374">here is doing. </span> <span class="line" data-startTime="1376">It &mdash; it, uh, tests </span><span class="line" data-startTime="1376">if the least significant bit </span><span class="line" data-startTime="1379">of eax is one. </span> <span class="line" data-startTime="1381">If it is, </span><span class="line" data-startTime="1381">this is an object pointer. </span> <span class="line" data-startTime="1383">If it's not, it's an immediate </span><span class="line" data-startTime="1383">integer value </span><span class="line" data-startTime="1386">for which this snippet </span><span class="line" data-startTime="1386">doesn't really do anything. </span> <span class="line" data-startTime="1389">So we're going to jump out </span><span class="line" data-startTime="1389">and go do the generic case </span><span class="line" data-startTime="1392">if that's the &mdash; </span><span class="line" data-startTime="1392">if &mdash; if that's happening. </span> <span class="line" data-startTime="1393">So if we see an integer here, </span><span class="line" data-startTime="1393">we're just bailing out. </span> <span class="line" data-startTime="1396">So the &mdash; the first lines here </span><span class="line" data-startTime="1396">are just loading the receiver, </span><span class="line" data-startTime="1399">checking that it's an object. </span></p>

<p><span class="line" data-startTime="1402">So the next couple </span><span class="line" data-startTime="1402">of lines here </span><span class="line" data-startTime="1403">are validating </span><span class="line" data-startTime="1403">our assumptions. </span> <span class="line" data-startTime="1405">And our assumption is </span><span class="line" data-startTime="1405">that we're going to see </span><span class="line" data-startTime="1407">the same hidden class again. </span> <span class="line" data-startTime="1409">So this piece of code </span><span class="line" data-startTime="1409">was generated with the knowledge </span><span class="line" data-startTime="1412">that the first, </span><span class="line" data-startTime="1412">uh, that the hidden class </span><span class="line" data-startTime="1414">of the first object </span><span class="line" data-startTime="1414">that got here </span><span class="line" data-startTime="1416">was at address </span><span class="line" data-startTime="1416">whatever's there. </span> <span class="line" data-startTime="1418">0xf78 and so on. </span></p>

<p><span class="line" data-startTime="1421">Okay. So now we need to check </span><span class="line" data-startTime="1421">that the hidden class </span><span class="line" data-startTime="1424">of a current object </span><span class="line" data-startTime="1424">is the same one. </span> <span class="line" data-startTime="1428">So we're going to load </span><span class="line" data-startTime="1428">from eax minus one. </span> <span class="line" data-startTime="1432">So that's removing the tagging </span><span class="line" data-startTime="1432">from the pointer </span><span class="line" data-startTime="1435">and loading a pointer </span><span class="line" data-startTime="1435">from there, </span><span class="line" data-startTime="1437">which is the map pointer, </span><span class="line" data-startTime="1439">and we're just comparing that </span><span class="line" data-startTime="1439">to what we saw before. </span> <span class="line" data-startTime="1441">If it's the same, </span><span class="line" data-startTime="1441">we're happy </span><span class="line" data-startTime="1444">and we load </span><span class="line" data-startTime="1444">the properties array </span><span class="line" data-startTime="1446">from our object. </span> <span class="line" data-startTime="1448">And from the properties array, </span><span class="line" data-startTime="1449">we load the property value </span><span class="line" data-startTime="1449">directly. </span> <span class="line" data-startTime="1453">And then we return. </span></p>

<p><span class="line" data-startTime="1454">So in the fast case, </span><span class="line" data-startTime="1455">all we need to do </span><span class="line" data-startTime="1455">is check our assumptions. </span> <span class="line" data-startTime="1457">We load the receiver. </span> <span class="line" data-startTime="1457">Check that it's an object. </span> <span class="line" data-startTime="1459">Check that it has the correct </span><span class="line" data-startTime="1459">hidden class. </span> <span class="line" data-startTime="1461">And then directly load </span><span class="line" data-startTime="1461">the property. </span> <span class="line" data-startTime="1462">So that's a few assembly line </span><span class="line" data-startTime="1462">instructions. </span> <span class="line" data-startTime="1465">And that's really, </span><span class="line" data-startTime="1465">really fast. </span> <span class="line" data-startTime="1466">And if any of </span><span class="line" data-startTime="1466">our assumptions break, </span><span class="line" data-startTime="1468">if we either get an integer </span><span class="line" data-startTime="1468">or if the class does not match, </span><span class="line" data-startTime="1473">then we bail out and go </span><span class="line" data-startTime="1473">to a fully generic lookup. </span> <span class="line" data-startTime="1479">Okay, so basically, </span><span class="line" data-startTime="1481">I've told you now </span><span class="line" data-startTime="1481">about two states </span><span class="line" data-startTime="1483">that our inline caches </span><span class="line" data-startTime="1483">can be in. </span> <span class="line" data-startTime="1485">There's actually a third </span><span class="line" data-startTime="1485">as well. </span> <span class="line" data-startTime="1487">So the three inline cache states </span><span class="line" data-startTime="1487">that we have </span><span class="line" data-startTime="1489">are uninitialized, </span><span class="line" data-startTime="1491">which is where </span><span class="line" data-startTime="1491">everything begins. </span></p>

<p><span class="line" data-startTime="1492">We don't know anything yet. </span> <span class="line" data-startTime="1493">We haven't seen </span><span class="line" data-startTime="1493">any objects here. </span> <span class="line" data-startTime="1496">So once we see </span><span class="line" data-startTime="1496">the first object, </span><span class="line" data-startTime="1498">we transition </span><span class="line" data-startTime="1498">to monomorphic, </span><span class="line" data-startTime="1501">which means that we've </span><span class="line" data-startTime="1501">only seen one hidden class </span><span class="line" data-startTime="1503">at this access site. </span> <span class="line" data-startTime="1505">If we see more hidden classes </span><span class="line" data-startTime="1505">at the same access site, </span><span class="line" data-startTime="1507">we go into what's called </span><span class="line" data-startTime="1507">a megamorphic state. </span> <span class="line" data-startTime="1510">And that just means </span><span class="line" data-startTime="1510">we've seen more types here. </span> <span class="line" data-startTime="1513">Um, and in that case, </span><span class="line" data-startTime="1513">we actually use a cache </span><span class="line" data-startTime="1516">of generated </span><span class="line" data-startTime="1516">fast-case stubs. </span> <span class="line" data-startTime="1519">So if we've already generated </span><span class="line" data-startTime="1519">a stub </span><span class="line" data-startTime="1521">for the, uh, this hidden class </span><span class="line" data-startTime="1521">that we're seeing </span><span class="line" data-startTime="1524">and this property, </span><span class="line" data-startTime="1524">we use that. </span> <span class="line" data-startTime="1526">And otherwise, we go </span><span class="line" data-startTime="1526">to the full generic lookup. </span></p>

<p><span class="line" data-startTime="1528">So even if we see, </span><span class="line" data-startTime="1528">uh, multiple different classes </span><span class="line" data-startTime="1531">at the same access site, </span><span class="line" data-startTime="1532">we're actually trying </span><span class="line" data-startTime="1532">to &mdash; to use </span><span class="line" data-startTime="1533">some of our optimized stubs. </span> <span class="line" data-startTime="1537">Another thing worth, </span><span class="line" data-startTime="1537">uh, knowing </span><span class="line" data-startTime="1539">about inline caches in V8 </span><span class="line" data-startTime="1541">is that we clear them </span><span class="line" data-startTime="1541">on full garbage collections. </span> <span class="line" data-startTime="1544">And that might sound odd. </span> <span class="line" data-startTime="1546">So we've just spent time </span><span class="line" data-startTime="1546">generating code on the fly. </span> <span class="line" data-startTime="1549">Uh, and now we just </span><span class="line" data-startTime="1549">throw it all away. </span> <span class="line" data-startTime="1552">So the reason for that is that, </span><span class="line" data-startTime="1552">first of all, </span><span class="line" data-startTime="1555">it allows us to get rid </span><span class="line" data-startTime="1555">of unused code stubs. </span> <span class="line" data-startTime="1558">So all of the code </span><span class="line" data-startTime="1558">that we generate </span><span class="line" data-startTime="1560">is allocated </span><span class="line" data-startTime="1560">in the JavaScript heap </span><span class="line" data-startTime="1562">like any other JavaScript </span><span class="line" data-startTime="1562">object. </span></p>

<p><span class="line" data-startTime="1564">And it flows freely around. </span> <span class="line" data-startTime="1566">Um, so in order to be able </span><span class="line" data-startTime="1566">to, uh, to throw it away, </span><span class="line" data-startTime="1570">uh, we need to clear </span><span class="line" data-startTime="1570">inline caches </span><span class="line" data-startTime="1572">so there are no pointers, </span><span class="line" data-startTime="1572">uh, to these stubs. </span> <span class="line" data-startTime="1576">Um, so if you have </span><span class="line" data-startTime="1576">an application </span><span class="line" data-startTime="1579">where you have, like, </span><span class="line" data-startTime="1579">a couple of stages &mdash; </span><span class="line" data-startTime="1582">so in the first stage, </span><span class="line" data-startTime="1582">you set up a lot of stuff. </span> <span class="line" data-startTime="1584">And you do a lot of things </span><span class="line" data-startTime="1584">with one piece of code. </span> <span class="line" data-startTime="1588">And then basically </span><span class="line" data-startTime="1588">you transition to some other &mdash; </span><span class="line" data-startTime="1590">to &mdash; to, like, another phase </span><span class="line" data-startTime="1590">where you use, basically, </span><span class="line" data-startTime="1592">another piece of code. </span> <span class="line" data-startTime="1594">We don't want to keep </span><span class="line" data-startTime="1594">all the code objects alive </span><span class="line" data-startTime="1596">from the first piece of code </span><span class="line" data-startTime="1598">because if they're not going </span><span class="line" data-startTime="1598">to be used anymore, </span><span class="line" data-startTime="1599">that's a waste. </span> <span class="line" data-startTime="1601">Um, so clearing inline caches </span><span class="line" data-startTime="1601">at full garbage collections </span><span class="line" data-startTime="1604">allows us to get rid </span><span class="line" data-startTime="1604">of unused code stubs. </span></p>

<p><span class="line" data-startTime="1607">The other thing that clearing, </span><span class="line" data-startTime="1607">um, inline caches </span><span class="line" data-startTime="1610">at full garbage collection </span><span class="line" data-startTime="1610">gives us </span><span class="line" data-startTime="1612">is the ability </span><span class="line" data-startTime="1612">to actually go back </span><span class="line" data-startTime="1615">to the fast case </span><span class="line" data-startTime="1615">if we hit the slow case </span><span class="line" data-startTime="1618">where we've seen multiple </span><span class="line" data-startTime="1618">different hidden classes </span><span class="line" data-startTime="1620">at an access site. </span> <span class="line" data-startTime="1622">But basically, </span><span class="line" data-startTime="1622">we've transitioned </span><span class="line" data-startTime="1624">to another, like, phase </span><span class="line" data-startTime="1624">of the program </span><span class="line" data-startTime="1626">where we're only seeing objects </span><span class="line" data-startTime="1626">with the same, </span><span class="line" data-startTime="1629">uh, with the same </span><span class="line" data-startTime="1629">hidden class. </span> <span class="line" data-startTime="1631">Uh, then we basically </span><span class="line" data-startTime="1631">don't want to get stuck </span><span class="line" data-startTime="1633">in the situation </span><span class="line" data-startTime="1633">where we think that we've seen </span><span class="line" data-startTime="1635">multiple, uh, things. </span> <span class="line" data-startTime="1637">So clearing inline caches </span><span class="line" data-startTime="1637">on &mdash; on full garbage collection </span><span class="line" data-startTime="1640">gives our inline caches </span><span class="line" data-startTime="1640">the ability </span><span class="line" data-startTime="1642">to go back to the fast </span><span class="line" data-startTime="1642">monomorphic case again. </span> <span class="line" data-startTime="1648">Okay, so, um, </span><span class="line" data-startTime="1654">that was, </span><span class="line" data-startTime="1654">uh, an introduction </span><span class="line" data-startTime="1656">to how we make </span><span class="line" data-startTime="1656">property accesses fast. </span></p>

<p><span class="line" data-startTime="1658">So there are </span><span class="line" data-startTime="1658">two things here. </span> <span class="line" data-startTime="1659">There are the hidden classes </span><span class="line" data-startTime="1659">and &mdash; and the transition </span><span class="line" data-startTime="1662">between hidden classes. </span> <span class="line" data-startTime="1664">And there's native code </span><span class="line" data-startTime="1664">generation with inline caching. </span> <span class="line" data-startTime="1667">So the next thing I'd like </span><span class="line" data-startTime="1667">to &mdash; to tell you about </span><span class="line" data-startTime="1670">is, uh, </span><span class="line" data-startTime="1670">our memory management. </span> <span class="line" data-startTime="1673">So we use a precise generational </span><span class="line" data-startTime="1673">garbage collector. </span> <span class="line" data-startTime="1677">And what we really want here </span><span class="line" data-startTime="1677">is, uh, </span><span class="line" data-startTime="1680">to get in a situation </span><span class="line" data-startTime="1680">where the JavaScript engine </span><span class="line" data-startTime="1682">scales well. </span> <span class="line" data-startTime="1684">So if you have a lot </span><span class="line" data-startTime="1684">of objects, </span><span class="line" data-startTime="1686">uh, and a lot of, like, </span><span class="line" data-startTime="1686">big data structures </span><span class="line" data-startTime="1689">when you run your program, </span><span class="line" data-startTime="1691">we don't want </span><span class="line" data-startTime="1691">the garbage collector </span><span class="line" data-startTime="1694">to have to look </span><span class="line" data-startTime="1694">at all of these objects </span><span class="line" data-startTime="1696">every time it has to, uh, </span><span class="line" data-startTime="1696">uh, reclaim, uh, some memory </span><span class="line" data-startTime="1700">because that's going to lead </span><span class="line" data-startTime="1700">to big pause times </span><span class="line" data-startTime="1703">and it's going to degrade </span><span class="line" data-startTime="1703">your performance. </span> <span class="line" data-startTime="1706">Because every time you need </span><span class="line" data-startTime="1706">to get some free memory, </span><span class="line" data-startTime="1708">it has to look at everything. </span></p>

<p><span class="line" data-startTime="1710">So we don't want that. </span> <span class="line" data-startTime="1711">So instead, we use generational </span><span class="line" data-startTime="1711">garbage collection. </span> <span class="line" data-startTime="1714">Um, so we have </span><span class="line" data-startTime="1714">two generations. </span> <span class="line" data-startTime="1718">We have a young generation, </span><span class="line" data-startTime="1720">which is one, small, </span><span class="line" data-startTime="1720">contiguous space, </span><span class="line" data-startTime="1722">which would </span><span class="line" data-startTime="1722">garbage collect often, </span><span class="line" data-startTime="1724">and then we have </span><span class="line" data-startTime="1724">an old generation, </span><span class="line" data-startTime="1726">uh, which is divided </span><span class="line" data-startTime="1726">into a number of spaces. </span> <span class="line" data-startTime="1729">Um, and &mdash; and we only </span><span class="line" data-startTime="1729">occasionally garbage collect </span><span class="line" data-startTime="1733">the old generation. </span> <span class="line" data-startTime="1734">So the reasoning here </span><span class="line" data-startTime="1734">is that, um, </span><span class="line" data-startTime="1737">in object-oriented programs, </span><span class="line" data-startTime="1739">most objects that you allocate </span><span class="line" data-startTime="1739">are going to be dead, </span><span class="line" data-startTime="1743">like, really soon. </span> <span class="line" data-startTime="1744">You'll have a lot </span><span class="line" data-startTime="1744">of temporary objects. </span> <span class="line" data-startTime="1746">Um, and the ones </span><span class="line" data-startTime="1746">that do not die immediately </span><span class="line" data-startTime="1750">are often long-lived. </span></p>

<p><span class="line" data-startTime="1752">So we allocate </span><span class="line" data-startTime="1752">all of our objects </span><span class="line" data-startTime="1755">in the young generation. </span> <span class="line" data-startTime="1757">When &mdash; when we run </span><span class="line" data-startTime="1757">out of space </span><span class="line" data-startTime="1758">in the young generation, </span><span class="line" data-startTime="1759">we need to do </span><span class="line" data-startTime="1759">a garbage collection. </span> <span class="line" data-startTime="1762">But we only garbage collect </span><span class="line" data-startTime="1762">the young generation. </span> <span class="line" data-startTime="1764">And since most objects </span><span class="line" data-startTime="1764">that are allocated </span><span class="line" data-startTime="1765">die really young, </span><span class="line" data-startTime="1767">there'll be a lot </span><span class="line" data-startTime="1767">of dead objects </span><span class="line" data-startTime="1769">in our young generation. </span> <span class="line" data-startTime="1770">So we can get rid </span><span class="line" data-startTime="1770">of most of them. </span> <span class="line" data-startTime="1772">And then we'll be ready </span><span class="line" data-startTime="1772">to allocate again. </span> <span class="line" data-startTime="1774">So there's no reason for us </span><span class="line" data-startTime="1774">to look at the old generation </span><span class="line" data-startTime="1776">if we can free enough, </span><span class="line" data-startTime="1776">uh, memory </span><span class="line" data-startTime="1778">from the &mdash; from the young </span><span class="line" data-startTime="1778">generation. </span> <span class="line" data-startTime="1781">Um, so objects that survive </span><span class="line" data-startTime="1781">in the young generation </span><span class="line" data-startTime="1787">will be promoted </span><span class="line" data-startTime="1787">to the old generation </span><span class="line" data-startTime="1790">and then will continue. </span></p>

<p><span class="line" data-startTime="1793">Okay, so, um, the old </span><span class="line" data-startTime="1793">generation, as I said, </span><span class="line" data-startTime="1795">is divided up into a number </span><span class="line" data-startTime="1795">of spaces. </span> <span class="line" data-startTime="1798">And I'm not going to go </span><span class="line" data-startTime="1798">into a lot of details with that. </span> <span class="line" data-startTime="1800">But, so &mdash; so the reasons </span><span class="line" data-startTime="1800">for having multiple spaces </span><span class="line" data-startTime="1803">is basically to be able </span><span class="line" data-startTime="1805">to, uh, um, manage the &mdash; </span><span class="line" data-startTime="1805">the bookkeeping </span><span class="line" data-startTime="1809">in our memory management </span><span class="line" data-startTime="1809">system. </span> <span class="line" data-startTime="1811">So for instance, </span><span class="line" data-startTime="1811">uh, we need &mdash; we have pages </span><span class="line" data-startTime="1814">that are 8, uh, 8K big. </span> <span class="line" data-startTime="1818">So if we have objects </span><span class="line" data-startTime="1818">that are larger than that, </span><span class="line" data-startTime="1819">then we're not going </span><span class="line" data-startTime="1819">to allocate them </span><span class="line" data-startTime="1821">in the normal way. </span> <span class="line" data-startTime="1822">So we have a special space </span><span class="line" data-startTime="1822">for large objects. </span></p>

<p><span class="line" data-startTime="1825">Uh, and also, </span><span class="line" data-startTime="1825">uh, as I said, </span><span class="line" data-startTime="1828">we're dynamically generating </span><span class="line" data-startTime="1828">native code on the fly. </span> <span class="line" data-startTime="1831">Um, so we need one space </span><span class="line" data-startTime="1831">that's executable, </span><span class="line" data-startTime="1835">uh, where we generate </span><span class="line" data-startTime="1835">our native code </span><span class="line" data-startTime="1837">and run it from there. </span> <span class="line" data-startTime="1839">Um, so that's </span><span class="line" data-startTime="1839">the code space. </span> <span class="line" data-startTime="1840">And then there are a number </span><span class="line" data-startTime="1840">of other spaces. </span> <span class="line" data-startTime="1843">Good. </span> <span class="line" data-startTime="1845">So which types of garbage </span><span class="line" data-startTime="1845">collection do we use? </span><span class="line" data-startTime="1848">Um, I'm sorry about that. </span> <span class="line" data-startTime="1850">My slides </span><span class="line" data-startTime="1850">are a bit messed up here. </span> <span class="line" data-startTime="1853">Uh, I think we'll be fine. </span> <span class="line" data-startTime="1856">So, um, we have three types </span><span class="line" data-startTime="1856">of garbage collection. </span> <span class="line" data-startTime="1860">So the first one </span><span class="line" data-startTime="1860">is a scavenge collect. </span></p>

<p><span class="line" data-startTime="1862">A scavenge. </span> <span class="line" data-startTime="1863">And on a scavenge collection, </span><span class="line" data-startTime="1865">uh, we only look </span><span class="line" data-startTime="1865">at the young generation. </span> <span class="line" data-startTime="1868">So this is what we do </span><span class="line" data-startTime="1868">all the time. </span> <span class="line" data-startTime="1869">Uh, and that's, </span><span class="line" data-startTime="1869">uh, copying collection. </span> <span class="line" data-startTime="1872">Um, which means </span><span class="line" data-startTime="1872">that it's leaning on the size </span><span class="line" data-startTime="1875">of the live data. </span> <span class="line" data-startTime="1876">And as I told you, </span><span class="line" data-startTime="1876">a lot of data dies &mdash; </span><span class="line" data-startTime="1878">a lot of objects die </span><span class="line" data-startTime="1878">really young. </span> <span class="line" data-startTime="1881">So that means </span><span class="line" data-startTime="1881">that most of your data </span><span class="line" data-startTime="1884">in the young generation </span><span class="line" data-startTime="1884">is going to be dead. </span> <span class="line" data-startTime="1886">And since this, uh, garbage </span><span class="line" data-startTime="1886">collection technique </span><span class="line" data-startTime="1888">is leaning on the size </span><span class="line" data-startTime="1888">of live objects, </span><span class="line" data-startTime="1890">it's going to be really fast </span><span class="line" data-startTime="1891">because there's not going </span><span class="line" data-startTime="1891">to be much live data. </span></p>

<p><span class="line" data-startTime="1893">So typical pause times </span><span class="line" data-startTime="1893">for a scavenge </span><span class="line" data-startTime="1896">is one to two milliseconds. </span> <span class="line" data-startTime="1897">Um, and we do that </span><span class="line" data-startTime="1897">all the time. </span> <span class="line" data-startTime="1901">Okay, so once in awhile, </span><span class="line" data-startTime="1903">we've actually, uh, promoted </span><span class="line" data-startTime="1903">enough objects </span><span class="line" data-startTime="1907">that we should, um, try </span><span class="line" data-startTime="1907">to clear up </span><span class="line" data-startTime="1910">the old generation as well. </span> <span class="line" data-startTime="1912">Um, so once in awhile, </span><span class="line" data-startTime="1912">we do full garbage collections. </span> <span class="line" data-startTime="1916">And we have two flavors </span><span class="line" data-startTime="1916">of those. </span> <span class="line" data-startTime="1917">So the first one </span><span class="line" data-startTime="1917">is a non-compacting collection. </span> <span class="line" data-startTime="1921">So that's a mark-sweep </span><span class="line" data-startTime="1921">collection </span><span class="line" data-startTime="1923">of both young and old </span><span class="line" data-startTime="1923">generation. </span></p>

<p><span class="line" data-startTime="1927">And in the non-compacting </span><span class="line" data-startTime="1927">version, </span><span class="line" data-startTime="1930">all free memory </span><span class="line" data-startTime="1930">gets added to free lists </span><span class="line" data-startTime="1932">and we allocate from there. </span> <span class="line" data-startTime="1934">Um, and this might cause </span><span class="line" data-startTime="1934">fragmentation. </span> <span class="line" data-startTime="1937">So, um, so fragmentation's </span><span class="line" data-startTime="1937">not good. </span> <span class="line" data-startTime="1941">So that's why we have </span><span class="line" data-startTime="1941">a &mdash; another way </span><span class="line" data-startTime="1943">of garbage collection. </span> <span class="line" data-startTime="1945">Um, okay, so a typical </span><span class="line" data-startTime="1945">pause time </span><span class="line" data-startTime="1947">for, like, really big </span><span class="line" data-startTime="1947">applications </span><span class="line" data-startTime="1949">for a full, </span><span class="line" data-startTime="1949">uh, non-compacting collection </span><span class="line" data-startTime="1952">is up to 50 milliseconds. </span> <span class="line" data-startTime="1955">Often, you'll see </span><span class="line" data-startTime="1955">a lot smaller. </span></p>

<p><span class="line" data-startTime="1957">But if you're building </span><span class="line" data-startTime="1957">really big applications, </span><span class="line" data-startTime="1960">you can see pause times </span><span class="line" data-startTime="1960">up to 50 milliseconds. </span> <span class="line" data-startTime="1964">So the last type of garbage </span><span class="line" data-startTime="1964">collection that we have </span><span class="line" data-startTime="1966">is a full compacting </span><span class="line" data-startTime="1966">collection. </span> <span class="line" data-startTime="1968">Uh, and that's </span><span class="line" data-startTime="1968">a mark-sweep-compact collection </span><span class="line" data-startTime="1971">of both generations. </span> <span class="line" data-startTime="1973">And instead </span><span class="line" data-startTime="1973">of adding free memory </span><span class="line" data-startTime="1975">to free lists, </span><span class="line" data-startTime="1976">we compact everything. </span> <span class="line" data-startTime="1978">So we move all of the objects </span><span class="line" data-startTime="1978">to the beginning of pages </span><span class="line" data-startTime="1981">um, to get rid </span><span class="line" data-startTime="1981">of the fragmentation. </span> <span class="line" data-startTime="1984">So basically, inside of V8, </span><span class="line" data-startTime="1984">we have a notion of &mdash; </span><span class="line" data-startTime="1987">we have an idea </span><span class="line" data-startTime="1987">of how much fragmentation </span><span class="line" data-startTime="1988">we've created. </span> <span class="line" data-startTime="1990">And when we reach </span><span class="line" data-startTime="1990">a certain threshold, </span><span class="line" data-startTime="1993">we're going to do a non &mdash; </span><span class="line" data-startTime="1993">sorry, a compacting collection </span><span class="line" data-startTime="1995">to get rid </span><span class="line" data-startTime="1995">of the fragmentation. </span> <span class="line" data-startTime="1998">Okay, so getting rid </span><span class="line" data-startTime="1998">of fragmentation </span><span class="line" data-startTime="1999">means that we need </span><span class="line" data-startTime="1999">to copy a lot of objects. </span></p>

<p><span class="line" data-startTime="2002">So if you're building </span><span class="line" data-startTime="2002">a really large application, </span><span class="line" data-startTime="2004">uh, you might get pause times </span><span class="line" data-startTime="2004">of up to 100 milliseconds here. </span> <span class="line" data-startTime="2009">Yeah. </span> <span class="line" data-startTime="2015">Oh, so the question is </span><span class="line" data-startTime="2015">"how big is the, uh, is the &mdash; </span><span class="line" data-startTime="2018">is the young generation?" </span><span class="line" data-startTime="2020">Um, it's not very big. </span> <span class="line" data-startTime="2022">It's, like, wow, </span><span class="line" data-startTime="2025">honestly, </span><span class="line" data-startTime="2025">I don't even remember. </span> <span class="line" data-startTime="2026">I think it's &mdash; it's &mdash; </span><span class="line" data-startTime="2026">it's a megabyte or two. </span> <span class="line" data-startTime="2029">Something like that. </span> <span class="line" data-startTime="2044">So the &mdash; so &mdash; I'm not sure </span><span class="line" data-startTime="2044">I understand the question. </span> <span class="line" data-startTime="2046">So you're saying </span><span class="line" data-startTime="2046">that if I have an application </span><span class="line" data-startTime="2048">that allocates </span><span class="line" data-startTime="2048">a lot of small objects &mdash; </span><span class="line" data-startTime="2051">a lot of small objects, </span><span class="line" data-startTime="2051">uh, and then you're saying </span><span class="line" data-startTime="2054">that then </span><span class="line" data-startTime="2054">the young generation's </span><span class="line" data-startTime="2055">going to be scanned </span><span class="line" data-startTime="2055">frequently? </span><span class="line" data-startTime="2058">Well, no, not really. </span> <span class="line" data-startTime="2059">So &mdash; so the &mdash; so, um, </span><span class="line" data-startTime="2059">so if you allocate </span><span class="line" data-startTime="2061">a lot of small objects, </span><span class="line" data-startTime="2063">yes, they're going </span><span class="line" data-startTime="2063">to be allocated </span><span class="line" data-startTime="2064">in the &mdash; </span><span class="line" data-startTime="2064">in the young generation. </span> <span class="line" data-startTime="2067">Um, so if &mdash; if when you &mdash; </span><span class="line" data-startTime="2069">so when you fill out </span><span class="line" data-startTime="2069">the young generation </span><span class="line" data-startTime="2071">and you don't have </span><span class="line" data-startTime="2071">any more room, </span><span class="line" data-startTime="2072">you need to garbage collect. </span> <span class="line" data-startTime="2074">So at that point, </span><span class="line" data-startTime="2074">you look at all the live data </span><span class="line" data-startTime="2076">and then it's true </span><span class="line" data-startTime="2076">that if all of your objects </span><span class="line" data-startTime="2078">are still live, </span><span class="line" data-startTime="2080">then you're going to look </span><span class="line" data-startTime="2080">through all of them, basically. </span></p>

<p><span class="line" data-startTime="2082">But if they survive, </span><span class="line" data-startTime="2082">then you're going to move them </span><span class="line" data-startTime="2084">to the old generation </span><span class="line" data-startTime="2085">and you're not going to look </span><span class="line" data-startTime="2085">at them again. </span> <span class="line" data-startTime="2088">Yeah. But, yeah, </span><span class="line" data-startTime="2088">you're right. </span> <span class="line" data-startTime="2090">I mean, as long as you just </span><span class="line" data-startTime="2090">allocate, </span><span class="line" data-startTime="2092">uh, and &mdash; and keep </span><span class="line" data-startTime="2092">everything alive, </span><span class="line" data-startTime="2094">it's going to be allocated </span><span class="line" data-startTime="2094">in the young generation, </span><span class="line" data-startTime="2096">and you're going </span><span class="line" data-startTime="2096">to scan all of them </span><span class="line" data-startTime="2098">and basically move them </span><span class="line" data-startTime="2098">to the old generation </span><span class="line" data-startTime="2099">so you don't have to look </span><span class="line" data-startTime="2099">at them the next time. </span> <span class="line" data-startTime="2103">Yeah. </span></p>

<p><span class="line" data-startTime="2106">Oh, the timing of these? </span><span class="line" data-startTime="2108">Uh, these are on, uh, </span><span class="line" data-startTime="2108">all desktop &mdash; desktop machines. </span> <span class="line" data-startTime="2113">Uh, and &mdash; and, uh, so basically </span><span class="line" data-startTime="2113">running inside of Chrome </span><span class="line" data-startTime="2117">on, like, a modern machine &mdash; </span><span class="line" data-startTime="2117">desktop machine. </span> <span class="line" data-startTime="2125">Okay. </span> <span class="line" data-startTime="2127">So that covers the part </span><span class="line" data-startTime="2127">of how we made V8 </span><span class="line" data-startTime="2132">handle, um, property accesses, </span><span class="line" data-startTime="2132">function calls, </span><span class="line" data-startTime="2136">and, um, uh, write really well </span><span class="line" data-startTime="2136">and be fast at that. </span> <span class="line" data-startTime="2141">And how we made V8 scale, </span><span class="line" data-startTime="2143">uh, by using generational </span><span class="line" data-startTime="2143">garbage collection. </span> <span class="line" data-startTime="2146">So now let me talk </span><span class="line" data-startTime="2146">a bit about, </span><span class="line" data-startTime="2148">uh, some recent developments. </span></p>

<p><span class="line" data-startTime="2152">So recently, we've, uh, </span><span class="line" data-startTime="2152">we've implemented </span><span class="line" data-startTime="2154">a new regular expression engine </span><span class="line" data-startTime="2154">for V8. </span> <span class="line" data-startTime="2157">It's called Irregexp. </span> <span class="line" data-startTime="2159">Um, so initially, V8, </span><span class="line" data-startTime="2162">um, actually </span><span class="line" data-startTime="2162">in the beginning, </span><span class="line" data-startTime="2164">like, completely </span><span class="line" data-startTime="2164">from the beginning </span><span class="line" data-startTime="2166">to get V8 up and running, </span><span class="line" data-startTime="2166">we use PCRE, </span><span class="line" data-startTime="2168">which is a standard library </span><span class="line" data-startTime="2168">for regular expression matching. </span> <span class="line" data-startTime="2171">Um, the problem with PCRE </span><span class="line" data-startTime="2174">is that it does not match </span><span class="line" data-startTime="2175">JavaScript regular expression </span><span class="line" data-startTime="2175">semantics. </span></p>

<p><span class="line" data-startTime="2178">So you need something else. </span> <span class="line" data-startTime="2179">Either you need </span><span class="line" data-startTime="2179">to modify PCRE </span><span class="line" data-startTime="2182">or you need to have, </span><span class="line" data-startTime="2182">like, a compatibility layer </span><span class="line" data-startTime="2184">that basically translates </span><span class="line" data-startTime="2184">PCRE regular expressions &mdash; </span><span class="line" data-startTime="2187">sorry, JavaScript regular </span><span class="line" data-startTime="2187">expressions </span><span class="line" data-startTime="2188">to their equivalent </span><span class="line" data-startTime="2188">PCRE regular expression </span><span class="line" data-startTime="2190">and then use PCRE. </span> <span class="line" data-startTime="2192">Um, so luckily, </span><span class="line" data-startTime="2192">at WebKit, </span><span class="line" data-startTime="2195">they, uh, they had this problem </span><span class="line" data-startTime="2195">as well. </span> <span class="line" data-startTime="2199">And they created a library </span><span class="line" data-startTime="2199">called JSCRE, </span><span class="line" data-startTime="2202">uh, which matched, </span><span class="line" data-startTime="2202">uh, JavaScript semantics. </span> <span class="line" data-startTime="2205">So we switched to that. </span> <span class="line" data-startTime="2206">So the initial version of V8 </span><span class="line" data-startTime="2206">used a library, </span><span class="line" data-startTime="2210">uh, from WebKit </span><span class="line" data-startTime="2210">called JSCRE. </span> <span class="line" data-startTime="2213">Um, so JSCRE did not fit V8 </span><span class="line" data-startTime="2213">that well </span><span class="line" data-startTime="2217">so it didn't really </span><span class="line" data-startTime="2217">perform well. </span></p>

<p><span class="line" data-startTime="2219">And the reason for this </span><span class="line" data-startTime="2219">is that, uh, JSCRE, </span><span class="line" data-startTime="2223">uh, expected a different string </span><span class="line" data-startTime="2223">representation </span><span class="line" data-startTime="2225">than most strings in V8. </span> <span class="line" data-startTime="2228">So in order to actually </span><span class="line" data-startTime="2228">hand off a string to JSCRE, </span><span class="line" data-startTime="2231">we would most of the time </span><span class="line" data-startTime="2231">have to do a string conversion. </span> <span class="line" data-startTime="2233">And that's really costly. </span> <span class="line" data-startTime="2235">Um, so this really didn't </span><span class="line" data-startTime="2235">perform very well. </span> <span class="line" data-startTime="2238">So, uh, and we thought </span><span class="line" data-startTime="2238">that we could do &mdash; do better. </span> <span class="line" data-startTime="2242">And we also thought </span><span class="line" data-startTime="2242">that we could do better </span><span class="line" data-startTime="2243">when it comes to algorithms, </span><span class="line" data-startTime="2245">uh, for regular expression </span><span class="line" data-startTime="2245">matching. </span> <span class="line" data-startTime="2247">Uh, so we implemented our own </span><span class="line" data-startTime="2247">regular expression matching, </span><span class="line" data-startTime="2250">which has given us a 10x speedup </span><span class="line" data-startTime="2250">on regular expression matching </span><span class="line" data-startTime="2254">on our benchmarks. </span></p>

<p><span class="line" data-startTime="2256">Um, and our new library </span><span class="line" data-startTime="2256">implements </span><span class="line" data-startTime="2259">all of, uh, JavaScript </span><span class="line" data-startTime="2259">regular expressions. </span> <span class="line" data-startTime="2261">So there's no fallback </span><span class="line" data-startTime="2261">to any other engines. </span> <span class="line" data-startTime="2264">It's a full JavaScript regular </span><span class="line" data-startTime="2264">expression implementation. </span> <span class="line" data-startTime="2270">So what's in there? </span><span class="line" data-startTime="2271">Um, well, first of all, </span><span class="line" data-startTime="2273">um, the new </span><span class="line" data-startTime="2273">regular expression engine </span><span class="line" data-startTime="2276">is based on an automata </span><span class="line" data-startTime="2276">approach. </span> <span class="line" data-startTime="2278">So from an input regular </span><span class="line" data-startTime="2278">expression, </span><span class="line" data-startTime="2281">we build an automaton. </span> <span class="line" data-startTime="2283">And then we perform </span><span class="line" data-startTime="2283">analysis </span><span class="line" data-startTime="2284">and optimization </span><span class="line" data-startTime="2284">on that automaton. </span> <span class="line" data-startTime="2287">And then from the resulting </span><span class="line" data-startTime="2287">rewritten automaton, </span><span class="line" data-startTime="2290">we generate native code. </span></p>

<p><span class="line" data-startTime="2292">So all of your regular </span><span class="line" data-startTime="2292">expressions </span><span class="line" data-startTime="2293">are now executed, </span><span class="line" data-startTime="2293">uh, using native code. </span> <span class="line" data-startTime="2298">And, um, in our analysis </span><span class="line" data-startTime="2298">and optimization phase, </span><span class="line" data-startTime="2303">we use a number of tricks </span><span class="line" data-startTime="2303">to, uh, to make, </span><span class="line" data-startTime="2306">um, regular expression matching </span><span class="line" data-startTime="2306">cheaper. </span> <span class="line" data-startTime="2309">So we try </span><span class="line" data-startTime="2309">to avoid backtracking </span><span class="line" data-startTime="2311">and we try </span><span class="line" data-startTime="2311">to reorder operations </span><span class="line" data-startTime="2312">so that we perform </span><span class="line" data-startTime="2312">the least &mdash; </span><span class="line" data-startTime="2314">the least expensive </span><span class="line" data-startTime="2314">operations first. </span> <span class="line" data-startTime="2317">So when you do regular </span><span class="line" data-startTime="2317">expression matching, </span><span class="line" data-startTime="2319">um, most of the time, </span><span class="line" data-startTime="2319">you do find a match </span><span class="line" data-startTime="2322">because you actually know </span><span class="line" data-startTime="2322">that it's going to be there &mdash; </span><span class="line" data-startTime="2324">at &mdash; at &mdash; that it's going </span><span class="line" data-startTime="2324">to be there somewhere. </span> <span class="line" data-startTime="2328">But you start </span><span class="line" data-startTime="2328">from the beginning, right? </span><span class="line" data-startTime="2330">And maybe you have to scan, </span><span class="line" data-startTime="2330">uh, through a lot. </span> <span class="line" data-startTime="2333">So basically, the common case </span><span class="line" data-startTime="2333">for regular expression matching </span><span class="line" data-startTime="2336">is that you don't have </span><span class="line" data-startTime="2336">a match. </span> <span class="line" data-startTime="2337">For the first position, </span><span class="line" data-startTime="2339">you're probably not going </span><span class="line" data-startTime="2339">to have a match. </span></p>

<p><span class="line" data-startTime="2340">And so on. </span> <span class="line" data-startTime="2341">Um, so reordering </span><span class="line" data-startTime="2341">operations </span><span class="line" data-startTime="2343">to perform the least expensive </span><span class="line" data-startTime="2343">operations first </span><span class="line" data-startTime="2345">gives us an opportunity </span><span class="line" data-startTime="2345">to &mdash; to fail </span><span class="line" data-startTime="2348">as quickly as possible, </span><span class="line" data-startTime="2349">which is actually </span><span class="line" data-startTime="2349">pretty important </span><span class="line" data-startTime="2350">when you do regular expression </span><span class="line" data-startTime="2350">matching. </span> <span class="line" data-startTime="2354">Okay, so let me, uh, </span><span class="line" data-startTime="2354">let me give you </span><span class="line" data-startTime="2356">a couple of examples here. </span> <span class="line" data-startTime="2358">Um, so one of the things </span><span class="line" data-startTime="2358">that we do, </span><span class="line" data-startTime="2361">uh, which is to avoid </span><span class="line" data-startTime="2361">backtracking, </span><span class="line" data-startTime="2363">is to search for common parts </span><span class="line" data-startTime="2363">of &mdash; in &mdash; in alternatives first. </span> <span class="line" data-startTime="2367">So if you want to look </span><span class="line" data-startTime="2367">for either "Sun" or "Mon," </span><span class="line" data-startTime="2370">then the common part </span><span class="line" data-startTime="2370">of this regular expression </span><span class="line" data-startTime="2373">is that the character </span><span class="line" data-startTime="2373">at index two </span><span class="line" data-startTime="2377">is going to be "n." </span><span class="line" data-startTime="2379">Okay. </span></p>

<p><span class="line" data-startTime="2380">So if, uh, </span><span class="line" data-startTime="2380">so if you search </span><span class="line" data-startTime="2382">and at the current position, </span><span class="line" data-startTime="2385">the thing that's at index two </span><span class="line" data-startTime="2385">is not an "n," </span><span class="line" data-startTime="2387">then you're done. </span> <span class="line" data-startTime="2388">Then you don't have to do </span><span class="line" data-startTime="2388">anything more </span><span class="line" data-startTime="2390">because then you know </span><span class="line" data-startTime="2390">that it can't match here. </span> <span class="line" data-startTime="2391">So you need to move on. </span> <span class="line" data-startTime="2393">Okay, so the more traditional </span><span class="line" data-startTime="2393">approach here </span><span class="line" data-startTime="2395">would be to start out </span><span class="line" data-startTime="2395">by the first alternative. </span> <span class="line" data-startTime="2398">So you try to look </span><span class="line" data-startTime="2398">for "Sun." </span><span class="line" data-startTime="2400">So you might find S. </span> <span class="line" data-startTime="2400">You might find u. </span> <span class="line" data-startTime="2402">And then </span><span class="line" data-startTime="2402">you might not find n. </span> <span class="line" data-startTime="2405">Then at that point, </span><span class="line" data-startTime="2405">all you know </span><span class="line" data-startTime="2406">is that you didn't match </span><span class="line" data-startTime="2406">"Sun." </span><span class="line" data-startTime="2408">So you have to try </span><span class="line" data-startTime="2408">the other alternative. </span> <span class="line" data-startTime="2411">Uh, and that'll fail, </span><span class="line" data-startTime="2411">uh, by looking at the M. </span></p>

<p><span class="line" data-startTime="2414">All right. </span> <span class="line" data-startTime="2415">But by, uh, looking </span><span class="line" data-startTime="2415">for common parts first, </span><span class="line" data-startTime="2418">we just have to do </span><span class="line" data-startTime="2418">one comparison </span><span class="line" data-startTime="2419">and we know that it's not </span><span class="line" data-startTime="2419">going to be here </span><span class="line" data-startTime="2421">for any of the alternatives. </span> <span class="line" data-startTime="2423">So that avoids </span><span class="line" data-startTime="2423">a lot of backtracking. </span> <span class="line" data-startTime="2426">Um, another nice thing </span><span class="line" data-startTime="2429">about the &mdash; our new regular </span><span class="line" data-startTime="2429">expression engine </span><span class="line" data-startTime="2431">is that, uh, in V8, we have </span><span class="line" data-startTime="2431">an ASCII representation </span><span class="line" data-startTime="2434">for most strings. </span> <span class="line" data-startTime="2436">Uh, because a lot of strings </span><span class="line" data-startTime="2436">that are actually used </span><span class="line" data-startTime="2438">in JavaScript programs </span><span class="line" data-startTime="2438">are still ASCII strings. </span> <span class="line" data-startTime="2441">Uh, and that means </span><span class="line" data-startTime="2442">that in a single compare </span><span class="line" data-startTime="2442">instruction, </span><span class="line" data-startTime="2444">you can actually, uh, </span><span class="line" data-startTime="2446">match up to four characters </span><span class="line" data-startTime="2446">at a time. </span> <span class="line" data-startTime="2448">So in order to search </span><span class="line" data-startTime="2448">for "foobar," </span><span class="line" data-startTime="2451">you'll just, um, </span><span class="line" data-startTime="2451">in an ASCII string, </span><span class="line" data-startTime="2454">you'll just load four bytes </span><span class="line" data-startTime="2454">into Word </span><span class="line" data-startTime="2458">and then you'll do a compare </span><span class="line" data-startTime="2459">against the bit parent </span><span class="line" data-startTime="2459">that's "foob." </span><span class="line" data-startTime="2462">Um, and then you're going </span><span class="line" data-startTime="2462">to load the next two characters, </span><span class="line" data-startTime="2465">which is two bytes, </span><span class="line" data-startTime="2467">and then you're going to do </span><span class="line" data-startTime="2467">a two-byte compare for those. </span> <span class="line" data-startTime="2470">Um, so that's really nice </span><span class="line" data-startTime="2470">to have the ability </span><span class="line" data-startTime="2473">to actually match </span><span class="line" data-startTime="2473">four characters at a time. </span></p>

<p><span class="line" data-startTime="2475">That's really fast. </span> <span class="line" data-startTime="2478">Okay, so here's an example </span><span class="line" data-startTime="2478">that shows you something </span><span class="line" data-startTime="2480">about reordering. </span> <span class="line" data-startTime="2481">Um, so here's </span><span class="line" data-startTime="2481">a regular expression </span><span class="line" data-startTime="2483">that looks for "foobar" </span><span class="line" data-startTime="2485">that can be spelled </span><span class="line" data-startTime="2485">either with a normal F </span><span class="line" data-startTime="2487">or a capital F </span><span class="line" data-startTime="2488">and a normal B </span><span class="line" data-startTime="2488">or a capital B. </span> <span class="line" data-startTime="2490">And then it's going to capture </span><span class="line" data-startTime="2490">whatever was matched. </span> <span class="line" data-startTime="2493">Okay, so we want to perform </span><span class="line" data-startTime="2493">the cheap operations first. </span> <span class="line" data-startTime="2496">So we're going to try </span><span class="line" data-startTime="2496">to begin by matching "oo" </span><span class="line" data-startTime="2499">and "ar" </span><span class="line" data-startTime="2499">at position one and four </span><span class="line" data-startTime="2502">because those are just, </span><span class="line" data-startTime="2502">like, </span><span class="line" data-startTime="2503">simple character </span><span class="line" data-startTime="2503">comparisons. </span> <span class="line" data-startTime="2505">And those are really quick. </span> <span class="line" data-startTime="2506">And if one of them fail, </span><span class="line" data-startTime="2507">well, then we can skip </span><span class="line" data-startTime="2507">all the rest. </span> <span class="line" data-startTime="2509">Okay, so the next thing </span><span class="line" data-startTime="2509">we're going to do </span><span class="line" data-startTime="2511">is look for either F </span><span class="line" data-startTime="2511">or a capital F </span><span class="line" data-startTime="2512">at position zero. </span></p>

<p><span class="line" data-startTime="2513">And we're going to look for a B </span><span class="line" data-startTime="2513">or a capital B </span><span class="line" data-startTime="2515">at position three. </span> <span class="line" data-startTime="2516">And then finally, </span><span class="line" data-startTime="2516">we're going to &mdash; to perform </span><span class="line" data-startTime="2518">the actual capture </span><span class="line" data-startTime="2518">operation. </span> <span class="line" data-startTime="2520">Um, so the reordering here </span><span class="line" data-startTime="2520">is really just to get </span><span class="line" data-startTime="2523">the cheap operations first </span><span class="line" data-startTime="2523">because that allows us </span><span class="line" data-startTime="2526">to fail early and quickly. </span> <span class="line" data-startTime="2531">Good. </span> <span class="line" data-startTime="2532">So that's, uh, that's our new </span><span class="line" data-startTime="2532">regular expression engine. </span> <span class="line" data-startTime="2535">So another thing </span><span class="line" data-startTime="2535">that we've done recently </span><span class="line" data-startTime="2537">is to change our compiler. </span> <span class="line" data-startTime="2539">Uh, so the original compiler </span><span class="line" data-startTime="2539">was extremely simple. </span></p>

<p><span class="line" data-startTime="2542">Uh, just build an abstract </span><span class="line" data-startTime="2542">syntax tree. </span> <span class="line" data-startTime="2545">It did no static analysis </span><span class="line" data-startTime="2545">of any kind. </span> <span class="line" data-startTime="2547">It did no </span><span class="line" data-startTime="2547">register allocation. </span> <span class="line" data-startTime="2549">So it just built an abstract </span><span class="line" data-startTime="2549">syntax tree. </span> <span class="line" data-startTime="2551">And one pass </span><span class="line" data-startTime="2551">over the abstract syntax tree, </span><span class="line" data-startTime="2553">it &mdash; it would generate </span><span class="line" data-startTime="2553">a code. </span> <span class="line" data-startTime="2555">Period. </span> <span class="line" data-startTime="2556">Um, so we've now implemented </span><span class="line" data-startTime="2556">a new compile infrastructure, </span><span class="line" data-startTime="2559">which performs register </span><span class="line" data-startTime="2559">allocation. </span> <span class="line" data-startTime="2561">It's still </span><span class="line" data-startTime="2561">a one-pass compiler. </span> <span class="line" data-startTime="2563">Um, so for JavaScript, </span><span class="line" data-startTime="2565">since you get all of your code </span><span class="line" data-startTime="2565">over the network, </span><span class="line" data-startTime="2568">you need </span><span class="line" data-startTime="2568">your JavaScript engine </span><span class="line" data-startTime="2570">to &mdash; to be able </span><span class="line" data-startTime="2570">to run the code quickly. </span> <span class="line" data-startTime="2573">So you need to, uh, </span><span class="line" data-startTime="2573">to have a fast compiler. </span> <span class="line" data-startTime="2576">So it's still </span><span class="line" data-startTime="2576">a one-pass compiler. </span> <span class="line" data-startTime="2578">But now it actually </span><span class="line" data-startTime="2578">does its best </span><span class="line" data-startTime="2579">to, uh, to do register </span><span class="line" data-startTime="2579">allocation as well. </span></p>

<p><span class="line" data-startTime="2582">And &mdash; and we're pretty </span><span class="line" data-startTime="2582">excited about this. </span> <span class="line" data-startTime="2584">And we think that it'll &mdash; </span><span class="line" data-startTime="2584">that it'll form the basis </span><span class="line" data-startTime="2586">for further native code </span><span class="line" data-startTime="2586">optimizations in &mdash; in V8. </span> <span class="line" data-startTime="2593">Okay, so that's what I wanted </span><span class="line" data-startTime="2593">to say about recent stuff. </span> <span class="line" data-startTime="2596">Um, so now I'm going to talk </span><span class="line" data-startTime="2596">to something </span><span class="line" data-startTime="2598">that's quite different, </span><span class="line" data-startTime="2599">uh, but that I think </span><span class="line" data-startTime="2599">is really, really important. </span> <span class="line" data-startTime="2602">Namely how well </span><span class="line" data-startTime="2602">your JavaScript engines scale </span><span class="line" data-startTime="2606">to deal with very large </span><span class="line" data-startTime="2606">applications. </span> <span class="line" data-startTime="2609">Um, so why is that </span><span class="line" data-startTime="2609">important? </span><span class="line" data-startTime="2614">Well, so web applications </span><span class="line" data-startTime="2614">are becoming bigger and bigger </span><span class="line" data-startTime="2617">and more complex. </span> <span class="line" data-startTime="2619">And with </span><span class="line" data-startTime="2619">the increased complexity, </span><span class="line" data-startTime="2621">you get more objects. </span> <span class="line" data-startTime="2623">And more objects </span><span class="line" data-startTime="2623">put extra, uh, stress </span><span class="line" data-startTime="2626">on your memory management </span><span class="line" data-startTime="2626">system. </span></p>

<p><span class="line" data-startTime="2628">So if you do not have </span><span class="line" data-startTime="2628">a system that scale </span><span class="line" data-startTime="2632">to handle all of </span><span class="line" data-startTime="2632">these objects, </span><span class="line" data-startTime="2633">your performance </span><span class="line" data-startTime="2633">will suffer. </span> <span class="line" data-startTime="2635">Um, so not only are applications </span><span class="line" data-startTime="2635">becoming bigger, </span><span class="line" data-startTime="2640">which means that they get </span><span class="line" data-startTime="2640">more objects, </span><span class="line" data-startTime="2641">but also, a lot of browsers </span><span class="line" data-startTime="2641">are still single process. </span> <span class="line" data-startTime="2644">And most single process </span><span class="line" data-startTime="2644">browsers, </span><span class="line" data-startTime="2646">um, when you start up </span><span class="line" data-startTime="2646">multiple tabs </span><span class="line" data-startTime="2649">with multiple applications, </span><span class="line" data-startTime="2651">all of your JavaScript objects </span><span class="line" data-startTime="2651">are going to be allocated </span><span class="line" data-startTime="2653">in the same JavaScript </span><span class="line" data-startTime="2653">object heap. </span> <span class="line" data-startTime="2656">Which means that you actually </span><span class="line" data-startTime="2656">get a lot of objects </span><span class="line" data-startTime="2659">in your JavaScript heap. </span> <span class="line" data-startTime="2661">So if your memory management </span><span class="line" data-startTime="2661">system has to look </span><span class="line" data-startTime="2664">at all objects </span><span class="line" data-startTime="2664">for every garbage collection, </span><span class="line" data-startTime="2667">that's going to hurt you. </span></p>

<p><span class="line" data-startTime="2669">Um, right. </span> <span class="line" data-startTime="2671">So it is actually </span><span class="line" data-startTime="2671">really important </span><span class="line" data-startTime="2674">that your JavaScript execution </span><span class="line" data-startTime="2674">is &mdash; is good </span><span class="line" data-startTime="2678">and is fast in these situations </span><span class="line" data-startTime="2678">as well. </span> <span class="line" data-startTime="2680">And it's important now. </span> <span class="line" data-startTime="2681">It's not &mdash; it's not only </span><span class="line" data-startTime="2681">for, like, the future. </span> <span class="line" data-startTime="2684">It's also important now. </span> <span class="line" data-startTime="2685">Um, right. </span> <span class="line" data-startTime="2687">So our approach </span><span class="line" data-startTime="2687">to scalability </span><span class="line" data-startTime="2690">is to use generational </span><span class="line" data-startTime="2690">garbage collection, </span><span class="line" data-startTime="2692">as I've just </span><span class="line" data-startTime="2692">told you about. </span> <span class="line" data-startTime="2694">Um, right. </span> <span class="line" data-startTime="2697">So I've done a little </span><span class="line" data-startTime="2697">experiment here. </span></p>

<p><span class="line" data-startTime="2700">And I should say right now </span><span class="line" data-startTime="2702">that this is really, </span><span class="line" data-startTime="2702">really artificial. </span> <span class="line" data-startTime="2705">So take all of this </span><span class="line" data-startTime="2705">with a grain of salt. </span> <span class="line" data-startTime="2708">But it does &mdash; it does </span><span class="line" data-startTime="2708">illustrate my point. </span> <span class="line" data-startTime="2710">Um, so my scalability </span><span class="line" data-startTime="2710">experiment, </span><span class="line" data-startTime="2713">um, was to take </span><span class="line" data-startTime="2713">the raytrace benchmark </span><span class="line" data-startTime="2716">from the V8 benchmark suite </span><span class="line" data-startTime="2716">and then run it </span><span class="line" data-startTime="2719">a number of times. </span> <span class="line" data-startTime="2720">And on each iteration, </span><span class="line" data-startTime="2721">I'm going to allocate </span><span class="line" data-startTime="2721">some extra memory </span><span class="line" data-startTime="2724">in the JavaScript heap. </span> <span class="line" data-startTime="2725">Um, and with V8, </span><span class="line" data-startTime="2725">the data structure </span><span class="line" data-startTime="2728">that I'm going to allocate, </span><span class="line" data-startTime="2730">I'm going to add one megabyte </span><span class="line" data-startTime="2730">of extra live data </span><span class="line" data-startTime="2732">per iteration. </span></p>

<p><span class="line" data-startTime="2733">And then I'm just going </span><span class="line" data-startTime="2733">to map out the performance &mdash; </span><span class="line" data-startTime="2736">so the benchmark score &mdash; </span><span class="line" data-startTime="2736">over these iterations </span><span class="line" data-startTime="2739">with an increased amount </span><span class="line" data-startTime="2739">of objects in your heap. </span> <span class="line" data-startTime="2743">And the result looks like this </span><span class="line" data-startTime="2743">for, uh, for three browsers. </span> <span class="line" data-startTime="2747">Um, so as you can see, </span><span class="line" data-startTime="2750">the performance </span><span class="line" data-startTime="2750">characteristics here </span><span class="line" data-startTime="2752">are quite different. </span> <span class="line" data-startTime="2753">Um, so what we want </span><span class="line" data-startTime="2753">to get to here </span><span class="line" data-startTime="2756">is basically having </span><span class="line" data-startTime="2756">a straight line. </span> <span class="line" data-startTime="2759">So as you can see, </span><span class="line" data-startTime="2760">uh, Chromium running V8 </span><span class="line" data-startTime="2760">is not getting a straight line. </span> <span class="line" data-startTime="2764">But it's also not, like, </span><span class="line" data-startTime="2764">dropping completely. </span> <span class="line" data-startTime="2767">Um, and that's &mdash; that's pretty </span><span class="line" data-startTime="2767">much what you get </span><span class="line" data-startTime="2770">when you use a generational </span><span class="line" data-startTime="2770">garbage collection like we do. </span></p>

<p><span class="line" data-startTime="2773">So it does cost </span><span class="line" data-startTime="2773">to have larger heaps, </span><span class="line" data-startTime="2776">but your performance </span><span class="line" data-startTime="2776">does not completely degrade. </span> <span class="line" data-startTime="2779">Um, so another </span><span class="line" data-startTime="2779">interesting thing </span><span class="line" data-startTime="2781">that you can see </span><span class="line" data-startTime="2781">from this graph </span><span class="line" data-startTime="2782">is that you have, like, </span><span class="line" data-startTime="2782">down spikes. </span> <span class="line" data-startTime="2784">Um, so those down spikes </span><span class="line" data-startTime="2784">are when you get </span><span class="line" data-startTime="2787">to the full compacting </span><span class="line" data-startTime="2787">collections. </span> <span class="line" data-startTime="2789">So if you actually get </span><span class="line" data-startTime="2789">to a point </span><span class="line" data-startTime="2790">where you need to do </span><span class="line" data-startTime="2790">a full compacting collection, </span><span class="line" data-startTime="2793">that's going to be visible </span><span class="line" data-startTime="2793">on graphs like, uh, like these. </span> <span class="line" data-startTime="2797">So the interesting thing here </span><span class="line" data-startTime="2798">is that, like, Firefox 3.5, </span><span class="line" data-startTime="2798">beta 4, </span><span class="line" data-startTime="2802">uh, seems to be doing </span><span class="line" data-startTime="2802">very well </span><span class="line" data-startTime="2803">when it comes to scalability. </span></p>

<p><span class="line" data-startTime="2805">Uh, the benchmark score </span><span class="line" data-startTime="2805">is not that impressive </span><span class="line" data-startTime="2808">on the other hand. </span> <span class="line" data-startTime="2809">Uh, Safari is doing really well </span><span class="line" data-startTime="2809">on the benchmark score. </span> <span class="line" data-startTime="2812">Uh, but it seems </span><span class="line" data-startTime="2812">that there's something </span><span class="line" data-startTime="2814">like a full scan of the heap </span><span class="line" data-startTime="2814">on each garbage collection </span><span class="line" data-startTime="2817">because if you add extra data </span><span class="line" data-startTime="2817">to the heap, </span><span class="line" data-startTime="2821">then already at, like, </span><span class="line" data-startTime="2821">five megabytes, </span><span class="line" data-startTime="2824">they're at a third </span><span class="line" data-startTime="2824">of the speed that they had </span><span class="line" data-startTime="2827">with, uh, with a freshly, </span><span class="line" data-startTime="2827">uh, started browser. </span> <span class="line" data-startTime="2831">Um, so I think </span><span class="line" data-startTime="2831">this really matters </span><span class="line" data-startTime="2833">because this is &mdash; I mean, </span><span class="line" data-startTime="2833">this is a benchmark, right? </span><span class="line" data-startTime="2836">So this is a benchmark </span><span class="line" data-startTime="2836">that's in our benchmark suite. </span> <span class="line" data-startTime="2838">And this tells you something </span><span class="line" data-startTime="2838">about how valid </span><span class="line" data-startTime="2840">those benchmark results are </span><span class="line" data-startTime="2840">in the real world. </span> <span class="line" data-startTime="2843">So if you have </span><span class="line" data-startTime="2843">a single process browser </span><span class="line" data-startTime="2847">and you open multiple tabs, </span><span class="line" data-startTime="2849">that's going to lead </span><span class="line" data-startTime="2849">to a lot of objects. </span> <span class="line" data-startTime="2851">And, uh, and then </span><span class="line" data-startTime="2851">your performance </span><span class="line" data-startTime="2853">is going to be more like </span><span class="line" data-startTime="2853">what's on the right </span><span class="line" data-startTime="2855">of this, uh, </span><span class="line" data-startTime="2855">of this graph. </span></p>

<p><span class="line" data-startTime="2858">So I think that &mdash; that we need </span><span class="line" data-startTime="2858">to put some more emphasis </span><span class="line" data-startTime="2860">on this. </span> <span class="line" data-startTime="2861">Uh, and I think </span><span class="line" data-startTime="2861">that it's really important, </span><span class="line" data-startTime="2864">um, because it's &mdash; </span><span class="line" data-startTime="2864">it's really important for &mdash; </span><span class="line" data-startTime="2868">for the real live </span><span class="line" data-startTime="2868">situations, </span><span class="line" data-startTime="2870">having many tabs </span><span class="line" data-startTime="2870">or having big applications. </span> <span class="line" data-startTime="2873">Um, so in order </span><span class="line" data-startTime="2873">to put a bit of focus on this, </span><span class="line" data-startTime="2876">uh, we've, um, we've published </span><span class="line" data-startTime="2876">a new benchmark </span><span class="line" data-startTime="2880">in the V8 benchmark suite. </span></p>

<p><span class="line" data-startTime="2881">Which is again completely </span><span class="line" data-startTime="2881">artificial. </span> <span class="line" data-startTime="2884">So it builds a splay tree, </span><span class="line" data-startTime="2884">uh, roughly the size </span><span class="line" data-startTime="2888">of, like, 30 megabytes, </span><span class="line" data-startTime="2888">something like that. </span> <span class="line" data-startTime="2890">And then it just performs </span><span class="line" data-startTime="2890">operations on the splay tree. </span> <span class="line" data-startTime="2892">Which means that it allocates </span><span class="line" data-startTime="2892">new nodes, </span><span class="line" data-startTime="2894">it modifies the splay tree, </span><span class="line" data-startTime="2896">and it garbage collects, uh, </span><span class="line" data-startTime="2896">nodes that have been removed. </span> <span class="line" data-startTime="2899">Um, right, </span><span class="line" data-startTime="2901">so we really want to try </span><span class="line" data-startTime="2901">to, like, </span><span class="line" data-startTime="2903">put some emphasis on this. </span> <span class="line" data-startTime="2904">Uh, we want scalability. </span> <span class="line" data-startTime="2904">We want browsers to be scalable. </span> <span class="line" data-startTime="2907">We want people to actually get </span><span class="line" data-startTime="2907">the JavaScript performance </span><span class="line" data-startTime="2910">that they expect </span><span class="line" data-startTime="2911">when they run the JavaScript </span><span class="line" data-startTime="2911">benchmarks out there. </span></p>

<p><span class="line" data-startTime="2915">Uh, those should basically </span><span class="line" data-startTime="2915">reflect what you get in reality. </span> <span class="line" data-startTime="2918">So again, this experiment </span><span class="line" data-startTime="2918">is completely artificial. </span> <span class="line" data-startTime="2921">Uh, if you want to try this, </span><span class="line" data-startTime="2921">uh, take your browsers, </span><span class="line" data-startTime="2924">load a number of tabs, </span><span class="line" data-startTime="2924">run benchmarks, </span><span class="line" data-startTime="2927">um, or try something else. </span> <span class="line" data-startTime="2929">Try writing really big </span><span class="line" data-startTime="2929">web applications </span><span class="line" data-startTime="2931">and see how well, </span><span class="line" data-startTime="2931">uh, JavaScript behaves </span><span class="line" data-startTime="2933">under a bit of stress. </span> <span class="line" data-startTime="2936">Good. So that finishes </span><span class="line" data-startTime="2936">my scalability rant. </span> <span class="line" data-startTime="2940">Um, good. </span> <span class="line" data-startTime="2942">So let me tell you a bit </span><span class="line" data-startTime="2943">about the performance </span><span class="line" data-startTime="2943">bottlenecks </span><span class="line" data-startTime="2944">that I see for &mdash; </span><span class="line" data-startTime="2944">for V8 currently. </span> <span class="line" data-startTime="2947">Um, so one of the bottlenecks </span><span class="line" data-startTime="2947">that we have is that, um, </span><span class="line" data-startTime="2953">we only generate </span><span class="line" data-startTime="2953">one, uh, fully general version </span><span class="line" data-startTime="2957">of all code that we generate. </span> <span class="line" data-startTime="2959">That means that we are not </span><span class="line" data-startTime="2959">basically allowed </span><span class="line" data-startTime="2961">to have that many assumptions </span><span class="line" data-startTime="2961">in our code. </span> <span class="line" data-startTime="2964">Because we need to handle </span><span class="line" data-startTime="2964">all the special cases </span><span class="line" data-startTime="2968">in the code that we generate. </span></p>

<p><span class="line" data-startTime="2971">So that means that we have </span><span class="line" data-startTime="2971">a lot of checking </span><span class="line" data-startTime="2973">for basically exceptional </span><span class="line" data-startTime="2973">situations in our code, </span><span class="line" data-startTime="2975">like situations that basically </span><span class="line" data-startTime="2975">do not happen in reality. </span> <span class="line" data-startTime="2979">Um, so one thing </span><span class="line" data-startTime="2979">that we should explore </span><span class="line" data-startTime="2983">is generating multiple versions </span><span class="line" data-startTime="2983">of the same code. </span> <span class="line" data-startTime="2987">So generating &mdash; </span><span class="line" data-startTime="2987">uh, in the beginning, </span><span class="line" data-startTime="2989">generating a really optimized </span><span class="line" data-startTime="2989">version of the code </span><span class="line" data-startTime="2992">that avoids a lot </span><span class="line" data-startTime="2992">of the checking. </span> <span class="line" data-startTime="2995">And then if some </span><span class="line" data-startTime="2995">of our checks fail, </span><span class="line" data-startTime="2997">then basically bail out </span><span class="line" data-startTime="2997">to a slower version of the code. </span> <span class="line" data-startTime="3000">So at that point, generate </span><span class="line" data-startTime="3000">another version of the code. </span> <span class="line" data-startTime="3003">So that should give us </span><span class="line" data-startTime="3003">a big performance gain. </span></p>

<p><span class="line" data-startTime="3006">Um, another, </span><span class="line" data-startTime="3006">uh, bottleneck </span><span class="line" data-startTime="3011">is that our use </span><span class="line" data-startTime="3011">of inline caching </span><span class="line" data-startTime="3015">is based on calls to stubs. </span> <span class="line" data-startTime="3018">So we generate these stubs </span><span class="line" data-startTime="3020">and then we use, </span><span class="line" data-startTime="3020">like, a call instruction </span><span class="line" data-startTime="3022">to actually get </span><span class="line" data-startTime="3022">to that code. </span> <span class="line" data-startTime="3024">Um, and that's good </span><span class="line" data-startTime="3024">for a code size </span><span class="line" data-startTime="3028">because we just have </span><span class="line" data-startTime="3028">a call instruction in there. </span> <span class="line" data-startTime="3030">But it's not necessarily </span><span class="line" data-startTime="3030">the best thing we can do </span><span class="line" data-startTime="3032">for our performance. </span> <span class="line" data-startTime="3034">So in some situations, </span><span class="line" data-startTime="3035">we might actually want </span><span class="line" data-startTime="3035">to inline the code instead </span><span class="line" data-startTime="3038">directly in the code stream. </span> <span class="line" data-startTime="3040">So instead of having </span><span class="line" data-startTime="3040">the call, </span><span class="line" data-startTime="3042">we can just have the code </span><span class="line" data-startTime="3042">directly there. </span> <span class="line" data-startTime="3044">Uh, and that </span><span class="line" data-startTime="3044">actually matters. </span> <span class="line" data-startTime="3046">Uh, and we have done that </span><span class="line" data-startTime="3046">for a couple of simple cases </span><span class="line" data-startTime="3051">of loads. </span> <span class="line" data-startTime="3052">And it really does matter. </span></p>

<p><span class="line" data-startTime="3054">So the downside to that </span><span class="line" data-startTime="3054">is code size. </span> <span class="line" data-startTime="3056">So your code becomes bigger </span><span class="line" data-startTime="3056">when you actually inline. </span> <span class="line" data-startTime="3061">Okay, so another issue, </span><span class="line" data-startTime="3062">which is basically, </span><span class="line" data-startTime="3062">uh, related </span><span class="line" data-startTime="3064">to doing more inlining </span><span class="line" data-startTime="3067">is our write barrier. </span> <span class="line" data-startTime="3068">Um, so since we use </span><span class="line" data-startTime="3068">generational garbage collection, </span><span class="line" data-startTime="3072">um, and we, uh, </span><span class="line" data-startTime="3075">garbage collect </span><span class="line" data-startTime="3075">the young generation often, </span><span class="line" data-startTime="3078">we need to know </span><span class="line" data-startTime="3078">about all pointers </span><span class="line" data-startTime="3080">into the young generation. </span> <span class="line" data-startTime="3082">And that includes </span><span class="line" data-startTime="3082">all of the pointers </span><span class="line" data-startTime="3083">from objects </span><span class="line" data-startTime="3083">in the old generation </span><span class="line" data-startTime="3085">to pointers </span><span class="line" data-startTime="3085">in the new generation. </span></p>

<p><span class="line" data-startTime="3087">And that means that whenever </span><span class="line" data-startTime="3087">we store a pointer </span><span class="line" data-startTime="3090">in an old generation object, </span><span class="line" data-startTime="3091">we might have </span><span class="line" data-startTime="3091">to record somewhere </span><span class="line" data-startTime="3093">that this object </span><span class="line" data-startTime="3093">is actually referring </span><span class="line" data-startTime="3095">to a new space object. </span> <span class="line" data-startTime="3097">And that's done by something </span><span class="line" data-startTime="3097">called a write barrier. </span> <span class="line" data-startTime="3099">And right now, </span><span class="line" data-startTime="3101">our write barrier is a bit </span><span class="line" data-startTime="3101">complicated. </span> <span class="line" data-startTime="3102">It has a lot of instructions, </span><span class="line" data-startTime="3102">and it's a bit slow. </span> <span class="line" data-startTime="3106">So we should experiment </span><span class="line" data-startTime="3106">with &mdash; with new ways </span><span class="line" data-startTime="3108">of implementing </span><span class="line" data-startTime="3108">our write barrier. </span> <span class="line" data-startTime="3110">Um, and the reason </span><span class="line" data-startTime="3110">why that's related </span><span class="line" data-startTime="3113">to, uh, inlining more code </span><span class="line" data-startTime="3115">is that since our write </span><span class="line" data-startTime="3115">barrier's pretty big, </span><span class="line" data-startTime="3118">it's not really practical </span><span class="line" data-startTime="3118">to inline stores </span><span class="line" data-startTime="3121">directly in the code </span><span class="line" data-startTime="3121">because all stores </span><span class="line" data-startTime="3123">need to have the write barrier </span><span class="line" data-startTime="3123">inline as well. </span></p>

<p><span class="line" data-startTime="3126">And that will lead </span><span class="line" data-startTime="3126">to a lot of, uh, </span><span class="line" data-startTime="3128">of code size, uh, increase. </span> <span class="line" data-startTime="3132">Okay, </span><span class="line" data-startTime="3132">and the last thing here, </span><span class="line" data-startTime="3134">I don't really want </span><span class="line" data-startTime="3134">to talk much about. </span> <span class="line" data-startTime="3135">But &mdash; but basically, </span><span class="line" data-startTime="3135">there are a lot of global loads </span><span class="line" data-startTime="3138">in JavaScript code. </span> <span class="line" data-startTime="3139">And we handle global loads </span><span class="line" data-startTime="3139">the same way as any other loads. </span> <span class="line" data-startTime="3142">And basically, </span><span class="line" data-startTime="3142">we don't have to. </span> <span class="line" data-startTime="3144">So we could generate </span><span class="line" data-startTime="3144">better code for that. </span> <span class="line" data-startTime="3146">Um, so another thing </span><span class="line" data-startTime="3146">that I didn't put up here, </span><span class="line" data-startTime="3149">but which is also </span><span class="line" data-startTime="3149">really important, </span><span class="line" data-startTime="3151">is, uh, DOM performance. </span></p>

<p><span class="line" data-startTime="3152">And basically, we haven't </span><span class="line" data-startTime="3152">done much, uh, in that area </span><span class="line" data-startTime="3155">to really, </span><span class="line" data-startTime="3155">really optimize it. </span> <span class="line" data-startTime="3157">Um, so that's another thing </span><span class="line" data-startTime="3157">that we should do. </span> <span class="line" data-startTime="3159">Uh, we should look more </span><span class="line" data-startTime="3159">at DOM performance. </span> <span class="line" data-startTime="3162">So the interaction </span><span class="line" data-startTime="3162">between JavaScript </span><span class="line" data-startTime="3165">and &mdash; and the DOM. </span> <span class="line" data-startTime="3171">Good. </span> <span class="line" data-startTime="3172">So to summarize, </span><span class="line" data-startTime="3173">V8 was designed </span><span class="line" data-startTime="3173">both for speed </span><span class="line" data-startTime="3175">and for scalability. </span> <span class="line" data-startTime="3177">Uh, the goal of V8 is </span><span class="line" data-startTime="3177">to raise the performance bar </span><span class="line" data-startTime="3180">for JavaScript. </span> <span class="line" data-startTime="3181">So we want to continue </span><span class="line" data-startTime="3181">to push </span><span class="line" data-startTime="3183">and see if we can make </span><span class="line" data-startTime="3183">JavaScript even faster. </span> <span class="line" data-startTime="3187">And, um, we don't want </span><span class="line" data-startTime="3187">to just push </span><span class="line" data-startTime="3192">for Google </span><span class="line" data-startTime="3192">and for Google Chrome. </span> <span class="line" data-startTime="3194">We really want to &mdash; </span><span class="line" data-startTime="3194">to try to see if we can &mdash; </span><span class="line" data-startTime="3197">if we can inspire other </span><span class="line" data-startTime="3197">JavaScript vendors as well. </span> <span class="line" data-startTime="3202">And therefore, </span><span class="line" data-startTime="3202">our full source code </span><span class="line" data-startTime="3205">is available </span><span class="line" data-startTime="3205">under a BSD license. </span> <span class="line" data-startTime="3208">And, unfortunately, </span><span class="line" data-startTime="3209">the URL scrolled out of </span><span class="line" data-startTime="3209">my slides here. </span></p>

<p><span class="line" data-startTime="3211">But it's at </span><span class="line" data-startTime="3211">code.google.com/p/v8. </span> <span class="line" data-startTime="3215">Should be pretty easy </span><span class="line" data-startTime="3215">to find. </span> <span class="line" data-startTime="3217">So the graph </span><span class="line" data-startTime="3217">that I've put up here </span><span class="line" data-startTime="3219">that I'd like to end with </span><span class="line" data-startTime="3220">is the, um, </span><span class="line" data-startTime="3220">is what has happened to </span><span class="line" data-startTime="3224">the V8 benchmark score </span><span class="line" data-startTime="3224">over time. </span> <span class="line" data-startTime="3226">So, um, the versions </span><span class="line" data-startTime="3226">that you see on the left </span><span class="line" data-startTime="3229">are Google Chrome versions. </span> <span class="line" data-startTime="3231">So this basically started </span><span class="line" data-startTime="3231">in September of 2008 </span><span class="line" data-startTime="3234">with a 1.0 beta. </span> <span class="line" data-startTime="3236">And since then, </span><span class="line" data-startTime="3236">we've just continued to push. </span> <span class="line" data-startTime="3239">And we will continue </span><span class="line" data-startTime="3239">to do that. </span></p>

<p><span class="line" data-startTime="3242">So that's all. </span> <span class="line" data-startTime="3242">Thanks. </span> <span class="line" data-startTime="3244">[applause] </span><span class="line" data-startTime="3251">Questions. </span> <span class="line" data-startTime="3253">Yes. </span> <span class="line" data-startTime="3263">Yeah, that's a good point. </span> <span class="line" data-startTime="3265">So the question is, </span><span class="line" data-startTime="3265">in my example of hidden classes </span><span class="line" data-startTime="3268">and hidden class transitions, </span><span class="line" data-startTime="3268">I added first X and then Y. </span> <span class="line" data-startTime="3271">So what would happen </span><span class="line" data-startTime="3271">if I added Y first and then X? </span><span class="line" data-startTime="3274">And the, uh, and the answer is </span><span class="line" data-startTime="3274">that that would be </span><span class="line" data-startTime="3277">a different hidden class. </span> <span class="line" data-startTime="3279">Um, so, uh, </span><span class="line" data-startTime="3279">it's really common </span><span class="line" data-startTime="3283">for objects to be allocat &mdash; </span><span class="line" data-startTime="3284">to be generated </span><span class="line" data-startTime="3284">in exactly the same way. </span> <span class="line" data-startTime="3287">Um, so that's basically </span><span class="line" data-startTime="3287">what saves us. </span> <span class="line" data-startTime="3289">But you're right. </span></p>

<p><span class="line" data-startTime="3290">They're objects that basically </span><span class="line" data-startTime="3290">have the same structure, </span><span class="line" data-startTime="3292">namely a Y-property </span><span class="line" data-startTime="3292">and an X-property, </span><span class="line" data-startTime="3294">um, they can actually </span><span class="line" data-startTime="3294">get completely different maps </span><span class="line" data-startTime="3297">if you first add Y and then X </span><span class="line" data-startTime="3297">and then in another place </span><span class="line" data-startTime="3300">add X and then Y. </span> <span class="line" data-startTime="3301">Those would be separate </span><span class="line" data-startTime="3301">hidden classes. </span> <span class="line" data-startTime="3305">Yeah. </span> <span class="line" data-startTime="3310">Okay. So what if you declare </span><span class="line" data-startTime="3310">an object </span><span class="line" data-startTime="3312">through an object literal </span><span class="line" data-startTime="3312">and not through a function? </span><span class="line" data-startTime="3314">Uh, that's not going </span><span class="line" data-startTime="3314">to be a problem </span><span class="line" data-startTime="3316">because object literals </span><span class="line" data-startTime="3316">are also created </span><span class="line" data-startTime="3318">based on a function &mdash; </span><span class="line" data-startTime="3318">namely the object function. </span></p>

<p><span class="line" data-startTime="3321">And the object function </span><span class="line" data-startTime="3321">has an initial map. </span> <span class="line" data-startTime="3324">Um, so basically, </span><span class="line" data-startTime="3324">uh, the same thing works. </span> <span class="line" data-startTime="3328">Yeah. </span> <span class="line" data-startTime="3335">Yeah, that's a good question. </span> <span class="line" data-startTime="3337">So the question is </span><span class="line" data-startTime="3338">do we only apply this </span><span class="line" data-startTime="3338">to user-defined objects </span><span class="line" data-startTime="3342">or do we also use this </span><span class="line" data-startTime="3342">on, like, built-in stuff </span><span class="line" data-startTime="3345">like date, math, number, </span><span class="line" data-startTime="3345">whatever? </span><span class="line" data-startTime="3347">And the answer is that, </span><span class="line" data-startTime="3347">yes, we also do it </span><span class="line" data-startTime="3349">on built-in stuff. </span> <span class="line" data-startTime="3350">Uh, and to go a bit deeper, </span><span class="line" data-startTime="3354">our built-in stuff is actually </span><span class="line" data-startTime="3354">implemented in JavaScript. </span> <span class="line" data-startTime="3356">So we don't implement that </span><span class="line" data-startTime="3356">in C++. </span> <span class="line" data-startTime="3359">We actually have it implemented </span><span class="line" data-startTime="3359">in JavaScript &mdash; a lot of it. </span> <span class="line" data-startTime="3362">Um, so that means that basically </span><span class="line" data-startTime="3362">the same thing applies. </span> <span class="line" data-startTime="3366">So it's going to go through </span><span class="line" data-startTime="3366">exactly the same path. </span></p>

<p><span class="line" data-startTime="3368">And the cool thing about that </span><span class="line" data-startTime="3368">is that if we improve </span><span class="line" data-startTime="3372">our overall JavaScript </span><span class="line" data-startTime="3372">performance, </span><span class="line" data-startTime="3374">we're also going to improve </span><span class="line" data-startTime="3374">the speed of our libraries. </span> <span class="line" data-startTime="3378">Um, so that's one cool thing </span><span class="line" data-startTime="3378">about having libraries </span><span class="line" data-startTime="3380">written in JavaScript. </span> <span class="line" data-startTime="3382">Another cool thing </span><span class="line" data-startTime="3382">is that, um, </span><span class="line" data-startTime="3385">uh, it's really easy and quick </span><span class="line" data-startTime="3385">to go change stuff. </span> <span class="line" data-startTime="3389">Um, so it also does lead to &mdash; </span><span class="line" data-startTime="3392">to some extra complication </span><span class="line" data-startTime="3394">in the sense that in order </span><span class="line" data-startTime="3394">to set up </span><span class="line" data-startTime="3397">your math, number, </span><span class="line" data-startTime="3397">date objects, </span><span class="line" data-startTime="3399">you actually have to look </span><span class="line" data-startTime="3399">at JavaScript code. </span> <span class="line" data-startTime="3403">You actually have to compile </span><span class="line" data-startTime="3403">JavaScript code. </span> <span class="line" data-startTime="3404">So to overcome that, </span><span class="line" data-startTime="3404">uh, we &mdash; we use something </span><span class="line" data-startTime="3408">called snapshotting. </span> <span class="line" data-startTime="3409">So, um, yes, </span><span class="line" data-startTime="3413">this is becoming </span><span class="line" data-startTime="3413">a longer explanation. </span></p>

<p><span class="line" data-startTime="3414">Sorry about that. </span> <span class="line" data-startTime="3416">So &mdash; so basically, </span><span class="line" data-startTime="3416">in the beginning, </span><span class="line" data-startTime="3417">the first time that we &mdash; </span><span class="line" data-startTime="3417">that we, uh &mdash; </span><span class="line" data-startTime="3419">so when we build V8, </span><span class="line" data-startTime="3421">we start up V8 once, </span><span class="line" data-startTime="3421">we load the basic libraries. </span> <span class="line" data-startTime="3424">That gives us a heap </span><span class="line" data-startTime="3424">that contains all of the code </span><span class="line" data-startTime="3427">for our basic libraries. </span> <span class="line" data-startTime="3429">We dump that heap </span><span class="line" data-startTime="3429">as a binary image to a file. </span> <span class="line" data-startTime="3432">And then we integrate </span><span class="line" data-startTime="3432">that binary data </span><span class="line" data-startTime="3436">into a new version of V8 </span><span class="line" data-startTime="3436">that we built </span><span class="line" data-startTime="3439">so that when you start V8, </span><span class="line" data-startTime="3440">even though your libraries </span><span class="line" data-startTime="3440">are written in JavaScript, </span><span class="line" data-startTime="3442">you don't have to &mdash; to pass </span><span class="line" data-startTime="3442">and compile any JavaScript code </span><span class="line" data-startTime="3445">to get your native libraries. </span></p>

<p><span class="line" data-startTime="3446">All you do is just slurp </span><span class="line" data-startTime="3446">in that binary data </span><span class="line" data-startTime="3449">and you're up and running. </span> <span class="line" data-startTime="3451">Yeah. </span> <span class="line" data-startTime="3460">So the question is </span><span class="line" data-startTime="3461">"if there are any JavaScript </span><span class="line" data-startTime="3461">design patterns </span><span class="line" data-startTime="3463">that I know of that perform </span><span class="line" data-startTime="3463">better than others." </span><span class="line" data-startTime="3466">Um, so my answer to that </span><span class="line" data-startTime="3466">would be no. </span> <span class="line" data-startTime="3469">But also, my answer to that </span><span class="line" data-startTime="3469">should be that, </span><span class="line" data-startTime="3472">uh, that it shouldn't matter </span><span class="line" data-startTime="3472">that much. </span> <span class="line" data-startTime="3475">So basically, you shouldn't </span><span class="line" data-startTime="3475">worry about it. </span> <span class="line" data-startTime="3477">We should hopefully be able </span><span class="line" data-startTime="3477">to make it fast. </span> <span class="line" data-startTime="3480">Um, but as you've seen </span><span class="line" data-startTime="3480">with the techniques </span><span class="line" data-startTime="3482">that we used here, </span><span class="line" data-startTime="3484">we're kind of, uh, somehow </span><span class="line" data-startTime="3484">relying on user build to &mdash; </span><span class="line" data-startTime="3488">to do something </span><span class="line" data-startTime="3488">that's, like, well structured, </span><span class="line" data-startTime="3490">uses abstractions, </span><span class="line" data-startTime="3490">and does not, </span><span class="line" data-startTime="3493">like, uh, try </span><span class="line" data-startTime="3493">to be overly general </span><span class="line" data-startTime="3497">and try to have, like, code </span><span class="line" data-startTime="3497">that's, like, really using </span><span class="line" data-startTime="3500">a million different &mdash; </span><span class="line" data-startTime="3501">operating on a million </span><span class="line" data-startTime="3501">different types. </span></p>

<p><span class="line" data-startTime="3503">But, um, but that shouldn't </span><span class="line" data-startTime="3503">really be an issue </span><span class="line" data-startTime="3507">because in &mdash; </span><span class="line" data-startTime="3509">in most application code </span><span class="line" data-startTime="3509">that you write, </span><span class="line" data-startTime="3510">you might have parts </span><span class="line" data-startTime="3510">of the code that's like that </span><span class="line" data-startTime="3512">that's really generic </span><span class="line" data-startTime="3513">and then you have most </span><span class="line" data-startTime="3513">of your code, which is not. </span> <span class="line" data-startTime="3517">So basically, you shouldn't </span><span class="line" data-startTime="3517">have to worry about it. </span> <span class="line" data-startTime="3518">That should be, uh, </span><span class="line" data-startTime="3518">that should be us worrying. </span> <span class="line" data-startTime="3533">Oh. </span> <span class="line" data-startTime="3539">Okay, so, uh, </span><span class="line" data-startTime="3539">the question is if I can &mdash; </span><span class="line" data-startTime="3541">can give some information </span><span class="line" data-startTime="3543">about other browsers </span><span class="line" data-startTime="3543">that are starting to use &mdash; </span><span class="line" data-startTime="3546">that are using </span><span class="line" data-startTime="3546">these techniques </span><span class="line" data-startTime="3547">and, uh, also if it's being </span><span class="line" data-startTime="3547">fed back to WebKit. </span></p>

<p><span class="line" data-startTime="3551">Yeah. </span> <span class="line" data-startTime="3552">So, um... </span> <span class="line" data-startTime="3555">so, uh, </span><span class="line" data-startTime="3555">Apple's JavaScript engine, </span><span class="line" data-startTime="3559">I guess it's called Nitro </span><span class="line" data-startTime="3559">by now, </span><span class="line" data-startTime="3561">uh, is using </span><span class="line" data-startTime="3561">these techniques as well, </span><span class="line" data-startTime="3565">which is really cool. </span> <span class="line" data-startTime="3566">So I think that's &mdash; </span><span class="line" data-startTime="3566">that's great. </span> <span class="line" data-startTime="3568">And they're getting </span><span class="line" data-startTime="3568">great performance gains </span><span class="line" data-startTime="3570">the same way that we did </span><span class="line" data-startTime="3570">by using these techniques. </span> <span class="line" data-startTime="3572">So they use, uh, </span><span class="line" data-startTime="3572">what we call hidden classes </span><span class="line" data-startTime="3575">and inline caching as well. </span> <span class="line" data-startTime="3577">Uh, I think they call </span><span class="line" data-startTime="3577">their hidden classes </span><span class="line" data-startTime="3579">structure IDs or something </span><span class="line" data-startTime="3579">like that. </span></p>

<p><span class="line" data-startTime="3581">But they use </span><span class="line" data-startTime="3581">the same techniques, </span><span class="line" data-startTime="3582">which is really cool. </span> <span class="line" data-startTime="3583">Um, feeding it back </span><span class="line" data-startTime="3583">to WebKit, </span><span class="line" data-startTime="3585">yes, we are doing that </span><span class="line" data-startTime="3585">in the sense </span><span class="line" data-startTime="3588">that the binding layer, </span><span class="line" data-startTime="3588">so the &mdash; </span><span class="line" data-startTime="3591">the layer that binds V8 </span><span class="line" data-startTime="3591">into the DOM </span><span class="line" data-startTime="3595">is being upstreamed </span><span class="line" data-startTime="3595">to WebKit. </span> <span class="line" data-startTime="3597">So that actually lives </span><span class="line" data-startTime="3597">at WebKit now. </span> <span class="line" data-startTime="3599">Um, so hopefully it should be </span><span class="line" data-startTime="3599">fairly easy going forward </span><span class="line" data-startTime="3603">to use V8 instead of Nitro </span><span class="line" data-startTime="3603">if you want to in WebKit. </span> <span class="line" data-startTime="3608">man: Any &mdash; over here. </span> <span class="line" data-startTime="3608">Over here. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="3611"><span class="speakerName">Ager</span>: Oh, yes. </span><span class="line" data-startTime="3612">man: </span><span class="line" data-startTime="3612">Any performance boosts </span><span class="line" data-startTime="3614">to the lambda </span><span class="line" data-startTime="3614">functional closures </span><span class="line" data-startTime="3618">optimizing </span><span class="line" data-startTime="3618">the call stacks? </span></p>

<p class="speaker"><span class="line" data-starttime="3622"><span class="speakerName">Ager</span>: I'm not sure </span><span class="line" data-startTime="3622">I understand the question. </span><span class="line" data-startTime="3624">Could you repeat, please? </span><span class="line" data-startTime="3626">man: Is there </span><span class="line" data-startTime="3626">a performance boost </span><span class="line" data-startTime="3627">to the handling of the lambda </span><span class="line" data-startTime="3627">functions closures? </span></p>

<p class="speaker"><span class="line" data-starttime="3632"><span class="speakerName">Ager</span>: Oh, if we have </span><span class="line" data-startTime="3632">any performance boosts </span><span class="line" data-startTime="3634">on &mdash; on closures. </span> <span class="line" data-startTime="3636">Uh... </span> <span class="line" data-startTime="3639">so... </span> <span class="line" data-startTime="3641">well, basically, </span><span class="line" data-startTime="3641">I mean, that code is handled </span><span class="line" data-startTime="3643">like &mdash; like all other code. </span> <span class="line" data-startTime="3645">So it gets, like, </span><span class="line" data-startTime="3645">the same kind of benefits </span><span class="line" data-startTime="3646">that &mdash; that the rest </span><span class="line" data-startTime="3646">of the code does. </span> <span class="line" data-startTime="3648">So &mdash; so yes. </span> <span class="line" data-startTime="3654">So I think we're running </span><span class="line" data-startTime="3654">out of time. </span> <span class="line" data-startTime="3656">So &mdash; so I think </span><span class="line" data-startTime="3656">I should stop now. </span> <span class="line" data-startTime="3658">So you're all welcome </span><span class="line" data-startTime="3658">to come talk to me afterwards. </span> <span class="line" data-startTime="3661">So if you have other questions, </span><span class="line" data-startTime="3661">please come talk to me. </span> <span class="line" data-startTime="3665">[applause] </span></p>