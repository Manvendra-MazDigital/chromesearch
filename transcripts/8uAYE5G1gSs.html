<p class="speaker"><span class="line" data-starttime="0"><span class="speakerName">Colt McAnlis</span>: Hello everyone. </span><span class="line" data-startTime="3">Oh, come on guys. </span><span class="line" data-startTime="4">Look up from your pixels. </span><span class="line" data-startTime="6">Let's try this again. </span><span class="line" data-startTime="7">Hello everyone. </span></p>

<p class="speaker"><span class="line" data-starttime="8"><span class="speakerName">Audience</span>: Hello. </span></p>

<p class="speaker"><span class="line" data-starttime="9"><span class="speakerName">Colt McAnlis</span>: All right. </span> <span class="line" data-startTime="10">That's the type of pre-lunch </span><span class="line" data-startTime="10">enthusiasm I </span><span class="line" data-startTime="12">would expect on a Thursday. </span> <span class="line" data-startTime="14">I can't see all of your </span><span class="line" data-startTime="14">hangovers, that's good. </span> <span class="line" data-startTime="18">All right, hello everyone. </span> <span class="line" data-startTime="18">My name is Colt McAnlis. </span> <span class="line" data-startTime="20">I'm a developer advocate at </span><span class="line" data-startTime="20">Google working on Chrome. </span> <span class="line" data-startTime="23">And joining me today is the </span><span class="line" data-startTime="23">amazingly talented Grace </span><span class="line" data-startTime="26">Kloba, who happens to be </span><span class="line" data-startTime="26">the technical lead </span><span class="line" data-startTime="28">on Chrome for Android. </span> <span class="line" data-startTime="30">So all of the cool Chrome on </span><span class="line" data-startTime="30">mobile questions can go to her </span><span class="line" data-startTime="33">after the talk. </span></p>

<p><span class="line" data-startTime="34">But if you have questions </span><span class="line" data-startTime="34">about my shirt, </span><span class="line" data-startTime="35">that come to me. </span> <span class="line" data-startTime="36">What we're here today to talk </span><span class="line" data-startTime="36">to you about is how to </span><span class="line" data-startTime="39">supercharge your websites, both </span><span class="line" data-startTime="39">on mobile and on desktop, </span><span class="line" data-startTime="43">with the help of using the </span><span class="line" data-startTime="43">GPU and a lot of amazing </span><span class="line" data-startTime="46">intrinsics that we've put </span><span class="line" data-startTime="46">inside of Chrome. </span> <span class="line" data-startTime="49">Quick show of hands, how many </span><span class="line" data-startTime="49">of you attended the Jank </span><span class="line" data-startTime="51">Busters talk yesterday? </span><span class="line" data-startTime="54">Awesome, that's a good set. </span> <span class="line" data-startTime="55">That's a good set. </span> <span class="line" data-startTime="56">You can view the content that </span><span class="line" data-startTime="56">we're going to talk about </span><span class="line" data-startTime="57">today as a pairing of what Nat </span><span class="line" data-startTime="57">talked about yesterday. </span> <span class="line" data-startTime="62">Today we're going to talk about </span><span class="line" data-startTime="62">how to use the GPU to </span><span class="line" data-startTime="63">get awesome stuff done. </span> <span class="line" data-startTime="65">Now before we begin, I want </span><span class="line" data-startTime="65">to point you all to this </span><span class="line" data-startTime="67">beautiful perfmatters hashtag. </span></p>

<p><span class="line" data-startTime="69">Quick show of hands, how many </span><span class="line" data-startTime="69">of you have seen this on the </span><span class="line" data-startTime="71">interwebs so far? </span><span class="line" data-startTime="73">You all are my favorite </span><span class="line" data-startTime="73">people. </span> <span class="line" data-startTime="75">Hugs for everyone after that. </span> <span class="line" data-startTime="76">Come find me later. </span> <span class="line" data-startTime="77">If you see something today </span><span class="line" data-startTime="77">that inspires you, some </span><span class="line" data-startTime="79">statistic you didn't know, or </span><span class="line" data-startTime="79">some cool technique that you </span><span class="line" data-startTime="82">haven't heard of before, please </span><span class="line" data-startTime="82">feel free to go to your </span><span class="line" data-startTime="84">social media outlet </span><span class="line" data-startTime="84">of choice and use </span><span class="line" data-startTime="86">the perfmatters hashtag. </span> <span class="line" data-startTime="87">Spread the word. </span> <span class="line" data-startTime="88">Spread the love. </span> <span class="line" data-startTime="88">That's what we're all here </span><span class="line" data-startTime="88">at Google to do. </span> <span class="line" data-startTime="91">I'll quit wasting time </span><span class="line" data-startTime="91">at this point. </span> <span class="line" data-startTime="93">Let's dig into it. </span> <span class="line" data-startTime="94">Before we can talk about how the </span><span class="line" data-startTime="94">GPU is used to supercharge </span><span class="line" data-startTime="97">your website into awesome town, </span><span class="line" data-startTime="97">we first need to start </span><span class="line" data-startTime="100">with a little bit of history so </span><span class="line" data-startTime="100">that you can understand how </span><span class="line" data-startTime="103">Chrome actually draws </span><span class="line" data-startTime="103">your web page. </span> <span class="line" data-startTime="105">It all starts at the top with </span><span class="line" data-startTime="105">a very complex series of </span><span class="line" data-startTime="108">algorithms known as software </span><span class="line" data-startTime="108">rasterization. </span></p>

<p><span class="line" data-startTime="111">Effectively, this suite of </span><span class="line" data-startTime="111">tools, or algorithms and </span><span class="line" data-startTime="114">computation, is responsible </span><span class="line" data-startTime="114">for taking a high-order </span><span class="line" data-startTime="116">primitive, like this beautiful </span><span class="line" data-startTime="116">little glyph we have here, </span><span class="line" data-startTime="119">subdividing it into </span><span class="line" data-startTime="119">boundary pixels. </span> <span class="line" data-startTime="121">And then finally, adding </span><span class="line" data-startTime="121">color to it and </span><span class="line" data-startTime="123">pushing it to your screen. </span> <span class="line" data-startTime="125">So we can actually subdivide it, </span><span class="line" data-startTime="125">add some color to it, and </span><span class="line" data-startTime="128">you can see that this is </span><span class="line" data-startTime="128">programmer art, so, of course, </span><span class="line" data-startTime="130">my at symbol is very, </span><span class="line" data-startTime="130">very pixelated. </span> <span class="line" data-startTime="132">Now Chrome will use this </span><span class="line" data-startTime="132">concept of software </span><span class="line" data-startTime="135">rasterization as your </span><span class="line" data-startTime="135">page is loaded. </span> <span class="line" data-startTime="137">Chrome loads your page. </span> <span class="line" data-startTime="139">It'll actually go through and </span><span class="line" data-startTime="139">software rasterize everything </span><span class="line" data-startTime="141">you see, so all of the glyphs </span><span class="line" data-startTime="141">that you see, your images, the </span><span class="line" data-startTime="144">small text, the lines on the </span><span class="line" data-startTime="144">screen, the borders, the </span><span class="line" data-startTime="147">rounded edges, the </span><span class="line" data-startTime="147">drop shadows. </span></p>

<p><span class="line" data-startTime="149">This is all being pushed </span><span class="line" data-startTime="149">through the software </span><span class="line" data-startTime="151">rasterization path into </span><span class="line" data-startTime="151">a single large bitmap. </span> <span class="line" data-startTime="154">And then what happens is, as you </span><span class="line" data-startTime="154">scroll, what Chrome will </span><span class="line" data-startTime="157">do is it'll do the smart thing </span><span class="line" data-startTime="157">and it'll actually go through </span><span class="line" data-startTime="160">a series of memory copy </span><span class="line" data-startTime="160">operations and effectively </span><span class="line" data-startTime="163">take all of those lines, the </span><span class="line" data-startTime="163">scan lines in the bitmap, and </span><span class="line" data-startTime="166">mem copy them to a position </span><span class="line" data-startTime="166">that's higher in the bitmap. </span> <span class="line" data-startTime="169">And then it'll go back through </span><span class="line" data-startTime="169">and only software rasterize </span><span class="line" data-startTime="172">what hasn't been seen </span><span class="line" data-startTime="172">on the page. </span></p>

<p><span class="line" data-startTime="174">This, of course, means </span><span class="line" data-startTime="174">that Chrome is </span><span class="line" data-startTime="175">doing the smart thing. </span> <span class="line" data-startTime="176">It's not spending all of its </span><span class="line" data-startTime="176">time software rasterizing divs </span><span class="line" data-startTime="179">as they're positioned </span><span class="line" data-startTime="179">on the page. </span> <span class="line" data-startTime="180">It's only updating what is </span><span class="line" data-startTime="180">new and what is awesome. </span></p>

<p class="speaker"><span class="line" data-starttime="185"><span class="speakerName">Grace Kloba</span>: So it's </span><span class="line" data-startTime="185">2013, right? </span><span class="line" data-startTime="187">Most of the sites has animation, </span><span class="line" data-startTime="187">transition, to make </span><span class="line" data-startTime="190">it look good. </span> <span class="line" data-startTime="192">So what is animation? </span><span class="line" data-startTime="194">It's essentially bits update </span><span class="line" data-startTime="194">to the screen constantly to </span><span class="line" data-startTime="198">make it feel like a movie. </span> <span class="line" data-startTime="200">So let's take a look </span><span class="line" data-startTime="200">at this example. </span> <span class="line" data-startTime="203">We have this rubber duck </span><span class="line" data-startTime="203">animated through the river to </span><span class="line" data-startTime="208">the other side. </span> <span class="line" data-startTime="209">So for every frame, we </span><span class="line" data-startTime="209">have to move the </span><span class="line" data-startTime="211">duck to a new location. </span> <span class="line" data-startTime="215">This means for every frame, we </span><span class="line" data-startTime="215">have to paint to the duck in </span><span class="line" data-startTime="218">the new location with </span><span class="line" data-startTime="218">a new background. </span></p>

<p><span class="line" data-startTime="221">And then go back to where </span><span class="line" data-startTime="221">the duck used to be and </span><span class="line" data-startTime="224">then erase the duck. </span> <span class="line" data-startTime="226">And [INAUDIBLE] </span><span class="line" data-startTime="228">just clean background. </span> <span class="line" data-startTime="231">Essentially, for every </span><span class="line" data-startTime="231">frame, we have to </span><span class="line" data-startTime="234">paint these two regions. </span> <span class="line" data-startTime="237">And there's a new trend, </span><span class="line" data-startTime="237">the retina display. </span> <span class="line" data-startTime="241">So it makes the display look </span><span class="line" data-startTime="241">pretty because it doubles the </span><span class="line" data-startTime="245">screen resolution, which </span><span class="line" data-startTime="245">quadruples the number of the </span><span class="line" data-startTime="248">pixels pushed onto the screen. </span> <span class="line" data-startTime="251">So Colt mentioned earlier during </span><span class="line" data-startTime="251">the scrolling for every </span><span class="line" data-startTime="254">frame we do a mem copy. </span> <span class="line" data-startTime="257">That's not free. </span> <span class="line" data-startTime="259">It's even not cheap with the </span><span class="line" data-startTime="259">retina display because we're </span><span class="line" data-startTime="263">pushing quadruple number of the </span><span class="line" data-startTime="263">pixel to the screen while </span><span class="line" data-startTime="267">the memory bus speed </span><span class="line" data-startTime="267">hasn't caught up. </span> <span class="line" data-startTime="269">And in the animation case, for </span><span class="line" data-startTime="269">every frame we have to paint </span><span class="line" data-startTime="274">the two regions. </span></p>

<p><span class="line" data-startTime="275">So now that region is quadruple </span><span class="line" data-startTime="275">the size, which </span><span class="line" data-startTime="278">means a much longer </span><span class="line" data-startTime="278">paint times. </span> <span class="line" data-startTime="281">So if we look at the chart, </span><span class="line" data-startTime="281">the number keep going up. </span> <span class="line" data-startTime="285">It's not coming down anytime </span><span class="line" data-startTime="285">soon, at least I was not told. </span> <span class="line" data-startTime="289">So Colt, what do we do? </span></p>

<p class="speaker"><span class="line" data-starttime="291"><span class="speakerName">Colt McAnlis</span>: Well, you see, </span><span class="line" data-startTime="291">because these things keep </span><span class="line" data-startTime="293">getting larger and larger and </span><span class="line" data-startTime="293">larger, we have to take </span><span class="line" data-startTime="295">advantage of the hardware that's </span><span class="line" data-startTime="295">resident on the system. </span> <span class="line" data-startTime="297">So everyone should have </span><span class="line" data-startTime="297">pixels by now. </span> <span class="line" data-startTime="299">I see most of you </span><span class="line" data-startTime="299">typing on them. </span> <span class="line" data-startTime="300">And everyone should have one </span><span class="line" data-startTime="300">of these beautiful little </span><span class="line" data-startTime="302">phones in your pocket as well. </span> <span class="line" data-startTime="304">All of these contain one common </span><span class="line" data-startTime="304">element, is they have a </span><span class="line" data-startTime="307">new piece of hardware &mdash; well, </span><span class="line" data-startTime="307">an old piece of hardware </span><span class="line" data-startTime="308">really &mdash; called a graphics </span><span class="line" data-startTime="308">processing unit, or a GPU. </span></p>

<p><span class="line" data-startTime="312">Now, GPUs were actually created </span><span class="line" data-startTime="312">in the mid to late </span><span class="line" data-startTime="315">'90s to effectively help with </span><span class="line" data-startTime="315">a concept of software </span><span class="line" data-startTime="318">rasterization needed for </span><span class="line" data-startTime="318">games and boring </span><span class="line" data-startTime="320">stuff like CAD software. </span> <span class="line" data-startTime="322">Effectively, architects came </span><span class="line" data-startTime="322">together and created dedicated </span><span class="line" data-startTime="325">hardware to do software </span><span class="line" data-startTime="325">rasterization. </span> <span class="line" data-startTime="327">And then we started calling </span><span class="line" data-startTime="327">it hardware </span><span class="line" data-startTime="329">rasterization after that. </span> <span class="line" data-startTime="330">These GPUs super excel at doing </span><span class="line" data-startTime="330">software rasterization. </span> <span class="line" data-startTime="334">They are amazingly capable </span><span class="line" data-startTime="334">to push pixels </span><span class="line" data-startTime="338">around on the screen. </span> <span class="line" data-startTime="338">They do it better than anything </span><span class="line" data-startTime="338">else we have out on </span><span class="line" data-startTime="341">the market today. </span> <span class="line" data-startTime="342">So the cool thing is that if the </span><span class="line" data-startTime="342">GPU is actually the best </span><span class="line" data-startTime="345">at moving pixels and doing </span><span class="line" data-startTime="345">software rasterization, the </span><span class="line" data-startTime="347">question for Chrome is, how do </span><span class="line" data-startTime="347">we utilize this piece of </span><span class="line" data-startTime="350">hardware to make your webpages </span><span class="line" data-startTime="350">render faster? </span><span class="line" data-startTime="353">Now, as we already talked about, </span><span class="line" data-startTime="353">you can look at our </span><span class="line" data-startTime="357">upload diagram in a hierarchical </span><span class="line" data-startTime="357">view of this. </span></p>

<p><span class="line" data-startTime="360">So we start with our </span><span class="line" data-startTime="360">page layout. </span> <span class="line" data-startTime="361">And that, of course, is </span><span class="line" data-startTime="361">rasterized by the CPU. </span> <span class="line" data-startTime="364">Then every frame that you make </span><span class="line" data-startTime="364">small updates, the CPU is </span><span class="line" data-startTime="366">responsible for updating </span><span class="line" data-startTime="366">and presenting those </span><span class="line" data-startTime="368">pixels to the screen. </span> <span class="line" data-startTime="370">Now this means that there's a </span><span class="line" data-startTime="370">lot of work going on in the </span><span class="line" data-startTime="372">CPU as you do small scrolls, </span><span class="line" data-startTime="372">big scrolls, and then </span><span class="line" data-startTime="374">animations over the page. </span> <span class="line" data-startTime="377">Because of the fact of that </span><span class="line" data-startTime="377">the GPU is actually really </span><span class="line" data-startTime="379">good at pushing pixels, it makes </span><span class="line" data-startTime="379">sense then that we can </span><span class="line" data-startTime="381">insert the GPU between the CPU </span><span class="line" data-startTime="381">and the actual monitor. </span> <span class="line" data-startTime="384">So this means that the CPU can </span><span class="line" data-startTime="384">do a single upload the GPU and </span><span class="line" data-startTime="387">allow the GPU to handle </span><span class="line" data-startTime="387">finalized positioning on the </span><span class="line" data-startTime="390">screen on your behalf. </span> <span class="line" data-startTime="392">This reduces the overall amount </span><span class="line" data-startTime="392">of CPU work that has to </span><span class="line" data-startTime="394">be done rendering your </span><span class="line" data-startTime="394">pages a lot faster. </span></p>

<p><span class="line" data-startTime="398">Clicky. </span> <span class="line" data-startTime="400">Ah, there we go. </span></p>

<p class="speaker"><span class="line" data-starttime="402"><span class="speakerName">Grace Kloba</span>: So recalling the </span><span class="line" data-startTime="402">CPU mode, we allocate one big </span><span class="line" data-startTime="405">bitmap to cover the entire </span><span class="line" data-startTime="405">visible regions. </span> <span class="line" data-startTime="410">In the GPU mode, we divided the </span><span class="line" data-startTime="410">page into smaller tiles. </span> <span class="line" data-startTime="414">And each tile is cached in the </span><span class="line" data-startTime="414">GPU memory as a texture. </span> <span class="line" data-startTime="420">So let's reexamine the case </span><span class="line" data-startTime="420">where we scroll the page. </span> <span class="line" data-startTime="426">When the page is first loaded, </span><span class="line" data-startTime="426">we allocate enough number of </span><span class="line" data-startTime="430">the tiles to cover the </span><span class="line" data-startTime="430">visible areas. </span> <span class="line" data-startTime="434">And then when the page is </span><span class="line" data-startTime="434">scrolling down, some of the </span><span class="line" data-startTime="436">tiles from the previous frame </span><span class="line" data-startTime="436">are still visible. </span> <span class="line" data-startTime="440">But they are drawn in a </span><span class="line" data-startTime="440">different position relative to </span><span class="line" data-startTime="443">the window of the screen. </span> <span class="line" data-startTime="447">So one key difference </span><span class="line" data-startTime="447">here is we can't </span><span class="line" data-startTime="450">read off the mem copy. </span></p>

<p><span class="line" data-startTime="452">So retina display, nice and </span><span class="line" data-startTime="452">we are fine with it. </span> <span class="line" data-startTime="457">Similar as a software rendering </span><span class="line" data-startTime="457">mode, there will be </span><span class="line" data-startTime="460">new content to show. </span> <span class="line" data-startTime="461">And then we just allocate the </span><span class="line" data-startTime="461">new tiles, render them in the </span><span class="line" data-startTime="465">CPU, and upload them to </span><span class="line" data-startTime="465">the GPU textures. </span> <span class="line" data-startTime="469">Some of the old tiles from </span><span class="line" data-startTime="469">the previous frame </span><span class="line" data-startTime="472">now they are invisible. </span> <span class="line" data-startTime="474">If there's enough GPU memory, </span><span class="line" data-startTime="474">we leave them in the cache. </span> <span class="line" data-startTime="477">So if the page is scrolling up, </span><span class="line" data-startTime="477">they will be visible and </span><span class="line" data-startTime="481">we have them right away. </span> <span class="line" data-startTime="483">There's no need to </span><span class="line" data-startTime="483">do a CPU paint. </span></p>

<p><span class="line" data-startTime="486">If you continue scrolling down, </span><span class="line" data-startTime="486">at some point we're </span><span class="line" data-startTime="490">going to run out </span><span class="line" data-startTime="490">of GPU memory. </span> <span class="line" data-startTime="492">What happens is we go back to </span><span class="line" data-startTime="492">the oldest tiles, which user </span><span class="line" data-startTime="498">hasn't seen for a while, </span><span class="line" data-startTime="498">and we recycle them. </span> <span class="line" data-startTime="501">This means if those tiles will </span><span class="line" data-startTime="501">be visible again, we have to </span><span class="line" data-startTime="505">go back to the CPU to paint them </span><span class="line" data-startTime="505">and upload them to the </span><span class="line" data-startTime="508">GPU texture. </span> <span class="line" data-startTime="510">So the amount of the GPU memory </span><span class="line" data-startTime="510">available is really </span><span class="line" data-startTime="514">device dependent. </span> <span class="line" data-startTime="515">The goal for us is to keep as </span><span class="line" data-startTime="515">much as possible in the GPU </span><span class="line" data-startTime="519">memory, so when user interacting </span><span class="line" data-startTime="519">with a page, we </span><span class="line" data-startTime="523">can avoid going to </span><span class="line" data-startTime="523">the CPU to paint. </span> <span class="line" data-startTime="527">Before we move on to the next </span><span class="line" data-startTime="527">topic, I want to mention, </span><span class="line" data-startTime="532">Chrome can also do </span><span class="line" data-startTime="532">pre-painting. </span> <span class="line" data-startTime="535">So earlier, I mentioned when the </span><span class="line" data-startTime="535">page is the first loaded </span><span class="line" data-startTime="538">Chrome allocates enough tiles </span><span class="line" data-startTime="538">for the visible areas. </span></p>

<p><span class="line" data-startTime="542">During the idle cycle, we </span><span class="line" data-startTime="542">proactively paint the area </span><span class="line" data-startTime="546">just outside of the </span><span class="line" data-startTime="546">visible region. </span> <span class="line" data-startTime="550">And this prediction also </span><span class="line" data-startTime="550">is gesture aware. </span> <span class="line" data-startTime="554">So for example, if you're </span><span class="line" data-startTime="554">scrolling down a page, the </span><span class="line" data-startTime="557">pre-paint will pre-paint the </span><span class="line" data-startTime="557">area below the current visible </span><span class="line" data-startTime="562">area because that's the </span><span class="line" data-startTime="562">direction going. </span></p>

<p class="speaker"><span class="line" data-starttime="568"><span class="speakerName">Colt McAnlis</span>: So this is really </span><span class="line" data-startTime="568">cool for scrolling, but </span><span class="line" data-startTime="570">it actually puts us in a little </span><span class="line" data-startTime="570">bit of a bind when we </span><span class="line" data-startTime="571">start talking about </span><span class="line" data-startTime="571">the same duck </span><span class="line" data-startTime="573">animation as we saw before. </span> <span class="line" data-startTime="574">By the way, ducks should be </span><span class="line" data-startTime="574">the new animation thing in </span><span class="line" data-startTime="576">presentations, in my </span><span class="line" data-startTime="576">personal opinion. </span> <span class="line" data-startTime="578">I'm going to start </span><span class="line" data-startTime="578">this movement. </span> <span class="line" data-startTime="579">Too many people put cats </span><span class="line" data-startTime="579">in their slides. </span> <span class="line" data-startTime="581">I really think ducks are ready </span><span class="line" data-startTime="581">for a comeback, especially if </span><span class="line" data-startTime="583">you've ever been bitten </span><span class="line" data-startTime="583">by a duck. </span> <span class="line" data-startTime="584">Actually it hurts a lot. </span> <span class="line" data-startTime="586">Anyhow, as we have the duck &mdash; </span><span class="line" data-startTime="587">that's my aside, right? </span><span class="line" data-startTime="588">We got time. </span> <span class="line" data-startTime="588">We got plenty of time. </span> <span class="line" data-startTime="590">Story time with Colt. </span> <span class="line" data-startTime="591">You can hashtag that. </span> <span class="line" data-startTime="592">That'll be fun. </span> <span class="line" data-startTime="593">Anyhow, as the duck is actually </span><span class="line" data-startTime="593">flowing across the </span><span class="line" data-startTime="595">pond here, we run </span><span class="line" data-startTime="595">into a problem. </span></p>

<p><span class="line" data-startTime="597">Where before, in the software </span><span class="line" data-startTime="597">mode, we would actually </span><span class="line" data-startTime="600">rasterize the regions that </span><span class="line" data-startTime="600">were dirtied by the duck </span><span class="line" data-startTime="603">moving around, we now actually </span><span class="line" data-startTime="603">have to rasterize more pixels </span><span class="line" data-startTime="607">because we have to redraw </span><span class="line" data-startTime="607">the entire tile that's </span><span class="line" data-startTime="610">touched by the duck. </span> <span class="line" data-startTime="611">So as you can see here, we have </span><span class="line" data-startTime="611">the duck moving from a </span><span class="line" data-startTime="613">one by two over to </span><span class="line" data-startTime="613">a two by two. </span> <span class="line" data-startTime="615">We have to redo all of </span><span class="line" data-startTime="615">those tiles at once. </span> <span class="line" data-startTime="618">So we're touching a lot more </span><span class="line" data-startTime="618">pixels during our animation. </span></p>

<p><span class="line" data-startTime="620">So this means the GPU tiles </span><span class="line" data-startTime="620">can actually get us </span><span class="line" data-startTime="622">into a bit of a bind. </span> <span class="line" data-startTime="625">Clicky. </span> <span class="line" data-startTime="627">Clicky. </span> <span class="line" data-startTime="629">Hashtag clicky. </span> <span class="line" data-startTime="630">There you go. </span> <span class="line" data-startTime="631">Can you do it for me? </span><span class="line" data-startTime="637">I think we just broke </span><span class="line" data-startTime="637">the internet. </span> <span class="line" data-startTime="640">Anyone? </span><span class="line" data-startTime="640">Can anyone fix the internet? </span><span class="line" data-startTime="647">You are all tweeting </span><span class="line" data-startTime="647">right now. </span> <span class="line" data-startTime="648">That's the problem. </span> <span class="line" data-startTime="650">You are all going </span><span class="line" data-startTime="650">and tweeting. </span> <span class="line" data-startTime="651">You're hashtagging. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="652"><span class="speakerName">Audience</span>: Don't you </span><span class="line" data-startTime="652">mean Google+? </span></p>

<p class="speaker"><span class="line" data-starttime="654"><span class="speakerName">Colt McAnlis</span>: Google+'ing, </span><span class="line" data-startTime="654">thank you. </span><span class="line" data-startTime="655">Actually, thank you for that. </span><span class="line" data-startTime="661">OK. </span><span class="line" data-startTime="665">I can reboot it. </span><span class="line" data-startTime="666">That might work. </span><span class="line" data-startTime="668">Maybe I should install Vista. </span><span class="line" data-startTime="668">That'll actually help too. </span><span class="line" data-startTime="675">Or did we freeze? </span><span class="line" data-startTime="679">I'm going to do a song </span><span class="line" data-startTime="679">and dance while he </span><span class="line" data-startTime="680">tries to fix this. </span><span class="line" data-startTime="681">What do you want on here? </span></p>

<p class="speaker"><span class="line" data-starttime="682"><span class="speakerName">Audience</span>: What's that? </span></p>

<p class="speaker"><span class="line" data-starttime="683"><span class="speakerName">Colt McAnlis</span>: What do you </span><span class="line" data-startTime="683">want me to click here? </span></p>

<p class="speaker"><span class="line" data-starttime="684"><span class="speakerName">Audience</span>: So go into </span><span class="line" data-startTime="684">the movie. </span></p>

<p class="speaker"><span class="line" data-starttime="688"><span class="speakerName">Colt McAnlis</span>: He's going </span><span class="line" data-startTime="688">to fix this. </span> <span class="line" data-startTime="690">I'm going to tell some great </span><span class="line" data-startTime="690">stories about rasterization </span><span class="line" data-startTime="691">real quick. </span> <span class="line" data-startTime="692">So for those of you who don't </span><span class="line" data-startTime="692">know, who haven't been over to </span><span class="line" data-startTime="694">the Chrome booth yet, we </span><span class="line" data-startTime="694">actually have an entire area </span><span class="line" data-startTime="696">there dedicated to </span><span class="line" data-startTime="696">performance. </span> <span class="line" data-startTime="698">So a lot of you web developers </span><span class="line" data-startTime="698">out here who are running into </span><span class="line" data-startTime="700">problems with compute processes, </span><span class="line" data-startTime="700">rendering issues, </span><span class="line" data-startTime="703">or even network load times, </span><span class="line" data-startTime="703">please come by </span><span class="line" data-startTime="705">and stop by the booth. </span> <span class="line" data-startTime="706">Talk to us. </span> <span class="line" data-startTime="707">We've got pretty much all of </span><span class="line" data-startTime="707">the genius brains of Google </span><span class="line" data-startTime="710">who work on performance day and </span><span class="line" data-startTime="710">night there waiting to ask </span><span class="line" data-startTime="714">you questions, and to answer </span><span class="line" data-startTime="714">your problems, and to run your </span><span class="line" data-startTime="716">site through our tools, </span><span class="line" data-startTime="716">and to solve all </span><span class="line" data-startTime="718">sorts of critical things. </span> <span class="line" data-startTime="720">Still need more time? </span><span class="line" data-startTime="721">Cool. </span> <span class="line" data-startTime="721">I can keep doing this. </span></p>

<p><span class="line" data-startTime="722">All right, so for too long, </span><span class="line" data-startTime="722">we've actually been spending a </span><span class="line" data-startTime="724">lot of time talking about </span><span class="line" data-startTime="724">network or web performance in </span><span class="line" data-startTime="728">just terms of page wait. </span> <span class="line" data-startTime="730">So we're very concerned </span><span class="line" data-startTime="730">about load time. </span> <span class="line" data-startTime="732">But as we've started getting </span><span class="line" data-startTime="732">more web apps on mobile and </span><span class="line" data-startTime="735">web apps doing crazy things, we </span><span class="line" data-startTime="735">realized that the wait that </span><span class="line" data-startTime="739">the user experiences your app </span><span class="line" data-startTime="739">while they're inside of it </span><span class="line" data-startTime="741">actually has a large &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="745"><span class="speakerName">Grace Kloba</span>: We're back. </span></p>

<p class="speaker"><span class="line" data-starttime="745"><span class="speakerName">Colt McAnlis</span>: We're back? </span><span class="line" data-startTime="746">Oh, well I was in the </span><span class="line" data-startTime="746">middle of something. </span><span class="line" data-startTime="747">Hold on. </span><span class="line" data-startTime="748">Hold on. </span><span class="line" data-startTime="748">Wait, no, I'm not done yet. </span></p>

<p class="speaker"><span class="line" data-starttime="749"><span class="speakerName">Grace Kloba</span>: OK. </span></p>

<p class="speaker"><span class="line" data-starttime="749"><span class="speakerName">Colt McAnlis</span>: We realized that </span><span class="line" data-startTime="749">how the user experiences your </span><span class="line" data-startTime="752">app inside of it actually has </span><span class="line" data-startTime="752">a lot to do with how much </span><span class="line" data-startTime="754">money they're willing to spend </span><span class="line" data-startTime="754">and how much you get from that </span><span class="line" data-startTime="756">user in terms of retention. </span> <span class="line" data-startTime="758">So this means that we have to </span><span class="line" data-startTime="758">start worrying about the other </span><span class="line" data-startTime="760">factors too, things like compute </span><span class="line" data-startTime="760">performance and render </span><span class="line" data-startTime="762">performance, which brings us </span><span class="line" data-startTime="762">back to how we can utilize the </span><span class="line" data-startTime="766">GPU to get awesome stuff done. </span> <span class="line" data-startTime="770">Did I break it again? </span><span class="line" data-startTime="771">Maybe it's my clicker. </span> <span class="line" data-startTime="773">There we go. </span> <span class="line" data-startTime="774">OK, so to rehash, after a five </span><span class="line" data-startTime="774">minute soliloquy, we have this </span><span class="line" data-startTime="779">duck effectively moving </span><span class="line" data-startTime="779">to the screen. </span> <span class="line" data-startTime="780">It would be ideal if we </span><span class="line" data-startTime="780">could effectively </span><span class="line" data-startTime="782">know the context here. </span></p>

<p><span class="line" data-startTime="784">Is that we have the duck </span><span class="line" data-startTime="784">moving and we have the </span><span class="line" data-startTime="785">background static. </span> <span class="line" data-startTime="787">It would great if we could </span><span class="line" data-startTime="787">somehow separate these two </span><span class="line" data-startTime="789">items so that the GPU can handle </span><span class="line" data-startTime="789">positioning of the duck </span><span class="line" data-startTime="792">and we won't have to use all </span><span class="line" data-startTime="792">of the extra CPU cycles </span><span class="line" data-startTime="795">painting the duck in position. </span> <span class="line" data-startTime="798">And this is actually what we </span><span class="line" data-startTime="798">can do inside of Chrome. </span> <span class="line" data-startTime="800">We actually allow some </span><span class="line" data-startTime="800">annotations and some </span><span class="line" data-startTime="802">intrinsics that you can add to </span><span class="line" data-startTime="802">your page that allow you to </span><span class="line" data-startTime="805">separate page elements into </span><span class="line" data-startTime="805">separate GPU layers. </span> <span class="line" data-startTime="809">What this means is that </span><span class="line" data-startTime="809">effectively each layer has its </span><span class="line" data-startTime="811">own set of tiles. </span> <span class="line" data-startTime="812">They're uploaded once </span><span class="line" data-startTime="812">to the GPU. </span> <span class="line" data-startTime="814">And then the GPU can position </span><span class="line" data-startTime="814">these things around without </span><span class="line" data-startTime="816">any interaction in the CPU. </span> <span class="line" data-startTime="818">Of course, this turbo charges </span><span class="line" data-startTime="818">the duck in their animation </span><span class="line" data-startTime="821">allowing it to do awesome stuff </span><span class="line" data-startTime="821">through the screen. </span></p>

<p><span class="line" data-startTime="822">And it allows the CPU to sit </span><span class="line" data-startTime="822">back and drink margaritas and </span><span class="line" data-startTime="825">basically chill out </span><span class="line" data-startTime="825">while the GPU does </span><span class="line" data-startTime="826">all the heavy lifting. </span> <span class="line" data-startTime="833">Sorry, we're having fun </span><span class="line" data-startTime="833">technical problems. </span> <span class="line" data-startTime="835">What kind of conference would </span><span class="line" data-startTime="835">this be if you don't get a </span><span class="line" data-startTime="837">blue screen while installing </span><span class="line" data-startTime="837">printer software? </span><span class="line" data-startTime="839">Anyhow, so this is how the </span><span class="line" data-startTime="839">GPU stuff is working. </span> <span class="line" data-startTime="842">Now let's actually talk about </span><span class="line" data-startTime="842">how you, as a developer, can </span><span class="line" data-startTime="844">control all of these things. </span></p>

<p><span class="line" data-startTime="846">First, it's worth pointing out </span><span class="line" data-startTime="846">that there's a set of page </span><span class="line" data-startTime="848">elements that are auto promoted </span><span class="line" data-startTime="848">to their own layer </span><span class="line" data-startTime="852">once your HTML is parsed and </span><span class="line" data-startTime="852">your page is loaded. </span> <span class="line" data-startTime="855">Depending on your platform, </span><span class="line" data-startTime="855">and your build, and your </span><span class="line" data-startTime="857">hardware spec, things like </span><span class="line" data-startTime="857">canvas, video, iframe, and </span><span class="line" data-startTime="860">plug-ins are all promoted </span><span class="line" data-startTime="860">to their own </span><span class="line" data-startTime="862">layer on your behalf. </span> <span class="line" data-startTime="863">You don't have to do anything. </span> <span class="line" data-startTime="864">And this is fantastic because </span><span class="line" data-startTime="864">most the time these type of </span><span class="line" data-startTime="866">page elements spend their </span><span class="line" data-startTime="866">entirety updating large </span><span class="line" data-startTime="869">portions of the screen. </span> <span class="line" data-startTime="871">They could be overlapping </span><span class="line" data-startTime="871">with other tiles. </span></p>

<p><span class="line" data-startTime="872">Recall the animation </span><span class="line" data-startTime="872">that you saw with </span><span class="line" data-startTime="874">the duck moving around. </span> <span class="line" data-startTime="875">So we're spending lots of times </span><span class="line" data-startTime="875">updating and rasterizing </span><span class="line" data-startTime="877">pixels we don't actually </span><span class="line" data-startTime="877">need to. </span></p>

<p class="speaker"><span class="line" data-starttime="880"><span class="speakerName">Grace Kloba</span>: There is also a </span><span class="line" data-startTime="880">set of the CSS properties </span><span class="line" data-startTime="883">which will manually </span><span class="line" data-startTime="883">promote the page </span><span class="line" data-startTime="885">element to its own layer. </span><span class="line" data-startTime="888">For example, all the 3D </span><span class="line" data-startTime="888">Transform, like TranslateZ, </span><span class="line" data-startTime="892">Translate3D. </span><span class="line" data-startTime="894">This making sense because these </span><span class="line" data-startTime="894">transforms can be easily </span><span class="line" data-startTime="898">accelerated on the GPU. </span><span class="line" data-startTime="901">It's worth noting the 2D </span><span class="line" data-startTime="901">transform does not promote the </span><span class="line" data-startTime="906">element to its own layer, which </span><span class="line" data-startTime="906">means they will be still </span><span class="line" data-startTime="909">rendered in the software mode. </span></p>

<p class="speaker"><span class="line" data-starttime="914"><span class="speakerName">Colt McAnlis</span>: Now those two </span><span class="line" data-startTime="914">examples are effectively load </span><span class="line" data-startTime="917">time modifications. </span> <span class="line" data-startTime="918">So effectively, you parse the </span><span class="line" data-startTime="918">page elements, or you parse </span><span class="line" data-startTime="921">the page, and these things are </span><span class="line" data-startTime="921">auto promoted on your behalf. </span> <span class="line" data-startTime="924">It's worth pointing out that </span><span class="line" data-startTime="924">there's a set of CSS </span><span class="line" data-startTime="926">properties that allow you to </span><span class="line" data-startTime="926">push things to a separate </span><span class="line" data-startTime="929">layer at run time. </span> <span class="line" data-startTime="930">And the two tags you need to </span><span class="line" data-startTime="930">be concerned with are CSS </span><span class="line" data-startTime="934">animations for opacity </span><span class="line" data-startTime="934">and transform. </span> <span class="line" data-startTime="936">How these effectively work is </span><span class="line" data-startTime="936">that when the page loads, an </span><span class="line" data-startTime="939">element on the page will stay </span><span class="line" data-startTime="939">static with the base layer. </span> <span class="line" data-startTime="941">Once the animation begins, the </span><span class="line" data-startTime="941">element in question will </span><span class="line" data-startTime="945">actually be promoted </span><span class="line" data-startTime="945">to its own layer. </span> <span class="line" data-startTime="948">So the CPU has to spin up, </span><span class="line" data-startTime="948">create a new layer, paint the </span><span class="line" data-startTime="951">data into the new layer, as </span><span class="line" data-startTime="951">well as go back and paint </span><span class="line" data-startTime="954">where the object used to </span><span class="line" data-startTime="954">be in the base layer. </span></p>

<p><span class="line" data-startTime="956">Then as the animation occurs, </span><span class="line" data-startTime="956">the GPU and the CPU are </span><span class="line" data-startTime="959">working in harmony creating </span><span class="line" data-startTime="959">happy ducks through the </span><span class="line" data-startTime="962">universe in a plethora of all </span><span class="line" data-startTime="962">the quacks that you hear </span><span class="line" data-startTime="964">through the cosmos. </span> <span class="line" data-startTime="965">And then at the end of the </span><span class="line" data-startTime="965">animation, the duck then has </span><span class="line" data-startTime="968">to be promoted back to the </span><span class="line" data-startTime="968">base layer where it &mdash; </span><span class="line" data-startTime="974">there we go. </span> <span class="line" data-startTime="974">Maybe it's my clicker. </span> <span class="line" data-startTime="975">The duck has to be demoted back </span><span class="line" data-startTime="975">to the base layer, which </span><span class="line" data-startTime="978">means we have to kill the </span><span class="line" data-startTime="978">original layer we had and then </span><span class="line" data-startTime="981">rerasterize the area where </span><span class="line" data-startTime="981">the duck finally lands. </span> <span class="line" data-startTime="986">I'm just going to let you click </span><span class="line" data-startTime="986">everything from now on. </span></p>

<p><span class="line" data-startTime="988">Of course, this means </span><span class="line" data-startTime="988">that we run into </span><span class="line" data-startTime="990">some interesting concepts. </span> <span class="line" data-startTime="991">So if we start an animation and </span><span class="line" data-startTime="991">all of a sudden we see a </span><span class="line" data-startTime="993">hitch in our performance, this </span><span class="line" data-startTime="993">means that the CPU may be </span><span class="line" data-startTime="997">doing too much work and actually </span><span class="line" data-startTime="997">firing up, doing </span><span class="line" data-startTime="999">rasterization, and moving on. </span> <span class="line" data-startTime="1003">Which means of course we have </span><span class="line" data-startTime="1003">to start talking about well, </span><span class="line" data-startTime="1005">why isn't everything in a </span><span class="line" data-startTime="1005">layer and what are the </span><span class="line" data-startTime="1007">consequences and tradeoffs </span><span class="line" data-startTime="1007">of doing that? </span><span class="line" data-startTime="1009">Well the first off thing is you </span><span class="line" data-startTime="1009">shouldn't put everything </span><span class="line" data-startTime="1010">in its own layer. </span></p>

<p><span class="line" data-startTime="1011">Even though the GPU can move </span><span class="line" data-startTime="1011">these things around and </span><span class="line" data-startTime="1013">position them, there's actually </span><span class="line" data-startTime="1013">some consequences you </span><span class="line" data-startTime="1015">should be aware of. </span> <span class="line" data-startTime="1016">First off, is the cost </span><span class="line" data-startTime="1016">of too many layers. </span> <span class="line" data-startTime="1019">You need to know that each layer </span><span class="line" data-startTime="1019">you put on the screen </span><span class="line" data-startTime="1021">effectively creates </span><span class="line" data-startTime="1021">more tiles. </span> <span class="line" data-startTime="1023">And as Grace mentioned before, </span><span class="line" data-startTime="1023">the GPU has a static </span><span class="line" data-startTime="1026">non-growable memory resource </span><span class="line" data-startTime="1026">in its texture cache. </span> <span class="line" data-startTime="1030">So what happens is as these </span><span class="line" data-startTime="1030">tiles are invalidated and more </span><span class="line" data-startTime="1034">tiles exist, if the cache is </span><span class="line" data-startTime="1034">full, we effectively have to </span><span class="line" data-startTime="1037">push old tiles out of the cache </span><span class="line" data-startTime="1037">before we can actually </span><span class="line" data-startTime="1040">put the new tiles in. </span> <span class="line" data-startTime="1041">This is going to put a lot of </span><span class="line" data-startTime="1041">pressure on your cache, which </span><span class="line" data-startTime="1044">is going to result in more </span><span class="line" data-startTime="1044">evictions, which is going to </span><span class="line" data-startTime="1046">result in a lot of additional </span><span class="line" data-startTime="1046">CPU overhead painting new </span><span class="line" data-startTime="1050">tiles that would have previously </span><span class="line" data-startTime="1050">been resident </span><span class="line" data-startTime="1052">inside of the cache. </span></p>

<p><span class="line" data-startTime="1055">In addition to the tile </span><span class="line" data-startTime="1055">overhead, you also have to </span><span class="line" data-startTime="1058">take into account just </span><span class="line" data-startTime="1058">the additional </span><span class="line" data-startTime="1059">processing that's involved. </span> <span class="line" data-startTime="1061">Now, this is minimal compared </span><span class="line" data-startTime="1061">to the cache thrashing. </span> <span class="line" data-startTime="1064">But effectively, each layer that </span><span class="line" data-startTime="1064">you add has to be sorted </span><span class="line" data-startTime="1067">every frame. </span> <span class="line" data-startTime="1068">There has to be occlusion </span><span class="line" data-startTime="1068">determinations that occur. </span> <span class="line" data-startTime="1070">And then Chrome can actually </span><span class="line" data-startTime="1070">go through and do union </span><span class="line" data-startTime="1073">processing to determine whether </span><span class="line" data-startTime="1073">or not it should </span><span class="line" data-startTime="1074">actually draw something. </span></p>

<p><span class="line" data-startTime="1075">So let's say you have an object </span><span class="line" data-startTime="1075">and then you have an </span><span class="line" data-startTime="1077">opaque layer in front of it, we </span><span class="line" data-startTime="1077">may be actually able to not </span><span class="line" data-startTime="1080">draw that lower object because </span><span class="line" data-startTime="1080">it's actually hidden. </span></p>

<p class="speaker"><span class="line" data-starttime="1088"><span class="speakerName">Grace Kloba</span>: So there's </span><span class="line" data-startTime="1088">overhead, as Colt mentioned, </span><span class="line" data-startTime="1092">when the animation starts. </span> <span class="line" data-startTime="1094">We pay extra cost to </span><span class="line" data-startTime="1094">promote the page </span><span class="line" data-startTime="1097">element to its own layer. </span> <span class="line" data-startTime="1099">So if there is a lot of pixels </span><span class="line" data-startTime="1099">during the paint that may take </span><span class="line" data-startTime="1104">a longer time, which means </span><span class="line" data-startTime="1104">there's a long delay for the </span><span class="line" data-startTime="1108">animation to start. </span> <span class="line" data-startTime="1110">So what you can do is, as we </span><span class="line" data-startTime="1110">earlier mentioned, the CSS </span><span class="line" data-startTime="1115">properties can permanently </span><span class="line" data-startTime="1115">move the page </span><span class="line" data-startTime="1119">element to its own layer. </span> <span class="line" data-startTime="1121">So you can either translateZ(0) </span><span class="line" data-startTime="1121">to promote it in </span><span class="line" data-startTime="1124">the page loading time. </span> <span class="line" data-startTime="1126">Of course, the tradeoff </span><span class="line" data-startTime="1126">is it's going to </span><span class="line" data-startTime="1129">use a lot of memory. </span> <span class="line" data-startTime="1131">So now the job is &mdash; </span><span class="line" data-startTime="1133">it's your job to make the </span><span class="line" data-startTime="1133">decision whether you want </span><span class="line" data-startTime="1137">animation to start instantly </span><span class="line" data-startTime="1137">or you want to </span><span class="line" data-startTime="1140">preserve the memory. </span></p>

<p><span class="line" data-startTime="1144">Let's look at another example. </span> <span class="line" data-startTime="1146">So on a mobile site, it's a </span><span class="line" data-startTime="1146">common case to try to slide in </span><span class="line" data-startTime="1151">some content from off </span><span class="line" data-startTime="1151">screen to on screen. </span> <span class="line" data-startTime="1154">So for example, we have </span><span class="line" data-startTime="1154">this helpful duck. </span> <span class="line" data-startTime="1157">When the page loaded, the </span><span class="line" data-startTime="1157">duck is off screen. </span> <span class="line" data-startTime="1161">And then it has a display now. </span> <span class="line" data-startTime="1165">So when the user asks the duck </span><span class="line" data-startTime="1165">for help and then what you </span><span class="line" data-startTime="1170">probably would do is change the </span><span class="line" data-startTime="1170">display property from none </span><span class="line" data-startTime="1173">to block and start </span><span class="line" data-startTime="1173">the animation. </span> <span class="line" data-startTime="1177">Unfortunately, we cannot start </span><span class="line" data-startTime="1177">the animation right away </span><span class="line" data-startTime="1181">because we have to go </span><span class="line" data-startTime="1181">to paint the duck . </span> <span class="line" data-startTime="1184">If this duck is fat, big, taking </span><span class="line" data-startTime="1184">a lot of pixels, it may </span><span class="line" data-startTime="1188">take a little bit longer time. </span> <span class="line" data-startTime="1191">So what do we do? </span><span class="line" data-startTime="1193">Remember earlier, we mentioned </span><span class="line" data-startTime="1193">Chrome does pre-paint. </span></p>

<p><span class="line" data-startTime="1199">So if you keep that display </span><span class="line" data-startTime="1199">block property, even when the </span><span class="line" data-startTime="1204">duck is off the screen and also </span><span class="line" data-startTime="1204">use a previous trick we </span><span class="line" data-startTime="1208">mentioned, using the </span><span class="line" data-startTime="1208">translateZ(0) to permanently </span><span class="line" data-startTime="1213">promote it to its own layer, </span><span class="line" data-startTime="1213">after page loaded, before the </span><span class="line" data-startTime="1217">animation start, Chrome </span><span class="line" data-startTime="1217">will paint the </span><span class="line" data-startTime="1220">duck in its own layer. </span> <span class="line" data-startTime="1222">So when user calls the duck for </span><span class="line" data-startTime="1222">help, the duck will just </span><span class="line" data-startTime="1226">jump out right away. </span> <span class="line" data-startTime="1229">Of course, everything </span><span class="line" data-startTime="1229">there is a tradeoff. </span> <span class="line" data-startTime="1231">If the user never calls the duck </span><span class="line" data-startTime="1231">for help, we still spend </span><span class="line" data-startTime="1235">cycles on the CPU to paint the </span><span class="line" data-startTime="1235">duck and then allocated memory </span><span class="line" data-startTime="1239">on the GPU to cache it. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="1244"><span class="speakerName">Colt McAnlis</span>: So what basically </span><span class="line" data-startTime="1244">we're getting at </span><span class="line" data-startTime="1246">here is that with these small </span><span class="line" data-startTime="1246">annotations and these CSS </span><span class="line" data-startTime="1248">properties, you can actually </span><span class="line" data-startTime="1248">control how the GPU is being </span><span class="line" data-startTime="1250">used to render your page. </span> <span class="line" data-startTime="1252">So you guys can make faster </span><span class="line" data-startTime="1252">loading websites, faster </span><span class="line" data-startTime="1254">rendering websites, which make </span><span class="line" data-startTime="1254">your users happier, which </span><span class="line" data-startTime="1256">means your websites </span><span class="line" data-startTime="1256">make more money. </span> <span class="line" data-startTime="1258">And then your boss recognizes </span><span class="line" data-startTime="1258">your contribution and gives </span><span class="line" data-startTime="1260">you the bonus and promotion. </span> <span class="line" data-startTime="1262">So really, we're here to help </span><span class="line" data-startTime="1262">you get promotions so you can </span><span class="line" data-startTime="1265">drink margaritas and stuff. </span> <span class="line" data-startTime="1266">Now with that, that we're giving </span><span class="line" data-startTime="1266">to you, we're asking </span><span class="line" data-startTime="1269">you to then understand that as </span><span class="line" data-startTime="1269">we inject the GPU into the </span><span class="line" data-startTime="1272">process, some parts of the </span><span class="line" data-startTime="1272">architecture of how Chrome </span><span class="line" data-startTime="1275">works changes, which You </span><span class="line" data-startTime="1275">need to be aware of. </span></p>

<p><span class="line" data-startTime="1277">Most important of that </span><span class="line" data-startTime="1277">is how input is being </span><span class="line" data-startTime="1280">handled with this. </span> <span class="line" data-startTime="1281">Because we're actually taking </span><span class="line" data-startTime="1281">what was a single-threaded </span><span class="line" data-startTime="1283">process and adding some new </span><span class="line" data-startTime="1283">components into it. </span></p>

<p class="speaker"><span class="line" data-starttime="1286"><span class="speakerName">Grace Kloba</span>: So before we talk </span><span class="line" data-startTime="1286">about this new [INAUDIBLE] </span><span class="line" data-startTime="1288">threaded compositing, let's take </span><span class="line" data-startTime="1288">a look at how without it </span><span class="line" data-startTime="1293">how it works. </span> <span class="line" data-startTime="1294">So threaded compositing is a new </span><span class="line" data-startTime="1294">concept that we added into </span><span class="line" data-startTime="1297">the Chrome. </span> <span class="line" data-startTime="1298">And the Chrome [INAUDIBLE] </span><span class="line" data-startTime="1299">working on Chrome for </span><span class="line" data-startTime="1299">Android, Chrome for </span><span class="line" data-startTime="1301">Chrome OS, and on Windows. </span> <span class="line" data-startTime="1303">We're soon going to turn </span><span class="line" data-startTime="1303">it on the Mac. </span> <span class="line" data-startTime="1306">So when something changed </span><span class="line" data-startTime="1306">[INAUDIBLE] </span><span class="line" data-startTime="1312">that's what do you did. </span> <span class="line" data-startTime="1313">And then we will do the paint </span><span class="line" data-startTime="1313">and the composite </span><span class="line" data-startTime="1317">on the BLINK thread. </span> <span class="line" data-startTime="1320">And then present this content </span><span class="line" data-startTime="1320">through the GPU commands to </span><span class="line" data-startTime="1324">the driver. </span> <span class="line" data-startTime="1325">But the driver only consume </span><span class="line" data-startTime="1325">the GPU commands up to the </span><span class="line" data-startTime="1329">refresh rate. </span></p>

<p><span class="line" data-startTime="1331">For example, at a 60 FPS display </span><span class="line" data-startTime="1331">it only consume the </span><span class="line" data-startTime="1336">frame at 16.6 millisecond time </span><span class="line" data-startTime="1336">frame, which means there's no </span><span class="line" data-startTime="1341">need, in our case, even the </span><span class="line" data-startTime="1341">paint and to composite a small </span><span class="line" data-startTime="1345">amount of the work, there is </span><span class="line" data-startTime="1345">still no need to paint it </span><span class="line" data-startTime="1348">twice using a 16 milliseconds </span><span class="line" data-startTime="1348">frame. </span></p>

<p class="speaker"><span class="line" data-starttime="1351"><span class="speakerName">Colt McAnlis</span>: And to be fair, </span><span class="line" data-startTime="1351">that diagram is actually a </span><span class="line" data-startTime="1354">little misleading. </span> <span class="line" data-startTime="1355">The what's going on under the </span><span class="line" data-startTime="1355">hood in these browsers is not </span><span class="line" data-startTime="1358">actually that simple. </span> <span class="line" data-startTime="1359">It's actually chaos in a jar, </span><span class="line" data-startTime="1359">what's really going on. </span> <span class="line" data-startTime="1362">Effectively, if you look at </span><span class="line" data-startTime="1362">our single-threaded model </span><span class="line" data-startTime="1363">here, you have lots and lots </span><span class="line" data-startTime="1363">of resources and events </span><span class="line" data-startTime="1366">fighting for time slices on this </span><span class="line" data-startTime="1366">single-threaded model. </span> <span class="line" data-startTime="1370">So things like parsing, </span><span class="line" data-startTime="1370">layout, paint, </span><span class="line" data-startTime="1371">all of these things. </span> <span class="line" data-startTime="1372">So what happens is if we </span><span class="line" data-startTime="1372">actually get one of these </span><span class="line" data-startTime="1374">VBLANKS coming along asking for </span><span class="line" data-startTime="1374">updated data, there's a </span><span class="line" data-startTime="1377">good chance that with all </span><span class="line" data-startTime="1377">of the processing that's </span><span class="line" data-startTime="1380">occurring that the thread has </span><span class="line" data-startTime="1380">not actually had a chance to </span><span class="line" data-startTime="1383">paint and give the VBLANK an </span><span class="line" data-startTime="1383">updated vision of the scene. </span></p>

<p><span class="line" data-startTime="1389">Now, what's really interesting </span><span class="line" data-startTime="1389">about this, when you dig a </span><span class="line" data-startTime="1391">little bit deeper, is that </span><span class="line" data-startTime="1391">there's some things that you, </span><span class="line" data-startTime="1393">as a developer, can control. </span> <span class="line" data-startTime="1394">So if we look at the breakdown </span><span class="line" data-startTime="1394">of the blocks here, things </span><span class="line" data-startTime="1397">like Touch Events, JavaScript </span><span class="line" data-startTime="1397">Events, onload callbacks, you </span><span class="line" data-startTime="1400">as developers really are in </span><span class="line" data-startTime="1400">control of how long those </span><span class="line" data-startTime="1403">events take on the JavaScript </span><span class="line" data-startTime="1403">processing thread. </span> <span class="line" data-startTime="1406">Now, there's some other </span><span class="line" data-startTime="1406">things though that you </span><span class="line" data-startTime="1408">really can't control. </span> <span class="line" data-startTime="1408">You can wave your hands at it </span><span class="line" data-startTime="1408">and maybe do some juju dances, </span><span class="line" data-startTime="1411">but it's really not going to </span><span class="line" data-startTime="1411">change because on the browser </span><span class="line" data-startTime="1413">side of things, that's </span><span class="line" data-startTime="1413">controlled &mdash; </span><span class="line" data-startTime="1415">things like layout, paints, </span><span class="line" data-startTime="1415">and compositing. </span></p>

<p><span class="line" data-startTime="1418">Now, the good thing is that some </span><span class="line" data-startTime="1418">of these can actually be </span><span class="line" data-startTime="1421">moved off onto different threads </span><span class="line" data-startTime="1421">because of modern </span><span class="line" data-startTime="1424">architectures. </span> <span class="line" data-startTime="1425">Like most of the phones in your </span><span class="line" data-startTime="1425">pockets actually have </span><span class="line" data-startTime="1426">multiple cores, which means we </span><span class="line" data-startTime="1426">can utilize modern techniques </span><span class="line" data-startTime="1430">for threaded programming. </span> <span class="line" data-startTime="1432">Now, there's a great technique </span><span class="line" data-startTime="1432">that Chrome does use called </span><span class="line" data-startTime="1434">multi-threaded painting, which </span><span class="line" data-startTime="1434">actually allows us to take the </span><span class="line" data-startTime="1437">paint block, which traditionally </span><span class="line" data-startTime="1437">was single </span><span class="line" data-startTime="1438">threaded sharing time with all </span><span class="line" data-startTime="1438">of your JavaScript events, and </span><span class="line" data-startTime="1441">actually thread that out off </span><span class="line" data-startTime="1441">to multiple threads, which </span><span class="line" data-startTime="1444">reduces the amount </span><span class="line" data-startTime="1444">of time it takes. </span> <span class="line" data-startTime="1446">Now, we're not going to talk </span><span class="line" data-startTime="1446">about that today because </span><span class="line" data-startTime="1448">that's not on the GPU. </span></p>

<p><span class="line" data-startTime="1449">Instead, what we're going to </span><span class="line" data-startTime="1449">talk about today is this other </span><span class="line" data-startTime="1451">block here, which is actually </span><span class="line" data-startTime="1451">the composite operation. </span> <span class="line" data-startTime="1454">The best way to think about this </span><span class="line" data-startTime="1454">is after your painting is </span><span class="line" data-startTime="1458">done, remember that Chrome has </span><span class="line" data-startTime="1458">to go back and actually create </span><span class="line" data-startTime="1460">all of these graphics driver </span><span class="line" data-startTime="1460">commands, GPU commands, to </span><span class="line" data-startTime="1464">take those textures and upload </span><span class="line" data-startTime="1464">them to the GPU and then </span><span class="line" data-startTime="1466">actually do that submit. </span> <span class="line" data-startTime="1467">Of course, that isn't </span><span class="line" data-startTime="1467">actually free. </span> <span class="line" data-startTime="1469">It actually cuts into </span><span class="line" data-startTime="1469">your frame time. </span></p>

<p><span class="line" data-startTime="1471">So what we want to talk about </span><span class="line" data-startTime="1471">today is how we move that off </span><span class="line" data-startTime="1473">onto a different thread and </span><span class="line" data-startTime="1473">what that means for you. </span> <span class="line" data-startTime="1477">So we now have the BLINK thread, </span><span class="line" data-startTime="1477">which is effectively </span><span class="line" data-startTime="1479">responsible &mdash; </span><span class="line" data-startTime="1483">if there's one thing you should </span><span class="line" data-startTime="1483">all take away from this </span><span class="line" data-startTime="1484">today is that there are tons of </span><span class="line" data-startTime="1484">technical problems on this </span><span class="line" data-startTime="1487">side of the stage. </span> <span class="line" data-startTime="1489">Basically we have our BLINK </span><span class="line" data-startTime="1489">thread, which handles all of </span><span class="line" data-startTime="1491">our JavaScript processing, </span><span class="line" data-startTime="1491">including layout and other </span><span class="line" data-startTime="1493">sorts of things. </span></p>

<p><span class="line" data-startTime="1494">And we can actually move the </span><span class="line" data-startTime="1494">composite operation down onto </span><span class="line" data-startTime="1496">a separate thread. </span> <span class="line" data-startTime="1497">So this means that whenever the </span><span class="line" data-startTime="1497">system can define that a </span><span class="line" data-startTime="1501">composite is actually needed, we </span><span class="line" data-startTime="1501">can actually go through and </span><span class="line" data-startTime="1504">kick off a composite onto </span><span class="line" data-startTime="1504">a separate thread. </span> <span class="line" data-startTime="1510">And one more. </span></p>

<p class="speaker"><span class="line" data-starttime="1511"><span class="speakerName">Grace Kloba</span>: One more. </span><span class="line" data-startTime="1512">OK. </span></p>

<p class="speaker"><span class="line" data-starttime="1512"><span class="speakerName">Colt McAnlis</span>: There we go. </span><span class="line" data-startTime="1514">Too far. </span><span class="line" data-startTime="1514">No, go back. </span><span class="line" data-startTime="1516">The universe, you divided </span><span class="line" data-startTime="1516">by 0, no. </span></p>

<p class="speaker"><span class="line" data-starttime="1519"><span class="speakerName">Grace Kloba</span>: OK. </span> <span class="line" data-startTime="1520">Calm down. </span> <span class="line" data-startTime="1523">So it's good. </span> <span class="line" data-startTime="1526">We move the composite into </span><span class="line" data-startTime="1526">a separate thread. </span> <span class="line" data-startTime="1528">So we offload some work </span><span class="line" data-startTime="1528">from the BLINK thread. </span> <span class="line" data-startTime="1533">But there is a key change we </span><span class="line" data-startTime="1533">made is let the composite </span><span class="line" data-startTime="1537">thread to accept input events </span><span class="line" data-startTime="1537">when it is possible. </span> <span class="line" data-startTime="1541">For example, scroll events can </span><span class="line" data-startTime="1541">be received and processed on </span><span class="line" data-startTime="1546">the composite thread without </span><span class="line" data-startTime="1546">the intervention </span><span class="line" data-startTime="1549">of the BLINK thread. </span> <span class="line" data-startTime="1551">This allows us to scroll as fast </span><span class="line" data-startTime="1551">as possible even there is </span><span class="line" data-startTime="1559">a long JavaScript is executing </span><span class="line" data-startTime="1559">in the BLINK thread. </span> <span class="line" data-startTime="1564">It is the for this exactly </span><span class="line" data-startTime="1564">reason we ask you to let the </span><span class="line" data-startTime="1568">browser to scroll. </span></p>

<p><span class="line" data-startTime="1572">Simply put, if you're using </span><span class="line" data-startTime="1572">touch events or mousewheel </span><span class="line" data-startTime="1577">events to drive the scroll, the </span><span class="line" data-startTime="1577">benefit of the threaded </span><span class="line" data-startTime="1582">compositing is thrown </span><span class="line" data-startTime="1582">out of the window. </span> <span class="line" data-startTime="1585">The custom scroll libraries </span><span class="line" data-startTime="1585">normally will put a touch </span><span class="line" data-startTime="1589">handler, mousewheel handler, </span><span class="line" data-startTime="1589">and then they will call </span><span class="line" data-startTime="1592">prevent default. </span> <span class="line" data-startTime="1594">So the result is there's no </span><span class="line" data-startTime="1594">scroll events happen or get </span><span class="line" data-startTime="1598">sent to compositers thread. </span> <span class="line" data-startTime="1601">What compositers thread can do </span><span class="line" data-startTime="1601">is just wait for the BLINK </span><span class="line" data-startTime="1606">thread to process the JavaScript </span><span class="line" data-startTime="1606">doing the layout </span><span class="line" data-startTime="1610">and then paint. </span></p>

<p><span class="line" data-startTime="1611">This is essentially go back to </span><span class="line" data-startTime="1611">the single thread [INAUDIBLE]. </span></p>

<p class="speaker"><span class="line" data-starttime="1616"><span class="speakerName">Colt McAnlis</span>: Now, </span><span class="line" data-startTime="1616">this is actually </span><span class="line" data-startTime="1617">pretty common on mobile. </span> <span class="line" data-startTime="1618">So how many of you guys actually </span><span class="line" data-startTime="1618">have a mobile website </span><span class="line" data-startTime="1620">that has a static header </span><span class="line" data-startTime="1620">at the top of it? </span><span class="line" data-startTime="1623">A good amount of hands. </span> <span class="line" data-startTime="1624">So OK, keep your hands up. </span> <span class="line" data-startTime="1625">Keep your hands up. </span> <span class="line" data-startTime="1626">How many of you, in order to </span><span class="line" data-startTime="1626">keep that banner at the top of </span><span class="line" data-startTime="1629">the page, actually intercept </span><span class="line" data-startTime="1629">the scroll handler? </span><span class="line" data-startTime="1632">Still a couple of you, OK. </span></p>

<p><span class="line" data-startTime="1634">Well, I'm here to let </span><span class="line" data-startTime="1634">you know that that's </span><span class="line" data-startTime="1635">actually a bad practice. </span> <span class="line" data-startTime="1637">So just like Grace said, that </span><span class="line" data-startTime="1637">when you intercept the scroll </span><span class="line" data-startTime="1639">handler on Chrome for Android, </span><span class="line" data-startTime="1639">what you're effectively doing </span><span class="line" data-startTime="1642">is throwing out all of the </span><span class="line" data-startTime="1642">cool stuff you get from </span><span class="line" data-startTime="1645">multi-threaded compositing. </span> <span class="line" data-startTime="1646">And the result of that is what </span><span class="line" data-startTime="1646">you're going to see is that as </span><span class="line" data-startTime="1648">the page scrolls, the scroll's </span><span class="line" data-startTime="1648">going to happen and the </span><span class="line" data-startTime="1650">headers going to move, whether </span><span class="line" data-startTime="1650">you like it or not. </span> <span class="line" data-startTime="1652">And then your JavaScript </span><span class="line" data-startTime="1652">code is actually going </span><span class="line" data-startTime="1654">to execute and fire. </span> <span class="line" data-startTime="1655">And then you'll see your header </span><span class="line" data-startTime="1655">snap to the position </span><span class="line" data-startTime="1657">that you want it to go to. </span> <span class="line" data-startTime="1658">So if we have this beautiful </span><span class="line" data-startTime="1658">Duck Surfing 101 page here and </span><span class="line" data-startTime="1661">you have the page scroll, you </span><span class="line" data-startTime="1661">actually want this thing to </span><span class="line" data-startTime="1663">stay static. </span></p>

<p><span class="line" data-startTime="1665">Now, instead of actually </span><span class="line" data-startTime="1665">intercepting the scroll </span><span class="line" data-startTime="1666">handler, you can take advantage </span><span class="line" data-startTime="1666">of these CSS </span><span class="line" data-startTime="1669">properties that we've been using </span><span class="line" data-startTime="1669">and actually put the </span><span class="line" data-startTime="1671">header in its own layer. </span> <span class="line" data-startTime="1673">So if you actually add a </span><span class="line" data-startTime="1673">position fixed as well as a </span><span class="line" data-startTime="1676">z-index 0 to this thing &mdash; or </span><span class="line" data-startTime="1676">z-index anything really, just </span><span class="line" data-startTime="1679">as long as a z-index is there </span><span class="line" data-startTime="1679">so you can create proper </span><span class="line" data-startTime="1682">context stacking. </span> <span class="line" data-startTime="1683">What this will do is actually </span><span class="line" data-startTime="1683">promote the header into its </span><span class="line" data-startTime="1686">own layer and allow the page </span><span class="line" data-startTime="1686">itself to transition </span><span class="line" data-startTime="1688">underneath it. </span> <span class="line" data-startTime="1689">So you will get the overhead of </span><span class="line" data-startTime="1689">having your own layer, but </span><span class="line" data-startTime="1692">you won't get the ghost chasing </span><span class="line" data-startTime="1692">effect that you're </span><span class="line" data-startTime="1694">going to see on top of mobile. </span></p>

<p><span class="line" data-startTime="1695">If you want a really great </span><span class="line" data-startTime="1695">example of who does this </span><span class="line" data-startTime="1697">right, definitely check out </span><span class="line" data-startTime="1697">the Google I/O 2013 mobile </span><span class="line" data-startTime="1702">site where we do this on </span><span class="line" data-startTime="1702">the session agenda. </span> <span class="line" data-startTime="1704">You can actually see as things </span><span class="line" data-startTime="1704">scroll, we have these static </span><span class="line" data-startTime="1706">headers at the top and it </span><span class="line" data-startTime="1706">does it the right way. </span> <span class="line" data-startTime="1708">Look at the source code. </span> <span class="line" data-startTime="1708">It's a great example. </span> <span class="line" data-startTime="1712">And so with that though, it's </span><span class="line" data-startTime="1712">worth pointing out, that we </span><span class="line" data-startTime="1714">just gave you an example that </span><span class="line" data-startTime="1714">we didn't talk about before. </span> <span class="line" data-startTime="1716">We talked about TranslateZ. </span> <span class="line" data-startTime="1718">We talked about overflow. </span> <span class="line" data-startTime="1719">We talked about those other </span><span class="line" data-startTime="1719">things and that will promote </span><span class="line" data-startTime="1722">items into their own </span><span class="line" data-startTime="1722">layer as well. </span> <span class="line" data-startTime="1723">But in reality, you may have </span><span class="line" data-startTime="1723">inadvertently put something </span><span class="line" data-startTime="1726">into a layer without really </span><span class="line" data-startTime="1726">knowing about it, which means </span><span class="line" data-startTime="1728">that we are not leaving </span><span class="line" data-startTime="1728">you abandoned here. </span> <span class="line" data-startTime="1729">We actually have updated our </span><span class="line" data-startTime="1729">tools to tell you how the GPU </span><span class="line" data-startTime="1732">is doing things. </span></p>

<p><span class="line" data-startTime="1734">First off, there's a fantastic </span><span class="line" data-startTime="1734">set of flags that you can turn </span><span class="line" data-startTime="1737">on in Chrome's dev tools </span><span class="line" data-startTime="1737">that will tell you </span><span class="line" data-startTime="1739">where the layers are. </span> <span class="line" data-startTime="1741">First off, if you open up dev </span><span class="line" data-startTime="1741">tools you actually see this </span><span class="line" data-startTime="1742">beautiful awesome little flag </span><span class="line" data-startTime="1742">there that says, Show </span><span class="line" data-startTime="1745">Composited Borders. </span> <span class="line" data-startTime="1746">What effectively this does is </span><span class="line" data-startTime="1746">any of your layers it will add </span><span class="line" data-startTime="1749">an orange border around the </span><span class="line" data-startTime="1749">boundaries of the layer. </span></p>

<p><span class="line" data-startTime="1753">So I randomly took a picture </span><span class="line" data-startTime="1753">of a random website on the </span><span class="line" data-startTime="1755">internet here. </span> <span class="line" data-startTime="1756">And you can actually see that </span><span class="line" data-startTime="1756">what we have here is lots and </span><span class="line" data-startTime="1759">lots and lots of layers. </span> <span class="line" data-startTime="1761">That's what each one of those </span><span class="line" data-startTime="1761">orange borders means. </span> <span class="line" data-startTime="1762">So part of their feed here, </span><span class="line" data-startTime="1762">effectively, is each layer. </span> <span class="line" data-startTime="1766">If you look at the source code </span><span class="line" data-startTime="1766">of this, you'll actually see </span><span class="line" data-startTime="1768">that each one of those leaf </span><span class="line" data-startTime="1768">elements in the DOM has </span><span class="line" data-startTime="1770">TranslateZ on it. </span> <span class="line" data-startTime="1772">So once again, you're seeing </span><span class="line" data-startTime="1772">that this would come to bad </span><span class="line" data-startTime="1774">performance like we've </span><span class="line" data-startTime="1774">already talked about. </span> <span class="line" data-startTime="1775">Because each one of those </span><span class="line" data-startTime="1775">layers is going to have </span><span class="line" data-startTime="1777">additional tiles. </span> <span class="line" data-startTime="1778">All of those tiles are going to </span><span class="line" data-startTime="1778">be fighting for residency </span><span class="line" data-startTime="1780">inside of GPU memory. </span></p>

<p><span class="line" data-startTime="1781">And of course, this is going to </span><span class="line" data-startTime="1781">slow things down on mobile. </span> <span class="line" data-startTime="1784">Now the cool thing is that it's </span><span class="line" data-startTime="1784">not always axial aligned </span><span class="line" data-startTime="1786">like one of the images there. </span> <span class="line" data-startTime="1787">You can see that they actually </span><span class="line" data-startTime="1787">have this loading icon that is </span><span class="line" data-startTime="1790">going to be rotated with a CSS </span><span class="line" data-startTime="1790">transform as well as a little </span><span class="line" data-startTime="1793">animated gif too. </span> <span class="line" data-startTime="1794">And you can see that the cool </span><span class="line" data-startTime="1794">borders match that as well. </span> <span class="line" data-startTime="1797">Now, it's worth pointing out </span><span class="line" data-startTime="1797">that these borders, as they're </span><span class="line" data-startTime="1799">rendered, actually obey </span><span class="line" data-startTime="1799">occlusion ordering. </span> <span class="line" data-startTime="1802">So effectively, if you've got </span><span class="line" data-startTime="1802">that nice little spinning </span><span class="line" data-startTime="1804">thing and then an image in </span><span class="line" data-startTime="1804">front of it, you won't </span><span class="line" data-startTime="1806">actually see that border. </span> <span class="line" data-startTime="1807">So take that into account </span><span class="line" data-startTime="1807">as you're moving along. </span></p>

<p><span class="line" data-startTime="1811">Another great tool that you can </span><span class="line" data-startTime="1811">actually dive into is one </span><span class="line" data-startTime="1814">called chrome://tracing. </span> <span class="line" data-startTime="1816">Now chrome://tracing </span><span class="line" data-startTime="1816">personally &mdash; </span><span class="line" data-startTime="1819">hey, I'm a beat box guy now. </span> <span class="line" data-startTime="1822">Chrome://tracing is actually </span><span class="line" data-startTime="1822">my favorite tool inside of </span><span class="line" data-startTime="1824">Chrome because it will actually </span><span class="line" data-startTime="1824">tell you what Chrome </span><span class="line" data-startTime="1826">is doing under the hood. </span> <span class="line" data-startTime="1828">Effectively, it gives you a </span><span class="line" data-startTime="1828">hierarchical view of the call </span><span class="line" data-startTime="1830">stack that's happening inside of </span><span class="line" data-startTime="1830">Chrome based upon what your </span><span class="line" data-startTime="1834">website is doing. </span> <span class="line" data-startTime="1835">So I actually put together a </span><span class="line" data-startTime="1835">little test page to give you </span><span class="line" data-startTime="1838">this graphic here. </span> <span class="line" data-startTime="1839">And effectively, all the test </span><span class="line" data-startTime="1839">page did was load a bunch of </span><span class="line" data-startTime="1842">large images, like 1024's and </span><span class="line" data-startTime="1842">2048's, and actually resize </span><span class="line" data-startTime="1846">them with a width and height </span><span class="line" data-startTime="1846">parameter down to 64 by 64's. </span> <span class="line" data-startTime="1850">And this is what </span><span class="line" data-startTime="1850">chrome://tracing showed me. </span> <span class="line" data-startTime="1852">So first off, the 1024 by </span><span class="line" data-startTime="1852">1024 actually took 51 </span><span class="line" data-startTime="1855">milliseconds to decode. </span> <span class="line" data-startTime="1856">And then after that, </span><span class="line" data-startTime="1856">it took another 29 </span><span class="line" data-startTime="1858">milliseconds to resize. </span> <span class="line" data-startTime="1860">So think of it this way, for </span><span class="line" data-startTime="1860">all of you guys in here who </span><span class="line" data-startTime="1862">are doing responsive web design, </span><span class="line" data-startTime="1862">and you're sending </span><span class="line" data-startTime="1864">your full resolution desktop </span><span class="line" data-startTime="1864">images down to your mobile </span><span class="line" data-startTime="1867">client because you feel that </span><span class="line" data-startTime="1867">that's the only way you can </span><span class="line" data-startTime="1868">handle viewport differences, </span><span class="line" data-startTime="1868">you could be </span><span class="line" data-startTime="1871">wasting a lot of time. </span></p>

<p><span class="line" data-startTime="1873">Instead, you can see that the </span><span class="line" data-startTime="1873">next image that I had in the </span><span class="line" data-startTime="1875">list was much smaller. </span> <span class="line" data-startTime="1876">It was about 128 by 128. </span> <span class="line" data-startTime="1878">So the decode took less </span><span class="line" data-startTime="1878">time, as well as the </span><span class="line" data-startTime="1880">resize took less time. </span> <span class="line" data-startTime="1881">So the cool thing to take away </span><span class="line" data-startTime="1881">from this slide is that we can </span><span class="line" data-startTime="1884">actually figure out how your </span><span class="line" data-startTime="1884">page is using the GPU by </span><span class="line" data-startTime="1887">looking at some patterns that </span><span class="line" data-startTime="1887">you can see inside of </span><span class="line" data-startTime="1889">chrome://tracing. </span></p>

<p class="speaker"><span class="line" data-starttime="1892"><span class="speakerName">Grace Kloba</span>: So earlier we </span><span class="line" data-startTime="1892">talked about browser scroll </span><span class="line" data-startTime="1895">versus JavaScript scroll. </span> <span class="line" data-startTime="1897">Let's take a look in the </span><span class="line" data-startTime="1897">chrome://tracing. </span> <span class="line" data-startTime="1899">So in this case, the top row </span><span class="line" data-startTime="1899">is a compositers thread. </span> <span class="line" data-startTime="1907">The bottom row called </span><span class="line" data-startTime="1907">[? CrRendererMain ?] </span><span class="line" data-startTime="1911">is essentially the </span><span class="line" data-startTime="1911">BLINK thread. </span> <span class="line" data-startTime="1913">The number on the left is a </span><span class="line" data-startTime="1913">process ID because compositer </span><span class="line" data-startTime="1918">and the BLINK thread are both in </span><span class="line" data-startTime="1918">the render process, so they </span><span class="line" data-startTime="1921">have the same number, </span><span class="line" data-startTime="1921">same process ID. </span> <span class="line" data-startTime="1926">Chrome trace also comes with </span><span class="line" data-startTime="1926">this nice FPS guideline. </span> <span class="line" data-startTime="1931">So it's running at a 60 FPS, </span><span class="line" data-startTime="1931">repeated at 16.6 milliseconds. </span> <span class="line" data-startTime="1938">In this case, [INAUDIBLE] </span><span class="line" data-startTime="1940">line data was the first </span><span class="line" data-startTime="1940">composite in this window. </span> <span class="line" data-startTime="1944">As you can see, the scroll is </span><span class="line" data-startTime="1944">updated nicely at 60 FPS, even </span><span class="line" data-startTime="1951">when we have a long paint </span><span class="line" data-startTime="1951">happening in the BLINK thread. </span></p>

<p><span class="line" data-startTime="1957">Let's take look at </span><span class="line" data-startTime="1957">another trace. </span> <span class="line" data-startTime="1960">This is done on the same device </span><span class="line" data-startTime="1960">with the same version </span><span class="line" data-startTime="1964">of the Chrome. </span> <span class="line" data-startTime="1965">Instead, we load a different </span><span class="line" data-startTime="1965">page, of course. </span> <span class="line" data-startTime="1968">Otherwise, it should be same. </span> <span class="line" data-startTime="1970">So in this page, the JavaScript </span><span class="line" data-startTime="1970">is hijacking the </span><span class="line" data-startTime="1974">touch events, and then drive </span><span class="line" data-startTime="1974">the scrolling of the page. </span> <span class="line" data-startTime="1980">First thing we did is pull back </span><span class="line" data-startTime="1980">our IPS guideline and </span><span class="line" data-startTime="1985">left the line with the </span><span class="line" data-startTime="1985">first composite. </span> <span class="line" data-startTime="1988">Immediately, you will notice </span><span class="line" data-startTime="1988">between the second and the </span><span class="line" data-startTime="1992">third composite, it took 33 </span><span class="line" data-startTime="1992">milliseconds instead of the 16 </span><span class="line" data-startTime="1998">milliseconds. </span></p>

<p><span class="line" data-startTime="2000">Why? </span><span class="line" data-startTime="2002">Because in this case, we also </span><span class="line" data-startTime="2002">have a long paint happening in </span><span class="line" data-startTime="2006">the BLINK thread. </span> <span class="line" data-startTime="2007">And because the scrolling is </span><span class="line" data-startTime="2007">driven by the JavaScript, so </span><span class="line" data-startTime="2012">the composite step in the </span><span class="line" data-startTime="2012">compositers thread cannot </span><span class="line" data-startTime="2016">start until the paint </span><span class="line" data-startTime="2016">is finished. </span> <span class="line" data-startTime="2021">So again, the thing you want to </span><span class="line" data-startTime="2021">learn from this example is </span><span class="line" data-startTime="2029">let the browser scroll. </span></p>

<p class="speaker"><span class="line" data-starttime="2033"><span class="speakerName">Colt McAnlis</span>: And with that, we </span><span class="line" data-startTime="2033">can recap what we've talked </span><span class="line" data-startTime="2035">about today. </span> <span class="line" data-startTime="2036">Four main bullet points to </span><span class="line" data-startTime="2036">walk away from this talk. </span> <span class="line" data-startTime="2038">Number one, making a </span><span class="line" data-startTime="2038">presentation is a lot more </span><span class="line" data-startTime="2041">technically difficult apparently </span><span class="line" data-startTime="2041">than writing a </span><span class="line" data-startTime="2043">whole web browser. </span> <span class="line" data-startTime="2045">First off is actually </span><span class="line" data-startTime="2045">GPU plus layers </span><span class="line" data-startTime="2047">equals faster rendering. </span> <span class="line" data-startTime="2049">By actually getting the GPU </span><span class="line" data-startTime="2049">into the mix and actually </span><span class="line" data-startTime="2051">using layers, we can allow it </span><span class="line" data-startTime="2051">to alleviate a lot of the </span><span class="line" data-startTime="2053">processing burden that would </span><span class="line" data-startTime="2053">previously exist in </span><span class="line" data-startTime="2055">rasterization on the CPU. </span> <span class="line" data-startTime="2057">But that comes with a caveat </span><span class="line" data-startTime="2057">though, is that too many </span><span class="line" data-startTime="2060">layers is going to be a </span><span class="line" data-startTime="2060">seriously bad time. </span> <span class="line" data-startTime="2061">If you put too many layers out </span><span class="line" data-startTime="2061">there, everything's going to </span><span class="line" data-startTime="2063">be fighting for residency inside </span><span class="line" data-startTime="2063">of the GPU tile cache </span><span class="line" data-startTime="2066">and that's going to create </span><span class="line" data-startTime="2066">some problems. </span> <span class="line" data-startTime="2068">In addition to that, that's </span><span class="line" data-startTime="2068">going to create some changes </span><span class="line" data-startTime="2070">in how input is handled, </span><span class="line" data-startTime="2070">especially for mobile devices, </span><span class="line" data-startTime="2073">which means that you guys </span><span class="line" data-startTime="2073">should really let Chrome </span><span class="line" data-startTime="2075">handle the scrolling </span><span class="line" data-startTime="2075">of things. </span></p>

<p><span class="line" data-startTime="2077">You're going to have a </span><span class="line" data-startTime="2077">smoother frame rate. </span> <span class="line" data-startTime="2078">It's going to give your </span><span class="line" data-startTime="2078">users a better </span><span class="line" data-startTime="2079">impression of your site. </span> <span class="line" data-startTime="2080">You're going to make lots of </span><span class="line" data-startTime="2080">money and get really cool </span><span class="line" data-startTime="2081">promotions. </span> <span class="line" data-startTime="2082">And then you can send Grace and </span><span class="line" data-startTime="2082">I emails thanking us for </span><span class="line" data-startTime="2084">all of our time and effort </span><span class="line" data-startTime="2084">that we put into this </span><span class="line" data-startTime="2086">technically flawed talk. </span> <span class="line" data-startTime="2088">And then finally, if you're not </span><span class="line" data-startTime="2088">really sure what's going </span><span class="line" data-startTime="2090">on, please use tooling to </span><span class="line" data-startTime="2090">verify what's going </span><span class="line" data-startTime="2092">on under the hood. </span></p>

<p><span class="line" data-startTime="2093">Use things like show composited </span><span class="line" data-startTime="2093">borders, as well as </span><span class="line" data-startTime="2095">about tracing and get </span><span class="line" data-startTime="2095">a really good deep </span><span class="line" data-startTime="2097">dive of what's happening. </span> <span class="line" data-startTime="2099">So with that, we thank you all </span><span class="line" data-startTime="2099">so much for giving us your </span><span class="line" data-startTime="2101">time today. </span> <span class="line" data-startTime="2102">Before we take off, I want </span><span class="line" data-startTime="2102">to actually, once again, </span><span class="line" data-startTime="2105">encourage all of you to use the </span><span class="line" data-startTime="2105">perfmatters hashtag for </span><span class="line" data-startTime="2107">any of your web performance </span><span class="line" data-startTime="2107">related things. </span> <span class="line" data-startTime="2109">As well as invite you </span><span class="line" data-startTime="2109">to join the Google+ </span><span class="line" data-startTime="2113">web performance community. </span></p>

<p><span class="line" data-startTime="2114">You can see the short link </span><span class="line" data-startTime="2114">there goo.gl/webperf. </span> <span class="line" data-startTime="2117">It's a fantastic community. </span> <span class="line" data-startTime="2118">We've got lots of the big brains </span><span class="line" data-startTime="2118">in web performance all </span><span class="line" data-startTime="2121">contributing there. </span> <span class="line" data-startTime="2121">It's a community of awesome </span><span class="line" data-startTime="2121">web performance stuff. </span> <span class="line" data-startTime="2125">With that, it looks like we've </span><span class="line" data-startTime="2125">got about four minutes and 30 </span><span class="line" data-startTime="2127">seconds for questions. </span> <span class="line" data-startTime="2129">The mics are here. </span> <span class="line" data-startTime="2130">Please give us your thoughts. </span> <span class="line" data-startTime="2132">Thank you. </span> <span class="line" data-startTime="2134">[APPLAUSE] </span></p>

<p class="speaker"><span class="line" data-starttime="2144"><span class="speakerName">Audience</span>: I have three brief </span><span class="line" data-startTime="2144">questions if I can read my own </span><span class="line" data-startTime="2147">handwriting. </span></p>

<p class="speaker"><span class="line" data-starttime="2147"><span class="speakerName">Colt McAnlis</span>: Wait, how </span><span class="line" data-startTime="2147">brief can they be? </span><span class="line" data-startTime="2148">You wrote them down. </span></p>

<p class="speaker"><span class="line" data-starttime="2150"><span class="speakerName">Audience</span>: That was so I </span><span class="line" data-startTime="2150">could pay attention. </span></p>

<p class="speaker"><span class="line" data-starttime="2151"><span class="speakerName">Colt McAnlis</span>: That's not </span><span class="line" data-startTime="2151">a brief question. </span></p>

<p class="speaker"><span class="line" data-starttime="2153"><span class="speakerName">Audience</span>: What is the limit </span><span class="line" data-startTime="2153">to the number of tiles? </span><span class="line" data-startTime="2156">Is it 100 tiles, 1,000 tiles, </span><span class="line" data-startTime="2156">10 tiles, in the mem </span><span class="line" data-startTime="2160">cache of the GPU? </span></p>

<p class="speaker"><span class="line" data-starttime="2162"><span class="speakerName">Grace Kloba</span>: It really </span><span class="line" data-startTime="2162">depends. </span><span class="line" data-startTime="2165">As we mentioned, the impact </span><span class="line" data-startTime="2165">of the tiles is memory. </span><span class="line" data-startTime="2170">So we try to do &mdash; </span><span class="line" data-startTime="2171">[? the parsing ?] </span><span class="line" data-startTime="2172">is the tile is fully behind </span><span class="line" data-startTime="2172">it, we're not </span><span class="line" data-startTime="2176">going to render it. </span><span class="line" data-startTime="2178">But if there is overlap because </span><span class="line" data-startTime="2178">of the tile size, you </span><span class="line" data-startTime="2181">of course pay the overhead. </span><span class="line" data-startTime="2183">So that depends on how </span><span class="line" data-startTime="2183">much you overlap. </span></p>

<p class="speaker"><span class="line" data-starttime="2185"><span class="speakerName">Audience</span>: So I guess the main </span><span class="line" data-startTime="2185">question is, how big is the </span><span class="line" data-startTime="2188">memory that's allocated </span><span class="line" data-startTime="2188">to the GPU? </span></p>

<p class="speaker"><span class="line" data-starttime="2192"><span class="speakerName">Grace Kloba</span>: As I think I </span><span class="line" data-startTime="2192">mentioned earlier, it's really </span><span class="line" data-startTime="2193">device dependent. </span><span class="line" data-startTime="2195">So for example, [INAUDIBLE] </span><span class="line" data-startTime="2197">the Android mobile device, </span><span class="line" data-startTime="2197">we're basically using the </span><span class="line" data-startTime="2203">memory limit, which is &mdash; </span><span class="line" data-startTime="2205">most of today's mobile devices </span><span class="line" data-startTime="2205">are unified memory. </span><span class="line" data-startTime="2209">So the total memory on the </span><span class="line" data-startTime="2209">Galaxy Nexus is 1 gig, on the </span><span class="line" data-startTime="2216">Nexus 10 it's 2 gig. </span><span class="line" data-startTime="2217">That's overall memory. </span><span class="line" data-startTime="2219">But available for the GPU we use </span><span class="line" data-startTime="2219">that one as a measurement </span><span class="line" data-startTime="2222">and also using the screen </span><span class="line" data-startTime="2222">resolution as a measurement. </span><span class="line" data-startTime="2226">In these two cases, we probably </span><span class="line" data-startTime="2226">allocated a limited, </span><span class="line" data-startTime="2229">so around 256 meg. </span></p>

<p class="speaker"><span class="line" data-starttime="2232"><span class="speakerName">Audience</span>: OK, so it's actually </span><span class="line" data-startTime="2232">part of the RAM is &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="2234"><span class="speakerName">Grace Kloba</span>: Yeah, </span><span class="line" data-startTime="2234">part of the RAM. </span><span class="line" data-startTime="2235">And then we have to be </span><span class="line" data-startTime="2235">conservative because there's </span><span class="line" data-startTime="2238">other apps. </span><span class="line" data-startTime="2239">So we basically allocate a </span><span class="line" data-startTime="2239">budget based on the device </span><span class="line" data-startTime="2243">memory limit and the </span><span class="line" data-startTime="2243">screen resolution. </span></p>

<p class="speaker"><span class="line" data-starttime="2246"><span class="speakerName">Audience</span>: OK, should I go to the </span><span class="line" data-startTime="2246">back of the line or ask &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="2247"><span class="speakerName">Colt McAnlis</span>: Yeah, </span><span class="line" data-startTime="2247">if you don't mind. </span><span class="line" data-startTime="2248">We'll get some more </span><span class="line" data-startTime="2248">questions in here. </span><span class="line" data-startTime="2249">This side over here. </span></p>

<p class="speaker"><span class="line" data-starttime="2249"><span class="speakerName">Audience</span>: Hi, question is, are </span><span class="line" data-startTime="2249">there any good methods for </span><span class="line" data-startTime="2253">syncing scrolling between </span><span class="line" data-startTime="2253">different panes, if you want </span><span class="line" data-startTime="2257">to create a paned approach, that </span><span class="line" data-startTime="2257">don't rely on JavaScript? </span></p>

<p class="speaker"><span class="line" data-starttime="2262"><span class="speakerName">Grace Kloba</span>: Different page? </span></p>

<p class="speaker"><span class="line" data-starttime="2264"><span class="speakerName">Audience</span>: Panes. </span><span class="line" data-startTime="2265">So for example, your </span><span class="line" data-startTime="2265">iOS session </span><span class="line" data-startTime="2267">example was a good one. </span><span class="line" data-startTime="2268">I noticed on iOS on Safari </span><span class="line" data-startTime="2268">that while the vertical </span><span class="line" data-startTime="2271">scrolling sticks nicely, the </span><span class="line" data-startTime="2271">horizontal scrolling doesn't </span><span class="line" data-startTime="2273">work at all. </span><span class="line" data-startTime="2274">It doesn't keep it in </span><span class="line" data-startTime="2274">sync as you scroll. </span><span class="line" data-startTime="2276">So are there mechanisms to have </span><span class="line" data-startTime="2276">different divs within a </span><span class="line" data-startTime="2279">web page where the scrolling in </span><span class="line" data-startTime="2279">one direction or the other </span><span class="line" data-startTime="2282">is synced between them, and yet, </span><span class="line" data-startTime="2282">still have some of the </span><span class="line" data-startTime="2285">advantages of layering? </span></p>

<p class="speaker"><span class="line" data-starttime="2289"><span class="speakerName">Grace Kloba</span>: I think, if I </span><span class="line" data-startTime="2289">understand the question, is </span><span class="line" data-startTime="2292">you want the vertical scroll </span><span class="line" data-startTime="2292">handled by the browser, but </span><span class="line" data-startTime="2296">the left and the right </span><span class="line" data-startTime="2296">handled by content? </span></p>

<p class="speaker"><span class="line" data-starttime="2298"><span class="speakerName">Audience</span>: Yeah, think of Google </span><span class="line" data-startTime="2298">spreadsheet where you </span><span class="line" data-startTime="2300">have the ability to split panes </span><span class="line" data-startTime="2300">and go both directions. </span><span class="line" data-startTime="2304">Well, when I scroll horizontally </span><span class="line" data-startTime="2304">I need both the </span><span class="line" data-startTime="2308">header, or top and bottom </span><span class="line" data-startTime="2308">panes, to stay in sync. </span></p>

<p class="speaker"><span class="line" data-starttime="2313"><span class="speakerName">Colt McAnlis</span>: I think the &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="2313"><span class="speakerName">Audience</span>: When I scroll </span><span class="line" data-startTime="2313">vertically I need &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="2314"><span class="speakerName">Colt McAnlis</span>: You have </span><span class="line" data-startTime="2314">to invoke dark magic. </span><span class="line" data-startTime="2319">That's a tricky one. </span><span class="line" data-startTime="2321">Let's dig deep on that if </span><span class="line" data-startTime="2321">you guys wouldn't mind. </span><span class="line" data-startTime="2324">We're actually running </span><span class="line" data-startTime="2324">out of time here. </span><span class="line" data-startTime="2325">And I know there's lots of </span><span class="line" data-startTime="2325">question, so Grace and I will </span><span class="line" data-startTime="2327">actually be at the Chrome </span><span class="line" data-startTime="2327">Office Hours for </span><span class="line" data-startTime="2329">the next half hour. </span><span class="line" data-startTime="2330">Please, everyone in line and </span><span class="line" data-startTime="2330">anyone else who has questions, </span><span class="line" data-startTime="2333">please come meet us there. </span><span class="line" data-startTime="2334">Let's talk more about this stuff </span><span class="line" data-startTime="2334">and help you guys out. </span><span class="line" data-startTime="2336">Once again, thank you </span><span class="line" data-startTime="2336">for your time today. </span><span class="line" data-startTime="2337">Appreciate it. </span><span class="line" data-startTime="2338">[APPLAUSE] </span></p>