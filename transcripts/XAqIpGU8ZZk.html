<style>* {font-family: "Open Sans", sans-serif}
a {color: #77aaff}
a.video {border-bottom: 1px solid #ddd; display: block; margin: 0 0 2em 0; padding: 0 0 2em 0}
h2 {color: #444; font-size: 18px;}
span.speakerName {color: black; font-weight: 900;}
body {padding: 2em}
p {color: #444; margin: 0; text-indent: 1.5em;}
p.speaker {margin: 1em 0 0 0; text-indent: 0;}
div#transcript > p:first-child {text-indent: 0;}
</style>

<h1>GDC 2012: From Console to Chrome</h1>

<h2>Lilli Thompson</h2>

<a class="video" href="http://youtu.be/XAqIpGU8ZZk">youtu.be/XAqIpGU8ZZk</a><div id="transcript"><p class="speaker"><span class="line" data-starttime="5"><span class="speakerName">Lilli Thompson</span>: Hello. </span> <span class="line" data-startTime="5">I'm Lilli Thompson, and this </span><span class="line" data-startTime="5">is Console to Chrome, HTML5 </span><span class="line" data-startTime="9">and JavaScript for </span><span class="line" data-startTime="9">game developers. </span> <span class="line" data-startTime="12">So first of all, just a little </span><span class="line" data-startTime="12">bit of background on me. </span> <span class="line" data-startTime="16">So I am an ex-console game </span><span class="line" data-startTime="16">programmer that joined Google </span><span class="line" data-startTime="19">as a software engineer. </span> <span class="line" data-startTime="20">And I did that for a couple of </span><span class="line" data-startTime="20">years, nothing to do with </span><span class="line" data-startTime="22">graphics or game, just generic </span><span class="line" data-startTime="22">software engineering. </span> <span class="line" data-startTime="26">And then, I found that </span><span class="line" data-startTime="26">I really missed game </span><span class="line" data-startTime="27">development. </span> <span class="line" data-startTime="28">So I then joined the </span><span class="line" data-startTime="28">Chrome team as a </span><span class="line" data-startTime="30">game developer advocate. </span> <span class="line" data-startTime="32">And what that means is that what </span><span class="line" data-startTime="32">I do now is that I work </span><span class="line" data-startTime="35">with game developers who are </span><span class="line" data-startTime="35">working with technologies that </span><span class="line" data-startTime="37">are a priority for Chrome. </span> <span class="line" data-startTime="39">And the big two for me </span><span class="line" data-startTime="39">are HTML5 and WebGL. </span> <span class="line" data-startTime="42">So that's what I do a lot of, </span><span class="line" data-startTime="42">and that's why I'm here today. </span> <span class="line" data-startTime="47">So first of all, an overview </span><span class="line" data-startTime="47">of this talk. </span></p>

<p><span class="line" data-startTime="49">The thing you really need to </span><span class="line" data-startTime="49">know is that this is a </span><span class="line" data-startTime="52">201-level talk. </span> <span class="line" data-startTime="54">I'm not going to give </span><span class="line" data-startTime="54">you the HTML5 pitch. </span> <span class="line" data-startTime="56">And I'm not going to give you an </span><span class="line" data-startTime="56">intro to game development. </span> <span class="line" data-startTime="58">I'm going to assume that you're </span><span class="line" data-startTime="58">a game developer type </span><span class="line" data-startTime="60">person that already knows that </span><span class="line" data-startTime="60">they want to use HTML5. </span> <span class="line" data-startTime="64">Maybe you've done a WebGL </span><span class="line" data-startTime="64">tutorial and even rendered </span><span class="line" data-startTime="67">your first couple </span><span class="line" data-startTime="67">of triangles. </span> <span class="line" data-startTime="69">But now, there's a huge </span><span class="line" data-startTime="69">knowledge gap between making a </span><span class="line" data-startTime="71">prototype and actually </span><span class="line" data-startTime="71">making a scalable </span><span class="line" data-startTime="74">large-scale game engine. </span> <span class="line" data-startTime="77">And so that's really what </span><span class="line" data-startTime="77">I want to address today. </span> <span class="line" data-startTime="80">And there are a couple of topics </span><span class="line" data-startTime="80">that go into that. </span> <span class="line" data-startTime="82">The first, I'll just have to </span><span class="line" data-startTime="82">go really briefly over the </span><span class="line" data-startTime="85">HTML5 APIs. </span> <span class="line" data-startTime="86">I'm not going to spend </span><span class="line" data-startTime="86">a lot of time on it. </span></p>

<p><span class="line" data-startTime="87">But I want to make sure that </span><span class="line" data-startTime="87">we're all on the same page. </span> <span class="line" data-startTime="90">Then the real meat of the </span><span class="line" data-startTime="90">issue for a lot of game </span><span class="line" data-startTime="93">developers is JavaScript. </span> <span class="line" data-startTime="94">Just writing code at that </span><span class="line" data-startTime="94">scale in JavaScript is </span><span class="line" data-startTime="97">something that a lot of console </span><span class="line" data-startTime="99">programmers struggle with. </span> <span class="line" data-startTime="101">And so I'm going to spend a lot </span><span class="line" data-startTime="101">of time there in talking </span><span class="line" data-startTime="102">about how to do that. </span> <span class="line" data-startTime="104">And then finally, when you write </span><span class="line" data-startTime="104">an HTML5 game, you're </span><span class="line" data-startTime="108">actually writing a game that </span><span class="line" data-startTime="108">renders inside a much more </span><span class="line" data-startTime="111">complicated system of Chrome's </span><span class="line" data-startTime="111">rendering system. </span> <span class="line" data-startTime="114">And so there's all sorts of </span><span class="line" data-startTime="114">things to know there. </span> <span class="line" data-startTime="117">And if you really understand how </span><span class="line" data-startTime="117">Chrome is set up, you can </span><span class="line" data-startTime="119">optimize your game and </span><span class="line" data-startTime="119">make it run better. </span></p>

<p><span class="line" data-startTime="121">So those are the topics I'm </span><span class="line" data-startTime="121">going to cover today. </span> <span class="line" data-startTime="125">So there are two major </span><span class="line" data-startTime="125">ways that people </span><span class="line" data-startTime="127">think about HTML5 games. </span> <span class="line" data-startTime="130">The first is as a means </span><span class="line" data-startTime="130">to get ubiquity. </span> <span class="line" data-startTime="132">There's a whole class of people </span><span class="line" data-startTime="132">who look at HTML5 as a </span><span class="line" data-startTime="136">way to write one code base and </span><span class="line" data-startTime="136">run it in multiple places. </span> <span class="line" data-startTime="139">So the dream is that every </span><span class="line" data-startTime="139">phone, every tablet, every PC, </span><span class="line" data-startTime="143">every device has a browser. </span> <span class="line" data-startTime="144">And if you can squish your </span><span class="line" data-startTime="144">game into a browser, into </span><span class="line" data-startTime="147">HTML5, then that's great </span><span class="line" data-startTime="147">for your maintenance. </span> <span class="line" data-startTime="150">You have one code base, and </span><span class="line" data-startTime="150">it's running everywhere. </span></p>

<p><span class="line" data-startTime="151">That's awesome. </span> <span class="line" data-startTime="153">But that particular use of HTML5 </span><span class="line" data-startTime="153">comes with a certain set </span><span class="line" data-startTime="157">of constraints. </span> <span class="line" data-startTime="158">So naturally, if you're really </span><span class="line" data-startTime="158">targeting ubiquity, if that's </span><span class="line" data-startTime="161">your point, then you have to peg </span><span class="line" data-startTime="161">the specification for your </span><span class="line" data-startTime="164">game to the lowest common </span><span class="line" data-startTime="164">denominator, both in terms of </span><span class="line" data-startTime="168">what APIs you can use, because </span><span class="line" data-startTime="168">you need APIs that are very </span><span class="line" data-startTime="170">broadly supported, and also in </span><span class="line" data-startTime="170">terms of what you can demand </span><span class="line" data-startTime="174">out of the hardware because you </span><span class="line" data-startTime="174">have to assume that you </span><span class="line" data-startTime="175">want to run just as well on a </span><span class="line" data-startTime="175">phone as you do on a desktop. </span> <span class="line" data-startTime="179">So anyway, very nice use of </span><span class="line" data-startTime="179">HTML5, but then there's this </span><span class="line" data-startTime="182">other way people think about </span><span class="line" data-startTime="182">it, which is as a way to do </span><span class="line" data-startTime="185">something awesome with </span><span class="line" data-startTime="185">the browser. </span> <span class="line" data-startTime="187">So there's a different set of </span><span class="line" data-startTime="187">people who see the browser as </span><span class="line" data-startTime="190">a distribution platform for </span><span class="line" data-startTime="190">their console-style games and </span><span class="line" data-startTime="194">are really excited by all the </span><span class="line" data-startTime="194">great new potential that HTML5 </span><span class="line" data-startTime="197">had added to the browser. </span></p>

<p><span class="line" data-startTime="199">And they really want to take </span><span class="line" data-startTime="199">advantage of that. </span> <span class="line" data-startTime="201">And there's a huge potential </span><span class="line" data-startTime="201">there, making sharable, </span><span class="line" data-startTime="203">linkable, seamless </span><span class="line" data-startTime="203">experiences. </span> <span class="line" data-startTime="205">You can get so many </span><span class="line" data-startTime="205">users that way. </span> <span class="line" data-startTime="207">And it's so exciting. </span> <span class="line" data-startTime="208">But as you can imagine, these </span><span class="line" data-startTime="208">people who are really </span><span class="line" data-startTime="211">interested in being on the </span><span class="line" data-startTime="211">leading edge, their goals are </span><span class="line" data-startTime="213">very different than the people </span><span class="line" data-startTime="213">who are trying to </span><span class="line" data-startTime="215">do HTML5 for ubiquity. </span> <span class="line" data-startTime="217">Because by virtue of being on </span><span class="line" data-startTime="217">the bleeding edge, these </span><span class="line" data-startTime="220">things aren't going to be </span><span class="line" data-startTime="220">supported everywhere. </span> <span class="line" data-startTime="223">If you're making a game that's </span><span class="line" data-startTime="223">a PC-style game that's really </span><span class="line" data-startTime="226">demanding, it's not going to run </span><span class="line" data-startTime="226">on 10-year-old hardware. </span></p>

<p><span class="line" data-startTime="228">And that's OK for </span><span class="line" data-startTime="228">this use case. </span> <span class="line" data-startTime="230">So whenever you talk to people </span><span class="line" data-startTime="230">about their opinions about </span><span class="line" data-startTime="234">HTML5 and what it's good for </span><span class="line" data-startTime="234">and what it isn't good for, </span><span class="line" data-startTime="236">you should make sure you </span><span class="line" data-startTime="236">understand which of these </span><span class="line" data-startTime="239">cases they're coming </span><span class="line" data-startTime="239">at it from. </span> <span class="line" data-startTime="241">And to be very clear here, </span><span class="line" data-startTime="241">what I want to talk about </span><span class="line" data-startTime="243">today is the leading </span><span class="line" data-startTime="243">edge of HTML5. </span> <span class="line" data-startTime="246">I want to talk about credible </span><span class="line" data-startTime="246">console-style experiences </span><span class="line" data-startTime="249">rendered in the browser. </span> <span class="line" data-startTime="253">So to begin talking about that, </span><span class="line" data-startTime="253">we need to talk about </span><span class="line" data-startTime="257">HTML5 APIs, at least briefly. </span> <span class="line" data-startTime="258">So the first one you're going </span><span class="line" data-startTime="258">to need is WebGL. </span> <span class="line" data-startTime="261">So WebGL is the way you do 3D </span><span class="line" data-startTime="261">rendering in a browser. </span></p>

<p><span class="line" data-startTime="264">It's a lot like OpenGL. </span> <span class="line" data-startTime="265">So if you're already an OpenGL </span><span class="line" data-startTime="265">programmer, it's going to be </span><span class="line" data-startTime="268">pretty familiar to you, </span><span class="line" data-startTime="268">except for it's </span><span class="line" data-startTime="271">actually OpenGL ES 2.0. </span> <span class="line" data-startTime="273">It's the embedded systems </span><span class="line" data-startTime="273">version of OpenGL. </span> <span class="line" data-startTime="276">And what that means is that when </span><span class="line" data-startTime="276">they made the embedded </span><span class="line" data-startTime="279">systems versions of the </span><span class="line" data-startTime="279">specifications, they took out </span><span class="line" data-startTime="282">everything that was deemed to be </span><span class="line" data-startTime="282">redundant in order to make </span><span class="line" data-startTime="284">it small and compact to </span><span class="line" data-startTime="284">fit on mobile devices. </span> <span class="line" data-startTime="287">But that means that a lot of </span><span class="line" data-startTime="287">stuff is sort of removed. </span> <span class="line" data-startTime="291">And the first thing you're going </span><span class="line" data-startTime="291">to notice there is that </span><span class="line" data-startTime="293">fixed function lighting </span><span class="line" data-startTime="293">is gone. </span> <span class="line" data-startTime="295">So all your rendering in WebGL </span><span class="line" data-startTime="295">is going to be done through </span><span class="line" data-startTime="297">programmable shaders. </span> <span class="line" data-startTime="299">You're going to have to get </span><span class="line" data-startTime="299">used to that if you're not </span><span class="line" data-startTime="300">used to that already. </span></p>

<p><span class="line" data-startTime="302">And besides that, there are a </span><span class="line" data-startTime="302">bunch of other little things </span><span class="line" data-startTime="304">which, when I talk to game </span><span class="line" data-startTime="304">developers about them, they're </span><span class="line" data-startTime="307">usually described as annoyances, </span><span class="line" data-startTime="307">just random stuff </span><span class="line" data-startTime="310">that just is missing for </span><span class="line" data-startTime="310">whatever reason in the </span><span class="line" data-startTime="312">specification. </span> <span class="line" data-startTime="313">So for instance, depth buffer </span><span class="line" data-startTime="313">access, texture compression is </span><span class="line" data-startTime="316">only available in a limited </span><span class="line" data-startTime="316">form, instancing is missing, </span><span class="line" data-startTime="319">and so on, and so forth. </span> <span class="line" data-startTime="321">So there are little </span><span class="line" data-startTime="321">stumbling blocks. </span> <span class="line" data-startTime="322">None of them are </span><span class="line" data-startTime="322">deal breakers. </span></p>

<p><span class="line" data-startTime="323">You can still make a </span><span class="line" data-startTime="323">high-quality, graphically </span><span class="line" data-startTime="326">impressive 3D game. </span> <span class="line" data-startTime="327">But you're going to </span><span class="line" data-startTime="327">have to know that </span><span class="line" data-startTime="329">these issues are there. </span> <span class="line" data-startTime="331">And then, there's a different </span><span class="line" data-startTime="331">class of things, which is a </span><span class="line" data-startTime="334">set of operations in OpenGL </span><span class="line" data-startTime="334">ES that have a different </span><span class="line" data-startTime="338">performance profile than you </span><span class="line" data-startTime="338">might expect in Chrome. </span> <span class="line" data-startTime="341">So, for instance, anything that </span><span class="line" data-startTime="341">starts with a "read," </span><span class="line" data-startTime="343">anything that's starts with a </span><span class="line" data-startTime="343">"get" and "glFinish," that </span><span class="line" data-startTime="346">kind of operation, they're </span><span class="line" data-startTime="346">all going to be extra </span><span class="line" data-startTime="348">expensive in Chrome. </span> <span class="line" data-startTime="348">They were always somewhat </span><span class="line" data-startTime="348">expensive. </span> <span class="line" data-startTime="350">Now they're going to be </span><span class="line" data-startTime="350">really expensive. </span> <span class="line" data-startTime="352">And when we get into talking </span><span class="line" data-startTime="352">about how Chrome actually </span><span class="line" data-startTime="356">renders things, I'll be able </span><span class="line" data-startTime="356">to explain why that is. </span></p>

<p><span class="line" data-startTime="359">But besides those performance </span><span class="line" data-startTime="359">notes, the rest of the </span><span class="line" data-startTime="364">performance of WebGL is </span><span class="line" data-startTime="364">actually pretty great. </span> <span class="line" data-startTime="366">It's actually tremendously </span><span class="line" data-startTime="366">impressive. </span> <span class="line" data-startTime="369">It's really calling straight </span><span class="line" data-startTime="369">through the hardware, so the </span><span class="line" data-startTime="371">performance of WebGL is very, </span><span class="line" data-startTime="371">very similar to the </span><span class="line" data-startTime="373">performance of OpenGL. </span> <span class="line" data-startTime="375">And you can get a </span><span class="line" data-startTime="375">lot out of it. </span> <span class="line" data-startTime="377">And the other thing to note is </span><span class="line" data-startTime="377">that the specification is </span><span class="line" data-startTime="380">evolving very, very quickly. </span> <span class="line" data-startTime="381">If you look at where WebGL was </span><span class="line" data-startTime="381">a year ago versus where it is </span><span class="line" data-startTime="384">today, you're going to see </span><span class="line" data-startTime="384">a lot of improvements. </span> <span class="line" data-startTime="387">So especially, when you think </span><span class="line" data-startTime="387">about all these little things </span><span class="line" data-startTime="389">that are either annoying, or </span><span class="line" data-startTime="389">missing, or whatever, make </span><span class="line" data-startTime="391">sure you check back in with your </span><span class="line" data-startTime="391">assumptions every three </span><span class="line" data-startTime="394">to six months because fixes very </span><span class="line" data-startTime="394">well might have come into </span><span class="line" data-startTime="397">the specification. </span> <span class="line" data-startTime="398">Or better still, go to the WebGL </span><span class="line" data-startTime="398">mailing list and start </span><span class="line" data-startTime="401">talking about what it is you </span><span class="line" data-startTime="401">need and want, because they're </span><span class="line" data-startTime="404">very responsive, and a lot of </span><span class="line" data-startTime="404">changes are getting made. </span></p>

<p><span class="line" data-startTime="408">So you can render polygons. </span> <span class="line" data-startTime="410">Next thing you need to do on </span><span class="line" data-startTime="410">your way to a prototype is to </span><span class="line" data-startTime="412">be able to play some audio. </span> <span class="line" data-startTime="414">HTML5 audio is a notorious </span><span class="line" data-startTime="414">sticking point. </span> <span class="line" data-startTime="418">Everyone in the HTML5 games </span><span class="line" data-startTime="418">community has heard everybody </span><span class="line" data-startTime="421">else complain about how </span><span class="line" data-startTime="421">painful audio is. </span> <span class="line" data-startTime="424">And that's pretty true, </span><span class="line" data-startTime="424">quite honestly. </span> <span class="line" data-startTime="427">It's pretty safe to say that </span><span class="line" data-startTime="427">audio in HTML5 is the most </span><span class="line" data-startTime="431">important, least standardized </span><span class="line" data-startTime="431">thing. </span> <span class="line" data-startTime="434">And so there actually is no </span><span class="line" data-startTime="434">specification that's really </span><span class="line" data-startTime="437">suitable for this kind of game </span><span class="line" data-startTime="437">that's going to work </span><span class="line" data-startTime="439">everywhere. </span> <span class="line" data-startTime="440">So you're stuck falling back and </span><span class="line" data-startTime="440">doing different things for </span><span class="line" data-startTime="442">different browsers. </span></p>

<p><span class="line" data-startTime="443">I wish it wasn't the case, but </span><span class="line" data-startTime="443">that's sort of the world we </span><span class="line" data-startTime="445">live in today. </span> <span class="line" data-startTime="446">Of all the specifications out </span><span class="line" data-startTime="446">there, the one that I </span><span class="line" data-startTime="449">personally think is the best and </span><span class="line" data-startTime="449">most suitable for games is </span><span class="line" data-startTime="452">the web audio API, which is </span><span class="line" data-startTime="452">only in Chrome right now. </span> <span class="line" data-startTime="454">And it offers just a lot </span><span class="line" data-startTime="454">of features, sort of a </span><span class="line" data-startTime="457">graph-based audio processing </span><span class="line" data-startTime="457">system, all kinds of </span><span class="line" data-startTime="460">out-of-the-box nodes and filters </span><span class="line" data-startTime="460">you can just use. </span> <span class="line" data-startTime="462">It's hardware accelerated. </span> <span class="line" data-startTime="464">It's very accurate in </span><span class="line" data-startTime="464">its timing, and </span><span class="line" data-startTime="465">so on, and so forth. </span> <span class="line" data-startTime="466">So it will help you out. </span></p>

<p><span class="line" data-startTime="469">And then, there's so much more </span><span class="line" data-startTime="469">that I just don't have time to </span><span class="line" data-startTime="471">get to today. </span> <span class="line" data-startTime="472">There's all kinds of new APIs </span><span class="line" data-startTime="472">being added to the HTML5 </span><span class="line" data-startTime="475">standards all the time. </span> <span class="line" data-startTime="478">Instead of trying to go over </span><span class="line" data-startTime="478">them here, because I just </span><span class="line" data-startTime="480">don't have time, I'm going to </span><span class="line" data-startTime="480">add a resources slide at the </span><span class="line" data-startTime="482">end where you can go and read </span><span class="line" data-startTime="482">about any one of these </span><span class="line" data-startTime="485">particular things. </span> <span class="line" data-startTime="486">There are also lots of </span><span class="line" data-startTime="486">presentations that sort of </span><span class="line" data-startTime="487">catalog APIs for games. </span> <span class="line" data-startTime="489">But suffice to say for the </span><span class="line" data-startTime="489">moment, there are a lot of </span><span class="line" data-startTime="492">things that you should </span><span class="line" data-startTime="492">look into. </span> <span class="line" data-startTime="493">If these things don't look </span><span class="line" data-startTime="493">familiar to you yet, then you </span><span class="line" data-startTime="496">should go look them up and see </span><span class="line" data-startTime="496">if they're useful to you. </span></p>

<p><span class="line" data-startTime="500">And that's pretty </span><span class="line" data-startTime="500">much for HTML5. </span> <span class="line" data-startTime="502">Pretty much two things you need, </span><span class="line" data-startTime="502">You need to be able to </span><span class="line" data-startTime="504">render triangles. </span> <span class="line" data-startTime="504">You need to be able </span><span class="line" data-startTime="504">to play sound. </span> <span class="line" data-startTime="506">From there, you can </span><span class="line" data-startTime="506">make a prototype. </span> <span class="line" data-startTime="508">Once you've got a prototype, now </span><span class="line" data-startTime="508">comes the hard part where </span><span class="line" data-startTime="511">you take prototype </span><span class="line" data-startTime="511">to game engine. </span> <span class="line" data-startTime="513">And that transition is all about </span><span class="line" data-startTime="513">writing high-performance </span><span class="line" data-startTime="516">JavaScript. </span> <span class="line" data-startTime="517">So that's what we're going </span><span class="line" data-startTime="517">to talk about now. </span> <span class="line" data-startTime="520">And before I get too deep into </span><span class="line" data-startTime="520">it, a great big caveat that </span><span class="line" data-startTime="523">what I'm talking about </span><span class="line" data-startTime="523">is JavaScript </span><span class="line" data-startTime="525">performance for Chrome. </span> <span class="line" data-startTime="527">Every browser has its own </span><span class="line" data-startTime="527">JavaScript engine, or there </span><span class="line" data-startTime="530">are many different JavaScript </span><span class="line" data-startTime="530">implementations. </span> <span class="line" data-startTime="533">And they're all going to have </span><span class="line" data-startTime="533">different performance quirks. </span> <span class="line" data-startTime="535">Certain operations are going to </span><span class="line" data-startTime="535">be slow over here, and fast </span><span class="line" data-startTime="537">over there, and all that. </span></p>

<p><span class="line" data-startTime="538">So this presentation, I'm </span><span class="line" data-startTime="538">going to try to give you </span><span class="line" data-startTime="541">general information. </span> <span class="line" data-startTime="542">But this information has been </span><span class="line" data-startTime="542">written in the context of V8 </span><span class="line" data-startTime="545">and sort of confirmed with </span><span class="line" data-startTime="545">the V8 team for accuracy. </span> <span class="line" data-startTime="548">And I'm not trying to </span><span class="line" data-startTime="548">or qualified to </span><span class="line" data-startTime="550">speak for other browsers. </span> <span class="line" data-startTime="553">So let's talk JavaScript. </span> <span class="line" data-startTime="555">JavaScript is a high-level </span><span class="line" data-startTime="555">scripting language. </span> <span class="line" data-startTime="558">And it's extremely permissive </span><span class="line" data-startTime="558">in what it allows you to do, </span><span class="line" data-startTime="561">extremely squishy </span><span class="line" data-startTime="561">in its syntax. </span> <span class="line" data-startTime="563">It's typeless. </span> <span class="line" data-startTime="564">It's kind of interpreted. </span> <span class="line" data-startTime="565">It's just-in-time compiled. </span></p>

<p><span class="line" data-startTime="567">There's no explicit syntax </span><span class="line" data-startTime="567">for memory management. </span> <span class="line" data-startTime="570">And it's all running on a single </span><span class="line" data-startTime="570">thread with some HTML5 </span><span class="line" data-startTime="573">exceptions called web workers </span><span class="line" data-startTime="573">which you should go look up if </span><span class="line" data-startTime="576">you don't know what </span><span class="line" data-startTime="576">they are already. </span> <span class="line" data-startTime="578">So the nice thing about </span><span class="line" data-startTime="578">JavaScript is that it's great </span><span class="line" data-startTime="581">to have an application running </span><span class="line" data-startTime="581">in JavaScript in front of your </span><span class="line" data-startTime="584">end users because it is great </span><span class="line" data-startTime="584">at not falling down. </span> <span class="line" data-startTime="588">JavaScript is great at eating </span><span class="line" data-startTime="588">bad input and staying up. </span> <span class="line" data-startTime="591">Nothing makes it crash. </span> <span class="line" data-startTime="592">It's super effective at being </span><span class="line" data-startTime="592">robust. The sort of dark side </span><span class="line" data-startTime="597">of that, though, is that because </span><span class="line" data-startTime="597">JavaScript doesn't </span><span class="line" data-startTime="600">have a lot of structure of its </span><span class="line" data-startTime="600">own and because it is really, </span><span class="line" data-startTime="603">really permissive in what it </span><span class="line" data-startTime="603">allows you to do, and it never </span><span class="line" data-startTime="606">sort of spits errors at you, </span><span class="line" data-startTime="606">that while you're developing, </span><span class="line" data-startTime="608">you're sort of stuck </span><span class="line" data-startTime="608">in this Wild West </span><span class="line" data-startTime="610">kind of lawless world. </span> <span class="line" data-startTime="611">And it's really hard to work in </span><span class="line" data-startTime="611">that kind of unstructured </span><span class="line" data-startTime="615">environment. </span></p>

<p><span class="line" data-startTime="616">So from a developer standpoint, </span><span class="line" data-startTime="616">what I usually </span><span class="line" data-startTime="618">think is that you want a really </span><span class="line" data-startTime="618">permissive system for </span><span class="line" data-startTime="621">deployment, because you don't </span><span class="line" data-startTime="621">want to put something in front </span><span class="line" data-startTime="624">of end users that will crash. </span> <span class="line" data-startTime="625">And you want a really strict </span><span class="line" data-startTime="625">system for development so that </span><span class="line" data-startTime="628">JavaScript doesn't allow you </span><span class="line" data-startTime="628">to do anything silly. </span> <span class="line" data-startTime="631">And JavaScript being way over </span><span class="line" data-startTime="631">on the permissive end of the </span><span class="line" data-startTime="634">spectrum, development of </span><span class="line" data-startTime="634">large-scale systems in it can </span><span class="line" data-startTime="637">be difficult. </span></p>

<p><span class="line" data-startTime="639">So what people do, because </span><span class="line" data-startTime="639">JavaScript doesn't bring a lot </span><span class="line" data-startTime="642">of structure of its own, is that </span><span class="line" data-startTime="642">they impose artificial </span><span class="line" data-startTime="645">structure on JavaScript. </span> <span class="line" data-startTime="647">So either they have their team </span><span class="line" data-startTime="647">follow very strict coding </span><span class="line" data-startTime="650">standards, or there are patterns </span><span class="line" data-startTime="650">that allow you to </span><span class="line" data-startTime="652">privatize data. </span> <span class="line" data-startTime="653">Even though JavaScript doesn't </span><span class="line" data-startTime="653">have an actual way to </span><span class="line" data-startTime="656">privatize data, you can </span><span class="line" data-startTime="656">sort of fake it </span><span class="line" data-startTime="658">with certain patterns. </span> <span class="line" data-startTime="659">There are post-processing tools </span><span class="line" data-startTime="659">that will warn you or </span><span class="line" data-startTime="662">add static types and tell </span><span class="line" data-startTime="662">you when you're </span><span class="line" data-startTime="664">doing something silly. </span> <span class="line" data-startTime="665">So there's all that kind of </span><span class="line" data-startTime="665">stuff that you should be aware </span><span class="line" data-startTime="667">if you're making a large-scale </span><span class="line" data-startTime="667">JavaScript application. </span></p>

<p><span class="line" data-startTime="670">And then you should also just </span><span class="line" data-startTime="670">be aware that JavaScript is </span><span class="line" data-startTime="673">not going to spit a lot </span><span class="line" data-startTime="673">of errors at you. </span> <span class="line" data-startTime="675">So when there are problems in a </span><span class="line" data-startTime="675">certain part of your system, </span><span class="line" data-startTime="678">it might be hard to figure out </span><span class="line" data-startTime="678">what exactly has gone wrong, </span><span class="line" data-startTime="681">because JavaScript always thinks </span><span class="line" data-startTime="681">that everything is OK. </span> <span class="line" data-startTime="683">So it's hard to trace </span><span class="line" data-startTime="683">back error chains. </span> <span class="line" data-startTime="686">And in an environment like that, </span><span class="line" data-startTime="686">you want to code extra </span><span class="line" data-startTime="689">defensively. </span> <span class="line" data-startTime="690">The idea is that you want to </span><span class="line" data-startTime="690">design your system in a </span><span class="line" data-startTime="693">modular way, which is </span><span class="line" data-startTime="693">always a good idea. </span> <span class="line" data-startTime="695">And then, hopefully, you can </span><span class="line" data-startTime="695">design it such that if one of </span><span class="line" data-startTime="698">your modules starts behaving </span><span class="line" data-startTime="698">strangely, starts going wonky, </span><span class="line" data-startTime="701">and you can't figure out why, </span><span class="line" data-startTime="701">you can just kill it, and </span><span class="line" data-startTime="703">restart a fresh one, and </span><span class="line" data-startTime="703">reconnect it to your system </span><span class="line" data-startTime="705">while the whole thing </span><span class="line" data-startTime="705">is running. </span> <span class="line" data-startTime="706">And if you can design in that </span><span class="line" data-startTime="706">way, you'll save yourself a </span><span class="line" data-startTime="709">lot of pain dealing in the </span><span class="line" data-startTime="709">system that's sort of squishy. </span> <span class="line" data-startTime="716">So if you're still one of those </span><span class="line" data-startTime="716">people who thinks to </span><span class="line" data-startTime="719">themselves, well, JavaScript, </span><span class="line" data-startTime="719">that's a scripting language. </span></p>

<p><span class="line" data-startTime="721">You could never actually write </span><span class="line" data-startTime="721">a high-performance credible </span><span class="line" data-startTime="724">game in JavaScript. </span> <span class="line" data-startTime="725">You are dealing with seriously </span><span class="line" data-startTime="725">dated information. </span> <span class="line" data-startTime="729">JavaScript engines are really </span><span class="line" data-startTime="729">fast these days. </span> <span class="line" data-startTime="731">They are absolutely capable of </span><span class="line" data-startTime="731">doing the kind of processing </span><span class="line" data-startTime="734">required for this </span><span class="line" data-startTime="734">kind of game. </span> <span class="line" data-startTime="736">The problem is that it's just </span><span class="line" data-startTime="736">really easy to write bad code </span><span class="line" data-startTime="740">in JavaScript. </span> <span class="line" data-startTime="741">And there are a ton of examples </span><span class="line" data-startTime="741">of bad code in </span><span class="line" data-startTime="743">JavaScript that people tend </span><span class="line" data-startTime="743">to follow as patterns. </span> <span class="line" data-startTime="746">So not only is JavaScript </span><span class="line" data-startTime="746">performance squirrely in that </span><span class="line" data-startTime="751">it's hard to tell what exactly </span><span class="line" data-startTime="751">is going wrong, or small </span><span class="line" data-startTime="754">changes in your JavaScript can </span><span class="line" data-startTime="754">have really, really big </span><span class="line" data-startTime="756">performance implications, and </span><span class="line" data-startTime="756">that information isn't really </span><span class="line" data-startTime="759">surfaced all that well to you as </span><span class="line" data-startTime="759">a developer, but on top of </span><span class="line" data-startTime="762">all that, the VM itself, the </span><span class="line" data-startTime="762">actual virtual machine that's </span><span class="line" data-startTime="766">executing your JavaScript, V8 </span><span class="line" data-startTime="766">in Chrome's case, is under </span><span class="line" data-startTime="768">development too. </span></p>

<p><span class="line" data-startTime="769">So something that was slow </span><span class="line" data-startTime="769">yesterday might be fast today. </span> <span class="line" data-startTime="773">And so you have to keep all of </span><span class="line" data-startTime="773">this in your mind as you're </span><span class="line" data-startTime="775">trying to write high-performance </span><span class="line" data-startTime="775">JavaScript. </span> <span class="line" data-startTime="779">So the best way I know how to </span><span class="line" data-startTime="779">give advice on how to write </span><span class="line" data-startTime="782">high-performance JavaScript is </span><span class="line" data-startTime="782">to explain to you the pieces, </span><span class="line" data-startTime="785">the general components </span><span class="line" data-startTime="785">of how V8 is </span><span class="line" data-startTime="787">actually executing things. </span> <span class="line" data-startTime="789">And then, you can develop an </span><span class="line" data-startTime="789">intuition for what might be </span><span class="line" data-startTime="792">fast and what might be slow, </span><span class="line" data-startTime="792">and go from there. </span> <span class="line" data-startTime="794">So again, I'm talking about </span><span class="line" data-startTime="794">components of V8 here. </span> <span class="line" data-startTime="797">In general, these are components </span><span class="line" data-startTime="797">you find in a lot </span><span class="line" data-startTime="799">of JavaScript engines. </span> <span class="line" data-startTime="800">But this, in particular, </span><span class="line" data-startTime="800">is referencing V8's </span><span class="line" data-startTime="803">implementation. </span> <span class="line" data-startTime="805">So the components are you have </span><span class="line" data-startTime="805">a just-in-time compiler. </span></p>

<p><span class="line" data-startTime="807">That compiler compiles two sum </span><span class="line" data-startTime="807">representations, so you have </span><span class="line" data-startTime="810">an object model under </span><span class="line" data-startTime="810">the hood. </span> <span class="line" data-startTime="812">You have an optimizing </span><span class="line" data-startTime="812">compiler that </span><span class="line" data-startTime="814">compiles after that. </span> <span class="line" data-startTime="815">And then, at the end of the </span><span class="line" data-startTime="815">day, you have a garbage </span><span class="line" data-startTime="816">collector that's running around </span><span class="line" data-startTime="816">cleaning up after you. </span> <span class="line" data-startTime="819">So I'll talk about each </span><span class="line" data-startTime="819">of these components. </span> <span class="line" data-startTime="822">First of all, the just-in-time </span><span class="line" data-startTime="822">compiler. </span> <span class="line" data-startTime="825">So the just-in-time compiler, </span><span class="line" data-startTime="825">what it does is </span><span class="line" data-startTime="827">very easy to explain. </span> <span class="line" data-startTime="828">It looks at the JavaScript </span><span class="line" data-startTime="828">you wrote. </span> <span class="line" data-startTime="830">And it takes snippets of your </span><span class="line" data-startTime="830">JavaScript, and it turns them </span><span class="line" data-startTime="832">into native code. </span> <span class="line" data-startTime="834">And that translation, the </span><span class="line" data-startTime="834">directive of the just-in-time </span><span class="line" data-startTime="837">compiler, is to do that as </span><span class="line" data-startTime="837">quickly as possible. </span> <span class="line" data-startTime="840">It doesn't try to be overly </span><span class="line" data-startTime="840">clever or to specialize or </span><span class="line" data-startTime="845">optimize at that point. </span></p>

<p><span class="line" data-startTime="846">It's trying to make the </span><span class="line" data-startTime="846">interpretation of JavaScript </span><span class="line" data-startTime="848">files fast. So it just </span><span class="line" data-startTime="848">does that translation </span><span class="line" data-startTime="850">as fast as it can. </span> <span class="line" data-startTime="851">And it does a great job of it. </span> <span class="line" data-startTime="853">So when we talk about the </span><span class="line" data-startTime="853">just-in-time compiler, we're </span><span class="line" data-startTime="855">talking about generating </span><span class="line" data-startTime="855">native code. </span> <span class="line" data-startTime="857">So now we need to talk </span><span class="line" data-startTime="857">about what kind of </span><span class="line" data-startTime="860">native code gets generated. </span> <span class="line" data-startTime="861">We need to talk about </span><span class="line" data-startTime="861">data types. </span> <span class="line" data-startTime="863">So the first data type of </span><span class="line" data-startTime="863">interest is numbers, numeric </span><span class="line" data-startTime="866">types, of course, </span><span class="line" data-startTime="866">very important. </span></p>

<p><span class="line" data-startTime="869">So V8 has two major internal </span><span class="line" data-startTime="869">representations of numbers. </span> <span class="line" data-startTime="873">There are small ints values </span><span class="line" data-startTime="873">and heap numbers, and they </span><span class="line" data-startTime="876">have different performance </span><span class="line" data-startTime="876">profiles. </span> <span class="line" data-startTime="878">So small ints are the case you </span><span class="line" data-startTime="878">want to be in if you can. </span> <span class="line" data-startTime="881">They are immediate values as </span><span class="line" data-startTime="881">opposed to heap numbers, which </span><span class="line" data-startTime="885">are allocated somewhere </span><span class="line" data-startTime="885">else on the heap. </span> <span class="line" data-startTime="887">Small ints are something you're </span><span class="line" data-startTime="887">just holding on to. </span> <span class="line" data-startTime="889">And that means they're really </span><span class="line" data-startTime="889">fast to interact with. </span> <span class="line" data-startTime="895">The size of a heap number is </span><span class="line" data-startTime="895">an interesting question. </span> <span class="line" data-startTime="897">On 32-bit machines, heap numbers </span><span class="line" data-startTime="897">are ints that are 31 </span><span class="line" data-startTime="901">bits or less. </span> <span class="line" data-startTime="902">On 64-bit machines, small ints </span><span class="line" data-startTime="902">are 32 bits or less. </span></p>

<p><span class="line" data-startTime="907">So there's some sort </span><span class="line" data-startTime="907">of intricacy there. </span> <span class="line" data-startTime="910">In general, you probably want to </span><span class="line" data-startTime="910">target both 32-bit machines </span><span class="line" data-startTime="913">and 64-bit machines. </span> <span class="line" data-startTime="915">So you probably want </span><span class="line" data-startTime="915">to aim for 31-bit </span><span class="line" data-startTime="918">integers if you can. </span> <span class="line" data-startTime="919">Now, don't go crazy with this, </span><span class="line" data-startTime="919">because other kinds of numbers </span><span class="line" data-startTime="922">can be optimized later too. </span> <span class="line" data-startTime="924">But if you have a system, like </span><span class="line" data-startTime="924">your OPT tree system or your </span><span class="line" data-startTime="926">particle system that lends </span><span class="line" data-startTime="926">itself to being cast in terms </span><span class="line" data-startTime="930">of integer math, it might be a </span><span class="line" data-startTime="930">major performance improvement </span><span class="line" data-startTime="934">for you if you can get into </span><span class="line" data-startTime="934">these SMI values. </span> <span class="line" data-startTime="937">So that's SMIs. </span></p>

<p><span class="line" data-startTime="939">Then we have heap numbers. </span> <span class="line" data-startTime="940">So heap numbers are anything </span><span class="line" data-startTime="940">that won't fit into an SMI and </span><span class="line" data-startTime="943">is not a local variable. </span> <span class="line" data-startTime="945">So exactly like you'd expect, </span><span class="line" data-startTime="945">these numbers can't be </span><span class="line" data-startTime="948">allocated in an immediate </span><span class="line" data-startTime="948">mode. </span> <span class="line" data-startTime="949">So they need to be wrapped up </span><span class="line" data-startTime="949">and allocated on the heap, </span><span class="line" data-startTime="952">which means that now they're </span><span class="line" data-startTime="952">going to be slightly slower to </span><span class="line" data-startTime="954">deal with because you're </span><span class="line" data-startTime="954">referencing a number that's </span><span class="line" data-startTime="956">somewhere else. </span> <span class="line" data-startTime="958">Now, before you go crazy, again, </span><span class="line" data-startTime="958">I want to make sure </span><span class="line" data-startTime="960">that I don't accidentally tell </span><span class="line" data-startTime="960">you to overspecialize. </span></p>

<p><span class="line" data-startTime="962">Doubles are sometimes </span><span class="line" data-startTime="962">optimized. </span> <span class="line" data-startTime="964">V8 knows that math is </span><span class="line" data-startTime="964">really important. </span> <span class="line" data-startTime="966">It's something people </span><span class="line" data-startTime="966">want to do a lot of. </span> <span class="line" data-startTime="968">So we'll try to optimize </span><span class="line" data-startTime="968">your doubles. </span> <span class="line" data-startTime="970">It'll try to allocate them </span><span class="line" data-startTime="970">in immediate mode. </span> <span class="line" data-startTime="972">It'll try to allocate them </span><span class="line" data-startTime="972">in registers if it can. </span> <span class="line" data-startTime="975">But it might not be able to, so </span><span class="line" data-startTime="975">there's no guarantee there. </span> <span class="line" data-startTime="978">So again, don't go crazy trying </span><span class="line" data-startTime="978">to make all small ints. </span> <span class="line" data-startTime="980">But if you can, if it lends </span><span class="line" data-startTime="980">itself to your system, it </span><span class="line" data-startTime="983">could work for you. </span> <span class="line" data-startTime="986">So that's numbers. </span> <span class="line" data-startTime="987">Next, we need to talk </span><span class="line" data-startTime="987">about arrays. </span></p>

<p><span class="line" data-startTime="989">So the first type of array to </span><span class="line" data-startTime="989">talk about in JavaScript is </span><span class="line" data-startTime="993">the TypedArray. </span> <span class="line" data-startTime="994">So TypedArrays are going to make </span><span class="line" data-startTime="994">a lot of sense to you if </span><span class="line" data-startTime="998">you're coming from </span><span class="line" data-startTime="998">a C background. </span> <span class="line" data-startTime="999">They are contiguous blocks of </span><span class="line" data-startTime="999">memory that are specified for </span><span class="line" data-startTime="1003">a particular data type. </span> <span class="line" data-startTime="1005">So you have Uint32Array, </span><span class="line" data-startTime="1005">Float64Array, Uint8Array, and </span><span class="line" data-startTime="1008">so on, and so forth, which </span><span class="line" data-startTime="1008">actually, if you're familiar </span><span class="line" data-startTime="1010">with JavaScript, is </span><span class="line" data-startTime="1010">sort of unusual. </span> <span class="line" data-startTime="1012">Because most things in </span><span class="line" data-startTime="1012">JavaScript have no type. </span> <span class="line" data-startTime="1014">So this idea that we're </span><span class="line" data-startTime="1014">specifying a very specific </span><span class="line" data-startTime="1018">size for our numbers is actually </span><span class="line" data-startTime="1018">like pretty unique. </span> <span class="line" data-startTime="1021">And that's because the </span><span class="line" data-startTime="1021">TypedArray specification grew </span><span class="line" data-startTime="1024">up alongside the WebGL </span><span class="line" data-startTime="1024">specification. </span></p>

<p><span class="line" data-startTime="1027">And you can imagine how you need </span><span class="line" data-startTime="1027">that level of specificity </span><span class="line" data-startTime="1030">if you're doing graphics </span><span class="line" data-startTime="1030">programming. </span> <span class="line" data-startTime="1032">So that's sort of where </span><span class="line" data-startTime="1032">the TypedArray </span><span class="line" data-startTime="1033">specification came from. </span> <span class="line" data-startTime="1034">But it's been adopted </span><span class="line" data-startTime="1034">into other things </span><span class="line" data-startTime="1037">now that it's there. </span> <span class="line" data-startTime="1038">So again, they're memory </span><span class="line" data-startTime="1038">efficient. </span> <span class="line" data-startTime="1039">You don't have to box them. </span> <span class="line" data-startTime="1040">They behave as you'd expect. </span> <span class="line" data-startTime="1041">They're a very nice </span><span class="line" data-startTime="1041">option for arrays. </span> <span class="line" data-startTime="1044">But if you can't use TypedArrays </span><span class="line" data-startTime="1044">for whatever </span><span class="line" data-startTime="1047">reason, you need to use </span><span class="line" data-startTime="1047">JavaScript Arrays. </span> <span class="line" data-startTime="1049">So JavaScript Array object &mdash; </span><span class="line" data-startTime="1051">Array with a capital A &mdash; </span><span class="line" data-startTime="1053">has an API which is going to </span><span class="line" data-startTime="1053">look a little weird to you if </span><span class="line" data-startTime="1055">you are used to C-style </span><span class="line" data-startTime="1055">arrays. </span> <span class="line" data-startTime="1058">It's going to have operations </span><span class="line" data-startTime="1058">that are different. </span> <span class="line" data-startTime="1060">It's going to have like </span><span class="line" data-startTime="1060">push and pop. </span></p>

<p><span class="line" data-startTime="1061">It's going to allow you to </span><span class="line" data-startTime="1061">index out of bounds. </span> <span class="line" data-startTime="1064">It's going to have just sort </span><span class="line" data-startTime="1064">of odd behavior to me as </span><span class="line" data-startTime="1068">somebody coming from C. </span> <span class="line" data-startTime="1070">So as you can imagine, because </span><span class="line" data-startTime="1070">the API allows all these non-C </span><span class="line" data-startTime="1074">array-like things, the backing </span><span class="line" data-startTime="1074">storage in V8 is not always </span><span class="line" data-startTime="1077">something that looks </span><span class="line" data-startTime="1077">like an array. </span> <span class="line" data-startTime="1080">There are actually two different </span><span class="line" data-startTime="1080">types of backing </span><span class="line" data-startTime="1082">storage for arrays. </span> <span class="line" data-startTime="1083">There are sparse arrays and </span><span class="line" data-startTime="1083">dense arrays, which map to </span><span class="line" data-startTime="1086">either something that looks </span><span class="line" data-startTime="1086">like a C-style array, like </span><span class="line" data-startTime="1088">you'd expect, or a hash table. </span> <span class="line" data-startTime="1091">And if your array is backed by a </span><span class="line" data-startTime="1091">V8 hash table, that's called </span><span class="line" data-startTime="1094">being in dictionary </span><span class="line" data-startTime="1094">mode, and it's </span><span class="line" data-startTime="1096">considerably less efficient. </span> <span class="line" data-startTime="1097">It's a case that you </span><span class="line" data-startTime="1097">want to avoid. </span></p>

<p><span class="line" data-startTime="1102">There are many factors in V8 </span><span class="line" data-startTime="1102">that causes you to be kicked </span><span class="line" data-startTime="1104">into dictionary mode or not. </span> <span class="line" data-startTime="1107">So it's kind of complicated </span><span class="line" data-startTime="1107">to define them all. </span> <span class="line" data-startTime="1110">But one of them, for instance, </span><span class="line" data-startTime="1110">is space efficiency. </span> <span class="line" data-startTime="1113">So if the codes you wrote will </span><span class="line" data-startTime="1113">be three times more efficient, </span><span class="line" data-startTime="1116">use three times less space if it </span><span class="line" data-startTime="1116">was backed by a hash table </span><span class="line" data-startTime="1120">than an array, then it'll be a </span><span class="line" data-startTime="1120">hash table on the back end. </span> <span class="line" data-startTime="1123">So there are criteria </span><span class="line" data-startTime="1123">like that. </span> <span class="line" data-startTime="1125">Let me give you an example. </span> <span class="line" data-startTime="1127">So this is something that </span><span class="line" data-startTime="1127">JavaScript allows you to do. </span> <span class="line" data-startTime="1130">JavaScript allows you to create </span><span class="line" data-startTime="1130">a new uninitialized </span><span class="line" data-startTime="1132">array and then just suddenly </span><span class="line" data-startTime="1132">index into </span><span class="line" data-startTime="1134">it at whatever index. </span> <span class="line" data-startTime="1136">This, of course, doesn't make </span><span class="line" data-startTime="1136">any sense in C. It's not </span><span class="line" data-startTime="1138">something you'd actually do. </span></p>

<p><span class="line" data-startTime="1140">And in V8, it will immediately </span><span class="line" data-startTime="1140">trigger dictionary mode. </span> <span class="line" data-startTime="1144">So this, you will now have a </span><span class="line" data-startTime="1144">nice, slow array to work with, </span><span class="line" data-startTime="1147">not something you want. </span> <span class="line" data-startTime="1149">This is an example of a better </span><span class="line" data-startTime="1149">way to do things. </span> <span class="line" data-startTime="1152">So real simple change. </span> <span class="line" data-startTime="1153">All you have to do is </span><span class="line" data-startTime="1153">declare how much </span><span class="line" data-startTime="1154">storage you want up front. </span> <span class="line" data-startTime="1156">Now you have declared to V8 </span><span class="line" data-startTime="1156">that you actually want an </span><span class="line" data-startTime="1159">array of a certain size. </span> <span class="line" data-startTime="1160">V8 will back your array by a </span><span class="line" data-startTime="1160">contiguous array of that size, </span><span class="line" data-startTime="1163">and you can go from there. </span> <span class="line" data-startTime="1164">Very sensible, kind of </span><span class="line" data-startTime="1164">no-brainerish, but again, </span><span class="line" data-startTime="1168">JavaScript allows you to do it </span><span class="line" data-startTime="1168">in a way that ends up being </span><span class="line" data-startTime="1171">very inefficient, so it's </span><span class="line" data-startTime="1171">important to know. </span> <span class="line" data-startTime="1175">So that is the numeric </span><span class="line" data-startTime="1175">representation and the </span><span class="line" data-startTime="1178">immediate representation </span><span class="line" data-startTime="1178">of objects. </span> <span class="line" data-startTime="1181">Now, we're going to talk about </span><span class="line" data-startTime="1181">representing JavaScript </span><span class="line" data-startTime="1184">objects in V8. </span> <span class="line" data-startTime="1186">So objects in JavaScript </span><span class="line" data-startTime="1186">are these very </span><span class="line" data-startTime="1189">poorly defined things. </span> <span class="line" data-startTime="1190">They are associative arrays. </span> <span class="line" data-startTime="1192">They're just bundles of key </span><span class="line" data-startTime="1192">value pairs of properties. </span></p>

<p><span class="line" data-startTime="1195">So you have string value for </span><span class="line" data-startTime="1195">key, property value. </span> <span class="line" data-startTime="1198">And all property values are </span><span class="line" data-startTime="1198">these undefined whatevers, </span><span class="line" data-startTime="1201">because JavaScript doesn't </span><span class="line" data-startTime="1201">have a notion of type. </span> <span class="line" data-startTime="1203">Objects have prototype chains. </span> <span class="line" data-startTime="1205">You can add and remove </span><span class="line" data-startTime="1205">properties anywhere at the </span><span class="line" data-startTime="1208">prototype chain and on the </span><span class="line" data-startTime="1208">object itself at any point. </span> <span class="line" data-startTime="1211">JavaScript doesn't enforce </span><span class="line" data-startTime="1211">any specificity or </span><span class="line" data-startTime="1214">structure in your code. </span> <span class="line" data-startTime="1217">So if you wanted to, you could </span><span class="line" data-startTime="1217">make every single object in </span><span class="line" data-startTime="1220">your whole program absolutely </span><span class="line" data-startTime="1220">a unique set of properties. </span> <span class="line" data-startTime="1224">Nothing in JavaScript will </span><span class="line" data-startTime="1224">enforce structure or </span><span class="line" data-startTime="1227">self-similarity. </span> <span class="line" data-startTime="1229">But just because JavaScript </span><span class="line" data-startTime="1229">allows you to do that, you </span><span class="line" data-startTime="1232">really, really shouldn't. </span> <span class="line" data-startTime="1232">That's actually a terrible thing </span><span class="line" data-startTime="1232">to do for performance. </span> <span class="line" data-startTime="1235">And I'll explain why </span><span class="line" data-startTime="1235">in a minute. </span></p>

<p><span class="line" data-startTime="1239">So in V8, the V8 team looked </span><span class="line" data-startTime="1239">at trying to write a </span><span class="line" data-startTime="1245">large-scale application in </span><span class="line" data-startTime="1245">JavaScript and thought, hey, </span><span class="line" data-startTime="1247">you know what's important in </span><span class="line" data-startTime="1247">large-scale systems is </span><span class="line" data-startTime="1249">object-orientedness. </span> <span class="line" data-startTime="1250">And if you have </span><span class="line" data-startTime="1250">object-orientedness in your </span><span class="line" data-startTime="1252">system, then now, property </span><span class="line" data-startTime="1252">access is one of the key </span><span class="line" data-startTime="1256">things that you need to make </span><span class="line" data-startTime="1256">fast. So V8 designed its </span><span class="line" data-startTime="1259">structure to make property </span><span class="line" data-startTime="1259">access on objects as efficient </span><span class="line" data-startTime="1263">as it could be. </span> <span class="line" data-startTime="1264">So the internal representation </span><span class="line" data-startTime="1264">of an object </span><span class="line" data-startTime="1267">in V8 is three words. </span> <span class="line" data-startTime="1269">So first, we have a hidden class </span><span class="line" data-startTime="1269">pointer, which is an </span><span class="line" data-startTime="1272">internal notion of type, which </span><span class="line" data-startTime="1272">I'll explain in a second. </span></p>

<p><span class="line" data-startTime="1275">And then we have two pointers </span><span class="line" data-startTime="1275">to different kinds of </span><span class="line" data-startTime="1276">properties. </span> <span class="line" data-startTime="1277">We have properties that have </span><span class="line" data-startTime="1277">string names and then </span><span class="line" data-startTime="1280">properties that have </span><span class="line" data-startTime="1280">int names. </span> <span class="line" data-startTime="1281">But really, the only thing </span><span class="line" data-startTime="1281">that's important is you have a </span><span class="line" data-startTime="1284">type, and then you have </span><span class="line" data-startTime="1284">property storage. </span> <span class="line" data-startTime="1287">So what's this hidden </span><span class="line" data-startTime="1287">class thing? </span><span class="line" data-startTime="1289">So hidden classes, again, </span><span class="line" data-startTime="1289">they're V8's </span><span class="line" data-startTime="1291">internal notion of type. </span> <span class="line" data-startTime="1292">JavaScript itself isn't going to </span><span class="line" data-startTime="1292">enforce any kind of notion </span><span class="line" data-startTime="1294">of type on you. </span> <span class="line" data-startTime="1296">But in order to make things </span><span class="line" data-startTime="1296">efficient, V8 itself needs to </span><span class="line" data-startTime="1299">have some sort of structure in </span><span class="line" data-startTime="1299">what it thinks you're doing. </span></p>

<p><span class="line" data-startTime="1302">So it introduces </span><span class="line" data-startTime="1302">a type system. </span> <span class="line" data-startTime="1304">And that type system </span><span class="line" data-startTime="1304">groups objects </span><span class="line" data-startTime="1306">with the same structure. </span> <span class="line" data-startTime="1307">So as you're adding properties </span><span class="line" data-startTime="1307">to objects, which you can do </span><span class="line" data-startTime="1310">in JavaScript, V8 will be </span><span class="line" data-startTime="1310">looking at the properties on </span><span class="line" data-startTime="1314">each object and mapping that </span><span class="line" data-startTime="1314">bundle of properties to a </span><span class="line" data-startTime="1317">hidden class, which defines an </span><span class="line" data-startTime="1317">object with exactly those </span><span class="line" data-startTime="1321">properties. </span> <span class="line" data-startTime="1321">So, for instance, if I have this </span><span class="line" data-startTime="1321">constructor in JavaScript </span><span class="line" data-startTime="1326">where I have a point, and it </span><span class="line" data-startTime="1326">has an x and y, and the way </span><span class="line" data-startTime="1329">those values are added by first </span><span class="line" data-startTime="1329">adding x to the object </span><span class="line" data-startTime="1332">and then adding y, that's going </span><span class="line" data-startTime="1332">to generate a hidden </span><span class="line" data-startTime="1335">class that backs objects that </span><span class="line" data-startTime="1335">are created from this function </span><span class="line" data-startTime="1339">that has exactly the </span><span class="line" data-startTime="1339">properties x and y. </span></p>

<p><span class="line" data-startTime="1342">And that really seems </span><span class="line" data-startTime="1342">sort of obvious. </span> <span class="line" data-startTime="1344">But then, the first time this </span><span class="line" data-startTime="1344">function is run, that hidden </span><span class="line" data-startTime="1347">class is going to be built </span><span class="line" data-startTime="1347">for the first time. </span> <span class="line" data-startTime="1350">And then, all subsequent times </span><span class="line" data-startTime="1350">this function is run, those </span><span class="line" data-startTime="1354">new objects can share the </span><span class="line" data-startTime="1354">same hidden class. </span> <span class="line" data-startTime="1356">So you only pay the price </span><span class="line" data-startTime="1356">for building it </span><span class="line" data-startTime="1358">the very first time. </span> <span class="line" data-startTime="1359">After that, you can just </span><span class="line" data-startTime="1359">use the same object. </span> <span class="line" data-startTime="1363">So we went through all this </span><span class="line" data-startTime="1363">trouble of building up a </span><span class="line" data-startTime="1365">notion of type. </span></p>

<p><span class="line" data-startTime="1365">So now, we have types that </span><span class="line" data-startTime="1365">correspond to specifically </span><span class="line" data-startTime="1369">what exact properties </span><span class="line" data-startTime="1369">are on an object. </span> <span class="line" data-startTime="1370">We can use that notion of type </span><span class="line" data-startTime="1370">to make property access quick </span><span class="line" data-startTime="1378">using something called </span><span class="line" data-startTime="1378">inline caching. </span> <span class="line" data-startTime="1381">So if you want to look up a </span><span class="line" data-startTime="1381">property on an object in </span><span class="line" data-startTime="1384">JavaScript, you're going to say, </span><span class="line" data-startTime="1384">I am looking for property </span><span class="line" data-startTime="1387">with name x on object y. </span> <span class="line" data-startTime="1391">The first thing you do when </span><span class="line" data-startTime="1391">you're trying to look up a </span><span class="line" data-startTime="1394">property is check the hidden </span><span class="line" data-startTime="1394">class of the object. </span> <span class="line" data-startTime="1399">If you've never tried to look up </span><span class="line" data-startTime="1399">that property on an object </span><span class="line" data-startTime="1401">of that type before, then what </span><span class="line" data-startTime="1401">you're going to have to do is </span><span class="line" data-startTime="1404">a fully generic search </span><span class="line" data-startTime="1404">for that property. </span> <span class="line" data-startTime="1407">So again, we just have a bundle </span><span class="line" data-startTime="1408">of properties somewhere. </span> <span class="line" data-startTime="1409">They all have string names. </span></p>

<p><span class="line" data-startTime="1410">You have a string of the </span><span class="line" data-startTime="1410">property you're looking for. </span> <span class="line" data-startTime="1412">And you're going to have to look </span><span class="line" data-startTime="1412">through that list for the </span><span class="line" data-startTime="1414">property that has </span><span class="line" data-startTime="1414">a matching name. </span> <span class="line" data-startTime="1416">That's a pretty slow </span><span class="line" data-startTime="1416">operation. </span> <span class="line" data-startTime="1419">But once you found that </span><span class="line" data-startTime="1419">property once, you can </span><span class="line" data-startTime="1421">remember the offset to it. </span> <span class="line" data-startTime="1423">You can remember where you found </span><span class="line" data-startTime="1423">that property and use it </span><span class="line" data-startTime="1425">later, which means that you can </span><span class="line" data-startTime="1425">use that to generate new </span><span class="line" data-startTime="1429">optimized code which specifies </span><span class="line" data-startTime="1429">how you look up that </span><span class="line" data-startTime="1432">particular property on that </span><span class="line" data-startTime="1432">particular object. </span> <span class="line" data-startTime="1435">And the next time you want to </span><span class="line" data-startTime="1435">look up property with that </span><span class="line" data-startTime="1438">name on an object of </span><span class="line" data-startTime="1438">that type, you </span><span class="line" data-startTime="1440">can have direct access. </span> <span class="line" data-startTime="1441">You know exactly where to go </span><span class="line" data-startTime="1441">in an object of that type. </span> <span class="line" data-startTime="1444">And it's much, much, </span><span class="line" data-startTime="1444">much faster. </span> <span class="line" data-startTime="1446">So that's really what the notion </span><span class="line" data-startTime="1446">of having hidden class </span><span class="line" data-startTime="1449">is getting us, is now we can </span><span class="line" data-startTime="1449">make property access really </span><span class="line" data-startTime="1452">fast through inline caching. </span></p>

<p><span class="line" data-startTime="1455">So this is a classic example </span><span class="line" data-startTime="1455">of a bad idea. </span> <span class="line" data-startTime="1459">So I have another constructor. </span> <span class="line" data-startTime="1461">It's creating a vector object. </span> <span class="line" data-startTime="1463">It's adding an x and y. </span> <span class="line" data-startTime="1465">But then, after I go through the </span><span class="line" data-startTime="1465">trouble of doing that, I </span><span class="line" data-startTime="1467">decide that I now wanted </span><span class="line" data-startTime="1467">property z on this object. </span> <span class="line" data-startTime="1471">The problem with that is that </span><span class="line" data-startTime="1471">if you add a property z to </span><span class="line" data-startTime="1474">that object at some future </span><span class="line" data-startTime="1474">point, if you just dynamically </span><span class="line" data-startTime="1476">do that, you're going to change </span><span class="line" data-startTime="1476">the hidden class of the </span><span class="line" data-startTime="1479">object, which means that all </span><span class="line" data-startTime="1479">this nice caching you've done </span><span class="line" data-startTime="1482">and building up a notion of </span><span class="line" data-startTime="1482">where the properties are, </span><span class="line" data-startTime="1484">that's just blown away </span><span class="line" data-startTime="1484">because now you have </span><span class="line" data-startTime="1485">a new hidden class. </span> <span class="line" data-startTime="1486">You have to pay to build the new </span><span class="line" data-startTime="1486">hidden class, and now you </span><span class="line" data-startTime="1488">have to deal with a </span><span class="line" data-startTime="1488">new hidden class. </span> <span class="line" data-startTime="1490">So one of the best things you </span><span class="line" data-startTime="1490">can do to make your code </span><span class="line" data-startTime="1493">efficient is to create a </span><span class="line" data-startTime="1493">few well-defined types. </span> <span class="line" data-startTime="1496">Don't do a lot of dynamic </span><span class="line" data-startTime="1496">property adding and removing </span><span class="line" data-startTime="1498">outside of constructors. </span></p>

<p><span class="line" data-startTime="1500">Pretty much set things up once, </span><span class="line" data-startTime="1500">have them look alike so </span><span class="line" data-startTime="1503">that they can share the same </span><span class="line" data-startTime="1503">hidden class, and don't mess </span><span class="line" data-startTime="1505">with the properties they have. </span> <span class="line" data-startTime="1509">So now we know an object </span><span class="line" data-startTime="1509">has properties. </span> <span class="line" data-startTime="1511">Those properties can be in </span><span class="line" data-startTime="1511">different storage states. </span> <span class="line" data-startTime="1515">So the first state, the default, </span><span class="line" data-startTime="1515">is that they can be </span><span class="line" data-startTime="1517">stored directly in an </span><span class="line" data-startTime="1517">array on the object. </span> <span class="line" data-startTime="1519">That's great. </span> <span class="line" data-startTime="1520">That's fast. That's where </span><span class="line" data-startTime="1520">you want to be. </span> <span class="line" data-startTime="1522">A second state they can be in </span><span class="line" data-startTime="1522">is being stored in array off </span><span class="line" data-startTime="1525">the objects. </span> <span class="line" data-startTime="1526">Still great. </span> <span class="line" data-startTime="1526">Still an array. </span></p>

<p><span class="line" data-startTime="1527">No problem. </span> <span class="line" data-startTime="1528">The third case, which is the </span><span class="line" data-startTime="1528">one you really have to look </span><span class="line" data-startTime="1530">out for, is when they're </span><span class="line" data-startTime="1530">stored in a hash table. </span> <span class="line" data-startTime="1533">So much like just the array case </span><span class="line" data-startTime="1533">in general where arrays </span><span class="line" data-startTime="1536">can have different types of </span><span class="line" data-startTime="1536">backing storage, properties </span><span class="line" data-startTime="1539">can have different types </span><span class="line" data-startTime="1539">of backing storage too. </span> <span class="line" data-startTime="1541">So properties can either be in </span><span class="line" data-startTime="1541">normal mode where they're </span><span class="line" data-startTime="1543">stored as an array or a </span><span class="line" data-startTime="1543">dictionary mode where they're </span><span class="line" data-startTime="1546">stored as a hash table. </span> <span class="line" data-startTime="1547">And if you have an object in </span><span class="line" data-startTime="1547">dictionary mode, it's going to </span><span class="line" data-startTime="1549">be much slower to </span><span class="line" data-startTime="1549">interact with. </span></p>

<p><span class="line" data-startTime="1551">So you don't want that. </span> <span class="line" data-startTime="1553">So what triggers dictionary </span><span class="line" data-startTime="1553">mode, and how do you avoid it? </span><span class="line" data-startTime="1556">Well, one thing that triggers </span><span class="line" data-startTime="1556">it is too many properties. </span> <span class="line" data-startTime="1558">So if you have so many </span><span class="line" data-startTime="1558">properties that they won't fit </span><span class="line" data-startTime="1561">into the internal storage for </span><span class="line" data-startTime="1561">properties, then you have to </span><span class="line" data-startTime="1563">have a hash table elsewhere. </span> <span class="line" data-startTime="1565">And that number of too </span><span class="line" data-startTime="1565">many properties is </span><span class="line" data-startTime="1567">somewhere around 30. </span> <span class="line" data-startTime="1568">It's quite generous, but you </span><span class="line" data-startTime="1568">might hit it in some cases. </span> <span class="line" data-startTime="1572">The other things you can do to </span><span class="line" data-startTime="1572">confuse your object and kick </span><span class="line" data-startTime="1576">it into dictionary mode </span><span class="line" data-startTime="1576">are to change the </span><span class="line" data-startTime="1579">properties on that object. </span> <span class="line" data-startTime="1580">You can change the attribute, </span><span class="line" data-startTime="1580">you can delete properties, </span><span class="line" data-startTime="1583">that kind of thing. </span></p>

<p><span class="line" data-startTime="1583">Those things are all going </span><span class="line" data-startTime="1583">to kick you straight to </span><span class="line" data-startTime="1585">dictionary mode. </span> <span class="line" data-startTime="1585">Again, and now you're going to </span><span class="line" data-startTime="1585">make your object much slower </span><span class="line" data-startTime="1588">to interact with. </span> <span class="line" data-startTime="1593">So that's object storage. </span> <span class="line" data-startTime="1594">And we have a general idea of </span><span class="line" data-startTime="1594">what we want to do, which is </span><span class="line" data-startTime="1597">pretty much create repeating </span><span class="line" data-startTime="1597">common stable structures in </span><span class="line" data-startTime="1601">our code, not change them too </span><span class="line" data-startTime="1601">much so we can do all our nice </span><span class="line" data-startTime="1603">caching and stuff. </span> <span class="line" data-startTime="1604">Now, we're going to talk about </span><span class="line" data-startTime="1604">the optimizing compiler which </span><span class="line" data-startTime="1606">is how you really make </span><span class="line" data-startTime="1606">JavaScript fast. </span> <span class="line" data-startTime="1610">So the optimizing compiler is </span><span class="line" data-startTime="1610">the second of two compilers. </span> <span class="line" data-startTime="1613">Remember, we had the </span><span class="line" data-startTime="1613">just-in-time compiler first, </span><span class="line" data-startTime="1615">which is doing its best to just </span><span class="line" data-startTime="1615">make the translation from </span><span class="line" data-startTime="1617">JavaScript to native code </span><span class="line" data-startTime="1617">as fast as it can. </span></p>

<p><span class="line" data-startTime="1620">And then, we have this other </span><span class="line" data-startTime="1620">compiler, the optimizing </span><span class="line" data-startTime="1622">compiler, which is actually </span><span class="line" data-startTime="1622">going to look at that code </span><span class="line" data-startTime="1624">that's generated and try to make </span><span class="line" data-startTime="1624">it really good fast code. </span> <span class="line" data-startTime="1629">So because JavaScript doesn't </span><span class="line" data-startTime="1629">give you any language to tell </span><span class="line" data-startTime="1634">V8 what you're intending, the </span><span class="line" data-startTime="1634">only thing that the optimizing </span><span class="line" data-startTime="1637">compiler can do is sit back and </span><span class="line" data-startTime="1637">watch your system as it </span><span class="line" data-startTime="1640">warms up and try to infer </span><span class="line" data-startTime="1640">structures in your code. </span></p>

<p><span class="line" data-startTime="1643">It's going to watch </span><span class="line" data-startTime="1643">what you're doing. </span> <span class="line" data-startTime="1644">It's going to watch for what </span><span class="line" data-startTime="1644">types are where and how the </span><span class="line" data-startTime="1648">data is flowing through it, and </span><span class="line" data-startTime="1648">then make inferences about </span><span class="line" data-startTime="1651">the kinds of optimizations </span><span class="line" data-startTime="1651">that it can do. </span> <span class="line" data-startTime="1654">So this is a costly operation, </span><span class="line" data-startTime="1654">which is why we don't actually </span><span class="line" data-startTime="1658">just try to optimize </span><span class="line" data-startTime="1658">everything. </span> <span class="line" data-startTime="1661">The system only tries to </span><span class="line" data-startTime="1661">optimize functions that have </span><span class="line" data-startTime="1663">been deemed to be worthwhile, </span><span class="line" data-startTime="1663">and that decision is made from </span><span class="line" data-startTime="1667">a profiler thread. </span> <span class="line" data-startTime="1668">So when Crankshaft, which is </span><span class="line" data-startTime="1668">the name of V8's optimizing </span><span class="line" data-startTime="1671">compiler, spins up, spins up a </span><span class="line" data-startTime="1671">profiling thread to watch for </span><span class="line" data-startTime="1674">what functions are hot, when </span><span class="line" data-startTime="1674">it sees a function that it </span><span class="line" data-startTime="1677">thinks should be optimized, it </span><span class="line" data-startTime="1677">then looks at the type data </span><span class="line" data-startTime="1680">it's collected so far. </span></p>

<p><span class="line" data-startTime="1681">So it's like, ah, this function </span><span class="line" data-startTime="1681">seems to take ints </span><span class="line" data-startTime="1683">all the time. </span> <span class="line" data-startTime="1684">And it seems to return this </span><span class="line" data-startTime="1684">kind of data, and </span><span class="line" data-startTime="1686">so on, and so forth. </span> <span class="line" data-startTime="1687">And using that type data that </span><span class="line" data-startTime="1687">it's collected, it can do all </span><span class="line" data-startTime="1691">sorts of optimization. </span> <span class="line" data-startTime="1692">It can inline code. </span> <span class="line" data-startTime="1693">It can do loop invariant </span><span class="line" data-startTime="1693">code motion. </span> <span class="line" data-startTime="1696">It can do all sorts of </span><span class="line" data-startTime="1696">optimizations and specialize </span><span class="line" data-startTime="1698">on those types. </span> <span class="line" data-startTime="1699">Then, it can take the new </span><span class="line" data-startTime="1699">optimized fast path code it </span><span class="line" data-startTime="1703">generated, do on-stack </span><span class="line" data-startTime="1703">replacement to just swap it </span><span class="line" data-startTime="1705">out in place, hold on to the old </span><span class="line" data-startTime="1705">slow code, just in case it </span><span class="line" data-startTime="1708">needs it later, and continue on </span><span class="line" data-startTime="1708">executing without anybody </span><span class="line" data-startTime="1712">knowing the difference except </span><span class="line" data-startTime="1712">for that the code is much, </span><span class="line" data-startTime="1714">much faster now. </span> <span class="line" data-startTime="1715">So the optimizing compiler is </span><span class="line" data-startTime="1715">really the heart of what will </span><span class="line" data-startTime="1719">make your game JavaScript </span><span class="line" data-startTime="1719">performant. </span></p>

<p><span class="line" data-startTime="1722">And you really need to be </span><span class="line" data-startTime="1722">working with this system to </span><span class="line" data-startTime="1725">try to play nice with it. </span> <span class="line" data-startTime="1728">So what kind of structures are </span><span class="line" data-startTime="1728">optimized by Crankshaft? </span><span class="line" data-startTime="1731">Well, I'll tell you, </span><span class="line" data-startTime="1731">not everything. </span> <span class="line" data-startTime="1732">Not everything is an eligible </span><span class="line" data-startTime="1732">construct in your JavaScript </span><span class="line" data-startTime="1735">for optimization. </span> <span class="line" data-startTime="1737">When Crankshaft looks at a </span><span class="line" data-startTime="1737">function, it's like, ah, I </span><span class="line" data-startTime="1739">want to optimize that. </span> <span class="line" data-startTime="1740">It starts trying to </span><span class="line" data-startTime="1740">optimize the code. </span> <span class="line" data-startTime="1742">And then in the middle, it hits </span><span class="line" data-startTime="1742">something that it can't </span><span class="line" data-startTime="1744">actually do. </span> <span class="line" data-startTime="1745">It finds something that </span><span class="line" data-startTime="1745">it can't optimize. </span> <span class="line" data-startTime="1747">That's a condition </span><span class="line" data-startTime="1747">we call bailout. </span> <span class="line" data-startTime="1749">Bailout means I tried </span><span class="line" data-startTime="1749">to optimize this. </span></p>

<p><span class="line" data-startTime="1751">I tried for you, but actually, </span><span class="line" data-startTime="1751">I couldn't </span><span class="line" data-startTime="1752">do it for some reason. </span> <span class="line" data-startTime="1753">So I'm just going to not </span><span class="line" data-startTime="1753">try to optimize that. </span> <span class="line" data-startTime="1756">And there are a number of things </span><span class="line" data-startTime="1756">that cause bailouts. </span> <span class="line" data-startTime="1758">And they actually change </span><span class="line" data-startTime="1758">a good deal. </span> <span class="line" data-startTime="1760">So one thing is that functions </span><span class="line" data-startTime="1760">are too long. </span> <span class="line" data-startTime="1764">Functions that are really, </span><span class="line" data-startTime="1764">really long are not candidates </span><span class="line" data-startTime="1766">for optimization. </span> <span class="line" data-startTime="1767">This is an interesting case </span><span class="line" data-startTime="1767">because some of these tools </span><span class="line" data-startTime="1770">that try to make your JavaScript </span><span class="line" data-startTime="1770">fast, like </span><span class="line" data-startTime="1771">post-processing tools, like </span><span class="line" data-startTime="1771">closure, some of those in some </span><span class="line" data-startTime="1775">cases do such aggressive </span><span class="line" data-startTime="1775">in-lining that they create </span><span class="line" data-startTime="1778">these giant functions. </span> <span class="line" data-startTime="1779">And then, those giant functions </span><span class="line" data-startTime="1779">are no longer </span><span class="line" data-startTime="1781">candidates for optimization </span><span class="line" data-startTime="1781">by Crankshaft. </span></p>

<p><span class="line" data-startTime="1784">And so they actually make the </span><span class="line" data-startTime="1784">code a good deal slower. </span> <span class="line" data-startTime="1786">I've seen this happen. </span> <span class="line" data-startTime="1787">So when I see function too long, </span><span class="line" data-startTime="1787">you probably wouldn't </span><span class="line" data-startTime="1790">write it, a function </span><span class="line" data-startTime="1790">that long. </span> <span class="line" data-startTime="1792">But something that's </span><span class="line" data-startTime="1793">post-processing your code might. </span> <span class="line" data-startTime="1795">So you should keep </span><span class="line" data-startTime="1795">your eye on it. </span> <span class="line" data-startTime="1798">And other than that, there are </span><span class="line" data-startTime="1798">just a number of specific </span><span class="line" data-startTime="1801">cases that can't be optimized. </span> <span class="line" data-startTime="1802">If you want to see what's </span><span class="line" data-startTime="1802">being optimized and what </span><span class="line" data-startTime="1805">isn't, you can use these </span><span class="line" data-startTime="1805">two handy V8 flags. </span> <span class="line" data-startTime="1808">You can use trace-bailout, </span><span class="line" data-startTime="1808">and trace-opt. </span></p>

<p><span class="line" data-startTime="1810">Tract-bailout will spit out </span><span class="line" data-startTime="1810">the function names of what </span><span class="line" data-startTime="1813">things are bailing </span><span class="line" data-startTime="1813">out and why. </span> <span class="line" data-startTime="1815">Trace-opt will tell you what </span><span class="line" data-startTime="1816">functions are getting optimized. </span> <span class="line" data-startTime="1817">So I have a bunch of specific </span><span class="line" data-startTime="1817">output from trace-bailout. </span> <span class="line" data-startTime="1822">These actually came from a </span><span class="line" data-startTime="1822">recent trace that I ran. </span> <span class="line" data-startTime="1826">And you can see, this </span><span class="line" data-startTime="1826">sort of makes sense. </span> <span class="line" data-startTime="1828">They're very readable &mdash; </span><span class="line" data-startTime="1829">tryCatch not supported, </span><span class="line" data-startTime="1829">Forin not supported, </span><span class="line" data-startTime="1831">NonStringToString </span><span class="line" data-startTime="1831">not supported. </span> <span class="line" data-startTime="1833">I debated a lot putting </span><span class="line" data-startTime="1833">them on the slide. </span> <span class="line" data-startTime="1835">I wanted to put something up </span><span class="line" data-startTime="1835">here as representative. </span></p>

<p><span class="line" data-startTime="1838">But just know that these are the </span><span class="line" data-startTime="1838">types of things that will </span><span class="line" data-startTime="1841">change, like the V8 team is </span><span class="line" data-startTime="1841">trying to optimize this. </span> <span class="line" data-startTime="1843">They're trying to handle </span><span class="line" data-startTime="1843">more cases. </span> <span class="line" data-startTime="1845">So just keep checking in about </span><span class="line" data-startTime="1845">what in your code is bailing </span><span class="line" data-startTime="1848">out and what is working </span><span class="line" data-startTime="1848">well, and keep </span><span class="line" data-startTime="1850">watching with the flags. </span> <span class="line" data-startTime="1854">So the thing is, all those </span><span class="line" data-startTime="1854">wonderful optimizations that </span><span class="line" data-startTime="1858">Crankshaft made for you when it </span><span class="line" data-startTime="1858">does successfully optimize </span><span class="line" data-startTime="1860">functions are speculative. </span> <span class="line" data-startTime="1862">They are based on the </span><span class="line" data-startTime="1862">information that Crankshaft </span><span class="line" data-startTime="1865">has at the time they are made. </span> <span class="line" data-startTime="1867">So again, the way Crankshaft </span><span class="line" data-startTime="1867">works, it </span><span class="line" data-startTime="1868">just watches the system. </span> <span class="line" data-startTime="1869">It infers what patterns </span><span class="line" data-startTime="1869">are where. </span> <span class="line" data-startTime="1871">It sees what the types kind of </span><span class="line" data-startTime="1871">are, and then, it tries to </span><span class="line" data-startTime="1874">specialize based on that. </span></p>

<p><span class="line" data-startTime="1875">So if your code always did </span><span class="line" data-startTime="1875">things a certain way, it </span><span class="line" data-startTime="1878">always passed this function </span><span class="line" data-startTime="1878">ints, and then suddenly, it's </span><span class="line" data-startTime="1880">like, nah, I want to pass this </span><span class="line" data-startTime="1880">function objects or strings or </span><span class="line" data-startTime="1882">whatever, suddenly, the </span><span class="line" data-startTime="1882">assumptions that were made to </span><span class="line" data-startTime="1888">optimize that code </span><span class="line" data-startTime="1888">are violated. </span> <span class="line" data-startTime="1890">And that results in something </span><span class="line" data-startTime="1890">called the deopt, which is </span><span class="line" data-startTime="1892">where we have to take that slow </span><span class="line" data-startTime="1892">code that we kept around </span><span class="line" data-startTime="1896">just in case and swap it back </span><span class="line" data-startTime="1896">in for the fast code. </span> <span class="line" data-startTime="1898">And deoptimizations </span><span class="line" data-startTime="1898">are really tragic. </span> <span class="line" data-startTime="1900">They're sort of a double fail. </span></p>

<p><span class="line" data-startTime="1902">Because you paid to optimize the </span><span class="line" data-startTime="1902">code, which was expensive. </span> <span class="line" data-startTime="1905">And you paid to swap it in. </span> <span class="line" data-startTime="1906">And then you paid to swap </span><span class="line" data-startTime="1906">it back out again. </span> <span class="line" data-startTime="1908">And now, you're running slow </span><span class="line" data-startTime="1908">code again on a function that </span><span class="line" data-startTime="1911">Crankshaft thought it </span><span class="line" data-startTime="1911">should optimize. </span> <span class="line" data-startTime="1912">So you really don't want </span><span class="line" data-startTime="1912">deoptimizations. </span> <span class="line" data-startTime="1915">The way you tell whether your </span><span class="line" data-startTime="1915">code is deopting is using </span><span class="line" data-startTime="1919">another handy flag in </span><span class="line" data-startTime="1919">V8 &mdash; trace-deopt. </span> <span class="line" data-startTime="1921">And that, again, it'll </span><span class="line" data-startTime="1921">tell you the </span><span class="line" data-startTime="1922">names of the functions. </span> <span class="line" data-startTime="1923">It'll output them to stdout, </span><span class="line" data-startTime="1923">the names of the functions </span><span class="line" data-startTime="1928">that are deopting and why. </span> <span class="line" data-startTime="1929">So keep an eye on that as </span><span class="line" data-startTime="1929">you write your game. </span> <span class="line" data-startTime="1933">So in general, what you should </span><span class="line" data-startTime="1933">be taking away from all this </span><span class="line" data-startTime="1936">is that JavaScript, it's </span><span class="line" data-startTime="1936">this wonderfully </span><span class="line" data-startTime="1938">elegant dynamic language. </span></p>

<p><span class="line" data-startTime="1939">So once you get used to it, </span><span class="line" data-startTime="1939">you can do all this stuff </span><span class="line" data-startTime="1942">which is very JavaScripty. </span> <span class="line" data-startTime="1944">You can dynamically add </span><span class="line" data-startTime="1944">properties and take optional </span><span class="line" data-startTime="1946">arguments to functions and </span><span class="line" data-startTime="1946">use closures in this </span><span class="line" data-startTime="1949">very elegant way. </span> <span class="line" data-startTime="1951">Whenever you see something </span><span class="line" data-startTime="1951">that's really dynamic and </span><span class="line" data-startTime="1954">really JavaScripty, you should </span><span class="line" data-startTime="1954">be a little bit suspicious, </span><span class="line" data-startTime="1957">because, just because you're </span><span class="line" data-startTime="1957">not writing native code, </span><span class="line" data-startTime="1961">doesn't mean that someone isn't </span><span class="line" data-startTime="1961">writing native code. </span> <span class="line" data-startTime="1963">Remember that Crankshaft is over </span><span class="line" data-startTime="1963">here watching what you do </span><span class="line" data-startTime="1966">and trying to figure out what </span><span class="line" data-startTime="1966">you mean, trying to infer from </span><span class="line" data-startTime="1969">your program's behavior </span><span class="line" data-startTime="1969">what you mean. </span></p>

<p><span class="line" data-startTime="1970">So if you keep changing what </span><span class="line" data-startTime="1970">your program does, it can't </span><span class="line" data-startTime="1973">help you optimize. </span> <span class="line" data-startTime="1974">So the more type stable and </span><span class="line" data-startTime="1974">predictable and C-like you can </span><span class="line" data-startTime="1978">make your code, the better </span><span class="line" data-startTime="1978">you're going to be. </span> <span class="line" data-startTime="1982">So again, that's a </span><span class="line" data-startTime="1982">rule of thumb. </span> <span class="line" data-startTime="1984">JavaScripty JavaScriptisms can </span><span class="line" data-startTime="1984">be fast. But if you want like </span><span class="line" data-startTime="1989">a hard-and-fast rule, the more </span><span class="line" data-startTime="1989">like C it is, those things are </span><span class="line" data-startTime="1993">likely to be faster. </span> <span class="line" data-startTime="1996">So in terms of other rules, so </span><span class="line" data-startTime="1996">create a few well-defined </span><span class="line" data-startTime="1999">object types. </span> <span class="line" data-startTime="2002">Don't add way too many </span><span class="line" data-startTime="2002">properties to objects. </span> <span class="line" data-startTime="2005">Keep it reasonable. </span> <span class="line" data-startTime="2007">Don't start changing the data </span><span class="line" data-startTime="2007">types your functions take. </span> <span class="line" data-startTime="2010">Try to make things type </span><span class="line" data-startTime="2010">stable and C like. </span></p>

<p><span class="line" data-startTime="2013">Don't use functions that </span><span class="line" data-startTime="2013">are way too big. </span> <span class="line" data-startTime="2016">And in general, just as you </span><span class="line" data-startTime="2016">develop, keep an eye on what's </span><span class="line" data-startTime="2020">going on in V8. </span> <span class="line" data-startTime="2021">Profile occasionally with </span><span class="line" data-startTime="2021">trace-deopt, trace-GC, </span><span class="line" data-startTime="2024">trace-bailout, and see what's </span><span class="line" data-startTime="2024">going on and just keep an eye. </span> <span class="line" data-startTime="2030">Now the last thing. </span> <span class="line" data-startTime="2031">We'll talk about the </span><span class="line" data-startTime="2031">garbage collector. </span> <span class="line" data-startTime="2034">So JavaScript, of course, is a </span><span class="line" data-startTime="2034">garbage-collected language. </span> <span class="line" data-startTime="2038">And garbage collection hitches </span><span class="line" data-startTime="2038">are one of the very first </span><span class="line" data-startTime="2042">performance problems I hear </span><span class="line" data-startTime="2042">people complaining about. </span> <span class="line" data-startTime="2045">When people write large-scale </span><span class="line" data-startTime="2045">JavaScript systems, one of the </span><span class="line" data-startTime="2048">first things they come back </span><span class="line" data-startTime="2048">with is like, wow, we're </span><span class="line" data-startTime="2050">getting this like sawtooth </span><span class="line" data-startTime="2050">performance curve. </span> <span class="line" data-startTime="2052">What's up with that? </span><span class="line" data-startTime="2053">And that's the garbage </span><span class="line" data-startTime="2053">collector going. </span> <span class="line" data-startTime="2057">So V8's garbage collector is </span><span class="line" data-startTime="2057">a precise, incremental, </span><span class="line" data-startTime="2061">generational garbage </span><span class="line" data-startTime="2061">collector. </span> <span class="line" data-startTime="2063">Of all those adjectives, the </span><span class="line" data-startTime="2063">one you really need to care </span><span class="line" data-startTime="2065">about is generational, which </span><span class="line" data-startTime="2065">really just means there are </span><span class="line" data-startTime="2068">two areas of memory, </span><span class="line" data-startTime="2068">two or more. </span></p>

<p><span class="line" data-startTime="2071">There are actually more. </span> <span class="line" data-startTime="2072">But two areas of memory for </span><span class="line" data-startTime="2072">all intents and purposes. </span> <span class="line" data-startTime="2075">There is a small </span><span class="line" data-startTime="2075">area that's for </span><span class="line" data-startTime="2077">really short-lived objects. </span> <span class="line" data-startTime="2078">And then, there's an area for </span><span class="line" data-startTime="2078">objects that are going to live </span><span class="line" data-startTime="2081">a long time. </span> <span class="line" data-startTime="2083">And if you want to see what's </span><span class="line" data-startTime="2083">going on with the garbage </span><span class="line" data-startTime="2085">collector, you could run again </span><span class="line" data-startTime="2085">a handy dandy V8 flag &mdash; </span><span class="line" data-startTime="2088">trace-GC. </span> <span class="line" data-startTime="2089">And that will spew a bunch of </span><span class="line" data-startTime="2089">information about what's going </span><span class="line" data-startTime="2091">on with the garbage collector </span><span class="line" data-startTime="2091">for your perusal. </span> <span class="line" data-startTime="2096">So if you're trying to make </span><span class="line" data-startTime="2096">an application that is </span><span class="line" data-startTime="2098">garbage-collector friendly, one </span><span class="line" data-startTime="2098">of the things you should </span><span class="line" data-startTime="2100">be aware of is that promotion </span><span class="line" data-startTime="2100">is expensive. </span></p>

<p><span class="line" data-startTime="2103">So again, we have a </span><span class="line" data-startTime="2103">generational garbage collector. </span> <span class="line" data-startTime="2105">So we have a young generation </span><span class="line" data-startTime="2105">and an older generation. </span> <span class="line" data-startTime="2107">And the promotion of objects </span><span class="line" data-startTime="2107">from the young to the old </span><span class="line" data-startTime="2111">generation is expensive because </span><span class="line" data-startTime="2111">you're actually </span><span class="line" data-startTime="2114">copying an object out of one </span><span class="line" data-startTime="2114">area of memory into another </span><span class="line" data-startTime="2116">area of memory. </span> <span class="line" data-startTime="2117">So one of the worst things you </span><span class="line" data-startTime="2117">can do is you can have an </span><span class="line" data-startTime="2121">object that lives just long </span><span class="line" data-startTime="2121">enough to get promoted, and </span><span class="line" data-startTime="2123">then you forget about it. </span> <span class="line" data-startTime="2125">So you want, in general, either </span><span class="line" data-startTime="2125">objects that are going </span><span class="line" data-startTime="2128">to live a very short time or </span><span class="line" data-startTime="2128">objects that are going to live </span><span class="line" data-startTime="2130">a very long time. </span> <span class="line" data-startTime="2131">Medium-lived objects, you're </span><span class="line" data-startTime="2131">kind of wasting some time </span><span class="line" data-startTime="2136">promoting them. </span></p>

<p><span class="line" data-startTime="2138">The other thing you need to be </span><span class="line" data-startTime="2138">aware of is that in a system </span><span class="line" data-startTime="2142">that is garbage collected, it's </span><span class="line" data-startTime="2142">very important that you </span><span class="line" data-startTime="2145">release your references </span><span class="line" data-startTime="2145">to things. </span> <span class="line" data-startTime="2147">Pretty obvious, except for that </span><span class="line" data-startTime="2147">in JavaScript, you can </span><span class="line" data-startTime="2151">have these large systems that </span><span class="line" data-startTime="2151">are sort of hard to tell </span><span class="line" data-startTime="2153">what's going. </span> <span class="line" data-startTime="2154">Also, there are some tricky </span><span class="line" data-startTime="2154">things in JavaScript that can </span><span class="line" data-startTime="2157">hold on to references for you. </span> <span class="line" data-startTime="2158">So for instance, execution </span><span class="line" data-startTime="2158">contexts and closures can both </span><span class="line" data-startTime="2162">hold onto references </span><span class="line" data-startTime="2162">for objects and not </span><span class="line" data-startTime="2164">let them get collected. </span> <span class="line" data-startTime="2165">So you need to be a little </span><span class="line" data-startTime="2165">careful with your JavaScript. </span> <span class="line" data-startTime="2167">Keep track of where all </span><span class="line" data-startTime="2167">your memory is. </span> <span class="line" data-startTime="2171">And then, the number one thing </span><span class="line" data-startTime="2171">you can do to make a </span><span class="line" data-startTime="2173">garbage-collector friendly </span><span class="line" data-startTime="2173">application is to </span><span class="line" data-startTime="2175">not generate garbage. </span> <span class="line" data-startTime="2176">And that will help you </span><span class="line" data-startTime="2176">avoid GC stalls. </span> <span class="line" data-startTime="2180">So the difficulty with that is </span><span class="line" data-startTime="2180">that most things are objects </span><span class="line" data-startTime="2184">in JavaScript. </span> <span class="line" data-startTime="2184">Temp variables, closures, all of </span><span class="line" data-startTime="2184">this other kind of stuff is </span><span class="line" data-startTime="2187">JavaScript. </span></p>

<p><span class="line" data-startTime="2188">Very few things aren't. </span> <span class="line" data-startTime="2190">Small ints, for instance, </span><span class="line" data-startTime="2190">are one thing that is </span><span class="line" data-startTime="2193">an immediate value. </span> <span class="line" data-startTime="2194">So that's another really good </span><span class="line" data-startTime="2194">reason to use small ints. </span> <span class="line" data-startTime="2197">Other than that, good rules of </span><span class="line" data-startTime="2197">thumb are to use scratch pads, </span><span class="line" data-startTime="2199">sort of reuse variables between </span><span class="line" data-startTime="2199">functions, and to </span><span class="line" data-startTime="2204">update things in place </span><span class="line" data-startTime="2204">where you can. </span> <span class="line" data-startTime="2206">So, for instance, this is an </span><span class="line" data-startTime="2206">example of a classic bad idea. </span> <span class="line" data-startTime="2209">So it's just a simple </span><span class="line" data-startTime="2209">vector add function. </span></p>

<p><span class="line" data-startTime="2212">One of the first things </span><span class="line" data-startTime="2212">you're going to </span><span class="line" data-startTime="2213">need is a math library. </span> <span class="line" data-startTime="2214">You might think that this was a </span><span class="line" data-startTime="2214">good way to write it, except </span><span class="line" data-startTime="2217">for that this actually allocates </span><span class="line" data-startTime="2217">a brand new vector </span><span class="line" data-startTime="2219">object every time you try to </span><span class="line" data-startTime="2219">do a vector add, which is </span><span class="line" data-startTime="2222">going to be often. </span> <span class="line" data-startTime="2223">So that's going to be really, </span><span class="line" data-startTime="2223">really garbage-collector </span><span class="line" data-startTime="2225">unfriendly. </span> <span class="line" data-startTime="2227">This is a much better </span><span class="line" data-startTime="2227">way to write it. </span> <span class="line" data-startTime="2228">I actually much prefer </span><span class="line" data-startTime="2228">the first syntax. </span> <span class="line" data-startTime="2231">But this is a much better way to </span><span class="line" data-startTime="2231">write it in the context of </span><span class="line" data-startTime="2234">a garbage collector where </span><span class="line" data-startTime="2234">you actually add </span><span class="line" data-startTime="2236">to the first vector. </span></p>

<p><span class="line" data-startTime="2237">You just update the first </span><span class="line" data-startTime="2237">vector in place. </span> <span class="line" data-startTime="2239">You don't allocate </span><span class="line" data-startTime="2239">a new object. </span> <span class="line" data-startTime="2241">So this is going to </span><span class="line" data-startTime="2241">work a lot better. </span> <span class="line" data-startTime="2244">Subtle point here is that if </span><span class="line" data-startTime="2244">you're working with doubles </span><span class="line" data-startTime="2247">again, you might be boxing and </span><span class="line" data-startTime="2247">allocating new heap numbers. </span> <span class="line" data-startTime="2252">So this might create </span><span class="line" data-startTime="2252">some garbage </span><span class="line" data-startTime="2253">collector pressure anyway. </span> <span class="line" data-startTime="2254">But it's still going </span><span class="line" data-startTime="2254">to be much better. </span> <span class="line" data-startTime="2258">So now you know how to write a </span><span class="line" data-startTime="2258">high-performance JavaScript </span><span class="line" data-startTime="2261">application. </span> <span class="line" data-startTime="2262">Or hopefully, you have some </span><span class="line" data-startTime="2262">intuition as to what might be </span><span class="line" data-startTime="2265">fast, what might be slow, and </span><span class="line" data-startTime="2265">how to check whether things </span><span class="line" data-startTime="2267">are going well or not </span><span class="line" data-startTime="2267">in your JavaScript. </span> <span class="line" data-startTime="2269">That's awesome. </span></p>

<p><span class="line" data-startTime="2270">Now, we have to take that </span><span class="line" data-startTime="2270">application and put it Chrome </span><span class="line" data-startTime="2273">in the context of Chrome </span><span class="line" data-startTime="2273">where all this other </span><span class="line" data-startTime="2275">stuff is going on. </span> <span class="line" data-startTime="2275">So let's talk about that. </span> <span class="line" data-startTime="2278">So first of all, when you're </span><span class="line" data-startTime="2278">in Chrome or when you're in </span><span class="line" data-startTime="2280">any browser, it's just very </span><span class="line" data-startTime="2280">different than being on a PC </span><span class="line" data-startTime="2284">or a console. </span> <span class="line" data-startTime="2285">There's a lot of stuff </span><span class="line" data-startTime="2285">you don't know. </span> <span class="line" data-startTime="2286">You don't know what </span><span class="line" data-startTime="2286">browser you're in. </span> <span class="line" data-startTime="2289">And different browsers, they </span><span class="line" data-startTime="2289">have different performance </span><span class="line" data-startTime="2292">profiles for different </span><span class="line" data-startTime="2292">operations. </span> <span class="line" data-startTime="2294">And also, they support </span><span class="line" data-startTime="2294">different HTML5 API. </span></p>

<p><span class="line" data-startTime="2297">So every single thing you do, </span><span class="line" data-startTime="2297">you need to check whether it's </span><span class="line" data-startTime="2299">supported here. </span> <span class="line" data-startTime="2302">You don't know anything about </span><span class="line" data-startTime="2302">the local hardware. </span> <span class="line" data-startTime="2303">And this is a really hard one </span><span class="line" data-startTime="2303">for people to get their head </span><span class="line" data-startTime="2306">around how important this is. </span> <span class="line" data-startTime="2309">Most game developers who are </span><span class="line" data-startTime="2309">coming from the console PC </span><span class="line" data-startTime="2312">space have never had to deal </span><span class="line" data-startTime="2312">with a range of hardware so </span><span class="line" data-startTime="2316">broad as you have </span><span class="line" data-startTime="2316">to for the web. </span> <span class="line" data-startTime="2319">Everything from a five-year-old </span><span class="line" data-startTime="2319">phone to the </span><span class="line" data-startTime="2322">latest and greatest desktop </span><span class="line" data-startTime="2322">system of today, that's the </span><span class="line" data-startTime="2325">range of things that </span><span class="line" data-startTime="2325">can run HTML5. </span> <span class="line" data-startTime="2328">And so you can get these huge </span><span class="line" data-startTime="2328">performance differences, which </span><span class="line" data-startTime="2331">means that it's very important </span><span class="line" data-startTime="2331">that you do a lot of checking </span><span class="line" data-startTime="2335">in your code about what the </span><span class="line" data-startTime="2335">local system can handle. </span> <span class="line" data-startTime="2339">Another thing you have </span><span class="line" data-startTime="2339">to know is that your </span><span class="line" data-startTime="2340">game lives in a tab. </span></p>

<p><span class="line" data-startTime="2342">What does that mean to you? </span><span class="line" data-startTime="2343">It means that that tab can </span><span class="line" data-startTime="2343">actually close at any time. </span> <span class="line" data-startTime="2345">Now, this is always true. </span> <span class="line" data-startTime="2346">If you're writing a console </span><span class="line" data-startTime="2346">game, the user can walk up and </span><span class="line" data-startTime="2349">hit the power button </span><span class="line" data-startTime="2349">on the console. </span> <span class="line" data-startTime="2351">That's always an issue, except </span><span class="line" data-startTime="2351">for that the way people </span><span class="line" data-startTime="2354">interact with tabs in a browser </span><span class="line" data-startTime="2354">is far more ephemeral. </span> <span class="line" data-startTime="2357">It's very normal for somebody </span><span class="line" data-startTime="2357">to be playing a web game and </span><span class="line" data-startTime="2359">then be like, oh, I want to </span><span class="line" data-startTime="2359">check email and just close </span><span class="line" data-startTime="2361">that tab down. </span></p>

<p><span class="line" data-startTime="2362">And this is important for you </span><span class="line" data-startTime="2362">to know, because if you're </span><span class="line" data-startTime="2365">writing files to local cache or </span><span class="line" data-startTime="2365">something like that, you're </span><span class="line" data-startTime="2367">going to have to be very careful </span><span class="line" data-startTime="2367">that you're ready to </span><span class="line" data-startTime="2369">be shut down at any time. </span> <span class="line" data-startTime="2372">There might be other </span><span class="line" data-startTime="2372">applications running in your </span><span class="line" data-startTime="2374">same thread. </span> <span class="line" data-startTime="2374">Here, I'm talking about </span><span class="line" data-startTime="2374">Chrome specifically. </span> <span class="line" data-startTime="2377">So you might not have the whole </span><span class="line" data-startTime="2377">thread to work with. </span> <span class="line" data-startTime="2379">And there's this other </span><span class="line" data-startTime="2379">compositing and rendering </span><span class="line" data-startTime="2382">cycle that's going around your </span><span class="line" data-startTime="2382">game that's making the whole </span><span class="line" data-startTime="2384">web page itself. </span> <span class="line" data-startTime="2386">And so you need to fit </span><span class="line" data-startTime="2386">into that as well. </span></p>

<p><span class="line" data-startTime="2389">So let's talk about this </span><span class="line" data-startTime="2389">local hardware thing. </span> <span class="line" data-startTime="2391">So you know nothing about </span><span class="line" data-startTime="2391">the local environment. </span> <span class="line" data-startTime="2393">And I know I just said </span><span class="line" data-startTime="2393">this, but I really </span><span class="line" data-startTime="2396">can't stress it enough. </span> <span class="line" data-startTime="2398">Because of privacy concerns, </span><span class="line" data-startTime="2398">there's nothing in JavaScript </span><span class="line" data-startTime="2401">that allows you to ask detailed </span><span class="line" data-startTime="2401">questions about a </span><span class="line" data-startTime="2404">user's local machine. </span> <span class="line" data-startTime="2405">So there's no way that </span><span class="line" data-startTime="2405">you can ask what kind </span><span class="line" data-startTime="2407">of hardware is this? </span><span class="line" data-startTime="2408">What can it support? </span><span class="line" data-startTime="2409">So you're just in charge </span><span class="line" data-startTime="2409">of being able to </span><span class="line" data-startTime="2412">scale on your own. </span> <span class="line" data-startTime="2414">And in the PC world, </span><span class="line" data-startTime="2414">this is not a </span><span class="line" data-startTime="2416">problem because PC games &mdash; </span><span class="line" data-startTime="2418">console games don't have this </span><span class="line" data-startTime="2418">problem to begin with. </span></p>

<p><span class="line" data-startTime="2420">PC games specifically say </span><span class="line" data-startTime="2420">on them what the system </span><span class="line" data-startTime="2423">requirements are. </span> <span class="line" data-startTime="2424">And everybody's used to that. </span> <span class="line" data-startTime="2425">Everybody's happy with that. </span> <span class="line" data-startTime="2427">On the web, people have this </span><span class="line" data-startTime="2427">expectation that everything be </span><span class="line" data-startTime="2431">lowest common denominator, </span><span class="line" data-startTime="2431">which is a </span><span class="line" data-startTime="2433">blessing and a curse. </span> <span class="line" data-startTime="2434">I love that you get broad </span><span class="line" data-startTime="2434">distribution. </span> <span class="line" data-startTime="2435">However, it makes it really </span><span class="line" data-startTime="2435">hard if you're trying to </span><span class="line" data-startTime="2438">target the high end. </span></p>

<p><span class="line" data-startTime="2440">And so what you can do that </span><span class="line" data-startTime="2440">this is just be very, very </span><span class="line" data-startTime="2443">clear with your users about </span><span class="line" data-startTime="2443">how your game will run on </span><span class="line" data-startTime="2446">their machine. </span> <span class="line" data-startTime="2447">The last thing you want is to </span><span class="line" data-startTime="2447">have your users buy your game </span><span class="line" data-startTime="2450">from some web app store, the </span><span class="line" data-startTime="2450">Chrome Web Store, for </span><span class="line" data-startTime="2453">instance, and try to play it, </span><span class="line" data-startTime="2453">and then find that it doesn't </span><span class="line" data-startTime="2456">run, or it runs at 5 FPS or </span><span class="line" data-startTime="2456">whatever, because they're </span><span class="line" data-startTime="2459">running on very old hardware. </span> <span class="line" data-startTime="2460">And then, they give you </span><span class="line" data-startTime="2460">a one-star review. </span> <span class="line" data-startTime="2462">They're like, this game sucks. </span> <span class="line" data-startTime="2463">I can't run it. </span> <span class="line" data-startTime="2463">So you really, really need to </span><span class="line" data-startTime="2463">be communicating proactively </span><span class="line" data-startTime="2467">with your users about </span><span class="line" data-startTime="2467">what they can </span><span class="line" data-startTime="2468">expect from your game. </span> <span class="line" data-startTime="2469">I can't stress that enough. </span> <span class="line" data-startTime="2470">It's like really important </span><span class="line" data-startTime="2470">for end-user experience. </span></p>

<p><span class="line" data-startTime="2474">Also, if you can, you want </span><span class="line" data-startTime="2474">graceful degradation where </span><span class="line" data-startTime="2476">it's not just a binary thing. </span> <span class="line" data-startTime="2478">You want to be able to make your </span><span class="line" data-startTime="2478">games gracefully scaled </span><span class="line" data-startTime="2480">down to fit on lower-end </span><span class="line" data-startTime="2480">hardware. </span> <span class="line" data-startTime="2484">So one thing you can do </span><span class="line" data-startTime="2484">to that end is micro </span><span class="line" data-startTime="2486">benchmarking. </span> <span class="line" data-startTime="2487">And so this is where </span><span class="line" data-startTime="2487">you, yourself &mdash; </span><span class="line" data-startTime="2488">again, it's all home brew. </span> <span class="line" data-startTime="2489">Nothing in the JavaScript </span><span class="line" data-startTime="2489">standards helps you. </span> <span class="line" data-startTime="2491">But you, yourself, write little </span><span class="line" data-startTime="2491">benchmarks that stress </span><span class="line" data-startTime="2494">what your game is going </span><span class="line" data-startTime="2494">to stress and </span><span class="line" data-startTime="2497">collects data about that. </span> <span class="line" data-startTime="2498">So maybe, during your loading </span><span class="line" data-startTime="2498">screen, you run a bunch of </span><span class="line" data-startTime="2501">tests, get a feeling about what </span><span class="line" data-startTime="2501">the local system is, and </span><span class="line" data-startTime="2504">then suggest settings or send </span><span class="line" data-startTime="2504">that data back to your service </span><span class="line" data-startTime="2507">for analysis. </span> <span class="line" data-startTime="2508">Or while the game is running, </span><span class="line" data-startTime="2508">you see what the FPS is and </span><span class="line" data-startTime="2512">adjust accordingly or take </span><span class="line" data-startTime="2512">data accordingly. </span> <span class="line" data-startTime="2514">But you really need to </span><span class="line" data-startTime="2514">be proactive about </span><span class="line" data-startTime="2517">collecting this data. </span></p>

<p><span class="line" data-startTime="2519">And that's pretty much it for </span><span class="line" data-startTime="2519">dealing with the hardware </span><span class="line" data-startTime="2522">variation you're going to </span><span class="line" data-startTime="2522">find in HTML5 games. </span> <span class="line" data-startTime="2524">Collect data, communicate, and </span><span class="line" data-startTime="2524">make sure, above all, that you </span><span class="line" data-startTime="2528">set your users' expectations </span><span class="line" data-startTime="2528">appropriately. </span> <span class="line" data-startTime="2533">So up until now, I've been </span><span class="line" data-startTime="2533">talking about HTML5 </span><span class="line" data-startTime="2536">specifications. </span> <span class="line" data-startTime="2536">I've been talking about how to </span><span class="line" data-startTime="2536">make JavaScript fast. Those </span><span class="line" data-startTime="2539">things all live within V8. </span> <span class="line" data-startTime="2540">So here, we're talking about </span><span class="line" data-startTime="2540">things that live in V8. </span> <span class="line" data-startTime="2543">Let's talk about what </span><span class="line" data-startTime="2543">goes around that. </span></p>

<p><span class="line" data-startTime="2545">So V8 lives in WebKit alongside </span><span class="line" data-startTime="2545">CSS and HTML. </span> <span class="line" data-startTime="2549">So the same way V8 executes </span><span class="line" data-startTime="2549">JavaScript, there's another </span><span class="line" data-startTime="2553">machine for HTML and another </span><span class="line" data-startTime="2553">system for CSS. </span> <span class="line" data-startTime="2557">All of those things </span><span class="line" data-startTime="2557">live side by side. </span> <span class="line" data-startTime="2559">When they want to render things, </span><span class="line" data-startTime="2559">any one of those </span><span class="line" data-startTime="2562">things can send commands </span><span class="line" data-startTime="2562">on this RPC </span><span class="line" data-startTime="2564">buffer to the GPU process. </span> <span class="line" data-startTime="2567">All rendering in Chrome is done </span><span class="line" data-startTime="2567">in a separate process </span><span class="line" data-startTime="2570">entirely, not just a separate </span><span class="line" data-startTime="2570">thread, a separate process. </span> <span class="line" data-startTime="2573">And it's done on a separate </span><span class="line" data-startTime="2573">process for security reasons. </span> <span class="line" data-startTime="2576">And so this structure is very </span><span class="line" data-startTime="2576">important to understand </span><span class="line" data-startTime="2579">because you're sharing this </span><span class="line" data-startTime="2579">RPC buffer with everything </span><span class="line" data-startTime="2581">else that's trying to </span><span class="line" data-startTime="2581">render anything. </span></p>

<p><span class="line" data-startTime="2584">Then from the GPU process, it'll </span><span class="line" data-startTime="2584">actually communicate </span><span class="line" data-startTime="2587">with the drivers and the </span><span class="line" data-startTime="2587">hardware itself to do the </span><span class="line" data-startTime="2589">actual rendering. </span> <span class="line" data-startTime="2590">But there are a couple of </span><span class="line" data-startTime="2590">additional pieces of </span><span class="line" data-startTime="2593">complexity here. </span> <span class="line" data-startTime="2594">One is that on Windows where </span><span class="line" data-startTime="2594">you don't have good OpenGL </span><span class="line" data-startTime="2597">drivers, there's this layer </span><span class="line" data-startTime="2597">called ANGLE, Almost Native </span><span class="line" data-startTime="2600">Graphics Layer Engine. </span> <span class="line" data-startTime="2601">And that will do a translation </span><span class="line" data-startTime="2601">from OpenGL to DirectX. </span> <span class="line" data-startTime="2604">And then, there's this other </span><span class="line" data-startTime="2604">translation layer called </span><span class="line" data-startTime="2606">SwiftShader. </span> <span class="line" data-startTime="2607">So on machines that don't have </span><span class="line" data-startTime="2607">good drivers or drivers that </span><span class="line" data-startTime="2610">are good enough for WebGL, </span><span class="line" data-startTime="2610">SwiftShader will actually do </span><span class="line" data-startTime="2613">software rasterization. </span> <span class="line" data-startTime="2614">So there's all this complexity </span><span class="line" data-startTime="2614">from your game on down into </span><span class="line" data-startTime="2618">the actual rendering. </span> <span class="line" data-startTime="2618">So let's talk about that. </span></p>

<p><span class="line" data-startTime="2621">So first, let's talk about </span><span class="line" data-startTime="2621">the RPC buffer part. </span> <span class="line" data-startTime="2625">So if you remember way back </span><span class="line" data-startTime="2625">when I was talking about </span><span class="line" data-startTime="2627">WebGL, I mentioned that </span><span class="line" data-startTime="2627">certain commands have </span><span class="line" data-startTime="2630">unexpectedly slow performance. </span> <span class="line" data-startTime="2632">And those are anything that </span><span class="line" data-startTime="2632">starts with "read," anything </span><span class="line" data-startTime="2634">that starts with "get," these </span><span class="line" data-startTime="2634">things that require round </span><span class="line" data-startTime="2637">trips to the GPU. </span> <span class="line" data-startTime="2639">And now that you understand that </span><span class="line" data-startTime="2639">there's an RPC buffer in </span><span class="line" data-startTime="2641">there and rendering is done on a </span><span class="line" data-startTime="2641">separate process, I'm hoping </span><span class="line" data-startTime="2643">that you'll have some intuition </span><span class="line" data-startTime="2643">for why that is and </span><span class="line" data-startTime="2645">what sorts of command </span><span class="line" data-startTime="2645">might be slow. </span></p>

<p><span class="line" data-startTime="2647">So besides that, the other thing </span><span class="line" data-startTime="2647">you have to know about </span><span class="line" data-startTime="2651">that buffer is that </span><span class="line" data-startTime="2651">it's shared, and </span><span class="line" data-startTime="2653">it's limited in size. </span> <span class="line" data-startTime="2655">So there's a specific size </span><span class="line" data-startTime="2655">limit on that buffer. </span> <span class="line" data-startTime="2658">And all the resources that you </span><span class="line" data-startTime="2658">upload to the GPU are going to </span><span class="line" data-startTime="2661">eat up that size. </span> <span class="line" data-startTime="2662">And it's total size of </span><span class="line" data-startTime="2662">resources, not total of number </span><span class="line" data-startTime="2665">of resources. </span> <span class="line" data-startTime="2666">But all your textures, all </span><span class="line" data-startTime="2666">your buffers, all your </span><span class="line" data-startTime="2667">commands, they're all </span><span class="line" data-startTime="2667">going to go into the </span><span class="line" data-startTime="2669">budget for that buffer. </span> <span class="line" data-startTime="2671">And if you go over that buffer </span><span class="line" data-startTime="2671">size, then you're going to </span><span class="line" data-startTime="2676">trigger something called a sink </span><span class="line" data-startTime="2676">flush, which is slow. </span> <span class="line" data-startTime="2679">And it's going to amount </span><span class="line" data-startTime="2679">to a stall. </span> <span class="line" data-startTime="2680">So that means that you're trying </span><span class="line" data-startTime="2680">to send another command </span><span class="line" data-startTime="2682">on that buffer. </span> <span class="line" data-startTime="2683">But the buffer is </span><span class="line" data-startTime="2683">already full. </span> <span class="line" data-startTime="2684">And so the buffer is like, </span><span class="line" data-startTime="2684">ah, no room for that. </span></p>

<p><span class="line" data-startTime="2686">So I have to stop and actually </span><span class="line" data-startTime="2686">process through the whole </span><span class="line" data-startTime="2689">thing, have to flush everything </span><span class="line" data-startTime="2689">out before I can </span><span class="line" data-startTime="2690">process this new command. </span> <span class="line" data-startTime="2692">And what that's going to look </span><span class="line" data-startTime="2692">like to you is that suddenly, </span><span class="line" data-startTime="2696">one of the commands you're </span><span class="line" data-startTime="2696">sending to OpenGL is going to </span><span class="line" data-startTime="2698">look like it takes a really </span><span class="line" data-startTime="2698">long time for no reason in </span><span class="line" data-startTime="2701">your profiling view. </span> <span class="line" data-startTime="2702">You're like, wow, that command </span><span class="line" data-startTime="2702">was always perfectly fine, and </span><span class="line" data-startTime="2704">now, it's taking 40 </span><span class="line" data-startTime="2704">milliseconds. </span> <span class="line" data-startTime="2706">And that's because you spilled </span><span class="line" data-startTime="2706">the buffer, and you triggered </span><span class="line" data-startTime="2708">a sink flush. </span> <span class="line" data-startTime="2710">So really, the only thing you </span><span class="line" data-startTime="2710">can do here is try to amortize </span><span class="line" data-startTime="2714">the cost of uploading </span><span class="line" data-startTime="2714">across frames. </span> <span class="line" data-startTime="2716">So just try to limit what </span><span class="line" data-startTime="2716">you do per frame. </span> <span class="line" data-startTime="2717">If you see these big stalls, you </span><span class="line" data-startTime="2717">can have an intuition that </span><span class="line" data-startTime="2720">you're probably or might be </span><span class="line" data-startTime="2720">spilling that buffer and act </span><span class="line" data-startTime="2723">accordingly. </span></p>

<p><span class="line" data-startTime="2725">One note here is that when I </span><span class="line" data-startTime="2725">talked about this with the </span><span class="line" data-startTime="2727">Chrome GPU team, they said yes, </span><span class="line" data-startTime="2727">this is true for now. </span> <span class="line" data-startTime="2730">This is good information. </span> <span class="line" data-startTime="2731">But this is something </span><span class="line" data-startTime="2731">that's subject to </span><span class="line" data-startTime="2733">change in the future. </span> <span class="line" data-startTime="2734">So keep checking back in </span><span class="line" data-startTime="2734">with this assumption. </span> <span class="line" data-startTime="2735">Hopefully, this will get better, </span><span class="line" data-startTime="2735">that this problem of </span><span class="line" data-startTime="2740">causing sink flushes won't be </span><span class="line" data-startTime="2740">a problem in the future. </span> <span class="line" data-startTime="2742">But for now, this </span><span class="line" data-startTime="2742">is good advice. </span> <span class="line" data-startTime="2746">So now, let's talk about the </span><span class="line" data-startTime="2746">close to the hardware type </span><span class="line" data-startTime="2749">part of the system. </span></p>

<p><span class="line" data-startTime="2751">So what do you need to </span><span class="line" data-startTime="2751">know about drivers? </span><span class="line" data-startTime="2753">Really just that they're </span><span class="line" data-startTime="2753">there, and that not all </span><span class="line" data-startTime="2757">drivers are secure. </span> <span class="line" data-startTime="2758">Not all drivers are stable </span><span class="line" data-startTime="2758">for use with WebGL. </span> <span class="line" data-startTime="2761">And that means in order to </span><span class="line" data-startTime="2761">keep people's browsing </span><span class="line" data-startTime="2764">experiences secure and stable, </span><span class="line" data-startTime="2764">that many or some drivers are </span><span class="line" data-startTime="2768">blacklisted. </span> <span class="line" data-startTime="2770">So sometimes, people running </span><span class="line" data-startTime="2770">on a computer that is </span><span class="line" data-startTime="2772">perfectly a &mdash; computer and </span><span class="line" data-startTime="2772">browser perfectly capable of </span><span class="line" data-startTime="2775">playing your game will not be </span><span class="line" data-startTime="2775">able to use WebGL because </span><span class="line" data-startTime="2779">their drivers are blacklisted. </span> <span class="line" data-startTime="2781">And unfortunately, the only way </span><span class="line" data-startTime="2781">to test whether the local </span><span class="line" data-startTime="2785">machine is capable of running </span><span class="line" data-startTime="2785">WebGL is by actually trying to </span><span class="line" data-startTime="2789">create a context and </span><span class="line" data-startTime="2789">seeing if it fails. </span></p>

<p><span class="line" data-startTime="2791">So the first thing you do when </span><span class="line" data-startTime="2791">you're making a WebGL </span><span class="line" data-startTime="2793">application is make </span><span class="line" data-startTime="2793">a WebGL context. </span> <span class="line" data-startTime="2795">And you really just have to try </span><span class="line" data-startTime="2795">it, see if it works, and </span><span class="line" data-startTime="2798">then handle accordingly. </span> <span class="line" data-startTime="2799">There's no more elegant </span><span class="line" data-startTime="2799">way than that. </span> <span class="line" data-startTime="2803">The other thing I mentioned is </span><span class="line" data-startTime="2803">this Almost Native Graphics </span><span class="line" data-startTime="2806">Layer Engine, which in response </span><span class="line" data-startTime="2806">to the fact that, in </span><span class="line" data-startTime="2810">general, DirectX rendering works </span><span class="line" data-startTime="2810">better on Windows than </span><span class="line" data-startTime="2813">OpenGL rendering, or rather, </span><span class="line" data-startTime="2813">OpenGL drivers for Windows </span><span class="line" data-startTime="2817">tend to be somewhat buggy or </span><span class="line" data-startTime="2817">unstable, there's this layer </span><span class="line" data-startTime="2820">called ANGLE, which will </span><span class="line" data-startTime="2820">translate your OpenGL calls </span><span class="line" data-startTime="2823">into DirectX before rendering </span><span class="line" data-startTime="2823">on Windows only. </span> <span class="line" data-startTime="2827">Hopefully, you never need </span><span class="line" data-startTime="2827">to know about this. </span> <span class="line" data-startTime="2830">It's just sort of trivia. </span> <span class="line" data-startTime="2831">But it's good for you to know </span><span class="line" data-startTime="2831">that it's there just in case. </span></p>

<p><span class="line" data-startTime="2834">And then, finally, we </span><span class="line" data-startTime="2834">have SwiftShader. </span> <span class="line" data-startTime="2836">Again, this is software </span><span class="line" data-startTime="2836">rasterization. </span> <span class="line" data-startTime="2838">So if you have a system that's </span><span class="line" data-startTime="2838">capable of running your game, </span><span class="line" data-startTime="2844">but for some reason, their </span><span class="line" data-startTime="2844">drivers don't work, then you </span><span class="line" data-startTime="2847">might get SwiftShader, </span><span class="line" data-startTime="2847">SwiftShader software </span><span class="line" data-startTime="2849">rasterization. </span> <span class="line" data-startTime="2850">Now, this is just another case </span><span class="line" data-startTime="2850">where you're going to have to </span><span class="line" data-startTime="2854">be really proactive about </span><span class="line" data-startTime="2854">judging the performance of the </span><span class="line" data-startTime="2856">local machine, because, of </span><span class="line" data-startTime="2856">course, software rasterization </span><span class="line" data-startTime="2859">is going to be nowhere </span><span class="line" data-startTime="2859">near as performant as </span><span class="line" data-startTime="2861">hardware-accelerated OpenGL. </span></p>

<p><span class="line" data-startTime="2864">So you need to be really careful </span><span class="line" data-startTime="2864">that you're catching </span><span class="line" data-startTime="2866">these cases, and testing the </span><span class="line" data-startTime="2866">performance, and degrading </span><span class="line" data-startTime="2869">appropriately, or informing </span><span class="line" data-startTime="2869">the user appropriately. </span> <span class="line" data-startTime="2871">Again, you never had any </span><span class="line" data-startTime="2871">guarantees about software </span><span class="line" data-startTime="2874">rasterization or not. </span> <span class="line" data-startTime="2876">It could always have been a </span><span class="line" data-startTime="2876">10-year-old graphics card. </span> <span class="line" data-startTime="2879">Now, you have software </span><span class="line" data-startTime="2879">rasterization in the mix. </span> <span class="line" data-startTime="2881">That just hammers home that </span><span class="line" data-startTime="2881">point a little bit harder. </span> <span class="line" data-startTime="2885">So let's talk about your </span><span class="line" data-startTime="2885">rendering loop for your game. </span> <span class="line" data-startTime="2888">So old-style JavaScript, the </span><span class="line" data-startTime="2888">way you would do periodic </span><span class="line" data-startTime="2892">function calls are with these </span><span class="line" data-startTime="2892">two methods, setInterval and </span><span class="line" data-startTime="2896">setTimeout. </span></p>

<p><span class="line" data-startTime="2897">But the problem with those is </span><span class="line" data-startTime="2897">that there's no way to tell </span><span class="line" data-startTime="2899">the browser what you're doing. </span> <span class="line" data-startTime="2900">And again, much like we were </span><span class="line" data-startTime="2900">seeing with the V8 case when </span><span class="line" data-startTime="2904">we were talking about performant </span><span class="line" data-startTime="2904">JavaScript, </span><span class="line" data-startTime="2906">performant rendering in general, </span><span class="line" data-startTime="2906">being performant in </span><span class="line" data-startTime="2908">general, is about being able </span><span class="line" data-startTime="2908">to inform the system what </span><span class="line" data-startTime="2911">you're doing in specific </span><span class="line" data-startTime="2911">terms so that it can </span><span class="line" data-startTime="2914">optimize around you. </span> <span class="line" data-startTime="2916">SetInterval and setTimeout are </span><span class="line" data-startTime="2916">not specific about what </span><span class="line" data-startTime="2918">they're doing. </span> <span class="line" data-startTime="2919">They could be doing anything. </span> <span class="line" data-startTime="2920">We don't know that this </span><span class="line" data-startTime="2920">is an animation. </span> <span class="line" data-startTime="2922">So the browser can't do </span><span class="line" data-startTime="2922">anything to help you. </span> <span class="line" data-startTime="2924">And that's why they're </span><span class="line" data-startTime="2924">bad ideas. </span></p>

<p><span class="line" data-startTime="2926">Instead, there's this nice API </span><span class="line" data-startTime="2926">in the HTML5 family of APIs </span><span class="line" data-startTime="2930">called RequestAnimationFrame. </span> <span class="line" data-startTime="2931">And this is a way to do periodic </span><span class="line" data-startTime="2931">rendering in a way </span><span class="line" data-startTime="2936">that tells the browser exactly </span><span class="line" data-startTime="2936">what you mean. </span> <span class="line" data-startTime="2938">So RequestAnimationFrame will </span><span class="line" data-startTime="2938">try to call at 60 hertz, and </span><span class="line" data-startTime="2942">it'll adapts down if you can't </span><span class="line" data-startTime="2942">actually call at 60 hertz. </span> <span class="line" data-startTime="2947">It'll never call faster </span><span class="line" data-startTime="2947">than that. </span> <span class="line" data-startTime="2948">But it'll call slower </span><span class="line" data-startTime="2948">if it needs to. </span> <span class="line" data-startTime="2955">So because the </span><span class="line" data-startTime="2955">RequestAnimationFrame callback </span><span class="line" data-startTime="2958">is always going to be scaling </span><span class="line" data-startTime="2958">its performance to how long </span><span class="line" data-startTime="2961">your frames are taking, if you </span><span class="line" data-startTime="2961">can't run at 60 hertz, then </span><span class="line" data-startTime="2965">your frame rate's going to go </span><span class="line" data-startTime="2965">a little jaggy, because it's </span><span class="line" data-startTime="2967">going to be based on how long </span><span class="line" data-startTime="2967">one of the recent frames took. </span> <span class="line" data-startTime="2972">And so if you don't want your </span><span class="line" data-startTime="2972">frame rate to wander, you need </span><span class="line" data-startTime="2975">to clamp it to either </span><span class="line" data-startTime="2975">60 or 30. </span></p>

<p><span class="line" data-startTime="2977">If you're trying to clamp your </span><span class="line" data-startTime="2977">frame rate to 30, what you do </span><span class="line" data-startTime="2979">is just the simplest </span><span class="line" data-startTime="2979">thing possible. </span> <span class="line" data-startTime="2981">You're just going to manually </span><span class="line" data-startTime="2981">skip frames by making a </span><span class="line" data-startTime="2983">counter that counts up, and you </span><span class="line" data-startTime="2983">render on even frames and </span><span class="line" data-startTime="2985">not on odd frames, </span><span class="line" data-startTime="2985">or whatever. </span> <span class="line" data-startTime="2988">So that's what you want to do </span><span class="line" data-startTime="2988">if having a jaggy frame rate </span><span class="line" data-startTime="2992">bothers you. </span> <span class="line" data-startTime="2994">And the other thing that </span><span class="line" data-startTime="2994">RequestAnimationFrame can do </span><span class="line" data-startTime="2996">for you, because it knows that </span><span class="line" data-startTime="2996">you are animating, it can feed </span><span class="line" data-startTime="3001">Chrome's rendering pipeline </span><span class="line" data-startTime="3001">with your data at </span><span class="line" data-startTime="3002">a consistent rate. </span> <span class="line" data-startTime="3004">And it can adapt the work you do </span><span class="line" data-startTime="3004">on the GPU and CPU to make </span><span class="line" data-startTime="3008">sure that you're not just </span><span class="line" data-startTime="3008">throwing a bunch of commands </span><span class="line" data-startTime="3010">over the wall that you could </span><span class="line" data-startTime="3010">never possibly render on the </span><span class="line" data-startTime="3012">GPU, that you're not totally </span><span class="line" data-startTime="3012">swamping everything. </span> <span class="line" data-startTime="3015">That's what </span><span class="line" data-startTime="3015">RequestAnimationFrame gives you. </span> <span class="line" data-startTime="3020">So this is a typical </span><span class="line" data-startTime="3020">game loop. </span></p>

<p><span class="line" data-startTime="3021">You have update, render, swap, </span><span class="line" data-startTime="3021">update, render, swap. </span> <span class="line" data-startTime="3024">That's pretty normal, you know, </span><span class="line" data-startTime="3024">while true, do this. </span> <span class="line" data-startTime="3026">That's a game. </span> <span class="line" data-startTime="3028">This is the way it </span><span class="line" data-startTime="3028">fits into Chrome. </span> <span class="line" data-startTime="3029">So you have </span><span class="line" data-startTime="3029">RequestAnimationFrame, which </span><span class="line" data-startTime="3031">is your JavaScript code. </span> <span class="line" data-startTime="3032">You have composite, which Chrome </span><span class="line" data-startTime="3032">takes care of that. </span> <span class="line" data-startTime="3036">That's where everything is </span><span class="line" data-startTime="3036">smooshed together and rendered </span><span class="line" data-startTime="3038">on the screen, and then, you </span><span class="line" data-startTime="3038">have a swap as well. </span> <span class="line" data-startTime="3041">So that loop is going on if you </span><span class="line" data-startTime="3041">have the main loop of your </span><span class="line" data-startTime="3043">game in there. </span> <span class="line" data-startTime="3045">If you didn't have that, the </span><span class="line" data-startTime="3045">browser would just go back to </span><span class="line" data-startTime="3047">idle and sit idly. </span> <span class="line" data-startTime="3048">User input can also cause a </span><span class="line" data-startTime="3048">screen dirty, which causes a </span><span class="line" data-startTime="3051">composite, which causes a swap, </span><span class="line" data-startTime="3051">which then either goes </span><span class="line" data-startTime="3054">back to idle or goes </span><span class="line" data-startTime="3054">back into your </span><span class="line" data-startTime="3055">RequestAnimationFrame loop. </span></p>

<p><span class="line" data-startTime="3062">So now, let's talk about </span><span class="line" data-startTime="3062">the life of a frame. </span> <span class="line" data-startTime="3064">So the way frames work in </span><span class="line" data-startTime="3064">Chrome is that we have </span><span class="line" data-startTime="3070">RequestAnimationFrame calls. </span> <span class="line" data-startTime="3071">So first thing that's done is </span><span class="line" data-startTime="3071">that your JavaScript in your </span><span class="line" data-startTime="3076">RequestAnimationFrame </span><span class="line" data-startTime="3076">call is executed. </span> <span class="line" data-startTime="3078">And during that JavaScript, </span><span class="line" data-startTime="3078">it'll kick off a bunch of </span><span class="line" data-startTime="3081">calls that result in commands </span><span class="line" data-startTime="3081">on the GPU. </span> <span class="line" data-startTime="3083">So you're going to kick off </span><span class="line" data-startTime="3083">commands down that RPC buffer </span><span class="line" data-startTime="3085">that are going to go on to this </span><span class="line" data-startTime="3085">other rendering process. </span> <span class="line" data-startTime="3088">When all your JavaScript is </span><span class="line" data-startTime="3088">completed, and all your GPU </span><span class="line" data-startTime="3091">work is completed, you have all </span><span class="line" data-startTime="3091">the information you need, </span><span class="line" data-startTime="3094">so you can composite the whole </span><span class="line" data-startTime="3094">frame together, and </span><span class="line" data-startTime="3096">you could do a swap. </span></p>

<p><span class="line" data-startTime="3098">So that's the general cycle. </span> <span class="line" data-startTime="3100">You do your JavaScript </span><span class="line" data-startTime="3100">callback, which kicks </span><span class="line" data-startTime="3103">off your GPU work. </span> <span class="line" data-startTime="3104">When all that's done, </span><span class="line" data-startTime="3104">you can composite. </span> <span class="line" data-startTime="3107">And then you just wait out </span><span class="line" data-startTime="3107">the rest of the frame. </span> <span class="line" data-startTime="3108">If your frame is under 16 </span><span class="line" data-startTime="3108">milliseconds, it'll just wait </span><span class="line" data-startTime="3115">until the next call of </span><span class="line" data-startTime="3115">RequestAnimationFrame. </span> <span class="line" data-startTime="3117">So yes, it just keeps </span><span class="line" data-startTime="3117">on like that. </span> <span class="line" data-startTime="3121">So in that diagram I showed </span><span class="line" data-startTime="3121">you before about how all </span><span class="line" data-startTime="3124">things fit together, one thing </span><span class="line" data-startTime="3124">I left out is user input. </span> <span class="line" data-startTime="3126">So I want to talk a little </span><span class="line" data-startTime="3126">bit about user input now. </span> <span class="line" data-startTime="3130">One really important thing you </span><span class="line" data-startTime="3130">need to know is that while </span><span class="line" data-startTime="3134">your main JavaScript thread </span><span class="line" data-startTime="3134">is busy, input is queued. </span></p>

<p><span class="line" data-startTime="3139">And that can introduce </span><span class="line" data-startTime="3139">a lot of input </span><span class="line" data-startTime="3141">latency into your code. </span> <span class="line" data-startTime="3143">So let me talk about how </span><span class="line" data-startTime="3143">that actually works. </span> <span class="line" data-startTime="3145">So here we have a diagram </span><span class="line" data-startTime="3145">similar to before, so it's </span><span class="line" data-startTime="3149">showing a series of frames. </span> <span class="line" data-startTime="3150">First, you do your </span><span class="line" data-startTime="3150">JavaScript work. </span> <span class="line" data-startTime="3153">Then you do your GPU work. </span> <span class="line" data-startTime="3155">And you just keep doing that. </span> <span class="line" data-startTime="3157">If during my JavaScript work </span><span class="line" data-startTime="3157">I get a bunch of mouse move </span><span class="line" data-startTime="3161">events, I'm not going to </span><span class="line" data-startTime="3161">hear them right away. </span> <span class="line" data-startTime="3163">I can't hear them while the </span><span class="line" data-startTime="3163">main thread is busy. </span></p>

<p><span class="line" data-startTime="3166">And they came in when the </span><span class="line" data-startTime="3166">main thread is busy. </span> <span class="line" data-startTime="3168">Once the JavaScript execution </span><span class="line" data-startTime="3168">is done, you're eligible to </span><span class="line" data-startTime="3172">hear a mouse event. </span> <span class="line" data-startTime="3173">So here, in this case, </span><span class="line" data-startTime="3173">I'm going to </span><span class="line" data-startTime="3174">hear this most freshest &mdash; </span><span class="line" data-startTime="3177">most recent, freshest </span><span class="line" data-startTime="3177">mouse click. </span> <span class="line" data-startTime="3180">Then during the next frame, </span><span class="line" data-startTime="3180">now I've got a m event. </span> <span class="line" data-startTime="3183">Now I'm eligible during the </span><span class="line" data-startTime="3183">next frame to process that </span><span class="line" data-startTime="3186">mouse event. </span> <span class="line" data-startTime="3187">And then at the very end </span><span class="line" data-startTime="3187">of the next frame when </span><span class="line" data-startTime="3188">everything's rendered, the </span><span class="line" data-startTime="3188">result of that mouse input can </span><span class="line" data-startTime="3191">get rendered. </span></p>

<p><span class="line" data-startTime="3193">And so you can see, especially </span><span class="line" data-startTime="3193">with this queuing delay, where </span><span class="line" data-startTime="3195">if events come in while the main </span><span class="line" data-startTime="3195">thread is busy, they just </span><span class="line" data-startTime="3198">get queued up, and you can't </span><span class="line" data-startTime="3198">hear them until later, you can </span><span class="line" data-startTime="3201">have a lot of input latency. </span> <span class="line" data-startTime="3204">The rule of thumb is that your </span><span class="line" data-startTime="3204">input latency is going to be </span><span class="line" data-startTime="3207">approximately twice </span><span class="line" data-startTime="3207">your frame length. </span> <span class="line" data-startTime="3210">So if these are 16-millisecond </span><span class="line" data-startTime="3210">frames, then the maximum input </span><span class="line" data-startTime="3214">latency you can get if you're </span><span class="line" data-startTime="3214">unlucky is 32 milliseconds, </span><span class="line" data-startTime="3218">which is a hell of </span><span class="line" data-startTime="3218">a lot of latency. </span> <span class="line" data-startTime="3219">But that's sort of the system </span><span class="line" data-startTime="3219">that you live in. </span> <span class="line" data-startTime="3221">So you just have to be ready </span><span class="line" data-startTime="3221">to deal with that. </span> <span class="line" data-startTime="3224">The other thing you can do to </span><span class="line" data-startTime="3224">help yourself is to move work </span><span class="line" data-startTime="3227">off the main thread. </span></p>

<p><span class="line" data-startTime="3228">So moving work to </span><span class="line" data-startTime="3228">the GPU is good. </span> <span class="line" data-startTime="3230">Moving work to web </span><span class="line" data-startTime="3230">workers is good. </span> <span class="line" data-startTime="3232">Anything that helps you free up </span><span class="line" data-startTime="3232">the main thread to be able </span><span class="line" data-startTime="3235">to receive user input </span><span class="line" data-startTime="3235">is good for you. </span> <span class="line" data-startTime="3241">So one more thing to talk about </span><span class="line" data-startTime="3241">user input is that one </span><span class="line" data-startTime="3244">of the really important things </span><span class="line" data-startTime="3244">that RequestAnimationFrame </span><span class="line" data-startTime="3247">does is it allows Chrome </span><span class="line" data-startTime="3247">to schedule your work </span><span class="line" data-startTime="3250">accordingly. </span> <span class="line" data-startTime="3251">So again, we see the same </span><span class="line" data-startTime="3251">simplified version of the </span><span class="line" data-startTime="3254">diagram we've been looking at </span><span class="line" data-startTime="3254">where you have your work, and </span><span class="line" data-startTime="3256">then Chrome's work, </span><span class="line" data-startTime="3256">and then wait. </span></p>

<p><span class="line" data-startTime="3257">Your work, and then Chrome's </span><span class="line" data-startTime="3257">work, and then wait, and so </span><span class="line" data-startTime="3259">on, and so forth. </span> <span class="line" data-startTime="3260">This all makes perfect sense, </span><span class="line" data-startTime="3260">nice repeating pattern. </span> <span class="line" data-startTime="3264">But when you have outside </span><span class="line" data-startTime="3264">events, DOM events or timers, </span><span class="line" data-startTime="3267">or things going off that cause </span><span class="line" data-startTime="3267">things at unexpected </span><span class="line" data-startTime="3270">intervals, Chrome no longer has </span><span class="line" data-startTime="3270">the ability to schedule </span><span class="line" data-startTime="3273">those things. </span> <span class="line" data-startTime="3273">They just happened </span><span class="line" data-startTime="3273">in on events. </span> <span class="line" data-startTime="3275">So in this case, on the slide, </span><span class="line" data-startTime="3275">I got this on-click event. </span> <span class="line" data-startTime="3278">It required some work. </span> <span class="line" data-startTime="3280">That processing all would have </span><span class="line" data-startTime="3280">fit in this frame nicely. </span> <span class="line" data-startTime="3282">But because Chrome didn't know </span><span class="line" data-startTime="3282">about that work, it couldn't </span><span class="line" data-startTime="3285">schedule, it which means that </span><span class="line" data-startTime="3285">this frame is actually going </span><span class="line" data-startTime="3288">to be delivered late. </span> <span class="line" data-startTime="3289">It's going to wait for that </span><span class="line" data-startTime="3289">on-click event to complete. </span></p>

<p><span class="line" data-startTime="3291">It's going to deliver </span><span class="line" data-startTime="3291">the frame late. </span> <span class="line" data-startTime="3292">And then, the next frame, frame </span><span class="line" data-startTime="3292">N+1, is actually going </span><span class="line" data-startTime="3295">to have a shorter time </span><span class="line" data-startTime="3295">in which to execute. </span> <span class="line" data-startTime="3297">So what this means to you is </span><span class="line" data-startTime="3297">essentially never do any work </span><span class="line" data-startTime="3303">outside of </span><span class="line" data-startTime="3303">RequestAnimationFrame. </span> <span class="line" data-startTime="3305">If you want like a DOM-based hub </span><span class="line" data-startTime="3305">over your WebGL game, what </span><span class="line" data-startTime="3309">you really want to be doing is </span><span class="line" data-startTime="3309">buffering up all user input </span><span class="line" data-startTime="3312">and then handling those </span><span class="line" data-startTime="3312">user inputs in the </span><span class="line" data-startTime="3314">RequestAnimationFrame </span><span class="line" data-startTime="3314">callback. </span> <span class="line" data-startTime="3315">You don't want to just handle </span><span class="line" data-startTime="3315">them whenever they come in. </span></p>

<p><span class="line" data-startTime="3318">Because you have to think about </span><span class="line" data-startTime="3318">how Chrome is actually </span><span class="line" data-startTime="3320">scheduling the work. </span> <span class="line" data-startTime="3321">You have to give Chrome a chance </span><span class="line" data-startTime="3321">to pack that work in </span><span class="line" data-startTime="3323">nicely, which means that you </span><span class="line" data-startTime="3323">have to actually do any </span><span class="line" data-startTime="3326">processing you want </span><span class="line" data-startTime="3326">to do inside the </span><span class="line" data-startTime="3328">RequestAnimationFrame </span><span class="line" data-startTime="3328">callback. </span> <span class="line" data-startTime="3332">So just in summary of what we've </span><span class="line" data-startTime="3332">learned about living </span><span class="line" data-startTime="3334">inside Chrome, first </span><span class="line" data-startTime="3334">of all, throttle </span><span class="line" data-startTime="3336">your upload per frame. </span> <span class="line" data-startTime="3337">Watch out for big performance </span><span class="line" data-startTime="3337">stalls. </span> <span class="line" data-startTime="3340">Those are probably </span><span class="line" data-startTime="3340">sink flushes. </span> <span class="line" data-startTime="3342">And they mean that you're </span><span class="line" data-startTime="3342">uploading too much data at </span><span class="line" data-startTime="3344">once essentially. </span> <span class="line" data-startTime="3347">Your game lives inside Chrome, </span><span class="line" data-startTime="3347">so you have to respect </span><span class="line" data-startTime="3350">Chrome's natural rendering cycle </span><span class="line" data-startTime="3350">and have to be prepared </span><span class="line" data-startTime="3353">to give 2 to 4 milliseconds per </span><span class="line" data-startTime="3353">frame to Chrome for all </span><span class="line" data-startTime="3356">the compositing and swapping </span><span class="line" data-startTime="3356">and finalizing that Chrome </span><span class="line" data-startTime="3359">needs to do. </span></p>

<p><span class="line" data-startTime="3359">So you don't actually have </span><span class="line" data-startTime="3359">16 milliseconds. </span> <span class="line" data-startTime="3361">You actually have 12. </span> <span class="line" data-startTime="3362">Hopefully, it will come in under </span><span class="line" data-startTime="3362">4, but you have to be </span><span class="line" data-startTime="3365">prepared to give </span><span class="line" data-startTime="3365">that much away. </span> <span class="line" data-startTime="3368">Never handle outside </span><span class="line" data-startTime="3368">events directly. </span> <span class="line" data-startTime="3370">Never handle user events </span><span class="line" data-startTime="3370">directly in events. </span> <span class="line" data-startTime="3374">Make sure you queue all the </span><span class="line" data-startTime="3374">work you need to do up and </span><span class="line" data-startTime="3377">handle it in RAF. </span> <span class="line" data-startTime="3377">All the work you do should </span><span class="line" data-startTime="3377">be inside your </span><span class="line" data-startTime="3379">RequestAnimationFrame callback </span><span class="line" data-startTime="3379">if you want Chrome to be able </span><span class="line" data-startTime="3382">to schedule it nicely. </span> <span class="line" data-startTime="3385">And then, if you're concerned </span><span class="line" data-startTime="3385">about input latency, if that's </span><span class="line" data-startTime="3388">a big deal for you, then the </span><span class="line" data-startTime="3388">best thing you can do there is </span><span class="line" data-startTime="3391">move work off your </span><span class="line" data-startTime="3391">main thread. </span></p>

<p><span class="line" data-startTime="3392">Move it to the GPU, move it </span><span class="line" data-startTime="3392">to Web Workers, whatever. </span> <span class="line" data-startTime="3395">Just know that the input is </span><span class="line" data-startTime="3395">blocked or queued while the </span><span class="line" data-startTime="3398">main thread is busy. </span> <span class="line" data-startTime="3399">And that's just going to imply </span><span class="line" data-startTime="3399">some input latency for you. </span> <span class="line" data-startTime="3404">So in general, all this amounts </span><span class="line" data-startTime="3404">to be aware of what </span><span class="line" data-startTime="3407">Chrome is doing and how you </span><span class="line" data-startTime="3407">fit inside it and try </span><span class="line" data-startTime="3409">to work with that. </span> <span class="line" data-startTime="3413">So we've talked about how to </span><span class="line" data-startTime="3413">write fast JavaScript. </span> <span class="line" data-startTime="3417">We've talked about how to make </span><span class="line" data-startTime="3417">that JavaScript work well </span><span class="line" data-startTime="3419">inside of Chrome. </span> <span class="line" data-startTime="3420">And now, just in the short time </span><span class="line" data-startTime="3420">I have left, I'm going to </span><span class="line" data-startTime="3422">talk about the developer tools </span><span class="line" data-startTime="3422">you need to check how well </span><span class="line" data-startTime="3425">you're doing. </span> <span class="line" data-startTime="3428">So first of all, just be aware </span><span class="line" data-startTime="3428">that Chrome's got all these </span><span class="line" data-startTime="3430">handy dandy flags. </span></p>

<p><span class="line" data-startTime="3431">So you can type about and then </span><span class="line" data-startTime="3431">a number of things different </span><span class="line" data-startTime="3433">into Chrome to get </span><span class="line" data-startTime="3433">some cool stats. </span> <span class="line" data-startTime="3436">So there's about:flags, which </span><span class="line" data-startTime="3436">has a lot of graphics options, </span><span class="line" data-startTime="3438">including an FPS counter, </span><span class="line" data-startTime="3438">which I essentially just </span><span class="line" data-startTime="3441">perpetually leave on. </span> <span class="line" data-startTime="3443">There's about:memory, which </span><span class="line" data-startTime="3443">shows you exactly what's going </span><span class="line" data-startTime="3445">on with memory in Chrome. </span> <span class="line" data-startTime="3446">It's a very in-depth </span><span class="line" data-startTime="3446">detailed view. </span> <span class="line" data-startTime="3448">There's about:gpu, which is </span><span class="line" data-startTime="3448">useful for figuring out what </span><span class="line" data-startTime="3451">Chrome thinks your </span><span class="line" data-startTime="3451">GPU stats are. </span> <span class="line" data-startTime="3453">Or if you're taking bug reports </span><span class="line" data-startTime="3453">from external people, </span><span class="line" data-startTime="3456">it's really nice to get </span><span class="line" data-startTime="3456">them to dump that data </span><span class="line" data-startTime="3458">and give it to you. </span></p>

<p><span class="line" data-startTime="3458">So these are all tools you </span><span class="line" data-startTime="3458">should be aware of. </span> <span class="line" data-startTime="3462">Then we have the Chrome </span><span class="line" data-startTime="3462">developer tools. </span> <span class="line" data-startTime="3463">So the Chrome developer tools </span><span class="line" data-startTime="3463">are really, really useful. </span> <span class="line" data-startTime="3468">They were designed. or </span><span class="line" data-startTime="3468">had been used most </span><span class="line" data-startTime="3471">often on web pages. </span> <span class="line" data-startTime="3472">They're really, really </span><span class="line" data-startTime="3472">great for web pages. </span> <span class="line" data-startTime="3474">They're also good for games, </span><span class="line" data-startTime="3474">but they've been optimized </span><span class="line" data-startTime="3477">around that case. </span> <span class="line" data-startTime="3478">So for instance, the CPU </span><span class="line" data-startTime="3478">profiler only take samples </span><span class="line" data-startTime="3481">every 1 or 2 milliseconds. </span></p>

<p><span class="line" data-startTime="3483">So it's a lot less resolution </span><span class="line" data-startTime="3483">than you would want. </span> <span class="line" data-startTime="3486">But they're really good </span><span class="line" data-startTime="3486">for some things. </span> <span class="line" data-startTime="3487">So how you get to the developer </span><span class="line" data-startTime="3487">tools, there's a </span><span class="line" data-startTime="3490">wrench icon up in the upper </span><span class="line" data-startTime="3490">right hand of Chrome. </span> <span class="line" data-startTime="3493">Then you go to the Tools menu, </span><span class="line" data-startTime="3493">go to Developer Tools. </span> <span class="line" data-startTime="3495">And the things you should be </span><span class="line" data-startTime="3495">aware of there are the </span><span class="line" data-startTime="3498">timeline view, which completely </span><span class="line" data-startTime="3498">rocks for trying to </span><span class="line" data-startTime="3501">see how your resource </span><span class="line" data-startTime="3501">loads are going. </span> <span class="line" data-startTime="3503">That's the thing that I find it </span><span class="line" data-startTime="3503">most useful for, is seeing </span><span class="line" data-startTime="3506">where resource requests were </span><span class="line" data-startTime="3506">made and how long they took. </span></p>

<p><span class="line" data-startTime="3509">There's the CPU profiler, </span><span class="line" data-startTime="3509">standard profiler. </span> <span class="line" data-startTime="3512">Again, resolution a little </span><span class="line" data-startTime="3512">low, but it still can be </span><span class="line" data-startTime="3514">really useful. </span> <span class="line" data-startTime="3516">And then there's the heap </span><span class="line" data-startTime="3516">profiler, which is a super </span><span class="line" data-startTime="3518">useful in-depth look </span><span class="line" data-startTime="3518">at exactly where </span><span class="line" data-startTime="3521">all your memory is. </span> <span class="line" data-startTime="3522">So those are the tools that are </span><span class="line" data-startTime="3522">most important, I think, </span><span class="line" data-startTime="3526">of the Chrome developer tools </span><span class="line" data-startTime="3526">for game developers. </span> <span class="line" data-startTime="3530">And then, there's </span><span class="line" data-startTime="3530">about:tracing. </span> <span class="line" data-startTime="3532">So about:tracing is the heaviest </span><span class="line" data-startTime="3532">weight tool you </span><span class="line" data-startTime="3535">should be aware of in Chrome if </span><span class="line" data-startTime="3535">you're actually trying to </span><span class="line" data-startTime="3538">debug a game. </span> <span class="line" data-startTime="3539">So this view that's on the </span><span class="line" data-startTime="3539">slide, pretty confusing the </span><span class="line" data-startTime="3542">first time you look at it. </span> <span class="line" data-startTime="3543">Every one of these colored </span><span class="line" data-startTime="3543">lines, colored vertical lines, </span><span class="line" data-startTime="3546">represents a function call </span><span class="line" data-startTime="3546">that's instrumented. </span> <span class="line" data-startTime="3549">And so this actually gives you a </span><span class="line" data-startTime="3549">list of all the instrumented </span><span class="line" data-startTime="3553">function calls on every Chrome </span><span class="line" data-startTime="3553">process, so for every open </span><span class="line" data-startTime="3556">tab, as well as calls </span><span class="line" data-startTime="3556">for the GPU. </span></p>

<p><span class="line" data-startTime="3558">So this is the tool you're going </span><span class="line" data-startTime="3558">to look at if you're </span><span class="line" data-startTime="3560">going to want to see how </span><span class="line" data-startTime="3560">your CPU work and </span><span class="line" data-startTime="3562">your GPU work relate. </span> <span class="line" data-startTime="3564">This is what's going </span><span class="line" data-startTime="3564">to be useful. </span> <span class="line" data-startTime="3566">If you zoom way in on that view </span><span class="line" data-startTime="3566">I just showed you, you </span><span class="line" data-startTime="3569">can see that each one of those </span><span class="line" data-startTime="3569">colored boxes, actually, you </span><span class="line" data-startTime="3572">can see a function name in it. </span> <span class="line" data-startTime="3573">And that function name </span><span class="line" data-startTime="3573">data is really raw. </span> <span class="line" data-startTime="3575">Again, it's right out </span><span class="line" data-startTime="3575">of the source code. </span> <span class="line" data-startTime="3576">So if you don't know what draw </span><span class="line" data-startTime="3576">layers means in this </span><span class="line" data-startTime="3581">particular context, then </span><span class="line" data-startTime="3581">that's too bad. </span> <span class="line" data-startTime="3584">But you can kind of look at the </span><span class="line" data-startTime="3584">function names and make </span><span class="line" data-startTime="3587">educated guesses about </span><span class="line" data-startTime="3587">what they mean. </span> <span class="line" data-startTime="3589">And then the really useful thing </span><span class="line" data-startTime="3589">you can do with this is </span><span class="line" data-startTime="3592">that from JavaScript, you </span><span class="line" data-startTime="3592">can add console.time and </span><span class="line" data-startTime="3595">console.timeEnd tags with </span><span class="line" data-startTime="3595">your own string tag. </span> <span class="line" data-startTime="3598">And that will create a colored </span><span class="line" data-startTime="3598">box in this view, just like </span><span class="line" data-startTime="3601">all the other function calls </span><span class="line" data-startTime="3601">that will manually instrument </span><span class="line" data-startTime="3604">a function call for you. </span> <span class="line" data-startTime="3605">And you can see exactly where </span><span class="line" data-startTime="3605">your function call happened </span><span class="line" data-startTime="3608">within your frame. </span></p>

<p><span class="line" data-startTime="3609">So this is a tool you </span><span class="line" data-startTime="3609">definitely, definitely want to </span><span class="line" data-startTime="3611">be aware of. </span> <span class="line" data-startTime="3613">And then finally, I know I </span><span class="line" data-startTime="3613">mentioned this in the section </span><span class="line" data-startTime="3616">about JavaScript, but you really </span><span class="line" data-startTime="3616">should be checking your </span><span class="line" data-startTime="3619">code with V8 flags. </span> <span class="line" data-startTime="3620">Unfortunately, this information </span><span class="line" data-startTime="3620">about what </span><span class="line" data-startTime="3623">JavaScript is fast and </span><span class="line" data-startTime="3623">slow isn't surfaced </span><span class="line" data-startTime="3625">really well to the user. </span> <span class="line" data-startTime="3626">It's all sort of at </span><span class="line" data-startTime="3626">the command line. </span> <span class="line" data-startTime="3628">But it's very, very important </span><span class="line" data-startTime="3628">information. </span> <span class="line" data-startTime="3630">And so I also put up </span><span class="line" data-startTime="3630">here exactly how to </span><span class="line" data-startTime="3633">run this for a Mac. </span> <span class="line" data-startTime="3635">It's not really friendly being </span><span class="line" data-startTime="3635">on a slide, but I wanted </span><span class="line" data-startTime="3638">people to have these slides </span><span class="line" data-startTime="3638">after the fact as reference to </span><span class="line" data-startTime="3641">be able to refer to it. </span></p>

<p><span class="line" data-startTime="3643">So that's actually a call you </span><span class="line" data-startTime="3643">can cut and paste into your </span><span class="line" data-startTime="3645">Mac to make this happen. </span> <span class="line" data-startTime="3648">And then finally, there's </span><span class="line" data-startTime="3648">WebGL Inspector. </span> <span class="line" data-startTime="3650">So WebGL Inspector is an </span><span class="line" data-startTime="3650">open-source Chrome extension </span><span class="line" data-startTime="3654">which patterns itself after </span><span class="line" data-startTime="3654">PIX or one of these other </span><span class="line" data-startTime="3657">heavyweight graphics debugging </span><span class="line" data-startTime="3657">tools that people in the games </span><span class="line" data-startTime="3660">industry especially are </span><span class="line" data-startTime="3660">really fond of. </span> <span class="line" data-startTime="3662">So if you want to step through </span><span class="line" data-startTime="3662">your draw calls or see exactly </span><span class="line" data-startTime="3665">how your textures are bound </span><span class="line" data-startTime="3665">something like that, WebGL </span><span class="line" data-startTime="3667">Inspector is going to be very, </span><span class="line" data-startTime="3667">very useful to you. </span> <span class="line" data-startTime="3670">So you should definitely </span><span class="line" data-startTime="3670">check that out. </span> <span class="line" data-startTime="3673">And then finally, one more note </span><span class="line" data-startTime="3673">before I'm out of time. </span> <span class="line" data-startTime="3675">I just want to stress </span><span class="line" data-startTime="3675">that we really, </span><span class="line" data-startTime="3678">really, really want feedback. </span></p>

<p><span class="line" data-startTime="3680">It's not at all knowing or </span><span class="line" data-startTime="3680">unwelcome to file bugs. </span> <span class="line" data-startTime="3683">It's really welcome. </span> <span class="line" data-startTime="3684">I really, really look forward to </span><span class="line" data-startTime="3684">working with teams that are </span><span class="line" data-startTime="3688">verbose about what they want. </span> <span class="line" data-startTime="3689">And they file bugs in Chrome. </span> <span class="line" data-startTime="3690">And they sort of squawk a lot </span><span class="line" data-startTime="3690">about what's working and </span><span class="line" data-startTime="3693">what's not working. </span> <span class="line" data-startTime="3695">So please, please, please, </span><span class="line" data-startTime="3695">when you find things that </span><span class="line" data-startTime="3697">don't work in Chrome, or things </span><span class="line" data-startTime="3697">you'd like to work </span><span class="line" data-startTime="3699">better, or features </span><span class="line" data-startTime="3699">you want, please </span><span class="line" data-startTime="3701">log things into crbug.com. </span> <span class="line" data-startTime="3702">That's the Chrome </span><span class="line" data-startTime="3702">bug database. </span> <span class="line" data-startTime="3704">Or if there are features you </span><span class="line" data-startTime="3704">want in WebGL or in any of the </span><span class="line" data-startTime="3707">HTML5 specifications, please go </span><span class="line" data-startTime="3707">to those mailing lists and </span><span class="line" data-startTime="3710">talk about what you need and </span><span class="line" data-startTime="3710">what your experience is. </span> <span class="line" data-startTime="3713">The community is not so large </span><span class="line" data-startTime="3713">that you can't make a </span><span class="line" data-startTime="3715">difference. </span> <span class="line" data-startTime="3716">Really, the decisions are made </span><span class="line" data-startTime="3716">by the people who show up. </span> <span class="line" data-startTime="3719">And you are really capable </span><span class="line" data-startTime="3719">of influencing what </span><span class="line" data-startTime="3722">actually gets done. </span> <span class="line" data-startTime="3723">So please, please, please </span><span class="line" data-startTime="3723">email those </span><span class="line" data-startTime="3725">mailing lists, file bugs. </span> <span class="line" data-startTime="3727">Everybody really wants </span><span class="line" data-startTime="3727">to hear from you. </span></p>

<p><span class="line" data-startTime="3730">All right. </span> <span class="line" data-startTime="3731">And that's it. </span> <span class="line" data-startTime="3732">Thank you very much. </span></p></div>