<style>* {font-family: "Open Sans", sans-serif}
a {color: #77aaff}
a.video {border-bottom: 1px solid #ddd; display: block; margin: 0 0 2em 0; padding: 0 0 2em 0}
h2 {color: #444; font-size: 18px;}
span.speakerName {color: black; font-weight: 900;}
body {padding: 2em}
p {color: #444; margin: 0; text-indent: 1.5em;}
p.speaker {margin: 1em 0 0 0; text-indent: 0;}
div#transcript > p:first-child {text-indent: 0;}
</style>

<h1>Google I/O 2012 &mdash; Life of a Native Client Instruction</h1>

<h2>Nick Bray</h2>

<a class="video" href="http://youtu.be/KOsJIhmeXoc">youtu.be/KOsJIhmeXoc</a><div id="transcript"><p class="speaker"><span class="line" data-starttime="0"><span class="speakerName">Nick Bray</span>: Hello. </span> <span class="line" data-startTime="1">My name is Nick Bray. </span> <span class="line" data-startTime="2">I'm a software engineer. </span> <span class="line" data-startTime="3">And I'm working on </span><span class="line" data-startTime="3">Native Client. </span> <span class="line" data-startTime="5">This is, unfortunately, </span><span class="line" data-startTime="5">where dinner parties </span><span class="line" data-startTime="7">get a little awkward. </span> <span class="line" data-startTime="8">So Nick, what's Native Client? </span><span class="line" data-startTime="13">It's a developer thing. </span> <span class="line" data-startTime="14">It's part of Chrome. </span> <span class="line" data-startTime="16">I work on Chrome. </span> <span class="line" data-startTime="19">That's usually a fairly </span><span class="line" data-startTime="19">soul-crushing thing. </span> <span class="line" data-startTime="21">But fortunately, this isn't </span><span class="line" data-startTime="21">a dinner party. </span> <span class="line" data-startTime="24">And we can talk about </span><span class="line" data-startTime="24">interesting things. </span> <span class="line" data-startTime="27">So when I say "interesting," </span><span class="line" data-startTime="27">what I mean is &mdash; </span><span class="line" data-startTime="29">you get to drink from </span><span class="line" data-startTime="29">the fire hose. </span> <span class="line" data-startTime="31">So we're going to be discussing </span><span class="line" data-startTime="31">address space. </span> <span class="line" data-startTime="33">We're going to be discussing </span><span class="line" data-startTime="33">instructions, assembly </span><span class="line" data-startTime="35">language, that kind of thing. </span> <span class="line" data-startTime="37">I will try to make sure everyone </span><span class="line" data-startTime="37">can follow along, </span><span class="line" data-startTime="40">even if you don't have a huge </span><span class="line" data-startTime="40">amount of background in this. </span> <span class="line" data-startTime="43">But we're going to get into </span><span class="line" data-startTime="43">the nitty gritty technical </span><span class="line" data-startTime="45">details of how Native </span><span class="line" data-startTime="45">Client works. </span></p>

<p><span class="line" data-startTime="48">Before we do this, of course, </span><span class="line" data-startTime="48">the only kind thing to do is </span><span class="line" data-startTime="52">give a bit of an overview and </span><span class="line" data-startTime="52">say how this fits in, why </span><span class="line" data-startTime="55">we're doing it, what's </span><span class="line" data-startTime="55">important here. </span> <span class="line" data-startTime="57">So one big thing we keep saying </span><span class="line" data-startTime="57">is that Native Client </span><span class="line" data-startTime="60">allows native code to be safe </span><span class="line" data-startTime="60">and secure as JavaScript. </span> <span class="line" data-startTime="63">And this is a very compressed </span><span class="line" data-startTime="63">tag line, which unless you </span><span class="line" data-startTime="67">actually know what's going on </span><span class="line" data-startTime="67">behind the scenes, you aren't </span><span class="line" data-startTime="70">quite sure what that means. </span> <span class="line" data-startTime="72">So one picture is worth </span><span class="line" data-startTime="72">a thousand words. </span></p>

<p><span class="line" data-startTime="74">And this is a picture, which </span><span class="line" data-startTime="74">you probably are familiar </span><span class="line" data-startTime="75">with, is whenever you try to run </span><span class="line" data-startTime="75">a piece of native code on </span><span class="line" data-startTime="78">a computer, you get a </span><span class="line" data-startTime="78">scary dialog box, or </span><span class="line" data-startTime="81">run from the web. </span> <span class="line" data-startTime="82">So say someone tries to install </span><span class="line" data-startTime="82">an NPAPI plug-in on </span><span class="line" data-startTime="85">your computer or even download </span><span class="line" data-startTime="85">an EXE from the Internet, then </span><span class="line" data-startTime="89">try to run it, well, the </span><span class="line" data-startTime="89">operating system is typically </span><span class="line" data-startTime="91">skeptical of any binary which </span><span class="line" data-startTime="91">is coming from the network. </span> <span class="line" data-startTime="94">And says, hey wait, you probably </span><span class="line" data-startTime="94">shouldn't do this, </span><span class="line" data-startTime="96">but what do I know? </span><span class="line" data-startTime="98">You can do it anyways. </span> <span class="line" data-startTime="100">So the problem with this is that </span><span class="line" data-startTime="100">most users really cannot </span><span class="line" data-startTime="103">evaluate whether they should </span><span class="line" data-startTime="103">click Run or not. </span> <span class="line" data-startTime="106">And you sometimes lose 60 to </span><span class="line" data-startTime="106">90% of your users when they </span><span class="line" data-startTime="110">get this dialog box. </span> <span class="line" data-startTime="111">And even if they do hit Run, </span><span class="line" data-startTime="111">then suddenly a lot of </span><span class="line" data-startTime="114">burden is on you. </span></p>

<p><span class="line" data-startTime="115">The burden becomes on you as </span><span class="line" data-startTime="115">the developer to make sure </span><span class="line" data-startTime="117">that this piece of native code </span><span class="line" data-startTime="117">you installed on your customer </span><span class="line" data-startTime="120">system is actually safe and </span><span class="line" data-startTime="120">secure and doesn't become an </span><span class="line" data-startTime="123">attack vector where someone </span><span class="line" data-startTime="123">exploits your customers </span><span class="line" data-startTime="126">because you made a mistake. </span> <span class="line" data-startTime="127">So native code, understandably, </span><span class="line" data-startTime="127">is very scary, </span><span class="line" data-startTime="132">especially when you get </span><span class="line" data-startTime="132">these dialog boxes. </span> <span class="line" data-startTime="134">So does the story end there, </span><span class="line" data-startTime="134">Native Client? </span><span class="line" data-startTime="137">Should we be doing this? </span><span class="line" data-startTime="139">As it turns out, it isn't native </span><span class="line" data-startTime="139">code itself which is </span><span class="line" data-startTime="142">the problem. </span> <span class="line" data-startTime="143">It's the fact that my </span><span class="line" data-startTime="143">presentation has not been </span><span class="line" data-startTime="144">refreshed, and the bullet </span><span class="line" data-startTime="144">points aren't fading in. </span></p>

<p><span class="line" data-startTime="147">Hold on a second. </span> <span class="line" data-startTime="157">OK, back in business. </span> <span class="line" data-startTime="159">So the problem is that the </span><span class="line" data-startTime="159">operating system has a very </span><span class="line" data-startTime="162">different notion of security </span><span class="line" data-startTime="162">than the web does. </span> <span class="line" data-startTime="166">So say I'm browsing a website </span><span class="line" data-startTime="166">to watch videos of cats, </span><span class="line" data-startTime="169">because that's what we all do, </span><span class="line" data-startTime="169">we just don't admit it. </span> <span class="line" data-startTime="171">And then suddenly I notice my </span><span class="line" data-startTime="171">tax return being uploaded to a </span><span class="line" data-startTime="176">Russian website. </span> <span class="line" data-startTime="178">So this right here </span><span class="line" data-startTime="178">is a Windows API </span><span class="line" data-startTime="180">call to open a file. </span> <span class="line" data-startTime="183">So really, this Russian website </span><span class="line" data-startTime="183">does not need my tax </span><span class="line" data-startTime="186">return in order for me to </span><span class="line" data-startTime="186">watch videos of cats. </span> <span class="line" data-startTime="188">So there's something seriously </span><span class="line" data-startTime="188">wrong here. </span> <span class="line" data-startTime="190">But as it turns out, operating </span><span class="line" data-startTime="190">systems are secure. </span> <span class="line" data-startTime="193">They just think that any </span><span class="line" data-startTime="193">program running on your </span><span class="line" data-startTime="195">computer is acting </span><span class="line" data-startTime="195">on your behalf. </span></p>

<p><span class="line" data-startTime="198">So because you can open your </span><span class="line" data-startTime="198">own spreadsheet, it assumes </span><span class="line" data-startTime="201">that any native program should </span><span class="line" data-startTime="201">have access to it. </span> <span class="line" data-startTime="205">The web figured out this is </span><span class="line" data-startTime="205">probably not the way things </span><span class="line" data-startTime="207">should run when you're loading </span><span class="line" data-startTime="207">other people's programs. </span> <span class="line" data-startTime="210">So instead they say that the </span><span class="line" data-startTime="210">program is operating on behalf </span><span class="line" data-startTime="213">of the website. </span> <span class="line" data-startTime="214">And it should only do things </span><span class="line" data-startTime="214">which you authorize the </span><span class="line" data-startTime="216">website to do. </span> <span class="line" data-startTime="219">What this means, of course, is </span><span class="line" data-startTime="219">that if you load native code </span><span class="line" data-startTime="221">and it can talk to the operating </span><span class="line" data-startTime="221">system, it can just </span><span class="line" data-startTime="223">blow right past the browser. </span> <span class="line" data-startTime="225">And that is the fundamental </span><span class="line" data-startTime="225">problem with native code, is </span><span class="line" data-startTime="227">it can do things that your web </span><span class="line" data-startTime="227">browser says is unsafe. </span> <span class="line" data-startTime="231">Another problem, which isn't </span><span class="line" data-startTime="231">immediately apparent, is this </span><span class="line" data-startTime="233">is a Windows API call </span><span class="line" data-startTime="233">to open a file. </span></p>

<p><span class="line" data-startTime="236">And imagine if you were, say, </span><span class="line" data-startTime="236">writing a nice application to </span><span class="line" data-startTime="239">view cat videos, which also </span><span class="line" data-startTime="239">happens to upload files. </span> <span class="line" data-startTime="242">Well, suddenly you have a cross- </span><span class="line" data-startTime="242">platform support issue. </span> <span class="line" data-startTime="245">You can open the files on </span><span class="line" data-startTime="245">Windows, but are you going to </span><span class="line" data-startTime="248">support Mac builds? </span><span class="line" data-startTime="249">Are you going to support </span><span class="line" data-startTime="249">Linux builds? </span><span class="line" data-startTime="250">I mean, honestly, when you're </span><span class="line" data-startTime="250">writing malware, it becomes a </span><span class="line" data-startTime="252">huge problem. </span> <span class="line" data-startTime="254">Of course, there's some </span><span class="line" data-startTime="254">honest developers who </span><span class="line" data-startTime="255">have the same problem. </span> <span class="line" data-startTime="256">And that's, when I distribute </span><span class="line" data-startTime="256">native code, how do I make </span><span class="line" data-startTime="259">sure it actually </span><span class="line" data-startTime="259">runs on all the </span><span class="line" data-startTime="261">operating systems out there? </span><span class="line" data-startTime="263">Another thing, again, which </span><span class="line" data-startTime="263">isn't immediately obvious, is </span><span class="line" data-startTime="265">this is a synchronous call. </span></p>

<p><span class="line" data-startTime="267">A lot of operating system APIs </span><span class="line" data-startTime="267">were designed back in the days </span><span class="line" data-startTime="270">where synchronous blocking </span><span class="line" data-startTime="270">of things </span><span class="line" data-startTime="272">seemed like a good idea. </span> <span class="line" data-startTime="273">But with the advent of browsers </span><span class="line" data-startTime="273">and JavaScript, a </span><span class="line" data-startTime="276">decision was made to eliminate </span><span class="line" data-startTime="276">the use of threads for the </span><span class="line" data-startTime="279">most part within a single </span><span class="line" data-startTime="279">JavaScript environment, a </span><span class="line" data-startTime="282">single document. </span> <span class="line" data-startTime="283">And instead, everything was </span><span class="line" data-startTime="283">single-threaded with </span><span class="line" data-startTime="285">asynchronous callbacks. </span> <span class="line" data-startTime="286">So APIs have had to change in </span><span class="line" data-startTime="286">order to support the web. </span> <span class="line" data-startTime="289">Whenever you open a file on the </span><span class="line" data-startTime="289">web, you, in fact, give it </span><span class="line" data-startTime="292">a callback to call you back. </span> <span class="line" data-startTime="294">So, the big crux of Native </span><span class="line" data-startTime="294">Client is making you talk to </span><span class="line" data-startTime="299">the web browser instead of </span><span class="line" data-startTime="299">talking to the operating </span><span class="line" data-startTime="301">system, and in fact making it </span><span class="line" data-startTime="301">impossible to talk to the </span><span class="line" data-startTime="305">operating system. </span> <span class="line" data-startTime="308">So this is an example of what </span><span class="line" data-startTime="308">a native program talking to </span><span class="line" data-startTime="311">the web browser would </span><span class="line" data-startTime="311">look like. </span></p>

<p><span class="line" data-startTime="312">It's a little ugly, but </span><span class="line" data-startTime="312">it's from real code. </span> <span class="line" data-startTime="314">And well, real code is ugly. </span> <span class="line" data-startTime="316">So this is an example of doing </span><span class="line" data-startTime="316">a URL request to get the page </span><span class="line" data-startTime="320">www.google.com. </span> <span class="line" data-startTime="322">It's analogous to what we were </span><span class="line" data-startTime="322">seeing with opening a file. </span> <span class="line" data-startTime="325">But it's a different </span><span class="line" data-startTime="325">API, and it's </span><span class="line" data-startTime="327">routed through the browser. </span> <span class="line" data-startTime="329">So Native Client provides a </span><span class="line" data-startTime="329">bunch of APIs for I/O that are </span><span class="line" data-startTime="333">mediated through the browser </span><span class="line" data-startTime="333">through an API called the </span><span class="line" data-startTime="335">Pepper Plugin API. </span> <span class="line" data-startTime="336">The Pepper Plugin API you can </span><span class="line" data-startTime="336">think of as a successor to the </span><span class="line" data-startTime="339">Netscape Plugin API, where </span><span class="line" data-startTime="339">things we've learned in the </span><span class="line" data-startTime="341">meantime, such as 3D graphics </span><span class="line" data-startTime="341">are good, have been </span><span class="line" data-startTime="345">incorporated. </span></p>

<p><span class="line" data-startTime="345">And instead of just drawing to </span><span class="line" data-startTime="345">a random window, you can now </span><span class="line" data-startTime="348">delegate to the browser and say </span><span class="line" data-startTime="348">here's some 3D content, </span><span class="line" data-startTime="351">just like WebGL. </span> <span class="line" data-startTime="352">So ultimately, the Pepper Plugin </span><span class="line" data-startTime="352">API gives you a lot of </span><span class="line" data-startTime="355">functionality similar </span><span class="line" data-startTime="355">to JavaScript. </span> <span class="line" data-startTime="357">As you can think, all the APIs </span><span class="line" data-startTime="357">that JavaScript has to open </span><span class="line" data-startTime="361">URLs, to draw 3D content, it's </span><span class="line" data-startTime="361">also exposed to native code </span><span class="line" data-startTime="364">through Pepper. </span> <span class="line" data-startTime="368">Not everything is I/O. So if you </span><span class="line" data-startTime="368">want to spin up a thread </span><span class="line" data-startTime="370">or do things like that, that </span><span class="line" data-startTime="370">actually occurs within a </span><span class="line" data-startTime="373">single process. </span> <span class="line" data-startTime="373">You don't need to talk </span><span class="line" data-startTime="373">to the browser, </span><span class="line" data-startTime="375">don't need it's approval. </span></p>

<p><span class="line" data-startTime="376">And for that, we've used </span><span class="line" data-startTime="376">the POSIX API. </span> <span class="line" data-startTime="378">So you can spawn threads </span><span class="line" data-startTime="378">and do similar things. </span> <span class="line" data-startTime="381">So if your code's running on </span><span class="line" data-startTime="381">Linux, you can port the I/O to </span><span class="line" data-startTime="385">use Pepper. </span> <span class="line" data-startTime="386">And more or less, everything </span><span class="line" data-startTime="386">else should look </span><span class="line" data-startTime="389">relatively the same. </span> <span class="line" data-startTime="391">And why are we doing this? </span><span class="line" data-startTime="393">The ultimate goal is no </span><span class="line" data-startTime="393">scary dialog box. </span> <span class="line" data-startTime="396">You can just run the code. </span> <span class="line" data-startTime="397">It follows the web safety rules, </span><span class="line" data-startTime="397">so you don't have to </span><span class="line" data-startTime="399">warn the user. </span> <span class="line" data-startTime="400">It's part a seamless </span><span class="line" data-startTime="400">experience. </span> <span class="line" data-startTime="401">And in fact, most users won't </span><span class="line" data-startTime="401">know the running NaCl. </span> <span class="line" data-startTime="405">We have a lot of games in the </span><span class="line" data-startTime="405">web store now, which we aren't </span><span class="line" data-startTime="408">trumpeting NaCl. </span></p>

<p><span class="line" data-startTime="408">It's just you can run bastion </span><span class="line" data-startTime="408">on your computer now. </span> <span class="line" data-startTime="413">So the life cycle of a Native </span><span class="line" data-startTime="413">Client application has three </span><span class="line" data-startTime="416">distinct stages. </span> <span class="line" data-startTime="417">The first stage is what </span><span class="line" data-startTime="417">the developer </span><span class="line" data-startTime="419">does on their computer. </span> <span class="line" data-startTime="420">So you can get a bunch of </span><span class="line" data-startTime="420">sources, existing library. </span> <span class="line" data-startTime="424">Or say you've written a game, </span><span class="line" data-startTime="424">and you want to port the game, </span><span class="line" data-startTime="426">run it on the web. </span> <span class="line" data-startTime="427">You do supporting work on your </span><span class="line" data-startTime="427">C files, and then you use a </span><span class="line" data-startTime="430">modified version of GCC, </span><span class="line" data-startTime="430">which we provide. </span> <span class="line" data-startTime="433">There's one wrinkle on this. </span> <span class="line" data-startTime="435">And that's that you need to </span><span class="line" data-startTime="435">use a version of GCC that </span><span class="line" data-startTime="438">targets binaries for different </span><span class="line" data-startTime="438">platforms &mdash; </span><span class="line" data-startTime="440">or different architectures, </span><span class="line" data-startTime="440">I should say, chip </span><span class="line" data-startTime="442">architectures. </span> <span class="line" data-startTime="443">So the binaries that are </span><span class="line" data-startTime="443">produced are OS independent, </span><span class="line" data-startTime="446">but for the moment, they have a </span><span class="line" data-startTime="446">architecture, an instruction </span><span class="line" data-startTime="451">architecture set dependency. </span> <span class="line" data-startTime="453">So for this talk, I'm going to </span><span class="line" data-startTime="453">show you the internals for the </span><span class="line" data-startTime="458">x86-64 sandboxing model. </span></p>

<p><span class="line" data-startTime="460">And you can think that the </span><span class="line" data-startTime="460">x86-32 and the ARM sandboxing </span><span class="line" data-startTime="463">models are quite similar. </span> <span class="line" data-startTime="466">The details differ, but </span><span class="line" data-startTime="466">spiritually they're the same. </span> <span class="line" data-startTime="470">At the end of the year, </span><span class="line" data-startTime="470">we're going to have a </span><span class="line" data-startTime="472">product called PNaCl. </span> <span class="line" data-startTime="474">I should've defined this </span><span class="line" data-startTime="474">a little earlier. </span> <span class="line" data-startTime="476">When I say NaCl, I mean </span><span class="line" data-startTime="476">Native Client. </span> <span class="line" data-startTime="479">And I've just use this term so </span><span class="line" data-startTime="479">much, I use it automatically. </span> <span class="line" data-startTime="482">So I need to make very sure </span><span class="line" data-startTime="482">that everyone knows I mean </span><span class="line" data-startTime="485">Native Client. </span> <span class="line" data-startTime="486">So PNaCl, Portable Native, </span><span class="line" data-startTime="486">Client, P-NaCl, is going to </span><span class="line" data-startTime="489">use an LLVM-based tool chain, </span><span class="line" data-startTime="489">which will allow you to ship </span><span class="line" data-startTime="492">bit code, platform independent </span><span class="line" data-startTime="492">bit code, across the wire. </span> <span class="line" data-startTime="495">And that'll get translated to </span><span class="line" data-startTime="495">whatever architecture you want </span><span class="line" data-startTime="497">to use on the computer. </span></p>

<p><span class="line" data-startTime="498">So that'll be roughly </span><span class="line" data-startTime="498">the end of the year. </span> <span class="line" data-startTime="501">And at the bottom level, what </span><span class="line" data-startTime="501">we're going to talk about </span><span class="line" data-startTime="506">today remains the same. </span> <span class="line" data-startTime="507">So the interchange format will </span><span class="line" data-startTime="507">change, but the sandboxing </span><span class="line" data-startTime="509">model, the inner mechanics, </span><span class="line" data-startTime="509">is going to stay the same. </span> <span class="line" data-startTime="512">So this modified version of GCC </span><span class="line" data-startTime="512">outputs code which we can </span><span class="line" data-startTime="516">later statically analyze. </span> <span class="line" data-startTime="518">And we'll get into </span><span class="line" data-startTime="518">what this is. </span> <span class="line" data-startTime="519">We call it validation. </span> <span class="line" data-startTime="522">Once you compile this code, you </span><span class="line" data-startTime="522">upload it to a web server, </span><span class="line" data-startTime="524">just like a normal web app. </span> <span class="line" data-startTime="525">In fact, it looks a lot </span><span class="line" data-startTime="525">like a normal web app. </span></p>

<p><span class="line" data-startTime="527">You have an HTML file. </span> <span class="line" data-startTime="528">You can have JavaScript. </span> <span class="line" data-startTime="529">You can have CSS. </span> <span class="line" data-startTime="531">And then within that app, you </span><span class="line" data-startTime="531">have an embed tag somewhere. </span> <span class="line" data-startTime="533">And the embed tag pulls in the </span><span class="line" data-startTime="533">Native Client executable, and </span><span class="line" data-startTime="536">it can talk with the rest </span><span class="line" data-startTime="536">of the web page. </span> <span class="line" data-startTime="538">So you can make a UI </span><span class="line" data-startTime="538">with HTML elements. </span> <span class="line" data-startTime="543">And finally, at the end, </span><span class="line" data-startTime="543">there is the user. </span> <span class="line" data-startTime="546">The user is running a browser </span><span class="line" data-startTime="546">on the computer. </span> <span class="line" data-startTime="548">The browser loads the page, </span><span class="line" data-startTime="548">loads the embed tag, pulls in </span><span class="line" data-startTime="552">the Native Client executable. </span> <span class="line" data-startTime="555">So the question to </span><span class="line" data-startTime="555">ask at this point </span><span class="line" data-startTime="556">is, where's the security? </span><span class="line" data-startTime="558">Ultimately, the user wants to </span><span class="line" data-startTime="558">say that this application I'm </span><span class="line" data-startTime="561">running on the network isn't </span><span class="line" data-startTime="561">going to harm my computer. </span></p>

<p><span class="line" data-startTime="564">So how are we are able to </span><span class="line" data-startTime="564">make that assertion? </span><span class="line" data-startTime="566">We actually can't say that </span><span class="line" data-startTime="566">about the compiler. </span> <span class="line" data-startTime="569">So the compiler tries to output </span><span class="line" data-startTime="569">code, which we can </span><span class="line" data-startTime="572">verify as safe. </span> <span class="line" data-startTime="574">But we don't trust it, because </span><span class="line" data-startTime="574">at the end of the day who </span><span class="line" data-startTime="577">knows what the developer's </span><span class="line" data-startTime="577">intending. </span> <span class="line" data-startTime="578">They could just have an </span><span class="line" data-startTime="578">arbitrary binary blob that </span><span class="line" data-startTime="581">they put together with </span><span class="line" data-startTime="581">the hex editor. </span> <span class="line" data-startTime="582">And when the user gets it, they </span><span class="line" data-startTime="582">have to look at it and </span><span class="line" data-startTime="585">verify it's safe before </span><span class="line" data-startTime="585">they run it. </span> <span class="line" data-startTime="587">And similarly, even if </span><span class="line" data-startTime="587">it isn't malicious, </span><span class="line" data-startTime="590">compilers have bugs. </span></p>

<p><span class="line" data-startTime="592">So GCC, LLVM, very complex </span><span class="line" data-startTime="592">pieces of software. </span> <span class="line" data-startTime="595">They were not written with </span><span class="line" data-startTime="595">safety in mind to begin with. </span> <span class="line" data-startTime="599">So saying that these compilers </span><span class="line" data-startTime="599">are going to produce perfect </span><span class="line" data-startTime="601">code, that's a bad assumption </span><span class="line" data-startTime="601">to make. </span> <span class="line" data-startTime="603">Instead, on the web browser, we </span><span class="line" data-startTime="603">look at the code before we </span><span class="line" data-startTime="606">run it and apply some simple </span><span class="line" data-startTime="606">rules to try to verify it's </span><span class="line" data-startTime="609">safe rather than saying this </span><span class="line" data-startTime="609">big complicated piece of </span><span class="line" data-startTime="612">software is where </span><span class="line" data-startTime="612">the safety is. </span> <span class="line" data-startTime="616">When Native Client actually runs </span><span class="line" data-startTime="616">an EXE, the process model </span><span class="line" data-startTime="621">looks a little bit like this. </span> <span class="line" data-startTime="622">So what you think of as the web </span><span class="line" data-startTime="622">browser, what you see is </span><span class="line" data-startTime="625">called the browser process. </span> <span class="line" data-startTime="627">And that's just a normal </span><span class="line" data-startTime="627">application running on your </span><span class="line" data-startTime="629">computer, talking with the OS. </span> <span class="line" data-startTime="631">But every time Chrome visits a </span><span class="line" data-startTime="631">new domain, it usually splits </span><span class="line" data-startTime="635">it off into its own process </span><span class="line" data-startTime="635">and says there is a render </span><span class="line" data-startTime="638">process for the specific site, </span><span class="line" data-startTime="638">which can do all the </span><span class="line" data-startTime="642">JavaScript execution, all the </span><span class="line" data-startTime="642">rendering of the DOM. </span></p>

<p><span class="line" data-startTime="645">And we're going to try to </span><span class="line" data-startTime="645">keep sites separate. </span> <span class="line" data-startTime="647">So if one site is compromised, </span><span class="line" data-startTime="647">it rattles around in its own </span><span class="line" data-startTime="650">process and has a much harder </span><span class="line" data-startTime="650">time attacking another site, </span><span class="line" data-startTime="654">stealing your credentials from </span><span class="line" data-startTime="654">your banking system, </span><span class="line" data-startTime="656">or things like that. </span> <span class="line" data-startTime="657">So these renderer processes run </span><span class="line" data-startTime="657">in something called the </span><span class="line" data-startTime="660">Chrome Sandbox. </span> <span class="line" data-startTime="661">The Chrome Sandbox, you can </span><span class="line" data-startTime="661">think of it as deprivileging </span><span class="line" data-startTime="664">the processes. </span> <span class="line" data-startTime="666">It says, hey, if these processes </span><span class="line" data-startTime="666">ask for your tax </span><span class="line" data-startTime="669">return, that's probably </span><span class="line" data-startTime="669">a bad idea. </span> <span class="line" data-startTime="672">So don't trust them, don't </span><span class="line" data-startTime="672">give it to them. </span> <span class="line" data-startTime="675">So you'd think that this </span><span class="line" data-startTime="675">solves most of the </span><span class="line" data-startTime="677">problems for NaCl. </span> <span class="line" data-startTime="678">But as it turns out, we're </span><span class="line" data-startTime="678">following a pattern called </span><span class="line" data-startTime="681">defense in depth. </span> <span class="line" data-startTime="683">We try to build layers, each of </span><span class="line" data-startTime="683">which is secure on its own. </span> <span class="line" data-startTime="686">And if one of those layers </span><span class="line" data-startTime="686">fails, the other should catch </span><span class="line" data-startTime="689">the problem. </span></p>

<p><span class="line" data-startTime="690">And there's actually some </span><span class="line" data-startTime="690">subtle problems with the </span><span class="line" data-startTime="692">sandbox I'm not going </span><span class="line" data-startTime="692">to get fully into. </span> <span class="line" data-startTime="694">But Native Client tries to </span><span class="line" data-startTime="694">provide an inner sandbox </span><span class="line" data-startTime="698">inside its own process. </span> <span class="line" data-startTime="699">So when you have an embed tag </span><span class="line" data-startTime="699">in the web page, instead of </span><span class="line" data-startTime="702">running the Native Client </span><span class="line" data-startTime="702">executable inside the render </span><span class="line" data-startTime="704">process, it spins up yet another </span><span class="line" data-startTime="704">process, and then </span><span class="line" data-startTime="707">applies the inner sandbox to </span><span class="line" data-startTime="707">make sure it never can &mdash; </span><span class="line" data-startTime="710">or we try to make sure it can </span><span class="line" data-startTime="710">never do anything bad. </span> <span class="line" data-startTime="714">So for the rest of this </span><span class="line" data-startTime="714">presentation, I'm going to be </span><span class="line" data-startTime="717">talking about the </span><span class="line" data-startTime="717">inner sandbox. </span> <span class="line" data-startTime="718">I'm going to be talking </span><span class="line" data-startTime="718">about what </span><span class="line" data-startTime="720">happens in the NaCl process. </span> <span class="line" data-startTime="722">Now, there's a lot of little </span><span class="line" data-startTime="722">pieces that build up in order </span><span class="line" data-startTime="726">for us to verify that the </span><span class="line" data-startTime="726">process isn't talking with the </span><span class="line" data-startTime="729">operating system, or more </span><span class="line" data-startTime="729">correctly, the code that's </span><span class="line" data-startTime="732">loaded across the network is not </span><span class="line" data-startTime="732">talking directly with the </span><span class="line" data-startTime="735">operating system. </span></p>

<p><span class="line" data-startTime="736">And we can do very controlled </span><span class="line" data-startTime="736">calls to provide services that </span><span class="line" data-startTime="739">are needed. </span> <span class="line" data-startTime="742">So the first step in this </span><span class="line" data-startTime="742">journey is being able to </span><span class="line" data-startTime="745">understand what code we have. </span> <span class="line" data-startTime="748">So you'd think this is easy. </span> <span class="line" data-startTime="749">You've done assembly language. </span> <span class="line" data-startTime="750">You see a lot of instructions. </span> <span class="line" data-startTime="752">And we just look at the </span><span class="line" data-startTime="752">instructions and say, bad </span><span class="line" data-startTime="754">instruction. </span> <span class="line" data-startTime="755">We're not running it. </span> <span class="line" data-startTime="757">End of the story. </span> <span class="line" data-startTime="758">However, computers see the world </span><span class="line" data-startTime="758">in a different way than </span><span class="line" data-startTime="760">humans usually do. </span> <span class="line" data-startTime="761">And that's that native code </span><span class="line" data-startTime="761">is a stream of bytes. </span> <span class="line" data-startTime="765">And they start executing </span><span class="line" data-startTime="765">the stream of bytes &mdash; </span><span class="line" data-startTime="767">pull in bytes, execute, pull </span><span class="line" data-startTime="767">in more bytes, execute. </span> <span class="line" data-startTime="770">And if we really want to </span><span class="line" data-startTime="770">understand what the processor </span><span class="line" data-startTime="772">is doing, we have to disassemble </span><span class="line" data-startTime="772">the code. </span> <span class="line" data-startTime="775">We have to look at it from the </span><span class="line" data-startTime="775">CPU's point of view and see </span><span class="line" data-startTime="778">what it's going to execute. </span></p>

<p><span class="line" data-startTime="781">So before we get into why this </span><span class="line" data-startTime="781">is all difficult, the question </span><span class="line" data-startTime="784">is, what are we looking for? </span><span class="line" data-startTime="785">What instructions do we </span><span class="line" data-startTime="785">not want to execute? </span><span class="line" data-startTime="788">The first one which I've been </span><span class="line" data-startTime="788">harping on is syscall. </span> <span class="line" data-startTime="792">So syscall, just as a </span><span class="line" data-startTime="792">convention, on the right I </span><span class="line" data-startTime="795">will have the bytes that these </span><span class="line" data-startTime="795">instructions compile into. </span> <span class="line" data-startTime="798">So syscall is a two-byte </span><span class="line" data-startTime="798">instruction. </span> <span class="line" data-startTime="800">And what this does is, it says, </span><span class="line" data-startTime="800">hey, operating system, I </span><span class="line" data-startTime="803">want you provide a </span><span class="line" data-startTime="803">service for me. </span> <span class="line" data-startTime="805">And without the outer sandbox, </span><span class="line" data-startTime="805">without the Chrome sandbox, </span><span class="line" data-startTime="809">there is very obvious problems </span><span class="line" data-startTime="809">here, is that you can open </span><span class="line" data-startTime="811">files, do all sorts </span><span class="line" data-startTime="811">of bad things. </span></p>

<p><span class="line" data-startTime="813">But even with the Chrome </span><span class="line" data-startTime="813">sandbox, there are still a lot </span><span class="line" data-startTime="815">of problems. </span> <span class="line" data-startTime="816">So there's a recently publicized </span><span class="line" data-startTime="816">vulnerability in </span><span class="line" data-startTime="821">the Intel implementation of the </span><span class="line" data-startTime="821">x86-64 architecture, where </span><span class="line" data-startTime="826">the sysexit return &mdash; so in the </span><span class="line" data-startTime="826">operating system return from </span><span class="line" data-startTime="829">assist call, if you set it up </span><span class="line" data-startTime="829">in such a clever way, you </span><span class="line" data-startTime="833">could cause it to overwrite </span><span class="line" data-startTime="833">arbitrary memory inside the </span><span class="line" data-startTime="836">operating system and result in </span><span class="line" data-startTime="836">a exploit, where you could </span><span class="line" data-startTime="840">escalate privileges in </span><span class="line" data-startTime="840">the operating system. </span> <span class="line" data-startTime="842">So the silicon itself </span><span class="line" data-startTime="842">allowed an attack on </span><span class="line" data-startTime="846">the operating system. </span> <span class="line" data-startTime="848">The bottom line is, we </span><span class="line" data-startTime="848">simply do not want </span><span class="line" data-startTime="849">to make these calls. </span></p>

<p><span class="line" data-startTime="850">These calls are the gateway </span><span class="line" data-startTime="850">to the operating system. </span> <span class="line" data-startTime="852">They are an attack surface. </span> <span class="line" data-startTime="854">So even if we're in a </span><span class="line" data-startTime="854">de-privilege process, we don't </span><span class="line" data-startTime="856">want to make them in </span><span class="line" data-startTime="856">the first place. </span> <span class="line" data-startTime="859">Another interesting </span><span class="line" data-startTime="859">instruction. </span> <span class="line" data-startTime="860">This is actually a fairly old </span><span class="line" data-startTime="860">example, but famous, is the </span><span class="line" data-startTime="863">FOOF instruction. </span> <span class="line" data-startTime="865">The FOOF instruction, because </span><span class="line" data-startTime="865">it starts with F-O-O-F, had </span><span class="line" data-startTime="869">this nasty habit of actually </span><span class="line" data-startTime="869">freezing your entire computer </span><span class="line" data-startTime="873">when executed on an </span><span class="line" data-startTime="873">older Pentium. </span> <span class="line" data-startTime="875">So under the hood what was going </span><span class="line" data-startTime="875">on is it applied a lock, </span><span class="line" data-startTime="879">and then it tried to execute </span><span class="line" data-startTime="879">an invalid instruction. </span></p>

<p><span class="line" data-startTime="882">And it never recovered </span><span class="line" data-startTime="882">and unlocked so your </span><span class="line" data-startTime="886">entire CPU hung up. </span> <span class="line" data-startTime="887">So if you talk to some security </span><span class="line" data-startTime="887">people, they'll say, </span><span class="line" data-startTime="890">well, this isn't really a </span><span class="line" data-startTime="890">security vulnerability. </span> <span class="line" data-startTime="892">Because, well, you know, you </span><span class="line" data-startTime="892">aren't using your bank account </span><span class="line" data-startTime="894">information to some </span><span class="line" data-startTime="894">random hacker. </span> <span class="line" data-startTime="896">But if you think about it from </span><span class="line" data-startTime="896">a web perspective, do you </span><span class="line" data-startTime="899">really want to surf to a web </span><span class="line" data-startTime="899">page and have to power cycle </span><span class="line" data-startTime="901">your computer? </span><span class="line" data-startTime="901">It's bad. </span> <span class="line" data-startTime="902">So there is these classes of </span><span class="line" data-startTime="902">instructions that again we </span><span class="line" data-startTime="905">want to blacklist and say if </span><span class="line" data-startTime="905">we encounter these in an </span><span class="line" data-startTime="908">executable, obviously the </span><span class="line" data-startTime="908">person's up to no good. </span> <span class="line" data-startTime="911">So syscalls, FOOF instructions, </span><span class="line" data-startTime="911">we're not going </span><span class="line" data-startTime="913">to mess with them and just </span><span class="line" data-startTime="913">reject the binary out right </span><span class="line" data-startTime="916">and not run it. </span> <span class="line" data-startTime="918">So there's a third class </span><span class="line" data-startTime="918">of instruction, </span><span class="line" data-startTime="920">which is a little weird. </span> <span class="line" data-startTime="922">And if you just look at this </span><span class="line" data-startTime="922">instruction, all it does is </span><span class="line" data-startTime="925">multiply a bunch of </span><span class="line" data-startTime="925">numbers together. </span></p>

<p><span class="line" data-startTime="927">Perfectly safe. </span> <span class="line" data-startTime="928">There's no problem with this. </span> <span class="line" data-startTime="930">Well, as it turns out, the one </span><span class="line" data-startTime="930">wrinkle here is that this is </span><span class="line" data-startTime="933">part of a new instruction set, </span><span class="line" data-startTime="933">the SSE4 instruction set. </span> <span class="line" data-startTime="938">So if you're running on a </span><span class="line" data-startTime="938">computer that doesn't support </span><span class="line" data-startTime="940">this instruction set, what </span><span class="line" data-startTime="940">happens when you try to </span><span class="line" data-startTime="943">execute it? </span><span class="line" data-startTime="945">So in theory, it should just </span><span class="line" data-startTime="945">halt the process, but has </span><span class="line" data-startTime="948">everyone really tested every </span><span class="line" data-startTime="948">invalid instruction possible </span><span class="line" data-startTime="951">on every chip? </span><span class="line" data-startTime="952">So instead of running this risk, </span><span class="line" data-startTime="952">instead what we do when </span><span class="line" data-startTime="955">we encounter it, instead of </span><span class="line" data-startTime="955">rejecting the program, we </span><span class="line" data-startTime="957">simply write over it with </span><span class="line" data-startTime="957">halt instructions. </span></p>

<p><span class="line" data-startTime="960">So a well-formed executable </span><span class="line" data-startTime="960">should not try to execute this </span><span class="line" data-startTime="964">instruction if it's </span><span class="line" data-startTime="964">not supported. </span> <span class="line" data-startTime="966">But if it does, because we </span><span class="line" data-startTime="966">overwrote it with halt </span><span class="line" data-startTime="968">instructions, that causes the </span><span class="line" data-startTime="968">execution to stop when it </span><span class="line" data-startTime="971">encounters it, just like it </span><span class="line" data-startTime="971">theoretically should if the </span><span class="line" data-startTime="974">instruction was not supported </span><span class="line" data-startTime="974">by the processor. </span> <span class="line" data-startTime="977">So overall, Native Client is </span><span class="line" data-startTime="977">looking for a variety of </span><span class="line" data-startTime="980">instructions that wants to say </span><span class="line" data-startTime="980">either don't run the program, </span><span class="line" data-startTime="984">or overwrite this to be </span><span class="line" data-startTime="984">sure that we're safe. </span> <span class="line" data-startTime="987">So how do we find these </span><span class="line" data-startTime="987">instructions? </span><span class="line" data-startTime="989">That's the crucial step. </span> <span class="line" data-startTime="992">So previously, I said it's </span><span class="line" data-startTime="992">a stream of bytes. </span></p>

<p><span class="line" data-startTime="994">And you're taking chunks </span><span class="line" data-startTime="994">out of the stream of </span><span class="line" data-startTime="995">bytes as you go. </span> <span class="line" data-startTime="996">And that's nice until you </span><span class="line" data-startTime="996">realize that you aren't just </span><span class="line" data-startTime="999">going in one direction. </span> <span class="line" data-startTime="1001">You can occasionally hit </span><span class="line" data-startTime="1001">a jump that'll take you </span><span class="line" data-startTime="1003">somewhere else in </span><span class="line" data-startTime="1003">the execution. </span> <span class="line" data-startTime="1004">And it could be an </span><span class="line" data-startTime="1004">arbitrary byte. </span> <span class="line" data-startTime="1006">So there's two classes </span><span class="line" data-startTime="1006">of jumps we're </span><span class="line" data-startTime="1007">going to deal with. </span> <span class="line" data-startTime="1008">One is direct jumps, jumps where </span><span class="line" data-startTime="1008">you know the address </span><span class="line" data-startTime="1011">that you're going to, and </span><span class="line" data-startTime="1011">indirect jumps, where your </span><span class="line" data-startTime="1013">address is calculated from data, </span><span class="line" data-startTime="1013">and you may not know </span><span class="line" data-startTime="1016">exactly where you're </span><span class="line" data-startTime="1016">going upfront. </span> <span class="line" data-startTime="1019">So here's an example of a </span><span class="line" data-startTime="1019">problematic direct jump. </span></p>

<p><span class="line" data-startTime="1022">So two instructions here. </span> <span class="line" data-startTime="1024">The first instruction loads a </span><span class="line" data-startTime="1024">constant into a register. </span> <span class="line" data-startTime="1028">Now, this is a strange constant, </span><span class="line" data-startTime="1028">but we'll assume the </span><span class="line" data-startTime="1031">programmer knows what they're </span><span class="line" data-startTime="1031">doing, and they have some </span><span class="line" data-startTime="1033">reason for that constant. </span> <span class="line" data-startTime="1035">And then the next instruction </span><span class="line" data-startTime="1035">jumps backwards 4 bytes. </span> <span class="line" data-startTime="1040">So on the surface, this </span><span class="line" data-startTime="1040">should be OK. </span> <span class="line" data-startTime="1044">But the fundamental problem is </span><span class="line" data-startTime="1044">that the move instruction </span><span class="line" data-startTime="1046">right before the jump backwards </span><span class="line" data-startTime="1046">is 5 bytes. </span> <span class="line" data-startTime="1050">So you're actually jumping back </span><span class="line" data-startTime="1050">into the middle of the </span><span class="line" data-startTime="1052">move instruction. </span> <span class="line" data-startTime="1054">So if we look at how the </span><span class="line" data-startTime="1054">processor sees this instead of </span><span class="line" data-startTime="1057">how our human eyes see the </span><span class="line" data-startTime="1057">assembly instruction, it first </span><span class="line" data-startTime="1062">sees the byte b8 and says, oh, </span><span class="line" data-startTime="1062">b8, that's a move constant </span><span class="line" data-startTime="1065">into eax instruction. </span> <span class="line" data-startTime="1067">And then there's going to be </span><span class="line" data-startTime="1067">4 bytes following it, which </span><span class="line" data-startTime="1070">define a constant. </span></p>

<p><span class="line" data-startTime="1071">So it happily pulls out the </span><span class="line" data-startTime="1071">constant, moves in the </span><span class="line" data-startTime="1073">register, goes on. </span> <span class="line" data-startTime="1075">Then it says, oh, there's a </span><span class="line" data-startTime="1075">jump backwards 4 bytes. </span> <span class="line" data-startTime="1078">It's actually a jump backwards 6 </span><span class="line" data-startTime="1078">bytes, because the processor </span><span class="line" data-startTime="1080">calculates from the end of the </span><span class="line" data-startTime="1080">instruction, whereas the </span><span class="line" data-startTime="1083">assembly language calculates </span><span class="line" data-startTime="1083">from the beginning. </span> <span class="line" data-startTime="1085">Just a detail, but </span><span class="line" data-startTime="1085">some people may </span><span class="line" data-startTime="1086">find it a little confusing. </span></p>

<p><span class="line" data-startTime="1088">So you jump backwards 4 bytes, </span><span class="line" data-startTime="1088">and then the processor happily </span><span class="line" data-startTime="1091">starts executing what </span><span class="line" data-startTime="1091">it previously </span><span class="line" data-startTime="1093">treated as a constant. </span> <span class="line" data-startTime="1095">So it says oh, 0f 05. </span> <span class="line" data-startTime="1098">Hey, that's a syscall. </span> <span class="line" data-startTime="1098">Let me do a syscall. </span> <span class="line" data-startTime="1100">And then suddenly, you don't. </span> <span class="line" data-startTime="1101">And then it sees a jump, which </span><span class="line" data-startTime="1101">nicely takes you out past the </span><span class="line" data-startTime="1104">previous jump, and you go on </span><span class="line" data-startTime="1104">with your normal execution. </span> <span class="line" data-startTime="1107">So in one single instruction, </span><span class="line" data-startTime="1107">we managed to smuggle in two </span><span class="line" data-startTime="1110">additional instructions, </span><span class="line" data-startTime="1110">which just entirely </span><span class="line" data-startTime="1112">compromised your system. </span> <span class="line" data-startTime="1114">So Native Client doesn't </span><span class="line" data-startTime="1114">play this game. </span> <span class="line" data-startTime="1116">If it ever detects a program </span><span class="line" data-startTime="1116">trying to jump into what it </span><span class="line" data-startTime="1119">previously thought was an </span><span class="line" data-startTime="1119">instruction, it says I'm not </span><span class="line" data-startTime="1122">going to run this program. </span> <span class="line" data-startTime="1123">I'm not going to touch it. </span> <span class="line" data-startTime="1124">Obviously, you're doing </span><span class="line" data-startTime="1124">something sketchy. </span></p>

<p><span class="line" data-startTime="1126">So if you generate code like </span><span class="line" data-startTime="1126">this, we don't run it. </span> <span class="line" data-startTime="1130">The other class of jumps </span><span class="line" data-startTime="1130">are indirect jumps. </span> <span class="line" data-startTime="1132">These are a little harder. </span> <span class="line" data-startTime="1134">Because you don't know exactly </span><span class="line" data-startTime="1134">where you're going. </span> <span class="line" data-startTime="1136">So how do we tell if we're </span><span class="line" data-startTime="1136">jumping inside an </span><span class="line" data-startTime="1138">instruction or not? </span><span class="line" data-startTime="1140">So this is a C example of where </span><span class="line" data-startTime="1140">indirect jumps come in. </span> <span class="line" data-startTime="1143">You take a function pointer. </span> <span class="line" data-startTime="1145">You call the function pointer. </span> <span class="line" data-startTime="1147">So if you look at the assembly </span><span class="line" data-startTime="1147">language, this is very </span><span class="line" data-startTime="1151">simplified, assuming </span><span class="line" data-startTime="1151">you have an </span><span class="line" data-startTime="1152">aggressive optimizing compiler. </span> <span class="line" data-startTime="1154">You do a direct call to a known </span><span class="line" data-startTime="1154">address, which we don't </span><span class="line" data-startTime="1158">know what it is. </span></p>

<p><span class="line" data-startTime="1158">So it's not fully </span><span class="line" data-startTime="1158">disassembled. </span> <span class="line" data-startTime="1160">And then the return value ends </span><span class="line" data-startTime="1160">up in rax, the register. </span> <span class="line" data-startTime="1163">And then you say, yeah, just </span><span class="line" data-startTime="1163">call that, whatever it is. </span> <span class="line" data-startTime="1167">So if we were being aggressive, </span><span class="line" data-startTime="1167">we could do some </span><span class="line" data-startTime="1169">deep analysis, try to figure </span><span class="line" data-startTime="1169">out what the pointer could </span><span class="line" data-startTime="1171">possibly point to. </span> <span class="line" data-startTime="1172">But that's hard. </span> <span class="line" data-startTime="1173">That's expensive. </span> <span class="line" data-startTime="1174">So instead, a much simpler </span><span class="line" data-startTime="1174">thing to do is look at </span><span class="line" data-startTime="1177">individual instructions and </span><span class="line" data-startTime="1177">say can we infer from the </span><span class="line" data-startTime="1180">sequence if what we're </span><span class="line" data-startTime="1180">doing is safe? </span><span class="line" data-startTime="1182">So what we're saying is that </span><span class="line" data-startTime="1182">this function pointer could be </span><span class="line" data-startTime="1185">a random number for </span><span class="line" data-startTime="1185">all we care. </span> <span class="line" data-startTime="1187">Can we make jumping to </span><span class="line" data-startTime="1187">a random number safe? </span><span class="line" data-startTime="1190">Can we make sure that jumping to </span><span class="line" data-startTime="1190">a random number doesn't get </span><span class="line" data-startTime="1193">us inside an instruction? </span><span class="line" data-startTime="1196">So the first step, which may not </span><span class="line" data-startTime="1196">make sense until you see </span><span class="line" data-startTime="1199">the second step, is any pointer, </span><span class="line" data-startTime="1199">any function pointer, </span><span class="line" data-startTime="1203">any instruction pointer that </span><span class="line" data-startTime="1203">we're going to jump to, we </span><span class="line" data-startTime="1205">first put a mask on it. </span></p>

<p><span class="line" data-startTime="1208">And that mask says, drop </span><span class="line" data-startTime="1208">the lower 5 bits. </span> <span class="line" data-startTime="1211">Set the lower 5 bits to 0. </span> <span class="line" data-startTime="1213">So how does this help us out? </span><span class="line" data-startTime="1215">What it means is that instead </span><span class="line" data-startTime="1215">of being able to jump </span><span class="line" data-startTime="1217">anywhere, we can instead jump </span><span class="line" data-startTime="1217">to every 32 bytes, 1/32 of </span><span class="line" data-startTime="1223">everywhere. </span> <span class="line" data-startTime="1224">And this isn't immediately </span><span class="line" data-startTime="1224">obvious how it </span><span class="line" data-startTime="1226">improves our lives. </span> <span class="line" data-startTime="1228">But we modified a </span><span class="line" data-startTime="1228">compiler, right? </span><span class="line" data-startTime="1230">So we can tell the compiler </span><span class="line" data-startTime="1230">that instead of having </span><span class="line" data-startTime="1233">instructions that could move </span><span class="line" data-startTime="1233">over or lap over the 32-byte </span><span class="line" data-startTime="1237">boundaries, any time you would </span><span class="line" data-startTime="1237">potentially omit an </span><span class="line" data-startTime="1239">instruction that overlaps the </span><span class="line" data-startTime="1239">boundary, nudge it down a </span><span class="line" data-startTime="1242">little bit. </span></p>

<p><span class="line" data-startTime="1243">Stick in extra operations </span><span class="line" data-startTime="1243">that do nothing. </span> <span class="line" data-startTime="1246">And then we know that any time </span><span class="line" data-startTime="1246">you do an indirect jump to a </span><span class="line" data-startTime="1248">32-byte boundary, you will be </span><span class="line" data-startTime="1248">hitting the start of an </span><span class="line" data-startTime="1251">instruction instead of the </span><span class="line" data-startTime="1251">middle of an instruction. </span> <span class="line" data-startTime="1255">So the mask allows you to jump </span><span class="line" data-startTime="1255">to known safe locations, even </span><span class="line" data-startTime="1258">if you don't know what </span><span class="line" data-startTime="1258">those locations are. </span> <span class="line" data-startTime="1261">Here's a more concrete </span><span class="line" data-startTime="1261">example. </span> <span class="line" data-startTime="1263">Here is that funky move again </span><span class="line" data-startTime="1263">with that constant. </span> <span class="line" data-startTime="1265">And if you generated it so that </span><span class="line" data-startTime="1265">it overlapped the 32-byte </span><span class="line" data-startTime="1268">boundary, an indirect </span><span class="line" data-startTime="1268">jump could again </span><span class="line" data-startTime="1271">execute this syscall. </span> <span class="line" data-startTime="1272">Because it would go to a mov 32 </span><span class="line" data-startTime="1272">address, see the 0f 05, and </span><span class="line" data-startTime="1278">boom, there goes your </span><span class="line" data-startTime="1278">tax return. </span></p>

<p><span class="line" data-startTime="1280">So instead, the validation </span><span class="line" data-startTime="1280">algorithm require would reject </span><span class="line" data-startTime="1284">this, because it overlaps </span><span class="line" data-startTime="1284">the boundary. </span> <span class="line" data-startTime="1286">Instead the compiler would </span><span class="line" data-startTime="1286">generate this extra </span><span class="line" data-startTime="1289">no-operation and move the </span><span class="line" data-startTime="1289">instruction down. </span> <span class="line" data-startTime="1292">So the combination of not </span><span class="line" data-startTime="1292">allowing direct jumps inside </span><span class="line" data-startTime="1295">that instruction and making </span><span class="line" data-startTime="1295">sure that no instructions </span><span class="line" data-startTime="1297">overlap 32-byte boundaries allow </span><span class="line" data-startTime="1297">you to know where all </span><span class="line" data-startTime="1300">the control flow in your </span><span class="line" data-startTime="1300">program is going. </span> <span class="line" data-startTime="1304">Aha, you say, but I'm </span><span class="line" data-startTime="1304">a clever hacker. </span> <span class="line" data-startTime="1306">I can modify the code after </span><span class="line" data-startTime="1306">you validate it. </span> <span class="line" data-startTime="1308">So validation just happens </span><span class="line" data-startTime="1308">at the beginning. </span> <span class="line" data-startTime="1311">We say, we'll look </span><span class="line" data-startTime="1311">at the code. </span> <span class="line" data-startTime="1313">If it's good to go, we'll </span><span class="line" data-startTime="1313">let you run the code. </span></p>

<p><span class="line" data-startTime="1316">So, to prevent code </span><span class="line" data-startTime="1316">modification, we say any time </span><span class="line" data-startTime="1319">we have a chunk of data, which </span><span class="line" data-startTime="1319">represents code, it's going to </span><span class="line" data-startTime="1322">be readable and executable </span><span class="line" data-startTime="1322">when you don't have the </span><span class="line" data-startTime="1325">permissions to write it. </span> <span class="line" data-startTime="1327">So everything that goes through </span><span class="line" data-startTime="1327">the validator, once we </span><span class="line" data-startTime="1329">know what it does, we make sure </span><span class="line" data-startTime="1329">it keeps doing what we </span><span class="line" data-startTime="1332">know it does. </span> <span class="line" data-startTime="1334">Aha, you say. </span> <span class="line" data-startTime="1335">But what about things </span><span class="line" data-startTime="1335">that aren't code? </span><span class="line" data-startTime="1337">So I can just do a buffer </span><span class="line" data-startTime="1337">overflow somewhere, jump to </span><span class="line" data-startTime="1340">that buffer overflow, start </span><span class="line" data-startTime="1340">executing it, and I just </span><span class="line" data-startTime="1343">executed code you haven't </span><span class="line" data-startTime="1343">validated. </span> <span class="line" data-startTime="1344">Well, again, every piece of data </span><span class="line" data-startTime="1344">we make sure can be read </span><span class="line" data-startTime="1348">and written, but not executed. </span></p>

<p><span class="line" data-startTime="1351">So this plugs the hole for </span><span class="line" data-startTime="1351">self-modifying code. </span> <span class="line" data-startTime="1354">So I just lied to you. </span> <span class="line" data-startTime="1355">And that's that things can </span><span class="line" data-startTime="1355">change after the initial setup </span><span class="line" data-startTime="1359">of the program. </span> <span class="line" data-startTime="1360">So you can load dynamic </span><span class="line" data-startTime="1360">libraries. </span> <span class="line" data-startTime="1362">You can have just-in-time </span><span class="line" data-startTime="1362">compilers which emit new code </span><span class="line" data-startTime="1365">and actually modify the code </span><span class="line" data-startTime="1365">in very controlled ways. </span> <span class="line" data-startTime="1368">But how you do that is </span><span class="line" data-startTime="1368">kind of complicated. </span> <span class="line" data-startTime="1370">Because you need to make sure </span><span class="line" data-startTime="1370">that if there's multiple </span><span class="line" data-startTime="1372">threads, you never get memory </span><span class="line" data-startTime="1372">de-coherency, where you </span><span class="line" data-startTime="1376">execute an instruction </span><span class="line" data-startTime="1376">which is in the </span><span class="line" data-startTime="1377">middle of being modified. </span> <span class="line" data-startTime="1379">At the end of this presentation, </span><span class="line" data-startTime="1379">I'll have a link </span><span class="line" data-startTime="1381">to the research papers. </span> <span class="line" data-startTime="1382">So if you're really interested </span><span class="line" data-startTime="1382">in how we do memory safe code </span><span class="line" data-startTime="1385">modification, you can read </span><span class="line" data-startTime="1385">up or ask me afterwards. </span></p>

<p><span class="line" data-startTime="1388">But for this presentation, we're </span><span class="line" data-startTime="1388">going to ignore this </span><span class="line" data-startTime="1390">rather large, ugly issue. </span> <span class="line" data-startTime="1393">Another thing is that mprotect </span><span class="line" data-startTime="1393">is now security-critical. </span> <span class="line" data-startTime="1398">So syscalls, we've thought about </span><span class="line" data-startTime="1398">all the damage we could </span><span class="line" data-startTime="1401">do with them. </span> <span class="line" data-startTime="1402">But now we can start doing </span><span class="line" data-startTime="1402">indirect damage like </span><span class="line" data-startTime="1404">unprotecting a page, writing it, </span><span class="line" data-startTime="1404">then boom, we're executing </span><span class="line" data-startTime="1407">code that is invalid. </span> <span class="line" data-startTime="1410">Similarly, there's other </span><span class="line" data-startTime="1410">syscalls like GetProcessID, </span><span class="line" data-startTime="1413">not immediately obvious why </span><span class="line" data-startTime="1413">they're dangerous, but they </span><span class="line" data-startTime="1415">can be used to escalate attacks </span><span class="line" data-startTime="1415">by knowing where </span><span class="line" data-startTime="1418">you're going from. </span> <span class="line" data-startTime="1419">So the name of the game is </span><span class="line" data-startTime="1419">white-listing, only allowing </span><span class="line" data-startTime="1421">functionality we know is safe </span><span class="line" data-startTime="1421">instead of saying, eh, do a </span><span class="line" data-startTime="1424">syscall , whatever. </span></p>

<p><span class="line" data-startTime="1428">So that's the basics of how we </span><span class="line" data-startTime="1428">allow code to be decompiled. </span> <span class="line" data-startTime="1431">And if you actually start </span><span class="line" data-startTime="1431">looking at how this affects </span><span class="line" data-startTime="1434">calling and returning a </span><span class="line" data-startTime="1434">function, there's some </span><span class="line" data-startTime="1435">interesting things that </span><span class="line" data-startTime="1435">get shaken out. </span> <span class="line" data-startTime="1437">So I'm going to do </span><span class="line" data-startTime="1437">in the reverse. </span> <span class="line" data-startTime="1439">I'm going to show how you </span><span class="line" data-startTime="1439">return from a function. </span> <span class="line" data-startTime="1441">Then I'm going to show how you </span><span class="line" data-startTime="1441">call it, because the return </span><span class="line" data-startTime="1443">impacts the call. </span> <span class="line" data-startTime="1447">So usually, returning from </span><span class="line" data-startTime="1447">a function is a single </span><span class="line" data-startTime="1449">instruction. </span> <span class="line" data-startTime="1450">Return, pop an address off the </span><span class="line" data-startTime="1450">stack, jumps to that address, </span><span class="line" data-startTime="1454">and you're back to where </span><span class="line" data-startTime="1454">you called from. </span> <span class="line" data-startTime="1457">So you could call the same </span><span class="line" data-startTime="1457">function for multiple places. </span></p>

<p><span class="line" data-startTime="1460">So the call records where you </span><span class="line" data-startTime="1460">called from on the stack in </span><span class="line" data-startTime="1463">order to be able to </span><span class="line" data-startTime="1463">return to it. </span> <span class="line" data-startTime="1464">But implicitly, this is </span><span class="line" data-startTime="1464">an indirect jump. </span> <span class="line" data-startTime="1469">So a malicious program could </span><span class="line" data-startTime="1469">stick a random number on the </span><span class="line" data-startTime="1472">stack and then jump instead of </span><span class="line" data-startTime="1472">calling to the function. </span> <span class="line" data-startTime="1475">And then when the function </span><span class="line" data-startTime="1475">returned, who </span><span class="line" data-startTime="1477">knows where you are. </span> <span class="line" data-startTime="1479">So there is a type of exploit </span><span class="line" data-startTime="1479">called return-oriented </span><span class="line" data-startTime="1481">programming, which uses this </span><span class="line" data-startTime="1481">kind of thing where the </span><span class="line" data-startTime="1484">returns can be repurposed </span><span class="line" data-startTime="1484">for jumping </span><span class="line" data-startTime="1486">to arbitrary locations. </span> <span class="line" data-startTime="1488">So we can try to fix this. </span></p>

<p><span class="line" data-startTime="1490">We can manually pop the return </span><span class="line" data-startTime="1490">address off the stack, mask </span><span class="line" data-startTime="1494">it, just like we should for </span><span class="line" data-startTime="1494">indirect jumps, push it back </span><span class="line" data-startTime="1496">on the stack, and then return. </span> <span class="line" data-startTime="1498">So problem solved. </span> <span class="line" data-startTime="1499">Well, no. </span> <span class="line" data-startTime="1501">I mentioned threads earlier. </span> <span class="line" data-startTime="1502">And threads are a big problem </span><span class="line" data-startTime="1502">because there could be another </span><span class="line" data-startTime="1504">thread in the background trying </span><span class="line" data-startTime="1504">to smash the stack. </span> <span class="line" data-startTime="1507">And so between the moment where </span><span class="line" data-startTime="1507">you push the address on </span><span class="line" data-startTime="1510">the stack and when you return, </span><span class="line" data-startTime="1510">the memory could get changed </span><span class="line" data-startTime="1514">out from under you, and you </span><span class="line" data-startTime="1514">could end up anywhere. </span> <span class="line" data-startTime="1516">Who knows where? </span><span class="line" data-startTime="1517">So we can't really trust any </span><span class="line" data-startTime="1517">addresses in memory. </span> <span class="line" data-startTime="1520">We can only trust addresses </span><span class="line" data-startTime="1520">in registers. </span> <span class="line" data-startTime="1523">So what this means is that in </span><span class="line" data-startTime="1523">order to return, we can't use </span><span class="line" data-startTime="1526">the return instruction. </span></p>

<p><span class="line" data-startTime="1527">We pop off the stack, mask it, </span><span class="line" data-startTime="1527">and then jump to the address. </span> <span class="line" data-startTime="1531">This has a few consequences, </span><span class="line" data-startTime="1531">like branch prediction is a </span><span class="line" data-startTime="1533">little harder. </span> <span class="line" data-startTime="1534">And we're using more bytes </span><span class="line" data-startTime="1534">to do the same operation. </span> <span class="line" data-startTime="1538">So I mentioned earlier that </span><span class="line" data-startTime="1538">the sandboxing schemes for </span><span class="line" data-startTime="1541">different architectures </span><span class="line" data-startTime="1541">were different. </span> <span class="line" data-startTime="1543">And this is largely due to the </span><span class="line" data-startTime="1543">fact that we are trying to </span><span class="line" data-startTime="1545">minimize the cost and tailor </span><span class="line" data-startTime="1545">it to each architecture. </span> <span class="line" data-startTime="1549">So we try to keep the number </span><span class="line" data-startTime="1549">of bytes per sandbox </span><span class="line" data-startTime="1552">instruction as low as possible </span><span class="line" data-startTime="1552">through being horrendously </span><span class="line" data-startTime="1555">clever about how </span><span class="line" data-startTime="1555">we mask things. </span> <span class="line" data-startTime="1557">And if you want to talk about </span><span class="line" data-startTime="1557">this, again, we can talk about </span><span class="line" data-startTime="1559">it afterwards, about clever </span><span class="line" data-startTime="1559">instruction encodings. </span> <span class="line" data-startTime="1562">So return. </span></p>

<p><span class="line" data-startTime="1563">A very basic instruction is </span><span class="line" data-startTime="1563">actually dangerous because </span><span class="line" data-startTime="1566">it's doing an indirect jump </span><span class="line" data-startTime="1566">to a location from memory. </span> <span class="line" data-startTime="1573">So bad idea. </span> <span class="line" data-startTime="1575">We have to do it explicitly. </span> <span class="line" data-startTime="1578">So whenever we have masks, it </span><span class="line" data-startTime="1578">becomes critical that we don't </span><span class="line" data-startTime="1583">bypass the mask. </span> <span class="line" data-startTime="1585">So we may have two instructions, </span><span class="line" data-startTime="1585">the mask and </span><span class="line" data-startTime="1588">then the jump. </span> <span class="line" data-startTime="1589">But if there's some other jump </span><span class="line" data-startTime="1589">which goes between the </span><span class="line" data-startTime="1592">instructions, it doesn't </span><span class="line" data-startTime="1592">actually violate what I talked </span><span class="line" data-startTime="1594">about previously. </span> <span class="line" data-startTime="1595">I said you can't jump </span><span class="line" data-startTime="1595">into an instruction. </span> <span class="line" data-startTime="1598">But if you jump between these </span><span class="line" data-startTime="1598">two instructions that are </span><span class="line" data-startTime="1600">critical for safety, </span><span class="line" data-startTime="1600">suddenly you just </span><span class="line" data-startTime="1602">stripped off the mask. </span></p>

<p><span class="line" data-startTime="1602">The entire security </span><span class="line" data-startTime="1602">model fails. </span> <span class="line" data-startTime="1604">And you have a problem. </span> <span class="line" data-startTime="1607">We call these </span><span class="line" data-startTime="1607">pseudo-instructions. </span> <span class="line" data-startTime="1608">So whenever we have a sequence </span><span class="line" data-startTime="1608">of instructions which is </span><span class="line" data-startTime="1610">security critical, we say treat </span><span class="line" data-startTime="1610">it just like it was an </span><span class="line" data-startTime="1613">instruction. </span> <span class="line" data-startTime="1614">So direct jumps cannot jump </span><span class="line" data-startTime="1614">inside a pseudo-instruction. </span> <span class="line" data-startTime="1618">Indirect jumps cannot jump </span><span class="line" data-startTime="1618">inside a pseudo-instruction, </span><span class="line" data-startTime="1621">which means that the entire </span><span class="line" data-startTime="1621">pseudo-instruction has to not </span><span class="line" data-startTime="1624">cross a 32-byte boundary. </span> <span class="line" data-startTime="1629">As a terminology, we </span><span class="line" data-startTime="1629">call this bundling. </span> <span class="line" data-startTime="1632">So what does this mean for </span><span class="line" data-startTime="1632">calling a function? </span><span class="line" data-startTime="1638">If you just call it like you </span><span class="line" data-startTime="1638">expected, just from the middle </span><span class="line" data-startTime="1641">of a bundle somewhere, </span><span class="line" data-startTime="1641">you do the call. </span> <span class="line" data-startTime="1645">You know, you see </span><span class="line" data-startTime="1645">the mask here. </span></p>

<p><span class="line" data-startTime="1646">You see the indirect jump. </span> <span class="line" data-startTime="1647">And then where do </span><span class="line" data-startTime="1647">you return to? </span><span class="line" data-startTime="1649">The problem is that the mask </span><span class="line" data-startTime="1649">drops the lower 5 bits of the </span><span class="line" data-startTime="1652">address, so you aren't returning </span><span class="line" data-startTime="1652">to the address that </span><span class="line" data-startTime="1656">was pushed on the stack </span><span class="line" data-startTime="1656">if those lower bits </span><span class="line" data-startTime="1658">were not all zeroes. </span> <span class="line" data-startTime="1660">So you end up returning to the </span><span class="line" data-startTime="1660">beginning of the bundle where </span><span class="line" data-startTime="1664">the call was from. </span> <span class="line" data-startTime="1665">And this is obviously </span><span class="line" data-startTime="1665">not what you want. </span> <span class="line" data-startTime="1667">This starts to look a bit like </span><span class="line" data-startTime="1667">an infinite loop unless you </span><span class="line" data-startTime="1669">account for it. </span> <span class="line" data-startTime="1670">Where you really want it to </span><span class="line" data-startTime="1670">return is immediately after </span><span class="line" data-startTime="1672">the instruction. </span> <span class="line" data-startTime="1673">So the work-around for this is </span><span class="line" data-startTime="1673">that whenever you have a call, </span><span class="line" data-startTime="1678">you pat it down to the very </span><span class="line" data-startTime="1678">end of the bundle. </span> <span class="line" data-startTime="1681">And this means that the return </span><span class="line" data-startTime="1681">address is at the beginning of </span><span class="line" data-startTime="1685">the very next bundle. </span> <span class="line" data-startTime="1686">So when you mask it, when you </span><span class="line" data-startTime="1686">drop the lower 5 bits, it </span><span class="line" data-startTime="1689">doesn't change it at all. </span></p>

<p><span class="line" data-startTime="1691">So all these instruction </span><span class="line" data-startTime="1691">sequences that we're showing </span><span class="line" data-startTime="1696">in fact should not change the </span><span class="line" data-startTime="1696">correctness of the program. </span> <span class="line" data-startTime="1699">They are simply there for the </span><span class="line" data-startTime="1699">validator to say, oh, yep, I </span><span class="line" data-startTime="1703">can prove that this is safe. </span> <span class="line" data-startTime="1704">And if somehow garbage data gets </span><span class="line" data-startTime="1704">in here, I know that I'm </span><span class="line" data-startTime="1707">going to be jumping </span><span class="line" data-startTime="1707">to a known place. </span> <span class="line" data-startTime="1709">But in normal operation, the </span><span class="line" data-startTime="1709">compiler will stick everything </span><span class="line" data-startTime="1712">on 32-byte aligned boundaries </span><span class="line" data-startTime="1712">that we need to jump to </span><span class="line" data-startTime="1715">indirectly. </span></p>

<p><span class="line" data-startTime="1719">OK, so yet again, I lied. </span> <span class="line" data-startTime="1721">I seem to be a serial </span><span class="line" data-startTime="1721">liar here. </span> <span class="line" data-startTime="1723">I apologize. </span> <span class="line" data-startTime="1726">There's more going on </span><span class="line" data-startTime="1726">in the process than </span><span class="line" data-startTime="1728">just this bit of code. </span> <span class="line" data-startTime="1729">We can validate a lot of code, </span><span class="line" data-startTime="1729">but as it turns out, there's </span><span class="line" data-startTime="1732">other code and data in </span><span class="line" data-startTime="1732">the process that </span><span class="line" data-startTime="1734">we don't fully control. </span> <span class="line" data-startTime="1735">It needs to be there </span><span class="line" data-startTime="1735">so we can use it. </span> <span class="line" data-startTime="1738">So we have a world where we </span><span class="line" data-startTime="1738">have a single process with </span><span class="line" data-startTime="1742">code we don't trust and </span><span class="line" data-startTime="1742">code that we do trust. </span> <span class="line" data-startTime="1745">So this is the general view </span><span class="line" data-startTime="1745">of what I've shown so far. </span></p>

<p><span class="line" data-startTime="1750">There's untrusted code </span><span class="line" data-startTime="1750">and untrusted data. </span> <span class="line" data-startTime="1752">And what I mean by untrusted </span><span class="line" data-startTime="1752">is this code is coming from </span><span class="line" data-startTime="1755">somewhere across the wire. </span> <span class="line" data-startTime="1757">And instead of having to have </span><span class="line" data-startTime="1757">this dialog box that says, </span><span class="line" data-startTime="1760">well, you're running </span><span class="line" data-startTime="1760">at your own risk. </span> <span class="line" data-startTime="1761">Instead, we validate it. </span> <span class="line" data-startTime="1763">And then we say this conforms </span><span class="line" data-startTime="1763">to our rules. </span> <span class="line" data-startTime="1765">So we'll run it without having </span><span class="line" data-startTime="1765">to place trust in it. </span> <span class="line" data-startTime="1767">We will enforce the security </span><span class="line" data-startTime="1767">instead of trusting, so </span><span class="line" data-startTime="1771">untrusted code, untrusted </span><span class="line" data-startTime="1771">data. </span> <span class="line" data-startTime="1774">Well, every time you launch a </span><span class="line" data-startTime="1774">process, the operating system </span><span class="line" data-startTime="1778">likes to stick in some code. </span> <span class="line" data-startTime="1780">So you can talk with the </span><span class="line" data-startTime="1780">operating system. </span> <span class="line" data-startTime="1782">And we could do something really </span><span class="line" data-startTime="1782">nasty, like try to </span><span class="line" data-startTime="1784">overwrite this, kick it out. </span> <span class="line" data-startTime="1786">But we're going to need </span><span class="line" data-startTime="1786">it eventually. </span> <span class="line" data-startTime="1788">We're going to need </span><span class="line" data-startTime="1788">to do something. </span></p>

<p><span class="line" data-startTime="1790">Simply living within the </span><span class="line" data-startTime="1790">sandbox isn't enough. </span> <span class="line" data-startTime="1792">So down the road, we're going </span><span class="line" data-startTime="1792">to need to talk to the NTDLL </span><span class="line" data-startTime="1796">on Windows, for instance. </span> <span class="line" data-startTime="1798">But we don't want the untrusted </span><span class="line" data-startTime="1798">code to do it. </span> <span class="line" data-startTime="1801">Similarly, we're going to be </span><span class="line" data-startTime="1801">talking with a web browser. </span> <span class="line" data-startTime="1803">So the easiest way to do this </span><span class="line" data-startTime="1803">is load the DLL for the web </span><span class="line" data-startTime="1807">browser in the process. </span> <span class="line" data-startTime="1808">So we can call the same </span><span class="line" data-startTime="1808">functionality to talk between </span><span class="line" data-startTime="1811">processes that Chrome uses. </span> <span class="line" data-startTime="1813">There's also trusted data. </span> <span class="line" data-startTime="1815">So when we're running the </span><span class="line" data-startTime="1815">sandbox, we have to keep track </span><span class="line" data-startTime="1818">of things like where </span><span class="line" data-startTime="1818">code is mapped. </span></p>

<p><span class="line" data-startTime="1820">Because if the untrusted code </span><span class="line" data-startTime="1820">says, well, there's actually </span><span class="line" data-startTime="1824">no code there, so why don't </span><span class="line" data-startTime="1824">you map code there again? </span><span class="line" data-startTime="1826">Then we could get weird </span><span class="line" data-startTime="1826">overwrites, partial </span><span class="line" data-startTime="1828">instructions. </span> <span class="line" data-startTime="1829">So there's bookkeeping data. </span> <span class="line" data-startTime="1830">And if you could clobber that </span><span class="line" data-startTime="1830">data, if you could go there </span><span class="line" data-startTime="1833">and say overwrite the table </span><span class="line" data-startTime="1833">for where all the code is, </span><span class="line" data-startTime="1835">then the untrusted code </span><span class="line" data-startTime="1835">could start doing, </span><span class="line" data-startTime="1837">again, very bad things. </span> <span class="line" data-startTime="1840">What we need to do is we need to </span><span class="line" data-startTime="1840">make sure all the execution </span><span class="line" data-startTime="1844">and all the data access that </span><span class="line" data-startTime="1844">can be done directly by the </span><span class="line" data-startTime="1847">untrusted code only happens </span><span class="line" data-startTime="1847">within a confined region that </span><span class="line" data-startTime="1852">doesn't include NTDLL, that </span><span class="line" data-startTime="1852">doesn't include Chrome DLL, </span><span class="line" data-startTime="1855">that doesn't include any bit of </span><span class="line" data-startTime="1855">code or data which could be </span><span class="line" data-startTime="1858">used as an exploit. </span> <span class="line" data-startTime="1860">So on 64-bit systems, this is a </span><span class="line" data-startTime="1860">4-gigabyte range of memory. </span> <span class="line" data-startTime="1865">And we reserve one of the </span><span class="line" data-startTime="1865">registers, R15, to point to </span><span class="line" data-startTime="1868">the bottom of this range. </span></p>

<p><span class="line" data-startTime="1870">So one of our security-critical </span><span class="line" data-startTime="1870">properties </span><span class="line" data-startTime="1872">is that R15 cannot </span><span class="line" data-startTime="1872">be overwritten by </span><span class="line" data-startTime="1875">the entrusted code. </span> <span class="line" data-startTime="1876">So as the validator goes </span><span class="line" data-startTime="1876">through, it looks for anything </span><span class="line" data-startTime="1878">that can modify R15. </span> <span class="line" data-startTime="1880">And if something does, it </span><span class="line" data-startTime="1880">goes, nope, not going </span><span class="line" data-startTime="1883">to deal with it. </span> <span class="line" data-startTime="1884">A thing you may note also is </span><span class="line" data-startTime="1884">that this is a 4-gigabyte </span><span class="line" data-startTime="1887">range, which happens to be 2 of </span><span class="line" data-startTime="1887">32, which allows us to do </span><span class="line" data-startTime="1890">some horrendously clever stuff </span><span class="line" data-startTime="1890">to make our masking as small </span><span class="line" data-startTime="1893">as possible. </span> <span class="line" data-startTime="1894">We'll get into that </span><span class="line" data-startTime="1894">in a second. </span> <span class="line" data-startTime="1897">So here's a scenario that </span><span class="line" data-startTime="1897">we have to worry about. </span> <span class="line" data-startTime="1899">What happens when the untrusted </span><span class="line" data-startTime="1899">code tries to jump </span><span class="line" data-startTime="1901">outside the sandbox? </span><span class="line" data-startTime="1903">So it can't do a direct jump </span><span class="line" data-startTime="1903">outside this constrained </span><span class="line" data-startTime="1907">range, because the validator </span><span class="line" data-startTime="1907">can't see the target. </span> <span class="line" data-startTime="1910">And because it can't see the </span><span class="line" data-startTime="1910">target, it can't tell whether </span><span class="line" data-startTime="1913">it's in the middle of an </span><span class="line" data-startTime="1913">instruction, so it says, no. </span></p>

<p><span class="line" data-startTime="1915">But it could do an </span><span class="line" data-startTime="1915">indirect jump. </span> <span class="line" data-startTime="1918">So it could do an indirect </span><span class="line" data-startTime="1918">jump to a 32-byte aligned </span><span class="line" data-startTime="1920">boundary somewhere in NTDLL. </span> <span class="line" data-startTime="1922">And we have to allow this, </span><span class="line" data-startTime="1922">because you could be loading </span><span class="line" data-startTime="1924">shared libraries. </span> <span class="line" data-startTime="1925">So you may not know where the </span><span class="line" data-startTime="1925">code is before you load it. </span> <span class="line" data-startTime="1928">So what we have to do is we have </span><span class="line" data-startTime="1928">to make sure the indirect </span><span class="line" data-startTime="1931">jumps only fall within this </span><span class="line" data-startTime="1931">constrained range. </span> <span class="line" data-startTime="1934">So how do we do that? </span><span class="line" data-startTime="1936">We have to confine the jumps </span><span class="line" data-startTime="1936">to the 4-gigabyte range. </span> <span class="line" data-startTime="1940">Here's an example. </span> <span class="line" data-startTime="1940">It's just an empty function. </span> <span class="line" data-startTime="1942">What's happening implicitly </span><span class="line" data-startTime="1942">here, however, </span><span class="line" data-startTime="1944">is that it's returning. </span> <span class="line" data-startTime="1945">And as we went through all these </span><span class="line" data-startTime="1945">explanations, this is </span><span class="line" data-startTime="1948">what a return eventually </span><span class="line" data-startTime="1948">looks like. </span></p>

<p><span class="line" data-startTime="1950">There's this masked indirect </span><span class="line" data-startTime="1950">jump back to </span><span class="line" data-startTime="1953">wherever you came from. </span> <span class="line" data-startTime="1954">But this could go into NTDLL. </span> <span class="line" data-startTime="1957">How do we fix it? </span><span class="line" data-startTime="1959">So we confine it by masking </span><span class="line" data-startTime="1959">it and dropping </span><span class="line" data-startTime="1963">the upper 32 bits. </span> <span class="line" data-startTime="1965">So we boil it down to </span><span class="line" data-startTime="1965">a 32-bit address. </span> <span class="line" data-startTime="1967">Then we add the offset. </span> <span class="line" data-startTime="1969">And then we actually use that. </span> <span class="line" data-startTime="1971">So remember I was saying </span><span class="line" data-startTime="1971">horrendously clever? </span><span class="line" data-startTime="1973">This is not really </span><span class="line" data-startTime="1973">self-promotion. </span> <span class="line" data-startTime="1975">When I was doing this </span><span class="line" data-startTime="1975">presentation, I had to work </span><span class="line" data-startTime="1977">through exactly how these </span><span class="line" data-startTime="1977">instructions worked. </span> <span class="line" data-startTime="1980">It's actually pretty </span><span class="line" data-startTime="1980">interesting. </span></p>

<p><span class="line" data-startTime="1981">So the "and" right here </span><span class="line" data-startTime="1981">is doing a 32-bit </span><span class="line" data-startTime="1984">operation on a register. </span> <span class="line" data-startTime="1985">And then later the register is </span><span class="line" data-startTime="1985">being used as a 64-bit value. </span> <span class="line" data-startTime="1989">So doing the 32-bit operation </span><span class="line" data-startTime="1989">implicitly </span><span class="line" data-startTime="1992">zeroes the upper bits. </span> <span class="line" data-startTime="1994">And this allows the actual "and" </span><span class="line" data-startTime="1994">to be packed down into a </span><span class="line" data-startTime="1997">single byte data. </span> <span class="line" data-startTime="1999">So it says, it's going to </span><span class="line" data-startTime="1999">be e0 sign extended. </span> <span class="line" data-startTime="2002">And then I'll implicitly drop </span><span class="line" data-startTime="2002">the upper 32 bits, because </span><span class="line" data-startTime="2005">it's a 32-bit operation. </span> <span class="line" data-startTime="2006">Then you do a full 64-bit add </span><span class="line" data-startTime="2006">and a full 64-bit jump. </span> <span class="line" data-startTime="2010">So the cost of this is about </span><span class="line" data-startTime="2010">8 bytes as opposed 2 bytes. </span> <span class="line" data-startTime="2014">So there's a bit of overhead for </span><span class="line" data-startTime="2014">doing it this way, but we </span><span class="line" data-startTime="2016">know where it's going. </span> <span class="line" data-startTime="2017">We know it's only going to be </span><span class="line" data-startTime="2017">within the confined region. </span></p>

<p><span class="line" data-startTime="2019">And we know it's only going to </span><span class="line" data-startTime="2019">be to a 32-byte boundary. </span> <span class="line" data-startTime="2022">And we know there's going to </span><span class="line" data-startTime="2022">be no instructions that are </span><span class="line" data-startTime="2024">overlapping those 32-byte </span><span class="line" data-startTime="2024">boundaries. </span> <span class="line" data-startTime="2027">The next thing to worry about is </span><span class="line" data-startTime="2027">reading and writing bits of </span><span class="line" data-startTime="2031">data that are outside </span><span class="line" data-startTime="2031">this confined range. </span> <span class="line" data-startTime="2034">Writing is obviously </span><span class="line" data-startTime="2034">a problem. </span> <span class="line" data-startTime="2036">If you can write to something, </span><span class="line" data-startTime="2036">you can change it. </span> <span class="line" data-startTime="2038">You can control it. </span> <span class="line" data-startTime="2039">It makes attacks much easier. </span> <span class="line" data-startTime="2042">Reading, debatably it's not an </span><span class="line" data-startTime="2042">attack, but this can be used </span><span class="line" data-startTime="2047">to help attacks. </span> <span class="line" data-startTime="2049">So if you can poke around </span><span class="line" data-startTime="2049">memory, find where things are, </span><span class="line" data-startTime="2051">then you can do much more </span><span class="line" data-startTime="2051">controlled jumps, much more </span><span class="line" data-startTime="2054">dangerous intended </span><span class="line" data-startTime="2054">actions than just </span><span class="line" data-startTime="2057">jumping around randomly. </span> <span class="line" data-startTime="2059">So how do we confine </span><span class="line" data-startTime="2059">data access? </span><span class="line" data-startTime="2062">Here's an example </span><span class="line" data-startTime="2062">of a C function. </span> <span class="line" data-startTime="2064">We're just taking a function </span><span class="line" data-startTime="2064">pointer, and we're writing a </span><span class="line" data-startTime="2067">constant to that pointer </span><span class="line" data-startTime="2067">wherever it may be. </span> <span class="line" data-startTime="2070">Thus far, we haven't </span><span class="line" data-startTime="2070">talked about </span><span class="line" data-startTime="2072">sandboxing rights at all. </span></p>

<p><span class="line" data-startTime="2074">So the Intel instruction for </span><span class="line" data-startTime="2074">doing this just says move this </span><span class="line" data-startTime="2077">constant to wherever the memory </span><span class="line" data-startTime="2077">address points to. </span> <span class="line" data-startTime="2080">So to sandbox it, we do </span><span class="line" data-startTime="2080">something similar to jumps. </span> <span class="line" data-startTime="2083">We mask it by moving a 32-bit </span><span class="line" data-startTime="2083">register to itself. </span> <span class="line" data-startTime="2087">So again, we rely on the </span><span class="line" data-startTime="2087">implicit zeroing </span><span class="line" data-startTime="2090">of the upper bits. </span> <span class="line" data-startTime="2091">But since we don't need to </span><span class="line" data-startTime="2091">discard the lower bits, it's </span><span class="line" data-startTime="2093">just a move. </span> <span class="line" data-startTime="2095">Simple enough. </span> <span class="line" data-startTime="2096">And then we do a complicated </span><span class="line" data-startTime="2096">addressing mode, which </span><span class="line" data-startTime="2100">actually adds R15 simultaneously </span><span class="line" data-startTime="2100">with moving the </span><span class="line" data-startTime="2106">constant to the address </span><span class="line" data-startTime="2106">that's computed. </span> <span class="line" data-startTime="2108">So this move instruction is </span><span class="line" data-startTime="2108">saying add R15 to rax and then </span><span class="line" data-startTime="2113">multiply rax by 1, </span><span class="line" data-startTime="2113">and there you go. </span></p>

<p><span class="line" data-startTime="2116">Instead of 5 bytes to do this </span><span class="line" data-startTime="2116">move constant, we got 9 bytes. </span> <span class="line" data-startTime="2120">Not too bad. </span> <span class="line" data-startTime="2122">There's a little curious </span><span class="line" data-startTime="2122">thing here, though. </span> <span class="line" data-startTime="2123">There's that multiplier. </span> <span class="line" data-startTime="2126">So we know that rax is a </span><span class="line" data-startTime="2126">32-bit value, but that </span><span class="line" data-startTime="2128">multiplier can be up to 8. </span> <span class="line" data-startTime="2130">So we aren't actually operating </span><span class="line" data-startTime="2130">within a 4-gigabyte </span><span class="line" data-startTime="2133">range, we're potentially </span><span class="line" data-startTime="2133">doing a write </span><span class="line" data-startTime="2136">to 8 times 4 gigabytes? </span><span class="line" data-startTime="2138">And there's ways you can rack </span><span class="line" data-startTime="2138">it up even further with </span><span class="line" data-startTime="2141">constant offsets. </span> <span class="line" data-startTime="2142">So we could tweak this a little </span><span class="line" data-startTime="2142">harder and do the mask </span><span class="line" data-startTime="2147">and get rid of the </span><span class="line" data-startTime="2147">multiplications, but sometimes </span><span class="line" data-startTime="2150">compilers just like </span><span class="line" data-startTime="2150">to generate these. </span> <span class="line" data-startTime="2151">And the more features you get </span><span class="line" data-startTime="2151">rid of, the slower the code's </span><span class="line" data-startTime="2154">going to be. </span></p>

<p><span class="line" data-startTime="2155">So instead of trying to do </span><span class="line" data-startTime="2155">instruction sequences that are </span><span class="line" data-startTime="2158">safer, we actually say, well, </span><span class="line" data-startTime="2158">40 to 44 gigabytes on either </span><span class="line" data-startTime="2164">side of this confined range, </span><span class="line" data-startTime="2164">we're going to mark as &mdash; </span><span class="line" data-startTime="2168">we own it. </span> <span class="line" data-startTime="2169">So you can't use it. </span> <span class="line" data-startTime="2171">So you aren't actually </span><span class="line" data-startTime="2171">allocating the memory. </span> <span class="line" data-startTime="2173">You're just marking it as no one </span><span class="line" data-startTime="2173">gets this memory but us. </span> <span class="line" data-startTime="2177">And it's illegal to read. </span> <span class="line" data-startTime="2179">It's illegal to write. </span> <span class="line" data-startTime="2180">It's illegal to jump to. </span> <span class="line" data-startTime="2181">It doesn't exist. </span> <span class="line" data-startTime="2183">So if you can do a memory access </span><span class="line" data-startTime="2183">which is outside this </span><span class="line" data-startTime="2188">4-gigabyte range, you get caught </span><span class="line" data-startTime="2188">by the guard region. </span> <span class="line" data-startTime="2191">And that's how we allow these </span><span class="line" data-startTime="2191">addressing modes. </span></p>

<p><span class="line" data-startTime="2194">And just as a funny side note, </span><span class="line" data-startTime="2194">sometimes we get people </span><span class="line" data-startTime="2197">benchmarking Native Client </span><span class="line" data-startTime="2197">and say, you take over 80 </span><span class="line" data-startTime="2200">gigabytes of memory! </span><span class="line" data-startTime="2201">And we're like, do you have over </span><span class="line" data-startTime="2201">80 gigabytes of memory? </span><span class="line" data-startTime="2205">But really what they're looking </span><span class="line" data-startTime="2205">at is they're looking </span><span class="line" data-startTime="2206">at address space usage rather </span><span class="line" data-startTime="2206">than actual memory usage. </span> <span class="line" data-startTime="2213">So we can't do anything fun. </span> <span class="line" data-startTime="2216">We can just go inside </span><span class="line" data-startTime="2216">the sandbox. </span> <span class="line" data-startTime="2218">How do we get out? </span><span class="line" data-startTime="2218">How do we actually request the </span><span class="line" data-startTime="2218">URL like I showed in the </span><span class="line" data-startTime="2222">beginning of this </span><span class="line" data-startTime="2222">presentation? </span><span class="line" data-startTime="2224">To do that, at the bottom of </span><span class="line" data-startTime="2224">the sandbox Native Client </span><span class="line" data-startTime="2228">inserts a bit of code called </span><span class="line" data-startTime="2228">the trampoline. </span> <span class="line" data-startTime="2231">Now the trampoline is code that </span><span class="line" data-startTime="2231">would not normally be </span><span class="line" data-startTime="2234">validated, but allows you to do </span><span class="line" data-startTime="2234">a controlled jump outside </span><span class="line" data-startTime="2237">the sandbox. </span></p>

<p><span class="line" data-startTime="2238">So there's a trampoline entry </span><span class="line" data-startTime="2238">for each service we provide, </span><span class="line" data-startTime="2242">such as spawning threads. </span> <span class="line" data-startTime="2243">And when you want that, you </span><span class="line" data-startTime="2243">jump to the trampoline. </span> <span class="line" data-startTime="2245">And the trampoline jumps you out </span><span class="line" data-startTime="2245">into Chrome DLL, where we </span><span class="line" data-startTime="2248">provide an implementation </span><span class="line" data-startTime="2248">for that. </span> <span class="line" data-startTime="2250">So the set of trampoline calls </span><span class="line" data-startTime="2250">you have, which are analogous </span><span class="line" data-startTime="2253">to syscalls, are the same </span><span class="line" data-startTime="2253">on every platform. </span> <span class="line" data-startTime="2255">So in one swoop, we are </span><span class="line" data-startTime="2255">providing a cross-platform API </span><span class="line" data-startTime="2261">and controlling exactly what </span><span class="line" data-startTime="2261">services the native code gets. </span> <span class="line" data-startTime="2267">The trampoline itself, again, </span><span class="line" data-startTime="2267">is small, but in some ways </span><span class="line" data-startTime="2270">overly clever. </span> <span class="line" data-startTime="2272">And we take a constant address, </span><span class="line" data-startTime="2272">stick it in a </span><span class="line" data-startTime="2275">register, and then call </span><span class="line" data-startTime="2275">that address. </span> <span class="line" data-startTime="2280">And there's a few things </span><span class="line" data-startTime="2280">going on here. </span> <span class="line" data-startTime="2282">One is that we do the move into </span><span class="line" data-startTime="2282">the register instead of </span><span class="line" data-startTime="2286">doing a direct call, so that </span><span class="line" data-startTime="2286">it's easier to patch the code </span><span class="line" data-startTime="2290">as we know exactly the address </span><span class="line" data-startTime="2290">we're going to. </span> <span class="line" data-startTime="2292">And in fact, we can make that </span><span class="line" data-startTime="2292">address the same for all the </span><span class="line" data-startTime="2294">trampolines. </span> <span class="line" data-startTime="2295">So if you have multiple </span><span class="line" data-startTime="2295">trampolines going to the same </span><span class="line" data-startTime="2297">place, since direct jumps are </span><span class="line" data-startTime="2297">relative, you'd have to do a </span><span class="line" data-startTime="2301">lot of math and make sure </span><span class="line" data-startTime="2301">that you're jumping </span><span class="line" data-startTime="2302">to the right address. </span></p>

<p><span class="line" data-startTime="2303">But here we just jump to </span><span class="line" data-startTime="2303">a constant address. </span> <span class="line" data-startTime="2305">Another thing is that it's a </span><span class="line" data-startTime="2305">call instead of a jump, so we </span><span class="line" data-startTime="2308">can have a trace of where the </span><span class="line" data-startTime="2308">syscall's coming from. </span> <span class="line" data-startTime="2311">So we know, oh, we're going </span><span class="line" data-startTime="2311">through trampoline 4, </span><span class="line" data-startTime="2313">therefore, we know what </span><span class="line" data-startTime="2313">service we're getting. </span> <span class="line" data-startTime="2316">And then finally at the </span><span class="line" data-startTime="2316">end, there's a halt. </span> <span class="line" data-startTime="2318">So even though we're doing a </span><span class="line" data-startTime="2318">call, we never return to where </span><span class="line" data-startTime="2321">we called from. </span> <span class="line" data-startTime="2322">It's just a method to </span><span class="line" data-startTime="2322">trace the address of </span><span class="line" data-startTime="2324">where we came from. </span> <span class="line" data-startTime="2325">So if anyone returns from inside </span><span class="line" data-startTime="2325">the system code, it's </span><span class="line" data-startTime="2328">going to hit the halt, and it's </span><span class="line" data-startTime="2329">going to prevent execution. </span> <span class="line" data-startTime="2332">This is all interesting because </span><span class="line" data-startTime="2332">it's within 13 bytes. </span> <span class="line" data-startTime="2335">So this means that the </span><span class="line" data-startTime="2335">trampoline fits within the </span><span class="line" data-startTime="2337">32-byte bundle. </span> <span class="line" data-startTime="2340">And this means that indirect </span><span class="line" data-startTime="2340">jumps will never go inside the </span><span class="line" data-startTime="2344">trampoline. </span></p>

<p><span class="line" data-startTime="2344">They can only go to the start </span><span class="line" data-startTime="2344">to the trampoline. </span> <span class="line" data-startTime="2346">And this is what allows us to </span><span class="line" data-startTime="2346">do safe exits outside of the </span><span class="line" data-startTime="2350">NaCl sandbox. </span> <span class="line" data-startTime="2353">So putting it all together, this </span><span class="line" data-startTime="2353">is the API call which I </span><span class="line" data-startTime="2356">started with. </span> <span class="line" data-startTime="2358">It is loading a URL. </span> <span class="line" data-startTime="2359">So to do this, the untrusted </span><span class="line" data-startTime="2359">code initiates it by jumping </span><span class="line" data-startTime="2363">to the trampoline and saying </span><span class="line" data-startTime="2363">I want to do this request. </span> <span class="line" data-startTime="2367">The trampoline takes </span><span class="line" data-startTime="2367">it to Chrome DLL. </span> <span class="line" data-startTime="2369">Chrome DLL has an implementation </span><span class="line" data-startTime="2369">that says, OK, </span><span class="line" data-startTime="2372">native code wants to </span><span class="line" data-startTime="2372">do a URL request. </span></p>

<p><span class="line" data-startTime="2375">Well, I can't do it myself </span><span class="line" data-startTime="2375">because I'm running inside the </span><span class="line" data-startTime="2378">Chrome sandbox. </span> <span class="line" data-startTime="2379">So instead, what I have to do </span><span class="line" data-startTime="2379">is I have to talk to the </span><span class="line" data-startTime="2382">Chrome browser via the </span><span class="line" data-startTime="2382">render process. </span> <span class="line" data-startTime="2384">So to do that, I'm going to need </span><span class="line" data-startTime="2384">to do some inter-process </span><span class="line" data-startTime="2387">communication. </span> <span class="line" data-startTime="2388">So it talks to the operating </span><span class="line" data-startTime="2388">system and says, hey, send </span><span class="line" data-startTime="2390">this bit of the data to the </span><span class="line" data-startTime="2390">renderer process, and then it </span><span class="line" data-startTime="2393">will know what to do with it. </span> <span class="line" data-startTime="2394">And at that point, it's </span><span class="line" data-startTime="2394">out of NaCl's control. </span> <span class="line" data-startTime="2396">It's just however the JavaScript </span><span class="line" data-startTime="2396">call would be. </span> <span class="line" data-startTime="2400">Same paths. </span> <span class="line" data-startTime="2403">That is Native Client </span><span class="line" data-startTime="2403">in a nutshell. </span></p>

<p><span class="line" data-startTime="2405">And I hope you all </span><span class="line" data-startTime="2405">followed that. </span> <span class="line" data-startTime="2407">And we have questions </span><span class="line" data-startTime="2407">afterwards, if you don't. </span> <span class="line" data-startTime="2410">There's more to this. </span> <span class="line" data-startTime="2412">As I mentioned before, dynamic </span><span class="line" data-startTime="2412">code loading in JIT, memory </span><span class="line" data-startTime="2415">consistency, making the </span><span class="line" data-startTime="2415">sandboxing model work is a </span><span class="line" data-startTime="2418">whole other ball of wax. </span> <span class="line" data-startTime="2419">I find it very fascinating. </span> <span class="line" data-startTime="2421">I hope you guys look into it. </span> <span class="line" data-startTime="2423">Portable Native Client. </span> <span class="line" data-startTime="2425">This is the future. </span> <span class="line" data-startTime="2428">Bit code, LLVM tool </span><span class="line" data-startTime="2428">chain, fixes, the </span><span class="line" data-startTime="2430">architecture-specific issues </span><span class="line" data-startTime="2430">we have now, but you </span><span class="line" data-startTime="2433">still can use it. </span> <span class="line" data-startTime="2433">You can write applications </span><span class="line" data-startTime="2433">now and switch to </span><span class="line" data-startTime="2435">PNaCl when it's available. </span> <span class="line" data-startTime="2439">You may have noticed that </span><span class="line" data-startTime="2439">nothing in this presentation </span><span class="line" data-startTime="2441">really has to be inside </span><span class="line" data-startTime="2441">the browser. </span></p>

<p><span class="line" data-startTime="2443">So this is a technical solution, </span><span class="line" data-startTime="2443">the sandboxing, </span><span class="line" data-startTime="2446">software for the isolation. </span> <span class="line" data-startTime="2448">There have been some projects </span><span class="line" data-startTime="2448">to use the same sandboxing </span><span class="line" data-startTime="2451">technology to, for instance, run </span><span class="line" data-startTime="2451">computation in the cloud. </span> <span class="line" data-startTime="2455">Or to just say, you know, </span><span class="line" data-startTime="2455">I don't want to audit </span><span class="line" data-startTime="2457">this piece of code. </span> <span class="line" data-startTime="2458">Well, I'll just throw it in the </span><span class="line" data-startTime="2458">sandbox, and that way, I </span><span class="line" data-startTime="2462">know that the third-party code </span><span class="line" data-startTime="2462">is going to be much more </span><span class="line" data-startTime="2464">contained than it </span><span class="line" data-startTime="2464">would otherwise. </span> <span class="line" data-startTime="2468">Recommended reading. </span></p>

<p><span class="line" data-startTime="2469">So every time we give a NaCl </span><span class="line" data-startTime="2469">talk, we point people to </span><span class="line" data-startTime="2471">gonacl.com. </span> <span class="line" data-startTime="2472">This is a developer-oriented </span><span class="line" data-startTime="2472">site, where you download the </span><span class="line" data-startTime="2476">compiler, the SDK tutorials </span><span class="line" data-startTime="2476">about how to get you started. </span> <span class="line" data-startTime="2480">This talk was a little </span><span class="line" data-startTime="2480">technical, more </span><span class="line" data-startTime="2482">research-based, so we have a </span><span class="line" data-startTime="2482">bunch of research papers, too. </span> <span class="line" data-startTime="2485">I point you towards those. </span> <span class="line" data-startTime="2486">If you Google gonacl or Native </span><span class="line" data-startTime="2486">Client research papers, you'll </span><span class="line" data-startTime="2490">get these URLs. </span> <span class="line" data-startTime="2492">And my favorite one is actually </span><span class="line" data-startTime="2492">"A Tale of Two </span><span class="line" data-startTime="2494">Pwnies." So every year </span><span class="line" data-startTime="2494">or so, there's a </span><span class="line" data-startTime="2497">browser security contest. </span> <span class="line" data-startTime="2499">And this year, Chrome </span><span class="line" data-startTime="2499">had two exploits. </span> <span class="line" data-startTime="2503">One of them actually touched </span><span class="line" data-startTime="2503">NaCl but did not break it. </span></p>

<p><span class="line" data-startTime="2506">So they used NaCl as </span><span class="line" data-startTime="2506">an attack platform </span><span class="line" data-startTime="2508">to hit the GPU process. </span> <span class="line" data-startTime="2509">And I myself actually learned </span><span class="line" data-startTime="2509">a lot from reading this. </span> <span class="line" data-startTime="2512">And it's really eye-opening to </span><span class="line" data-startTime="2512">see how many layers and levels </span><span class="line" data-startTime="2515">you have to get through to </span><span class="line" data-startTime="2515">do a modern exploit. </span> <span class="line" data-startTime="2518">The one that involved </span><span class="line" data-startTime="2518">NaCl was six. </span> <span class="line" data-startTime="2520">The other one was 10 because </span><span class="line" data-startTime="2520">they had to chain that many </span><span class="line" data-startTime="2523">different vulnerabilities </span><span class="line" data-startTime="2523">together to </span><span class="line" data-startTime="2524">actually get an exploit. </span> <span class="line" data-startTime="2526">So security, very interesting </span><span class="line" data-startTime="2526">field. </span> <span class="line" data-startTime="2528">I strongly suggest you </span><span class="line" data-startTime="2528">read that paper. </span> <span class="line" data-startTime="2533">Now the fun part. </span> <span class="line" data-startTime="2534">Questions. </span></p>

<p><span class="line" data-startTime="2535">[APPLAUSE] </span></p>

<p class="speaker"><span class="line" data-starttime="2548"><span class="speakerName">Audience</span>: Thanks for </span><span class="line" data-startTime="2548">the presentation. </span></p>

<p class="speaker"><span class="line" data-starttime="2549"><span class="speakerName">Nick Bray</span>: My pleasure. </span></p>

<p class="speaker"><span class="line" data-starttime="2550"><span class="speakerName">Audience</span>: Out of all of I/O, </span><span class="line" data-startTime="2550">it's probably the most </span><span class="line" data-startTime="2552">interesting, funnest one that </span><span class="line" data-startTime="2552">I've ever been to, so that was </span><span class="line" data-startTime="2554">really cool. </span><span class="line" data-startTime="2555">I've known NaCl for about </span><span class="line" data-startTime="2555">an hour and a half. </span><span class="line" data-startTime="2558">I was wondering, does it matter </span><span class="line" data-startTime="2558">what version of CIUs? </span><span class="line" data-startTime="2561">Does NaCl care whether </span><span class="line" data-startTime="2561">it's C99 or C90? </span></p>

<p class="speaker"><span class="line" data-starttime="2568"><span class="speakerName">Nick Bray</span>: It doesn't even </span><span class="line" data-startTime="2568">matter if you use a </span><span class="line" data-startTime="2569">C-compiler. </span><span class="line" data-startTime="2571">So you can actually hand-write </span><span class="line" data-startTime="2571">NaCl code, and it'll run. </span><span class="line" data-startTime="2574">But we provide compilers that </span><span class="line" data-startTime="2574">generate code that's </span><span class="line" data-startTime="2577">compatible. </span><span class="line" data-startTime="2578">So I think our version </span><span class="line" data-startTime="2578">of GCC supports C99. </span><span class="line" data-startTime="2582">Do you know? </span><span class="line" data-startTime="2584">Yeah, I think, so </span><span class="line" data-startTime="2584">you can use C99. </span><span class="line" data-startTime="2586">It's whatever GCC supports, </span><span class="line" data-startTime="2586">really. </span></p>

<p class="speaker"><span class="line" data-starttime="2589"><span class="speakerName">Audience</span>: The one question </span><span class="line" data-startTime="2589">I had was about </span><span class="line" data-startTime="2590">the indirect jumps. </span><span class="line" data-startTime="2591">And it sounds like you are </span><span class="line" data-startTime="2591">relying on the compiler to put </span><span class="line" data-startTime="2595">everything on 32-bit </span><span class="line" data-startTime="2595">boundaries. </span><span class="line" data-startTime="2598">That seems to me like the </span><span class="line" data-startTime="2598">only position where </span><span class="line" data-startTime="2600">a handwritten exploit &mdash; </span><span class="line" data-startTime="2601">I mean, you were assuming that </span><span class="line" data-startTime="2601">all the code coming in would </span><span class="line" data-startTime="2605">allow jumps to 32-byte </span><span class="line" data-startTime="2605">boundaries. </span><span class="line" data-startTime="2607">But if I were to hand-write some </span><span class="line" data-startTime="2607">asm that a jump into a </span><span class="line" data-startTime="2610">32-bit boundary was a actually </span><span class="line" data-startTime="2610">a bad execution, how do you </span><span class="line" data-startTime="2612">manage that? </span></p>

<p class="speaker"><span class="line" data-starttime="2614"><span class="speakerName">Nick Bray</span>: Validation. </span><span class="line" data-startTime="2615">So while we're going through </span><span class="line" data-startTime="2615">looking at what the </span><span class="line" data-startTime="2618">instructions are, we record </span><span class="line" data-startTime="2618">where they are, too. </span><span class="line" data-startTime="2621">So internally, you can think </span><span class="line" data-startTime="2621">that we have a bit factor, </span><span class="line" data-startTime="2625">which contains a bit </span><span class="line" data-startTime="2625">for each byte. </span><span class="line" data-startTime="2627">And every time we see an </span><span class="line" data-startTime="2627">instruction start, we say, </span><span class="line" data-startTime="2629">boom, there's a bit. </span><span class="line" data-startTime="2631">So whenever we have a </span><span class="line" data-startTime="2631">direct jump we say, </span><span class="line" data-startTime="2633">is the bit set there? </span><span class="line" data-startTime="2634">We actually have to do this </span><span class="line" data-startTime="2634">after we see all the </span><span class="line" data-startTime="2636">instructions. </span><span class="line" data-startTime="2637">But in the final thing, we go, </span><span class="line" data-startTime="2637">OK, here's all the jump </span><span class="line" data-startTime="2639">targets, here's all the </span><span class="line" data-startTime="2639">instructions, starts &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="2642"><span class="speakerName">Audience</span>: But what about </span><span class="line" data-startTime="2642">the indirect </span><span class="line" data-startTime="2642">jumps into the 32 byte &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="2645"><span class="speakerName">Nick Bray</span>: We do that </span><span class="line" data-startTime="2645">on the fly. </span><span class="line" data-startTime="2646">So you say, OK, while I'm </span><span class="line" data-startTime="2646">parsing this instruction, I </span><span class="line" data-startTime="2650">notice that it's overlapping </span><span class="line" data-startTime="2650">the 32-byte boundary. </span><span class="line" data-startTime="2652">Boom, that's bad. </span></p>

<p class="speaker"><span class="line" data-starttime="2653"><span class="speakerName">Audience</span>: OK. </span><span class="line" data-startTime="2654">So you also make sure that all </span><span class="line" data-startTime="2654">32-byte boundary instructions, </span><span class="line" data-startTime="2658">whatever is at a 32-byte </span><span class="line" data-startTime="2658">boundary is also safe. </span></p>

<p class="speaker"><span class="line" data-starttime="2660"><span class="speakerName">Nick Bray</span>: Yes. </span></p>

<p class="speaker"><span class="line" data-starttime="2663"><span class="speakerName">Audience</span>: So it looks like </span><span class="line" data-startTime="2663">you're creating a 4-gig memory </span><span class="line" data-startTime="2666">limit again. </span><span class="line" data-startTime="2666">Didn't we just get </span><span class="line" data-startTime="2666">rid of that? </span></p>

<p class="speaker"><span class="line" data-starttime="2670"><span class="speakerName">Nick Bray</span>: It depends on </span><span class="line" data-startTime="2670">how you look at it. </span> <span class="line" data-startTime="2673">So there's all sorts </span><span class="line" data-startTime="2673">of devices. </span> <span class="line" data-startTime="2675">But what you're really saying </span><span class="line" data-startTime="2675">is, can I get more </span><span class="line" data-startTime="2677">than 4 gigs of memory? </span><span class="line" data-startTime="2679">And the answer is we could </span><span class="line" data-startTime="2679">change the sandboxing model, </span><span class="line" data-startTime="2682">but there would be performance </span><span class="line" data-startTime="2682">implications. </span> <span class="line" data-startTime="2684">So a lot of the clever things </span><span class="line" data-startTime="2684">we were doing with dropping </span><span class="line" data-startTime="2687">the upper 32 bits, suddenly </span><span class="line" data-startTime="2687">you're carting </span><span class="line" data-startTime="2689">around 8-byte constants. </span> <span class="line" data-startTime="2692">And that's a generally </span><span class="line" data-startTime="2692">bad thing. </span> <span class="line" data-startTime="2694">So has it been a problem? </span><span class="line" data-startTime="2696">And the answer is, we haven't </span><span class="line" data-startTime="2696">really had any developers </span><span class="line" data-startTime="2698">complain about it. </span></p>

<p><span class="line" data-startTime="2700">We've been living under the </span><span class="line" data-startTime="2700">4-gig limit so long, that it's </span><span class="line" data-startTime="2703">not been an issue. </span> <span class="line" data-startTime="2704">Plus do you really want an </span><span class="line" data-startTime="2704">application in your web </span><span class="line" data-startTime="2707">browser consuming that </span><span class="line" data-startTime="2707">much memory? </span><span class="line" data-startTime="2709">Eh, most the time, not. </span> <span class="line" data-startTime="2710">There are some applications </span><span class="line" data-startTime="2710">that you write that </span><span class="line" data-startTime="2711">you may want to. </span></p>

<p class="speaker"><span class="line" data-starttime="2712"><span class="speakerName">Audience</span>: In five years, </span><span class="line" data-startTime="2712">certainly? </span></p>

<p class="speaker"><span class="line" data-starttime="2714"><span class="speakerName">Nick Bray</span>: Yeah. </span><span class="line" data-startTime="2715">So sandboxing models </span><span class="line" data-startTime="2715">are flexible. </span><span class="line" data-startTime="2718">And once we get PNaCl running, </span><span class="line" data-startTime="2718">we can take another look at </span><span class="line" data-startTime="2721">generating a new sandboxing </span><span class="line" data-startTime="2721">model or </span><span class="line" data-startTime="2723">something along those lines. </span></p>

<p class="speaker"><span class="line" data-starttime="2726"><span class="speakerName">Audience</span>: Kind of a </span><span class="line" data-startTime="2726">related question. </span><span class="line" data-startTime="2728">You, at the beginning, showed </span><span class="line" data-startTime="2728">x64, x86, and ARM. </span><span class="line" data-startTime="2734">On x86, you obviously can't </span><span class="line" data-startTime="2734">do the same kind of jump </span><span class="line" data-startTime="2737">constraint because you are &mdash; </span><span class="line" data-startTime="2740">if you're on 32-bit x86, </span><span class="line" data-startTime="2740">you're then limited. </span><span class="line" data-startTime="2744">You're going to reduce your </span><span class="line" data-startTime="2744">memory space by far more and </span><span class="line" data-startTime="2747">lose a very precious register. </span></p>

<p class="speaker"><span class="line" data-starttime="2749"><span class="speakerName">Nick Bray</span>: One gig. </span><span class="line" data-startTime="2751">And you don't lose precious </span><span class="line" data-startTime="2751">registers. </span><span class="line" data-startTime="2753">We do something very perverse </span><span class="line" data-startTime="2753">on 32-bit Intel. </span><span class="line" data-startTime="2757">We use segment registers. </span><span class="line" data-startTime="2759">So we're bringing back all </span><span class="line" data-startTime="2759">these things that you </span><span class="line" data-startTime="2761">thought were dead. </span></p>

<p class="speaker"><span class="line" data-starttime="2761"><span class="speakerName">Audience</span>: Awesome. </span></p>

<p class="speaker"><span class="line" data-starttime="2763"><span class="speakerName">Nick Bray</span>: So, for those of you </span><span class="line" data-startTime="2763">who don't know, segment </span><span class="line" data-startTime="2765">registers say this is the range </span><span class="line" data-startTime="2765">of memory you can use. </span><span class="line" data-startTime="2768">So we say, OK, 256 megs for </span><span class="line" data-startTime="2768">code, 1 gig for data. </span><span class="line" data-startTime="2773">If you jump outside </span><span class="line" data-startTime="2773">this, boom. </span><span class="line" data-startTime="2776">And then we say you can't change </span><span class="line" data-startTime="2776">the segment registers </span><span class="line" data-startTime="2779">while you're running. </span><span class="line" data-startTime="2780">This has a few weird </span><span class="line" data-startTime="2780">implications, like most people </span><span class="line" data-startTime="2782">thought they were dead. </span><span class="line" data-startTime="2783">So the Intel atom processor </span><span class="line" data-startTime="2783">for instance, they didn't </span><span class="line" data-startTime="2787">spend so much time supporting </span><span class="line" data-startTime="2787">segment registers. </span><span class="line" data-startTime="2788">They do lip service, but then </span><span class="line" data-startTime="2788">when you actually use them in </span><span class="line" data-startTime="2791">nonstandard ways, it </span><span class="line" data-startTime="2791">slows down a lot. </span></p>

<p class="speaker"><span class="line" data-starttime="2794"><span class="speakerName">Audience</span>: Thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="2796"><span class="speakerName">Audience</span>: Hi. </span> <span class="line" data-startTime="2797">It's a great project. </span> <span class="line" data-startTime="2798">I love it. </span> <span class="line" data-startTime="2800">It is very perverse though, in </span><span class="line" data-startTime="2800">some ways, as you're going </span><span class="line" data-startTime="2803">through all of these things. </span> <span class="line" data-startTime="2805">I was just wondering, with the </span><span class="line" data-startTime="2805">LLVM thing that you're going </span><span class="line" data-startTime="2811">to be doing, does it get easier </span><span class="line" data-startTime="2811">now that you control </span><span class="line" data-startTime="2814">the instruction set? </span><span class="line" data-startTime="2815">I mean, can you somehow do </span><span class="line" data-startTime="2815">something to make this whole </span><span class="line" data-startTime="2818">process simpler? </span></p>

<p class="speaker"><span class="line" data-starttime="2820"><span class="speakerName">Nick Bray</span>: Define the "whole </span><span class="line" data-startTime="2820">process simpler." </span></p>

<p class="speaker"><span class="line" data-starttime="2822"><span class="speakerName">Audience</span>: The verification </span><span class="line" data-startTime="2822">process. </span><span class="line" data-startTime="2824">I mean, since you control the </span><span class="line" data-startTime="2824">intermediate format, is there </span><span class="line" data-startTime="2829">some way to &mdash; </span><span class="line" data-startTime="2832">will it become simpler when </span><span class="line" data-startTime="2832">you get to the LLVM model? </span></p>

<p class="speaker"><span class="line" data-starttime="2836"><span class="speakerName">Nick Bray</span>: The big problem </span><span class="line" data-startTime="2836">is that we </span><span class="line" data-startTime="2837">can't trust the compiler. </span> <span class="line" data-startTime="2839">So we can't audit it. </span> <span class="line" data-startTime="2841">We can't verify that it's &mdash; </span><span class="line" data-startTime="2843">you know, it should generate </span><span class="line" data-startTime="2843">the code we want. </span> <span class="line" data-startTime="2845">But at the end of the day, what </span><span class="line" data-startTime="2845">we do is, we have to have </span><span class="line" data-startTime="2847">validation be the last </span><span class="line" data-startTime="2847">line of defense. </span> <span class="line" data-startTime="2849">So if the code doesn't look </span><span class="line" data-startTime="2849">safe, we don't run it. </span> <span class="line" data-startTime="2852">And we make no assumptions </span><span class="line" data-startTime="2852">about its providence. </span> <span class="line" data-startTime="2856">So what LLVM would allow us to </span><span class="line" data-startTime="2856">do is do more creative things. </span> <span class="line" data-startTime="2862">Right now, the binary that's </span><span class="line" data-startTime="2862">shipped across the wire is </span><span class="line" data-startTime="2864">something that we've stabilized </span><span class="line" data-startTime="2864">and we said this is </span><span class="line" data-startTime="2866">what we're going to support. </span></p>

<p><span class="line" data-startTime="2868">Once we start supporting bit </span><span class="line" data-startTime="2868">code, then we can generate </span><span class="line" data-startTime="2870">other sandboxing models. </span> <span class="line" data-startTime="2872">We can generate other </span><span class="line" data-startTime="2872">interesting low-level things. </span> <span class="line" data-startTime="2874">And it decouples us and gives </span><span class="line" data-startTime="2874">us a lot of flexibility. </span> <span class="line" data-startTime="2877">But at the bottom level, there's </span><span class="line" data-startTime="2877">going to have to be </span><span class="line" data-startTime="2880">some algorithm that goes through </span><span class="line" data-startTime="2880">and says does this </span><span class="line" data-startTime="2883">native code look right? </span><span class="line" data-startTime="2884">And if it doesn't, </span><span class="line" data-startTime="2884">out of there. </span> <span class="line" data-startTime="2886">And once LLVM's in </span><span class="line" data-startTime="2886">the picture, it </span><span class="line" data-startTime="2888">should always look right. </span> <span class="line" data-startTime="2890">But we are going to </span><span class="line" data-startTime="2890">bank on that. </span></p>

<p><span class="line" data-startTime="2891">We're going to always </span><span class="line" data-startTime="2891">have the last line. </span></p>

<p class="speaker"><span class="line" data-starttime="2892"><span class="speakerName">Audience</span>: Will the bit code be </span><span class="line" data-startTime="2892">actual LLVM byte code, or will </span><span class="line" data-startTime="2895">you have something of </span><span class="line" data-startTime="2895">your own nature? </span></p>

<p class="speaker"><span class="line" data-starttime="2899"><span class="speakerName">Nick Bray</span>: I think the plan </span><span class="line" data-startTime="2899">is actual LLVM byte code. </span></p>

<p class="speaker"><span class="line" data-starttime="2905"><span class="speakerName">Audience</span>: That was actually very </span><span class="line" data-startTime="2905">similar to the question I </span><span class="line" data-startTime="2908">was going to ask. </span><span class="line" data-startTime="2909">When you're going through the </span><span class="line" data-startTime="2909">initial design for NaCl, why </span><span class="line" data-startTime="2912">did you choose native code </span><span class="line" data-startTime="2912">versus LLVM or comparing it to </span><span class="line" data-startTime="2918">the JVMs and what they do? </span></p>

<p class="speaker"><span class="line" data-starttime="2920"><span class="speakerName">Nick Bray</span>: Why choose </span><span class="line" data-startTime="2920">native code instead </span><span class="line" data-startTime="2922">of everything else? </span></p>

<p class="speaker"><span class="line" data-starttime="2925"><span class="speakerName">Audience</span>: Was it to have a </span><span class="line" data-startTime="2925">simpler just run- time </span><span class="line" data-startTime="2928">environment, not have to </span><span class="line" data-startTime="2928">have an actual JIT? </span></p>

<p class="speaker"><span class="line" data-starttime="2931"><span class="speakerName">Nick Bray</span>: Yep. </span> <span class="line" data-startTime="2934">Part of the view was </span><span class="line" data-startTime="2934">compatibility, because we have </span><span class="line" data-startTime="2937">a lot of infrastructure </span><span class="line" data-startTime="2937">for native code. </span> <span class="line" data-startTime="2939">So if we're just running native </span><span class="line" data-startTime="2939">code, a lot of that </span><span class="line" data-startTime="2942">should be analogous, fairly </span><span class="line" data-startTime="2942">straightforward. </span> <span class="line" data-startTime="2946">Less overhead. </span> <span class="line" data-startTime="2947">You can access certain </span><span class="line" data-startTime="2947">intrinsic </span><span class="line" data-startTime="2949">instructions directly. </span> <span class="line" data-startTime="2951">You can do threads. </span> <span class="line" data-startTime="2952">You don't have to solve </span><span class="line" data-startTime="2952">all these ugly </span><span class="line" data-startTime="2955">issues at the VM level. </span> <span class="line" data-startTime="2956">Instead, you can just validate </span><span class="line" data-startTime="2956">it and let it rip instead of </span><span class="line" data-startTime="2960">trying to have a larger surface </span><span class="line" data-startTime="2960">area, which you are </span><span class="line" data-startTime="2962">trying to prove is safe. </span></p>

<p><span class="line" data-startTime="2965">Part of it was also </span><span class="line" data-startTime="2965">a technical issue. </span> <span class="line" data-startTime="2968">We realized, hey, </span><span class="line" data-startTime="2968">we CAN do this. </span> <span class="line" data-startTime="2970">So how can we bring </span><span class="line" data-startTime="2970">it to the web? </span><span class="line" data-startTime="2972">So we finally realized </span><span class="line" data-startTime="2972">native code </span><span class="line" data-startTime="2974">doesn't have to be unsafe. </span> <span class="line" data-startTime="2976">And what are the </span><span class="line" data-startTime="2976">opportunities? </span><span class="line" data-startTime="2978">So we've been seeing </span><span class="line" data-startTime="2978">a lot of people </span><span class="line" data-startTime="2979">port games, for instance. </span> <span class="line" data-startTime="2980">And when you spend how many </span><span class="line" data-startTime="2980">years writing native code, and </span><span class="line" data-startTime="2983">you want to port it, well, you </span><span class="line" data-startTime="2983">don't want to jump through too </span><span class="line" data-startTime="2986">many hoops. </span> <span class="line" data-startTime="2987">You can try to do weird cross </span><span class="line" data-startTime="2987">compiles into JavaScript VMs, </span><span class="line" data-startTime="2991">but, it works some </span><span class="line" data-startTime="2991">of the time. </span> <span class="line" data-startTime="2994">Instead, why don't you just run </span><span class="line" data-startTime="2994">the native code, and call </span><span class="line" data-startTime="2997">the browser instead of the OS. </span></p>

<p><span class="line" data-startTime="2999">That's the general philosophy, </span><span class="line" data-startTime="2999">is trying to keep the surface </span><span class="line" data-startTime="3001">area small and trying to make </span><span class="line" data-startTime="3001">it as close to other native </span><span class="line" data-startTime="3005">code development as possible. </span></p>

<p class="speaker"><span class="line" data-starttime="3007"><span class="speakerName">Audience</span>: Cool. </span><span class="line" data-startTime="3008">Thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="3009"><span class="speakerName">Audience</span>: I've got </span><span class="line" data-startTime="3009">two questions. </span><span class="line" data-startTime="3010">I think they're both small. </span><span class="line" data-startTime="3012">Trampolines got me thinking. </span><span class="line" data-startTime="3014">Do you have any dev tools that </span><span class="line" data-startTime="3014">would de-bug what's going on, </span><span class="line" data-startTime="3017">so that you can see in the </span><span class="line" data-startTime="3017">inspector that, OK, it's </span><span class="line" data-startTime="3020">making it HTTP requests </span><span class="line" data-startTime="3020">and so on? </span></p>

<p class="speaker"><span class="line" data-starttime="3023"><span class="speakerName">Nick Bray</span>: De-buggers are </span><span class="line" data-startTime="3023">something we're working on. </span><span class="line" data-startTime="3025">They're harder than </span><span class="line" data-startTime="3025">you'd expect. </span><span class="line" data-startTime="3027">Because they've made many silly </span><span class="line" data-startTime="3027">assumptions that native </span><span class="line" data-startTime="3030">code just happens to work the </span><span class="line" data-startTime="3030">way native code does. </span><span class="line" data-startTime="3033">So the moment we start adding </span><span class="line" data-startTime="3033">this R15 register to offset </span><span class="line" data-startTime="3036">everything, there's been a lot </span><span class="line" data-startTime="3036">of work to try to get the </span><span class="line" data-startTime="3039">de-buggers to get all </span><span class="line" data-startTime="3039">the right symbols. </span></p>

<p class="speaker"><span class="line" data-starttime="3040"><span class="speakerName">Audience</span>: I'm thinking on a much </span><span class="line" data-startTime="3040">higher level actually. </span><span class="line" data-startTime="3042">If you're coming as a web </span><span class="line" data-startTime="3042">developer looking at things in </span><span class="line" data-startTime="3045">the inspector, what's going </span><span class="line" data-startTime="3045">on in this web page? </span><span class="line" data-startTime="3047">What is it doing? </span><span class="line" data-startTime="3049">Can I see what stuff is it </span><span class="line" data-startTime="3049">requesting on the web? </span></p>

<p class="speaker"><span class="line" data-starttime="3053"><span class="speakerName">Nick Bray</span>: At the moment, </span><span class="line" data-startTime="3053">half and half. </span><span class="line" data-startTime="3056">So whenever you're doing </span><span class="line" data-startTime="3056">a Pepper call, that </span><span class="line" data-startTime="3059">usually gets traced. </span><span class="line" data-startTime="3060">So every time you see a URL </span><span class="line" data-startTime="3060">load, Chrome has the console </span><span class="line" data-startTime="3065">of all network activity. </span><span class="line" data-startTime="3066">And it will get logged </span><span class="line" data-startTime="3066">in that. </span><span class="line" data-startTime="3068">So you're mediating through </span><span class="line" data-startTime="3068">the browser, so all the </span><span class="line" data-startTime="3070">instrumentation the </span><span class="line" data-startTime="3070">browser has. </span><span class="line" data-startTime="3071">What's actually going on inside </span><span class="line" data-startTime="3071">the native process is a </span><span class="line" data-startTime="3074">little more opaque than I'd </span><span class="line" data-startTime="3074">like at this point. </span><span class="line" data-startTime="3076">And we're thinking about ways </span><span class="line" data-startTime="3076">to expose health and metrics </span><span class="line" data-startTime="3079">and pull that out </span><span class="line" data-startTime="3079">of the process. </span></p>

<p class="speaker"><span class="line" data-starttime="3081"><span class="speakerName">Audience</span>: That's awesome. </span><span class="line" data-startTime="3082">The second question is, so </span><span class="line" data-startTime="3082">you're defending against all </span><span class="line" data-startTime="3085">these things that are unsafe </span><span class="line" data-startTime="3085">from the system's perspective. </span><span class="line" data-startTime="3088">But are you having any checks </span><span class="line" data-startTime="3088">and bounds on stuff that's </span><span class="line" data-startTime="3092">causing infinite loops that </span><span class="line" data-startTime="3092">just eat the CPU? </span><span class="line" data-startTime="3095">That kind of stuff. </span></p>

<p class="speaker"><span class="line" data-starttime="3096"><span class="speakerName">Nick Bray</span>: Nope. </span></p>

<p class="speaker"><span class="line" data-starttime="3096"><span class="speakerName">Audience</span>: OK. </span><span class="line" data-startTime="3099">Thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="3101"><span class="speakerName">Audience</span>: This is similar to </span><span class="line" data-startTime="3101">the question before last. </span><span class="line" data-startTime="3103">Once you move into the LLVM </span><span class="line" data-startTime="3103">world and you're sending </span><span class="line" data-startTime="3107">basically Virtual Machine </span><span class="line" data-startTime="3107">instructions and calling a </span><span class="line" data-startTime="3110">limited API, how would you say </span><span class="line" data-startTime="3110">that PNaCl would compare to </span><span class="line" data-startTime="3114">Java or dot-net? </span></p>

<p class="speaker"><span class="line" data-starttime="3118"><span class="speakerName">Nick Bray</span>: One thing about LLVM </span><span class="line" data-startTime="3118">is it's a bit misnamed. </span><span class="line" data-startTime="3122">So the Virtual Machine </span><span class="line" data-startTime="3122">name came </span><span class="line" data-startTime="3125">earlier in its life cycle. </span><span class="line" data-startTime="3127">And it's more a compiler </span><span class="line" data-startTime="3127">IR than it is, </span><span class="line" data-startTime="3130">strictly speaking, a VM. </span><span class="line" data-startTime="3132">There's some </span><span class="line" data-startTime="3132">architecture-specific things </span><span class="line" data-startTime="3133">that have got leaked into it, </span><span class="line" data-startTime="3133">which have had to be hammered </span><span class="line" data-startTime="3136">out in order to use it as </span><span class="line" data-startTime="3136">an interchange format. </span><span class="line" data-startTime="3139">So how would byte code </span><span class="line" data-startTime="3139">compare against VMs? </span><span class="line" data-startTime="3146">It's an interesting question. </span><span class="line" data-startTime="3148">I think the only real answer </span><span class="line" data-startTime="3148">I would add to </span><span class="line" data-startTime="3150">that is surface area. </span><span class="line" data-startTime="3152">Securing a VM is going to be </span><span class="line" data-startTime="3152">much harder than validating </span><span class="line" data-startTime="3156">native code and just use </span><span class="line" data-startTime="3156">the model that's there. </span><span class="line" data-startTime="3158">And the VM will likely be </span><span class="line" data-startTime="3158">slower, give or take </span><span class="line" data-startTime="3161">just-in-time compilers, </span><span class="line" data-startTime="3161">how well those do. </span></p>

<p class="speaker"><span class="line" data-starttime="3165"><span class="speakerName">Audience</span>: So does the validator </span><span class="line" data-startTime="3165">in PNaCl work on </span><span class="line" data-startTime="3169">native code still? </span><span class="line" data-startTime="3170">Or is it still validating </span><span class="line" data-startTime="3170">LLVM code? </span></p>

<p class="speaker"><span class="line" data-starttime="3173"><span class="speakerName">Nick Bray</span>: We validate all </span><span class="line" data-startTime="3173">native code before we run it. </span><span class="line" data-startTime="3176">So PNaCl you can think of as </span><span class="line" data-startTime="3176">largely a translator, which is </span><span class="line" data-startTime="3180">I'm going to take this bit </span><span class="line" data-startTime="3180">code, then turn it into </span><span class="line" data-startTime="3182">machine code. </span><span class="line" data-startTime="3184">And then we pass it off </span><span class="line" data-startTime="3184">to the validator. </span><span class="line" data-startTime="3185">The validator says, OK, you </span><span class="line" data-startTime="3185">did your job right. </span><span class="line" data-startTime="3188">You're good to go. </span></p>

<p class="speaker"><span class="line" data-starttime="3190"><span class="speakerName">Audience</span>: Thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="3197"><span class="speakerName">Audience</span>: Have you done any </span><span class="line" data-startTime="3197">benchmarking on the difference </span><span class="line" data-startTime="3199">between the unmodified code </span><span class="line" data-startTime="3199">that you do, like adding </span><span class="line" data-startTime="3204">padding and replacing things </span><span class="line" data-startTime="3204">with pseudo-instructions, </span><span class="line" data-startTime="3207">versus the modified version? </span></p>

<p class="speaker"><span class="line" data-starttime="3210"><span class="speakerName">Nick Bray</span>: Yes. </span></p>

<p class="speaker"><span class="line" data-starttime="3211"><span class="speakerName">Audience</span>: And what </span><span class="line" data-startTime="3211">are the results? </span></p>

<p class="speaker"><span class="line" data-starttime="3214"><span class="speakerName">Nick Bray</span>: It depends. </span> <span class="line" data-startTime="3215">Also, one of these </span><span class="line" data-startTime="3215">horrible answers. </span> <span class="line" data-startTime="3217">I'm not trying to weasel </span><span class="line" data-startTime="3217">out, but the </span><span class="line" data-startTime="3218">truth is, it does depend. </span> <span class="line" data-startTime="3220">So if you're doing a numerical </span><span class="line" data-startTime="3220">application, for instance, </span><span class="line" data-startTime="3223">you're not going to have </span><span class="line" data-startTime="3223">a lot of jumps. </span> <span class="line" data-startTime="3226">You're not going to have </span><span class="line" data-startTime="3226">a lot of calls. </span> <span class="line" data-startTime="3227">So you can usually rip through </span><span class="line" data-startTime="3227">those instructions. </span> <span class="line" data-startTime="3229">But certain benchmarks which are </span><span class="line" data-startTime="3229">doing indirect jumps all </span><span class="line" data-startTime="3231">over the place, you're going </span><span class="line" data-startTime="3231">to get no-op padding. </span> <span class="line" data-startTime="3235">You're going to get a bunch </span><span class="line" data-startTime="3235">of guard instructions. </span> <span class="line" data-startTime="3237">And on 32-bit, because we're </span><span class="line" data-startTime="3237">using segment registers, it's </span><span class="line" data-startTime="3240">actually more efficient. </span> <span class="line" data-startTime="3241">So I think on 32-bit, it's like </span><span class="line" data-startTime="3241">10 20% slowdown compared </span><span class="line" data-startTime="3246">to full native speed. </span></p>

<p><span class="line" data-startTime="3247">On 64-bit, our guard sequences </span><span class="line" data-startTime="3247">are a little more complex. </span> <span class="line" data-startTime="3251">They take up more bytes, </span><span class="line" data-startTime="3251">a few more </span><span class="line" data-startTime="3253">instructions here and there. </span> <span class="line" data-startTime="3254">And I'm not exactly sure what </span><span class="line" data-startTime="3254">the benchmarks are. </span> <span class="line" data-startTime="3257">Again, I say rule of thumb, </span><span class="line" data-startTime="3257">20%, although on some </span><span class="line" data-startTime="3261">degenerate benchmarks, it's down </span><span class="line" data-startTime="3261">40, 50% just because of </span><span class="line" data-startTime="3265">the way the code works out. </span> <span class="line" data-startTime="3267">Again, the answer is that, no </span><span class="line" data-startTime="3267">one's complained yet either. </span> <span class="line" data-startTime="3270">So it works as intended. </span></p>

<p class="speaker"><span class="line" data-starttime="3272"><span class="speakerName">Audience</span>: Thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="3277"><span class="speakerName">Audience</span>: Another </span><span class="line" data-startTime="3277">PNaCl question. </span><span class="line" data-startTime="3279">Since you're going to have </span><span class="line" data-startTime="3279">LLVM living in PNaCl to </span><span class="line" data-startTime="3285">generate the instructions, you </span><span class="line" data-startTime="3285">mentioned earlier that you can </span><span class="line" data-startTime="3288">still do JITs in </span><span class="line" data-startTime="3288">Native Client. </span><span class="line" data-startTime="3292">I'm thinking about some ways </span><span class="line" data-startTime="3292">in which you could do that. </span><span class="line" data-startTime="3295">Are you going to expose </span><span class="line" data-startTime="3295">the LLVM translator to </span><span class="line" data-startTime="3300">applications so they can just </span><span class="line" data-startTime="3300">use that instead of having </span><span class="line" data-startTime="3303">another copy of LLVM inside </span><span class="line" data-startTime="3303">to do JIT-ing? </span></p>

<p class="speaker"><span class="line" data-starttime="3306"><span class="speakerName">Nick Bray</span>: Interesting </span><span class="line" data-startTime="3306">question. </span><span class="line" data-startTime="3307">Very interesting question that </span><span class="line" data-startTime="3307">I can't answer, because I'm </span><span class="line" data-startTime="3309">not working on the </span><span class="line" data-startTime="3309">PNaCl project. </span><span class="line" data-startTime="3311">So what they're working </span><span class="line" data-startTime="3311">on there. </span><span class="line" data-startTime="3312">But you can imagine all the </span><span class="line" data-startTime="3312">complexities of, well, since </span><span class="line" data-startTime="3315">we can't trust the translator, </span><span class="line" data-startTime="3315">how do we fit it in so we can </span><span class="line" data-startTime="3318">run it in an untrusted </span><span class="line" data-startTime="3318">capacity. </span><span class="line" data-startTime="3320">So one neat thing I didn't </span><span class="line" data-startTime="3320">mention is that the actual </span><span class="line" data-startTime="3324">ahead-of-time time translator </span><span class="line" data-startTime="3324">is implemented inside of </span><span class="line" data-startTime="3327">Native Client. </span><span class="line" data-startTime="3329">So we have the LLVM compiler </span><span class="line" data-startTime="3329">running inside the Native </span><span class="line" data-startTime="3331">Client sandbox to produce code </span><span class="line" data-startTime="3331">that then we run inside the </span><span class="line" data-startTime="3335">Native Client sandbox. </span></p>

<p class="speaker"><span class="line" data-starttime="3338"><span class="speakerName">Audience</span>: Thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="3346"><span class="speakerName">Nick Bray</span>: Standard technique </span><span class="line" data-startTime="3346">for presentations is wait a </span><span class="line" data-startTime="3348">few seconds. </span><span class="line" data-startTime="3349">Usually someone gets </span><span class="line" data-startTime="3349">uncomfortable, stands up, and </span><span class="line" data-startTime="3352">ask another question. </span><span class="line" data-startTime="3354">If that doesn't work, then you </span><span class="line" data-startTime="3354">say, OK, thanks for coming. </span></p></div>