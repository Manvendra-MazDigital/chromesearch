<p class="speaker"><span class="line" data-starttime="0"><span class="speakerName">Wan-Teh</span>: My name is </span><span class="line" data-startTime="0">Wan-Teh Chang. </span> <span class="line" data-startTime="2">I'm going to talk about </span><span class="line" data-startTime="2">the network stack in Chromium. </span> <span class="line" data-startTime="5">A few minutes ago I sent </span><span class="line" data-startTime="5">the URL for the slides </span><span class="line" data-startTime="10">to Chrome team &mdash; the Chrome team </span><span class="line" data-startTime="10">email address. </span> <span class="line" data-startTime="14">So if you have a laptop, </span><span class="line" data-startTime="16">you can search for an email </span><span class="line" data-startTime="16">from me. </span> <span class="line" data-startTime="18">And then you can look </span><span class="line" data-startTime="18">at the slides. </span> <span class="line" data-startTime="22">So when a user types in a URL &mdash; </span><span class="line" data-startTime="22">a universal resource locator &mdash; </span><span class="line" data-startTime="27">the browser need to fetch </span><span class="line" data-startTime="27">the resource from the network. </span></p>

<p><span class="line" data-startTime="32">And the network stack is </span><span class="line" data-startTime="32">a component of Chromium </span><span class="line" data-startTime="35">that actually goes </span><span class="line" data-startTime="35">through the network to do that, </span><span class="line" data-startTime="37">and also potentially </span><span class="line" data-startTime="37">caches the resource </span><span class="line" data-startTime="40">for the next time. </span> <span class="line" data-startTime="42">It's amazing that in the short </span><span class="line" data-startTime="42">history of Chromium, </span><span class="line" data-startTime="47">we have already written </span><span class="line" data-startTime="47">the network stack price. </span> <span class="line" data-startTime="51">originally we started using </span><span class="line" data-startTime="51">the WinINet library, </span><span class="line" data-startTime="54">which is really a component </span><span class="line" data-startTime="54">of IE. </span> <span class="line" data-startTime="57">And we did that to get something </span><span class="line" data-startTime="57">working very quickly. </span> <span class="line" data-startTime="60">And also, we believe that after </span><span class="line" data-startTime="60">more than ten years at the web, </span><span class="line" data-startTime="65">every OS should have a very good </span><span class="line" data-startTime="65">BOT and HTTP library. </span> <span class="line" data-startTime="69">And we believe </span><span class="line" data-startTime="69">that should be the case </span><span class="line" data-startTime="72">for all the three major </span><span class="line" data-startTime="72">platforms. </span> <span class="line" data-startTime="75">But we ran </span><span class="line" data-startTime="75">into some problems, </span><span class="line" data-startTime="77">so we switched to another </span><span class="line" data-startTime="77">library called </span><span class="line" data-startTime="80">WinHTTP on Windows. </span></p>

<p><span class="line" data-startTime="82">And it works mostly </span><span class="line" data-startTime="82">just fine. </span> <span class="line" data-startTime="84">So that's what &mdash; </span><span class="line" data-startTime="86">WinHTTP is actually </span><span class="line" data-startTime="86">what's shipping in Chrome 1.0. </span> <span class="line" data-startTime="90">But gradually we will run into </span><span class="line" data-startTime="90">some imitations of WinHTTP. </span> <span class="line" data-startTime="94">It's very difficult </span><span class="line" data-startTime="94">to overcome those </span><span class="line" data-startTime="97">without a source code. </span> <span class="line" data-startTime="99">I'll just name one example </span><span class="line" data-startTime="99">is that </span><span class="line" data-startTime="101">you cannot use WinHTTP </span><span class="line" data-startTime="101">to download a file </span><span class="line" data-startTime="104">larger than two gigabytes. </span> <span class="line" data-startTime="106">And these days, </span><span class="line" data-startTime="106">with these dvd-rom images, </span><span class="line" data-startTime="110">there are a lot of downloads </span><span class="line" data-startTime="110">that are larger than that. </span></p>

<p><span class="line" data-startTime="112">and there is no way </span><span class="line" data-startTime="112">for us to overcome that. </span> <span class="line" data-startTime="116">So last July we started </span><span class="line" data-startTime="116">to realize that </span><span class="line" data-startTime="122">it's really time to write </span><span class="line" data-startTime="122">our own network stack. </span> <span class="line" data-startTime="125">And also we believe that </span><span class="line" data-startTime="125">that will also help </span><span class="line" data-startTime="129">the porting effort </span><span class="line" data-startTime="129">to Mac and Linux. </span> <span class="line" data-startTime="133">So in Chrome 2.0 beta, </span><span class="line" data-startTime="137">we are using our own </span><span class="line" data-startTime="137">cross-platform network stack. </span> <span class="line" data-startTime="143">And this also &mdash; </span><span class="line" data-startTime="146">One reason I mentioned earlier </span><span class="line" data-startTime="149">is that it allows us </span><span class="line" data-startTime="149">to fix bugs easier. </span> <span class="line" data-startTime="152">But we also have a lot of ideas </span><span class="line" data-startTime="152">to improve performance. </span> <span class="line" data-startTime="155">So this allows us </span><span class="line" data-startTime="155">to experiment with those ideas. </span></p>

<p><span class="line" data-startTime="161">So in the source code, all </span><span class="line" data-startTime="161">of our network stack source code </span><span class="line" data-startTime="166">is under a single directory net. </span> <span class="line" data-startTime="169">And then under that, there are </span><span class="line" data-startTime="169">several sub-directories. </span> <span class="line" data-startTime="173">And most of them have </span><span class="line" data-startTime="173">very obvious names, like HTTP. </span> <span class="line" data-startTime="178">The HTTP subdirectory contains </span><span class="line" data-startTime="178">the implementation </span><span class="line" data-startTime="181">of the HTTP protocol. </span> <span class="line" data-startTime="183">And then, similarly, there is </span><span class="line" data-startTime="183">another subdirectory for FTP. </span> <span class="line" data-startTime="186">And then there is </span><span class="line" data-startTime="186">a subdirectory called </span><span class="line" data-startTime="189">url_request. </span> <span class="line" data-startTime="190">And for most of you, that </span><span class="line" data-startTime="190">directory is the most important </span><span class="line" data-startTime="194">because that's really &mdash; </span><span class="line" data-startTime="196">The rest of Chrome uses </span><span class="line" data-startTime="196">the network stack. </span> <span class="line" data-startTime="199">They issue a URL request. </span> <span class="line" data-startTime="201">And the URL request </span><span class="line" data-startTime="201">will create </span><span class="line" data-startTime="205">the appropriate proto handle </span><span class="line" data-startTime="205">to handle that URL request. </span> <span class="line" data-startTime="211">We also have a subdirectory </span><span class="line" data-startTime="211">called proxy </span><span class="line" data-startTime="215">to handle proxy </span><span class="line" data-startTime="215">and get our system </span><span class="line" data-startTime="220">proxy settings and so on. </span></p>

<p><span class="line" data-startTime="222">And then there is a directory </span><span class="line" data-startTime="222">underneath called Base &mdash; </span><span class="line" data-startTime="227">Underneath Net called Base, </span><span class="line" data-startTime="229">which contains the basic </span><span class="line" data-startTime="229">socket implementation &mdash; SSL &mdash; </span><span class="line" data-startTime="234">certificate handling, </span><span class="line" data-startTime="234">and so on. </span> <span class="line" data-startTime="236">We also have our own test </span><span class="line" data-startTime="239">that is only used </span><span class="line" data-startTime="239">for our unitest. </span> <span class="line" data-startTime="242">So the network stack </span><span class="line" data-startTime="242">is actually something </span><span class="line" data-startTime="245">that is possible to use </span><span class="line" data-startTime="245">independent of Chromium. </span> <span class="line" data-startTime="249">It has very little dependency </span><span class="line" data-startTime="249">on the rest of Chromium. </span> <span class="line" data-startTime="252">We only depend </span><span class="line" data-startTime="252">on three other components... </span> <span class="line" data-startTime="255">The Base component... </span> <span class="line" data-startTime="257">The V8 JavaScript interpreter </span><span class="line" data-startTime="260">you only use for interpreting </span><span class="line" data-startTime="260">the proxy auto-config files. </span> <span class="line" data-startTime="266">We also use the Google URL </span><span class="line" data-startTime="266">library. </span> <span class="line" data-startTime="269">And then we use just a few </span><span class="line" data-startTime="269">open-source libraries </span><span class="line" data-startTime="275">to decode HTTP content </span><span class="line" data-startTime="275">decoding, such as Zzip or Gzip. </span> <span class="line" data-startTime="280">So that's pretty much it. </span></p>

<p><span class="line" data-startTime="282">And most of the code is </span><span class="line" data-startTime="282">cross-platformed. </span> <span class="line" data-startTime="285">We hide platform-dependency </span><span class="line" data-startTime="285">in a small number of files. </span> <span class="line" data-startTime="290">So if you need to port </span><span class="line" data-startTime="290">the network stack </span><span class="line" data-startTime="293">to a new platform, </span><span class="line" data-startTime="294">you would just need to provide </span><span class="line" data-startTime="294">the OS bindings </span><span class="line" data-startTime="296">for RTCP sockets &mdash; </span><span class="line" data-startTime="296">SSL sockets &mdash; </span><span class="line" data-startTime="299">get in the system, </span><span class="line" data-startTime="299">process settings. </span> <span class="line" data-startTime="302">Or how to access </span><span class="line" data-startTime="302">the system certificate store. </span> <span class="line" data-startTime="306">That's it. </span> <span class="line" data-startTime="311">Then, if you need to use </span><span class="line" data-startTime="311">the network stack, </span><span class="line" data-startTime="314">it's useful to know </span><span class="line" data-startTime="314">the threading model </span><span class="line" data-startTime="316">and the IO model. </span> <span class="line" data-startTime="318">The threading model is </span><span class="line" data-startTime="318">mostly single-threaded. </span> <span class="line" data-startTime="322">So we do most of the work </span><span class="line" data-startTime="322">a single thread </span><span class="line" data-startTime="325">called the IO thread. </span> <span class="line" data-startTime="327">This is useful to know </span><span class="line" data-startTime="327">because this is why </span><span class="line" data-startTime="330">a lot of data structures </span><span class="line" data-startTime="330">in the network stack </span><span class="line" data-startTime="333">don't need to be protected </span><span class="line" data-startTime="333">by a lot. </span></p>

<p><span class="line" data-startTime="339">And the IO model is </span><span class="line" data-startTime="339">an asynchronized IO model. </span> <span class="line" data-startTime="344">So this means you initiate </span><span class="line" data-startTime="344">an IO operation, </span><span class="line" data-startTime="347">and we return immediately </span><span class="line" data-startTime="347">a status code that says </span><span class="line" data-startTime="351">it's in progress. </span> <span class="line" data-startTime="353">And then, when </span><span class="line" data-startTime="353">the IO operation is done, </span><span class="line" data-startTime="356">like the read, you say, </span><span class="line" data-startTime="356">"I want to read." </span><span class="line" data-startTime="358">When the data is received, </span><span class="line" data-startTime="360">we will invoke your </span><span class="line" data-startTime="360">Completion Callback </span><span class="line" data-startTime="363">provided by you </span><span class="line" data-startTime="363">on the same IO thread. </span> <span class="line" data-startTime="367">So they're just the model </span><span class="line" data-startTime="367">we're using. </span> <span class="line" data-startTime="371">And this actually is true </span><span class="line" data-startTime="371">for most of the classes </span><span class="line" data-startTime="376">in the network stack, </span><span class="line" data-startTime="377">except for the top level &mdash; </span><span class="line" data-startTime="377">URL request class. </span> <span class="line" data-startTime="381">For that class we have </span><span class="line" data-startTime="381">a delegate class </span><span class="line" data-startTime="386">that provide more ways </span><span class="line" data-startTime="386">to invoke the callbacks </span><span class="line" data-startTime="391">for multiple events. </span> <span class="line" data-startTime="397">Then the next slide </span><span class="line" data-startTime="397">is how the network stack </span><span class="line" data-startTime="403">is integrated with Chromium. </span></p>

<p><span class="line" data-startTime="409">The network stack, because </span><span class="line" data-startTime="409">it needs to access the network, </span><span class="line" data-startTime="415">is a privileged operation. </span> <span class="line" data-startTime="416">So it has to run </span><span class="line" data-startTime="416">inside the browser process. </span> <span class="line" data-startTime="419">The renderer is the one </span><span class="line" data-startTime="419">that actually initiates </span><span class="line" data-startTime="424">the loading of a resource </span><span class="line" data-startTime="424">that starts from WebCATS. </span> <span class="line" data-startTime="430">The web &mdash; internet engine. </span> <span class="line" data-startTime="432">So that load resource request </span><span class="line" data-startTime="432">goes through IPC </span><span class="line" data-startTime="436">to the browser process. </span> <span class="line" data-startTime="438">And then there is a class </span><span class="line" data-startTime="438">in the browser process </span><span class="line" data-startTime="441">called the resource </span><span class="line" data-startTime="441">dispatcher host. </span> <span class="line" data-startTime="443">That is responsible </span><span class="line" data-startTime="443">for issuing </span><span class="line" data-startTime="446">the URL request </span><span class="line" data-startTime="446">from the renderer processes </span><span class="line" data-startTime="451">through the network stack. </span> <span class="line" data-startTime="453">So that is a very important </span><span class="line" data-startTime="453">entry point </span><span class="line" data-startTime="456">into the network stack. </span></p>

<p><span class="line" data-startTime="461">But there is another </span><span class="line" data-startTime="461">entry point </span><span class="line" data-startTime="464">into the network stack </span><span class="line" data-startTime="464">called the URL fetcher. </span> <span class="line" data-startTime="467">And that is used </span><span class="line" data-startTime="467">only for URL requests, </span><span class="line" data-startTime="472">generated by Chromium itself. </span> <span class="line" data-startTime="474">Such as visiting </span><span class="line" data-startTime="474">the safe-browsing server, </span><span class="line" data-startTime="477">or carrying navigation </span><span class="line" data-startTime="477">suggestions, </span><span class="line" data-startTime="480">or sending usage statistics </span><span class="line" data-startTime="480">to our UMA servers. </span> <span class="line" data-startTime="484">So at this point I'm going </span><span class="line" data-startTime="484">to turn over to Eric Roman </span><span class="line" data-startTime="490">to go into the network stack </span><span class="line" data-startTime="490">in more detail. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="506"><span class="speakerName">Roman</span>: Hey, so I'm gonna talk </span><span class="line" data-startTime="506">a little bit about </span><span class="line" data-startTime="508">the programming model </span><span class="line" data-startTime="508">for how you actually end up </span><span class="line" data-startTime="511">issuing network requests, </span><span class="line" data-startTime="513">and some of the layers </span><span class="line" data-startTime="513">that we'll pass through </span><span class="line" data-startTime="514">as you do this. </span> <span class="line" data-startTime="516">So the main header file </span><span class="line" data-startTime="516">you'd want to check, </span><span class="line" data-startTime="518">if you're going to be </span><span class="line" data-startTime="518">programming a network request, </span><span class="line" data-startTime="521">is urlrequest.h. </span> <span class="line" data-startTime="523">And this describes how to use </span><span class="line" data-startTime="523">the URL request objects, </span><span class="line" data-startTime="526">which is the main entry point </span><span class="line" data-startTime="526">into the network stack. </span> <span class="line" data-startTime="529">So when you construct </span><span class="line" data-startTime="529">the URL request, </span><span class="line" data-startTime="532">you're going to specify </span><span class="line" data-startTime="532">the URL that you want to fetch, </span><span class="line" data-startTime="535">as well as the URL request </span><span class="line" data-startTime="535">delegate object. </span> <span class="line" data-startTime="540">And the delegate object is </span><span class="line" data-startTime="540">how you receive notification </span><span class="line" data-startTime="544">of events </span><span class="line" data-startTime="544">during the network fetch. </span></p>

<p><span class="line" data-startTime="546">So you'll get &mdash; </span><span class="line" data-startTime="546">you specify, essentially, </span><span class="line" data-startTime="548">callbacks for when </span><span class="line" data-startTime="548">the response has started. </span> <span class="line" data-startTime="550">When the response has completed. </span> <span class="line" data-startTime="553">When you get a repeater act, </span><span class="line" data-startTime="553">when authentication's required. </span> <span class="line" data-startTime="558">And so the URL request object, </span><span class="line" data-startTime="558">once you've constructed it, </span><span class="line" data-startTime="563">you just call "start," </span><span class="line" data-startTime="564">and it begins </span><span class="line" data-startTime="564">issuing the stuff synchronously, </span><span class="line" data-startTime="567">and your delegate will </span><span class="line" data-startTime="567">get called </span><span class="line" data-startTime="569">to notify those various events. </span> <span class="line" data-startTime="572">So the other thing you have </span><span class="line" data-startTime="572">to specify to your request </span><span class="line" data-startTime="577">is the URL request context. </span> <span class="line" data-startTime="580">And the context is essentially </span><span class="line" data-startTime="580">the global state </span><span class="line" data-startTime="583">that's shared between </span><span class="line" data-startTime="583">network requests. </span> <span class="line" data-startTime="586">So this includes </span><span class="line" data-startTime="586">the cookie store, </span><span class="line" data-startTime="589">the HTTP cache, the various </span><span class="line" data-startTime="589">network session state... </span></p>

<p><span class="line" data-startTime="592">auth cache, </span><span class="line" data-startTime="592">the client socket pool, </span><span class="line" data-startTime="596">and proxy service. </span> <span class="line" data-startTime="598">And usually </span><span class="line" data-startTime="598">the URL request contacts... </span> <span class="line" data-startTime="600">you can think of it </span><span class="line" data-startTime="600">as one per browser. </span> <span class="line" data-startTime="604">And so all requests </span><span class="line" data-startTime="604">you do </span><span class="line" data-startTime="607">will be sharing </span><span class="line" data-startTime="607">this same state. </span> <span class="line" data-startTime="608">So they share </span><span class="line" data-startTime="608">the same cookie store. </span> <span class="line" data-startTime="611">They share the same </span><span class="line" data-startTime="611">HTTP cache. </span> <span class="line" data-startTime="613">The exception is </span><span class="line" data-startTime="613">with incognito mode, </span><span class="line" data-startTime="615">where you'd actually specify </span><span class="line" data-startTime="615">a different URL request contact </span><span class="line" data-startTime="619">that you can substitute in </span><span class="line" data-startTime="619">an in-memory cookie store, </span><span class="line" data-startTime="622">and in-memory cache. </span> <span class="line" data-startTime="625">So I guess we'll just </span><span class="line" data-startTime="625">step through a sample request &mdash; </span><span class="line" data-startTime="628">what happens </span><span class="line" data-startTime="628">when you issue, </span><span class="line" data-startTime="630">let's say an HTTPS </span><span class="line" data-startTime="630">or HTTP request. </span> <span class="line" data-startTime="647">So if you have the &mdash; </span><span class="line" data-startTime="647">Can you hear me? </span><span class="line" data-startTime="651">So if you have the slides, </span><span class="line" data-startTime="652">you can follow along </span><span class="line" data-startTime="652">on those as well. </span></p>

<p><span class="line" data-startTime="654">I'll try and reproduce </span><span class="line" data-startTime="654">the similar diagram. </span> <span class="line" data-startTime="741">Okay, so, we'll start with </span><span class="line" data-startTime="741">the URL request object. </span> <span class="line" data-startTime="746">The arrows here represent </span><span class="line" data-startTime="746">dependencies </span><span class="line" data-startTime="751">and sort of flow </span><span class="line" data-startTime="751">of execution. </span> <span class="line" data-startTime="755">So we're going to pass in </span><span class="line" data-startTime="755">the delegate object, </span><span class="line" data-startTime="757">which is how we get called back </span><span class="line" data-startTime="757">when events complete. </span> <span class="line" data-startTime="762">And we also pass </span><span class="line" data-startTime="762">the URL request contacts, </span><span class="line" data-startTime="765">which holds all </span><span class="line" data-startTime="765">of our global state. </span> <span class="line" data-startTime="767">So we're first going to </span><span class="line" data-startTime="767">pass into the &mdash; </span><span class="line" data-startTime="770">The URL request is going to </span><span class="line" data-startTime="770">look at the scheme of the URL. </span> <span class="line" data-startTime="773">It's going to determine </span><span class="line" data-startTime="773">what type of job to create. </span> <span class="line" data-startTime="775">So since we support FTP file, </span><span class="line" data-startTime="775">URLs, HTTP, HTTPS, </span><span class="line" data-startTime="781">this is where it determines </span><span class="line" data-startTime="781">which specific type of jobs </span><span class="line" data-startTime="785">used for this request. </span> <span class="line" data-startTime="786">So in our hypothetical </span><span class="line" data-startTime="786">situation, </span><span class="line" data-startTime="788">we'll be using </span><span class="line" data-startTime="788">an HTTPS request. </span> <span class="line" data-startTime="790">So what it's going to do is </span><span class="line" data-startTime="790">it's going to create </span><span class="line" data-startTime="791">a URL request HTTP drop. </span></p>

<p><span class="line" data-startTime="793">And the URL request HTTP drop, </span><span class="line" data-startTime="793">at this layer, </span><span class="line" data-startTime="797">it applies filters. </span> <span class="line" data-startTime="798">And it's also going to read </span><span class="line" data-startTime="798">and write the cookie store. </span> <span class="line" data-startTime="802">So we'll just write </span><span class="line" data-startTime="802">the cookie store here. </span> <span class="line" data-startTime="806">And the cookie store </span><span class="line" data-startTime="806">comes from </span><span class="line" data-startTime="810">the URL request contacts. </span> <span class="line" data-startTime="813">So after &mdash; we're going to </span><span class="line" data-startTime="813">go down to the next layer. </span> <span class="line" data-startTime="818">This is the HTTP cache </span><span class="line" data-startTime="818">transaction. </span> <span class="line" data-startTime="821">And this is going to enforce </span><span class="line" data-startTime="821">the HTTP cache stuff. </span> <span class="line" data-startTime="826">So it also has a dependency now </span><span class="line" data-startTime="826">for more stake </span><span class="line" data-startTime="829">coming from the URL request </span><span class="line" data-startTime="829">contacts, </span><span class="line" data-startTime="830">which is the HTTP cache. </span> <span class="line" data-startTime="837">And that's also </span><span class="line" data-startTime="837">part of URL requests contacts. </span></p>

<p><span class="line" data-startTime="840">So if the HTTP &mdash; </span><span class="line" data-startTime="842">If the request </span><span class="line" data-startTime="842">can be serviced from cache, </span><span class="line" data-startTime="844">it's gonna stop at this layer, </span><span class="line" data-startTime="844">and sort of return that. </span> <span class="line" data-startTime="847">If not, then it's going to </span><span class="line" data-startTime="847">have to actually do </span><span class="line" data-startTime="850">a real transaction </span><span class="line" data-startTime="850">on the network. </span> <span class="line" data-startTime="853">So it's going to go down </span><span class="line" data-startTime="853">to the next layer, </span><span class="line" data-startTime="855">which is the HTTP network </span><span class="line" data-startTime="855">transaction. </span> <span class="line" data-startTime="858">And this is where </span><span class="line" data-startTime="858">the real details </span><span class="line" data-startTime="859">of the HTTP protocol </span><span class="line" data-startTime="859">are implemented. </span> <span class="line" data-startTime="861">So reading and writing </span><span class="line" data-startTime="861">the headers, </span><span class="line" data-startTime="864">understanding response codes &mdash; </span><span class="line" data-startTime="865">most of that logic is </span><span class="line" data-startTime="865">in HTTP network transaction. </span> <span class="line" data-startTime="869">And it's going to, like, </span><span class="line" data-startTime="869">apply authentication, </span><span class="line" data-startTime="871">apply the proxy. </span> <span class="line" data-startTime="873">So at this layer, </span><span class="line" data-startTime="873">it's going to rely </span><span class="line" data-startTime="878">on quite a bit of state </span><span class="line" data-startTime="878">from URL request contacts. </span></p>

<p><span class="line" data-startTime="881">And most of this is </span><span class="line" data-startTime="881">in HTTP network session. </span> <span class="line" data-startTime="894">So this is indirectly part </span><span class="line" data-startTime="894">of URL request contacts. </span> <span class="line" data-startTime="898">It's contained in that. </span> <span class="line" data-startTime="900">And so your HTTP session </span><span class="line" data-startTime="900">contains various things. </span> <span class="line" data-startTime="905">IT contains the HTTP cache... </span> <span class="line" data-startTime="911">the client socket pool, </span><span class="line" data-startTime="911">proxy service. </span> <span class="line" data-startTime="915">A lot of stuff from here </span><span class="line" data-startTime="915">as well. </span> <span class="line" data-startTime="916">So we'll draw in </span><span class="line" data-startTime="916">a couple of those. </span> <span class="line" data-startTime="932">Okay, and then, so now we're </span><span class="line" data-startTime="932">near the bottom of the stack. </span> <span class="line" data-startTime="937">And now we hav &mdash; the final levels </span><span class="line" data-startTime="937">are the socket levels. </span> <span class="line" data-startTime="940">So if this were an HTTP request, </span><span class="line" data-startTime="940">we'd be talking </span><span class="line" data-startTime="943">to the client socket interface. </span> <span class="line" data-startTime="946">We'd be talking to </span><span class="line" data-startTime="946">SSL client socket. </span></p>

<p><span class="line" data-startTime="949">So we'll just put that </span><span class="line" data-startTime="949">in here. </span> <span class="line" data-startTime="959">And so this would essentially </span><span class="line" data-startTime="959">wrap a transport socket, </span><span class="line" data-startTime="964">which would just be </span><span class="line" data-startTime="964">our TCP client socket. </span> <span class="line" data-startTime="972">And then, obviously, here </span><span class="line" data-startTime="972">we're actually just </span><span class="line" data-startTime="974">talking down to the network. </span> <span class="line" data-startTime="979">So lastly, </span><span class="line" data-startTime="984">just gonna talk a little </span><span class="line" data-startTime="984">about the tests. </span> <span class="line" data-startTime="986">So if you're going to be </span><span class="line" data-startTime="986">working the network stack, </span><span class="line" data-startTime="989">and you make modifications, </span><span class="line" data-startTime="991">you obviously want </span><span class="line" data-startTime="991">a unit test. </span></p>

<p><span class="line" data-startTime="993">So to run the unit test, </span><span class="line" data-startTime="995">you just use the net unit test </span><span class="line" data-startTime="995">target. </span> <span class="line" data-startTime="1000">And most of the tests use </span><span class="line" data-startTime="1000">mock dependencies. </span> <span class="line" data-startTime="1003">For, like, at the socket level </span><span class="line" data-startTime="1003">or, you know, </span><span class="line" data-startTime="1007">mock proxy services, </span><span class="line" data-startTime="1007">whatever. </span> <span class="line" data-startTime="1008">There are some exceptions. </span> <span class="line" data-startTime="1010">As once I mentioned, </span><span class="line" data-startTime="1010">we also have the test server. </span> <span class="line" data-startTime="1013">And the test server is </span><span class="line" data-startTime="1013">a Python application, </span><span class="line" data-startTime="1016">where you can create </span><span class="line" data-startTime="1016">custom responses </span><span class="line" data-startTime="1021">or handlers for special tests. </span></p>

<p><span class="line" data-startTime="1025">So that's also an option. </span> <span class="line" data-startTime="1029">So, yeah. </span> <span class="line" data-startTime="1033">And there's a bunch </span><span class="line" data-startTime="1033">of resources for &mdash; </span><span class="line" data-startTime="1036">You can check out </span><span class="line" data-startTime="1036">the network stack road map, </span><span class="line" data-startTime="1038">the DNS prefetching document </span><span class="line" data-startTime="1038">page. </span> <span class="line" data-startTime="1041">There's documentation </span><span class="line" data-startTime="1041">on disk cache, </span><span class="line" data-startTime="1043">if you want more information. </span> <span class="line" data-startTime="1044">There's some links </span><span class="line" data-startTime="1044">in the slides. </span> <span class="line" data-startTime="1047">And I guess lastly, </span><span class="line" data-startTime="1049">Wan-Teh and I can </span><span class="line" data-startTime="1049">answer questions. </span> <span class="line" data-startTime="1054">Yes. </span></p>

<p class="speaker"><span class="line" data-starttime="1056"><span class="speakerName">Roman</span>: So Wan-Teh mentioned </span><span class="line" data-startTime="1056">reasons for switching away </span><span class="line" data-startTime="1058">from WinINet and and WinHTTP. </span><span class="line" data-startTime="1061">Can you guys reiterate </span><span class="line" data-startTime="1061">some of the other reasons </span><span class="line" data-startTime="1064">besides the two-gigabyte </span><span class="line" data-startTime="1064">file download limit on WinHTTP? </span><span class="line" data-startTime="1069">Why we ended up ditching, </span><span class="line" data-startTime="1069">like, WinINet, for example? </span><span class="line" data-startTime="1073">So the question was to elaborate </span><span class="line" data-startTime="1073">a bit on, you know, </span><span class="line" data-startTime="1078">why we chose to ditch WinINet </span><span class="line" data-startTime="1078">and WinHTTP. </span><span class="line" data-startTime="1081">So he mentioned </span><span class="line" data-startTime="1081">there were some bugs. </span><span class="line" data-startTime="1084">in particular, like, </span><span class="line" data-startTime="1084">not being able </span><span class="line" data-startTime="1086">to do file downloads </span><span class="line" data-startTime="1086">over two gigabytes, </span><span class="line" data-startTime="1089">and with some other &mdash; </span><span class="line" data-startTime="1089">I think Wan-Teh will &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="1093"><span class="speakerName">Wan-Teh</span>: So with WinINet, </span><span class="line" data-startTime="1093">we basically ran into </span><span class="line" data-startTime="1095">two major problems. </span> <span class="line" data-startTime="1097">The first one is that </span><span class="line" data-startTime="1097">we cannot get the certificate &mdash; </span><span class="line" data-startTime="1101">the service certificate. </span> <span class="line" data-startTime="1103">And this is critical </span><span class="line" data-startTime="1105">when you handle </span><span class="line" data-startTime="1105">an SSL certificate error. </span> <span class="line" data-startTime="1108">So that one we actually went </span><span class="line" data-startTime="1108">to extraordinary measure &mdash; means. </span> <span class="line" data-startTime="1111">And we were able </span><span class="line" data-startTime="1111">to get the certificate </span><span class="line" data-startTime="1114">by patching WinINet. </span> <span class="line" data-startTime="1117">But the other one </span><span class="line" data-startTime="1117">that we cannot surmount </span><span class="line" data-startTime="1119">was that it's impossible </span><span class="line" data-startTime="1119">to tell WinINet </span><span class="line" data-startTime="1122">to bypass its own cache. </span> <span class="line" data-startTime="1125">And we know that some server </span><span class="line" data-startTime="1125">generates dynamic content </span><span class="line" data-startTime="1129">based on the browser's </span><span class="line" data-startTime="1129">user agent. </span> <span class="line" data-startTime="1132">So we do not want to share </span><span class="line" data-startTime="1132">the cache with IE. </span></p>

<p><span class="line" data-startTime="1138">So that's really the reason </span><span class="line" data-startTime="1138">we had to switch </span><span class="line" data-startTime="1141">to a new library. </span> <span class="line" data-startTime="1143">For WinHTTP, we could tell </span><span class="line" data-startTime="1143">that it shares some code </span><span class="line" data-startTime="1148">with WinINet. </span> <span class="line" data-startTime="1149">But probably because </span><span class="line" data-startTime="1149">it's not used in IE. </span> <span class="line" data-startTime="1152">The shared code is older, </span><span class="line" data-startTime="1152">so it has some bugs. </span> <span class="line" data-startTime="1158">Security bugs that had already </span><span class="line" data-startTime="1158">been fixed in IE's version. </span> <span class="line" data-startTime="1162">So we are quite unhappy </span><span class="line" data-startTime="1162">about that. </span> <span class="line" data-startTime="1165">And it also had some problem </span><span class="line" data-startTime="1165">that caused system crashes &mdash; </span><span class="line" data-startTime="1171">blue screens on some laptops. </span> <span class="line" data-startTime="1173">That one we were also able </span><span class="line" data-startTime="1173">to find &mdash; work around. </span> <span class="line" data-startTime="1179">But in the end we just thought </span><span class="line" data-startTime="1179">that there are </span><span class="line" data-startTime="1183">too many issues. </span> <span class="line" data-startTime="1184">And the porting to Mac </span><span class="line" data-startTime="1184">and Linux was going to start. </span> <span class="line" data-startTime="1190">So we thought it's time </span><span class="line" data-startTime="1190">to write our own. </span></p>

<p><span class="line" data-startTime="1194">man: So on Mac and Linux, </span><span class="line" data-startTime="1194">what's the lay of the land </span><span class="line" data-startTime="1200">with regard to existing platform </span><span class="line" data-startTime="1200">network implementations, </span><span class="line" data-startTime="1204">and whether they're </span><span class="line" data-startTime="1204">better or worse? </span><span class="line" data-startTime="1206">The same for us as &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="1208"><span class="speakerName">Wan-Teh</span>: Okay. </span> <span class="line" data-startTime="1209">So Peter asked about the system </span><span class="line" data-startTime="1209">networking libraries </span><span class="line" data-startTime="1213">on Mac and Linux, </span><span class="line" data-startTime="1213">and their quality. </span> <span class="line" data-startTime="1216">On the Mac, </span><span class="line" data-startTime="1216">I know there is a library </span><span class="line" data-startTime="1218">called CFNetwork. </span> <span class="line" data-startTime="1220">I guess it stands for </span><span class="line" data-startTime="1220">Core Foundation Network. </span> <span class="line" data-startTime="1222">That's used by Safari. </span> <span class="line" data-startTime="1224">So I thought that should be </span><span class="line" data-startTime="1224">pretty good. </span> <span class="line" data-startTime="1226">But I don't have any </span><span class="line" data-startTime="1226">personal experience using it. </span> <span class="line" data-startTime="1231">Linux, the usual problem is </span><span class="line" data-startTime="1231">not whether there is one. </span> <span class="line" data-startTime="1235">The problem is </span><span class="line" data-startTime="1235">there are too many, </span><span class="line" data-startTime="1237">and you need to pick one. </span> <span class="line" data-startTime="1238">So I thought on Linux &mdash; </span><span class="line" data-startTime="1238">we were considering LibCurl. </span></p>

<p><span class="line" data-startTime="1242">That's quite popular. </span> <span class="line" data-startTime="1244">And there's another one </span><span class="line" data-startTime="1244">called Lib Neon </span><span class="line" data-startTime="1246">that's used by the SBN client. </span> <span class="line" data-startTime="1248">I think both would </span><span class="line" data-startTime="1248">probably work well. </span> <span class="line" data-startTime="1252">But in the end, we just thought </span><span class="line" data-startTime="1252">it better to write our own. </span> <span class="line" data-startTime="1256">And the network stack, </span><span class="line" data-startTime="1256">it turns out, </span><span class="line" data-startTime="1258">is not really that complicated </span><span class="line" data-startTime="1260">Especially the core portion. </span> <span class="line" data-startTime="1262">So basically Darin Fisher </span><span class="line" data-startTime="1262">wrote it within a week. </span> <span class="line" data-startTime="1267">And it was able to do TCP &mdash; </span><span class="line" data-startTime="1271">regular TTP requests &mdash; </span><span class="line" data-startTime="1271">HTTP requests. </span> <span class="line" data-startTime="1274">man: I'm just curious. </span> <span class="line" data-startTime="1277">Are we headed in the direction </span><span class="line" data-startTime="1277">of being able </span><span class="line" data-startTime="1279">to have our own proxy settings </span><span class="line" data-startTime="1279">and our own certificate store, </span><span class="line" data-startTime="1283">and not rely on the system </span><span class="line" data-startTime="1283">for that? </span><span class="line" data-startTime="1285">Um, okay... </span></p>

<p><span class="line" data-startTime="1285">so the question is &mdash; </span><span class="line" data-startTime="1288">Right now we're using </span><span class="line" data-startTime="1288">the system proxy settings </span><span class="line" data-startTime="1291">and the system certificate </span><span class="line" data-startTime="1291">store. </span> <span class="line" data-startTime="1293">So the question is whether </span><span class="line" data-startTime="1293">we're going to support </span><span class="line" data-startTime="1297">our own proxy settings </span><span class="line" data-startTime="1297">and a certificate store. </span> <span class="line" data-startTime="1301">I think the answer is &mdash; </span><span class="line" data-startTime="1301">I have two different answers. </span> <span class="line" data-startTime="1305">For a certificate store, </span><span class="line" data-startTime="1305">I still think </span><span class="line" data-startTime="1307">it's very important to share </span><span class="line" data-startTime="1307">the system cert store </span><span class="line" data-startTime="1310">with other applications. </span> <span class="line" data-startTime="1313">And we haven't received </span><span class="line" data-startTime="1313">any complaints </span><span class="line" data-startTime="1316">about our using </span><span class="line" data-startTime="1316">the Windows system store. </span> <span class="line" data-startTime="1319">But with the proxy settings, </span><span class="line" data-startTime="1322">we do get a lot of complaints </span><span class="line" data-startTime="1322">from some Firefox users. </span> <span class="line" data-startTime="1328">Basically, </span><span class="line" data-startTime="1328">their problem is that </span><span class="line" data-startTime="1332">they use </span><span class="line" data-startTime="1332">the same laptop at work </span><span class="line" data-startTime="1335">and at home. </span> <span class="line" data-startTime="1336">And they have to use </span><span class="line" data-startTime="1336">the system proxy settings </span><span class="line" data-startTime="1339">with IE at work. </span> <span class="line" data-startTime="1341">But for some reason </span><span class="line" data-startTime="1341">they want to use &mdash; </span><span class="line" data-startTime="1344">When they use Firefox, </span><span class="line" data-startTime="1346">they want to use </span><span class="line" data-startTime="1346">a different set of settings </span><span class="line" data-startTime="1347">that's appropriate </span><span class="line" data-startTime="1347">for their home network. </span></p>

<p><span class="line" data-startTime="1350">And these Firefox users </span><span class="line" data-startTime="1350">told us </span><span class="line" data-startTime="1354">that they cannot use Chrome </span><span class="line" data-startTime="1354">because of this reason. </span> <span class="line" data-startTime="1357">So we are seriously </span><span class="line" data-startTime="1357">considering adding </span><span class="line" data-startTime="1360">our own proxy settings. </span> <span class="line" data-startTime="1364">man: What are the real-world </span><span class="line" data-startTime="1364">web-compat ramifications </span><span class="line" data-startTime="1369">of different network stacks, </span><span class="line" data-startTime="1369">especially rolling our own? </span></p>

<p class="speaker"><span class="line" data-starttime="1372"><span class="speakerName">Wan-Teh</span>: So the question is </span><span class="line" data-startTime="1375">what are the real-world </span><span class="line" data-startTime="1375">ramifications </span><span class="line" data-startTime="1377">of network stacks? </span><span class="line" data-startTime="1379">Especially when writing </span><span class="line" data-startTime="1379">our own. </span><span class="line" data-startTime="1382">man: For website compatibility. </span></p>

<p class="speaker"><span class="line" data-starttime="1385"><span class="speakerName">Wan-Teh</span>: our experience is </span><span class="line" data-startTime="1385">that &mdash; </span><span class="line" data-startTime="1388">So working on network, I think, </span><span class="line" data-startTime="1388">is similar to our layout. </span> <span class="line" data-startTime="1393">On the one hand, you need </span><span class="line" data-startTime="1393">to implement a standard. </span> <span class="line" data-startTime="1396">But on the other hand, </span><span class="line" data-startTime="1396">you also need to be </span><span class="line" data-startTime="1399">somewhat permissive </span><span class="line" data-startTime="1399">of broken implementations. </span> <span class="line" data-startTime="1402">So our approach has been that </span><span class="line" data-startTime="1402">we're trying to be </span><span class="line" data-startTime="1407">as strict as possible. </span> <span class="line" data-startTime="1409">And when we run into </span><span class="line" data-startTime="1409">incompatibility, </span><span class="line" data-startTime="1414">we make our best effort </span><span class="line" data-startTime="1414">to contact the site, </span><span class="line" data-startTime="1418">to correct it. </span></p>

<p><span class="line" data-startTime="1419">Or sometimes contact &mdash; </span><span class="line" data-startTime="1421">if they are using open-source </span><span class="line" data-startTime="1421">server product, </span><span class="line" data-startTime="1424">we try to file a bug report. </span> <span class="line" data-startTime="1426">But usually that takes </span><span class="line" data-startTime="1426">a lot of effort. </span> <span class="line" data-startTime="1430">So we also have to implement </span><span class="line" data-startTime="1430">work-arounds </span><span class="line" data-startTime="1433">for some </span><span class="line" data-startTime="1433">of the incompatibilites. </span> <span class="line" data-startTime="1442">Any other questions? </span><span class="line" data-startTime="1447">Okay, thank you. </span> <span class="line" data-startTime="1449">[applause] </span></p>