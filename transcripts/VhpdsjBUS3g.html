<style>* {font-family: "Open Sans", sans-serif}
a {color: #77aaff}
a.video {border-bottom: 1px solid #ddd; display: block; margin: 0 0 2em 0; padding: 0 0 2em 0}
h2 {color: #444; font-size: 18px;}
span.speakerName {color: black; font-weight: 900;}
body {padding: 2em}
p {color: #444; margin: 0; text-indent: 1.5em;}
p.speaker {margin: 1em 0 0 0; text-indent: 0;}
div#transcript > p:first-child {text-indent: 0;}
</style>

<h1>Google I/O 2013 &mdash; Accelerating Oz with V8: Follow the Yellow Brick Road to JavaScript Performance</h1>

<h2>John McCutchan</h2>

<a class="video" href="http://youtu.be/VhpdsjBUS3g">youtu.be/VhpdsjBUS3g</a><div id="transcript"><p class="speaker"><span class="line" data-starttime="2"><span class="speakerName">John McCutchan</span>: Hello, everyone. I'm John </span><span class="line" data-startTime="2">McCutchan. I'm part of the Chrome DevRel team </span><span class="line" data-startTime="7">and my focus is on making the web fast, and </span><span class="line" data-startTime="7">that's what I'm hoping to teach you today: </span><span class="line" data-startTime="12">How to make your page very fast with V8. </span> <span class="line" data-startTime="12">So this talk's going to get into some pretty </span><span class="line" data-startTime="19">low-level details about how V8 works and how </span><span class="line" data-startTime="19">you can surface some signals, so hopefully </span><span class="line" data-startTime="23">that's really exciting to you because it's </span><span class="line" data-startTime="23">exciting to me. </span> <span class="line" data-startTime="28">So today I want to talk about Oz. Specifically, </span><span class="line" data-startTime="28">Find Your Way to Oz, the Chrome experiment </span><span class="line" data-startTime="34">that came out in February. </span> <span class="line" data-startTime="34">Let's just take a look at a video of what </span><span class="line" data-startTime="37">the experience is like. </span> <span class="line" data-startTime="37">This is all running inside the browser and </span><span class="line" data-startTime="42">it's a game. There's about four games and </span><span class="line" data-startTime="42">it's all themed around the new Wizard of Oz </span><span class="line" data-startTime="47">movie. </span> <span class="line" data-startTime="47">So the first one is like the carnival cutout. </span> <span class="line" data-startTime="52">You put your face into this &mdash; this wooden </span><span class="line" data-startTime="52">painting and it's using a webcam. Let me just </span><span class="line" data-startTime="60">kill the ad. </span></p>

<p><span class="line" data-startTime="60">So the next one is a music box, and you can </span><span class="line" data-startTime="67">actually kind of compose your own theme that, </span><span class="line" data-startTime="67">you know, kind of fits with the Wizard of </span><span class="line" data-startTime="73">Oz theme. </span> <span class="line" data-startTime="73">And then when you &mdash; after you're finished, </span><span class="line" data-startTime="76">when you're walking around throughout the </span><span class="line" data-startTime="76">Wizard of Oz, the park, it will be playing </span><span class="line" data-startTime="80">the song that you've made, and this is using </span><span class="line" data-startTime="80">Web Audio. </span> <span class="line" data-startTime="91">So the next attraction at the circus is make </span><span class="line" data-startTime="91">your own zoetrope, and for those of you who </span><span class="line" data-startTime="97">are too young to know what a zoetrope is, </span><span class="line" data-startTime="97">including myself, it kind of predated animation </span><span class="line" data-startTime="102">in film and, you know, you kind of &mdash; this </span><span class="line" data-startTime="102">thing spun around in a circle and showed you </span><span class="line" data-startTime="107">a very simplistic animation like this. And </span><span class="line" data-startTime="107">again, this is using the webcam and capturing </span><span class="line" data-startTime="112">video from your computer and then putting </span><span class="line" data-startTime="112">you into the game world. </span></p>

<p><span class="line" data-startTime="117">The final attraction is really impressive. </span> <span class="line" data-startTime="117">It's a hot air balloon ride where you have </span><span class="line" data-startTime="122">to navigate this big tornado and, you know, </span><span class="line" data-startTime="122">kind of escape &mdash; Find Your Way </span><span class="line" data-startTime="122">to Oz. </span> <span class="line" data-startTime="133">So really impressive graphics. I mean, this </span><span class="line" data-startTime="133">looks great. There's a really in-depth article </span><span class="line" data-startTime="137">on how they actually accomplished this effect, </span><span class="line" data-startTime="137">and it's very interesting. It kind of incorporated </span><span class="line" data-startTime="143">a lot of things from how they do effects in </span><span class="line" data-startTime="143">film where they have like a mat painting and </span><span class="line" data-startTime="148">they're kind of composing all of these different </span><span class="line" data-startTime="148">layers together, but it's all running with </span><span class="line" data-startTime="152">WebGL. </span> <span class="line" data-startTime="152">So this is Find Your Way to Oz. It's really </span><span class="line" data-startTime="157">exciting. I recommend that you check it out. </span></p>

<p><span class="line" data-startTime="157">Like I said, it's been using &mdash; it's using </span><span class="line" data-startTime="162">all of the latest HTML5 features. It's using </span><span class="line" data-startTime="162">WebGL. It was developed by unit9 and this </span><span class="line" data-startTime="167">was a partnership between Disney and Google, </span><span class="line" data-startTime="167">and unit9 did a great job. It won a few awards. </span> <span class="line" data-startTime="172">It's a really exciting project. </span> <span class="line" data-startTime="172">But late in development, there was a really </span><span class="line" data-startTime="178">serious performance problem and it wasn't </span><span class="line" data-startTime="178">a trivial problem. We were seeing something </span><span class="line" data-startTime="184">that &mdash; you know, we're looking at memory </span><span class="line" data-startTime="184">usage and seeing the graph along the bottom </span><span class="line" data-startTime="187">here where we're just seeing like this sawtooth-like </span><span class="line" data-startTime="187">shape where it just keeps using more memory </span><span class="line" data-startTime="191">and the garbage collection kicks in and cleans </span><span class="line" data-startTime="191">it up and no one could really figure this </span><span class="line" data-startTime="195">out. </span></p>

<p><span class="line" data-startTime="195">This was late. This was not good. The product </span><span class="line" data-startTime="199">needed to ship. Delays were a possibility </span><span class="line" data-startTime="199">and we really had to make sure that this &mdash; this </span><span class="line" data-startTime="204">didn't get out of hand. </span> <span class="line" data-startTime="204">So lucky for unit9, they were able to call </span><span class="line" data-startTime="209">in some performance detectives and this is </span><span class="line" data-startTime="209">Yacov and Yung from the V8 team and they were </span><span class="line" data-startTime="214">actually able to help kind of hold unit9's </span><span class="line" data-startTime="214">hand and figure out what was going on inside </span><span class="line" data-startTime="220">of their game. </span> <span class="line" data-startTime="220">So I hope that you in the audience, after </span><span class="line" data-startTime="224">going through this talk, will be able to do </span><span class="line" data-startTime="224">the same things that unit9 did that the V8 </span><span class="line" data-startTime="229">team taught them. So hopefully you all will </span><span class="line" data-startTime="229">become performance detectives by the end. </span> <span class="line" data-startTime="236">So before we go into what the problem was </span><span class="line" data-startTime="236">and how we resolved it, let's spend a few </span><span class="line" data-startTime="240">minutes talking about why performance matters. </span></p>

<p><span class="line" data-startTime="240">So if we look at a typical frame in a browser, </span><span class="line" data-startTime="249">the first thing that happens is you have to </span><span class="line" data-startTime="249">handle input. The users click something or </span><span class="line" data-startTime="252">they press a button. </span> <span class="line" data-startTime="252">After handling input, scripts start executing. </span> <span class="line" data-startTime="257">All the &mdash; the state of the page gets updated, </span><span class="line" data-startTime="257">and actually this often triggers a layout </span><span class="line" data-startTime="263">change, and so the browser has to re-lay out </span><span class="line" data-startTime="263">all the elements inside the page, and then </span><span class="line" data-startTime="268">after this, it's got to paint all of the elements. </span> <span class="line" data-startTime="268">They're changed the contents. What's inside </span><span class="line" data-startTime="272">of there has changed. This is a lot of work. </span> <span class="line" data-startTime="272">And then finally, it all gets composited onto </span><span class="line" data-startTime="277">the screen. This just loops and you actually </span><span class="line" data-startTime="277">have to do this 60 times a second and you </span><span class="line" data-startTime="283">have 16 milliseconds to accomplish all of </span><span class="line" data-startTime="283">this. If you don't, you're going to drop a </span><span class="line" data-startTime="288">frame and you're going to get jank. </span> <span class="line" data-startTime="288">So "jank" is the slang term for like kind </span><span class="line" data-startTime="294">of a &mdash; an unpleasant, unsmooth site experience. </span></p>

<p><span class="line" data-startTime="294">When you're scrolling on a page and it kind </span><span class="line" data-startTime="300">of clips and it jumps, it doesn't feel smooth, </span><span class="line" data-startTime="300">that's jank. When you're playing an online </span><span class="line" data-startTime="304">game and it drops a frame or some &mdash; you know, </span><span class="line" data-startTime="304">something kind of weird happens, it pauses </span><span class="line" data-startTime="308">for a second, that's jank. </span> <span class="line" data-startTime="308">And so if you miss &mdash; I mean, if you cannot </span><span class="line" data-startTime="313">get all &mdash; through all the steps in 16 milliseconds, </span><span class="line" data-startTime="313">you're going to have a janky page and users </span><span class="line" data-startTime="318">don't really like that. </span> <span class="line" data-startTime="318">So where does all this performance go? Where </span><span class="line" data-startTime="322">does that 16 milliseconds &mdash; where does it </span><span class="line" data-startTime="322">go? </span><span class="line" data-startTime="326">So if we look at this graph here, it's kind </span><span class="line" data-startTime="326">of difficult to parse, but each column represents </span><span class="line" data-startTime="332">a very mainstream site on the web, like Google </span><span class="line" data-startTime="332">Docs or Gmail or Wikipedia or something like </span><span class="line" data-startTime="338">that. And what we really care about for this </span><span class="line" data-startTime="338">talk is the red candy-striped section along </span><span class="line" data-startTime="344">the bottom. </span> <span class="line" data-startTime="344">This is actually the time that your page is </span><span class="line" data-startTime="347">spending inside V8. </span> <span class="line" data-startTime="347">And what we see is that, you know, for Google </span><span class="line" data-startTime="354">Apps, when the page isn't idle, we're actually </span><span class="line" data-startTime="354">spending between 50 to 70% of the time inside </span><span class="line" data-startTime="360">idle. And for other popular sites, it's in </span><span class="line" data-startTime="360">the range of 20 to 40%. </span></p>

<p><span class="line" data-startTime="366">So of that 16 milliseconds, a Google app is </span><span class="line" data-startTime="366">spending 50% of it, at least, executing scripts. </span> <span class="line" data-startTime="377">So performance matters because you want your </span><span class="line" data-startTime="377">site to grow. You want to attract more users, </span><span class="line" data-startTime="382">and users care about the performance of the </span><span class="line" data-startTime="382">site. </span> <span class="line" data-startTime="384">In particular, it's been highlighted, you </span><span class="line" data-startTime="384">know, in recent times with battery life. If </span><span class="line" data-startTime="387">you go to a page that performs poorly, the </span><span class="line" data-startTime="387">&mdash; you know, the battery in your mobile device </span><span class="line" data-startTime="391">is going to drain quicker and people are going </span><span class="line" data-startTime="391">to stop coming back because it's just not </span><span class="line" data-startTime="395">the greatest experience. </span> <span class="line" data-startTime="395">Users also want smoother applications. They </span><span class="line" data-startTime="401">want that, like, smooth experience when they </span><span class="line" data-startTime="401">scroll. They want their game to run flawlessly </span><span class="line" data-startTime="405">and never have a hiccup on any frame. And </span><span class="line" data-startTime="405">they want more features. All of these things </span><span class="line" data-startTime="410">&mdash; it's actually kind of difficult to satisfy </span><span class="line" data-startTime="410">these requests, because they're all sort of </span><span class="line" data-startTime="414">competing with each other. </span></p>

<p><span class="line" data-startTime="414">But you as the developer, you have to satisfy </span><span class="line" data-startTime="417">all of these requests. It's &mdash; you want to </span><span class="line" data-startTime="417">maximize battery life, you want the smoothest </span><span class="line" data-startTime="422">application, and you want the most featureful </span><span class="line" data-startTime="422">application. And without that, you're not </span><span class="line" data-startTime="425">going to see a really strong growth in the </span><span class="line" data-startTime="425">traffic to your site. </span> <span class="line" data-startTime="431">So let's get back to the mystery and dig in </span><span class="line" data-startTime="431">a little bit. </span> <span class="line" data-startTime="435">So solving a performance problem is actually </span><span class="line" data-startTime="435">a lot like solving a crime. The first thing </span><span class="line" data-startTime="439">you have to do is you have to dig in and get </span><span class="line" data-startTime="439">&mdash; collect some evidence and really figure </span><span class="line" data-startTime="442">out what's happening. </span> <span class="line" data-startTime="442">And then from the evidence, you're going to </span><span class="line" data-startTime="446">find some suspects, and you're going to kind </span><span class="line" data-startTime="446">of interrogate the suspects and figure out </span><span class="line" data-startTime="451">like which one of them is likely responsible </span><span class="line" data-startTime="451">for your performance problem. </span></p>

<p><span class="line" data-startTime="455">And then finally, you're going to go into </span><span class="line" data-startTime="455">the forensics lab and really prove that they're </span><span class="line" data-startTime="459">responsible and dig up some information that </span><span class="line" data-startTime="459">will hopefully let you solve the crime and </span><span class="line" data-startTime="463">fix the performance problem. </span> <span class="line" data-startTime="463">So let's get started on the &mdash; the mystery </span><span class="line" data-startTime="467">that the unit9 team faced with Oz. </span> <span class="line" data-startTime="467">So evidence collection. You want to start </span><span class="line" data-startTime="477">off asking some pretty fundamental questions </span><span class="line" data-startTime="477">about the site that you're looking at. If </span><span class="line" data-startTime="481">it's your site, then you can probably very </span><span class="line" data-startTime="481">quickly zoom through this, but if you're helping </span><span class="line" data-startTime="485">someone else, then you really &mdash; it might </span><span class="line" data-startTime="485">seem silly to start at such a basic question, </span><span class="line" data-startTime="490">but it's important to contextualize what you're </span><span class="line" data-startTime="490">doing. </span> <span class="line" data-startTime="492">So the &mdash; Oz is a real-time interactive 3D </span><span class="line" data-startTime="492">game. It's taking advantage of WebGL. It has </span><span class="line" data-startTime="498">to run smooth. It has to fit that 16-millisecond </span><span class="line" data-startTime="498">time slice or else it's going to perform badly. </span> <span class="line" data-startTime="506">So the next question you want to ask yourself, </span><span class="line" data-startTime="506">are the developers following the best practices? </span><span class="line" data-startTime="511">If they're not, then the likely solution to </span><span class="line" data-startTime="511">the performance problem is probably something </span><span class="line" data-startTime="516">really simple. They probably just aren't aware </span><span class="line" data-startTime="516">of the best practices and are making some </span><span class="line" data-startTime="520">silly error and it's great. You can fix it </span><span class="line" data-startTime="520">in no time. </span></p>

<p><span class="line" data-startTime="526">But unit9 are really good developers and they </span><span class="line" data-startTime="526">were following the best practices and they </span><span class="line" data-startTime="530">were well-read and they were up-to-date on </span><span class="line" data-startTime="530">all of the things that you have to do to make </span><span class="line" data-startTime="533">a really smooth and, you know, impressive </span><span class="line" data-startTime="533">3D game in the browser. </span> <span class="line" data-startTime="538">So it wasn't something simple. I mean, why </span><span class="line" data-startTime="538">would I be here talking about if it was such </span><span class="line" data-startTime="544">a trivial problem? </span><span class="line" data-startTime="544">So specifically what kind of performance problem </span><span class="line" data-startTime="551">are you seeing? And when you're at this stage </span><span class="line" data-startTime="551">in your investigation, you want to really </span><span class="line" data-startTime="554">kind of nail it down because this is going </span><span class="line" data-startTime="554">to lead you to suspects. And specifically, </span><span class="line" data-startTime="560">they were seeing once per second the frame </span><span class="line" data-startTime="560">rate dropped significantly. And to add a little </span><span class="line" data-startTime="566">bit of extra information to it, it was actually </span><span class="line" data-startTime="566">correlated with GC activity. </span></p>

<p><span class="line" data-startTime="570">So right when the frame rate dropped, they </span><span class="line" data-startTime="570">actually saw that the &mdash; there was a lot of </span><span class="line" data-startTime="574">GC activity. Garbage collector was running. </span> <span class="line" data-startTime="574">So that gives you a bit of a clue as to maybe </span><span class="line" data-startTime="579">where should you start your investigation. </span> <span class="line" data-startTime="579">We're seeing a frame rate drop with GC activity. </span> <span class="line" data-startTime="586">And in particular, the GC activity was massive. </span> <span class="line" data-startTime="586">Once per second. 10 megabytes of garbage was </span><span class="line" data-startTime="590">being collected. And so you want to ask yourself, </span><span class="line" data-startTime="590">"Is 10 megabytes per second of garbage expected?" </span><span class="line" data-startTime="596">Because in some applications, this might be </span><span class="line" data-startTime="596">&mdash; that might be a reasonable amount of garbage. </span> <span class="line" data-startTime="601">In this case, it's not. </span> <span class="line" data-startTime="601">They should be generating almost no garbage </span><span class="line" data-startTime="606">per second. And that was what the developers' </span><span class="line" data-startTime="606">expectations were. So something really strange </span><span class="line" data-startTime="610">was happening and we really needed to figure </span><span class="line" data-startTime="610">it out. So to help us come up with suspects, </span><span class="line" data-startTime="617">we need to understand what triggers a garbage </span><span class="line" data-startTime="617">collection, because if we're seeing a correlation </span><span class="line" data-startTime="623">with a performance drop with garbage collection, </span><span class="line" data-startTime="623">we have to understand why garbage collection </span><span class="line" data-startTime="628">happens. </span> <span class="line" data-startTime="628">So let's walk through V8 memory management </span><span class="line" data-startTime="637">in a bit more detail and walk through a GC </span><span class="line" data-startTime="637">pause. </span> <span class="line" data-startTime="642">So to help understand the performance characteristics </span><span class="line" data-startTime="642">of a GC pause, we have to understand where </span><span class="line" data-startTime="647">the cost in allocated memory comes from, and </span><span class="line" data-startTime="647">it's not in allocating the memory itself. </span> <span class="line" data-startTime="652">That's actually really cheap. It's incredibly </span><span class="line" data-startTime="652">fast to allocate memory in V8. </span></p>

<p><span class="line" data-startTime="657">The performance problem &mdash; the cost of allocating </span><span class="line" data-startTime="657">memory actually comes after a while you've </span><span class="line" data-startTime="662">allocated enough objects and you've actually </span><span class="line" data-startTime="662">exhausted the memory pool. </span> <span class="line" data-startTime="666">So at that point the V8 runtime is forced </span><span class="line" data-startTime="666">to run a garbage collection and this can take </span><span class="line" data-startTime="671">milliseconds. And if we remember, like you </span><span class="line" data-startTime="671">have 16 milliseconds to get through the entire </span><span class="line" data-startTime="675">frame. You spend 5 of it doing a GC, you've </span><span class="line" data-startTime="675">lost your frame. You cannot recover from that. </span> <span class="line" data-startTime="684">So V8 manages memory in a generational split. </span> <span class="line" data-startTime="684">So values are split between young and old </span><span class="line" data-startTime="688">and their age is actually kind of estimated </span><span class="line" data-startTime="688">based on the number of garbage collections </span><span class="line" data-startTime="692">in which they survive. </span> <span class="line" data-startTime="692">So as an object lives through collections, </span><span class="line" data-startTime="697">it gets older. </span> <span class="line" data-startTime="697">And over time, the older values are promoted </span><span class="line" data-startTime="701">from the young generation to the old generation. </span></p>

<p><span class="line" data-startTime="701">So the young generation offers really fast </span><span class="line" data-startTime="708">allocation, which I've already stated. Collection </span><span class="line" data-startTime="708">is fast in relation to the cost of an old </span><span class="line" data-startTime="714">generation collection. And it's frequently </span><span class="line" data-startTime="714">collected. When you're using the Chrome DevTools </span><span class="line" data-startTime="719">Timeline panel and you see a GC event, as </span><span class="line" data-startTime="719">you can see on the slide here that's the young </span><span class="line" data-startTime="726">generation being collected. </span> <span class="line" data-startTime="726">In contrast, the old generation offers fast </span><span class="line" data-startTime="732">allocation, but relative to young generation, </span><span class="line" data-startTime="732">the collection is slower. Luckily, though, </span><span class="line" data-startTime="737">it happens infrequently. </span> <span class="line" data-startTime="737">And part of that collection actually runs </span><span class="line" data-startTime="741">concurrently with the mutator, which is your </span><span class="line" data-startTime="741">JavaScript thread. It does some incremental </span><span class="line" data-startTime="745">marking and there's a few different types </span><span class="line" data-startTime="745">of collections that can occur in the old generation, </span><span class="line" data-startTime="749">but typically when you've &mdash; when you see </span><span class="line" data-startTime="749">a frame drop in your game or, you know, you </span><span class="line" data-startTime="754">see weird scrolling behavior and it's a GC </span><span class="line" data-startTime="754">problem, it's the young generation. So let's </span><span class="line" data-startTime="759">really focus on that. </span> <span class="line" data-startTime="759">So why is collecting the young generation </span><span class="line" data-startTime="765">so much faster? Well, to help you understand </span><span class="line" data-startTime="765">that, you have to &mdash; you have to kind of intuitively </span><span class="line" data-startTime="769">understand the cost of a GC is proportional </span><span class="line" data-startTime="769">to the number of live objects. So the number </span><span class="line" data-startTime="774">of objects which survive the GC is how you </span><span class="line" data-startTime="774">can estimate how long this GC's going to take. </span></p>

<p><span class="line" data-startTime="780">So because we split the objects into two generations, </span><span class="line" data-startTime="780">the young and the old, the young kind of, </span><span class="line" data-startTime="786">by definition, has a very high death rate. </span> <span class="line" data-startTime="786">Very few objects survive many young generation </span><span class="line" data-startTime="793">collections. You know, in contrast, old generation </span><span class="line" data-startTime="793">by the very nature of what's in the old generation, </span><span class="line" data-startTime="798">these objects have lived for a long time so </span><span class="line" data-startTime="798">you can't expect that, hey, let's do an old </span><span class="line" data-startTime="803">generation collection, they're probably all </span><span class="line" data-startTime="803">now garbage. That doesn't make a lot of sense </span><span class="line" data-startTime="806">because they've historically lived for a long </span><span class="line" data-startTime="806">time inside your program. </span> <span class="line" data-startTime="813">So let's look at how the young generation </span><span class="line" data-startTime="813">actually operates. So the young generation </span><span class="line" data-startTime="817">is split into two semi-spaces equally sized, </span><span class="line" data-startTime="817">the to space and the from space. </span> <span class="line" data-startTime="823">Values are allocated from the to space, so </span><span class="line" data-startTime="823">when your JavaScript executes a new statement, </span><span class="line" data-startTime="828">new foo, it pulls some memory from the to </span><span class="line" data-startTime="828">space. The from space is used during GC and </span><span class="line" data-startTime="833">we'll get to that shortly. </span> <span class="line" data-startTime="833">So assuming that we started with an empty </span><span class="line" data-startTime="837">to space, it's all full of unallocated memory, </span><span class="line" data-startTime="837">page allocates Object A and then Object B, </span><span class="line" data-startTime="843">and then C, and D. Everything up until this </span><span class="line" data-startTime="843">point is great. Things are really humming </span><span class="line" data-startTime="848">along. </span></p>

<p><span class="line" data-startTime="848">But unfortunately the page then tries to allocate </span><span class="line" data-startTime="851">Object E. Now, at this point we've actually </span><span class="line" data-startTime="851">exhausted the amount of memory in the young </span><span class="line" data-startTime="856">generation and we cannot do this. </span> <span class="line" data-startTime="856">So things back up a little bit. Object E wasn't </span><span class="line" data-startTime="862">allocated because there just wasn't room for </span><span class="line" data-startTime="862">it. The page is paused. Everything stops. </span> <span class="line" data-startTime="866">The rendering stops like exactly at that line </span><span class="line" data-startTime="866">of code where you called new. Everything pauses. </span> <span class="line" data-startTime="873">A collection gets triggered. So the first </span><span class="line" data-startTime="873">thing in a collection is that the from and </span><span class="line" data-startTime="877">the to space, they're just swapped. The labels </span><span class="line" data-startTime="877">are swapped. The old from space, which is </span><span class="line" data-startTime="881">empty, becomes the new to space. </span></p>

<p><span class="line" data-startTime="881">The next stage is that all the live values </span><span class="line" data-startTime="887">inside the young generation are discovered. </span> <span class="line" data-startTime="887">These are marked and the next step is to copy </span><span class="line" data-startTime="895">them. And this is where a lot of the time </span><span class="line" data-startTime="895">is actually spent. It's in this copy. And </span><span class="line" data-startTime="897">this is what &mdash; when I said earlier that the </span><span class="line" data-startTime="897">cost of the GC is proportional to the number </span><span class="line" data-startTime="901">of objects which survive, you have to copy </span><span class="line" data-startTime="901">these objects across from one space to the </span><span class="line" data-startTime="906">other, and this is where a lot of that time </span><span class="line" data-startTime="906">goes. </span> <span class="line" data-startTime="909">So in this example, A and C survived and we've </span><span class="line" data-startTime="909">copied them to the new to space and here we </span><span class="line" data-startTime="915">go. The page can resume and allocate Object </span><span class="line" data-startTime="915">E. </span> <span class="line" data-startTime="925">So what you intuitively have to understand </span><span class="line" data-startTime="925">is that each allocation moves you closer to </span><span class="line" data-startTime="929">this pause. So if you're dealing with a &mdash; you </span><span class="line" data-startTime="929">know, something where timing really matters, </span><span class="line" data-startTime="935">you almost want to operate under the assumption </span><span class="line" data-startTime="935">that you cannot allocate memory. You want </span><span class="line" data-startTime="940">to kind of preallocate everything ahead of </span><span class="line" data-startTime="940">time. </span></p>

<p><span class="line" data-startTime="943">Because the collection completely pauses your </span><span class="line" data-startTime="943">application, and this brings higher latency, </span><span class="line" data-startTime="947">so just imagine that a user clicks a button </span><span class="line" data-startTime="947">and then right then inside your click handler </span><span class="line" data-startTime="952">you allocate some new object. Boom, you've </span><span class="line" data-startTime="952">hit the GC pause and like these are actually </span><span class="line" data-startTime="956">fields. Like "Hey, I clicked," and there's </span><span class="line" data-startTime="956">just this moment where nothing is happening </span><span class="line" data-startTime="960">and it offers a bad user experience. In games, </span><span class="line" data-startTime="960">you get dropped frames. You know, ultimately </span><span class="line" data-startTime="965">this just leads to unhappy users who may not </span><span class="line" data-startTime="965">come back to your site. </span> <span class="line" data-startTime="977">So now that we understand what happens in </span><span class="line" data-startTime="977">a GC pause and how you get to a GC pause, </span><span class="line" data-startTime="982">it's time to start looking at some suspects. </span></p>

<p><span class="line" data-startTime="982">And we've got these sneaky guys right here </span><span class="line" data-startTime="987">&mdash; blue, red, and green &mdash; who are incognito. </span> <span class="line" data-startTime="987">So the first suspect is pretty &mdash; you know, </span><span class="line" data-startTime="995">this should really jump to your mind at this </span><span class="line" data-startTime="995">point &mdash; is just calling new. Maybe Oz is </span><span class="line" data-startTime="1000">calling new all the time and they're just </span><span class="line" data-startTime="1000">like allocating all of these objects throughout </span><span class="line" data-startTime="1003">the frame and then, like, they're triggering </span><span class="line" data-startTime="1003">the GC pause and they haven't retained references </span><span class="line" data-startTime="1008">to any of these objects, so they're all just </span><span class="line" data-startTime="1008">garbage and it gets collected and that's where </span><span class="line" data-startTime="1011">that 10 megs come from. </span> <span class="line" data-startTime="1011">So a careful audit of the code base confirmed </span><span class="line" data-startTime="1016">that there was no calls to new within the </span><span class="line" data-startTime="1016">frame. And actually unit9 said that would </span><span class="line" data-startTime="1020">have been really embarrassing, and this goes </span><span class="line" data-startTime="1020">back to them being &mdash; they're following the </span><span class="line" data-startTime="1023">best practices. They're well aware of what </span><span class="line" data-startTime="1023">they should and shouldn't be doing inside </span><span class="line" data-startTime="1026">their game. </span></p>

<p><span class="line" data-startTime="1026">So suspect Number 2 is code running in unoptimized </span><span class="line" data-startTime="1034">mode. And let's talk about why this is a suspect. </span> <span class="line" data-startTime="1034">If we look at JavaScript on the slide, we </span><span class="line" data-startTime="1040">can see that there is some computation and </span><span class="line" data-startTime="1040">they calculate A and B and C and then they </span><span class="line" data-startTime="1045">do some multiplication and update the X position </span><span class="line" data-startTime="1045">of some sprite in the game. </span> <span class="line" data-startTime="1054">So in unoptimized mode, there is actually </span><span class="line" data-startTime="1054">a lot of implicit memory allocations. Why </span><span class="line" data-startTime="1058">we don't see any calls to new on the slide, </span><span class="line" data-startTime="1058">there is actually behind the scenes many calls </span><span class="line" data-startTime="1063">to new or their equivalent. </span></p>

<p><span class="line" data-startTime="1063">So, when we calculate P times D, a new object </span><span class="line" data-startTime="1070">is allocated. Similarly, for C plus 3 and </span><span class="line" data-startTime="1070">3.3 times dt, new objects are being allocated </span><span class="line" data-startTime="1077">at each one of these points. It is not clear </span><span class="line" data-startTime="1077">to you as a developer when you are looking </span><span class="line" data-startTime="1080">at the code, but this is actually what's happening </span><span class="line" data-startTime="1080">behind the scenes. </span> <span class="line" data-startTime="1083">And then even when we calculate A times B, </span><span class="line" data-startTime="1083">it is not assigned anywhere; but, still, memory </span><span class="line" data-startTime="1089">is reserved for the result. </span> <span class="line" data-startTime="1089">And then the result there is multiplied with </span><span class="line" data-startTime="1093">C. More memory is allocated. </span> <span class="line" data-startTime="1093">In contrast, if this function was running </span><span class="line" data-startTime="1100">in optimized mode, there would actually only </span><span class="line" data-startTime="1100">be a single memory allocation and that's what </span><span class="line" data-startTime="1105">the final result is assigned to the field </span><span class="line" data-startTime="1105">inside the object. </span></p>

<p><span class="line" data-startTime="1109">You can see that there is a huge difference </span><span class="line" data-startTime="1109">between the amount of memory that is churned </span><span class="line" data-startTime="1113">through in unoptimized mode compared to optimized </span><span class="line" data-startTime="1113">mode. </span> <span class="line" data-startTime="1119">And actually V8 recently optimized for this </span><span class="line" data-startTime="1119">case so only the first time that X is updated </span><span class="line" data-startTime="1126">will memory be allocated. So it has got even </span><span class="line" data-startTime="1126">better. </span> <span class="line" data-startTime="1134">So let's walk through, like, how you transition </span><span class="line" data-startTime="1134">between unoptimized mode and optimized mode </span><span class="line" data-startTime="1138">and exactly kind of what's the state machine </span><span class="line" data-startTime="1138">under the hood. </span> <span class="line" data-startTime="1143">So all code starts off unoptimized. The first </span><span class="line" data-startTime="1143">time your function runs, it is always going </span><span class="line" data-startTime="1148">to be unoptimized. That's fine. After a little </span><span class="line" data-startTime="1148">while though, V8 will say, Hey, this function </span><span class="line" data-startTime="1152">is actually pretty hot, meaning it is executing </span><span class="line" data-startTime="1152">a lot. And it is going to attempt to optimize </span><span class="line" data-startTime="1159">that function. So it is going to transition </span><span class="line" data-startTime="1159">from the unoptimized state to the optimized </span><span class="line" data-startTime="1163">state. But as is kind of natural in JavaScript, </span><span class="line" data-startTime="1163">there is occasionally some deoptimization </span><span class="line" data-startTime="1168">events. Some assumption that was baked into </span><span class="line" data-startTime="1168">the optimization has been violated so then </span><span class="line" data-startTime="1174">the function gets kicked back over to the </span><span class="line" data-startTime="1174">unoptimized state. </span></p>

<p><span class="line" data-startTime="1178">This is actually okay. This kind of naturally </span><span class="line" data-startTime="1178">happens throughout JavaScript's execution </span><span class="line" data-startTime="1183">lifetime. And then, again, after a little </span><span class="line" data-startTime="1183">while, V8 says, You know what? I have got </span><span class="line" data-startTime="1187">some better information with this function. </span> <span class="line" data-startTime="1187">It is still pretty hot. Let me try to optimize </span><span class="line" data-startTime="1190">it in a better way so we can handle both of </span><span class="line" data-startTime="1190">the cases that we've seen so far. </span> <span class="line" data-startTime="1196">Unfortunately, what happens is that after </span><span class="line" data-startTime="1196">too many de-optimizations, your function actually </span><span class="line" data-startTime="1202">just gets sent down to unoptimized hell and </span><span class="line" data-startTime="1202">you never get to escape. Like, once you are </span><span class="line" data-startTime="1206">in this place, that's it, you are always going </span><span class="line" data-startTime="1206">to run in unoptimized mode. </span> <span class="line" data-startTime="1211">There are also other ways to get into unoptimized </span><span class="line" data-startTime="1211">hell. You can use certain code constructs. </span> <span class="line" data-startTime="1217">We will see an example in a little bit. But </span><span class="line" data-startTime="1217">if your function has a try catch block in </span><span class="line" data-startTime="1222">it, V8 today just doesn't optimize for that. </span> <span class="line" data-startTime="1222">So right away as soon as the function is seen </span><span class="line" data-startTime="1227">by V8, it just gets slotted into, you know, </span><span class="line" data-startTime="1227">permanently unoptimized state and it is just </span><span class="line" data-startTime="1232">going to sit there. </span> <span class="line" data-startTime="1232">These constructs could be optimized for, but </span><span class="line" data-startTime="1236">it just hasn't been a priority up to this </span><span class="line" data-startTime="1236">point. </span></p>

<p><span class="line" data-startTime="1241">So we've definitely got a potential suspect </span><span class="line" data-startTime="1241">here. It's possible that some code inside </span><span class="line" data-startTime="1246">Oz is running in unoptimized mode. And, you </span><span class="line" data-startTime="1246">know, there actually is no way to surface </span><span class="line" data-startTime="1252">this using Chrome DevTools. You can't figure </span><span class="line" data-startTime="1252">out just looking inside the dev panel, Hey, </span><span class="line" data-startTime="1256">this function is unoptimized. Let's fix it. </span> <span class="line" data-startTime="1256">So we have a potential suspect. </span> <span class="line" data-startTime="1261">So the third suspect is a common JavaScript </span><span class="line" data-startTime="1261">performance strap and that's actually modifying </span><span class="line" data-startTime="1266">object shape. So if we &mdash; V8 behind the scenes </span><span class="line" data-startTime="1266">creates these hidden classes for objects. </span></p>

<p><span class="line" data-startTime="1273">So the point constructor assigns the X field </span><span class="line" data-startTime="1273">and then the Y field. And that &mdash; that order, </span><span class="line" data-startTime="1278">the sequence of assigning the fields in the </span><span class="line" data-startTime="1278">constructor generates the class ID. So A little </span><span class="line" data-startTime="1283">bit later on after constructing P, somewhere </span><span class="line" data-startTime="1283">in the program, someone just adds a new field </span><span class="line" data-startTime="1290">to the P object, which is completely fine </span><span class="line" data-startTime="1290">inside JavaScript. </span> <span class="line" data-startTime="1293">But that new field inside P, that instance, </span><span class="line" data-startTime="1293">creates a new class ID. So this is going to </span><span class="line" data-startTime="1300">trigger a deoptimization. </span> <span class="line" data-startTime="1300">So let's walk through kind of what happens. </span> <span class="line" data-startTime="1307">This calls back to that state machine we were </span><span class="line" data-startTime="1307">just looking at. So at first we see this point </span><span class="line" data-startTime="1311">object, the class ID for it. And code is running </span><span class="line" data-startTime="1311">in unoptimized state because it is the beginning </span><span class="line" data-startTime="1316">of execution and that's expected. </span> <span class="line" data-startTime="1316">So after a little bit of time, V8 detects </span><span class="line" data-startTime="1320">that some functions using point are hot and </span><span class="line" data-startTime="1320">let's optimize for them. But then the shape </span><span class="line" data-startTime="1328">is modified. And this point prime class is </span><span class="line" data-startTime="1328">created. </span> <span class="line" data-startTime="1331">So now there's two point classes kind of floating </span><span class="line" data-startTime="1331">around inside the internal state of V8. There's </span><span class="line" data-startTime="1336">point with XY and there is point with XYZ. </span></p>

<p><span class="line" data-startTime="1336">So the next time a call site sees this point </span><span class="line" data-startTime="1343">prime class when it is expecting a point class, </span><span class="line" data-startTime="1343">it actually de-optimizes and we go across </span><span class="line" data-startTime="1347">that graph back to the unoptimized state. </span> <span class="line" data-startTime="1347">But after a little while, the code is optimized </span><span class="line" data-startTime="1354">to support both point and point prime classes. </span> <span class="line" data-startTime="1354">So, again, a careful audit confirmed there </span><span class="line" data-startTime="1362">were no shape changes. This is a really common </span><span class="line" data-startTime="1362">JavaScript performance trap. And, again, the </span><span class="line" data-startTime="1366">unit9 guys were really well-read. So it is </span><span class="line" data-startTime="1366">not surprising that this was not the problem. </span> <span class="line" data-startTime="1373">And in some ways, suspect Number 3 is a special </span><span class="line" data-startTime="1373">case of suspect Number 2. </span></p>

<p><span class="line" data-startTime="1379">So suspect Number 1, calling new, its alibi, </span><span class="line" data-startTime="1379">wasn't even at the crime scene. No one was </span><span class="line" data-startTime="1383">doing that. </span> <span class="line" data-startTime="1383">Suspect Number 2 has no alibi. So it seems </span><span class="line" data-startTime="1387">like a pretty likely suspect at this point. </span> <span class="line" data-startTime="1387">And the third one, suspect Number 3, shape </span><span class="line" data-startTime="1391">change, again, not at the crime scene so we </span><span class="line" data-startTime="1391">are really narrowing in. It really seems likely </span><span class="line" data-startTime="1395">that a big chunk of code is running in unoptimized </span><span class="line" data-startTime="1395">mode. And now we need to get to the lab and </span><span class="line" data-startTime="1400">prove this. </span> <span class="line" data-startTime="1400">So there is a lot of tools that you can use </span><span class="line" data-startTime="1406">to help diagnose and really dig into performance </span><span class="line" data-startTime="1406">problems. </span> <span class="line" data-startTime="1409">First is Chrome DevTools. And that's the panel </span><span class="line" data-startTime="1409">that you can bring up inside Chrome, and it </span><span class="line" data-startTime="1413">ships with Chrome. But this is a real performance </span><span class="line" data-startTime="1413">mystery, so we're just going to jump right </span><span class="line" data-startTime="1418">past it. We are already past Chrome DevTools. </span> <span class="line" data-startTime="1418">The next is about tracing. And this is a really </span><span class="line" data-startTime="1423">great tool for diagnosing the internal GPU </span><span class="line" data-startTime="1423">state inside Chrome and some other really </span><span class="line" data-startTime="1429">low-level information. But, again, like, we're </span><span class="line" data-startTime="1429">past this. This is a really strange performance </span><span class="line" data-startTime="1434">problem. </span></p>

<p><span class="line" data-startTime="1434">So we've got to jump right down to the nitty-gritty. </span> <span class="line" data-startTime="1439">We have got to go to the V8 tools. The V8 </span><span class="line" data-startTime="1439">tools actually ship with V8 source code. So </span><span class="line" data-startTime="1444">if you want to use these tools, you have to </span><span class="line" data-startTime="1444">go to Google code and grab V8 and compile </span><span class="line" data-startTime="1448">it and then you get access to these tools. </span> <span class="line" data-startTime="1448">As we will see, these tools were necessary </span><span class="line" data-startTime="1453">to diagnose this performance problem. </span> <span class="line" data-startTime="1453">So what we want to do is we want to confirm </span><span class="line" data-startTime="1459">that unoptimized code is running and then </span><span class="line" data-startTime="1459">determine why that code isn't being optimized. </span> <span class="line" data-startTime="1466">So the first thing we want to do is we want </span><span class="line" data-startTime="1466">to capture a V8 timeline. And the way you </span><span class="line" data-startTime="1470">do that is you run Chrome with this crazy </span><span class="line" data-startTime="1470">command line flag, Chrome, no Sandbox, JS </span><span class="line" data-startTime="1476">flags, prof, noprof2-lazy, log-timer events. </span> <span class="line" data-startTime="1476">Kind of strange but it gives you a lot of </span><span class="line" data-startTime="1481">really good information. </span></p>

<p><span class="line" data-startTime="1481">So after running Chrome with this and you </span><span class="line" data-startTime="1486">run your site for a little while, you close </span><span class="line" data-startTime="1486">it down. Inside the directory that you launched </span><span class="line" data-startTime="1489">Chrome from will be a v8.logfile. This is </span><span class="line" data-startTime="1489">a text file which you are free to open up </span><span class="line" data-startTime="1493">and look inside but it is a little bit cryptic. </span> <span class="line" data-startTime="1493">So V8 ships with some tools that will parse </span><span class="line" data-startTime="1498">this logfile and generate really useful information </span><span class="line" data-startTime="1498">for you. </span> <span class="line" data-startTime="1504">So after running plot timer events on the </span><span class="line" data-startTime="1504">log, you are going to get a PNG that actually </span><span class="line" data-startTime="1509">shows you a big timeline of the state of V8 </span><span class="line" data-startTime="1509">and what's happening. So let's kind of walk </span><span class="line" data-startTime="1514">through what's in this diagram here. </span> <span class="line" data-startTime="1514">So along the left-hand side are rows representing </span><span class="line" data-startTime="1523">different states that V8 is executing in. </span></p>

<p><span class="line" data-startTime="1523">And you will see a colored vertical tick whenever </span><span class="line" data-startTime="1528">V8 is in that state. So along the top is some </span><span class="line" data-startTime="1528">different garbage collector states. And I </span><span class="line" data-startTime="1534">have arrowed out the scavenger, and that's </span><span class="line" data-startTime="1534">the young generation collection. </span> <span class="line" data-startTime="1539">Along the bottom there, you can see the V8.execute </span><span class="line" data-startTime="1539">state and that's when it is executing script </span><span class="line" data-startTime="1544">code. You will see, though, where the blue </span><span class="line" data-startTime="1544">line for the scavenger, you can actually see </span><span class="line" data-startTime="1549">that there is a blank spot on the execute. </span> <span class="line" data-startTime="1549">And this fits with our understanding of the </span><span class="line" data-startTime="1554">way GC works. When GC is active, your script </span><span class="line" data-startTime="1554">isn't executing. </span> <span class="line" data-startTime="1561">So along the middle is this colored band showing </span><span class="line" data-startTime="1561">you the code kind. And this is really helpful </span><span class="line" data-startTime="1567">because we suspect that we're running some </span><span class="line" data-startTime="1567">unoptimized code and looking at the timeline. </span> <span class="line" data-startTime="1572">It really does look like we are. </span> <span class="line" data-startTime="1572">So the bright green is optimized code. So </span><span class="line" data-startTime="1576">when you see that across, you know that everything </span><span class="line" data-startTime="1576">executing across those ticks is optimized. </span> <span class="line" data-startTime="1582">What we see in the graph is we see this blue-purply </span><span class="line" data-startTime="1582">kind of color, and this is unoptimized code. </span> <span class="line" data-startTime="1588">And it is executing in different stubs and </span><span class="line" data-startTime="1588">different runtime methods inside V8. </span> <span class="line" data-startTime="1593">So it looks like our hunch was correct and </span><span class="line" data-startTime="1593">that we are executing some unoptimized code. </span></p>

<p><span class="line" data-startTime="1600">So if we look at the transition where we switch </span><span class="line" data-startTime="1600">from running optimized code to unoptimized </span><span class="line" data-startTime="1606">code, it might be difficult to see on the </span><span class="line" data-startTime="1606">slides because that's a little bit blown out. </span> <span class="line" data-startTime="1610">But you can actually see that there is a whole </span><span class="line" data-startTime="1610">bunch of scavenges across that time slice. </span> <span class="line" data-startTime="1615">You can actually see there are little gaps </span><span class="line" data-startTime="1615">in the execution that fit perfectly with when </span><span class="line" data-startTime="1619">these scavengers were occurring. </span> <span class="line" data-startTime="1619">So here we are. Oz is running smoothly. And </span><span class="line" data-startTime="1623">then we are at that one-second mark and it </span><span class="line" data-startTime="1623">hiccups down and it starts running unoptimized </span><span class="line" data-startTime="1627">code for some reason. And we can see that </span><span class="line" data-startTime="1627">there is all these scavenges, and this fits </span><span class="line" data-startTime="1631">exactly with what we saw inside Chrome DevTools. </span> <span class="line" data-startTime="1631">Another really helpful piece of information </span><span class="line" data-startTime="1638">inside the timeline is this graph along the </span><span class="line" data-startTime="1638">bottom. And this is the pause times graph. </span></p>

<p><span class="line" data-startTime="1643">So you can see at the beginning, there is </span><span class="line" data-startTime="1643">actually a whole bunch of pause times. You </span><span class="line" data-startTime="1646">can see these black vertical bars sticking </span><span class="line" data-startTime="1646">up on the bottom on the left-hand side. That's </span><span class="line" data-startTime="1650">when it is parsing the script, and it is actually </span><span class="line" data-startTime="1650">just getting going. </span> <span class="line" data-startTime="1653">And then we're in optimized function time. </span> <span class="line" data-startTime="1653">You don't see any pause times there. It is </span><span class="line" data-startTime="1658">just this flat curve. </span> <span class="line" data-startTime="1658">And then right when we transition into running </span><span class="line" data-startTime="1662">unoptimized code and we see all these scavenges, </span><span class="line" data-startTime="1662">we also see correlated spikes in pause times. </span> <span class="line" data-startTime="1668">So you can see that the scripts have stopped </span><span class="line" data-startTime="1668">executing right when the scavenges occur, </span><span class="line" data-startTime="1673">right when we transition to unoptimized code. </span> <span class="line" data-startTime="1673">So now we need to figure out what function </span><span class="line" data-startTime="1679">is that? I mean, we've confirmed that there's </span><span class="line" data-startTime="1679">unoptimized code running. But we really have </span><span class="line" data-startTime="1683">to nail down who is responsible for it. </span> <span class="line" data-startTime="1683">So, again, we run Chrome with the same command </span><span class="line" data-startTime="1688">line flags but this time we take the V8 log </span><span class="line" data-startTime="1688">and we run the Mac tick processor. And so </span><span class="line" data-startTime="1693">when you download V8 and you build it, you </span><span class="line" data-startTime="1693">are going to get a tick processor for whatever </span><span class="line" data-startTime="1698">platform you build it on. So there is a Windows </span><span class="line" data-startTime="1698">one, a Linux one. In this case, we are on </span><span class="line" data-startTime="1702">a Mac so we will run the Mac tick processor. </span></p>

<p><span class="line" data-startTime="1702">When you run that on the V8 log, you actually </span><span class="line" data-startTime="1706">get this nice helpful table of functions sorted </span><span class="line" data-startTime="1706">by how frequently they're seen by the profiler. </span> <span class="line" data-startTime="1715">So next to drawsprites, you see this asterisk; </span><span class="line" data-startTime="1715">and that indicates that the function in question </span><span class="line" data-startTime="1721">is optimized. But if we look at the top, this </span><span class="line" data-startTime="1721">is the function that is running the most &mdash; most </span><span class="line" data-startTime="1727">often in the profile capture. Updatesprites </span><span class="line" data-startTime="1727">doesn't have a asterisk next to it. So this </span><span class="line" data-startTime="1732">seems like the likely culprit here. Something </span><span class="line" data-startTime="1732">in updatesprites is causing it not to be optimized. </span> <span class="line" data-startTime="1739">And so let's try to figure out what's going </span><span class="line" data-startTime="1739">on. </span></p>

<p><span class="line" data-startTime="1743">So, how can we determine why a function is </span><span class="line" data-startTime="1743">not optimized? This is actually where it gets </span><span class="line" data-startTime="1748">a little hairy. You run Chrome with a different </span><span class="line" data-startTime="1748">set of flags you run with trace deopt and </span><span class="line" data-startTime="1753">trace opt verbose. </span> <span class="line" data-startTime="1753">What happens is actually a lot of text just </span><span class="line" data-startTime="1757">gets dumped to the terminal that you launched </span><span class="line" data-startTime="1757">Chrome from. It is just this wall of text. </span> <span class="line" data-startTime="1761">You likely want to pipe it to a text file </span><span class="line" data-startTime="1761">and look at it later on. </span> <span class="line" data-startTime="1765">But digging through that, we looked for updatesprites </span><span class="line" data-startTime="1765">and we actually found that, Hey, here's this </span><span class="line" data-startTime="1770">line that says "disabled optimization for </span><span class="line" data-startTime="1770">updatesprites, reason: Forinstatement is not </span><span class="line" data-startTime="1776">the fast case." </span><span class="line" data-startTime="1776">It seems kind of cryptic at this point, but </span><span class="line" data-startTime="1779">I think when we look at the source code of </span><span class="line" data-startTime="1779">updatesprites, we might get a better idea </span><span class="line" data-startTime="1783">of what's going on. </span> <span class="line" data-startTime="1783">So, here's equivalent of the problem code </span><span class="line" data-startTime="1794">in Oz. We have this function updatesprites. </span> <span class="line" data-startTime="1794">And it just iterates using a for-in loop across </span><span class="line" data-startTime="1801">the sprites array. And then inside of this </span><span class="line" data-startTime="1801">loop, it just does a bunch of arithmetic. </span> <span class="line" data-startTime="1806">And if we remember earlier, when you are running </span><span class="line" data-startTime="1806">in unoptimized mode and you are performing </span><span class="line" data-startTime="1810">arithmetic, you actually are allocating all </span><span class="line" data-startTime="1810">of these objects, like, just for temporary </span><span class="line" data-startTime="1814">values that aren't being stored anywhere. </span></p>

<p><span class="line" data-startTime="1814">And here we see this for-in statement. And </span><span class="line" data-startTime="1822">this function was not being optimized specifically </span><span class="line" data-startTime="1822">because of this loop construct. </span> <span class="line" data-startTime="1826">And earlier when I was showing you the diagram </span><span class="line" data-startTime="1826">of the different states that your functions </span><span class="line" data-startTime="1831">can be in inside V8, there is way to get into </span><span class="line" data-startTime="1831">unoptimized hell by just using a code construct </span><span class="line" data-startTime="1836">that V8 doesn't optimize for today. It is </span><span class="line" data-startTime="1836">not that V8 can't optimize for it, but it </span><span class="line" data-startTime="1841">just hasn't yet. </span> <span class="line" data-startTime="1841">So this seems like we've kind of found our </span><span class="line" data-startTime="1846">suspect here. It is this single line of code, </span><span class="line" data-startTime="1846">is triggering V8 to say, You know what? I </span><span class="line" data-startTime="1851">can't optimize this. I will just treat it </span><span class="line" data-startTime="1851">as an unoptimized function. </span> <span class="line" data-startTime="1854">We couldn't really have this. So, ah, yes, </span><span class="line" data-startTime="1854">arithmetic has implicit allocations. </span> <span class="line" data-startTime="1862">So the fix is actually really simple. You </span><span class="line" data-startTime="1862">just move the arithmetic into its own function </span><span class="line" data-startTime="1867">and this function doesn't have the forinstatement </span><span class="line" data-startTime="1867">so it can actually be optimized by V8. </span> <span class="line" data-startTime="1874">And we can leave that for-in loop inside the </span><span class="line" data-startTime="1874">unoptimized function and just call the updatesprite </span><span class="line" data-startTime="1879">method. </span></p>

<p><span class="line" data-startTime="1879">So if we look at the memory of such graph </span><span class="line" data-startTime="1884">before and after, we can see a really clear </span><span class="line" data-startTime="1884">difference. We're no longer seeing this huge </span><span class="line" data-startTime="1890">sawtooth spike up and then come down with </span><span class="line" data-startTime="1890">a GC. We are seeing a nice, natural growth </span><span class="line" data-startTime="1895">curve which &mdash; which you want to see. </span> <span class="line" data-startTime="1895">So case closed, right? I mean, we figured </span><span class="line" data-startTime="1902">it out. But, actually, the GC pause time was </span><span class="line" data-startTime="1902">a bit of a red herring because the real performance </span><span class="line" data-startTime="1907">problem was that all this arithmetic was executing </span><span class="line" data-startTime="1907">in unoptimized mode. That's just significantly </span><span class="line" data-startTime="1913">slower. </span> <span class="line" data-startTime="1913">So, the GC pause time actually led us to fixing </span><span class="line" data-startTime="1917">the problem but it wasn't the problem in itself. </span> <span class="line" data-startTime="1917">But it was a really, really simple fix. I </span><span class="line" data-startTime="1924">mean, you saw how simple it was. Just move </span><span class="line" data-startTime="1924">the loop body into its own function. It was </span><span class="line" data-startTime="1928">great. </span> <span class="line" data-startTime="1928">But what was really helpful and what I hope </span><span class="line" data-startTime="1931">you can take away from this talk is that unit9, </span><span class="line" data-startTime="1931">the developers who built Oz, they understood </span><span class="line" data-startTime="1937">how to look under the hood. They understood </span><span class="line" data-startTime="1937">how to pull out all this information and surface </span><span class="line" data-startTime="1941">these signals inside V8. And they on their </span><span class="line" data-startTime="1941">own without the help of the V8 team were able </span><span class="line" data-startTime="1946">to go and identify many other functions which </span><span class="line" data-startTime="1946">would have got stuck in deoptimization hell </span><span class="line" data-startTime="1951">and just generally improved the performance </span><span class="line" data-startTime="1951">of their code. </span></p>

<p><span class="line" data-startTime="1958">So in conclusion, V8 offers three tools. There's </span><span class="line" data-startTime="1958">the timeline plot tool which is this bird's </span><span class="line" data-startTime="1964">eye view of V8 activity. There is the tick </span><span class="line" data-startTime="1964">processor, which is going to give you a table </span><span class="line" data-startTime="1970">of hot functions. And, remember, there is </span><span class="line" data-startTime="1970">a asterisk next to the functions which are </span><span class="line" data-startTime="1974">optimized. If you are running into a similar </span><span class="line" data-startTime="1974">problem, you are going to want to look for </span><span class="line" data-startTime="1979">functions that lack the asterisk. </span> <span class="line" data-startTime="1979">And then the deoptimization log. This actually </span><span class="line" data-startTime="1983">gives you deep insight into the optimization </span><span class="line" data-startTime="1983">state machine that we looked at previously. </span> <span class="line" data-startTime="1990">So, solving a performance problem is just </span><span class="line" data-startTime="1990">like solving a crime in real life. You first </span><span class="line" data-startTime="1996">have to start with evidence collection. And </span><span class="line" data-startTime="1996">it is really important to ask the right questions </span><span class="line" data-startTime="2000">because you might start going down the path </span><span class="line" data-startTime="2000">that leads you to no performance improvement. </span> <span class="line" data-startTime="2007">After you've collected the right set of evidence, </span><span class="line" data-startTime="2007">you move on to suspects. You try and narrow </span><span class="line" data-startTime="2011">it down to a few likely culprits. And then </span><span class="line" data-startTime="2011">after interrogating your suspects, you want </span><span class="line" data-startTime="2017">to move on to the forensics lab and use these </span><span class="line" data-startTime="2017">tools to prove your case. </span> <span class="line" data-startTime="2021">So, of course, you want to start with Chrome </span><span class="line" data-startTime="2021">DevTools and then maybe about tracing before </span><span class="line" data-startTime="2026">you get to V8. But sometimes these performance </span><span class="line" data-startTime="2026">problems are so mysterious that the only way </span><span class="line" data-startTime="2031">that you're going to be able to solve them </span><span class="line" data-startTime="2031">is by using these tools that we just covered. </span> <span class="line" data-startTime="2038">So thank you. </span></p>

<p><span class="line" data-startTime="2038">[ Applause ] </span><span class="line" data-startTime="2043">So don't forget to check out perf alley. And </span><span class="line" data-startTime="2043">we have a few minutes for questions. But afterwards, </span><span class="line" data-startTime="2054">I will be up doing some Chrome office hours </span><span class="line" data-startTime="2054">upstairs. If you have any questions, please </span><span class="line" data-startTime="2060">come to the mic. </span></p>

<p class="speaker"><span class="line" data-starttime="2060"><span class="speakerName">Audience member</span>: Hi. So I'm curious if I used &mdash; if I had </span><span class="line" data-startTime="2066">used a closure compiler to compile my JavaScript, </span><span class="line" data-startTime="2066">does it automatically figure out that these </span><span class="line" data-startTime="2071">constructs could lead to unoptimized code </span><span class="line" data-startTime="2071">and remove them? Or what happens? </span></p>

<p class="speaker"><span class="line" data-starttime="2076"><span class="speakerName">John McCutchan</span>: That's actually a good question </span><span class="line" data-startTime="2076">for the closure team. </span></p>

<p class="speaker"><span class="line" data-starttime="2079"><span class="speakerName">Audience member</span>: Uh-huh. </span></p>

<p class="speaker"><span class="line" data-starttime="2079"><span class="speakerName">John McCutchan</span>: But I would hope that some </span><span class="line" data-startTime="2082">constructs they are aware are slower. Of course, </span><span class="line" data-startTime="2082">it varies over which JavaScript engine is </span><span class="line" data-startTime="2088">executing the code. </span></p>

<p class="speaker"><span class="line" data-starttime="2088"><span class="speakerName">Audience member</span>: Okay. </span></p>

<p class="speaker"><span class="line" data-starttime="2089"><span class="speakerName">John McCutchan</span>: Everyone has a slightly </span><span class="line" data-startTime="2089">different performance profile. </span></p>

<p class="speaker"><span class="line" data-starttime="2091"><span class="speakerName">Audience member</span>: I mean, is there some or any static analysis, </span><span class="line" data-startTime="2091">some kind of tool I could put my JavaScript </span><span class="line" data-startTime="2096">into to tell me when I'm using constructs </span><span class="line" data-startTime="2096">like this? Because it seems like this you </span><span class="line" data-startTime="2101">could have caught very easily without actually </span><span class="line" data-startTime="2101">running it, right? </span></p>

<p class="speaker"><span class="line" data-starttime="2104"><span class="speakerName">John McCutchan</span>: Well, in some sense, yeah, </span><span class="line" data-startTime="2104">it does kind of seem that way. You will note </span><span class="line" data-startTime="2108">that the message was actually &mdash; the forinstatement </span><span class="line" data-startTime="2108">is not the fast case. So the fact that it </span><span class="line" data-startTime="2113">couldn't be optimized really depended on the </span><span class="line" data-startTime="2113">runtime behavior. </span><span class="line" data-startTime="2116">But I agree, it would be nice to have a static </span><span class="line" data-startTime="2116">analysis tool that was kept current with JavaScript </span><span class="line" data-startTime="2121">engines because this is always changing. So </span><span class="line" data-startTime="2121">you wouldn't want to have a tool that's a </span><span class="line" data-startTime="2125">year old because some of the advice might </span><span class="line" data-startTime="2125">just be wrong. </span></p>

<p class="speaker"><span class="line" data-starttime="2128"><span class="speakerName">Audience member</span>: Right, okay. Cool. </span></p>

<p class="speaker"><span class="line" data-starttime="2128"><span class="speakerName">Audience member</span>: Hi, I'm James Harding. I was wondering, </span><span class="line" data-startTime="2134">is there a way that you can tell V8 you are </span><span class="line" data-startTime="2134">going to allocate a bunch of objects, especially </span><span class="line" data-startTime="2138">like if a user goes to a page where, like, </span><span class="line" data-startTime="2138">the developer, like, we know that there's </span><span class="line" data-startTime="2142">going to be thousands of objects that are </span><span class="line" data-startTime="2142">going to be allocated when they visit that </span><span class="line" data-startTime="2146">page, is there any way to sort of optimize </span><span class="line" data-startTime="2146">that? </span></p>

<p class="speaker"><span class="line" data-starttime="2148"><span class="speakerName">John McCutchan</span>: There is no way to tell </span><span class="line" data-startTime="2148">V8, hey, I'm going to allocate thousands of </span><span class="line" data-startTime="2152">objects, don't do any GC. What you could do </span><span class="line" data-startTime="2152">is at that initial &mdash; when the page is first </span><span class="line" data-startTime="2158">loading and the scripts are first executing, </span><span class="line" data-startTime="2158">you can preallocate a lot of these objects </span><span class="line" data-startTime="2161">and then keep them around. </span></p>

<p class="speaker"><span class="line" data-starttime="2161"><span class="speakerName">Audience member</span>: Okay, thank you. </span></p>

<p class="speaker"><span class="line" data-starttime="2166"><span class="speakerName">Audience member</span>: So this kind of goes back to the first </span><span class="line" data-startTime="2166">question. You said that static tools probably </span><span class="line" data-startTime="2171">wouldn't be good because, I mean, the advice </span><span class="line" data-startTime="2171">changes, right? I mean, the engine changes </span><span class="line" data-startTime="2175">and what was good before is no longer good. </span><span class="line" data-startTime="2175">But I see that same problem with something </span><span class="line" data-startTime="2179">like this, right? Like, you make that change </span><span class="line" data-startTime="2179">now, but that change that you made now is </span><span class="line" data-startTime="2184">no longer good in the future? Right? Because </span><span class="line" data-startTime="2184">this changes a lot, like the V8 engine. </span></p>

<p class="speaker"><span class="line" data-starttime="2189"><span class="speakerName">John McCutchan</span>: Yeah, so it does. But what </span><span class="line" data-startTime="2189">I'm trying to get across here is how to use </span><span class="line" data-startTime="2192">these tools to uncover any performance problem. </span></p>

<p class="speaker"><span class="line" data-starttime="2192"><span class="speakerName">Audience member</span>: Yeah. </span></p>

<p class="speaker"><span class="line" data-starttime="2195"><span class="speakerName">John McCutchan</span>: Not just highlight this </span><span class="line" data-startTime="2195">for-in loop. </span></p>

<p class="speaker"><span class="line" data-starttime="2198"><span class="speakerName">Audience member</span>: Right. Do you think that V8 &mdash; I don't </span><span class="line" data-startTime="2198">know how to say this &mdash; is stable enough to, </span><span class="line" data-startTime="2205">like, justify that? Because, I mean, I wouldn't </span><span class="line" data-startTime="2205">want to do something like this, which is quite </span><span class="line" data-startTime="2208">a bit of investment, to have, like, two months </span><span class="line" data-startTime="2208">later, like &mdash; I don't know a lot about V8. </span><span class="line" data-startTime="2215">Do you think it is stable enough that this </span><span class="line" data-startTime="2215">kind of investment is worth it? </span></p>

<p class="speaker"><span class="line" data-starttime="2218"><span class="speakerName">John McCutchan</span>: Well, again, this work was </span><span class="line" data-startTime="2218">done because the performance was bad already. </span></p>

<p class="speaker"><span class="line" data-starttime="2223"><span class="speakerName">Audience member</span>: Uh-huh. </span></p>

<p class="speaker"><span class="line" data-starttime="2223"><span class="speakerName">John McCutchan</span>: So, I mean, that's the first </span><span class="line" data-startTime="2225">question you should ask yourself, is: Are </span><span class="line" data-startTime="2225">things performing fine? In which case, you </span><span class="line" data-startTime="2229">should stop, because great, there is no problem. </span><span class="line" data-startTime="2229">But V8 does change a lot. But I wouldn't expect </span><span class="line" data-startTime="2235">V8 to take something that once ran fast and </span><span class="line" data-startTime="2235">make it run slow. </span></p>

<p class="speaker"><span class="line" data-starttime="2240"><span class="speakerName">Audience member</span>: Okay. Thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="2240"><span class="speakerName">Audience member</span>: Hi. I'm (saying name) from LinkedIn Mobile. </span><span class="line" data-startTime="2247">I'm curious, what are you guys doing with </span><span class="line" data-startTime="2247">the Chrome DevTools to help bring better some </span><span class="line" data-startTime="2253">of the P analysis and performance analysis </span><span class="line" data-startTime="2253">to node GAS? Because right now there's a lot </span><span class="line" data-startTime="2258">of community projects out there that kind </span><span class="line" data-startTime="2258">of attempt to do that. </span><span class="line" data-startTime="2260">It would really be nice if there was a Google-blessed </span><span class="line" data-startTime="2260">way of profiling V8 in node GAS for long-running </span><span class="line" data-startTime="2265">processes in memory management. </span></p>

<p class="speaker"><span class="line" data-starttime="2265"><span class="speakerName">John McCutchan</span>: That would be nice, but </span><span class="line" data-startTime="2268">I'm not the right person to ask that question. </span><span class="line" data-startTime="2268">I think it would be great, too. We have a </span><span class="line" data-startTime="2273">question at the back microphone now. </span></p>

<p class="speaker"><span class="line" data-starttime="2273"><span class="speakerName">Audience member</span>: Yeah. So these tools look really cool. </span><span class="line" data-startTime="2277">I would like to use them. I don't particularly </span><span class="line" data-startTime="2277">want to download V8 to do so. Do you know </span><span class="line" data-startTime="2281">if there are any plans to source this sort </span><span class="line" data-startTime="2281">of information in Chrome? It seems like it </span><span class="line" data-startTime="2284">would be useful to Chrome &mdash; </span><span class="line" data-startTime="2284">[ Multiple people speaking simultaneously </span><span class="line" data-startTime="2285">] </span></p>

<p class="speaker"><span class="line" data-starttime="2285"><span class="speakerName">John McCutchan</span>: There is discussions about </span><span class="line" data-startTime="2287">how we can surface some of these signals into </span><span class="line" data-startTime="2287">Chrome DevTools or maybe about tracing so </span><span class="line" data-startTime="2292">you don't have to go and grab the V8 source </span><span class="line" data-startTime="2292">code. </span><span class="line" data-startTime="2295">But it's going to be kind of like this &mdash; it </span><span class="line" data-startTime="2295">is going to be a continuous transition so </span><span class="line" data-startTime="2301">you could still get into situations where, </span><span class="line" data-startTime="2301">you know, we've surfaced a whole bunch of </span><span class="line" data-startTime="2305">signals but you still need to go and grab </span><span class="line" data-startTime="2305">the tools to find that one signal that we </span><span class="line" data-startTime="2309">haven't surfaced yet. But yeah. We're aware </span><span class="line" data-startTime="2309">of the desire to have this stuff come up into </span><span class="line" data-startTime="2314">DevTools. </span><span class="line" data-startTime="2314">All right. Thank you. </span><span class="line" data-startTime="2318">[ Applause ] </span></p></div>