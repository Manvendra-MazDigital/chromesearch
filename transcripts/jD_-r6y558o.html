<p class="speaker"><span class="line" data-starttime="3"><span class="speakerName">Ryan Fioravanti</span>: I'm going </span><span class="line" data-startTime="3">to get started now. </span> <span class="line" data-startTime="4">Welcome everyone. </span> <span class="line" data-startTime="6">My name is Ryan Fioravanti. </span> <span class="line" data-startTime="8">I'm here today from the Gmail </span><span class="line" data-startTime="8">team to talk about building </span><span class="line" data-startTime="10">fast mobile web apps. </span> <span class="line" data-startTime="12">And if you'd like to follow </span><span class="line" data-startTime="12">along on your laptop or </span><span class="line" data-startTime="14">device, the URL is up here. </span> <span class="line" data-startTime="16">You can see the slides at </span><span class="line" data-startTime="17">rjf-io2012.appspot.com OK. </span> <span class="line" data-startTime="26">Everyone loves fast stuff, </span><span class="line" data-startTime="26">especially users. </span> <span class="line" data-startTime="29">And developers like building </span><span class="line" data-startTime="29">fast things. </span> <span class="line" data-startTime="32">Unfortunately, on the mobile </span><span class="line" data-startTime="32">web, it's really </span><span class="line" data-startTime="34">difficult to do. </span> <span class="line" data-startTime="36">Today I'm going to try and </span><span class="line" data-startTime="36">present a few things that I </span><span class="line" data-startTime="38">hope you can use to help </span><span class="line" data-startTime="38">build faster mobile web </span><span class="line" data-startTime="42">applications. </span> <span class="line" data-startTime="45">When I start looking at </span><span class="line" data-startTime="45">performance work, I like to </span><span class="line" data-startTime="47">approach things in a very </span><span class="line" data-startTime="47">structured manner. </span> <span class="line" data-startTime="51">What that means for me is before </span><span class="line" data-startTime="51">I start working on some </span><span class="line" data-startTime="53">improvements, I like to measure </span><span class="line" data-startTime="53">first to prove myself </span><span class="line" data-startTime="57">that there's actually </span><span class="line" data-startTime="57">a problem that </span><span class="line" data-startTime="58">I'm trying to solve. </span></p>

<p><span class="line" data-startTime="60">As I start working on the </span><span class="line" data-startTime="60">problem, I then remeasure </span><span class="line" data-startTime="63">throughout the process to make </span><span class="line" data-startTime="63">sure that I'm making progress </span><span class="line" data-startTime="66">in a way that I'm happy with. </span> <span class="line" data-startTime="68">And finally, when I think I'm </span><span class="line" data-startTime="68">done, I'll measure again to </span><span class="line" data-startTime="72">see that I actually had impact </span><span class="line" data-startTime="72">I thought I would. </span> <span class="line" data-startTime="74">And if I didn't find an </span><span class="line" data-startTime="74">improvement, I think it's </span><span class="line" data-startTime="76">really important in those </span><span class="line" data-startTime="76">cases to investigate and </span><span class="line" data-startTime="79">figure out why the work that I </span><span class="line" data-startTime="79">did didn't have the impact </span><span class="line" data-startTime="82">that I thought it would. </span> <span class="line" data-startTime="84">I seen a lot of people spend a </span><span class="line" data-startTime="84">lot of time trying to make </span><span class="line" data-startTime="86">performance optimizations based </span><span class="line" data-startTime="86">off hunches they have or </span><span class="line" data-startTime="90">ideas, and they spend </span><span class="line" data-startTime="90">a lot of time. </span></p>

<p><span class="line" data-startTime="92">When they're done, it </span><span class="line" data-startTime="92">ends up having no </span><span class="line" data-startTime="94">impact for the users. </span> <span class="line" data-startTime="95">And there's no benefit. </span> <span class="line" data-startTime="98">So we want to avoid these </span><span class="line" data-startTime="98">kinds of situations. </span> <span class="line" data-startTime="101">With this kind of thinking in </span><span class="line" data-startTime="101">mind, this kind of approach, I </span><span class="line" data-startTime="103">decided to structure this </span><span class="line" data-startTime="103">presentation today around a </span><span class="line" data-startTime="107">live website. </span> <span class="line" data-startTime="109">So I decided to pick on </span><span class="line" data-startTime="111">html5rocks.com, the mobile version. </span> <span class="line" data-startTime="114">And what we're going to do </span><span class="line" data-startTime="114">is do a little bit of </span><span class="line" data-startTime="116">exploration, a little bit of </span><span class="line" data-startTime="116">measurements, to try to </span><span class="line" data-startTime="118">identify what kind of problems </span><span class="line" data-startTime="118">it has, and what kind of fixes </span><span class="line" data-startTime="122">we can make and how much </span><span class="line" data-startTime="122">we can improve this. </span> <span class="line" data-startTime="126">So before we start working on </span><span class="line" data-startTime="126">improvements, we first have to </span><span class="line" data-startTime="129">measure to figure out what's </span><span class="line" data-startTime="129">actually wrong. </span></p>

<p><span class="line" data-startTime="132">The best way to do that is by </span><span class="line" data-startTime="132">using a device to do all these </span><span class="line" data-startTime="136">measurements for us. </span> <span class="line" data-startTime="138">Now that you all have Chrome on </span><span class="line" data-startTime="138">an Android device, this is </span><span class="line" data-startTime="140">really easy for you to do. </span> <span class="line" data-startTime="142">And Chrome on Android comes </span><span class="line" data-startTime="142">with a really neat feature </span><span class="line" data-startTime="144">where you can use the remote </span><span class="line" data-startTime="144">debugger to do profiling on </span><span class="line" data-startTime="147">the device itself. </span> <span class="line" data-startTime="149">And this is really useful, </span><span class="line" data-startTime="149">because profiling on your </span><span class="line" data-startTime="151">local desktop browser, for </span><span class="line" data-startTime="151">example, is not at all the </span><span class="line" data-startTime="155">same as profiling on </span><span class="line" data-startTime="155">your mobile device. </span> <span class="line" data-startTime="158">The hardware's very different. </span></p>

<p><span class="line" data-startTime="159">The performance is </span><span class="line" data-startTime="159">really different. </span> <span class="line" data-startTime="160">And so we really need </span><span class="line" data-startTime="160">to do all this </span><span class="line" data-startTime="162">profiling on a mobile device. </span> <span class="line" data-startTime="164">We're also going to install the </span><span class="line" data-startTime="164">PageSpeed extension, and </span><span class="line" data-startTime="167">this is going to help us run </span><span class="line" data-startTime="167">a bunch of automated </span><span class="line" data-startTime="170">analysis on the page. </span> <span class="line" data-startTime="172">And hopefully we can get some </span><span class="line" data-startTime="172">quick wins based on its </span><span class="line" data-startTime="174">recommendations. </span> <span class="line" data-startTime="179">OK, before we get started out </span><span class="line" data-startTime="179">with PageSpeed or anything </span><span class="line" data-startTime="181">else, we need to define </span><span class="line" data-startTime="181">our success criteria. </span> <span class="line" data-startTime="185">So to do that, we need an </span><span class="line" data-startTime="185">accurate way to make some </span><span class="line" data-startTime="188">measurements and figure </span><span class="line" data-startTime="188">out if we're </span><span class="line" data-startTime="189">actually improving anything. </span> <span class="line" data-startTime="192">Typically this has been </span><span class="line" data-startTime="192">done in a couple </span><span class="line" data-startTime="194">of ways in the past. </span> <span class="line" data-startTime="195">One of the most common ways that </span><span class="line" data-startTime="195">developers would profile </span><span class="line" data-startTime="197">their application or do </span><span class="line" data-startTime="197">measurements for performance </span><span class="line" data-startTime="201">timings, was to add timings in </span><span class="line" data-startTime="201">script blocks for the page. </span></p>

<p><span class="line" data-startTime="205">So it was really common to see </span><span class="line" data-startTime="205">people add a script block at </span><span class="line" data-startTime="207">the top of the document where </span><span class="line" data-startTime="207">they would take a time. </span> <span class="line" data-startTime="210">And that would be time zero. </span> <span class="line" data-startTime="211">And then they would have timing </span><span class="line" data-startTime="211">throughout the page, </span><span class="line" data-startTime="213">which they could then use the </span><span class="line" data-startTime="213">deltas of to decide how long </span><span class="line" data-startTime="216">certain parts of the page took </span><span class="line" data-startTime="216">for the browser to render. </span> <span class="line" data-startTime="222">There's a couple of </span><span class="line" data-startTime="222">problems with this </span><span class="line" data-startTime="224">that we want to avoid. </span> <span class="line" data-startTime="225">Number one, just by adding these </span><span class="line" data-startTime="225">measurements to your </span><span class="line" data-startTime="227">page, you can actually have </span><span class="line" data-startTime="227">a negative impact on the </span><span class="line" data-startTime="230">browser's performance. </span> <span class="line" data-startTime="231">So just by measuring and looking </span><span class="line" data-startTime="231">at it, you're changing </span><span class="line" data-startTime="233">the situation. </span></p>

<p><span class="line" data-startTime="234">So we want to avoid that. </span> <span class="line" data-startTime="236">But also, using this technique, </span><span class="line" data-startTime="236">we were only able </span><span class="line" data-startTime="238">to measure things that were </span><span class="line" data-startTime="238">happening in the browser after </span><span class="line" data-startTime="242">the browser has received </span><span class="line" data-startTime="242">the page content. </span> <span class="line" data-startTime="244">We didn't have access to things </span><span class="line" data-startTime="244">like, how long did a </span><span class="line" data-startTime="247">redirect take? </span><span class="line" data-startTime="247">How long did the DNS </span><span class="line" data-startTime="247">lookups take? </span><span class="line" data-startTime="249">How long did the page take to </span><span class="line" data-startTime="249">download from first byte to </span><span class="line" data-startTime="253">the last byte being </span><span class="line" data-startTime="253">sent to the page? </span><span class="line" data-startTime="256">Using this </span><span class="line" data-startTime="256">window.performance.timing </span><span class="line" data-startTime="258">object, we're able to </span><span class="line" data-startTime="258">capture all that </span><span class="line" data-startTime="260">information really easily. </span> <span class="line" data-startTime="261">This is an object that's </span><span class="line" data-startTime="261">injected by the browser on </span><span class="line" data-startTime="264">every page load, and it contains </span><span class="line" data-startTime="264">a lot of different </span><span class="line" data-startTime="267">attributes that we can </span><span class="line" data-startTime="267">use to analyze the </span><span class="line" data-startTime="269">full pageload sequence. </span></p>

<p><span class="line" data-startTime="271">So this is really cool. </span> <span class="line" data-startTime="272">And we're going to use this in </span><span class="line" data-startTime="272">a bunch of experiments that </span><span class="line" data-startTime="275">we're going to do throughout </span><span class="line" data-startTime="275">this presentation. </span> <span class="line" data-startTime="278">The ones I found particularly </span><span class="line" data-startTime="278">interesting from the </span><span class="line" data-startTime="281">experiments I was running </span><span class="line" data-startTime="281">were these four. </span> <span class="line" data-startTime="284">So first of all, the most </span><span class="line" data-startTime="284">important one is </span><span class="line" data-startTime="285">navigationStart timing. </span> <span class="line" data-startTime="287">This is the exact time that </span><span class="line" data-startTime="287">the user requested for the </span><span class="line" data-startTime="290">page to be loaded. </span> <span class="line" data-startTime="291">So this is them clicking a link </span><span class="line" data-startTime="291">to go to your page, or </span><span class="line" data-startTime="295">typing in the URL, or </span><span class="line" data-startTime="295">opening a bookmark. </span> <span class="line" data-startTime="298">From the user's perspective, </span><span class="line" data-startTime="298">this is time zero, and </span><span class="line" data-startTime="301">everything after this time is </span><span class="line" data-startTime="301">them sitting there staring at </span><span class="line" data-startTime="303">a white screen, waiting for </span><span class="line" data-startTime="303">your content to appear. </span></p>

<p><span class="line" data-startTime="307">The responseStart event was </span><span class="line" data-startTime="307">the second one that was </span><span class="line" data-startTime="310">interesting to me. </span> <span class="line" data-startTime="311">This one is when the browser has </span><span class="line" data-startTime="311">started receiving content. </span> <span class="line" data-startTime="315">So this is important because </span><span class="line" data-startTime="315">this tells me when the browser </span><span class="line" data-startTime="317">is able to actually </span><span class="line" data-startTime="317">start doing work. </span> <span class="line" data-startTime="319">It's not waiting for the page </span><span class="line" data-startTime="319">to load over the network. </span> <span class="line" data-startTime="321">It can start processing </span><span class="line" data-startTime="321">a document, executing </span><span class="line" data-startTime="323">JavaScript, and evaluating </span><span class="line" data-startTime="323">CSS. </span> <span class="line" data-startTime="327">The next one is this </span><span class="line" data-startTime="327">domContentLoadedEventStart. </span> <span class="line" data-startTime="332">This is basically the </span><span class="line" data-startTime="332">DOMContentReady event. </span> <span class="line" data-startTime="334">And this one is important </span><span class="line" data-startTime="334">because this is when your </span><span class="line" data-startTime="336">document becomes interactive and </span><span class="line" data-startTime="336">can start handling events. </span></p>

<p><span class="line" data-startTime="340">And this is our best </span><span class="line" data-startTime="340">approximation for when the </span><span class="line" data-startTime="343">user actually sees something </span><span class="line" data-startTime="343">on the page. </span> <span class="line" data-startTime="346">And this is important, because </span><span class="line" data-startTime="346">this is the time that for the </span><span class="line" data-startTime="350">start of this that I'm going to </span><span class="line" data-startTime="350">be optimizing for, for when </span><span class="line" data-startTime="352">the browser gets the page to </span><span class="line" data-startTime="352">when the user sees something. </span> <span class="line" data-startTime="354">We want the user to see </span><span class="line" data-startTime="354">something as soon as possible, </span><span class="line" data-startTime="357">because until that point, </span><span class="line" data-startTime="357">they're just staring at a </span><span class="line" data-startTime="359">white screen. </span> <span class="line" data-startTime="360">So DOMContentReady means the </span><span class="line" data-startTime="360">user is no longer staring at a </span><span class="line" data-startTime="362">white screen. </span> <span class="line" data-startTime="364">The load event is the </span><span class="line" data-startTime="364">window load event. </span> <span class="line" data-startTime="368">And this is when the browser's </span><span class="line" data-startTime="368">finished downloading all the </span><span class="line" data-startTime="370">resources on a page, including </span><span class="line" data-startTime="370">the images. </span></p>

<p><span class="line" data-startTime="373">So this is like the final </span><span class="line" data-startTime="373">finish point. </span> <span class="line" data-startTime="378">OK. </span> <span class="line" data-startTime="378">So we had to set up a baseline </span><span class="line" data-startTime="378">for the experiments before we </span><span class="line" data-startTime="381">start making any performance </span><span class="line" data-startTime="381">improvements. </span> <span class="line" data-startTime="383">And this is what </span><span class="line" data-startTime="383">I came up with. </span> <span class="line" data-startTime="385">So the way that I set up my </span><span class="line" data-startTime="385">experiments here is, I created </span><span class="line" data-startTime="388">a local copy of html5rocks.com, </span><span class="line" data-startTime="388">the mobile </span><span class="line" data-startTime="390">version, and I set up an </span><span class="line" data-startTime="390">experiment where the browser </span><span class="line" data-startTime="393">would reload the page 50 times </span><span class="line" data-startTime="393">and capture the time from </span><span class="line" data-startTime="396">response start to the </span><span class="line" data-startTime="396">DOMContentReady event. </span> <span class="line" data-startTime="399">So what I wanted to optimize </span><span class="line" data-startTime="399">for was just the in-page </span><span class="line" data-startTime="401">rendering, none of the </span><span class="line" data-startTime="401">network stuff. </span> <span class="line" data-startTime="404">Just optimizing how fast we </span><span class="line" data-startTime="404">can show the user their </span><span class="line" data-startTime="407">content and stop staring </span><span class="line" data-startTime="407">at the white screen. </span></p>

<p><span class="line" data-startTime="410">And for this experiment, all </span><span class="line" data-startTime="410">the resources are cache, </span><span class="line" data-startTime="414">running on Nexus S hardware, </span><span class="line" data-startTime="414">and using window.reload to </span><span class="line" data-startTime="419">execute the page reloads. </span> <span class="line" data-startTime="422">So our baseline here is </span><span class="line" data-startTime="422">1,200 milliseconds. </span> <span class="line" data-startTime="424">So 1,200 milliseconds from the </span><span class="line" data-startTime="424">browser getting the first byte </span><span class="line" data-startTime="428">of the document to showing </span><span class="line" data-startTime="428">the user something. </span> <span class="line" data-startTime="430">And so that's what we're trying </span><span class="line" data-startTime="430">to improve on now. </span> <span class="line" data-startTime="432">And also, 812 kilobytes </span><span class="line" data-startTime="432">transferred for the page. </span> <span class="line" data-startTime="438">So the first thing I tried </span><span class="line" data-startTime="438">was PageSpeed. </span> <span class="line" data-startTime="440">So you can just open your Chrome </span><span class="line" data-startTime="440">debugger on the Android </span><span class="line" data-startTime="444">device and open up PageSpeed, </span><span class="line" data-startTime="444">and you can run an analysis. </span> <span class="line" data-startTime="448">So what it told me right away is </span><span class="line" data-startTime="448">hey, you've got some images </span><span class="line" data-startTime="451">that aren't scaled properly. </span> <span class="line" data-startTime="453">So this is a pretty easy fix. </span> <span class="line" data-startTime="454">We just have to scale </span><span class="line" data-startTime="454">the images. </span> <span class="line" data-startTime="456">So I just modified the local </span><span class="line" data-startTime="456">version to serve up images of </span><span class="line" data-startTime="459">the right size. </span></p>

<p><span class="line" data-startTime="460">The images we were serving were </span><span class="line" data-startTime="460">actually way too big. </span> <span class="line" data-startTime="463">They were 369x369 as </span><span class="line" data-startTime="463">opposed to 75x75. </span> <span class="line" data-startTime="467">So a lot of wasted </span><span class="line" data-startTime="467">space there. </span> <span class="line" data-startTime="469">And also, these were avatar </span><span class="line" data-startTime="469">images, people's photographs, </span><span class="line" data-startTime="473">served up as PNGs. </span> <span class="line" data-startTime="478">So I fixed that issue, reran all </span><span class="line" data-startTime="478">my experiments, and these </span><span class="line" data-startTime="480">were the results that I saw. </span> <span class="line" data-startTime="482">We had a 2% improvement in </span><span class="line" data-startTime="482">rendering time of the </span><span class="line" data-startTime="486">responseStart event to the DOM </span><span class="line" data-startTime="486">ContentReady, and we saved </span><span class="line" data-startTime="489">about 67 kilobytes. </span> <span class="line" data-startTime="492">So this isn't actually the </span><span class="line" data-startTime="492">kind of improvement I was </span><span class="line" data-startTime="494">hoping for. </span> <span class="line" data-startTime="494">I thought we were going to be </span><span class="line" data-startTime="494">able to do much better here. </span> <span class="line" data-startTime="496">Because we're serving up much </span><span class="line" data-startTime="496">smaller images, and I just </span><span class="line" data-startTime="499">assumed that the browser would </span><span class="line" data-startTime="499">be able to render the page </span><span class="line" data-startTime="501">much more quickly. </span></p>

<p><span class="line" data-startTime="502">But that wasn't actually </span><span class="line" data-startTime="502">the case. </span> <span class="line" data-startTime="503">But we did save some </span><span class="line" data-startTime="503">bytes, so that's </span><span class="line" data-startTime="505">good for users' bandwidth. </span> <span class="line" data-startTime="507">So at least we have that. </span> <span class="line" data-startTime="509">The next thing I realized is, </span><span class="line" data-startTime="509">hey, these are avatars. </span> <span class="line" data-startTime="511">We shouldn't be serving </span><span class="line" data-startTime="511">them up as PNGs. </span> <span class="line" data-startTime="512">We should be using JPEG. </span> <span class="line" data-startTime="514">And with JPEG, we can get much </span><span class="line" data-startTime="514">better compression as well. </span> <span class="line" data-startTime="517">So I change the JPEGs and </span><span class="line" data-startTime="517">I remeasured everything. </span> <span class="line" data-startTime="522">Here we have another 2% </span><span class="line" data-startTime="522">improvement in rendering time. </span> <span class="line" data-startTime="524">We're still talking only about </span><span class="line" data-startTime="524">tens of milliseconds saved. </span></p>

<p><span class="line" data-startTime="528">So this isn't really anything </span><span class="line" data-startTime="528">to get excited about yet. </span> <span class="line" data-startTime="530">But we did save another large </span><span class="line" data-startTime="530">chunk of the payload size. </span> <span class="line" data-startTime="535">We saved over 300 milliseconds </span><span class="line" data-startTime="535">here, which is a 44% </span><span class="line" data-startTime="538">improvement in the </span><span class="line" data-startTime="538">download size. </span> <span class="line" data-startTime="540">So when the resources aren't </span><span class="line" data-startTime="540">cached, the page is going to </span><span class="line" data-startTime="543">load faster, and we're going </span><span class="line" data-startTime="543">to be using less </span><span class="line" data-startTime="545">bandwidth for the users. </span> <span class="line" data-startTime="547">So again, no big improvement in </span><span class="line" data-startTime="547">rendering time, but still a </span><span class="line" data-startTime="550">really useful optimization </span><span class="line" data-startTime="550">for us to have made. </span> <span class="line" data-startTime="555">Back to PageSpeed. </span> <span class="line" data-startTime="556">It's now happy with </span><span class="line" data-startTime="556">the scaled images. </span></p>

<p><span class="line" data-startTime="557">And it's telling us, now you've </span><span class="line" data-startTime="557">got to minify some </span><span class="line" data-startTime="560">JavaScript. </span> <span class="line" data-startTime="561">So that's also a pretty </span><span class="line" data-startTime="561">easy fix. </span> <span class="line" data-startTime="564">I opened up the network trace, </span><span class="line" data-startTime="564">just to kind of see what </span><span class="line" data-startTime="566">resources it was loading, and </span><span class="line" data-startTime="566">I found that the page was </span><span class="line" data-startTime="569">including the full version </span><span class="line" data-startTime="569">of jQuery. </span> <span class="line" data-startTime="571">So that's an easy fix. </span> <span class="line" data-startTime="574">I just opened it up, saw that </span><span class="line" data-startTime="574">it's actually the full </span><span class="line" data-startTime="576">version, and then we can just </span><span class="line" data-startTime="576">swap that out with a minified </span><span class="line" data-startTime="580">version, save a bunch </span><span class="line" data-startTime="580">of bytes. </span></p>

<p><span class="line" data-startTime="583">The page functionality </span><span class="line" data-startTime="583">remains the same. </span> <span class="line" data-startTime="585">This is a really easy fix to </span><span class="line" data-startTime="585">make because it won't actually </span><span class="line" data-startTime="587">change anything. </span> <span class="line" data-startTime="589">And then we can remeasure. </span> <span class="line" data-startTime="591">This is the one that surprised </span><span class="line" data-startTime="591">me the most, because here, we </span><span class="line" data-startTime="594">significantly reduced the amount </span><span class="line" data-startTime="594">of JavaScript, but we </span><span class="line" data-startTime="597">didn't actually improve the </span><span class="line" data-startTime="597">rendering time at all. </span> <span class="line" data-startTime="600">The rendering time remained </span><span class="line" data-startTime="600">constant from the last set of </span><span class="line" data-startTime="602">experiments. </span> <span class="line" data-startTime="604">So that's not good. </span> <span class="line" data-startTime="605">But again, we saved some bytes, </span><span class="line" data-startTime="605">so we should do this. </span> <span class="line" data-startTime="607">It's the right thing to do. </span> <span class="line" data-startTime="608">It'll be faster when the </span><span class="line" data-startTime="608">resources aren't cached, and </span><span class="line" data-startTime="610">that's good. </span> <span class="line" data-startTime="612">So I said that we should always </span><span class="line" data-startTime="612">measure before and </span><span class="line" data-startTime="615">after, so that's what </span><span class="line" data-startTime="615">I did here. </span> <span class="line" data-startTime="616">And if it doesn't match the </span><span class="line" data-startTime="616">results that you expected, we </span><span class="line" data-startTime="619">should figure out why. </span> <span class="line" data-startTime="621">So this is one that really </span><span class="line" data-startTime="621">surprised me. </span> <span class="line" data-startTime="623">And I figured out the answer, </span><span class="line" data-startTime="623">and I'm going to show you that </span><span class="line" data-startTime="627">a bit later. </span> <span class="line" data-startTime="629">So when you need to minify, this </span><span class="line" data-startTime="629">is something you should </span><span class="line" data-startTime="632">definitely do to save </span><span class="line" data-startTime="632">bytes over the wire. </span></p>

<p><span class="line" data-startTime="635">If you're using a third-party </span><span class="line" data-startTime="635">library, just make sure you're </span><span class="line" data-startTime="637">pulling in the right version </span><span class="line" data-startTime="637">for your production </span><span class="line" data-startTime="639">environment. </span> <span class="line" data-startTime="640">So you usually want to include </span><span class="line" data-startTime="640">the [? dead ?] version in your </span><span class="line" data-startTime="643">local setup. </span> <span class="line" data-startTime="645">But when you deploy to </span><span class="line" data-startTime="645">production, you should have </span><span class="line" data-startTime="649">some kind of build phase where </span><span class="line" data-startTime="649">you swap it out with the </span><span class="line" data-startTime="650">minified version. </span> <span class="line" data-startTime="651">And that's easy to do. </span> <span class="line" data-startTime="653">If you're writing a lot of </span><span class="line" data-startTime="653">your own JavaScript, then </span><span class="line" data-startTime="654">you're going to have to do </span><span class="line" data-startTime="654">your own minification. </span> <span class="line" data-startTime="657">This is something that </span><span class="line" data-startTime="657">you can also set up </span><span class="line" data-startTime="658">into your build phase. </span> <span class="line" data-startTime="660">There's a couple of tools you </span><span class="line" data-startTime="660">can download as command-line </span><span class="line" data-startTime="663">tools that you can run </span><span class="line" data-startTime="663">on your files. </span> <span class="line" data-startTime="665">You run this tool, and </span><span class="line" data-startTime="665">it spits out the </span><span class="line" data-startTime="667">minified version for you. </span></p>

<p><span class="line" data-startTime="668">Or if you just want to quickly </span><span class="line" data-startTime="668">minify some stuff and you </span><span class="line" data-startTime="670">don't want to download anything </span><span class="line" data-startTime="670">to get this set up, </span><span class="line" data-startTime="672">there's an online version as </span><span class="line" data-startTime="672">well that you can try. </span> <span class="line" data-startTime="674">You just drop some JavaScript </span><span class="line" data-startTime="674">into a text area, click a </span><span class="line" data-startTime="677">button, and then you'll get </span><span class="line" data-startTime="677">the minified version. </span> <span class="line" data-startTime="682">OK. </span> <span class="line" data-startTime="682">So the next thing that </span><span class="line" data-startTime="682">I wanted to try &mdash; </span><span class="line" data-startTime="684">we're done with PageSpeed now. </span> <span class="line" data-startTime="685">We've satisfied all of </span><span class="line" data-startTime="685">its recommendations. </span> <span class="line" data-startTime="687">The next thing that I </span><span class="line" data-startTime="687">wanted to try is to </span><span class="line" data-startTime="689">run some CSS profiling. </span></p>

<p><span class="line" data-startTime="692">So using this, I can take a look </span><span class="line" data-startTime="692">at exactly how expensive </span><span class="line" data-startTime="695">my CSS rendering is for the </span><span class="line" data-startTime="695">browser to execute. </span> <span class="line" data-startTime="699">So to do this, open up your </span><span class="line" data-startTime="699">developer tools on the Android </span><span class="line" data-startTime="702">device, go over to the Profiles </span><span class="line" data-startTime="702">tab, select the CSS </span><span class="line" data-startTime="706">Selector profile, </span><span class="line" data-startTime="706">and click Start. </span> <span class="line" data-startTime="709">And this will start a recording </span><span class="line" data-startTime="709">of how expensive </span><span class="line" data-startTime="711">your CSS is. </span> <span class="line" data-startTime="713">So what I did here </span><span class="line" data-startTime="713">is I did that. </span> <span class="line" data-startTime="714">I clicked start, started </span><span class="line" data-startTime="714">recording, and then reload the </span><span class="line" data-startTime="717">page, and then I stopped </span><span class="line" data-startTime="717">the recording. </span> <span class="line" data-startTime="719">And this tells me how expensive </span><span class="line" data-startTime="719">the CSS is during </span><span class="line" data-startTime="722">the pageload. </span> <span class="line" data-startTime="724">And here's the results. </span> <span class="line" data-startTime="726">So here we get a breakdown of </span><span class="line" data-startTime="726">exactly how expensive every </span><span class="line" data-startTime="729">single CSS rule is in my style </span><span class="line" data-startTime="729">sheets during a pageload. </span></p>

<p><span class="line" data-startTime="733">So it's telling me here, </span><span class="line" data-startTime="733">this rule at the top &mdash; </span><span class="line" data-startTime="735">I've sorted by the total time </span><span class="line" data-startTime="735">taken for each rule &mdash; </span><span class="line" data-startTime="738">the rule at the top is taking </span><span class="line" data-startTime="738">over 50 milliseconds for the </span><span class="line" data-startTime="741">browser to evaluate while </span><span class="line" data-startTime="741">the page is loading. </span> <span class="line" data-startTime="745">This is rendering time that the </span><span class="line" data-startTime="745">browser is spending before </span><span class="line" data-startTime="747">showing the user any content. </span> <span class="line" data-startTime="749">So it's telling me, just by </span><span class="line" data-startTime="749">fixing this rule, I can save </span><span class="line" data-startTime="753">the user 50 milliseconds </span><span class="line" data-startTime="753">in wait time. </span> <span class="line" data-startTime="755">So that's pretty cool. </span></p>

<p><span class="line" data-startTime="756">And there's also a bunch more </span><span class="line" data-startTime="756">rules here that are over 20 </span><span class="line" data-startTime="759">and 30 milliseconds. </span> <span class="line" data-startTime="760">So if I fixed all of those, I'd </span><span class="line" data-startTime="760">be looking at hundreds of </span><span class="line" data-startTime="763">milliseconds in savings. </span> <span class="line" data-startTime="765">So that's something I'm </span><span class="line" data-startTime="765">interested in, so I dug a </span><span class="line" data-startTime="768">little further. </span> <span class="line" data-startTime="769">Before I show exactly what was </span><span class="line" data-startTime="769">wrong, I'll talk a little bit </span><span class="line" data-startTime="773">about what can make CSS </span><span class="line" data-startTime="773">expensive on mobile. </span> <span class="line" data-startTime="778">Mainly, it all boils down to how </span><span class="line" data-startTime="778">many elements is your CSS </span><span class="line" data-startTime="781">selector matching? </span><span class="line" data-startTime="782">So if you're matching all </span><span class="line" data-startTime="782">elements in your document, </span><span class="line" data-startTime="785">that's going to be really </span><span class="line" data-startTime="785">expensive for the </span><span class="line" data-startTime="786">browser to work with. </span></p>

<p><span class="line" data-startTime="789">This is why the universal </span><span class="line" data-startTime="789">selector is so bad on mobile, </span><span class="line" data-startTime="792">because the browser has to apply </span><span class="line" data-startTime="792">that to every element in </span><span class="line" data-startTime="795">your document. </span> <span class="line" data-startTime="797">Also, ancestor rules are </span><span class="line" data-startTime="797">pretty expensive. </span> <span class="line" data-startTime="799">Because when it finds a match </span><span class="line" data-startTime="799">for the right-most element in </span><span class="line" data-startTime="802">the selector, it has to search </span><span class="line" data-startTime="802">the ancestor tree of that </span><span class="line" data-startTime="804">element, further qualifying to </span><span class="line" data-startTime="804">find a match for that rule. </span> <span class="line" data-startTime="810">So what I've got here, this body </span><span class="line" data-startTime="810">* rule &mdash; this is about </span><span class="line" data-startTime="814">the worst CSS rule you </span><span class="line" data-startTime="814">could possibly write. </span> <span class="line" data-startTime="817">This is the universal </span><span class="line" data-startTime="817">selector matching </span><span class="line" data-startTime="819">everything in the document &mdash; </span><span class="line" data-startTime="820">which we already know we </span><span class="line" data-startTime="820">shouldn't do on mobile &mdash; but </span><span class="line" data-startTime="821">also with an ancestor selector </span><span class="line" data-startTime="821">of the body. </span></p>

<p><span class="line" data-startTime="824">So the browser has to enumerate </span><span class="line" data-startTime="824">every single element </span><span class="line" data-startTime="827">in the document, and then search </span><span class="line" data-startTime="827">the ancestor tree of </span><span class="line" data-startTime="829">that element to ensure that it </span><span class="line" data-startTime="829">has an ancestor of type body. </span> <span class="line" data-startTime="834">So this is really expensive, </span><span class="line" data-startTime="834">and it's also wasteful, </span><span class="line" data-startTime="836">because of course every </span><span class="line" data-startTime="836">element's in the body. </span> <span class="line" data-startTime="838">We really don't need to </span><span class="line" data-startTime="838">qualify for this. </span> <span class="line" data-startTime="844">Here's some examples of ways you </span><span class="line" data-startTime="844">can change your CSS from </span><span class="line" data-startTime="848">bad to good for these </span><span class="line" data-startTime="848">different cases. </span> <span class="line" data-startTime="851">So first of all, we know </span><span class="line" data-startTime="851">we want to avoid </span><span class="line" data-startTime="852">the universal selector. </span> <span class="line" data-startTime="855">The way to avoid this is to </span><span class="line" data-startTime="855">just realize that most the </span><span class="line" data-startTime="857">time, you don't actually </span><span class="line" data-startTime="857">need it. </span> <span class="line" data-startTime="859">Say, for example, you want to </span><span class="line" data-startTime="859">apply a consistent font to </span><span class="line" data-startTime="861">your entire document. </span> <span class="line" data-startTime="862">You don't need to use the </span><span class="line" data-startTime="862">universal selector to do that </span><span class="line" data-startTime="864">because CSS has this </span><span class="line" data-startTime="864">cascading nature. </span> <span class="line" data-startTime="868">You just apply the font rule </span><span class="line" data-startTime="868">to your body, and then your </span><span class="line" data-startTime="871">entire document will naturally </span><span class="line" data-startTime="871">inherit that rule. </span></p>

<p><span class="line" data-startTime="874">So that's an easy fix. </span> <span class="line" data-startTime="878">For [? considered ?] </span><span class="line" data-startTime="880">rules, these are pretty standard </span><span class="line" data-startTime="880">rules, the ul li. </span> <span class="line" data-startTime="883">If you want to color all of your </span><span class="line" data-startTime="883">list items blue, that's a </span><span class="line" data-startTime="886">pretty standard way to do </span><span class="line" data-startTime="886">it, when we learn CSS. </span> <span class="line" data-startTime="889">But if you swap that out with </span><span class="line" data-startTime="889">a specific class name called </span><span class="line" data-startTime="893">unordered-list-item that you </span><span class="line" data-startTime="893">manually apply to all of your </span><span class="line" data-startTime="896">li elements in the document </span><span class="line" data-startTime="896">that are children of ul </span><span class="line" data-startTime="898">elements, this will </span><span class="line" data-startTime="898">execute much </span><span class="line" data-startTime="901">faster on mobile hardware. </span> <span class="line" data-startTime="903">And you will see a difference. </span> <span class="line" data-startTime="905">Lastly, don't include CSS rules </span><span class="line" data-startTime="905">that set things that are </span><span class="line" data-startTime="908">default values. </span> <span class="line" data-startTime="910">Like here, I've got div </span><span class="line" data-startTime="910">set to display block. </span></p>

<p><span class="line" data-startTime="913">Just let the browser </span><span class="line" data-startTime="913">figure that out. </span> <span class="line" data-startTime="915">If you're trying to save some </span><span class="line" data-startTime="915">rare user agents that might </span><span class="line" data-startTime="919">have screwed this up, then I </span><span class="line" data-startTime="919">would say, just let most of </span><span class="line" data-startTime="922">your browsers be fast </span><span class="line" data-startTime="922">and let broken </span><span class="line" data-startTime="923">browsers be broken browsers. </span> <span class="line" data-startTime="928">So back to the example, </span><span class="line" data-startTime="928">html5rocks.com, we had that </span><span class="line" data-startTime="930">50-millisecond timing </span><span class="line" data-startTime="930">on one rule. </span> <span class="line" data-startTime="933">It turns out that it was </span><span class="line" data-startTime="933">specifying a default CSS </span><span class="line" data-startTime="937">property, setting the </span><span class="line" data-startTime="937">box sizing of every </span><span class="line" data-startTime="939">element in the document. </span> <span class="line" data-startTime="941">So this one is really easy. </span> <span class="line" data-startTime="942">Because it's a default </span><span class="line" data-startTime="942">property, we </span><span class="line" data-startTime="943">can just remove it. </span> <span class="line" data-startTime="944">The page will have the </span><span class="line" data-startTime="944">same behavior. </span> <span class="line" data-startTime="946">And we can figure out what </span><span class="line" data-startTime="946">kind of impact it had. </span></p>

<p><span class="line" data-startTime="950">So here we go. </span> <span class="line" data-startTime="952">Approximately 50 milliseconds </span><span class="line" data-startTime="952">saved in rendering time. </span> <span class="line" data-startTime="954">That's just about exactly </span><span class="line" data-startTime="954">what we expected. </span> <span class="line" data-startTime="957">That was nice to see. </span> <span class="line" data-startTime="959">I was comforted by this, because </span><span class="line" data-startTime="959">the profiler told me, </span><span class="line" data-startTime="962">when I measured before, that I </span><span class="line" data-startTime="962">would save 50 milliseconds if </span><span class="line" data-startTime="966">I fixed this rule. </span> <span class="line" data-startTime="967">And then when I measured after, </span><span class="line" data-startTime="967">that was confirmed. </span> <span class="line" data-startTime="969">So what this means is that the </span><span class="line" data-startTime="969">profiler is doing an accurate </span><span class="line" data-startTime="971">job of predicting exactly how </span><span class="line" data-startTime="971">much my users will save in </span><span class="line" data-startTime="975">time if I fix those rules. </span> <span class="line" data-startTime="978">So that's good to know. </span> <span class="line" data-startTime="979">So if you are planning on </span><span class="line" data-startTime="979">setting out for a couple of </span><span class="line" data-startTime="982">days or a week to optimize the </span><span class="line" data-startTime="982">CSS on your page, you can be </span><span class="line" data-startTime="985">sure that you should definitely </span><span class="line" data-startTime="985">open up your CSS </span><span class="line" data-startTime="988">profiler and check, are there </span><span class="line" data-startTime="988">actually any problems? </span><span class="line" data-startTime="991">And if not, then you can just </span><span class="line" data-startTime="991">skip that whole process. </span> <span class="line" data-startTime="997">OK. </span></p>

<p><span class="line" data-startTime="997">So what's next? </span><span class="line" data-startTime="1000">Remember what we're </span><span class="line" data-startTime="1000">trying to do here. </span> <span class="line" data-startTime="1002">We want to optimize the time for </span><span class="line" data-startTime="1002">which the user is sitting </span><span class="line" data-startTime="1006">there waiting, looking </span><span class="line" data-startTime="1006">at a white screen. </span> <span class="line" data-startTime="1009">From the time the browser gets </span><span class="line" data-startTime="1009">the page to the time they want </span><span class="line" data-startTime="1012">to see content, we want to get </span><span class="line" data-startTime="1012">rid of everything on that </span><span class="line" data-startTime="1015">critical path. </span> <span class="line" data-startTime="1017">So if we look at the network </span><span class="line" data-startTime="1017">trace in your developer tools, </span><span class="line" data-startTime="1021">you can see exactly when that </span><span class="line" data-startTime="1021">DomReady event is firing. </span> <span class="line" data-startTime="1025">That's the blue line. </span> <span class="line" data-startTime="1027">So this is our approximation </span><span class="line" data-startTime="1027">for when the </span><span class="line" data-startTime="1028">user is seeing content. </span></p>

<p><span class="line" data-startTime="1030">Everything on the left of this </span><span class="line" data-startTime="1030">is just getting in the way. </span> <span class="line" data-startTime="1033">So we need to make sure that </span><span class="line" data-startTime="1033">everything over here is </span><span class="line" data-startTime="1035">something that's critical to </span><span class="line" data-startTime="1035">showing our user content. </span> <span class="line" data-startTime="1039">So here's the first resource. </span> <span class="line" data-startTime="1041">Obviously this is critical. </span> <span class="line" data-startTime="1042">This is the main markup </span><span class="line" data-startTime="1042">of the page. </span> <span class="line" data-startTime="1044">Our CSS is pretty critical. </span> <span class="line" data-startTime="1045">We don't want to show people </span><span class="line" data-startTime="1045">just plain HTML. </span> <span class="line" data-startTime="1049">But then the rest of these are </span><span class="line" data-startTime="1049">all JavaScript files that are </span><span class="line" data-startTime="1051">loading over the network and </span><span class="line" data-startTime="1051">taking time to execute. </span> <span class="line" data-startTime="1056">So on html5rocks.com, this </span><span class="line" data-startTime="1056">is just a plain website. </span> <span class="line" data-startTime="1059">We don't need to include all </span><span class="line" data-startTime="1059">these scripts before we show </span><span class="line" data-startTime="1062">the user something. </span></p>

<p><span class="line" data-startTime="1064">And the problem with these is </span><span class="line" data-startTime="1064">just the presence of the </span><span class="line" data-startTime="1068">scripts on the page that's </span><span class="line" data-startTime="1068">slowing down the </span><span class="line" data-startTime="1070">DOMContentReady event. </span> <span class="line" data-startTime="1072">When you include a script on </span><span class="line" data-startTime="1072">your page, the browser doesn't </span><span class="line" data-startTime="1074">actually know when it should </span><span class="line" data-startTime="1074">do something with it. </span> <span class="line" data-startTime="1078">It doesn't know if you need that </span><span class="line" data-startTime="1078">script immediately, or if </span><span class="line" data-startTime="1080">you just need it 10 </span><span class="line" data-startTime="1080">seconds from now. </span> <span class="line" data-startTime="1082">So what it does is it downloads </span><span class="line" data-startTime="1082">it immediately, </span><span class="line" data-startTime="1085">before doing anything else, </span><span class="line" data-startTime="1085">before it proceeds with the </span><span class="line" data-startTime="1087">rest of your document, </span><span class="line" data-startTime="1087">and then executes </span><span class="line" data-startTime="1089">it right away, too. </span> <span class="line" data-startTime="1092">So in this case, we don't need </span><span class="line" data-startTime="1092">that kind of behavior. </span></p>

<p><span class="line" data-startTime="1095">We can defer this JavaScript </span><span class="line" data-startTime="1095">until later. </span> <span class="line" data-startTime="1098">So we can do something here in </span><span class="line" data-startTime="1098">order to get rid of that. </span> <span class="line" data-startTime="1105">So what we need is a way to </span><span class="line" data-startTime="1105">defer this JavaScript in a </span><span class="line" data-startTime="1107">reliable manner. </span> <span class="line" data-startTime="1109">I looked at a couple </span><span class="line" data-startTime="1109">of ways to do this. </span> <span class="line" data-startTime="1112">First, I tried the </span><span class="line" data-startTime="1112">defer attribute. </span> <span class="line" data-startTime="1114">This didn't work well for me. </span> <span class="line" data-startTime="1115">I tried it and it worked, but </span><span class="line" data-startTime="1115">when I reran my experiments, </span><span class="line" data-startTime="1119">it didn't actually </span><span class="line" data-startTime="1119">help anything. </span></p>

<p><span class="line" data-startTime="1121">When I investigated a little </span><span class="line" data-startTime="1121">deeper to find out what was </span><span class="line" data-startTime="1123">happening, I found a lot of </span><span class="line" data-startTime="1123">resources suggesting that the </span><span class="line" data-startTime="1127">defer attribute is more like a </span><span class="line" data-startTime="1127">suggestion to the browser. </span> <span class="line" data-startTime="1130">So it can defer it if it thinks </span><span class="line" data-startTime="1130">that's a good idea, or </span><span class="line" data-startTime="1132">it'll execute in parallel </span><span class="line" data-startTime="1132">to those idle cycles. </span> <span class="line" data-startTime="1136">I also found a bunch of stuff </span><span class="line" data-startTime="1136">that it's not good </span><span class="line" data-startTime="1138">cross-browser, and </span><span class="line" data-startTime="1138">all this stuff. </span> <span class="line" data-startTime="1140">But the point is, it just </span><span class="line" data-startTime="1140">didn't really work well. </span></p>

<p><span class="line" data-startTime="1142">It didn't speed up the </span><span class="line" data-startTime="1142">page-rendering time. </span> <span class="line" data-startTime="1146">I then looked at async </span><span class="line" data-startTime="1146">attribute, and this had some </span><span class="line" data-startTime="1149">different behavior, where </span><span class="line" data-startTime="1149">it would defer the </span><span class="line" data-startTime="1152">loading of the scripts. </span> <span class="line" data-startTime="1154">But they would load in at any </span><span class="line" data-startTime="1154">order, not necessarily the </span><span class="line" data-startTime="1156">order that you included </span><span class="line" data-startTime="1156">them on the page. </span> <span class="line" data-startTime="1158">So this can lead to some race </span><span class="line" data-startTime="1158">conditions where you get </span><span class="line" data-startTime="1162">JavaScript errors. </span> <span class="line" data-startTime="1164">Say, you have some inline </span><span class="line" data-startTime="1164">script running jQuery </span><span class="line" data-startTime="1166">functions before the jQuery </span><span class="line" data-startTime="1166">file gets loaded. </span> <span class="line" data-startTime="1170">Then that's not going </span><span class="line" data-startTime="1170">to work properly. </span> <span class="line" data-startTime="1174">So what I did is, I cooked up </span><span class="line" data-startTime="1174">a way you can include a </span><span class="line" data-startTime="1177">special type on your script </span><span class="line" data-startTime="1177">attribute that tricks the </span><span class="line" data-startTime="1180">browser into thinking that </span><span class="line" data-startTime="1180">this isn't actually </span><span class="line" data-startTime="1182">JavaScript. </span></p>

<p><span class="line" data-startTime="1183">So what we have here, is I've </span><span class="line" data-startTime="1183">just stamped all these script </span><span class="line" data-startTime="1185">elements with a special </span><span class="line" data-startTime="1185">type called notJs. </span> <span class="line" data-startTime="1188">And so now these scripts will </span><span class="line" data-startTime="1188">actually download over the </span><span class="line" data-startTime="1190">network, but the browser will </span><span class="line" data-startTime="1190">just pass over these and not </span><span class="line" data-startTime="1193">do anything with it, because </span><span class="line" data-startTime="1193">it doesn't know what it is. </span> <span class="line" data-startTime="1198">And then when you want to load </span><span class="line" data-startTime="1198">these scripts, you can just </span><span class="line" data-startTime="1200">include this simple bit </span><span class="line" data-startTime="1200">of script here. </span> <span class="line" data-startTime="1202">What this does is it loads all </span><span class="line" data-startTime="1202">the scripts in the document, </span><span class="line" data-startTime="1204">and loops through them. </span></p>

<p><span class="line" data-startTime="1205">If the type is notJs, then </span><span class="line" data-startTime="1205">it sets the type back to </span><span class="line" data-startTime="1208">text/javascript and then it </span><span class="line" data-startTime="1208">re-adds it to the document. </span> <span class="line" data-startTime="1212">When you do this, the document </span><span class="line" data-startTime="1212">reevaluates it, parses it </span><span class="line" data-startTime="1216">right away because now it sees </span><span class="line" data-startTime="1216">that it's JavaScript, and </span><span class="line" data-startTime="1218">executes it just as </span><span class="line" data-startTime="1218">we would expect. </span> <span class="line" data-startTime="1222">So what I've done is, I modified </span><span class="line" data-startTime="1222">the experiments. </span> <span class="line" data-startTime="1224">I created this function. </span> <span class="line" data-startTime="1225">I added notJs to all the </span><span class="line" data-startTime="1225">scripts on the page. </span> <span class="line" data-startTime="1228">And then I set this </span><span class="line" data-startTime="1228">function to be the </span><span class="line" data-startTime="1229">window.onload function. </span> <span class="line" data-startTime="1232">Here's the results. </span> <span class="line" data-startTime="1233">Oooh. </span></p>

<p><span class="line" data-startTime="1237">So our page running time </span><span class="line" data-startTime="1237">just got a lot faster. </span> <span class="line" data-startTime="1240">We have a 33% improvement in </span><span class="line" data-startTime="1240">running time, and this is </span><span class="line" data-startTime="1242">hundreds of milliseconds. </span> <span class="line" data-startTime="1245">But remember, all these </span><span class="line" data-startTime="1245">resources are cached. </span> <span class="line" data-startTime="1249">That's how we're running </span><span class="line" data-startTime="1249">these experiments. </span> <span class="line" data-startTime="1251">So why does this take so long? </span><span class="line" data-startTime="1256">It takes so long because it </span><span class="line" data-startTime="1256">takes one millisecond to parse </span><span class="line" data-startTime="1259">every kilobyte of JavaScript </span><span class="line" data-startTime="1259">on modern mobile hardware. </span> <span class="line" data-startTime="1263">And this is really important. </span> <span class="line" data-startTime="1264">What I mean by parse is, when </span><span class="line" data-startTime="1264">the browser encounters a </span><span class="line" data-startTime="1268">script block, this is the time </span><span class="line" data-startTime="1268">that it takes to read all the </span><span class="line" data-startTime="1272">text in that script block and </span><span class="line" data-startTime="1272">figure out what it means in </span><span class="line" data-startTime="1275">terms of JavaScript, and then </span><span class="line" data-startTime="1275">execute on the top-level lines </span><span class="line" data-startTime="1278">of JavaScript in that </span><span class="line" data-startTime="1278">script function. </span></p>

<p><span class="line" data-startTime="1282">And this is much more expensive </span><span class="line" data-startTime="1282">to do on mobile than </span><span class="line" data-startTime="1285">it is on desktop. </span> <span class="line" data-startTime="1288">Here's a more detailed breakdown </span><span class="line" data-startTime="1288">of some of the </span><span class="line" data-startTime="1289">experiments that my team has run </span><span class="line" data-startTime="1289">to investigate what kind </span><span class="line" data-startTime="1293">of parse times we see </span><span class="line" data-startTime="1293">across devices. </span> <span class="line" data-startTime="1296">So you can see here, for Nexus </span><span class="line" data-startTime="1296">S hardware, it takes 300 </span><span class="line" data-startTime="1299">milliseconds to parse 300 </span><span class="line" data-startTime="1299">kilobytes of JavaScript. </span> <span class="line" data-startTime="1302">And that's where we get our </span><span class="line" data-startTime="1302">one millisecond to one </span><span class="line" data-startTime="1304">kilobyte rule. </span> <span class="line" data-startTime="1306">And 300K is a pretty average </span><span class="line" data-startTime="1306">amount of JavaScript to </span><span class="line" data-startTime="1309">include on a page, especially </span><span class="line" data-startTime="1309">for pages that have kind of </span><span class="line" data-startTime="1312">been ported over from desktop, </span><span class="line" data-startTime="1312">where we just include lots of </span><span class="line" data-startTime="1315">JavaScript all the time and </span><span class="line" data-startTime="1315">it doesn't really matter. </span></p>

<p><span class="line" data-startTime="1319">And 300 milliseconds is a long </span><span class="line" data-startTime="1319">time for a user to wait, </span><span class="line" data-startTime="1322">sitting and staring at a white </span><span class="line" data-startTime="1322">screen, seeing nothing, </span><span class="line" data-startTime="1324">waiting for your page to load. </span> <span class="line" data-startTime="1326">Now what's really interesting </span><span class="line" data-startTime="1326">is looking back a few </span><span class="line" data-startTime="1327">generations in phone hardware. </span> <span class="line" data-startTime="1329">And we see that iPhone 2G would </span><span class="line" data-startTime="1329">take over three seconds </span><span class="line" data-startTime="1333">to parse the same amount </span><span class="line" data-startTime="1333">of JavaScript. </span> <span class="line" data-startTime="1336">And that's a 10x improvement in </span><span class="line" data-startTime="1336">just a few generations of </span><span class="line" data-startTime="1339">phone hardware. </span> <span class="line" data-startTime="1341">So what we're seeing is a trend </span><span class="line" data-startTime="1341">where phone hardware is </span><span class="line" data-startTime="1345">improving drastically, </span><span class="line" data-startTime="1345">very quickly. </span></p>

<p><span class="line" data-startTime="1348">And so this should play &mdash; </span><span class="line" data-startTime="1350">you should keep this in mind. </span> <span class="line" data-startTime="1351">It should play a pretty big role </span><span class="line" data-startTime="1351">in how you think about </span><span class="line" data-startTime="1354">performance optimizations. </span> <span class="line" data-startTime="1356">Now let's think back &mdash; </span><span class="line" data-startTime="1357">our jQuery example. </span> <span class="line" data-startTime="1359">We minified jQuery, and we saved </span><span class="line" data-startTime="1359">over 100 kilobytes in </span><span class="line" data-startTime="1363">JavaScript, but we saw no </span><span class="line" data-startTime="1363">improvement in rendering time. </span> <span class="line" data-startTime="1366">So why was that? </span><span class="line" data-startTime="1368">So in this table, you'll see &mdash; </span><span class="line" data-startTime="1371">or maybe you won't see &mdash; </span><span class="line" data-startTime="1372">these are for minified </span><span class="line" data-startTime="1372">JavaScript sizes. </span> <span class="line" data-startTime="1376">So when we minified our jQuery </span><span class="line" data-startTime="1376">file from 240 kilobytes to 90 </span><span class="line" data-startTime="1380">kilobytes, we didn't actually </span><span class="line" data-startTime="1380">make it any less complex for </span><span class="line" data-startTime="1384">the browser to parse. </span> <span class="line" data-startTime="1385">It's still the same </span><span class="line" data-startTime="1385">JavaScript. </span> <span class="line" data-startTime="1387">It still has the same level of </span><span class="line" data-startTime="1387">complexity, the same amount of </span><span class="line" data-startTime="1389">stuff to execute, and the same </span><span class="line" data-startTime="1389">amount of stuff for the </span><span class="line" data-startTime="1391">browser to figure out. </span> <span class="line" data-startTime="1393">So just by minifying it, we </span><span class="line" data-startTime="1393">didn't actually save anything </span><span class="line" data-startTime="1396">in parse time. </span> <span class="line" data-startTime="1397">So that makes sense. </span></p>

<p><span class="line" data-startTime="1399">What this also means is that you </span><span class="line" data-startTime="1399">shouldn't just minify your </span><span class="line" data-startTime="1401">JavaScript. </span> <span class="line" data-startTime="1402">You should compile it. </span> <span class="line" data-startTime="1403">Using tools like Closure </span><span class="line" data-startTime="1403">Compiler, you can run phases </span><span class="line" data-startTime="1407">like the dead code removal in </span><span class="line" data-startTime="1407">order to get rid of all the </span><span class="line" data-startTime="1412">JavaScript on your page that's </span><span class="line" data-startTime="1412">not actually being used. </span> <span class="line" data-startTime="1414">So when you're pulling in </span><span class="line" data-startTime="1414">libraries like jQuery and </span><span class="line" data-startTime="1417">using only a small fraction of </span><span class="line" data-startTime="1417">it, you can use compilers to </span><span class="line" data-startTime="1420">remove all the stuff that you're </span><span class="line" data-startTime="1420">not actually using. </span> <span class="line" data-startTime="1422">And when you do that, that's </span><span class="line" data-startTime="1422">when you're going to see </span><span class="line" data-startTime="1423">improvements in parse time. </span> <span class="line" data-startTime="1429">OK, so how much faster </span><span class="line" data-startTime="1429">can we go now? </span><span class="line" data-startTime="1430">We have optimized images, </span><span class="line" data-startTime="1430">optimized CSS, and no </span><span class="line" data-startTime="1434">JavaScript getting in the way </span><span class="line" data-startTime="1434">of our content rendering. </span></p>

<p><span class="line" data-startTime="1438">The only thing we could do now </span><span class="line" data-startTime="1438">is get rid of styles, which we </span><span class="line" data-startTime="1441">probably don't want to do, or </span><span class="line" data-startTime="1441">send down a smaller DOM. </span> <span class="line" data-startTime="1446">So we could just say to our </span><span class="line" data-startTime="1446">designers, hey, your </span><span class="line" data-startTime="1448">document's too big. </span> <span class="line" data-startTime="1449">I don't want to show </span><span class="line" data-startTime="1449">this much content. </span> <span class="line" data-startTime="1450">It's really expensive </span><span class="line" data-startTime="1450">on mobile. </span> <span class="line" data-startTime="1452">And maybe that's acceptable. </span> <span class="line" data-startTime="1453">But say it's not. </span> <span class="line" data-startTime="1454">There's still something </span><span class="line" data-startTime="1454">that you can do. </span> <span class="line" data-startTime="1459">Here's a little trick. </span> <span class="line" data-startTime="1460">We're going to lazy load a </span><span class="line" data-startTime="1460">bunch of the document. </span> <span class="line" data-startTime="1463">So we can send down large </span><span class="line" data-startTime="1463">portions of the document and </span><span class="line" data-startTime="1467">only show a little bit </span><span class="line" data-startTime="1467">when we're first </span><span class="line" data-startTime="1471">rendering the page. </span> <span class="line" data-startTime="1473">The html5rocks.com main </span><span class="line" data-startTime="1473">page, it's got a lot </span><span class="line" data-startTime="1477">of scrollable content. </span></p>

<p><span class="line" data-startTime="1478">So there's a lot of stuff when </span><span class="line" data-startTime="1478">the user loads the page that's </span><span class="line" data-startTime="1481">there, but they can't </span><span class="line" data-startTime="1481">actually see. </span> <span class="line" data-startTime="1483">So there's no reason for us to </span><span class="line" data-startTime="1483">actually demand that the </span><span class="line" data-startTime="1484">browser try and render </span><span class="line" data-startTime="1484">that right away. </span> <span class="line" data-startTime="1487">So what I've done here is I took </span><span class="line" data-startTime="1487">a couple of the top-level </span><span class="line" data-startTime="1490">elements on the web page and </span><span class="line" data-startTime="1490">set them to display:none, </span><span class="line" data-startTime="1493">which just takes it out of the </span><span class="line" data-startTime="1493">rendering process completely. </span> <span class="line" data-startTime="1496">Then on the pageload, we can </span><span class="line" data-startTime="1496">just set these back to </span><span class="line" data-startTime="1500">display:visible and they'll </span><span class="line" data-startTime="1500">show up right away. </span></p>

<p><span class="line" data-startTime="1502">So they'll be there by the time </span><span class="line" data-startTime="1502">the user scrolls down to </span><span class="line" data-startTime="1505">try and use those parts </span><span class="line" data-startTime="1505">of the page. </span> <span class="line" data-startTime="1507">And by doing this, we've made </span><span class="line" data-startTime="1507">the page significantly simpler </span><span class="line" data-startTime="1509">for the browser to render, and </span><span class="line" data-startTime="1509">now we've saved another couple </span><span class="line" data-startTime="1512">hundred milliseconds </span><span class="line" data-startTime="1512">in rendering time. </span> <span class="line" data-startTime="1516">So now we're sitting at 600 </span><span class="line" data-startTime="1516">milliseconds of render time. </span> <span class="line" data-startTime="1519">So remember, that's time from </span><span class="line" data-startTime="1519">the browser getting the page </span><span class="line" data-startTime="1522">to showing user content. </span> <span class="line" data-startTime="1524">And that's just about a 2x </span><span class="line" data-startTime="1524">improvement since we started </span><span class="line" data-startTime="1527">these optimizations. </span> <span class="line" data-startTime="1529">So at this point I'm </span><span class="line" data-startTime="1529">pretty happy. </span> <span class="line" data-startTime="1532">And I don't know that there's </span><span class="line" data-startTime="1532">much more we can do on just </span><span class="line" data-startTime="1535">the rendering, other </span><span class="line" data-startTime="1535">than waiting </span><span class="line" data-startTime="1536">for newer phone hardware. </span></p>

<p><span class="line" data-startTime="1539">We could maybe squeeze out </span><span class="line" data-startTime="1539">another 50 or 100 milliseconds </span><span class="line" data-startTime="1542">in this rendering time by really </span><span class="line" data-startTime="1542">digging into the CSS or </span><span class="line" data-startTime="1545">simplifying the DOM a little bit </span><span class="line" data-startTime="1545">more, and stuff like that. </span> <span class="line" data-startTime="1549">But at this point, our effort </span><span class="line" data-startTime="1549">is probably better spent </span><span class="line" data-startTime="1553">optimizing other things. </span> <span class="line" data-startTime="1555">So, so far we've only been </span><span class="line" data-startTime="1555">looking at the rendering </span><span class="line" data-startTime="1557">performance, but there's </span><span class="line" data-startTime="1557">actually a lot more variables </span><span class="line" data-startTime="1560">that the user waits on, other </span><span class="line" data-startTime="1560">than just the rendering. </span> <span class="line" data-startTime="1564">We need to consider things like </span><span class="line" data-startTime="1564">the network load time and </span><span class="line" data-startTime="1566">redirects and all this </span><span class="line" data-startTime="1566">kind of stuff. </span> <span class="line" data-startTime="1568">And optimizing for these is </span><span class="line" data-startTime="1568">really hard to do on your </span><span class="line" data-startTime="1571">local development environments, </span><span class="line" data-startTime="1571">because the </span><span class="line" data-startTime="1573">environment is completely </span><span class="line" data-startTime="1573">different from the production </span><span class="line" data-startTime="1575">environment. </span> <span class="line" data-startTime="1577">So to figure out what real </span><span class="line" data-startTime="1577">users in the wild are </span><span class="line" data-startTime="1579">experiencing, there's this </span><span class="line" data-startTime="1579">cool website called </span><span class="line" data-startTime="1581">webpagetest.org, where you can </span><span class="line" data-startTime="1581">go and they've got a browser </span><span class="line" data-startTime="1585">farm, and you can type </span><span class="line" data-startTime="1585">in any website URL. </span></p>

<p><span class="line" data-startTime="1587">It will load the page and tell </span><span class="line" data-startTime="1587">you exactly what kind of load </span><span class="line" data-startTime="1590">sequence your page has. </span> <span class="line" data-startTime="1593">So these are results for </span><span class="line" data-startTime="1593">html5rocks.com using one of </span><span class="line" data-startTime="1596">their Android browsers in </span><span class="line" data-startTime="1596">the mobile browser farm. </span> <span class="line" data-startTime="1600">So here we can see exactly </span><span class="line" data-startTime="1600">what's happening on pageload. </span> <span class="line" data-startTime="1602">We've got two redirects here, </span><span class="line" data-startTime="1602">and then here's the main </span><span class="line" data-startTime="1606">pageload, and then all these </span><span class="line" data-startTime="1606">resources loading. </span> <span class="line" data-startTime="1609">And here's the rest of </span><span class="line" data-startTime="1609">the waterfall chart. </span> <span class="line" data-startTime="1611">So right away, we can see </span><span class="line" data-startTime="1611">exactly how much time we could </span><span class="line" data-startTime="1614">save the users by optimizing </span><span class="line" data-startTime="1614">different </span><span class="line" data-startTime="1616">parts of this process. </span> <span class="line" data-startTime="1618">For example, why do we </span><span class="line" data-startTime="1618">need two redirects? </span><span class="line" data-startTime="1619">We can just get rid of one of </span><span class="line" data-startTime="1619">these redirects, and we would </span><span class="line" data-startTime="1622">automatically save 100 </span><span class="line" data-startTime="1622">milliseconds right there. </span></p>

<p><span class="line" data-startTime="1627">But it looks like the biggest </span><span class="line" data-startTime="1627">performance improvements we </span><span class="line" data-startTime="1629">could make here are </span><span class="line" data-startTime="1629">on this pageload. </span> <span class="line" data-startTime="1631">It's taking over 1.7 seconds </span><span class="line" data-startTime="1631">to download this page. </span> <span class="line" data-startTime="1636">That's pretty terrible. </span> <span class="line" data-startTime="1639">Also, interestingly, is that </span><span class="line" data-startTime="1639">these browsers and the browser </span><span class="line" data-startTime="1643">farm are all on a strong </span><span class="line" data-startTime="1643">Wi-Fi connection. </span> <span class="line" data-startTime="1645">So it's not like this is </span><span class="line" data-startTime="1645">downloading over an Edge </span><span class="line" data-startTime="1647">network and taking </span><span class="line" data-startTime="1647">a long time. </span> <span class="line" data-startTime="1650">This is probably taking over </span><span class="line" data-startTime="1650">a second just in server </span><span class="line" data-startTime="1654">processing time. </span> <span class="line" data-startTime="1655">So if we really want to make a </span><span class="line" data-startTime="1655">difference for our users, we </span><span class="line" data-startTime="1658">would look at this information </span><span class="line" data-startTime="1658">and dig into our server </span><span class="line" data-startTime="1662">infrastructure and figure out </span><span class="line" data-startTime="1662">why it's taking over a second </span><span class="line" data-startTime="1665">to process requests and </span><span class="line" data-startTime="1665">start sending the </span><span class="line" data-startTime="1667">first byte to the browser. </span> <span class="line" data-startTime="1672">And here's the green line &mdash; </span><span class="line" data-startTime="1672">this is the load event. </span></p>

<p><span class="line" data-startTime="1674">And you can see there's </span><span class="line" data-startTime="1674">a bunch of </span><span class="line" data-startTime="1675">JavaScript files loading. </span> <span class="line" data-startTime="1677">This is what we've pushed over </span><span class="line" data-startTime="1677">onto the other side of the </span><span class="line" data-startTime="1679">Ready event. </span> <span class="line" data-startTime="1681">And remember that we saved 600 </span><span class="line" data-startTime="1681">milliseconds, which is maybe </span><span class="line" data-startTime="1686">about like this much. </span> <span class="line" data-startTime="1689">And we said that the only </span><span class="line" data-startTime="1689">further improvements we can </span><span class="line" data-startTime="1692">make there are pretty </span><span class="line" data-startTime="1692">marginal. </span> <span class="line" data-startTime="1694">So definitely, looking at this </span><span class="line" data-startTime="1694">huge chunk here, this is what </span><span class="line" data-startTime="1697">we would want to focus on if we </span><span class="line" data-startTime="1697">want to help our users out. </span> <span class="line" data-startTime="1702">OK. </span> <span class="line" data-startTime="1702">So what if we decide improving </span><span class="line" data-startTime="1702">the server is hard? </span><span class="line" data-startTime="1705">I want to do this </span><span class="line" data-startTime="1705">from the client. </span> <span class="line" data-startTime="1706">We actually can do that </span><span class="line" data-startTime="1706">by using AppCache. </span></p>

<p><span class="line" data-startTime="1709">And using AppCache, we can </span><span class="line" data-startTime="1709">entirely get rid of the </span><span class="line" data-startTime="1711">network time and bring that </span><span class="line" data-startTime="1711">to zero, because all the </span><span class="line" data-startTime="1714">resources will be </span><span class="line" data-startTime="1714">cached locally, </span><span class="line" data-startTime="1715">including the HTML file. </span> <span class="line" data-startTime="1718">To set this up, you just need to </span><span class="line" data-startTime="1718">create a manifest file and </span><span class="line" data-startTime="1721">link it to your HTML </span><span class="line" data-startTime="1721">attribute here. </span> <span class="line" data-startTime="1725">You host this manifest file </span><span class="line" data-startTime="1725">on your web server. </span> <span class="line" data-startTime="1728">And in this manifest file, you </span><span class="line" data-startTime="1728">describe all the resources </span><span class="line" data-startTime="1730">that you want to be cached. </span> <span class="line" data-startTime="1735">So when we add that to the </span><span class="line" data-startTime="1735">page and rerun the </span><span class="line" data-startTime="1737">experiments, we see that </span><span class="line" data-startTime="1737">we've actually </span><span class="line" data-startTime="1739">taken a rendering hit. </span> <span class="line" data-startTime="1741">And so this was important </span><span class="line" data-startTime="1741">and a little bit of </span><span class="line" data-startTime="1744">a surprise to me. </span> <span class="line" data-startTime="1745">Upon investigation, I realized </span><span class="line" data-startTime="1745">that what was happening was, </span><span class="line" data-startTime="1749">the manifest file was </span><span class="line" data-startTime="1749">downloading every pageload. </span> <span class="line" data-startTime="1751">Even if all the resources are </span><span class="line" data-startTime="1751">cached, the browser has to </span><span class="line" data-startTime="1754">re-download this manifest file </span><span class="line" data-startTime="1754">every time it opens the page, </span><span class="line" data-startTime="1758">and that's because the manifest </span><span class="line" data-startTime="1758">serves as the </span><span class="line" data-startTime="1761">indication to the browser as to </span><span class="line" data-startTime="1761">when it needs to update the </span><span class="line" data-startTime="1764">resources because the </span><span class="line" data-startTime="1764">application's out of date. </span></p>

<p><span class="line" data-startTime="1767">So when the developer changes </span><span class="line" data-startTime="1767">the manifest file, that means </span><span class="line" data-startTime="1769">the app needs to be updated and </span><span class="line" data-startTime="1771">re-download all the resources. </span> <span class="line" data-startTime="1773">But what it means for a normal </span><span class="line" data-startTime="1773">pageload sequence is that </span><span class="line" data-startTime="1776">we've downloaded the page and </span><span class="line" data-startTime="1776">the first thing the browser </span><span class="line" data-startTime="1778">processes is the HTML node. </span> <span class="line" data-startTime="1781">And it sees the manifest </span><span class="line" data-startTime="1781">attribute, and then right then </span><span class="line" data-startTime="1783">and there, it starts </span><span class="line" data-startTime="1783">downloading </span><span class="line" data-startTime="1784">this AppCache file. </span> <span class="line" data-startTime="1786">So that means while you're on </span><span class="line" data-startTime="1786">the critical path of trying to </span><span class="line" data-startTime="1788">render your content, you've </span><span class="line" data-startTime="1788">initiated a new download </span><span class="line" data-startTime="1792">happening in parallel. </span></p>

<p><span class="line" data-startTime="1793">So you're creating resource </span><span class="line" data-startTime="1793">contention, and that's why we </span><span class="line" data-startTime="1795">see the rendering hit. </span> <span class="line" data-startTime="1796">However, this is pretty </span><span class="line" data-startTime="1796">acceptable, given that we're </span><span class="line" data-startTime="1798">saving, as we saw, almost two </span><span class="line" data-startTime="1798">seconds in network load time. </span> <span class="line" data-startTime="1803">So that pretty far offsets the </span><span class="line" data-startTime="1803">tens of milliseconds that </span><span class="line" data-startTime="1806">we're losing here. </span> <span class="line" data-startTime="1809">So AppCache sounds </span><span class="line" data-startTime="1809">pretty easy. </span> <span class="line" data-startTime="1811">I'm making it sound like a </span><span class="line" data-startTime="1811">silver bullet to improving </span><span class="line" data-startTime="1813">your network time. </span> <span class="line" data-startTime="1815">But that's not actually </span><span class="line" data-startTime="1815">the case. </span> <span class="line" data-startTime="1817">It can be a real challenge. </span> <span class="line" data-startTime="1818">It can be a real nuisance, and </span><span class="line" data-startTime="1818">there's lots of things that </span><span class="line" data-startTime="1820">can go wrong. </span></p>

<p><span class="line" data-startTime="1823">Let's talk about why. </span> <span class="line" data-startTime="1824">And it requires a little bit </span><span class="line" data-startTime="1824">deeper understanding of how </span><span class="line" data-startTime="1826">AppCache works. </span> <span class="line" data-startTime="1828">So what we're doing here is </span><span class="line" data-startTime="1828">looking at the Resources tab. </span> <span class="line" data-startTime="1830">This is showing us the AppCache </span><span class="line" data-startTime="1830">entry for the site on </span><span class="line" data-startTime="1833">the local version that </span><span class="line" data-startTime="1833">I've created. </span> <span class="line" data-startTime="1835">These are all the files that </span><span class="line" data-startTime="1835">have been added to this </span><span class="line" data-startTime="1838">AppCache entry. </span> <span class="line" data-startTime="1840">The manifest file is the key to </span><span class="line" data-startTime="1840">the AppCache entry the maps </span><span class="line" data-startTime="1844">all the resources that are </span><span class="line" data-startTime="1844">cached in this entry. </span> <span class="line" data-startTime="1847">So all the resources that you </span><span class="line" data-startTime="1847">list in the manifest file &mdash; </span><span class="line" data-startTime="1851">you can find them all here. </span></p>

<p><span class="line" data-startTime="1852">These are the explicit </span><span class="line" data-startTime="1852">entries here. </span> <span class="line" data-startTime="1855">All of the HTML files that point </span><span class="line" data-startTime="1855">to this manifest file </span><span class="line" data-startTime="1859">end up in here as </span><span class="line" data-startTime="1859">master entries. </span> <span class="line" data-startTime="1861">So if you have 10 pages on your </span><span class="line" data-startTime="1861">site, all pointing to the </span><span class="line" data-startTime="1864">same manifest file, they'll </span><span class="line" data-startTime="1864">all appear here as master </span><span class="line" data-startTime="1867">entries in your AppCache </span><span class="line" data-startTime="1867">entry. </span> <span class="line" data-startTime="1870">And then remember, when the </span><span class="line" data-startTime="1870">manifest file changes, that's </span><span class="line" data-startTime="1873">the signal to the browser to </span><span class="line" data-startTime="1873">re-download the resources </span><span class="line" data-startTime="1876">because the developer has </span><span class="line" data-startTime="1876">published an update to this </span><span class="line" data-startTime="1879">application. </span> <span class="line" data-startTime="1882">So when that happens, you can </span><span class="line" data-startTime="1882">see how the browser behaves by </span><span class="line" data-startTime="1886">looking at the developer </span><span class="line" data-startTime="1886">console when you're </span><span class="line" data-startTime="1889">refreshing the page. </span> <span class="line" data-startTime="1891">So what happens is the browser </span><span class="line" data-startTime="1891">sees the manifest file has </span><span class="line" data-startTime="1895">changed and then initiates </span><span class="line" data-startTime="1895">an AppCache update and </span><span class="line" data-startTime="1898">re-downloads all these </span><span class="line" data-startTime="1898">resources. </span> <span class="line" data-startTime="1900">And what we see here is that </span><span class="line" data-startTime="1900">it's downloading these two </span><span class="line" data-startTime="1902">HTML files at the same time. </span> <span class="line" data-startTime="1906">Let's look at an example of </span><span class="line" data-startTime="1906">why this can be so bad. </span></p>

<p><span class="line" data-startTime="1909">Number one, user opens </span><span class="line" data-startTime="1909">a single page with </span><span class="line" data-startTime="1911">five external resources. </span> <span class="line" data-startTime="1913">Let's say that totals 350 </span><span class="line" data-startTime="1913">kilobytes of downloaded stuff. </span> <span class="line" data-startTime="1916">That goes into the </span><span class="line" data-startTime="1916">AppCache entry. </span> <span class="line" data-startTime="1919">The user then opens 10 more </span><span class="line" data-startTime="1919">pages on the site. </span> <span class="line" data-startTime="1922">Each of them are </span><span class="line" data-startTime="1922">200 kilobytes. </span> <span class="line" data-startTime="1924">All of these go into </span><span class="line" data-startTime="1924">the AppCache entry. </span> <span class="line" data-startTime="1927">Now we've published an update to </span><span class="line" data-startTime="1927">the web app by changing the </span><span class="line" data-startTime="1930">manifest file. </span> <span class="line" data-startTime="1932">The user visits just one </span><span class="line" data-startTime="1932">of these 11 pages. </span> <span class="line" data-startTime="1935">The browser checks the manifest </span><span class="line" data-startTime="1935">file, sees a change, </span><span class="line" data-startTime="1938">and initiates an AppCache </span><span class="line" data-startTime="1938">update. </span> <span class="line" data-startTime="1941">Now, what happens is the browser </span><span class="line" data-startTime="1941">downloads over 2 </span><span class="line" data-startTime="1943">megabytes of data in the </span><span class="line" data-startTime="1943">background, just by navigating </span><span class="line" data-startTime="1947">to this one page. </span> <span class="line" data-startTime="1950">Say you had 10,000 </span><span class="line" data-startTime="1950">users that day. </span></p>

<p><span class="line" data-startTime="1952">You're serving up over 20 </span><span class="line" data-startTime="1952">gigabytes of data versus what </span><span class="line" data-startTime="1955">should have been only 20 </span><span class="line" data-startTime="1955">megabytes of data if they were </span><span class="line" data-startTime="1958">just loading those HTML </span><span class="line" data-startTime="1958">files by themselves. </span> <span class="line" data-startTime="1960">So not only could this be really </span><span class="line" data-startTime="1960">expensive for your </span><span class="line" data-startTime="1961">users, but it can be really </span><span class="line" data-startTime="1961">expensive to you, depending on </span><span class="line" data-startTime="1965">your server infrastructure. </span> <span class="line" data-startTime="1969">OK. </span> <span class="line" data-startTime="1969">So how can we get around this? </span><span class="line" data-startTime="1970">The obvious solution seems to </span><span class="line" data-startTime="1970">be, let's include one manifest </span><span class="line" data-startTime="1973">file per HTML page. </span> <span class="line" data-startTime="1976">So for every page we're serving </span><span class="line" data-startTime="1976">up, it's going to have </span><span class="line" data-startTime="1978">its own manifest file, it'll </span><span class="line" data-startTime="1978">have its own AppCache entry, </span><span class="line" data-startTime="1981">and everything will be good. </span> <span class="line" data-startTime="1983">That's not actually </span><span class="line" data-startTime="1983">the case either. </span> <span class="line" data-startTime="1985">When you create several AppCache </span><span class="line" data-startTime="1985">entries, you can use </span><span class="line" data-startTime="1989">Chrome, go into AppCache </span><span class="line" data-startTime="1989">Internals, and see how you're </span><span class="line" data-startTime="1992">kind of affecting the </span><span class="line" data-startTime="1992">various AppCache </span><span class="line" data-startTime="1994">entries in the system. </span></p>

<p><span class="line" data-startTime="1997">So what I've done is I've </span><span class="line" data-startTime="1997">modified the local version to </span><span class="line" data-startTime="1999">have several AppCache files for </span><span class="line" data-startTime="1999">those two HTML files that </span><span class="line" data-startTime="2002">we were previously loading </span><span class="line" data-startTime="2002">in a single entry. </span> <span class="line" data-startTime="2005">What we see here is this one </span><span class="line" data-startTime="2005">here is over 350 kilobytes in </span><span class="line" data-startTime="2008">size, and this one is also </span><span class="line" data-startTime="2008">very large, over 260. </span> <span class="line" data-startTime="2012">And what's happening is that all </span><span class="line" data-startTime="2012">of the external resources </span><span class="line" data-startTime="2015">that our manifest files are </span><span class="line" data-startTime="2015">pointing to are being cached </span><span class="line" data-startTime="2018">in both of these AppCache </span><span class="line" data-startTime="2018">entries. </span> <span class="line" data-startTime="2020">So the AppCache entries can't </span><span class="line" data-startTime="2020">share external resources </span><span class="line" data-startTime="2024">amongst themselves. </span></p>

<p><span class="line" data-startTime="2025">They need to cache </span><span class="line" data-startTime="2025">all the files </span><span class="line" data-startTime="2026">explicitly in each entry. </span> <span class="line" data-startTime="2028">And so the sizes of these </span><span class="line" data-startTime="2028">are adding up quickly. </span> <span class="line" data-startTime="2031">And the reason that's a problem </span><span class="line" data-startTime="2031">is because the browser </span><span class="line" data-startTime="2033">has a hard limit of 5 megabytes </span><span class="line" data-startTime="2033">per domain quota for </span><span class="line" data-startTime="2037">your AppCache space. </span> <span class="line" data-startTime="2040">So just based on the pace that </span><span class="line" data-startTime="2040">we're going here, for </span><span class="line" data-startTime="2043">html5rocks.com, by only adding </span><span class="line" data-startTime="2043">10 pages to this AppCache </span><span class="line" data-startTime="2049">setup, we would exceed </span><span class="line" data-startTime="2049">that limit already. </span> <span class="line" data-startTime="2053">And what happens when you </span><span class="line" data-startTime="2053">exceed the limit is, the </span><span class="line" data-startTime="2054">browser tries to download the </span><span class="line" data-startTime="2054">updates, and when it gets the </span><span class="line" data-startTime="2058">update it tries to push </span><span class="line" data-startTime="2058">it into the cache. </span> <span class="line" data-startTime="2060">But when you've exceeded </span><span class="line" data-startTime="2060">your quota, that </span><span class="line" data-startTime="2062">push will just fail. </span> <span class="line" data-startTime="2063">And there's nothing that you </span><span class="line" data-startTime="2063">can really do about it </span><span class="line" data-startTime="2065">programmatically </span><span class="line" data-startTime="2065">in JavaScript. </span></p>

<p><span class="line" data-startTime="2067">If your users get into this </span><span class="line" data-startTime="2067">situation, they can actually </span><span class="line" data-startTime="2069">get stuck on a really stale </span><span class="line" data-startTime="2069">version of their site, because </span><span class="line" data-startTime="2072">they can't actually update </span><span class="line" data-startTime="2072">to the new version. </span> <span class="line" data-startTime="2074">So this is a pretty big </span><span class="line" data-startTime="2074">problem that you </span><span class="line" data-startTime="2077">should try to avoid. </span> <span class="line" data-startTime="2077">And if you get into this </span><span class="line" data-startTime="2077">problem, you're kind of </span><span class="line" data-startTime="2079">screwed, because you can't </span><span class="line" data-startTime="2079">fix it after the fact. </span> <span class="line" data-startTime="2081">The only thing that you can do </span><span class="line" data-startTime="2081">is serve 404s on your AppCache </span><span class="line" data-startTime="2084">requests, and this invalidates </span><span class="line" data-startTime="2084">the AppCache in the browser. </span></p>

<p><span class="line" data-startTime="2092">So it used to seem </span><span class="line" data-startTime="2092">really easy. </span> <span class="line" data-startTime="2093">Now it seems really hard. </span> <span class="line" data-startTime="2094">How can we actually </span><span class="line" data-startTime="2094">make this work? </span><span class="line" data-startTime="2095">You have three options, </span><span class="line" data-startTime="2095">basically. </span> <span class="line" data-startTime="2097">You can decide to only include </span><span class="line" data-startTime="2097">a manifest file on </span><span class="line" data-startTime="2100">a select few pages. </span> <span class="line" data-startTime="2101">So this means, maybe, your home </span><span class="line" data-startTime="2101">page or just a few really </span><span class="line" data-startTime="2104">important pages include </span><span class="line" data-startTime="2104">a manifest </span><span class="line" data-startTime="2106">file and use AppCache. </span> <span class="line" data-startTime="2108">So this is acceptable, maybe, </span><span class="line" data-startTime="2108">depending on your product </span><span class="line" data-startTime="2111">requirements. </span> <span class="line" data-startTime="2112">But what this does is basically </span><span class="line" data-startTime="2112">limit the scope on </span><span class="line" data-startTime="2115">how big your AppCache </span><span class="line" data-startTime="2115">entry can get. </span></p>

<p><span class="line" data-startTime="2117">The next thing that you can </span><span class="line" data-startTime="2117">try is to implement your </span><span class="line" data-startTime="2120">entire site as a single page. </span> <span class="line" data-startTime="2123">So this is more what those like, </span><span class="line" data-startTime="2123">webapps apps do, where </span><span class="line" data-startTime="2127">it's just a single </span><span class="line" data-startTime="2127">HTML/JavaScript/CSS bundle </span><span class="line" data-startTime="2132">sent to the client. </span> <span class="line" data-startTime="2134">Gmail and Twitter are both good </span><span class="line" data-startTime="2134">examples of single-page </span><span class="line" data-startTime="2137">sites that use AppCache. </span> <span class="line" data-startTime="2139">And when you're doing this, you </span><span class="line" data-startTime="2139">don't run into the problem </span><span class="line" data-startTime="2141">of many pages, because you </span><span class="line" data-startTime="2141">only have one page. </span> <span class="line" data-startTime="2144">And the other option is to just </span><span class="line" data-startTime="2144">not use AppCache at all. </span> <span class="line" data-startTime="2149">Google Search uses a really cool </span><span class="line" data-startTime="2149">technique where they want </span><span class="line" data-startTime="2153">to cache lots of resources, </span><span class="line" data-startTime="2153">but they want those to be </span><span class="line" data-startTime="2156">cached across all their URLs, </span><span class="line" data-startTime="2156">because when you do a search, </span><span class="line" data-startTime="2158">it modifies the URL so that's </span><span class="line" data-startTime="2158">shareable and things. </span></p>

<p><span class="line" data-startTime="2162">And so they're saving a lot of </span><span class="line" data-startTime="2162">stuff in localStorage and </span><span class="line" data-startTime="2165">caching their resources that </span><span class="line" data-startTime="2165">way, such that they're </span><span class="line" data-startTime="2167">available across all pages. </span> <span class="line" data-startTime="2172">OK, so let's change </span><span class="line" data-startTime="2172">gears a bit. </span> <span class="line" data-startTime="2173">So far we've only talked, </span><span class="line" data-startTime="2173">really, about page load and </span><span class="line" data-startTime="2177">rendering time. </span> <span class="line" data-startTime="2178">The next really important </span><span class="line" data-startTime="2178">thing on mobile is event </span><span class="line" data-startTime="2182">handling time. </span> <span class="line" data-startTime="2183">Basically, everything that </span><span class="line" data-startTime="2183">happens after your page is </span><span class="line" data-startTime="2185">loaded is an event handler </span><span class="line" data-startTime="2185">of some sort. </span></p>

<p><span class="line" data-startTime="2189">And so what I really want to </span><span class="line" data-startTime="2189">focus on here is the user does </span><span class="line" data-startTime="2191">some kind of interaction on the </span><span class="line" data-startTime="2191">page, and then we execute </span><span class="line" data-startTime="2194">some JavaScript and publish an </span><span class="line" data-startTime="2194">update to the applications and </span><span class="line" data-startTime="2198">we change the DOM so the user </span><span class="line" data-startTime="2198">sees something happen. </span> <span class="line" data-startTime="2204">So there's a couple of </span><span class="line" data-startTime="2204">high-level guidelines here. </span> <span class="line" data-startTime="2206">First of all, everything on the </span><span class="line" data-startTime="2206">DOM is slow, so touch it </span><span class="line" data-startTime="2210">as little as possible. </span> <span class="line" data-startTime="2212">And when you do touch it, we </span><span class="line" data-startTime="2212">want to batch all of the DOM </span><span class="line" data-startTime="2215">changes together. </span> <span class="line" data-startTime="2216">If you were at the Jank </span><span class="line" data-startTime="2216">Busting talk that just </span><span class="line" data-startTime="2218">happened an hour ago, they </span><span class="line" data-startTime="2218">showed a couple of really cool </span><span class="line" data-startTime="2222">ways that you could debug </span><span class="line" data-startTime="2222">these kind of issues. </span> <span class="line" data-startTime="2225">And this is a little </span><span class="line" data-startTime="2225">bit of the same </span><span class="line" data-startTime="2226">thing, but kind of different. </span> <span class="line" data-startTime="2230">So here's an example of a really </span><span class="line" data-startTime="2230">bad event handler. </span> <span class="line" data-startTime="2234">And this is how you can debug </span><span class="line" data-startTime="2234">it and see what's going on. </span></p>

<p><span class="line" data-startTime="2236">So using the Events timeline, </span><span class="line" data-startTime="2236">we see, here </span><span class="line" data-startTime="2239">is the event handler. </span> <span class="line" data-startTime="2241">And I've expanded this, and </span><span class="line" data-startTime="2241">now we can see what's </span><span class="line" data-startTime="2242">happening in this </span><span class="line" data-startTime="2242">event handler. </span> <span class="line" data-startTime="2244">And what we see here &mdash; </span><span class="line" data-startTime="2245">these are Recalculate </span><span class="line" data-startTime="2245">Style events. </span> <span class="line" data-startTime="2250">What we see here is we executed </span><span class="line" data-startTime="2250">some JavaScript and </span><span class="line" data-startTime="2254">then we have a style </span><span class="line" data-startTime="2254">recalculation. </span> <span class="line" data-startTime="2255">Then we execute some more, and </span><span class="line" data-startTime="2255">we have a style recalculation. </span> <span class="line" data-startTime="2258">And every time there's a style </span><span class="line" data-startTime="2258">recalculation, this is what's </span><span class="line" data-startTime="2260">really expensive, especially </span><span class="line" data-startTime="2260">on mobile. </span> <span class="line" data-startTime="2263">This is where the browser </span><span class="line" data-startTime="2263">says hey, wait, I </span><span class="line" data-startTime="2264">gotta update stuff. </span> <span class="line" data-startTime="2266">And it basically does a reflow </span><span class="line" data-startTime="2266">of the entire document to </span><span class="line" data-startTime="2270">calculate how large all the </span><span class="line" data-startTime="2270">blocks on the page are. </span></p>

<p><span class="line" data-startTime="2274">And that's why we see this </span><span class="line" data-startTime="2274">big time gap here. </span> <span class="line" data-startTime="2276">This time here is the browser </span><span class="line" data-startTime="2276">just taking time to </span><span class="line" data-startTime="2278">lay itself out again. </span> <span class="line" data-startTime="2280">And then we have another reflow </span><span class="line" data-startTime="2280">here, and another one. </span> <span class="line" data-startTime="2283">And then here's the </span><span class="line" data-startTime="2283">Paint event here. </span> <span class="line" data-startTime="2286">And this is the real goal of </span><span class="line" data-startTime="2286">the event handler, is to </span><span class="line" data-startTime="2289">respond to the user's event and </span><span class="line" data-startTime="2289">Paint as soon as possible. </span> <span class="line" data-startTime="2295">Here's the code that is the </span><span class="line" data-startTime="2295">implementation of this really </span><span class="line" data-startTime="2298">bad event handler. </span> <span class="line" data-startTime="2300">So what we have here is a </span><span class="line" data-startTime="2300">bunch of DOM mutations </span><span class="line" data-startTime="2304">sprinkled throughout </span><span class="line" data-startTime="2304">the event handler. </span></p>

<p><span class="line" data-startTime="2305">And this is exactly what </span><span class="line" data-startTime="2305">we want to avoid. </span> <span class="line" data-startTime="2308">And then what we have is, we're </span><span class="line" data-startTime="2308">looking at offsetWidth </span><span class="line" data-startTime="2312">on one of these divs. </span> <span class="line" data-startTime="2314">And using offsetWidth is </span><span class="line" data-startTime="2314">something that requires the </span><span class="line" data-startTime="2317">browser to know how large </span><span class="line" data-startTime="2317">things are on the page. </span> <span class="line" data-startTime="2320">So it needs to do a style </span><span class="line" data-startTime="2320">recalculation. </span> <span class="line" data-startTime="2322">So each one of these offsetWidth </span><span class="line" data-startTime="2322">statements here is </span><span class="line" data-startTime="2327">what causes the style </span><span class="line" data-startTime="2327">recalculation and is what's </span><span class="line" data-startTime="2329">making this event </span><span class="line" data-startTime="2329">handler so slow. </span> <span class="line" data-startTime="2333">Here's a reimplementation just </span><span class="line" data-startTime="2333">simply rearranging this </span><span class="line" data-startTime="2335">function so that it performs </span><span class="line" data-startTime="2335">significantly better. </span> <span class="line" data-startTime="2338">All of the DOM mutations </span><span class="line" data-startTime="2338">are batched together. </span> <span class="line" data-startTime="2341">And then based on these </span><span class="line" data-startTime="2341">statements here, we'll only </span><span class="line" data-startTime="2343">end up with one style </span><span class="line" data-startTime="2343">recalculation. </span> <span class="line" data-startTime="2346">So here's what it </span><span class="line" data-startTime="2346">looks like now. </span></p>

<p><span class="line" data-startTime="2348">The event handler fires, we </span><span class="line" data-startTime="2348">execute a bunch of JavaScript, </span><span class="line" data-startTime="2352">we have one style recalculation, </span><span class="line" data-startTime="2352">and </span><span class="line" data-startTime="2354">then we do our Paint. </span> <span class="line" data-startTime="2355">And so this is significantly </span><span class="line" data-startTime="2355">faster and will end up being </span><span class="line" data-startTime="2359">much more responsive feedback to </span><span class="line" data-startTime="2359">our user, because the Paint </span><span class="line" data-startTime="2362">happened so much closer </span><span class="line" data-startTime="2362">as to when they </span><span class="line" data-startTime="2364">interacted with the page. </span> <span class="line" data-startTime="2369">Here's the performance impact </span><span class="line" data-startTime="2369">this can actually have. </span> <span class="line" data-startTime="2371">So I ran just this simple bad </span><span class="line" data-startTime="2371">code snippet on desktop Chrome </span><span class="line" data-startTime="2375">1,000 times. </span> <span class="line" data-startTime="2377">And it took nine seconds for the </span><span class="line" data-startTime="2377">bad case and 2.5 seconds </span><span class="line" data-startTime="2381">for the good implementation. </span> <span class="line" data-startTime="2382">This is a 72% improvement in </span><span class="line" data-startTime="2382">the processing time of this </span><span class="line" data-startTime="2386">event handler. </span> <span class="line" data-startTime="2387">So that's really significant. </span> <span class="line" data-startTime="2388">And then on mobile, I ran it </span><span class="line" data-startTime="2388">100 times on Chrome for </span><span class="line" data-startTime="2390">Android, and similarly, I saw </span><span class="line" data-startTime="2390">66% improvement in the </span><span class="line" data-startTime="2394">handling time. </span> <span class="line" data-startTime="2395">So this is really </span><span class="line" data-startTime="2395">important to do. </span></p>

<p><span class="line" data-startTime="2398">For any time that your user on </span><span class="line" data-startTime="2398">your touch-based mobile web </span><span class="line" data-startTime="2402">application &mdash; </span><span class="line" data-startTime="2402">when they touch something, they </span><span class="line" data-startTime="2402">want to see an update as </span><span class="line" data-startTime="2405">soon as possible. </span> <span class="line" data-startTime="2405">Because they a), want things to </span><span class="line" data-startTime="2405">be fast, but b), when they </span><span class="line" data-startTime="2410">touch it, they need that kind </span><span class="line" data-startTime="2410">of tactile feedback in order </span><span class="line" data-startTime="2414">to feel like the application is </span><span class="line" data-startTime="2414">really performing properly. </span> <span class="line" data-startTime="2421">So the next thing that can </span><span class="line" data-startTime="2421">really hurt your interaction </span><span class="line" data-startTime="2423">speed is the 300 millisecond </span><span class="line" data-startTime="2423">problem. </span> <span class="line" data-startTime="2427">This is the problem where all </span><span class="line" data-startTime="2427">click events on mobile </span><span class="line" data-startTime="2430">browsers come 300 milliseconds </span><span class="line" data-startTime="2430">after the user actually taps </span><span class="line" data-startTime="2433">the screen. </span></p>

<p><span class="line" data-startTime="2435">And the reason that browsers </span><span class="line" data-startTime="2435">do this is because they're </span><span class="line" data-startTime="2437">waiting to see if the user taps </span><span class="line" data-startTime="2437">the screen again, which </span><span class="line" data-startTime="2440">would indicate a double-tap. </span> <span class="line" data-startTime="2442">And so a double-tap on mobile </span><span class="line" data-startTime="2442">browsers will perform a </span><span class="line" data-startTime="2444">zoom-in operation, and so that's </span><span class="line" data-startTime="2444">why they introduced </span><span class="line" data-startTime="2447">this delay. </span> <span class="line" data-startTime="2450">For us, if we're creating an app </span><span class="line" data-startTime="2450">and we have a button, we </span><span class="line" data-startTime="2454">don't really want to have </span><span class="line" data-startTime="2454">to support the user </span><span class="line" data-startTime="2455">zooming in on a button. </span> <span class="line" data-startTime="2457">We just want that button to </span><span class="line" data-startTime="2457">respond as fast as possible. </span> <span class="line" data-startTime="2459">And by the time 300 milliseconds </span><span class="line" data-startTime="2459">executes, we're </span><span class="line" data-startTime="2462">way too late already. </span> <span class="line" data-startTime="2463">There's nothing we can do. </span> <span class="line" data-startTime="2464">No matter how efficient our </span><span class="line" data-startTime="2464">event handler is, it's going </span><span class="line" data-startTime="2467">to be too slow. </span></p>

<p><span class="line" data-startTime="2470">So the way we fix this is </span><span class="line" data-startTime="2470">actually really hackey. </span> <span class="line" data-startTime="2474">I've got a code snippet here </span><span class="line" data-startTime="2474">that kind of illustrates how </span><span class="line" data-startTime="2476">we can do this. </span> <span class="line" data-startTime="2478">This overrides the default </span><span class="line" data-startTime="2478">functionality of the click </span><span class="line" data-startTime="2481">event, sets up touchend event </span><span class="line" data-startTime="2481">listeners on the button, and </span><span class="line" data-startTime="2485">then on the touchend we'll do </span><span class="line" data-startTime="2485">whatever click behavior we </span><span class="line" data-startTime="2488">wanted the button to do </span><span class="line" data-startTime="2488">in the first place. </span> <span class="line" data-startTime="2491">And then you can get a handle on </span><span class="line" data-startTime="2491">your buttons throughout the </span><span class="line" data-startTime="2494">application in JavaScript </span><span class="line" data-startTime="2494">and decorate </span><span class="line" data-startTime="2496">them with this behavior. </span> <span class="line" data-startTime="2499">And all of a sudden, </span><span class="line" data-startTime="2499">your buttons will </span><span class="line" data-startTime="2500">be magically fast. </span> <span class="line" data-startTime="2502">So I make this code seem really </span><span class="line" data-startTime="2502">simple, but there's </span><span class="line" data-startTime="2506">actually a lot of problems and </span><span class="line" data-startTime="2506">glitches that it introduces, </span><span class="line" data-startTime="2509">and considerations. </span> <span class="line" data-startTime="2510">So for more details, check out </span><span class="line" data-startTime="2510">this article that I wrote a </span><span class="line" data-startTime="2513">while ago on creating fast </span><span class="line" data-startTime="2513">buttons for mobile web </span><span class="line" data-startTime="2516">applications. </span></p>

<p><span class="line" data-startTime="2517">It explains all of the things </span><span class="line" data-startTime="2517">that you need to keep in mind </span><span class="line" data-startTime="2520">while you're working </span><span class="line" data-startTime="2520">with this approach. </span> <span class="line" data-startTime="2522">And if you don't want to have </span><span class="line" data-startTime="2522">to write code yourself, </span><span class="line" data-startTime="2525">because developers are lazy, </span><span class="line" data-startTime="2525">which is good, you can pull up </span><span class="line" data-startTime="2529">this implementation here on </span><span class="line" data-startTime="2529">html5boilerplate.com/mobile </span><span class="line" data-startTime="2533">and you can just drop </span><span class="line" data-startTime="2533">this into your app </span><span class="line" data-startTime="2535">and start using it. </span> <span class="line" data-startTime="2538">OK. </span> <span class="line" data-startTime="2538">So the next thing that we want </span><span class="line" data-startTime="2538">to be able to do when we're </span><span class="line" data-startTime="2542">providing user with DOM updates </span><span class="line" data-startTime="2542">is to make sure, if </span><span class="line" data-startTime="2545">we're doing animations and </span><span class="line" data-startTime="2545">things like that, that they're </span><span class="line" data-startTime="2548">as smooth as possible. </span> <span class="line" data-startTime="2550">Which will make the user </span><span class="line" data-startTime="2550">happy, hopefully. </span> <span class="line" data-startTime="2552">And so the way that we need to </span><span class="line" data-startTime="2552">do that is make sure that all </span><span class="line" data-startTime="2554">of our animations and </span><span class="line" data-startTime="2554">document updates are </span><span class="line" data-startTime="2558">hardware-accelerated </span><span class="line" data-startTime="2558">when necessary. </span></p>

<p><span class="line" data-startTime="2561">So hardware-accelerated means </span><span class="line" data-startTime="2561">that you're going to take an </span><span class="line" data-startTime="2566">element, and it's going to be </span><span class="line" data-startTime="2566">turned into a layer that will </span><span class="line" data-startTime="2568">be uploaded to the GPU </span><span class="line" data-startTime="2568">for processing </span><span class="line" data-startTime="2571">off the main thread. </span> <span class="line" data-startTime="2572">And this is what allows </span><span class="line" data-startTime="2572">it to be really </span><span class="line" data-startTime="2573">smooth and really fast. </span> <span class="line" data-startTime="2576">Making something </span><span class="line" data-startTime="2576">hardware-accelerated in your </span><span class="line" data-startTime="2578">document is kind of </span><span class="line" data-startTime="2578">magical today. </span> <span class="line" data-startTime="2581">You just have to do something to </span><span class="line" data-startTime="2581">put it into some 3D space, </span><span class="line" data-startTime="2586">and that will hopefully make </span><span class="line" data-startTime="2586">it hardware-accelerated. </span> <span class="line" data-startTime="2589">So you can create a class </span><span class="line" data-startTime="2589">like this in your CSS </span><span class="line" data-startTime="2592">rules called .hwaccel. </span> <span class="line" data-startTime="2594">Webkit-transform is the </span><span class="line" data-startTime="2594">identity transform. </span></p>

<p><span class="line" data-startTime="2597">And you can apply this </span><span class="line" data-startTime="2597">to elements. </span> <span class="line" data-startTime="2598">It won't move it anywhere on the </span><span class="line" data-startTime="2598">page, but now updates to </span><span class="line" data-startTime="2601">this element will be </span><span class="line" data-startTime="2601">hardware-accelerated. </span> <span class="line" data-startTime="2605">Now if you're moving </span><span class="line" data-startTime="2605">elements, you can </span><span class="line" data-startTime="2606">create a different class. </span> <span class="line" data-startTime="2609">You can move elements using the </span><span class="line" data-startTime="2609">positioning attributes, </span><span class="line" data-startTime="2612">like left or top. </span> <span class="line" data-startTime="2613">But it's actually much faster to </span><span class="line" data-startTime="2613">use the transform property </span><span class="line" data-startTime="2616">to move elements. </span> <span class="line" data-startTime="2618">So this will ensure </span><span class="line" data-startTime="2618">the best hardware </span><span class="line" data-startTime="2620">acceleration possible. </span> <span class="line" data-startTime="2621">So what we have here is a </span><span class="line" data-startTime="2621">little CSS rule to make </span><span class="line" data-startTime="2624">something transitionable. </span> <span class="line" data-startTime="2625">We've applied transition, </span><span class="line" data-startTime="2625">which will be on </span><span class="line" data-startTime="2628">the transform property. </span></p>

<p><span class="line" data-startTime="2629">This transition will take 200 </span><span class="line" data-startTime="2629">milliseconds to execute and </span><span class="line" data-startTime="2632">we'll use an easing function. </span> <span class="line" data-startTime="2636">OK. </span> <span class="line" data-startTime="2636">So we're going to put these </span><span class="line" data-startTime="2636">three ideas together now. </span> <span class="line" data-startTime="2639">The three ideas were efficient </span><span class="line" data-startTime="2639">event handling, solving the </span><span class="line" data-startTime="2643">300-millisecond problem, and </span><span class="line" data-startTime="2643">smooth updating of elements </span><span class="line" data-startTime="2648">using hardware acceleration. </span> <span class="line" data-startTime="2650">So consider a scenario. </span> <span class="line" data-startTime="2651">In your mobile web app, you've </span><span class="line" data-startTime="2651">got a button, and when the </span><span class="line" data-startTime="2654">user taps that button, you </span><span class="line" data-startTime="2654">want to do a view slide </span><span class="line" data-startTime="2656">transition to the next page. </span> <span class="line" data-startTime="2658">And you want this to happen </span><span class="line" data-startTime="2658">as fast as possible. </span> <span class="line" data-startTime="2661">The next page isn't </span><span class="line" data-startTime="2661">rendered yet. </span> <span class="line" data-startTime="2662">So we need to render it when </span><span class="line" data-startTime="2662">the user taps this. </span></p>

<p><span class="line" data-startTime="2665">And the next page needs to </span><span class="line" data-startTime="2665">become interactive as well. </span> <span class="line" data-startTime="2668">So not only do we need to render </span><span class="line" data-startTime="2668">it, but we need to add </span><span class="line" data-startTime="2670">a bunch of event listeners to </span><span class="line" data-startTime="2670">it, and maybe load in some </span><span class="line" data-startTime="2673">images, and stuff like that. </span> <span class="line" data-startTime="2676">So here's a nice approach </span><span class="line" data-startTime="2676">we can take. </span> <span class="line" data-startTime="2677">First of all, we'll set up a </span><span class="line" data-startTime="2677">couple of CSS rules for our </span><span class="line" data-startTime="2680">two pages that will make </span><span class="line" data-startTime="2680">them transitionable. </span> <span class="line" data-startTime="2684">Next we'll take our button and </span><span class="line" data-startTime="2684">make it a fast button to avoid </span><span class="line" data-startTime="2688">the 300 millisecond problem. </span></p>

<p><span class="line" data-startTime="2690">Now when the tap event occurs, </span><span class="line" data-startTime="2690">we'll get a handle on the </span><span class="line" data-startTime="2695">current page and </span><span class="line" data-startTime="2695">the next page. </span> <span class="line" data-startTime="2696">We'll render the next page, </span><span class="line" data-startTime="2696">but we're going to be very </span><span class="line" data-startTime="2698">careful to only do a minimal </span><span class="line" data-startTime="2698">amount of rendering possible. </span> <span class="line" data-startTime="2702">So we don't want to render </span><span class="line" data-startTime="2702">everything, because that will </span><span class="line" data-startTime="2704">take too long. </span> <span class="line" data-startTime="2704">We want to start this animation </span><span class="line" data-startTime="2704">as soon as possible. </span> <span class="line" data-startTime="2709">We then apply our transform </span><span class="line" data-startTime="2709">properties, because using </span><span class="line" data-startTime="2711">transforms is the better way </span><span class="line" data-startTime="2711">to reposition an element. </span> <span class="line" data-startTime="2715">And we're going to do it such </span><span class="line" data-startTime="2715">that the current page animates </span><span class="line" data-startTime="2718">off the screen and the next page </span><span class="line" data-startTime="2718">animates onto the screen. </span></p>

<p><span class="line" data-startTime="2723">Remember, we want to make the </span><span class="line" data-startTime="2723">next page interactive. </span> <span class="line" data-startTime="2725">As soon as we apply these </span><span class="line" data-startTime="2725">transforms, the </span><span class="line" data-startTime="2727">animation will start. </span> <span class="line" data-startTime="2729">But we still have to do </span><span class="line" data-startTime="2729">additional work on the next </span><span class="line" data-startTime="2731">page to load in those extra </span><span class="line" data-startTime="2731">resources, images, maybe, and </span><span class="line" data-startTime="2734">add event listeners to it. </span> <span class="line" data-startTime="2736">So we can add an event listener </span><span class="line" data-startTime="2736">which will fire as </span><span class="line" data-startTime="2739">soon as the transition ends. </span> <span class="line" data-startTime="2741">And when it does, now this is </span><span class="line" data-startTime="2741">the appropriate time to do all </span><span class="line" data-startTime="2744">that additional rendering </span><span class="line" data-startTime="2744">and event setup. </span> <span class="line" data-startTime="2747">So what we have here </span><span class="line" data-startTime="2747">is probably </span><span class="line" data-startTime="2750">the ideal event handler. </span></p>

<p><span class="line" data-startTime="2751">It's a fast button. </span> <span class="line" data-startTime="2753">We do a minimal amount </span><span class="line" data-startTime="2753">of DOM changes. </span> <span class="line" data-startTime="2755">And all of our DOM changes </span><span class="line" data-startTime="2755">are batched together. </span> <span class="line" data-startTime="2757">And then we defer all of the </span><span class="line" data-startTime="2757">expensive work until after the </span><span class="line" data-startTime="2760">animation starts. </span> <span class="line" data-startTime="2761">And our animation is </span><span class="line" data-startTime="2761">hardware-accelerated. </span> <span class="line" data-startTime="2766">So that's all I have </span><span class="line" data-startTime="2766">for you today. </span> <span class="line" data-startTime="2769">Here's a summary of the various </span><span class="line" data-startTime="2771">optimizations that we did. </span> <span class="line" data-startTime="2773">And some of them were a little </span><span class="line" data-startTime="2773">bit surprising, so again, </span><span class="line" data-startTime="2776">that's why it's really good </span><span class="line" data-startTime="2776">that we measure things. </span> <span class="line" data-startTime="2778">So we don't just assume what's </span><span class="line" data-startTime="2778">going to happen. </span> <span class="line" data-startTime="2780">We confirm that it behaves </span><span class="line" data-startTime="2780">as expected. </span></p>

<p><span class="line" data-startTime="2784">And these are some of the </span><span class="line" data-startTime="2784">tools that we looked at. </span> <span class="line" data-startTime="2785">Chrome dev tools, PageSpeed, </span><span class="line" data-startTime="2785">and webpagetest.org. </span> <span class="line" data-startTime="2790">And if you're going to remember </span><span class="line" data-startTime="2790">anything, please </span><span class="line" data-startTime="2792">remember, don't waste </span><span class="line" data-startTime="2792">your time. </span> <span class="line" data-startTime="2793">Always measure before </span><span class="line" data-startTime="2793">and after. </span> <span class="line" data-startTime="2795">Verify all of your </span><span class="line" data-startTime="2795">assumptions. </span> <span class="line" data-startTime="2797">And optimize what will make a </span><span class="line" data-startTime="2797">difference, not just what's </span><span class="line" data-startTime="2800">interesting to work on. </span> <span class="line" data-startTime="2802">OK. </span> <span class="line" data-startTime="2803">Thank you very much. </span> <span class="line" data-startTime="2805">I'll happily take some questions </span><span class="line" data-startTime="2805">if people want. </span> <span class="line" data-startTime="2807">[APPLAUSE] </span></p>

<p class="speaker"><span class="line" data-starttime="2813"><span class="speakerName">Audience</span>: Hey there. </span></p>

<p class="speaker"><span class="line" data-starttime="2814"><span class="speakerName">Ryan Fioravanti</span>: I can also </span><span class="line" data-startTime="2814">stick around for a bit after, </span><span class="line" data-startTime="2815">if people would like </span><span class="line" data-startTime="2815">to talk in person. </span><span class="line" data-startTime="2817">But if you want to ask a </span><span class="line" data-startTime="2817">question in front of everyone, </span><span class="line" data-startTime="2819">just step up to the mic. </span></p>

<p class="speaker"><span class="line" data-starttime="2821"><span class="speakerName">Audience</span>: I was wondering if you </span><span class="line" data-startTime="2821">know if jQuery mobile uses </span><span class="line" data-startTime="2825">most of the optimizations that </span><span class="line" data-startTime="2825">you were just showing. </span></p>

<p class="speaker"><span class="line" data-starttime="2830"><span class="speakerName">Ryan Fioravanti</span>: jQuery </span><span class="line" data-startTime="2830">mobile, I know &mdash; </span><span class="line" data-startTime="2831">I'm pretty sure they have the </span><span class="line" data-startTime="2831">tab functionality, like making </span><span class="line" data-startTime="2835">buttons fast. </span><span class="line" data-startTime="2836">I've also seen that they've </span><span class="line" data-startTime="2836">worked a lot on view </span><span class="line" data-startTime="2838">transitions and things. </span><span class="line" data-startTime="2841">When you're using these </span><span class="line" data-startTime="2841">frameworks, they can try and </span><span class="line" data-startTime="2844">do a lot of stuff for you. </span><span class="line" data-startTime="2845">But based on all of your </span><span class="line" data-startTime="2845">integration points, it's </span><span class="line" data-startTime="2847">really easy to introduce </span><span class="line" data-startTime="2847">slow points. </span><span class="line" data-startTime="2850">So it's really important, even </span><span class="line" data-startTime="2850">if you're using all these </span><span class="line" data-startTime="2852">libraries, that you really dig </span><span class="line" data-startTime="2852">and understand what can make </span><span class="line" data-startTime="2854">your app slow. </span><span class="line" data-startTime="2855">And look at if it's </span><span class="line" data-startTime="2855">being slow. </span><span class="line" data-startTime="2857">Maybe jQuery mobile does do </span><span class="line" data-startTime="2857">all of this stuff, but you </span><span class="line" data-startTime="2860">have to confirm that you're </span><span class="line" data-startTime="2860">using it properly. </span><span class="line" data-startTime="2862">Because there's so much you </span><span class="line" data-startTime="2862">can do to screw it up. </span><span class="line" data-startTime="2865">So yeah. </span></p>

<p class="speaker"><span class="line" data-starttime="2868"><span class="speakerName">Audience</span>: Yeah. </span><span class="line" data-startTime="2868">I have a question about your </span><span class="line" data-startTime="2868">really interesting technique </span><span class="line" data-startTime="2871">for making the JavaScript </span><span class="line" data-startTime="2871">load later by making </span><span class="line" data-startTime="2874">it a different type. </span><span class="line" data-startTime="2875">I've seen a lot of people do the </span><span class="line" data-startTime="2875">technique where they put </span><span class="line" data-startTime="2877">the JavaScript at the </span><span class="line" data-startTime="2877">bottom of the page </span><span class="line" data-startTime="2878">instead of in the head. </span><span class="line" data-startTime="2880">How does that play into </span><span class="line" data-startTime="2880">the decision? </span></p>

<p class="speaker"><span class="line" data-starttime="2882"><span class="speakerName">Ryan Fioravanti</span>: Yeah, so I </span><span class="line" data-startTime="2882">tried moving the JavaScript to </span><span class="line" data-startTime="2884">the bottom of page. </span><span class="line" data-startTime="2889">When it's at the bottom of the </span><span class="line" data-startTime="2889">page, the browser has just </span><span class="line" data-startTime="2893">finished receiving the </span><span class="line" data-startTime="2893">entire document. </span><span class="line" data-startTime="2895">And so it's not clear whether </span><span class="line" data-startTime="2895">it's being painted or not. </span><span class="line" data-startTime="2899">And it then encounters the </span><span class="line" data-startTime="2899">JavaScript, which may or may </span><span class="line" data-startTime="2902">not be mutating the DOM. </span><span class="line" data-startTime="2903">So it then executes </span><span class="line" data-startTime="2903">all of that. </span><span class="line" data-startTime="2905">So when I did that, it didn't </span><span class="line" data-startTime="2905">actually have an impact on my </span><span class="line" data-startTime="2907">experiments at all. </span><span class="line" data-startTime="2909">And it kind of makes sense. </span><span class="line" data-startTime="2911">Like if your script at the </span><span class="line" data-startTime="2911">bottom is going to change </span><span class="line" data-startTime="2914">everything in the document, then </span><span class="line" data-startTime="2914">the browser should wait </span><span class="line" data-startTime="2916">for that so that you can show </span><span class="line" data-startTime="2916">the user the proper content. </span><span class="line" data-startTime="2922">Does that answer your question? </span><span class="line" data-startTime="2923">Yeah. </span></p>

<p class="speaker"><span class="line" data-starttime="2925"><span class="speakerName">Audience</span>: What tool </span><span class="line" data-startTime="2925">did you use to get </span><span class="line" data-startTime="2928">the repeated pageloads? </span></p>

<p class="speaker"><span class="line" data-starttime="2931"><span class="speakerName">Ryan Fioravanti</span>: So at first &mdash; </span><span class="line" data-startTime="2933">I'll be honest &mdash; </span><span class="line" data-startTime="2934">I was actually just refreshing </span><span class="line" data-startTime="2934">the page and looking at some </span><span class="line" data-startTime="2936">of the timing output </span><span class="line" data-startTime="2936">in the dev console. </span><span class="line" data-startTime="2938">But then I got much smarter and </span><span class="line" data-startTime="2938">I created a loop, kind of, </span><span class="line" data-startTime="2945">where the page would load and </span><span class="line" data-startTime="2945">then it would take my timing. </span><span class="line" data-startTime="2947">I would save that in </span><span class="line" data-startTime="2947">localStorage and then I would </span><span class="line" data-startTime="2950">call window.location.reload. </span><span class="line" data-startTime="2952">And also in localStorage, I </span><span class="line" data-startTime="2952">would save the number of times </span><span class="line" data-startTime="2955">I ran this. </span><span class="line" data-startTime="2956">So when that counter </span><span class="line" data-startTime="2956">got to 50 &mdash; </span><span class="line" data-startTime="2960">because I was running </span><span class="line" data-startTime="2960">50 samples &mdash; </span><span class="line" data-startTime="2962">then I would stop calling </span><span class="line" data-startTime="2962">reload, and I would just stop, </span><span class="line" data-startTime="2964">and I would alert the </span><span class="line" data-startTime="2964">average of all the </span><span class="line" data-startTime="2966">times that I was tracking. </span><span class="line" data-startTime="2970">So, no tool. </span><span class="line" data-startTime="2970">I just wrote something </span><span class="line" data-startTime="2970">that used </span><span class="line" data-startTime="2971">localStorage pretty quickly. </span><span class="line" data-startTime="2978">OK. </span><span class="line" data-startTime="2978">Thanks everybody. </span></p>