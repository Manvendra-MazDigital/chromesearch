<p class="speaker"><span class="line" data-starttime="0"><span class="speakerName">Ian Barber</span>: If any of you worry </span><span class="line" data-startTime="0">there's no space at the </span><span class="line" data-startTime="3">front, there's plenty. </span> <span class="line" data-startTime="4">Feel free to move. </span> <span class="line" data-startTime="6">So my name's Ian. </span> <span class="line" data-startTime="7">I'm a developer advocate </span><span class="line" data-startTime="7">with Google+. </span> <span class="line" data-startTime="10">And I'm going to talk today </span><span class="line" data-startTime="10">a little bit about using </span><span class="line" data-startTime="14">authentication systems for </span><span class="line" data-startTime="14">multiple providers in your </span><span class="line" data-startTime="16">code without having it turn into </span><span class="line" data-startTime="16">a giant ball of hay that </span><span class="line" data-startTime="21">you don't want to deal with. </span> <span class="line" data-startTime="24">Hopefully over the last day and </span><span class="line" data-startTime="24">a half, you've seen some </span><span class="line" data-startTime="29">things about sign-in in general, </span><span class="line" data-startTime="29">maybe Tim Bray's </span><span class="line" data-startTime="32">identity talk yesterday. </span> <span class="line" data-startTime="35">And you'll know that sign-in </span><span class="line" data-startTime="35">is difficult. </span></p>

<p><span class="line" data-startTime="38">It's very easy to make a fragile </span><span class="line" data-startTime="38">implementation of </span><span class="line" data-startTime="42">identity, of passwords, of </span><span class="line" data-startTime="42">dealing with account recovery, </span><span class="line" data-startTime="47">things like two-factor auth. </span> <span class="line" data-startTime="48">It's complicated. </span> <span class="line" data-startTime="50">And it's nice that you </span><span class="line" data-startTime="50">can defer that. </span> <span class="line" data-startTime="52">You can hand that off to some </span><span class="line" data-startTime="52">other party who's got the </span><span class="line" data-startTime="55">engineering, who's got the </span><span class="line" data-startTime="55">privacy and the security teams </span><span class="line" data-startTime="58">to look after it. </span> <span class="line" data-startTime="59">So I think social </span><span class="line" data-startTime="62">authentication is a good thing. </span> <span class="line" data-startTime="63">I think third party identity </span><span class="line" data-startTime="63">providers are a good thing. </span></p>

<p><span class="line" data-startTime="66">But it doesn't necessarily </span><span class="line" data-startTime="66">follow that it's a good thing </span><span class="line" data-startTime="68">to have multiple providers </span><span class="line" data-startTime="68">on, right? </span><span class="line" data-startTime="72">You can easily get into a </span><span class="line" data-startTime="72">situation where you have </span><span class="line" data-startTime="73">hundreds of buttons, and no </span><span class="line" data-startTime="73">one wants to deal with it. </span> <span class="line" data-startTime="76">But I think it is worth </span><span class="line" data-startTime="76">considering adding more than </span><span class="line" data-startTime="79">one identity provider </span><span class="line" data-startTime="79">to your application. </span> <span class="line" data-startTime="83">I think there's a reason that </span><span class="line" data-startTime="83">it's good for you, and there's </span><span class="line" data-startTime="85">a reason that it's good </span><span class="line" data-startTime="85">for the users. </span> <span class="line" data-startTime="87">For the users, it gives </span><span class="line" data-startTime="87">them choice. </span> <span class="line" data-startTime="89">And that choice is valuable. </span> <span class="line" data-startTime="91">That choice allows them to </span><span class="line" data-startTime="91">choose the one they're most </span><span class="line" data-startTime="95">familiar with, choose the </span><span class="line" data-startTime="95">one that works for them. </span></p>

<p><span class="line" data-startTime="98">But it also allows them to </span><span class="line" data-startTime="98">express a facet of their </span><span class="line" data-startTime="101">personality. </span> <span class="line" data-startTime="102">We don't all use the internet </span><span class="line" data-startTime="102">in the same way. </span> <span class="line" data-startTime="104">And we don't all use every </span><span class="line" data-startTime="104">service in the same way. </span> <span class="line" data-startTime="107">I have certain friends on </span><span class="line" data-startTime="107">certain sites and certain </span><span class="line" data-startTime="110">networks, and certain interests </span><span class="line" data-startTime="110">that I post there. </span> <span class="line" data-startTime="113">If I can sign into your app </span><span class="line" data-startTime="113">with the network that most </span><span class="line" data-startTime="117">closely aligns to my interest, </span><span class="line" data-startTime="117">I can express myself more </span><span class="line" data-startTime="120">accurately. </span> <span class="line" data-startTime="122">As a developer, the big gain is </span><span class="line" data-startTime="122">that these days, identity </span><span class="line" data-startTime="126">providers don't just </span><span class="line" data-startTime="126">provide identity. </span> <span class="line" data-startTime="128">They provide services. </span> <span class="line" data-startTime="129">And you get access to those </span><span class="line" data-startTime="129">APIs for users as well. </span> <span class="line" data-startTime="132">So it's valuable even if you </span><span class="line" data-startTime="132">have a user who is connected </span><span class="line" data-startTime="138">to connect an extra network to </span><span class="line" data-startTime="138">have ways of getting into </span><span class="line" data-startTime="141">additional systems so that you </span><span class="line" data-startTime="141">can enhance your application, </span><span class="line" data-startTime="145">so that you can add more </span><span class="line" data-startTime="145">services, so that you can do </span><span class="line" data-startTime="147">things which are a bit </span><span class="line" data-startTime="147">more interesting. </span></p>

<p><span class="line" data-startTime="150">Now adding an identity </span><span class="line" data-startTime="150">provider isn't </span><span class="line" data-startTime="151">actually that hard. </span> <span class="line" data-startTime="153">And if you just went out and </span><span class="line" data-startTime="153">tried to implement Google+ </span><span class="line" data-startTime="156">Sign-In or Facebook or Twitter </span><span class="line" data-startTime="156">or LinkedIn or whoever, you'd </span><span class="line" data-startTime="161">get it done in a reasonably </span><span class="line" data-startTime="161">short time. </span> <span class="line" data-startTime="163">It's somewhere between </span><span class="line" data-startTime="163">days and a few weeks. </span> <span class="line" data-startTime="166">But it's very, very easy to </span><span class="line" data-startTime="166">spread knowledge of how a user </span><span class="line" data-startTime="172">is created throughout your </span><span class="line" data-startTime="172">system and end up in a case </span><span class="line" data-startTime="175">where changing it then </span><span class="line" data-startTime="175">becomes tricky. </span> <span class="line" data-startTime="178">When there's an API change, when </span><span class="line" data-startTime="178">there is a newer version </span><span class="line" data-startTime="181">of something, it becomes </span><span class="line" data-startTime="181">complicated to do so. </span></p>

<p><span class="line" data-startTime="184">It becomes complicated </span><span class="line" data-startTime="184">to think about it. </span> <span class="line" data-startTime="187">So what I think we need to think </span><span class="line" data-startTime="187">about when we're talking </span><span class="line" data-startTime="190">about multiple providers is </span><span class="line" data-startTime="190">roughly these four things. </span> <span class="line" data-startTime="195">We have to think about how the </span><span class="line" data-startTime="195">user is authorized and </span><span class="line" data-startTime="198">authenticated. </span> <span class="line" data-startTime="199">We have to think about what are </span><span class="line" data-startTime="199">the capabilities of the </span><span class="line" data-startTime="202">various systems we're </span><span class="line" data-startTime="202">integrating with. </span> <span class="line" data-startTime="204">What's shared, and what's </span><span class="line" data-startTime="204">different, what's special. </span> <span class="line" data-startTime="207">We have to think about the </span><span class="line" data-startTime="207">data model on our side. </span> <span class="line" data-startTime="209">And we have to think about the </span><span class="line" data-startTime="209">story for the user side. </span> <span class="line" data-startTime="213">I'm not saying the user </span><span class="line" data-startTime="213">interface or the user </span><span class="line" data-startTime="215">experience. </span> <span class="line" data-startTime="216">Those are things which have been </span><span class="line" data-startTime="216">covered elsewhere and are </span><span class="line" data-startTime="220">well worth spending time on. </span> <span class="line" data-startTime="222">But I mean, why does </span><span class="line" data-startTime="222">the user sign in? </span><span class="line" data-startTime="224">What is the mechanism </span><span class="line" data-startTime="224">they are using? </span><span class="line" data-startTime="226">Why are they going to go </span><span class="line" data-startTime="226">and press this button? </span><span class="line" data-startTime="228">What do they get out of it? </span><span class="line" data-startTime="229">Telling that story is an </span><span class="line" data-startTime="229">important part of it, and </span><span class="line" data-startTime="232">having a feel for what signing </span><span class="line" data-startTime="232">in means in your application. </span></p>

<p><span class="line" data-startTime="237">So when I say authorization, </span><span class="line" data-startTime="237">I mean OAuth. </span> <span class="line" data-startTime="241">OAuth is the dominant pattern </span><span class="line" data-startTime="241">for authorizing access to </span><span class="line" data-startTime="245">services online, on </span><span class="line" data-startTime="245">the web at least. </span> <span class="line" data-startTime="249">And OAuth is very, very </span><span class="line" data-startTime="249">well established. </span> <span class="line" data-startTime="251">OAuth 2.0, standardized, lots </span><span class="line" data-startTime="251">of good implementations. </span> <span class="line" data-startTime="255">Most providers now are working </span><span class="line" data-startTime="255">with OAuth 2.0. </span> <span class="line" data-startTime="257">There are some with </span><span class="line" data-startTime="257">OAuth 1.0, though. </span> <span class="line" data-startTime="258">Twitter, I think, is </span><span class="line" data-startTime="258">a notable example. </span> <span class="line" data-startTime="260">But mostly, it's moved </span><span class="line" data-startTime="260">to OAuth 2.0. </span></p>

<p><span class="line" data-startTime="263">But OAuth is like giving the </span><span class="line" data-startTime="263">keys to your house to a real </span><span class="line" data-startTime="268">estate agent to show </span><span class="line" data-startTime="268">people around. </span> <span class="line" data-startTime="271">Those people can come </span><span class="line" data-startTime="271">to your house. </span> <span class="line" data-startTime="273">They can see what's there. </span> <span class="line" data-startTime="274">But they don't know </span><span class="line" data-startTime="274">who you are. </span> <span class="line" data-startTime="276">They just have access. </span> <span class="line" data-startTime="278">So on top of OAuth, </span><span class="line" data-startTime="278">we need to layer a </span><span class="line" data-startTime="281">service to give us identity. </span> <span class="line" data-startTime="284">And in fact, there's </span><span class="line" data-startTime="284">standardization happening in </span><span class="line" data-startTime="286">that area as well. </span> <span class="line" data-startTime="288">From the OpenID group, there's </span><span class="line" data-startTime="288">OpenID Connect, which is </span><span class="line" data-startTime="292">adding standardized identity </span><span class="line" data-startTime="292">services which you can call </span><span class="line" data-startTime="296">with OAuth authorization. </span> <span class="line" data-startTime="298">And we're involved in it. </span> <span class="line" data-startTime="300">Facebook are involved in it. </span></p>

<p><span class="line" data-startTime="301">A lot of the big systems </span><span class="line" data-startTime="301">are moving that way. </span> <span class="line" data-startTime="303">And I think that combination </span><span class="line" data-startTime="303">of OAuth 2.0 and OpenID </span><span class="line" data-startTime="306">Connect is very, very </span><span class="line" data-startTime="306">interesting. </span> <span class="line" data-startTime="307">There's a lot of very valuable </span><span class="line" data-startTime="307">and powerful concepts that </span><span class="line" data-startTime="309">come out of it. </span> <span class="line" data-startTime="310">And you'll see those spread </span><span class="line" data-startTime="310">through more of the more </span><span class="line" data-startTime="313">recent systems and services. </span> <span class="line" data-startTime="317">But if you you've done OAuth 2.0 </span><span class="line" data-startTime="317">before, you might think of </span><span class="line" data-startTime="319">a flow something like this. </span> <span class="line" data-startTime="321">There's an app. </span></p>

<p><span class="line" data-startTime="322">It generates a URL. </span> <span class="line" data-startTime="324">User clicks on the URL, </span><span class="line" data-startTime="324">goes to the provider, </span><span class="line" data-startTime="326">authenticates, comes back. </span> <span class="line" data-startTime="328">Sends a code to the </span><span class="line" data-startTime="328">application. </span> <span class="line" data-startTime="331">The application then exchanges </span><span class="line" data-startTime="331">it with an identity provider. </span> <span class="line" data-startTime="333">Straightforward, right? </span><span class="line" data-startTime="334">And this is well covered </span><span class="line" data-startTime="334">by libraries. </span> <span class="line" data-startTime="335">There's tons of libraries out </span><span class="line" data-startTime="335">here who will do OAuth </span><span class="line" data-startTime="337">exchange for you. </span> <span class="line" data-startTime="339">But even on the web, it's </span><span class="line" data-startTime="339">not that simple. </span> <span class="line" data-startTime="342">If you look at more modern </span><span class="line" data-startTime="342">implementations, like Google+ </span><span class="line" data-startTime="344">Sign-In, like Facebook's </span><span class="line" data-startTime="344">client-side sign-in, you'll </span><span class="line" data-startTime="347">see they don't actually </span><span class="line" data-startTime="347">redirect the user. </span> <span class="line" data-startTime="349">They spin up an iframe. </span> <span class="line" data-startTime="351">And in the iframe, the user </span><span class="line" data-startTime="351">communicates directly with the </span><span class="line" data-startTime="355">identity provider. </span></p>

<p><span class="line" data-startTime="356">And then they communicate with </span><span class="line" data-startTime="356">that iframe via the HTML5 post </span><span class="line" data-startTime="360">message API. </span> <span class="line" data-startTime="361">That's really cool. </span> <span class="line" data-startTime="362">It's faster. </span> <span class="line" data-startTime="363">You get bi-directional </span><span class="line" data-startTime="363">origin verification. </span> <span class="line" data-startTime="366">You get an ability to do things </span><span class="line" data-startTime="366">like seamlessly sign </span><span class="line" data-startTime="369">the user in when they </span><span class="line" data-startTime="369">visit a site. </span> <span class="line" data-startTime="371">You like those things. </span> <span class="line" data-startTime="372">But it means this flow </span><span class="line" data-startTime="372">isn't quite right. </span> <span class="line" data-startTime="374">On mobile, it's even worse. </span> <span class="line" data-startTime="376">On mobile, we have the </span><span class="line" data-startTime="376">same flow, maybe. </span> <span class="line" data-startTime="379">But how we actually deal </span><span class="line" data-startTime="379">with that varies. </span> <span class="line" data-startTime="382">Perhaps we'd want to bring a </span><span class="line" data-startTime="382">browser up in the application. </span></p>

<p><span class="line" data-startTime="385">That could be a WebView in </span><span class="line" data-startTime="385">Android or a UIWebView in iOS. </span> <span class="line" data-startTime="389">We'll have that flow, </span><span class="line" data-startTime="389">and that will work. </span> <span class="line" data-startTime="391">But that's a terrible experience </span><span class="line" data-startTime="391">for the users. </span> <span class="line" data-startTime="393">They definitely don't </span><span class="line" data-startTime="393">have a cookie. </span> <span class="line" data-startTime="394">So they're going to have </span><span class="line" data-startTime="394">to type in their </span><span class="line" data-startTime="396">username and password. </span> <span class="line" data-startTime="397">And when they do that, </span><span class="line" data-startTime="397">they can't see where </span><span class="line" data-startTime="399">they're typing it into. </span> <span class="line" data-startTime="400">They can't see the URL bar. </span> <span class="line" data-startTime="401">They can't check the </span><span class="line" data-startTime="401">certificate. </span> <span class="line" data-startTime="403">So maybe it's better to send </span><span class="line" data-startTime="403">them to the system browser. </span></p>

<p><span class="line" data-startTime="407">They may have cookies there. </span> <span class="line" data-startTime="408">That's great. </span> <span class="line" data-startTime="409">And they can check </span><span class="line" data-startTime="409">the certificate. </span> <span class="line" data-startTime="411">They can see where they are. </span> <span class="line" data-startTime="412">And that helps. </span> <span class="line" data-startTime="414">It's a better experience. </span> <span class="line" data-startTime="415">But the user can still kind </span><span class="line" data-startTime="415">of decide to go and </span><span class="line" data-startTime="417">do something else. </span> <span class="line" data-startTime="419">So in a lot of cases, it's </span><span class="line" data-startTime="419">actually nicer to authenticate </span><span class="line" data-startTime="422">via another application. </span> <span class="line" data-startTime="424">If you try and sign in on iOS </span><span class="line" data-startTime="424">with Google+, we'll actually </span><span class="line" data-startTime="428">take you to the Google+ </span><span class="line" data-startTime="428">iOS app. </span> <span class="line" data-startTime="431">And you'll sign in there. </span> <span class="line" data-startTime="432">And that's great because when </span><span class="line" data-startTime="432">you have a nice, fast consent </span><span class="line" data-startTime="434">screen, you're pretty much </span><span class="line" data-startTime="434">guaranteed to be signed in to </span><span class="line" data-startTime="437">the actual application. </span> <span class="line" data-startTime="438">And there's no other </span><span class="line" data-startTime="438">navigation. </span> <span class="line" data-startTime="440">You're not going to go off and </span><span class="line" data-startTime="440">look at a bookmark bar or </span><span class="line" data-startTime="442">something like that. </span></p>

<p><span class="line" data-startTime="443">And of course, you could have </span><span class="line" data-startTime="443">the actual authentication in </span><span class="line" data-startTime="446">the device itself. </span> <span class="line" data-startTime="448">And that's something like the </span><span class="line" data-startTime="448">account manager on Android or </span><span class="line" data-startTime="451">the Social Framework on iOS, </span><span class="line" data-startTime="451">where the accounts live with </span><span class="line" data-startTime="454">the device. </span> <span class="line" data-startTime="456">And all of these complicate </span><span class="line" data-startTime="456">how we implement even a </span><span class="line" data-startTime="459">straightforward flow. </span> <span class="line" data-startTime="461">So what we're trying to get </span><span class="line" data-startTime="461">to is something like this. </span> <span class="line" data-startTime="465">People don't use your </span><span class="line" data-startTime="465">app to sign in. </span> <span class="line" data-startTime="469">They sign in to use your app. </span></p>

<p><span class="line" data-startTime="470">They sign in to get value </span><span class="line" data-startTime="470">out of your app. </span> <span class="line" data-startTime="472">And that's all happening up in </span><span class="line" data-startTime="472">the controllers, in a standard </span><span class="line" data-startTime="475">sort of MVC pattern. </span> <span class="line" data-startTime="476">The controllers and the users. </span> <span class="line" data-startTime="478">The UI, it's the UX, it's the </span><span class="line" data-startTime="478">logic of what it's doing. </span> <span class="line" data-startTime="480">You don't want to be thinking </span><span class="line" data-startTime="480">in there about how your user </span><span class="line" data-startTime="484">came to be, about the process </span><span class="line" data-startTime="484">of identification. </span> <span class="line" data-startTime="487">You just want to think about </span><span class="line" data-startTime="487">what you can do with the user. </span> <span class="line" data-startTime="490">So what we want is for that </span><span class="line" data-startTime="490">user to be generic &mdash; </span><span class="line" data-startTime="494">well, specific to your app, but </span><span class="line" data-startTime="494">generic to the provider &mdash; </span><span class="line" data-startTime="497">and useful. </span> <span class="line" data-startTime="500">Down here, though, is where the </span><span class="line" data-startTime="500">actual user is generated. </span> <span class="line" data-startTime="503">That happens in the identity </span><span class="line" data-startTime="503">providers. </span> <span class="line" data-startTime="505">You know they're going to have </span><span class="line" data-startTime="505">to actually sign in there. </span></p>

<p><span class="line" data-startTime="508">And we don't want that leaking </span><span class="line" data-startTime="508">all the way into the </span><span class="line" data-startTime="510">controller. </span> <span class="line" data-startTime="510">So we need to put some </span><span class="line" data-startTime="510">layer in between. </span> <span class="line" data-startTime="513">And that's the idea that really </span><span class="line" data-startTime="513">underpins everything </span><span class="line" data-startTime="516">I'm going to talk about. </span> <span class="line" data-startTime="517">If you take one thing away, </span><span class="line" data-startTime="517">just take that away. </span> <span class="line" data-startTime="519">Try and separate the </span><span class="line" data-startTime="519">provisioning of identity from </span><span class="line" data-startTime="522">the usage of the user that </span><span class="line" data-startTime="522">has been identified. </span> <span class="line" data-startTime="526">So I've got some code </span><span class="line" data-startTime="526">examples in here. </span> <span class="line" data-startTime="528">And don't worry if you wonder &mdash; </span><span class="line" data-startTime="528">you know, you want to </span><span class="line" data-startTime="532">note some things </span><span class="line" data-startTime="532">or take photos. </span> <span class="line" data-startTime="534">All of the slides will </span><span class="line" data-startTime="534">be online afterwards. </span> <span class="line" data-startTime="536">The video for this talk </span><span class="line" data-startTime="536">will be on YouTube. </span></p>

<p><span class="line" data-startTime="538">And there is code in here. </span> <span class="line" data-startTime="539">I've got a bit of PHP for the </span><span class="line" data-startTime="539">web, a bit of Java for Android </span><span class="line" data-startTime="542">and a bit of Objective-C </span><span class="line" data-startTime="542">for iOS. </span> <span class="line" data-startTime="544">But little sample apps will </span><span class="line" data-startTime="544">all be up on GitHub </span><span class="line" data-startTime="546">afterwards. </span> <span class="line" data-startTime="547">So don't feel like you have </span><span class="line" data-startTime="547">to follow every line. </span> <span class="line" data-startTime="551">But this is kind of what we </span><span class="line" data-startTime="551">want to be able to do. </span> <span class="line" data-startTime="553">We want to be able to </span><span class="line" data-startTime="553">just get a user. </span> <span class="line" data-startTime="555">If I got a user? </span><span class="line" data-startTime="556">No. </span></p>

<p><span class="line" data-startTime="557">If I don't, redirect them. </span> <span class="line" data-startTime="558">If I do, use them. </span> <span class="line" data-startTime="560">I just get the name. </span> <span class="line" data-startTime="561">I activate it. </span> <span class="line" data-startTime="562">I don't have to think about </span><span class="line" data-startTime="562">how this user came to be. </span> <span class="line" data-startTime="565">I just have to use it. </span> <span class="line" data-startTime="567">So to do that, we </span><span class="line" data-startTime="567">need to mediate </span><span class="line" data-startTime="569">access to these things. </span> <span class="line" data-startTime="571">Down this side is roughly </span><span class="line" data-startTime="571">the user's flow if </span><span class="line" data-startTime="574">they're not logged in. </span> <span class="line" data-startTime="575">They'll come to some part of </span><span class="line" data-startTime="575">your application where they </span><span class="line" data-startTime="577">need to be logged in. </span> <span class="line" data-startTime="578">They'll be redirected to a login </span><span class="line" data-startTime="578">controller to choose </span><span class="line" data-startTime="581">their sign-in provider. </span> <span class="line" data-startTime="583">Then something will happen, </span><span class="line" data-startTime="583">depending on the provider. </span> <span class="line" data-startTime="585">And eventually, they'll come </span><span class="line" data-startTime="585">back to the callback, where </span><span class="line" data-startTime="588">they will be given </span><span class="line" data-startTime="588">back that code. </span> <span class="line" data-startTime="591">They will be given back </span><span class="line" data-startTime="591">some kind of token. </span> <span class="line" data-startTime="593">And we will need to bring that </span><span class="line" data-startTime="593">back into the application and </span><span class="line" data-startTime="596">sign them in. </span></p>

<p><span class="line" data-startTime="597">In between, we have this </span><span class="line" data-startTime="597">authenticator. </span> <span class="line" data-startTime="599">And the authenticator is </span><span class="line" data-startTime="599">handling all of the identity </span><span class="line" data-startTime="603">stuff for the vast majority </span><span class="line" data-startTime="603">of our app. </span> <span class="line" data-startTime="605">In our sample apps, there's </span><span class="line" data-startTime="605">probably more identity code </span><span class="line" data-startTime="608">than anything else. </span> <span class="line" data-startTime="608">But in reality, the vast </span><span class="line" data-startTime="608">majority of your code should </span><span class="line" data-startTime="611">be business code, should be </span><span class="line" data-startTime="611">doing what you want it to do. </span> <span class="line" data-startTime="614">So we can get the </span><span class="line" data-startTime="614">user from here. </span> <span class="line" data-startTime="616">We can list the providers so </span><span class="line" data-startTime="616">that we can create the sign-in </span><span class="line" data-startTime="618">options for them. </span> <span class="line" data-startTime="620">We can take the response from </span><span class="line" data-startTime="620">the outside world and route it </span><span class="line" data-startTime="623">to the appropriate provider. </span> <span class="line" data-startTime="624">And in all of these cases, we </span><span class="line" data-startTime="624">don't want to have to know </span><span class="line" data-startTime="628">which each provider is &mdash; </span><span class="line" data-startTime="631">what they're doing, </span><span class="line" data-startTime="631">how they work. </span> <span class="line" data-startTime="633">We want it to be hidden. </span> <span class="line" data-startTime="635">So we need an interface. </span> <span class="line" data-startTime="636">We need to separate the generic </span><span class="line" data-startTime="636">parts of going through </span><span class="line" data-startTime="639">a sign-in process, checking </span><span class="line" data-startTime="639">whether the user is </span><span class="line" data-startTime="642">authenticated, signing them in, </span><span class="line" data-startTime="642">verifying that response to </span><span class="line" data-startTime="645">make sure they're the </span><span class="line" data-startTime="645">user we expect. </span></p>

<p><span class="line" data-startTime="647">And we need to provide a user. </span> <span class="line" data-startTime="649">That's at the heart of it. </span> <span class="line" data-startTime="650">If we can't provide </span><span class="line" data-startTime="650">a user, we're not </span><span class="line" data-startTime="651">doing anything useful. </span> <span class="line" data-startTime="653">But then for each individual </span><span class="line" data-startTime="653">provider, we need to implement </span><span class="line" data-startTime="656">a specific strategy of how to </span><span class="line" data-startTime="656">go and do those things for </span><span class="line" data-startTime="660">this provider. </span> <span class="line" data-startTime="661">So we have an interface. </span> <span class="line" data-startTime="664">It's how we decompose things </span><span class="line" data-startTime="664">in an OO system. </span> <span class="line" data-startTime="667">We have an interface which </span><span class="line" data-startTime="667">defines exactly that thing. </span> <span class="line" data-startTime="669">These are the functions. </span> <span class="line" data-startTime="670">Now this is PHP, and it's the </span><span class="line" data-startTime="670">web, and it's a slightly noddy </span><span class="line" data-startTime="674">demo example, so I'm just </span><span class="line" data-startTime="674">getting a markup and getting </span><span class="line" data-startTime="677">script to actually </span><span class="line" data-startTime="677">do the request. </span> <span class="line" data-startTime="678">You might prefer to get a URL </span><span class="line" data-startTime="678">or to return an object or to </span><span class="line" data-startTime="682">return a reference </span><span class="line" data-startTime="682">to a template. </span> <span class="line" data-startTime="685">There's 100 different </span><span class="line" data-startTime="685">ways of doing it. </span></p>

<p><span class="line" data-startTime="686">But the general idea is, you're </span><span class="line" data-startTime="686">going to need something </span><span class="line" data-startTime="689">that will initiate </span><span class="line" data-startTime="689">the process. </span> <span class="line" data-startTime="691">And that's what that does </span><span class="line" data-startTime="691">in this example. </span> <span class="line" data-startTime="694">So even for a nice, </span><span class="line" data-startTime="694">standards-compliant, OAuth 2.0 </span><span class="line" data-startTime="698">implementation like </span><span class="line" data-startTime="698">GitHub, there's </span><span class="line" data-startTime="700">things that are specific. </span> <span class="line" data-startTime="702">GitHub have a certain way of </span><span class="line" data-startTime="702">dealing with redirect URIs </span><span class="line" data-startTime="705">that's not necessarily </span><span class="line" data-startTime="705">the same way every </span><span class="line" data-startTime="707">other provider does. </span> <span class="line" data-startTime="708">So we need to take that </span><span class="line" data-startTime="708">into consideration. </span> <span class="line" data-startTime="710">They also have their own URLs </span><span class="line" data-startTime="710">for getting a token in the </span><span class="line" data-startTime="713">OAuth flow. </span> <span class="line" data-startTime="714">They have their own URLs </span><span class="line" data-startTime="714">for exchanging &mdash; </span><span class="line" data-startTime="717">for sending the user </span><span class="line" data-startTime="717">to so that they can </span><span class="line" data-startTime="719">actually sign in. </span> <span class="line" data-startTime="720">And we want to encapsulate </span><span class="line" data-startTime="720">all that. </span></p>

<p><span class="line" data-startTime="722">So we have logic like this. </span> <span class="line" data-startTime="723">This is just going to create a </span><span class="line" data-startTime="723">token to avoid CSRF attacks. </span> <span class="line" data-startTime="729">Put that into a URL along with </span><span class="line" data-startTime="729">our client ID, our identifier </span><span class="line" data-startTime="733">of which application we are with </span><span class="line" data-startTime="733">GitHub, our state value </span><span class="line" data-startTime="737">there, and the URL we'd like </span><span class="line" data-startTime="737">users to be redirected to </span><span class="line" data-startTime="740">afterwards. </span> <span class="line" data-startTime="741">All of this is private. </span> <span class="line" data-startTime="742">All of this stays inside </span><span class="line" data-startTime="742">our GitHub class. </span> <span class="line" data-startTime="745">The external surface area </span><span class="line" data-startTime="745">is getting markup. </span> <span class="line" data-startTime="747">And in this case, we're just </span><span class="line" data-startTime="747">going to return a button. </span> <span class="line" data-startTime="749">It's a thing someone </span><span class="line" data-startTime="749">can click. </span> <span class="line" data-startTime="751">It's not complex. </span> <span class="line" data-startTime="752">We just get that URL, whack </span><span class="line" data-startTime="752">it into some HTML, </span><span class="line" data-startTime="755">someone clicks it, fine. </span> <span class="line" data-startTime="757">When they've done that, </span><span class="line" data-startTime="757">they're going </span><span class="line" data-startTime="758">to go away to GitHub. </span> <span class="line" data-startTime="759">They'll approve this </span><span class="line" data-startTime="759">access, hopefully. </span></p>

<p><span class="line" data-startTime="762">And when they come back, they're </span><span class="line" data-startTime="762">going to come back </span><span class="line" data-startTime="765">with a code. </span> <span class="line" data-startTime="766">That code is going to be sent </span><span class="line" data-startTime="766">to our authenticator. </span> <span class="line" data-startTime="768">Our authenticator is going to </span><span class="line" data-startTime="768">work out which provider it </span><span class="line" data-startTime="770">needs to go to and </span><span class="line" data-startTime="770">send it to that. </span> <span class="line" data-startTime="772">And at that point, we </span><span class="line" data-startTime="772">need to verify it. </span> <span class="line" data-startTime="775">So in this case, we're going </span><span class="line" data-startTime="775">to do a token exchange. </span> <span class="line" data-startTime="777">And we're going to look at the </span><span class="line" data-startTime="777">results of the token that </span><span class="line" data-startTime="780">comes back. </span> <span class="line" data-startTime="781">So we take the short-lived </span><span class="line" data-startTime="781">code we're given. </span> <span class="line" data-startTime="783">We send it off to GitHub. </span> <span class="line" data-startTime="784">We get back an access token. </span></p>

<p><span class="line" data-startTime="785">And we can look at that and see </span><span class="line" data-startTime="785">what we can do with it. </span> <span class="line" data-startTime="787">For example, we can go and get </span><span class="line" data-startTime="787">the user's profile so we know </span><span class="line" data-startTime="790">their name. </span> <span class="line" data-startTime="791">We know they are. </span> <span class="line" data-startTime="793">Now if we do this with Google+, </span><span class="line" data-startTime="793">we probably want to </span><span class="line" data-startTime="796">do it a little bit </span><span class="line" data-startTime="796">differently. </span> <span class="line" data-startTime="797">In Google+, we'd like to use </span><span class="line" data-startTime="797">this nice JavaScript </span><span class="line" data-startTime="800">postMessage flow. </span> <span class="line" data-startTime="801">So the markup isn't a link. </span> <span class="line" data-startTime="803">It's this tag, which has the </span><span class="line" data-startTime="803">g-signing class on it. </span> <span class="line" data-startTime="806">And that's going to generate a </span><span class="line" data-startTime="806">button that's going to trigger </span><span class="line" data-startTime="809">a JavaScript callback </span><span class="line" data-startTime="809">once they click it. </span> <span class="line" data-startTime="811">And then we can send the </span><span class="line" data-startTime="811">response of that callback back </span><span class="line" data-startTime="814">to our server. </span> <span class="line" data-startTime="815">So in this case, the user isn't </span><span class="line" data-startTime="815">getting redirected. </span></p>

<p><span class="line" data-startTime="817">We're handling that through </span><span class="line" data-startTime="817">JavaScript. </span> <span class="line" data-startTime="819">But the same end result </span><span class="line" data-startTime="819">kind of happens. </span> <span class="line" data-startTime="821">Some information comes back to </span><span class="line" data-startTime="821">our server, and we need to </span><span class="line" data-startTime="824">validate it. </span> <span class="line" data-startTime="826">So we can send it through to our </span><span class="line" data-startTime="826">validate function, which </span><span class="line" data-startTime="829">looks a bit like this. </span> <span class="line" data-startTime="830">Same idea. </span> <span class="line" data-startTime="831">Exchange token, get the </span><span class="line" data-startTime="831">user's profile. </span> <span class="line" data-startTime="834">In this case, we can use the </span><span class="line" data-startTime="834">Google PHP API client library </span><span class="line" data-startTime="838">to do that for us. </span> <span class="line" data-startTime="840">But in either case, we </span><span class="line" data-startTime="840">don't have to care. </span> <span class="line" data-startTime="842">We've done that. </span> <span class="line" data-startTime="843">We've got that information. </span></p>

<p><span class="line" data-startTime="844">We can generate a user and </span><span class="line" data-startTime="844">return it, and our controller </span><span class="line" data-startTime="846">code just deals with the user. </span> <span class="line" data-startTime="848">Doesn't have to think about </span><span class="line" data-startTime="848">how that user came to be. </span> <span class="line" data-startTime="852">But in our little example, I </span><span class="line" data-startTime="852">was just getting the name. </span> <span class="line" data-startTime="855">And the name's not </span><span class="line" data-startTime="855">very interesting. </span> <span class="line" data-startTime="857">We want to do more interesting </span><span class="line" data-startTime="857">things with the APIs we've </span><span class="line" data-startTime="860">exposed by signing in </span><span class="line" data-startTime="860">with a provider. </span> <span class="line" data-startTime="863">And that's tricky because when </span><span class="line" data-startTime="863">we're doing that, we need to </span><span class="line" data-startTime="867">think about what specific </span><span class="line" data-startTime="867">functionality </span><span class="line" data-startTime="869">each provider provides. </span> <span class="line" data-startTime="872">There's very little that is </span><span class="line" data-startTime="872">shared between everyone you </span><span class="line" data-startTime="874">could sign in with. </span></p>

<p><span class="line" data-startTime="876">All we need to do, though, is </span><span class="line" data-startTime="876">to think about what we're </span><span class="line" data-startTime="878">trying to do rather than how </span><span class="line" data-startTime="878">we're actually doing it. </span> <span class="line" data-startTime="882">If you imagine you had a section </span><span class="line" data-startTime="882">on a site that had a </span><span class="line" data-startTime="884">kind of "Recommended For You," </span><span class="line" data-startTime="884">and there was a provider that </span><span class="line" data-startTime="887">returned an interest list, and </span><span class="line" data-startTime="887">that was a list of entries in </span><span class="line" data-startTime="891">a database in some graph </span><span class="line" data-startTime="891">database somewhere that said </span><span class="line" data-startTime="894">what you were interested in or </span><span class="line" data-startTime="894">a list of entities that you </span><span class="line" data-startTime="897">were interested in, and you were </span><span class="line" data-startTime="897">extracting tags out of </span><span class="line" data-startTime="899">that and using those </span><span class="line" data-startTime="899">tags to look up </span><span class="line" data-startTime="901">content in your database. </span> <span class="line" data-startTime="903">If you model it mentally as, </span><span class="line" data-startTime="903">I get that information from </span><span class="line" data-startTime="906">there, you're limited. </span></p>

<p><span class="line" data-startTime="908">You can only do it with them. </span> <span class="line" data-startTime="909">If you think about, I just need </span><span class="line" data-startTime="909">a list of tags, then you </span><span class="line" data-startTime="912">can do it a number of </span><span class="line" data-startTime="912">different ways. </span> <span class="line" data-startTime="914">You could get those tags </span><span class="line" data-startTime="914">by looking at a social </span><span class="line" data-startTime="916">bookmarking site. </span> <span class="line" data-startTime="917">You could get it from posts </span><span class="line" data-startTime="917">or hashtags on a social </span><span class="line" data-startTime="919">networking site. </span> <span class="line" data-startTime="920">You could go and look </span><span class="line" data-startTime="920">at someone's </span><span class="line" data-startTime="921">YouTube watch history. </span> <span class="line" data-startTime="923">Once you think about it in terms </span><span class="line" data-startTime="923">of the feature you're </span><span class="line" data-startTime="925">actually trying to provide, you </span><span class="line" data-startTime="925">then have the flexibility </span><span class="line" data-startTime="928">to implement it different ways </span><span class="line" data-startTime="928">with different providers. </span> <span class="line" data-startTime="931">It's the same idea of separating </span><span class="line" data-startTime="931">and abstraction </span><span class="line" data-startTime="933">there and not leaking the </span><span class="line" data-startTime="933">details of that provider </span><span class="line" data-startTime="937">through to your application. </span></p>

<p><span class="line" data-startTime="939">So that means we need to </span><span class="line" data-startTime="939">represent the user. </span> <span class="line" data-startTime="941">And we do that, again, with an </span><span class="line" data-startTime="941">interface because each of </span><span class="line" data-startTime="944">these providers is going to </span><span class="line" data-startTime="944">return their own concrete user </span><span class="line" data-startTime="947">object which provides </span><span class="line" data-startTime="947">this interface. </span> <span class="line" data-startTime="950">So we've got the name. </span> <span class="line" data-startTime="951">We've got the provider ID. </span> <span class="line" data-startTime="953">We've got whether they can </span><span class="line" data-startTime="953">do a certain feature. </span> <span class="line" data-startTime="955">And we've got signOut and </span><span class="line" data-startTime="955">disconnect so we can obey the </span><span class="line" data-startTime="958">various rules for various </span><span class="line" data-startTime="958">networks on what options </span><span class="line" data-startTime="960">should be given to users. </span> <span class="line" data-startTime="962">But you'll note that we've made </span><span class="line" data-startTime="962">a decision here which is </span><span class="line" data-startTime="965">a little bit subtle in that this </span><span class="line" data-startTime="965">user has a provider and a </span><span class="line" data-startTime="970">ID, just the one. </span> <span class="line" data-startTime="973">We've made the decision that </span><span class="line" data-startTime="973">what's happening here is you </span><span class="line" data-startTime="975">are signing in, not </span><span class="line" data-startTime="975">signing up. </span></p>

<p><span class="line" data-startTime="979">And both models are common. </span> <span class="line" data-startTime="981">When you sign in, there is a </span><span class="line" data-startTime="981">one-to-one mapping between an </span><span class="line" data-startTime="984">identity provider account and </span><span class="line" data-startTime="984">an application account. </span> <span class="line" data-startTime="988">When you sign up, there is a </span><span class="line" data-startTime="988">many-to-one mapping between </span><span class="line" data-startTime="992">identity providers and </span><span class="line" data-startTime="992">a single app account. </span> <span class="line" data-startTime="996">So each case is valid. </span> <span class="line" data-startTime="998">Each case is a reasonable </span><span class="line" data-startTime="998">thing. </span> <span class="line" data-startTime="1000">I can sign in with GitHub and </span><span class="line" data-startTime="1000">be me and sign in as Google+ </span><span class="line" data-startTime="1004">and be me, or I can sign in with </span><span class="line" data-startTime="1004">those two networks and be </span><span class="line" data-startTime="1007">two different users </span><span class="line" data-startTime="1007">on the system. </span> <span class="line" data-startTime="1009">It depends on what </span><span class="line" data-startTime="1009">you're doing. </span> <span class="line" data-startTime="1011">And communicating this is part </span><span class="line" data-startTime="1011">of what the user story is, </span><span class="line" data-startTime="1014">making them understand what's </span><span class="line" data-startTime="1014">valuable for them. </span> <span class="line" data-startTime="1018">But who is the user, anyway? </span><span class="line" data-startTime="1020">What are we actually storing? </span><span class="line" data-startTime="1022">What are we actually </span><span class="line" data-startTime="1022">working with? </span><span class="line" data-startTime="1024">A lot of the time when people </span><span class="line" data-startTime="1024">implement a provider, they </span><span class="line" data-startTime="1028">take the ID, and they stick it </span><span class="line" data-startTime="1028">in the database column, and </span><span class="line" data-startTime="1030">they're done. </span></p>

<p><span class="line" data-startTime="1031">And that's bad. </span> <span class="line" data-startTime="1033">Because when you do that, you've </span><span class="line" data-startTime="1033">coupled yourself to </span><span class="line" data-startTime="1035">that provider. </span> <span class="line" data-startTime="1035">As soon as you add another </span><span class="line" data-startTime="1035">one, that ID is no longer </span><span class="line" data-startTime="1039">enough information. </span> <span class="line" data-startTime="1040">You need to always store a </span><span class="line" data-startTime="1040">tuple, a pair of the provider </span><span class="line" data-startTime="1045">and the provider user ID. </span> <span class="line" data-startTime="1047">So in this case, this is Google </span><span class="line" data-startTime="1047">and my Google ID, </span><span class="line" data-startTime="1049">Facebook and my Facebook ID, </span><span class="line" data-startTime="1049">LinkedIn and my LinkedIn ID. </span> <span class="line" data-startTime="1053">Those are all identifiers. </span> <span class="line" data-startTime="1054">And I can have multiple of those </span><span class="line" data-startTime="1054">referring to the same </span><span class="line" data-startTime="1058">app user if I want to. </span> <span class="line" data-startTime="1061">And this is why things like </span><span class="line" data-startTime="1061">upgrade are not a problem. </span> <span class="line" data-startTime="1065">If you already had an OAuth 2.0 </span><span class="line" data-startTime="1065">login, and you wanted to </span><span class="line" data-startTime="1067">go to Google+ Sign-In, it's </span><span class="line" data-startTime="1067">not a problem because the </span><span class="line" data-startTime="1070">provider is still Google. </span> <span class="line" data-startTime="1072">The user ID is still </span><span class="line" data-startTime="1072">that user ID. </span></p>

<p><span class="line" data-startTime="1074">It's just a different way </span><span class="line" data-startTime="1074">of getting there. </span> <span class="line" data-startTime="1076">And thinking about it that way </span><span class="line" data-startTime="1076">means that you don't have to </span><span class="line" data-startTime="1079">worry about the exact strategy </span><span class="line" data-startTime="1079">being used to sign a user in. </span> <span class="line" data-startTime="1082">If you use a completely </span><span class="line" data-startTime="1082">different system on mobile </span><span class="line" data-startTime="1084">than you do on the web, as long </span><span class="line" data-startTime="1084">as it results in that </span><span class="line" data-startTime="1087">pair, you know it's </span><span class="line" data-startTime="1087">the same user. </span> <span class="line" data-startTime="1089">And that's great. </span> <span class="line" data-startTime="1091">Now the other thing people </span><span class="line" data-startTime="1091">look at is email. </span> <span class="line" data-startTime="1094">And email is often used to </span><span class="line" data-startTime="1094">combine accounts, which feels </span><span class="line" data-startTime="1097">like a good thing. </span></p>

<p><span class="line" data-startTime="1098">But it's tricky. </span> <span class="line" data-startTime="1101">When you have an email address, </span><span class="line" data-startTime="1101">you have some </span><span class="line" data-startTime="1105">knowledge about that user. </span> <span class="line" data-startTime="1106">That user probably had </span><span class="line" data-startTime="1106">that email address. </span> <span class="line" data-startTime="1108">Most providers will do </span><span class="line" data-startTime="1108">some verification. </span> <span class="line" data-startTime="1110">But the verification is likely </span><span class="line" data-startTime="1110">to be point in time. </span> <span class="line" data-startTime="1113">So at some point, the identity </span><span class="line" data-startTime="1113">provider sent an </span><span class="line" data-startTime="1117">email to that address. </span> <span class="line" data-startTime="1118">The user clicked the email. </span> <span class="line" data-startTime="1119">They had that address then. </span> <span class="line" data-startTime="1121">But particularly with corporate </span><span class="line" data-startTime="1121">email, with email on </span><span class="line" data-startTime="1124">free providers, sometimes </span><span class="line" data-startTime="1124">things get reused. </span> <span class="line" data-startTime="1127">Sometimes email belongs </span><span class="line" data-startTime="1127">to a different person. </span></p>

<p><span class="line" data-startTime="1131">But it doesn't mean that all the </span><span class="line" data-startTime="1131">other identities that have </span><span class="line" data-startTime="1134">been associated with that </span><span class="line" data-startTime="1134">email get invalidated. </span> <span class="line" data-startTime="1136">So it can be a little risky </span><span class="line" data-startTime="1136">at times to rely on email. </span> <span class="line" data-startTime="1143">The OpenID Connect spec actually </span><span class="line" data-startTime="1143">says, do not assume </span><span class="line" data-startTime="1147">email to be a unique </span><span class="line" data-startTime="1147">identifier. </span> <span class="line" data-startTime="1149">It is totally fine for an </span><span class="line" data-startTime="1149">identity provider to return an </span><span class="line" data-startTime="1153">email address &mdash; </span><span class="line" data-startTime="1154">the same email address &mdash; for </span><span class="line" data-startTime="1154">two different accounts. </span> <span class="line" data-startTime="1156">You should always look for </span><span class="line" data-startTime="1156">that ID and that provider </span><span class="line" data-startTime="1159">identification. </span> <span class="line" data-startTime="1160">That's the most reliable way </span><span class="line" data-startTime="1160">of dealing with them. </span> <span class="line" data-startTime="1163">But the way of having multiple </span><span class="line" data-startTime="1163">accounts is nice. </span></p>

<p><span class="line" data-startTime="1166">So the Android code is in the </span><span class="line" data-startTime="1166">GitHub repo, the sort of </span><span class="line" data-startTime="1170">sample we're working with. </span> <span class="line" data-startTime="1171">That has this basic idea. </span> <span class="line" data-startTime="1173">You can sign in, and there's a </span><span class="line" data-startTime="1173">bunch of features, pretty much </span><span class="line" data-startTime="1176">the same as PHP. </span> <span class="line" data-startTime="1178">And when you sign in, we enable </span><span class="line" data-startTime="1178">the features that go </span><span class="line" data-startTime="1180">with that network. </span> <span class="line" data-startTime="1182">But at this point, </span><span class="line" data-startTime="1182">we've created an </span><span class="line" data-startTime="1185">app account as well. </span> <span class="line" data-startTime="1186">That's why it can say, thank </span><span class="line" data-startTime="1186">you for using our app. </span></p>

<p><span class="line" data-startTime="1188">Because it knows I'm new. </span> <span class="line" data-startTime="1190">I have local state to go with </span><span class="line" data-startTime="1190">my identity provider state. </span> <span class="line" data-startTime="1194">And that means I can attach </span><span class="line" data-startTime="1194">other identity </span><span class="line" data-startTime="1197">providers as well. </span> <span class="line" data-startTime="1199">And then I get more features </span><span class="line" data-startTime="1199">available to me because those </span><span class="line" data-startTime="1202">providers provide additional </span><span class="line" data-startTime="1202">features. </span> <span class="line" data-startTime="1204">And this pattern is very, very </span><span class="line" data-startTime="1204">common in the real world. </span> <span class="line" data-startTime="1207">This is TuneIn Radio, The Fancy, </span><span class="line" data-startTime="1207">and Banjo, all who </span><span class="line" data-startTime="1210">implement pretty much </span><span class="line" data-startTime="1210">this structure. </span> <span class="line" data-startTime="1212">And you'll see it in </span><span class="line" data-startTime="1212">many, many apps. </span></p>

<p><span class="line" data-startTime="1215">All of them allowing you to </span><span class="line" data-startTime="1215">map multiple identity </span><span class="line" data-startTime="1217">providers to a single </span><span class="line" data-startTime="1217">user account. </span> <span class="line" data-startTime="1220">And that means you need to think </span><span class="line" data-startTime="1220">about how the data is </span><span class="line" data-startTime="1222">structured differently. </span> <span class="line" data-startTime="1224">You can't think about </span><span class="line" data-startTime="1224">one table of a user. </span> <span class="line" data-startTime="1227">You have to have a separation </span><span class="line" data-startTime="1227">between the identity provider </span><span class="line" data-startTime="1230">and the user. </span> <span class="line" data-startTime="1231">And it's many-to-one. </span> <span class="line" data-startTime="1233">This is good, though, because </span><span class="line" data-startTime="1233">once you have this second </span><span class="line" data-startTime="1235">table that has the provider user </span><span class="line" data-startTime="1235">ID, you can then key data </span><span class="line" data-startTime="1239">against it. </span> <span class="line" data-startTime="1240">So if you retrieve some </span><span class="line" data-startTime="1240">information, you can put it </span><span class="line" data-startTime="1243">into another table keyed against </span><span class="line" data-startTime="1243">the provider user ID. </span></p>

<p><span class="line" data-startTime="1246">Which means if you need to </span><span class="line" data-startTime="1246">disconnect a user, and you </span><span class="line" data-startTime="1249">have to follow data deletion </span><span class="line" data-startTime="1249">rules, it's easy. </span> <span class="line" data-startTime="1252">You just look up everything </span><span class="line" data-startTime="1252">attached to that ID. </span> <span class="line" data-startTime="1254">If you have to expire a cache </span><span class="line" data-startTime="1254">after a certain amount of </span><span class="line" data-startTime="1258">time, then it's easy. </span> <span class="line" data-startTime="1260">You just look up everything </span><span class="line" data-startTime="1260">connected to that ID. </span> <span class="line" data-startTime="1263">So having this separation makes </span><span class="line" data-startTime="1263">it easier to structure </span><span class="line" data-startTime="1265">your applications and structure </span><span class="line" data-startTime="1265">the data retrieved </span><span class="line" data-startTime="1268">from your applications and the </span><span class="line" data-startTime="1268">provenance of that data. </span></p>

<p><span class="line" data-startTime="1273">So to do this, we're going </span><span class="line" data-startTime="1273">to do things a little bit </span><span class="line" data-startTime="1275">differently. </span> <span class="line" data-startTime="1275">We've still got the </span><span class="line" data-startTime="1275">same basic model. </span> <span class="line" data-startTime="1276">We've got our authenticator </span><span class="line" data-startTime="1276">layer in the middle. </span> <span class="line" data-startTime="1278">Though in this case, it's </span><span class="line" data-startTime="1278">going to be a fragment. </span> <span class="line" data-startTime="1280">We've got our providers, which </span><span class="line" data-startTime="1280">are going to be fairly dumb. </span> <span class="line" data-startTime="1284">And we've got our activity. </span> <span class="line" data-startTime="1286">But we know that our providers </span><span class="line" data-startTime="1286">are going to want to hold a </span><span class="line" data-startTime="1290">little bit more state. </span> <span class="line" data-startTime="1292">We'd like our providers to be </span><span class="line" data-startTime="1292">able to be signed in, so that </span><span class="line" data-startTime="1295">when you go in and attach </span><span class="line" data-startTime="1295">them, if you've already </span><span class="line" data-startTime="1297">authenticated with that app in </span><span class="line" data-startTime="1297">that device, it's quick. </span> <span class="line" data-startTime="1300">It's a quick thing to do. </span> <span class="line" data-startTime="1302">So it speeds the process </span><span class="line" data-startTime="1302">for the user. </span></p>

<p><span class="line" data-startTime="1305">And we know we're going to </span><span class="line" data-startTime="1305">have to pass around some </span><span class="line" data-startTime="1307">information. </span> <span class="line" data-startTime="1308">Activity results are going to </span><span class="line" data-startTime="1308">have to flow all the way back </span><span class="line" data-startTime="1310">from the outside world, if it's </span><span class="line" data-startTime="1310">going out to the system </span><span class="line" data-startTime="1313">browser, back in to </span><span class="line" data-startTime="1313">our provider. </span> <span class="line" data-startTime="1315">But it's roughly </span><span class="line" data-startTime="1315">the same idea. </span> <span class="line" data-startTime="1316">We're sending information </span><span class="line" data-startTime="1316">back to be verified. </span> <span class="line" data-startTime="1319">And when we're done, we </span><span class="line" data-startTime="1319">send the user back. </span></p>

<p><span class="line" data-startTime="1322">But there's an extra </span><span class="line" data-startTime="1322">complication in it. </span> <span class="line" data-startTime="1324">In this middle layer, we </span><span class="line" data-startTime="1324">don't just send the </span><span class="line" data-startTime="1327">user straight back. </span> <span class="line" data-startTime="1328">It's the same as in PHP. </span> <span class="line" data-startTime="1330">We have a user created </span><span class="line" data-startTime="1330">in our provider. </span> <span class="line" data-startTime="1332">But we don't just send </span><span class="line" data-startTime="1332">it straight back </span><span class="line" data-startTime="1334">out to our main activity. </span> <span class="line" data-startTime="1336">Instead, we have this account </span><span class="line" data-startTime="1336">user concept, because we need </span><span class="line" data-startTime="1340">to be able to deal </span><span class="line" data-startTime="1340">with those cases. </span> <span class="line" data-startTime="1344">We need to be able to go, does </span><span class="line" data-startTime="1344">this identity provider user </span><span class="line" data-startTime="1348">map to an account user? </span><span class="line" data-startTime="1349">Does it map to an account user </span><span class="line" data-startTime="1349">when one is already signed in? </span><span class="line" data-startTime="1353">Is it the same user? </span><span class="line" data-startTime="1354">We need to consider that state </span><span class="line" data-startTime="1354">before we return anything. </span> <span class="line" data-startTime="1358">And we won't return anything </span><span class="line" data-startTime="1358">until we've resolved it into a </span><span class="line" data-startTime="1360">central reliable application </span><span class="line" data-startTime="1360">user. </span> <span class="line" data-startTime="1365">So it's pretty straightforward </span><span class="line" data-startTime="1365">for our activities. </span> <span class="line" data-startTime="1367">They get to do things </span><span class="line" data-startTime="1367">like this. </span></p>

<p><span class="line" data-startTime="1368">They get a callback. </span> <span class="line" data-startTime="1369">They can get the name. </span> <span class="line" data-startTime="1370">They can test the features. </span> <span class="line" data-startTime="1371">They can see if the </span><span class="line" data-startTime="1371">user's new. </span> <span class="line" data-startTime="1373">Simple. </span> <span class="line" data-startTime="1374">They don't have to </span><span class="line" data-startTime="1374">do much at all. </span> <span class="line" data-startTime="1377">Our sign-in user, however, has </span><span class="line" data-startTime="1377">to do a lot more work. </span> <span class="line" data-startTime="1380">Rather than just being an </span><span class="line" data-startTime="1380">interface, it's now a concrete </span><span class="line" data-startTime="1383">object because it needs to carry </span><span class="line" data-startTime="1383">with it information. </span> <span class="line" data-startTime="1386">It needs to carry with it the </span><span class="line" data-startTime="1386">provider data for all of the </span><span class="line" data-startTime="1390">providers that are attached. </span> <span class="line" data-startTime="1391">Previously, that was </span><span class="line" data-startTime="1391">kind of built in. </span> <span class="line" data-startTime="1393">If you had a Google user, </span><span class="line" data-startTime="1393">that Google user </span><span class="line" data-startTime="1395">came with that data. </span> <span class="line" data-startTime="1396">In this case, we want to attach </span><span class="line" data-startTime="1396">Google data or LinkedIn </span><span class="line" data-startTime="1399">data or Facebook data into </span><span class="line" data-startTime="1399">the same object. </span> <span class="line" data-startTime="1401">And we need access </span><span class="line" data-startTime="1401">to a database. </span></p>

<p><span class="line" data-startTime="1403">Now in this case, this is </span><span class="line" data-startTime="1403">just a local SQLite. </span> <span class="line" data-startTime="1406">In reality you'd probably be </span><span class="line" data-startTime="1406">using Cinque to sync down to a </span><span class="line" data-startTime="1411">web service somewhere or other </span><span class="line" data-startTime="1411">kind of communication. </span> <span class="line" data-startTime="1414">And your user store would </span><span class="line" data-startTime="1414">be on a server. </span> <span class="line" data-startTime="1417">But the basic concept </span><span class="line" data-startTime="1417">is similar. </span> <span class="line" data-startTime="1419">You're going to have this </span><span class="line" data-startTime="1419">representation of a user </span><span class="line" data-startTime="1423">stored away in a database. </span> <span class="line" data-startTime="1425">So to add a provider, all we </span><span class="line" data-startTime="1425">need to do is put their </span><span class="line" data-startTime="1428">information into that hash we </span><span class="line" data-startTime="1428">defined earlier, and then, if </span><span class="line" data-startTime="1431">the user ID is null &mdash; and that </span><span class="line" data-startTime="1431">ID, that mId, is the account </span><span class="line" data-startTime="1436">user ID, is the app user ID. </span> <span class="line" data-startTime="1438">It's not a provider one. </span> <span class="line" data-startTime="1439">That's why there's just an </span><span class="line" data-startTime="1439">ID no matching provider. </span></p>

<p><span class="line" data-startTime="1442">If it's null, we're going </span><span class="line" data-startTime="1442">to then go and </span><span class="line" data-startTime="1444">retrieve a user ID. </span> <span class="line" data-startTime="1446">Say, has this user signed </span><span class="line" data-startTime="1446">in with this provider? </span><span class="line" data-startTime="1449">If they have, great. </span> <span class="line" data-startTime="1450">We know who this is. </span> <span class="line" data-startTime="1451">We can go with it. </span> <span class="line" data-startTime="1452">If they haven't, we </span><span class="line" data-startTime="1452">can create a user. </span> <span class="line" data-startTime="1455">And that's when we can </span><span class="line" data-startTime="1455">set the IsNew flag. </span> <span class="line" data-startTime="1457">We know we've had to build </span><span class="line" data-startTime="1457">a user for this. </span> <span class="line" data-startTime="1459">And all that's doing is just </span><span class="line" data-startTime="1459">insert some reads on those </span><span class="line" data-startTime="1462">database tables. </span> <span class="line" data-startTime="1464">And then it's easy. </span> <span class="line" data-startTime="1466">Dealing with things like </span><span class="line" data-startTime="1466">features, all the features are </span><span class="line" data-startTime="1468">is just a set of features </span><span class="line" data-startTime="1468">provided by </span><span class="line" data-startTime="1470">each connected provider. </span> <span class="line" data-startTime="1472">So we just loop over the </span><span class="line" data-startTime="1472">providers we have in our </span><span class="line" data-startTime="1474">object, and we can test </span><span class="line" data-startTime="1474">them to see, do you </span><span class="line" data-startTime="1476">provide this feature? </span><span class="line" data-startTime="1477">If you do, I'm good to go. </span></p>

<p><span class="line" data-startTime="1479">Very simple for our object. </span> <span class="line" data-startTime="1480">And note, it doesn't have to </span><span class="line" data-startTime="1480">know anything about who these </span><span class="line" data-startTime="1483">providers are. </span> <span class="line" data-startTime="1484">The user never has to care about </span><span class="line" data-startTime="1484">who the providers are. </span> <span class="line" data-startTime="1487">They just follow </span><span class="line" data-startTime="1487">the interface. </span> <span class="line" data-startTime="1490">So you don't have to leak that </span><span class="line" data-startTime="1490">provider-specific code into </span><span class="line" data-startTime="1493">anywhere else in your </span><span class="line" data-startTime="1493">application. </span> <span class="line" data-startTime="1496">But the provider-specific code </span><span class="line" data-startTime="1496">gets to be relatively </span><span class="line" data-startTime="1498">straightforward as well. </span> <span class="line" data-startTime="1499">You don't have to do too much </span><span class="line" data-startTime="1499">with it because it doesn't </span><span class="line" data-startTime="1502">have to carry much more than </span><span class="line" data-startTime="1502">just its general state. </span> <span class="line" data-startTime="1506">So when we want to attempt to </span><span class="line" data-startTime="1506">sign in, to see if we've got a </span><span class="line" data-startTime="1510">connection using Facebook, </span><span class="line" data-startTime="1510">we can just use the </span><span class="line" data-startTime="1512">openActiveSession call with </span><span class="line" data-startTime="1512">allowLoginUI set to false. </span> <span class="line" data-startTime="1515">So that's that middle </span><span class="line" data-startTime="1515">parameter there. </span> <span class="line" data-startTime="1517">And that means, we'll try and </span><span class="line" data-startTime="1517">see whether we have a valid </span><span class="line" data-startTime="1519">Facebook session running. </span></p>

<p><span class="line" data-startTime="1520">If we do, cool. </span> <span class="line" data-startTime="1523">We've gotten a user account </span><span class="line" data-startTime="1523">ready to go. </span> <span class="line" data-startTime="1524">So if the user taps on us, we </span><span class="line" data-startTime="1524">can immediately serve it. </span> <span class="line" data-startTime="1527">If not, fine. </span> <span class="line" data-startTime="1529">We'll just leave it. </span> <span class="line" data-startTime="1530">In the sign-in, though, where </span><span class="line" data-startTime="1530">a user action has been </span><span class="line" data-startTime="1533">requested, we make the same </span><span class="line" data-startTime="1533">call but with that </span><span class="line" data-startTime="1535">allowLoginUI set to true. </span> <span class="line" data-startTime="1537">So we'll actively go </span><span class="line" data-startTime="1537">and make a call. </span> <span class="line" data-startTime="1539">We'll actively present dialogue </span><span class="line" data-startTime="1539">to the users for them </span><span class="line" data-startTime="1542">to sign in with. </span> <span class="line" data-startTime="1544">It's precisely the same </span><span class="line" data-startTime="1544">with Google+. </span> <span class="line" data-startTime="1546">When we go in, we have </span><span class="line" data-startTime="1546">a connect call. </span> <span class="line" data-startTime="1548">That's going to connect to </span><span class="line" data-startTime="1548">Google Play services. </span></p>

<p><span class="line" data-startTime="1550">That's where our authentication </span><span class="line" data-startTime="1550">has </span><span class="line" data-startTime="1552">kind of been held. </span> <span class="line" data-startTime="1553">We go to Google Play services. </span> <span class="line" data-startTime="1555">We see whether we're </span><span class="line" data-startTime="1555">signed in. </span> <span class="line" data-startTime="1556">If we're not, we're going to get </span><span class="line" data-startTime="1556">a call back with an error. </span> <span class="line" data-startTime="1559">And that error can be resolved </span><span class="line" data-startTime="1559">into an intent which will </span><span class="line" data-startTime="1562">display some dialogue </span><span class="line" data-startTime="1562">to the user. </span> <span class="line" data-startTime="1564">So we just won't do that. </span> <span class="line" data-startTime="1566">When the user signs in, we know </span><span class="line" data-startTime="1566">they've taken an action. </span> <span class="line" data-startTime="1568">So we can display that dialogue </span><span class="line" data-startTime="1568">to them and let them </span><span class="line" data-startTime="1571">sign in and let them </span><span class="line" data-startTime="1571">authenticate with us. </span></p>

<p><span class="line" data-startTime="1574">So that's fine. </span> <span class="line" data-startTime="1575">And most of the time, we're </span><span class="line" data-startTime="1575">in a really easy state. </span> <span class="line" data-startTime="1578">The user goes to the choose </span><span class="line" data-startTime="1578">a page, taps a sign-in, an </span><span class="line" data-startTime="1582">account is created or looked </span><span class="line" data-startTime="1582">up, and there we are. </span> <span class="line" data-startTime="1584">We have an identity provider </span><span class="line" data-startTime="1584">and an app account. </span> <span class="line" data-startTime="1587">You come back another day, </span><span class="line" data-startTime="1587">or another user comes in, </span><span class="line" data-startTime="1591">identity provider account, </span><span class="line" data-startTime="1591">app account, great. </span> <span class="line" data-startTime="1593">But sometimes you've </span><span class="line" data-startTime="1593">got this situation. </span> <span class="line" data-startTime="1597">And then the top user signs </span><span class="line" data-startTime="1597">in with the same identity </span><span class="line" data-startTime="1600">provider, the same identity </span><span class="line" data-startTime="1600">provider account, which now </span><span class="line" data-startTime="1604">maps to a second account. </span> <span class="line" data-startTime="1606">We've now got a conflict. </span></p>

<p><span class="line" data-startTime="1608">And what we do with that depends </span><span class="line" data-startTime="1608">on the application and </span><span class="line" data-startTime="1611">what you want to do with it. </span> <span class="line" data-startTime="1613">Most of the time, </span><span class="line" data-startTime="1613">you can go, ah, </span><span class="line" data-startTime="1615">these users don't conflict. </span> <span class="line" data-startTime="1617">We can just merge them. </span> <span class="line" data-startTime="1619">Whether that's something the </span><span class="line" data-startTime="1619">user would be involved with or </span><span class="line" data-startTime="1621">not, that's up to you. </span> <span class="line" data-startTime="1622">But you know they've </span><span class="line" data-startTime="1622">signed in. </span> <span class="line" data-startTime="1623">You know they have </span><span class="line" data-startTime="1623">authenticated </span><span class="line" data-startTime="1624">on both these systems. </span> <span class="line" data-startTime="1626">So they have access. </span> <span class="line" data-startTime="1627">So you can choose to merge </span><span class="line" data-startTime="1627">it if you want. </span> <span class="line" data-startTime="1629">And that's roughly </span><span class="line" data-startTime="1629">what we do here. </span> <span class="line" data-startTime="1632">We just present a dialogue </span><span class="line" data-startTime="1632">to the user. </span></p>

<p><span class="line" data-startTime="1634">Hey, this user already exists. </span> <span class="line" data-startTime="1636">But we can have those </span><span class="line" data-startTime="1636">map to the same app </span><span class="line" data-startTime="1639">account if you want. </span> <span class="line" data-startTime="1640">Do you want to merge, or </span><span class="line" data-startTime="1640">do you want to switch? </span><span class="line" data-startTime="1642">Because maybe you'd just </span><span class="line" data-startTime="1642">like to be this </span><span class="line" data-startTime="1643">other user right now. </span> <span class="line" data-startTime="1645">We can give them that option. </span> <span class="line" data-startTime="1646">But sometimes we can't. </span> <span class="line" data-startTime="1648">It's easy to think of cases, but </span><span class="line" data-startTime="1648">there's likely to be more </span><span class="line" data-startTime="1651">app-specific cases in your </span><span class="line" data-startTime="1651">application, where there are </span><span class="line" data-startTime="1654">things between accounts </span><span class="line" data-startTime="1654">that don't allow them </span><span class="line" data-startTime="1656">to be merged well. </span> <span class="line" data-startTime="1657">In this case, imagine there was </span><span class="line" data-startTime="1657">a third identity provider </span><span class="line" data-startTime="1661">connected, and on that third </span><span class="line" data-startTime="1661">identity provider, two </span><span class="line" data-startTime="1664">different users were </span><span class="line" data-startTime="1664">signed in. </span></p>

<p><span class="line" data-startTime="1667">In that case, we couldn't </span><span class="line" data-startTime="1667">combine them. </span> <span class="line" data-startTime="1669">We can't merge those accounts </span><span class="line" data-startTime="1669">automatically. </span> <span class="line" data-startTime="1672">But we can still prompt </span><span class="line" data-startTime="1672">the user. </span> <span class="line" data-startTime="1673">They've done a legitimate action </span><span class="line" data-startTime="1673">by signing in with </span><span class="line" data-startTime="1676">another provider. </span> <span class="line" data-startTime="1676">They genuinely have </span><span class="line" data-startTime="1676">access to that. </span> <span class="line" data-startTime="1678">We just can't fix the </span><span class="line" data-startTime="1678">situation for them. </span> <span class="line" data-startTime="1680">So we can just say to them, hey, </span><span class="line" data-startTime="1680">do you want to switch? </span><span class="line" data-startTime="1682">Or just cancel, stay </span><span class="line" data-startTime="1682">where you are. </span> <span class="line" data-startTime="1685">And all of that is mediated </span><span class="line" data-startTime="1685">by this authenticator. </span> <span class="line" data-startTime="1689">All of that is mediated in the </span><span class="line" data-startTime="1689">fragment, in this middle </span><span class="line" data-startTime="1692">layer, without needing to </span><span class="line" data-startTime="1692">know about the provider. </span></p>

<p><span class="line" data-startTime="1695">We can go in. </span> <span class="line" data-startTime="1696">We can see, is the </span><span class="line" data-startTime="1696">user ID null? </span><span class="line" data-startTime="1699">If it is, we just take that </span><span class="line" data-startTime="1699">user, whatever's been given to </span><span class="line" data-startTime="1701">us by a provider. </span> <span class="line" data-startTime="1703">If it isn't null, then </span><span class="line" data-startTime="1703">is it the same as the </span><span class="line" data-startTime="1706">user that's come in? </span><span class="line" data-startTime="1707">So I've signed in </span><span class="line" data-startTime="1707">with Google+. </span> <span class="line" data-startTime="1710">I've signed in with Facebook. </span> <span class="line" data-startTime="1711">Both look up to the </span><span class="line" data-startTime="1711">same app user. </span> <span class="line" data-startTime="1713">It just connects the accounts. </span> <span class="line" data-startTime="1714">It doesn't have to </span><span class="line" data-startTime="1714">do anything. </span> <span class="line" data-startTime="1715">If that's not true, then </span><span class="line" data-startTime="1715">can I merge the users? </span><span class="line" data-startTime="1719">What logic is required </span><span class="line" data-startTime="1719">to test that? </span><span class="line" data-startTime="1721">That logic doesn't have to </span><span class="line" data-startTime="1721">involve knowing anything about </span><span class="line" data-startTime="1724">who the providers are. </span> <span class="line" data-startTime="1725">It can just be testing, is there </span><span class="line" data-startTime="1725">a conflict between these </span><span class="line" data-startTime="1727">two sets of providers? </span><span class="line" data-startTime="1729">And it can be doing </span><span class="line" data-startTime="1729">application-specific </span><span class="line" data-startTime="1731">information. </span></p>

<p><span class="line" data-startTime="1731">But again, we don't have to look </span><span class="line" data-startTime="1731">into the provider to see </span><span class="line" data-startTime="1734">how to do this. </span> <span class="line" data-startTime="1737">So I wanted to give you one </span><span class="line" data-startTime="1737">other way of looking at this </span><span class="line" data-startTime="1741">kind of problem. </span> <span class="line" data-startTime="1744">Which is the idea that having </span><span class="line" data-startTime="1744">state for the identity </span><span class="line" data-startTime="1748">provider user separate than </span><span class="line" data-startTime="1748">having application state is </span><span class="line" data-startTime="1753">kind of beneficial. </span> <span class="line" data-startTime="1755">And you can use that to handle a </span><span class="line" data-startTime="1755">whole bunch of applications. </span> <span class="line" data-startTime="1759">So you might think of </span><span class="line" data-startTime="1759">a TV Guide that </span><span class="line" data-startTime="1761">lives on a tablet app. </span> <span class="line" data-startTime="1763">TV Guide, different family </span><span class="line" data-startTime="1763">members want to see their </span><span class="line" data-startTime="1766">chosen shows. </span> <span class="line" data-startTime="1768">But they don't &mdash; it's </span><span class="line" data-startTime="1768">not secret, right? </span><span class="line" data-startTime="1769">They just don't want to see </span><span class="line" data-startTime="1769">the other person's. </span></p>

<p><span class="line" data-startTime="1771">They want be able to switch. </span> <span class="line" data-startTime="1772">So that means it's an </span><span class="line" data-startTime="1772">identity problem. </span> <span class="line" data-startTime="1774">You need to know who they are. </span> <span class="line" data-startTime="1775">But you don't really care </span><span class="line" data-startTime="1775">about separating </span><span class="line" data-startTime="1779">that data too much. </span> <span class="line" data-startTime="1780">You just want to make sure they </span><span class="line" data-startTime="1780">only see the stuff they </span><span class="line" data-startTime="1782">want to see. </span> <span class="line" data-startTime="1783">So you can build something </span><span class="line" data-startTime="1783">like this. </span> <span class="line" data-startTime="1785">And this is in iOS. </span> <span class="line" data-startTime="1786">And we've just got our screen. </span> <span class="line" data-startTime="1787">It's anonymous. </span> <span class="line" data-startTime="1788">You can tap Choose Account. </span> <span class="line" data-startTime="1790">When you choose account, </span><span class="line" data-startTime="1790">you get a </span><span class="line" data-startTime="1791">list of attached accounts. </span></p>

<p><span class="line" data-startTime="1793">In this case, there's </span><span class="line" data-startTime="1793">my Facebook account </span><span class="line" data-startTime="1795">and a Twitter account. </span> <span class="line" data-startTime="1796">And Google+ isn't signed in. </span> <span class="line" data-startTime="1797">So I tap Google+. </span> <span class="line" data-startTime="1798">And then I sign in. </span> <span class="line" data-startTime="1799">I go through the regular flow. </span> <span class="line" data-startTime="1801">So even though these two </span><span class="line" data-startTime="1801">providers were signed in, that </span><span class="line" data-startTime="1803">doesn't automatically sign </span><span class="line" data-startTime="1803">me in to the app. </span> <span class="line" data-startTime="1805">I have to choose. </span> <span class="line" data-startTime="1806">I have to go through </span><span class="line" data-startTime="1806">an account chooser. </span> <span class="line" data-startTime="1810">Once I do it, I'm signed </span><span class="line" data-startTime="1810">in, and I can use the </span><span class="line" data-startTime="1812">application as me. </span> <span class="line" data-startTime="1813">But if I want to change, I just </span><span class="line" data-startTime="1813">hit Choose Account and </span><span class="line" data-startTime="1815">can switch again. </span> <span class="line" data-startTime="1816">This is very much like </span><span class="line" data-startTime="1816">the fast account </span><span class="line" data-startTime="1817">switching in Gmail &mdash; </span><span class="line" data-startTime="1819">in the Gmail app, where </span><span class="line" data-startTime="1819">you can choose what </span><span class="line" data-startTime="1821">you're using it is. </span></p>

<p><span class="line" data-startTime="1822">That's a really valuable </span><span class="line" data-startTime="1822">model. </span> <span class="line" data-startTime="1824">And it brings home the point </span><span class="line" data-startTime="1824">that identity doesn't have to </span><span class="line" data-startTime="1827">be like this huge lock and key </span><span class="line" data-startTime="1827">way of getting into systems. </span> <span class="line" data-startTime="1831">It can be anything that helps </span><span class="line" data-startTime="1831">the user use your application, </span><span class="line" data-startTime="1835">helps them get what they </span><span class="line" data-startTime="1835">need out of it. </span> <span class="line" data-startTime="1838">So in this case, to keep it </span><span class="line" data-startTime="1838">lightweight, rather than have </span><span class="line" data-startTime="1841">the view controller know </span><span class="line" data-startTime="1841">anything about our </span><span class="line" data-startTime="1843">authentication layer in the </span><span class="line" data-startTime="1843">middle, I thought, why not use </span><span class="line" data-startTime="1846">a message bus? </span><span class="line" data-startTime="1847">And in iOS, NSNotification </span><span class="line" data-startTime="1847">Center is the sort of standard </span><span class="line" data-startTime="1850">way of doing it. </span></p>

<p><span class="line" data-startTime="1851">On Android, you could use any </span><span class="line" data-startTime="1851">EventBus type library. </span> <span class="line" data-startTime="1854">Otto Square is a good one. </span> <span class="line" data-startTime="1856">And in this case, the </span><span class="line" data-startTime="1856">user might go </span><span class="line" data-startTime="1859">to the account chooser. </span> <span class="line" data-startTime="1860">The account chooser will </span><span class="line" data-startTime="1861">communicate with the providers. </span> <span class="line" data-startTime="1863">If the user taps on one of them, </span><span class="line" data-startTime="1863">they just signal the </span><span class="line" data-startTime="1866">authenticator which puts </span><span class="line" data-startTime="1866">a message onto the bus. </span> <span class="line" data-startTime="1868">And anyone that happens to be </span><span class="line" data-startTime="1868">listening that wants to know </span><span class="line" data-startTime="1870">about it, knows. </span> <span class="line" data-startTime="1871">Very cheap, very </span><span class="line" data-startTime="1871">easy switching. </span></p>

<p><span class="line" data-startTime="1873">Subscribing is as simple as </span><span class="line" data-startTime="1873">registering an observer of </span><span class="line" data-startTime="1877">yourself with </span><span class="line" data-startTime="1877">kUserStatusNotification. </span> <span class="line" data-startTime="1880">That's just the message type </span><span class="line" data-startTime="1880">you want to listen for. </span> <span class="line" data-startTime="1882">And checkUser is the function </span><span class="line" data-startTime="1882">that should be called when the </span><span class="line" data-startTime="1885">message comes in. </span> <span class="line" data-startTime="1886">And publishing is pretty </span><span class="line" data-startTime="1886">much the same. </span> <span class="line" data-startTime="1889">So we don't have to know </span><span class="line" data-startTime="1889">about what's going on </span><span class="line" data-startTime="1892">between those two. </span> <span class="line" data-startTime="1895">And in this case, we </span><span class="line" data-startTime="1895">need the identity </span><span class="line" data-startTime="1897">provider to hold state. </span> <span class="line" data-startTime="1898">It has to know whether it's </span><span class="line" data-startTime="1898">signed in because that doesn't </span><span class="line" data-startTime="1902">mean that we're signed into </span><span class="line" data-startTime="1902">the app with that user. </span></p>

<p><span class="line" data-startTime="1904">It just means they're </span><span class="line" data-startTime="1904">available. </span> <span class="line" data-startTime="1906">So each of our identity </span><span class="line" data-startTime="1906">providers, when you sign in, </span><span class="line" data-startTime="1909">may already have a user. </span> <span class="line" data-startTime="1910">They can return it right away. </span> <span class="line" data-startTime="1912">You want to track </span><span class="line" data-startTime="1912">that separately. </span> <span class="line" data-startTime="1915">And then if the user </span><span class="line" data-startTime="1915">signed in, we can </span><span class="line" data-startTime="1918">actually prompt some UI. </span> <span class="line" data-startTime="1919">We can bring something up. </span> <span class="line" data-startTime="1920">And in fact, this is from </span><span class="line" data-startTime="1920">an example with Twitter. </span> <span class="line" data-startTime="1923">So with Twitter, we're using the </span><span class="line" data-startTime="1923">built-in integration into </span><span class="line" data-startTime="1927">the OS with the Social Framework </span><span class="line" data-startTime="1927">in iOS 5 and 6. </span> <span class="line" data-startTime="1931">So we can go in. </span> <span class="line" data-startTime="1932">We can request from the account </span><span class="line" data-startTime="1932">store accounts of type </span><span class="line" data-startTime="1935">Twitter, see if we're </span><span class="line" data-startTime="1935">granted access. </span></p>

<p><span class="line" data-startTime="1937">If we are, we can retrieve </span><span class="line" data-startTime="1937">that user. </span> <span class="line" data-startTime="1939">Now we'll do that either way. </span> <span class="line" data-startTime="1941">We'll do that if we've started </span><span class="line" data-startTime="1941">the app right away, and we'll </span><span class="line" data-startTime="1945">do it when the user </span><span class="line" data-startTime="1945">taps Sign In. </span> <span class="line" data-startTime="1947">If we've started the app right </span><span class="line" data-startTime="1947">away, and the user has </span><span class="line" data-startTime="1949">previously granted access, and </span><span class="line" data-startTime="1949">we retrieve a user, we won't </span><span class="line" data-startTime="1952">do anything with it. </span> <span class="line" data-startTime="1953">We'll just keep it locally. </span> <span class="line" data-startTime="1955">And then when they sign </span><span class="line" data-startTime="1955">in, we return it. </span> <span class="line" data-startTime="1957">If this is happening once </span><span class="line" data-startTime="1957">they've already &mdash; </span><span class="line" data-startTime="1960">once they've tapped </span><span class="line" data-startTime="1960">the button, we </span><span class="line" data-startTime="1962">know it's a user action. </span> <span class="line" data-startTime="1963">So down here, we'll actually </span><span class="line" data-startTime="1963">take that user and return it </span><span class="line" data-startTime="1965">back to our object. </span> <span class="line" data-startTime="1967">But again, wrapped in an </span><span class="line" data-startTime="1967">interface, wrapped in a way </span><span class="line" data-startTime="1969">that means the actual view </span><span class="line" data-startTime="1969">controller doesn't have to </span><span class="line" data-startTime="1972">understand how that identity </span><span class="line" data-startTime="1972">was provisioned. </span></p>

<p><span class="line" data-startTime="1975">They just have to use it. </span> <span class="line" data-startTime="1977">Google+, pretty much </span><span class="line" data-startTime="1977">the same thing. </span> <span class="line" data-startTime="1979">We return the user if we </span><span class="line" data-startTime="1979">have it available. </span> <span class="line" data-startTime="1981">Otherwise, we just call the </span><span class="line" data-startTime="1981">authenticate method on the </span><span class="line" data-startTime="1984">shared instance of the </span><span class="line" data-startTime="1984">GPPSignIn object. </span> <span class="line" data-startTime="1986">Very straightforward. </span> <span class="line" data-startTime="1987">And that will kick off </span><span class="line" data-startTime="1987">the process for us. </span> <span class="line" data-startTime="1992">So I kind hope that's given you </span><span class="line" data-startTime="1992">some ideas about ways you </span><span class="line" data-startTime="1999">can think about combining </span><span class="line" data-startTime="1999">different providers. </span> <span class="line" data-startTime="2002">It doesn't have to be all or </span><span class="line" data-startTime="2002">nothing incredibly complex </span><span class="line" data-startTime="2007">integration. </span> <span class="line" data-startTime="2007">It can be simple and </span><span class="line" data-startTime="2007">lightweight, and you can just </span><span class="line" data-startTime="2010">let users choose. </span> <span class="line" data-startTime="2011">And I hope it gives you some </span><span class="line" data-startTime="2011">ideas about benefits. </span> <span class="line" data-startTime="2014">I appreciate it is difficult. </span> <span class="line" data-startTime="2016">If you are doing a situation </span><span class="line" data-startTime="2016">where you're merging multiple </span><span class="line" data-startTime="2019">identity provider accounts onto </span><span class="line" data-startTime="2019">a single app account, </span><span class="line" data-startTime="2022">there are edge cases. </span></p>

<p><span class="line" data-startTime="2023">There are conflicts. </span> <span class="line" data-startTime="2024">And you'll have to </span><span class="line" data-startTime="2024">resolve those. </span> <span class="line" data-startTime="2025">And that will take time. </span> <span class="line" data-startTime="2027">But if done right, I do believe </span><span class="line" data-startTime="2027">that it will not just </span><span class="line" data-startTime="2030">give your users a better </span><span class="line" data-startTime="2030">experience. </span> <span class="line" data-startTime="2031">It will actually help the </span><span class="line" data-startTime="2031">structure of your </span><span class="line" data-startTime="2033">applications. </span> <span class="line" data-startTime="2033">It'll help you provide a good </span><span class="line" data-startTime="2033">system and a scalable system </span><span class="line" data-startTime="2037">that is going to be flexible </span><span class="line" data-startTime="2037">when demands come up for you </span><span class="line" data-startTime="2039">to change it, for you to change </span><span class="line" data-startTime="2039">versions, for you to </span><span class="line" data-startTime="2041">upgrade, or to add </span><span class="line" data-startTime="2041">new providers. </span> <span class="line" data-startTime="2045">So that's about it for me. </span> <span class="line" data-startTime="2047">We'll do &mdash; got a few minutes </span><span class="line" data-startTime="2047">for questions. </span> <span class="line" data-startTime="2050">But I'll be at the Google+ </span><span class="line" data-startTime="2050">sandbox on the second floor </span><span class="line" data-startTime="2055">afterwards if you </span><span class="line" data-startTime="2055">have any more. </span> <span class="line" data-startTime="2057">If you're interested in this </span><span class="line" data-startTime="2057">kind of thing, Eric Sachs from </span><span class="line" data-startTime="2059">our Identity team wrote a </span><span class="line" data-startTime="2059">really good document on </span><span class="line" data-startTime="2062">running a login system with </span><span class="line" data-startTime="2062">an account chooser. </span></p>

<p><span class="line" data-startTime="2064">It's kind of web-centric. </span> <span class="line" data-startTime="2065">But the concepts and ideas </span><span class="line" data-startTime="2065">are fantastic. </span> <span class="line" data-startTime="2068">And it's really, really helpful </span><span class="line" data-startTime="2068">if you want to think </span><span class="line" data-startTime="2070">about this in more detail. </span> <span class="line" data-startTime="2072">If you're interested in Google+ </span><span class="line" data-startTime="2072">Sign-In, all of the </span><span class="line" data-startTime="2074">documentation is on </span><span class="line" data-startTime="2074">developers.google.com/+, and </span><span class="line" data-startTime="2078">there's sessions on it today. </span> <span class="line" data-startTime="2079">We had Android earlier. </span> <span class="line" data-startTime="2081">IOS at the end of the day </span><span class="line" data-startTime="2081">with XT and Silvano. </span> <span class="line" data-startTime="2085">We've got web with Ade up </span><span class="line" data-startTime="2085">next in here, I think. </span> <span class="line" data-startTime="2088">And then there's a few other </span><span class="line" data-startTime="2088">sessions on things like best </span><span class="line" data-startTime="2091">practices and how to integrate </span><span class="line" data-startTime="2091">throughout the day. </span></p>

<p><span class="line" data-startTime="2095">All of the code for this talk, </span><span class="line" data-startTime="2095">if you are interested in it, </span><span class="line" data-startTime="2097">is on GitHub. </span> <span class="line" data-startTime="2098">Or it will be as soon as I go </span><span class="line" data-startTime="2098">and make the repo public. </span> <span class="line" data-startTime="2101">And that is at that URL. </span> <span class="line" data-startTime="2103">And that's about it for me. </span> <span class="line" data-startTime="2104">Thank you. </span> <span class="line" data-startTime="2105">[APPLAUSE] </span></p>

<p class="speaker"><span class="line" data-starttime="2111"><span class="speakerName">Ian Barber</span>: Yeah, </span><span class="line" data-startTime="2111">so questions. </span><span class="line" data-startTime="2112">And as this gentleman has, if </span><span class="line" data-startTime="2112">you could come to the mic if </span><span class="line" data-startTime="2114">you have questions, just so that </span><span class="line" data-startTime="2114">they're on the recording, </span><span class="line" data-startTime="2116">that'd be great. </span></p>

<p class="speaker"><span class="line" data-starttime="2117"><span class="speakerName">Audience</span>: Thanks, Ian. </span><span class="line" data-startTime="2118">It was a very practical </span><span class="line" data-startTime="2118">discussion. </span><span class="line" data-startTime="2119">I really appreciate it. </span><span class="line" data-startTime="2121">Yesterday, in Tim Bray's talk </span><span class="line" data-startTime="2121">in the morning, I saw </span><span class="line" data-startTime="2122">something really interesting, </span><span class="line" data-startTime="2122">something I didn't really </span><span class="line" data-startTime="2124">think you could do. </span><span class="line" data-startTime="2126">He logged in to a demo </span><span class="line" data-startTime="2126">app that he'd written </span><span class="line" data-startTime="2129">in Ruby with Google+. </span><span class="line" data-startTime="2131">Then he set a preference, logged </span><span class="line" data-startTime="2131">out, and then logged in </span><span class="line" data-startTime="2136">to it again with Facebook, and </span><span class="line" data-startTime="2136">it recognized that he was the </span><span class="line" data-startTime="2138">same person both ways. </span><span class="line" data-startTime="2140">And I'm kind of curious can you </span><span class="line" data-startTime="2140">give some practical advice </span><span class="line" data-startTime="2143">on how to do stuff like that? </span></p>

<p class="speaker"><span class="line" data-starttime="2145"><span class="speakerName">Ian Barber</span>: Tim's actually </span><span class="line" data-startTime="2145">just over there. </span><span class="line" data-startTime="2149">So I don't know &mdash; how did you </span><span class="line" data-startTime="2149">do it in your example? </span></p>

<p class="speaker"><span class="line" data-starttime="2153"><span class="speakerName">Tim Bray</span>: Well, exactly </span><span class="line" data-startTime="2153">what you said. </span><span class="line" data-startTime="2154">There's a layer of abstraction </span><span class="line" data-startTime="2154">in there that auto-merges </span><span class="line" data-startTime="2158">these people if it detects </span><span class="line" data-startTime="2158">they're the same person. </span><span class="line" data-startTime="2161">Now I confess that because this </span><span class="line" data-startTime="2161">was a cheap demo app, I </span><span class="line" data-startTime="2164">used email. </span><span class="line" data-startTime="2165">Which is bad. </span></p>

<p class="speaker"><span class="line" data-starttime="2167"><span class="speakerName">Ian Barber</span>: Yeah. </span> <span class="line" data-startTime="2167">So yeah, Tim was just saying </span><span class="line" data-startTime="2167">that it's exactly </span><span class="line" data-startTime="2170">that kind of thing. </span> <span class="line" data-startTime="2171">He auto-merged people. </span> <span class="line" data-startTime="2172">And in that case, he used the </span><span class="line" data-startTime="2172">email address as the key. </span> <span class="line" data-startTime="2174">But it's finding an identifier </span><span class="line" data-startTime="2174">and using that </span><span class="line" data-startTime="2177">to go back and forth. </span> <span class="line" data-startTime="2178">I think there's a lot of </span><span class="line" data-startTime="2178">different ways you can do it. </span> <span class="line" data-startTime="2180">And though I might say email </span><span class="line" data-startTime="2180">address is a problem in some </span><span class="line" data-startTime="2184">cases, there are some cases </span><span class="line" data-startTime="2184">where you don't actually care </span><span class="line" data-startTime="2186">that much, right? </span><span class="line" data-startTime="2188">If you just want a lightweight </span><span class="line" data-startTime="2188">way, and you're not that </span><span class="line" data-startTime="2191">bothered if some other </span><span class="line" data-startTime="2191">user gets access to </span><span class="line" data-startTime="2193">it, it might be fine. </span></p>

<p><span class="line" data-startTime="2196">And there's loads of legitimate </span><span class="line" data-startTime="2196">cases for that, </span><span class="line" data-startTime="2197">where you do want something </span><span class="line" data-startTime="2197">a bit lighter. </span> <span class="line" data-startTime="2199">So there's always tradeoffs. </span> <span class="line" data-startTime="2202">There's always what do you want </span><span class="line" data-startTime="2202">to do, and what the level </span><span class="line" data-startTime="2204">of confidentiality and security </span><span class="line" data-startTime="2204">and functionality you </span><span class="line" data-startTime="2206">need to provide is. </span></p>

<p class="speaker"><span class="line" data-starttime="2217"><span class="speakerName">Tim Bray</span>: Whereas it's a bad </span><span class="line" data-startTime="2217">practice to rely on the email </span><span class="line" data-startTime="2220">address, it's also probably not </span><span class="line" data-startTime="2220">a good practice to ignore </span><span class="line" data-startTime="2223">the case when you happen to </span><span class="line" data-startTime="2223">get two that are the same. </span><span class="line" data-startTime="2225">A very reasonable course of </span><span class="line" data-startTime="2225">action might be something you </span><span class="line" data-startTime="2227">suggested to us, which is to pop </span><span class="line" data-startTime="2227">up a dialogue, saying, oh, </span><span class="line" data-startTime="2230">hey, you're just signing in </span><span class="line" data-startTime="2230">as Tim Bray on Facebook. </span><span class="line" data-startTime="2233">And I noticed you've been </span><span class="line" data-startTime="2233">signing in as Tim Bray as </span><span class="line" data-startTime="2235">Google for the last </span><span class="line" data-startTime="2235">three weeks. </span><span class="line" data-startTime="2237">Would you like to merge these? </span><span class="line" data-startTime="2239">That's a very reasonable </span><span class="line" data-startTime="2239">course of action. </span></p>

<p class="speaker"><span class="line" data-starttime="2240"><span class="speakerName">Ian Barber</span>: Yeah, absolutely. </span> <span class="line" data-startTime="2242">That's a really good point. </span> <span class="line" data-startTime="2243">I think one of the subtleties </span><span class="line" data-startTime="2243">that tends to come into it </span><span class="line" data-startTime="2247">which when you've got things </span><span class="line" data-startTime="2247">like multiple sign-in, is what </span><span class="line" data-startTime="2251">do you do when users </span><span class="line" data-startTime="2251">kind of forget what </span><span class="line" data-startTime="2253">they signed in with? </span><span class="line" data-startTime="2254">And so that kind of </span><span class="line" data-startTime="2254">case really helps, </span><span class="line" data-startTime="2255">if you can go, hmm. </span> <span class="line" data-startTime="2256">You're a new user, but you </span><span class="line" data-startTime="2256">look like this user. </span> <span class="line" data-startTime="2258">Are you really them? </span><span class="line" data-startTime="2259">And then give them the </span><span class="line" data-startTime="2259">option to merge. </span> <span class="line" data-startTime="2261">Luke Wroblewski actually had a </span><span class="line" data-startTime="2261">really interesting model he </span><span class="line" data-startTime="2264">did where you could start typing </span><span class="line" data-startTime="2264">in your email address, </span><span class="line" data-startTime="2267">and it would show you which </span><span class="line" data-startTime="2267">providers you've signed in </span><span class="line" data-startTime="2270">with, which obviously could </span><span class="line" data-startTime="2270">be a privacy leak. </span> <span class="line" data-startTime="2272">So it's something you have to </span><span class="line" data-startTime="2272">think about whether that fits </span><span class="line" data-startTime="2274">for your app. </span></p>

<p><span class="line" data-startTime="2275">But it was a really nice idea </span><span class="line" data-startTime="2275">where you could start typing </span><span class="line" data-startTime="2277">things in and go, oh </span><span class="line" data-startTime="2277">yeah, that's me. </span> <span class="line" data-startTime="2279">So that they hint which the user </span><span class="line" data-startTime="2279">should use if you do have </span><span class="line" data-startTime="2282">that situation. </span> <span class="line" data-startTime="2286">Cool. </span> <span class="line" data-startTime="2287">Is there any other questions? </span><span class="line" data-startTime="2288">Otherwise, I think </span><span class="line" data-startTime="2288">that's about it. </span> <span class="line" data-startTime="2291">OK, thank you very much. </span> <span class="line" data-startTime="2292">[APPLAUSE] </span></p>