<p class="speaker"><span class="line" data-starttime="2"><span class="speakerName">David Symonds</span>: Thank you </span><span class="line" data-startTime="2">very much for coming. </span><span class="line" data-startTime="3">How about we give our </span><span class="line" data-startTime="3">gopher dancers a </span><span class="line" data-startTime="4">big round of applause. </span><span class="line" data-startTime="5">[APPLAUSE] </span></p>

<p class="speaker"><span class="line" data-starttime="13"><span class="speakerName">David Symonds</span>: This is High </span><span class="line" data-startTime="13">Performance Apps with Go on </span><span class="line" data-startTime="15">App Engine. </span> <span class="line" data-startTime="16">Thank you very much </span><span class="line" data-startTime="16">for coming. </span> <span class="line" data-startTime="17">My name is David Symonds. </span> <span class="line" data-startTime="19">I am an engineer on the Go team </span><span class="line" data-startTime="19">at Google, and I lead the </span><span class="line" data-startTime="22">Technical Development for the </span><span class="line" data-startTime="22">Go runtime for App Engine. </span> <span class="line" data-startTime="26">As you might tell for </span><span class="line" data-startTime="26">my accent, I'm </span><span class="line" data-startTime="28">not from around here. </span> <span class="line" data-startTime="29">I'm from the Sydney office. </span> <span class="line" data-startTime="31">So here's what we're going </span><span class="line" data-startTime="31">to cover today. </span> <span class="line" data-startTime="33">I'm just going to give </span><span class="line" data-startTime="33">you a brief overview </span><span class="line" data-startTime="34">of Go on App Engine. </span></p>

<p><span class="line" data-startTime="36">Hopefully many of you here </span><span class="line" data-startTime="36">have tried it out at one </span><span class="line" data-startTime="38">stage, just to give you a feel </span><span class="line" data-startTime="38">for where we're at and give </span><span class="line" data-startTime="43">you a bit of an overview of </span><span class="line" data-startTime="43">a couple of relatively </span><span class="line" data-startTime="45">high-profile apps that </span><span class="line" data-startTime="45">are using it. </span> <span class="line" data-startTime="48">Then I'm going to introduce a </span><span class="line" data-startTime="48">motivating example for what </span><span class="line" data-startTime="50">we're going to use to explore </span><span class="line" data-startTime="50">some performance techniques </span><span class="line" data-startTime="53">for your app. </span> <span class="line" data-startTime="54">And then the rest of the </span><span class="line" data-startTime="54">session, which will be most of </span><span class="line" data-startTime="55">the time, I'll be talking </span><span class="line" data-startTime="55">about those performance </span><span class="line" data-startTime="58">techniques in some detail. </span> <span class="line" data-startTime="61">So why Go on App engine? </span><span class="line" data-startTime="62">First of all, it's got the </span><span class="line" data-startTime="62">peanut butter and the </span><span class="line" data-startTime="65">chocolate in a great </span><span class="line" data-startTime="65">combination. </span></p>

<p><span class="line" data-startTime="66">Go compiles to native code. </span> <span class="line" data-startTime="68">It runs really fast. </span> <span class="line" data-startTime="70">It's a fantastic programming </span><span class="line" data-startTime="70">environment to work in. </span> <span class="line" data-startTime="73">At the same time, App Engine is </span><span class="line" data-startTime="73">a fantastic platform as a </span><span class="line" data-startTime="75">service you can use to </span><span class="line" data-startTime="75">host your web app. </span> <span class="line" data-startTime="79">It auto scales. </span> <span class="line" data-startTime="80">It's very, very low </span><span class="line" data-startTime="80">maintenance. </span> <span class="line" data-startTime="83">I don't like getting woken up </span><span class="line" data-startTime="83">at 3:00 AM to fix things. </span> <span class="line" data-startTime="86">I imagine neither do you. </span> <span class="line" data-startTime="89">So if you're hosting on App </span><span class="line" data-startTime="89">Engine, we have people at </span><span class="line" data-startTime="91">Google who will wake up at 3:00 </span><span class="line" data-startTime="91">AM to fix problems when </span><span class="line" data-startTime="93">they happen. </span></p>

<p><span class="line" data-startTime="95">Combining these two together, we </span><span class="line" data-startTime="95">get the fastest runtime for </span><span class="line" data-startTime="98">App Engine. </span> <span class="line" data-startTime="99">It starts really fast. </span> <span class="line" data-startTime="100">It runs really fast. </span> <span class="line" data-startTime="102">It keeps your instance </span><span class="line" data-startTime="102">hours down low. </span> <span class="line" data-startTime="104">It's cheap for what it does. </span> <span class="line" data-startTime="107">And you've got code running at </span><span class="line" data-startTime="107">full machine speed so you can </span><span class="line" data-startTime="112">do sophisticated, actual </span><span class="line" data-startTime="112">processing, not </span><span class="line" data-startTime="114">just serving text. </span> <span class="line" data-startTime="117">So we first unveiled the Go </span><span class="line" data-startTime="117">runtime for App Engine here at </span><span class="line" data-startTime="119">Google I/O two years ago. </span> <span class="line" data-startTime="121">And since then, we've seen </span><span class="line" data-startTime="121">a lot of people adopt it. </span></p>

<p><span class="line" data-startTime="123">It's grown over time. </span> <span class="line" data-startTime="124">It's supporting more of </span><span class="line" data-startTime="124">the App Engine APIs. </span> <span class="line" data-startTime="127">It's got better tooling. </span> <span class="line" data-startTime="128">And we're seeing steady </span><span class="line" data-startTime="128">growth and several </span><span class="line" data-startTime="130">high-profile users. </span> <span class="line" data-startTime="131">Now, I wanted to talk about two </span><span class="line" data-startTime="131">that Google has done to </span><span class="line" data-startTime="134">give you a feel for </span><span class="line" data-startTime="134">what's possible. </span> <span class="line" data-startTime="136">These are by no means hugely </span><span class="line" data-startTime="136">sophisticated apps. </span> <span class="line" data-startTime="140">But they're kind of </span><span class="line" data-startTime="140">representative of things that </span><span class="line" data-startTime="142">are easy and natural to do in Go </span><span class="line" data-startTime="142">that might be a little bit </span><span class="line" data-startTime="145">harder in other languages. </span></p>

<p><span class="line" data-startTime="146">But they really show off the </span><span class="line" data-startTime="146">power and speed you can get. </span> <span class="line" data-startTime="150">The first one is a front page of </span><span class="line" data-startTime="150">google.com, a Turkey Doodle </span><span class="line" data-startTime="155">from Thanksgiving </span><span class="line" data-startTime="155">two years ago. </span> <span class="line" data-startTime="158">This is an interesting </span><span class="line" data-startTime="158">one because it was </span><span class="line" data-startTime="159">written by a Go newcomer. </span> <span class="line" data-startTime="160">He'd never written any Go code </span><span class="line" data-startTime="160">before, but he picked it up, </span><span class="line" data-startTime="163">and he got this high-profile </span><span class="line" data-startTime="163">app to </span><span class="line" data-startTime="165">launch in under 24 hours. </span> <span class="line" data-startTime="167">So if you're thinking to </span><span class="line" data-startTime="167">yourself, I love App Engine, </span><span class="line" data-startTime="171">but I'm a Python, or Java </span><span class="line" data-startTime="171">programmer, or maybe a PHP </span><span class="line" data-startTime="173">programmer now. </span> <span class="line" data-startTime="175">What's Go got in for me? </span><span class="line" data-startTime="176">Maybe it's too hard to learn. </span> <span class="line" data-startTime="177">This is great evidence that </span><span class="line" data-startTime="177">you can get from 0 to 100 </span><span class="line" data-startTime="182">miles per hour with not </span><span class="line" data-startTime="182">too much difficulty. </span></p>

<p><span class="line" data-startTime="185">Go's really easy to pick up. </span> <span class="line" data-startTime="187">When this person built it, this </span><span class="line" data-startTime="187">app is doing some image </span><span class="line" data-startTime="190">compositing. </span> <span class="line" data-startTime="192">So you can see it's rendering </span><span class="line" data-startTime="192">a graphic of a turkey with </span><span class="line" data-startTime="196">different feathers. </span> <span class="line" data-startTime="197">You can see it animated from </span><span class="line" data-startTime="197">that link down below. </span> <span class="line" data-startTime="201">But it's doing image </span><span class="line" data-startTime="201">work here. </span> <span class="line" data-startTime="202">It's not just serving </span><span class="line" data-startTime="202">static images. </span> <span class="line" data-startTime="204">It's doing sophisticated </span><span class="line" data-startTime="204">stuff. </span> <span class="line" data-startTime="206">And this Go newcomer found that </span><span class="line" data-startTime="206">he could build this app </span><span class="line" data-startTime="209">relatively easily and get half </span><span class="line" data-startTime="209">the latency of an equivalent </span><span class="line" data-startTime="212">Python 2.7 version. </span> <span class="line" data-startTime="214">As you can imagine, watching it </span><span class="line" data-startTime="214">on google.com, the homepage </span><span class="line" data-startTime="217">produces a fair bit of </span><span class="line" data-startTime="217">traffic, and this </span><span class="line" data-startTime="220">didn't miss a beat. </span> <span class="line" data-startTime="221">And there's some more details </span><span class="line" data-startTime="221">of how well it </span><span class="line" data-startTime="222">performed at that link. </span> <span class="line" data-startTime="226">Santa Tracker for last year </span><span class="line" data-startTime="226">was written in Go. </span></p>

<p><span class="line" data-startTime="229">And this was the component that </span><span class="line" data-startTime="229">kept track of where Santa </span><span class="line" data-startTime="232">was and informed the client-side </span><span class="line" data-startTime="232">JavaScript where </span><span class="line" data-startTime="236">to render Santa and how </span><span class="line" data-startTime="236">many presents he had </span><span class="line" data-startTime="237">delivered, and so forth. </span> <span class="line" data-startTime="239">It served a peak of nearly 5,000 </span><span class="line" data-startTime="239">QPS, so 5,000 queries </span><span class="line" data-startTime="243">per second. </span> <span class="line" data-startTime="244">This is also a very </span><span class="line" data-startTime="244">high-pressure situation. </span> <span class="line" data-startTime="246">If things aren't going right, he </span><span class="line" data-startTime="246">can't just tell people come </span><span class="line" data-startTime="248">back tomorrow for something </span><span class="line" data-startTime="248">like this. </span> <span class="line" data-startTime="251">It's too late by then. </span> <span class="line" data-startTime="252">We didn't make any </span><span class="line" data-startTime="252">children cry. </span> <span class="line" data-startTime="254">And you can see down at the </span><span class="line" data-startTime="254">bottom, we did this with under </span><span class="line" data-startTime="257">80 instances. </span> <span class="line" data-startTime="259">So this is a lot fewer than you </span><span class="line" data-startTime="259">might expect for this kind </span><span class="line" data-startTime="261">of query volume. </span> <span class="line" data-startTime="264">So let me introduce to </span><span class="line" data-startTime="264">you Gopher Mart. </span> <span class="line" data-startTime="268">Gopher Mart is a little sample </span><span class="line" data-startTime="268">app, and I'll have a link at </span><span class="line" data-startTime="271">the end of this presentation </span><span class="line" data-startTime="271">for source code for it. </span></p>

<p><span class="line" data-startTime="276">It's a bit of a silly app. </span> <span class="line" data-startTime="278">But it kind of demonstrates </span><span class="line" data-startTime="278">enough of the features for us </span><span class="line" data-startTime="281">to discuss building a really </span><span class="line" data-startTime="281">high-performance app. </span> <span class="line" data-startTime="287">So here's the situation. </span> <span class="line" data-startTime="289">Imagine you are running an app </span><span class="line" data-startTime="289">to manage or to run, indeed, </span><span class="line" data-startTime="293">your Gopher Mart, which is your </span><span class="line" data-startTime="293">one-stop shop for all </span><span class="line" data-startTime="296">your gopher needs. </span> <span class="line" data-startTime="297">You gophers can come in, get </span><span class="line" data-startTime="297">their gopher bran, their </span><span class="line" data-startTime="299">gopher flakes, their gopher </span><span class="line" data-startTime="299">liter, load them up in a cart, </span><span class="line" data-startTime="302">take them to a checkout, and </span><span class="line" data-startTime="302">then take them home obviously. </span> <span class="line" data-startTime="308">And the correspondence to an app </span><span class="line" data-startTime="308">that we're going to use is </span><span class="line" data-startTime="312">that the gophers that are doing </span><span class="line" data-startTime="312">the shopping are your </span><span class="line" data-startTime="315">user requests. </span> <span class="line" data-startTime="317">Each of your checkout </span><span class="line" data-startTime="317">gophers &mdash; </span><span class="line" data-startTime="318">the gophers processing each </span><span class="line" data-startTime="318">of those requests &mdash; </span><span class="line" data-startTime="321">is an app instance. </span> <span class="line" data-startTime="322">And then there's the scheduler </span><span class="line" data-startTime="322">gopher that's got a direct </span><span class="line" data-startTime="325">user request to app instances. </span></p>

<p><span class="line" data-startTime="328">A checkout gopher can </span><span class="line" data-startTime="328">only deal with one </span><span class="line" data-startTime="330">request at a time. </span> <span class="line" data-startTime="333">And checkout gophers can be </span><span class="line" data-startTime="333">hired or fired in our Gopher </span><span class="line" data-startTime="337">Mart, but there is a certain </span><span class="line" data-startTime="337">overhead to this. </span> <span class="line" data-startTime="339">This models how we deal with </span><span class="line" data-startTime="339">App Engine instances. </span> <span class="line" data-startTime="343">They take a little bit </span><span class="line" data-startTime="343">of time to start up. </span> <span class="line" data-startTime="345">They're very quick to start up </span><span class="line" data-startTime="345">and go, but it's still a </span><span class="line" data-startTime="347">nonzero amount of time. </span> <span class="line" data-startTime="348">And they can't be fired </span><span class="line" data-startTime="348">straight away. </span> <span class="line" data-startTime="350">Our Gopher Mart has serious </span><span class="line" data-startTime="350">industrial relations laws. </span> <span class="line" data-startTime="354">You need to keep your checkout </span><span class="line" data-startTime="354">gophers around for at least 15 </span><span class="line" data-startTime="357">minutes after they've </span><span class="line" data-startTime="357">been hired. </span> <span class="line" data-startTime="361">But as in our Gopher Mart, our </span><span class="line" data-startTime="361">gophers don't want to be </span><span class="line" data-startTime="365">standing in queue with </span><span class="line" data-startTime="365">their gopher bran. </span></p>

<p><span class="line" data-startTime="366">They want to get home and eat </span><span class="line" data-startTime="366">their gopher bran &mdash; pour </span><span class="line" data-startTime="368">gopher milk all over it, scoop </span><span class="line" data-startTime="368">it out of their gopher bowls. </span> <span class="line" data-startTime="371">They don't want to be standing </span><span class="line" data-startTime="371">in queues waiting </span><span class="line" data-startTime="372">for all this to happen. </span> <span class="line" data-startTime="373">They'll get kind of grumpy </span><span class="line" data-startTime="373">if we take too long. </span> <span class="line" data-startTime="375">So we're going to look at </span><span class="line" data-startTime="375">different ways of making our </span><span class="line" data-startTime="377">app really fly. </span> <span class="line" data-startTime="379">I'm going to be looking at five </span><span class="line" data-startTime="379">different techniques. </span> <span class="line" data-startTime="383">But before we look at any </span><span class="line" data-startTime="383">techniques, we have to </span><span class="line" data-startTime="385">understand the way </span><span class="line" data-startTime="385">that we approach </span><span class="line" data-startTime="387">high-performance apps. </span> <span class="line" data-startTime="389">And it's very easy to fool </span><span class="line" data-startTime="389">ourselves into thinking that </span><span class="line" data-startTime="391">we know where the </span><span class="line" data-startTime="391">slow bits are. </span> <span class="line" data-startTime="394">Whenever you're doing </span><span class="line" data-startTime="394">performance work, you need to </span><span class="line" data-startTime="395">first measure to understand </span><span class="line" data-startTime="395">where the slow bits are. </span></p>

<p><span class="line" data-startTime="398">There's no point of spending </span><span class="line" data-startTime="398">months of your time tuning, </span><span class="line" data-startTime="401">and tweaking, and caching, and </span><span class="line" data-startTime="401">doing all kinds of things to </span><span class="line" data-startTime="406">one bit of code if that bit of </span><span class="line" data-startTime="406">code isn't your slow bit. </span> <span class="line" data-startTime="408">So you need to measure first. </span> <span class="line" data-startTime="411">It's also important to </span><span class="line" data-startTime="411">measure periodically. </span> <span class="line" data-startTime="414">Your app will behave differently </span><span class="line" data-startTime="414">based on different </span><span class="line" data-startTime="417">request loads, different types </span><span class="line" data-startTime="417">of request processing, what </span><span class="line" data-startTime="420">you're trying to do </span><span class="line" data-startTime="420">in each request. </span> <span class="line" data-startTime="421">So it's important to come back </span><span class="line" data-startTime="421">to measuring how fast it is </span><span class="line" data-startTime="426">over time because it will change </span><span class="line" data-startTime="426">as you change your app. </span> <span class="line" data-startTime="428">Even if you don't change your </span><span class="line" data-startTime="428">app, the infrastructure </span><span class="line" data-startTime="430">underneath will change over time </span><span class="line" data-startTime="430">as well and almost always </span><span class="line" data-startTime="433">for the better. </span> <span class="line" data-startTime="435">So App Engine gets better </span><span class="line" data-startTime="435">at scheduling </span><span class="line" data-startTime="437">instances to app servers. </span> <span class="line" data-startTime="439">It'll get better at getting </span><span class="line" data-startTime="439">files to the app servers, </span><span class="line" data-startTime="441">starting them up quickly, </span><span class="line" data-startTime="441">and so on. </span> <span class="line" data-startTime="443">Go got a lot faster. </span></p>

<p><span class="line" data-startTime="446">Just a few days ago when we </span><span class="line" data-startTime="446">announced Go 1.1, that was </span><span class="line" data-startTime="449">major milestone, our second </span><span class="line" data-startTime="449">major stable release, that </span><span class="line" data-startTime="453">brought a lot of performance </span><span class="line" data-startTime="453">improvements. </span> <span class="line" data-startTime="456">We got emails to the mailing </span><span class="line" data-startTime="456">list about people seeing their </span><span class="line" data-startTime="460">programs written in Go dropping </span><span class="line" data-startTime="460">from like 24 hours </span><span class="line" data-startTime="462">runtime to 9 hours runtime. </span> <span class="line" data-startTime="464">So there's startling differences </span><span class="line" data-startTime="464">in every release </span><span class="line" data-startTime="467">of things, so you need to </span><span class="line" data-startTime="467">periodically come back to </span><span class="line" data-startTime="469">remeasure your app to understand </span><span class="line" data-startTime="469">what bits are slow </span><span class="line" data-startTime="471">and what bits aren't. </span> <span class="line" data-startTime="476">The tool that we're going to be </span><span class="line" data-startTime="476">using to get a feel for how </span><span class="line" data-startTime="480">our app performs is </span><span class="line" data-startTime="480">called Appstats. </span></p>

<p><span class="line" data-startTime="483">And what Appstats does is it </span><span class="line" data-startTime="483">traces API RPCs over the </span><span class="line" data-startTime="486">course of requests. </span> <span class="line" data-startTime="487">It measures the start time and </span><span class="line" data-startTime="487">the stop time, what these </span><span class="line" data-startTime="490">requests are doing, and also </span><span class="line" data-startTime="490">records the stack trace so you </span><span class="line" data-startTime="493">can dig in through a web </span><span class="line" data-startTime="493">interface to be able to see </span><span class="line" data-startTime="496">where this RPC came from, how </span><span class="line" data-startTime="496">long it took, any errors that </span><span class="line" data-startTime="500">happened, and so on. </span> <span class="line" data-startTime="502">And as you can see here, here's </span><span class="line" data-startTime="502">a &mdash; timeline, with </span><span class="line" data-startTime="505">time running along </span><span class="line" data-startTime="505">the x-axis &mdash; </span><span class="line" data-startTime="507">of my first version </span><span class="line" data-startTime="507">of this app. </span> <span class="line" data-startTime="509">Now, I wrote it as simply as </span><span class="line" data-startTime="509">possible with no thoughts to </span><span class="line" data-startTime="513">performance, just simplicity. </span> <span class="line" data-startTime="515">And you can see it's </span><span class="line" data-startTime="515">pretty slow. </span></p>

<p><span class="line" data-startTime="516">It's taking nearly </span><span class="line" data-startTime="516">400 milliseconds. </span> <span class="line" data-startTime="519">And what it's doing </span><span class="line" data-startTime="519">is, the gopher </span><span class="line" data-startTime="521">comes up to the checkout. </span> <span class="line" data-startTime="523">The checkout gopher has to scan </span><span class="line" data-startTime="523">each item that was in </span><span class="line" data-startTime="528">their cart, and then emails </span><span class="line" data-startTime="528">them a receipt afterwards. </span> <span class="line" data-startTime="530">This is a fairly modern </span><span class="line" data-startTime="530">Gopher Mart. </span> <span class="line" data-startTime="533">So instead of just giving them </span><span class="line" data-startTime="533">a printed receipt, they'll </span><span class="line" data-startTime="535">just get it in their email </span><span class="line" data-startTime="535">later on that day. </span> <span class="line" data-startTime="539">So we're going to look </span><span class="line" data-startTime="539">at different ways of </span><span class="line" data-startTime="540">speeding this up. </span> <span class="line" data-startTime="543">So I'm going to be </span><span class="line" data-startTime="543">covering five </span><span class="line" data-startTime="544">performance techniques today. </span></p>

<p><span class="line" data-startTime="545">These aren't comprehensive. </span> <span class="line" data-startTime="547">There's plenty more that you </span><span class="line" data-startTime="547">can think of, and each one, </span><span class="line" data-startTime="550">I'll be only giving a bit of a </span><span class="line" data-startTime="550">flavor for the depth that you </span><span class="line" data-startTime="553">can go into to fully realize </span><span class="line" data-startTime="553">these techniques. </span> <span class="line" data-startTime="557">But these should be five </span><span class="line" data-startTime="557">fairly representative </span><span class="line" data-startTime="559">techniques of how to </span><span class="line" data-startTime="559">tackle these kind </span><span class="line" data-startTime="560">of performance problems. </span> <span class="line" data-startTime="566">First one to do is </span><span class="line" data-startTime="566">deferring work. </span> <span class="line" data-startTime="570">Not all work needs to be done </span><span class="line" data-startTime="570">during the request. </span> <span class="line" data-startTime="572">In our Gopher Mart situation </span><span class="line" data-startTime="572">when the gophers come up to </span><span class="line" data-startTime="576">the checkout and are checking </span><span class="line" data-startTime="576">out their items, they don't </span><span class="line" data-startTime="578">need the email of the receipt </span><span class="line" data-startTime="578">right then and there. </span></p>

<p><span class="line" data-startTime="582">They're going to take their cart </span><span class="line" data-startTime="582">out to their gopher car, </span><span class="line" data-startTime="584">load up the gopher boot with </span><span class="line" data-startTime="584">their gopher bran, drive to </span><span class="line" data-startTime="587">the gopher home. </span> <span class="line" data-startTime="587">It's going to take them </span><span class="line" data-startTime="587">a little while. </span> <span class="line" data-startTime="589">So the importance of getting the </span><span class="line" data-startTime="589">mail out to them straight </span><span class="line" data-startTime="592">away is not so important. </span> <span class="line" data-startTime="594">And in general, a lot of web </span><span class="line" data-startTime="594">apps need to do things as a </span><span class="line" data-startTime="597">consequence of a request, but </span><span class="line" data-startTime="597">don't need to do them during </span><span class="line" data-startTime="602">the request. </span> <span class="line" data-startTime="603">So this may seem like a pretty </span><span class="line" data-startTime="603">simplistic technique, and </span><span class="line" data-startTime="607">we'll get on to slightly more </span><span class="line" data-startTime="607">sophisticated ones shortly. </span> <span class="line" data-startTime="610">But it's an important </span><span class="line" data-startTime="610">one to remember. </span> <span class="line" data-startTime="611">Lots of the time, you can </span><span class="line" data-startTime="611">forget that you're doing </span><span class="line" data-startTime="613">things that you don't </span><span class="line" data-startTime="613">need to be doing. </span> <span class="line" data-startTime="616">The main ways that we're going </span><span class="line" data-startTime="616">to going do this with the Go </span><span class="line" data-startTime="618">App Engine API is with the Task </span><span class="line" data-startTime="618">Queue API or the delay </span><span class="line" data-startTime="622">package that is built over </span><span class="line" data-startTime="622">the Task Queue API. </span></p>

<p><span class="line" data-startTime="625">And we're going to use this to </span><span class="line" data-startTime="625">shift work that it needs to do </span><span class="line" data-startTime="628">outside the request scope. </span> <span class="line" data-startTime="629">In our Gopher Mart situation, </span><span class="line" data-startTime="629">we're going to shift that slow </span><span class="line" data-startTime="632">mail lots end call that took a </span><span class="line" data-startTime="632">large chunk of our timeline. </span> <span class="line" data-startTime="636">And we're going to do that in a </span><span class="line" data-startTime="636">task that's going to happen </span><span class="line" data-startTime="639">usually very soon afterwards. </span> <span class="line" data-startTime="641">But we're going to replace </span><span class="line" data-startTime="641">it with a very quick </span><span class="line" data-startTime="643">taskqueue.add. </span> <span class="line" data-startTime="644">And we're going to use </span><span class="line" data-startTime="644">the delay package. </span> <span class="line" data-startTime="647">And here's how the delay package </span><span class="line" data-startTime="647">works in case you </span><span class="line" data-startTime="649">haven't seen it before. </span></p>

<p><span class="line" data-startTime="650">What it does is it </span><span class="line" data-startTime="650">wraps a function. </span> <span class="line" data-startTime="653">You just go to try and </span><span class="line" data-startTime="653">invoke that function. </span> <span class="line" data-startTime="656">And what it'll do behind the </span><span class="line" data-startTime="656">scenes is it will marshall the </span><span class="line" data-startTime="659">function arguments, store them </span><span class="line" data-startTime="659">in a Task Queue task, add it </span><span class="line" data-startTime="664">to the queue, and then when it </span><span class="line" data-startTime="664">comes back, it'll invoke your </span><span class="line" data-startTime="667">function for you. </span> <span class="line" data-startTime="668">So it's a very, very simple way </span><span class="line" data-startTime="668">of dealing with Task Queue </span><span class="line" data-startTime="672">when you're doing it </span><span class="line" data-startTime="672">to defer work. </span> <span class="line" data-startTime="674">So you can see at the top, two </span><span class="line" data-startTime="674">lines of my code for my simple </span><span class="line" data-startTime="679">version there's a sendReceipt </span><span class="line" data-startTime="679">function invocation. </span> <span class="line" data-startTime="682">And then you can see just the </span><span class="line" data-startTime="682">function signature of </span><span class="line" data-startTime="684">sendReceipt. </span> <span class="line" data-startTime="685">It's fairly simple. </span> <span class="line" data-startTime="687">All we have to do to use the </span><span class="line" data-startTime="687">delay package is import </span><span class="line" data-startTime="690">appengine/delay. </span> <span class="line" data-startTime="693">And then we turn our sendReceipt </span><span class="line" data-startTime="693">invocation to </span><span class="line" data-startTime="696">stick a dot Call in there. </span> <span class="line" data-startTime="697">Nothing else has to </span><span class="line" data-startTime="697">change there. </span> <span class="line" data-startTime="700">Then we turn our function </span><span class="line" data-startTime="700">definition into a variable </span><span class="line" data-startTime="703">definition. </span></p>

<p><span class="line" data-startTime="705">And we just use delay.func, give </span><span class="line" data-startTime="705">it a name, and then we </span><span class="line" data-startTime="709">have our function body </span><span class="line" data-startTime="709">exactly as is. </span> <span class="line" data-startTime="711">So there's no difference from </span><span class="line" data-startTime="711">what we were doing before. </span> <span class="line" data-startTime="713">And you can see the effect </span><span class="line" data-startTime="713">that it has. </span> <span class="line" data-startTime="715">It shrunk that mail.send call. </span> <span class="line" data-startTime="717">It be a bit slow, and it might </span><span class="line" data-startTime="717">be waiting on the mail </span><span class="line" data-startTime="719">protocol to start so it can </span><span class="line" data-startTime="719">verify that it can send mail, </span><span class="line" data-startTime="722">spam filters, whatever it is. </span> <span class="line" data-startTime="725">And it's turned into a very </span><span class="line" data-startTime="725">quick Task Queue call. </span> <span class="line" data-startTime="727">So this is a lot quicker, and </span><span class="line" data-startTime="727">then the mail will happen in </span><span class="line" data-startTime="730">its own Task Queue request. </span> <span class="line" data-startTime="734">Second technique I want to </span><span class="line" data-startTime="734">talk about is batching. </span></p>

<p><span class="line" data-startTime="738">In our Gopher Mart scenario, </span><span class="line" data-startTime="738">it kind of makes sense that </span><span class="line" data-startTime="742">you don't want a family of </span><span class="line" data-startTime="742">10 gophers all going in </span><span class="line" data-startTime="744">individually, picking up their </span><span class="line" data-startTime="744">own box of gopher flakes, </span><span class="line" data-startTime="747">walking up to the counter, each </span><span class="line" data-startTime="747">going through the process </span><span class="line" data-startTime="749">of checking them out, paying </span><span class="line" data-startTime="749">for them, and then walking </span><span class="line" data-startTime="751">home with them. </span> <span class="line" data-startTime="752">It makes a lot more sense for </span><span class="line" data-startTime="752">one of the gophers to go in by </span><span class="line" data-startTime="756">themselves, load up their cart </span><span class="line" data-startTime="756">with 10 boxes of gopher </span><span class="line" data-startTime="759">flakes, and then check </span><span class="line" data-startTime="759">them out all at once. </span></p>

<p><span class="line" data-startTime="762">And again, this is a relatively </span><span class="line" data-startTime="762">simple technique, </span><span class="line" data-startTime="764">but it's often overlooked. </span> <span class="line" data-startTime="768">This would be using API calls </span><span class="line" data-startTime="768">like GetMulti instead of Get, </span><span class="line" data-startTime="771">or PutMulti instead of Put. </span> <span class="line" data-startTime="774">Often they're a little bit </span><span class="line" data-startTime="774">more overhead than just a </span><span class="line" data-startTime="776">single call if you've only </span><span class="line" data-startTime="776">got a single object. </span> <span class="line" data-startTime="778">But a lot time, you're dealing </span><span class="line" data-startTime="778">with multiple entities. </span> <span class="line" data-startTime="781">And so they can be a lot quicker </span><span class="line" data-startTime="781">because you only have </span><span class="line" data-startTime="785">one lot of the RPC overhead </span><span class="line" data-startTime="785">instead of in. </span></p>

<p><span class="line" data-startTime="789">So here you can see the </span><span class="line" data-startTime="789">code that I wrote </span><span class="line" data-startTime="791">for the simple version. </span> <span class="line" data-startTime="793">You can see that it's just </span><span class="line" data-startTime="793">sitting in a loop. </span> <span class="line" data-startTime="795">And for each key it goes and </span><span class="line" data-startTime="795">fetches the item corresponding </span><span class="line" data-startTime="799">to that key from </span><span class="line" data-startTime="799">the data store. </span> <span class="line" data-startTime="801">It deals with any error, and </span><span class="line" data-startTime="801">then just builds up a slice of </span><span class="line" data-startTime="803">those items. </span> <span class="line" data-startTime="805">That's obviously very simple </span><span class="line" data-startTime="805">to understand and to reason </span><span class="line" data-startTime="807">about, but it's slow. </span> <span class="line" data-startTime="810">And here's what we do </span><span class="line" data-startTime="810">when we batch it. </span> <span class="line" data-startTime="815">Instead of a loop where we're </span><span class="line" data-startTime="815">doing each data store call, we </span><span class="line" data-startTime="817">use datastore.GetMulti. </span> <span class="line" data-startTime="820">We tell it all the keys to go </span><span class="line" data-startTime="820">and get, and then it returns </span><span class="line" data-startTime="822">all the items for us. </span></p>

<p><span class="line" data-startTime="824">And you can see, in this case, </span><span class="line" data-startTime="824">the task you call was very </span><span class="line" data-startTime="828">luckily short. </span> <span class="line" data-startTime="829">But more importantly the </span><span class="line" data-startTime="829">datastore.Get call turned from </span><span class="line" data-startTime="832">five sequential calls into </span><span class="line" data-startTime="832">just one short one. </span> <span class="line" data-startTime="838">So we've already cut down our </span><span class="line" data-startTime="838">program's request processing </span><span class="line" data-startTime="841">time dramatically. </span> <span class="line" data-startTime="845">Third technique I want to </span><span class="line" data-startTime="845">talk about is caching. </span> <span class="line" data-startTime="848">And I'm sure many of you have </span><span class="line" data-startTime="848">cached things in the past. </span> <span class="line" data-startTime="851">And in our Gopher Mart scenario, </span><span class="line" data-startTime="851">this would be like a </span><span class="line" data-startTime="855">checkout gopher remembering </span><span class="line" data-startTime="855">that for a certain fresh </span><span class="line" data-startTime="859">fruit &mdash; which might not have bar </span><span class="line" data-startTime="859">codes, and they normally </span><span class="line" data-startTime="861">have to look up a </span><span class="line" data-startTime="861">booklet for &mdash; </span><span class="line" data-startTime="862">they just remember gopher </span><span class="line" data-startTime="862">berries, 361. </span> <span class="line" data-startTime="866">Gopher bananas, 492. </span> <span class="line" data-startTime="868">They can just remember these </span><span class="line" data-startTime="868">things once they've been </span><span class="line" data-startTime="870">running for a while, and they </span><span class="line" data-startTime="870">can be a lot quicker. </span> <span class="line" data-startTime="874">But the first layer </span><span class="line" data-startTime="874">that I want to </span><span class="line" data-startTime="876">talk about is Datastore. </span> <span class="line" data-startTime="877">And Datastore is a great </span><span class="line" data-startTime="877">storage system. </span></p>

<p><span class="line" data-startTime="880">It's very fast. </span> <span class="line" data-startTime="880">It's very reliable. </span> <span class="line" data-startTime="881">It's highly scalable. </span> <span class="line" data-startTime="883">But it also can be </span><span class="line" data-startTime="883">used as a cache. </span> <span class="line" data-startTime="885">So your program might be doing </span><span class="line" data-startTime="885">expensive computation work. </span> <span class="line" data-startTime="888">It might be compositing </span><span class="line" data-startTime="888">images. </span> <span class="line" data-startTime="890">It might be fetching a request </span><span class="line" data-startTime="890">via URL fetch from a remote </span><span class="line" data-startTime="895">server that's slow. </span> <span class="line" data-startTime="897">It could be doing any number of </span><span class="line" data-startTime="897">things outside itself that </span><span class="line" data-startTime="899">it has very little control over </span><span class="line" data-startTime="899">that can be quite slow. </span> <span class="line" data-startTime="902">We can stick those in the </span><span class="line" data-startTime="902">Datastore, and then all our </span><span class="line" data-startTime="905">app instances can check the </span><span class="line" data-startTime="905">Datastore before trying to do </span><span class="line" data-startTime="907">that expensive computation </span><span class="line" data-startTime="907">or remote fetch. </span></p>

<p><span class="line" data-startTime="911">One thing even faster than </span><span class="line" data-startTime="911">Datastore is Memcache. </span> <span class="line" data-startTime="915">And as opposed to Datastore </span><span class="line" data-startTime="915">where a small Get might take </span><span class="line" data-startTime="919">20 milliseconds &mdash; </span><span class="line" data-startTime="920">thereabouts &mdash; </span><span class="line" data-startTime="921">Memcache can do it in </span><span class="line" data-startTime="921">about 1 millisecond. </span> <span class="line" data-startTime="923">So it can often be 20 times </span><span class="line" data-startTime="923">faster for small workloads. </span> <span class="line" data-startTime="928">That's great. </span> <span class="line" data-startTime="928">It's shared across all </span><span class="line" data-startTime="928">your instances. </span> <span class="line" data-startTime="929">You know, one of your checkout </span><span class="line" data-startTime="929">gophers needs to look up the </span><span class="line" data-startTime="934">code for gopher berries. </span> <span class="line" data-startTime="935">It stores it in your Memcache, </span><span class="line" data-startTime="935">and every other checkout </span><span class="line" data-startTime="937">gopher suddenly gets the benefit </span><span class="line" data-startTime="937">of that caching. </span> <span class="line" data-startTime="941">You need to remember that, </span><span class="line" data-startTime="941">unlike Datastore, Memcache is </span><span class="line" data-startTime="943">not guaranteed to hang around. </span></p>

<p><span class="line" data-startTime="945">It's not a persistent storage </span><span class="line" data-startTime="945">system so it could get flushed </span><span class="line" data-startTime="949">any time your app has been using </span><span class="line" data-startTime="949">Memcache too much or </span><span class="line" data-startTime="954">your App Engine infrastructure </span><span class="line" data-startTime="954">moves your app to </span><span class="line" data-startTime="956">another data center. </span> <span class="line" data-startTime="957">So you can't depend </span><span class="line" data-startTime="957">on it being there. </span> <span class="line" data-startTime="959">But it's a great way of keeping </span><span class="line" data-startTime="959">hot used data at </span><span class="line" data-startTime="964">immediate access. </span> <span class="line" data-startTime="965">Third thing to use, and </span><span class="line" data-startTime="965">something that might be quite </span><span class="line" data-startTime="969">foreign to particularly </span><span class="line" data-startTime="969">Python programmers, </span><span class="line" data-startTime="971">is using local memory. </span> <span class="line" data-startTime="973">Your app is running as a program </span><span class="line" data-startTime="973">on a real machine. </span> <span class="line" data-startTime="975">And we can easily forget about </span><span class="line" data-startTime="975">that with our abstract notions </span><span class="line" data-startTime="978">of the App Engine set up, and </span><span class="line" data-startTime="978">instances, and requests, and </span><span class="line" data-startTime="982">it all feels very abstract. </span> <span class="line" data-startTime="984">And we forget that they're </span><span class="line" data-startTime="984">programs running on a machine </span><span class="line" data-startTime="987">and that machine has memory. </span> <span class="line" data-startTime="989">So we can use local memory </span><span class="line" data-startTime="989">in your app instance. </span></p>

<p><span class="line" data-startTime="992">It would just be sticking things </span><span class="line" data-startTime="992">in a global variable, </span><span class="line" data-startTime="994">for example. </span> <span class="line" data-startTime="995">And that's even faster. </span> <span class="line" data-startTime="996">That's three orders of magnitude </span><span class="line" data-startTime="996">faster than Memcache </span><span class="line" data-startTime="998">will usually be for </span><span class="line" data-startTime="998">small amounts. </span> <span class="line" data-startTime="1002">It's even more fragile than </span><span class="line" data-startTime="1002">Memcache, though. </span> <span class="line" data-startTime="1004">It's not shared across </span><span class="line" data-startTime="1004">instances. </span> <span class="line" data-startTime="1006">So if one instance gets shut </span><span class="line" data-startTime="1006">down because it hasn't been </span><span class="line" data-startTime="1009">receiving enough requests or </span><span class="line" data-startTime="1009">it's not needed, that memory </span><span class="line" data-startTime="1012">will disappear. </span> <span class="line" data-startTime="1013">But it's an important tool in </span><span class="line" data-startTime="1013">your tool belt when your </span><span class="line" data-startTime="1016">caching things to use </span><span class="line" data-startTime="1016">local memory. </span> <span class="line" data-startTime="1018">It can be heaps faster than </span><span class="line" data-startTime="1018">Memcache, heaps more reliable, </span><span class="line" data-startTime="1023">with the proviso that </span><span class="line" data-startTime="1023">it will disappear. </span></p>

<p><span class="line" data-startTime="1029">The third technique I want to </span><span class="line" data-startTime="1029">talk about it concurrency. </span> <span class="line" data-startTime="1030">And this is where Go </span><span class="line" data-startTime="1030">really shines. </span> <span class="line" data-startTime="1033">And this is where it </span><span class="line" data-startTime="1033">really excels as </span><span class="line" data-startTime="1037">compared to other runtimes. </span> <span class="line" data-startTime="1039">Concurrency is where you can </span><span class="line" data-startTime="1039">decompose what your app is </span><span class="line" data-startTime="1042">doing into independently </span><span class="line" data-startTime="1042">executing things. </span> <span class="line" data-startTime="1046">So even though Go on App Engine </span><span class="line" data-startTime="1046">is, at the moment, </span><span class="line" data-startTime="1050">bound to a single CPU thread, </span><span class="line" data-startTime="1050">concurrency allows you to </span><span class="line" data-startTime="1054">decompose your program so that </span><span class="line" data-startTime="1054">you can write very simple </span><span class="line" data-startTime="1057">chunks of code that are </span><span class="line" data-startTime="1057">run concurrently. </span></p>

<p><span class="line" data-startTime="1061">They might not run </span><span class="line" data-startTime="1061">in parallel. </span> <span class="line" data-startTime="1062">But while one is blocked on an </span><span class="line" data-startTime="1062">API request, another one will </span><span class="line" data-startTime="1065">immediately start running. </span> <span class="line" data-startTime="1067">And in our Gopher Mart scenario, </span><span class="line" data-startTime="1067">this would be as if </span><span class="line" data-startTime="1069">a checkout gopher needs to get </span><span class="line" data-startTime="1069">a price check on an item and </span><span class="line" data-startTime="1073">then can immediately start </span><span class="line" data-startTime="1073">scanning the other items. </span> <span class="line" data-startTime="1076">If you walk into a regular </span><span class="line" data-startTime="1076">supermarket, you don't see </span><span class="line" data-startTime="1078">somebody waiting for a price </span><span class="line" data-startTime="1078">check, and then just standing </span><span class="line" data-startTime="1080">there waiting, getting the </span><span class="line" data-startTime="1080">price check back and then </span><span class="line" data-startTime="1083">doing the other items. </span> <span class="line" data-startTime="1084">They go on and do more things. </span> <span class="line" data-startTime="1085">And so that's concurrent work. </span> <span class="line" data-startTime="1090">So let me take a bit of our code </span><span class="line" data-startTime="1090">from our example app that </span><span class="line" data-startTime="1093">was poorly written by me, and </span><span class="line" data-startTime="1093">let's make it better and </span><span class="line" data-startTime="1097">faster by using concurrency. </span> <span class="line" data-startTime="1099">So here might be a little chunk </span><span class="line" data-startTime="1099">of code that needs to </span><span class="line" data-startTime="1102">look up all the entities </span><span class="line" data-startTime="1102">of two Datastore kinds. </span></p>

<p><span class="line" data-startTime="1105">In this case, we have a list and </span><span class="line" data-startTime="1105">an item kind, and we want </span><span class="line" data-startTime="1108">to get all the items of each. </span> <span class="line" data-startTime="1112">This is a straight line code, </span><span class="line" data-startTime="1112">and it's very slow. </span> <span class="line" data-startTime="1115">If each query takes a certain </span><span class="line" data-startTime="1115">amount of time, the total time </span><span class="line" data-startTime="1118">to run this bit of code </span><span class="line" data-startTime="1118">is going to be </span><span class="line" data-startTime="1119">the sum of the times. </span> <span class="line" data-startTime="1121">It'd be much, much quicker if we </span><span class="line" data-startTime="1121">could run them in parallel. </span> <span class="line" data-startTime="1127">And since most of your web apps, </span><span class="line" data-startTime="1127">most of all web apps, </span><span class="line" data-startTime="1131">tend to be bound waiting on API </span><span class="line" data-startTime="1131">calls to come back from </span><span class="line" data-startTime="1134">various other services, this </span><span class="line" data-startTime="1134">is an easy way to speed up </span><span class="line" data-startTime="1137">most requests by doing </span><span class="line" data-startTime="1137">things concurrently. </span> <span class="line" data-startTime="1140">So here all we've had to do is </span><span class="line" data-startTime="1140">kick off two Go routines to </span><span class="line" data-startTime="1143">run these queries, and they'll </span><span class="line" data-startTime="1143">be independently waiting. </span> <span class="line" data-startTime="1147">Then we're using an error </span><span class="line" data-startTime="1147">channel to signal </span><span class="line" data-startTime="1150">when they're done. </span></p>

<p><span class="line" data-startTime="1151">Hopefully it'll send back </span><span class="line" data-startTime="1151">nil if there's no error. </span> <span class="line" data-startTime="1153">And then, down at the bottom, </span><span class="line" data-startTime="1153">we just wait for </span><span class="line" data-startTime="1155">both of them to return. </span> <span class="line" data-startTime="1158">This means that instead of two </span><span class="line" data-startTime="1158">requests summing together, we </span><span class="line" data-startTime="1162">now end up taking time roughly </span><span class="line" data-startTime="1162">equivalent of the maximum </span><span class="line" data-startTime="1166">length of either of them. </span> <span class="line" data-startTime="1167">So that's going to be strictly </span><span class="line" data-startTime="1167">less than the sum in any </span><span class="line" data-startTime="1171">reasonable scenario. </span> <span class="line" data-startTime="1172">So this is a very simple flavor </span><span class="line" data-startTime="1172">of concurrency in Go. </span> <span class="line" data-startTime="1176">This is far from </span><span class="line" data-startTime="1176">sophisticated. </span></p>

<p><span class="line" data-startTime="1178">So I'll commend you, my </span><span class="line" data-startTime="1178">colleague, Sameer Ajmani, and </span><span class="line" data-startTime="1181">his talk this afternoon where </span><span class="line" data-startTime="1181">he'll be talking about some </span><span class="line" data-startTime="1183">advanced Go concurrency </span><span class="line" data-startTime="1183">patterns. </span> <span class="line" data-startTime="1185">So if this kind of thing sounds </span><span class="line" data-startTime="1185">interesting to you, and </span><span class="line" data-startTime="1188">it does to me, get along </span><span class="line" data-startTime="1188">to that talk. </span> <span class="line" data-startTime="1198">The next technique I </span><span class="line" data-startTime="1198">want to talk about </span><span class="line" data-startTime="1200">is controlling variance. </span> <span class="line" data-startTime="1202">And in our Gopher Mart, </span><span class="line" data-startTime="1202">we have a 10 </span><span class="line" data-startTime="1206">items or fewer queue. </span> <span class="line" data-startTime="1207">But occasionally a gopher comes </span><span class="line" data-startTime="1207">by when they've got a </span><span class="line" data-startTime="1210">few more than 10 items, if </span><span class="line" data-startTime="1210">you know what I mean. </span> <span class="line" data-startTime="1213">And while most gophers might </span><span class="line" data-startTime="1213">take a millisecond to process, </span><span class="line" data-startTime="1217">one in 100 might take </span><span class="line" data-startTime="1217">10 times that. </span> <span class="line" data-startTime="1220">It might take 100 milliseconds, </span><span class="line" data-startTime="1220">for example. </span></p>

<p><span class="line" data-startTime="1222">And this is a very </span><span class="line" data-startTime="1222">common thing. </span> <span class="line" data-startTime="1224">It could be due to </span><span class="line" data-startTime="1224">the request. </span> <span class="line" data-startTime="1226">So in our Gopher Mart situation, </span><span class="line" data-startTime="1226">it might just be </span><span class="line" data-startTime="1229">the occasional gopher with a </span><span class="line" data-startTime="1229">very, very big cart full of </span><span class="line" data-startTime="1231">items, whereas most carts </span><span class="line" data-startTime="1231">only have a few items. </span> <span class="line" data-startTime="1236">But it can also be due </span><span class="line" data-startTime="1236">to the infrastructure </span><span class="line" data-startTime="1238">underneath your app. </span> <span class="line" data-startTime="1242">And the App Engine </span><span class="line" data-startTime="1242">infrastructure is great. </span> <span class="line" data-startTime="1244">It's highly scalable. </span> <span class="line" data-startTime="1246">It's fast. </span> <span class="line" data-startTime="1246">It's dependable. </span></p>

<p><span class="line" data-startTime="1247">It's very reliable. </span> <span class="line" data-startTime="1248">But it's not perfect. </span> <span class="line" data-startTime="1250">Occasionally you'll be doing </span><span class="line" data-startTime="1250">Datastore requests, and </span><span class="line" data-startTime="1252">they'll be going 20 </span><span class="line" data-startTime="1252">milliseconds, 25 milliseconds, </span><span class="line" data-startTime="1254">22 milliseconds, be really </span><span class="line" data-startTime="1254">reliably quick. </span> <span class="line" data-startTime="1257">But then a small fraction of it </span><span class="line" data-startTime="1257">might take half a second. </span> <span class="line" data-startTime="1268">And the consequences of this </span><span class="line" data-startTime="1268">kind of variance can cascade </span><span class="line" data-startTime="1272">through our system if </span><span class="line" data-startTime="1272">it's sophisticated. </span> <span class="line" data-startTime="1275">If your app needs to do several </span><span class="line" data-startTime="1275">things in a sequence, </span><span class="line" data-startTime="1278">where each one depends on the </span><span class="line" data-startTime="1278">results of the previous one </span><span class="line" data-startTime="1280">such that these things can't be </span><span class="line" data-startTime="1280">done concurrently, then a </span><span class="line" data-startTime="1284">variance in one affects </span><span class="line" data-startTime="1284">the whole pipeline. </span> <span class="line" data-startTime="1286">And the perfect storm of </span><span class="line" data-startTime="1286">variance affecting all your </span><span class="line" data-startTime="1290">items in this sequence </span><span class="line" data-startTime="1290">will blow out your </span><span class="line" data-startTime="1293">request time hugely. </span> <span class="line" data-startTime="1296">Variable requests also make </span><span class="line" data-startTime="1296">scheduling a lot harder. </span></p>

<p><span class="line" data-startTime="1299">And this something that I </span><span class="line" data-startTime="1299">haven't really touched on </span><span class="line" data-startTime="1301">much, and I won't go into </span><span class="line" data-startTime="1301">too much detail. </span> <span class="line" data-startTime="1303">But the App Engine scheduler </span><span class="line" data-startTime="1303">needs to take a guess as to </span><span class="line" data-startTime="1308">which App Engine instance </span><span class="line" data-startTime="1308">each request will </span><span class="line" data-startTime="1312">best be served by. </span> <span class="line" data-startTime="1313">It's got a balance </span><span class="line" data-startTime="1313">across them. </span> <span class="line" data-startTime="1315">If it's getting too much </span><span class="line" data-startTime="1315">traffic, it'll start up new </span><span class="line" data-startTime="1316">instances and so on </span><span class="line" data-startTime="1316">automatically. </span> <span class="line" data-startTime="1319">But it needs to usually, for the </span><span class="line" data-startTime="1319">most part, take a guess as </span><span class="line" data-startTime="1321">to which instance will be idle </span><span class="line" data-startTime="1321">the first so it can add that </span><span class="line" data-startTime="1325">request to that App Engine </span><span class="line" data-startTime="1325">instance's queue. </span></p>

<p><span class="line" data-startTime="1330">The less predictable your </span><span class="line" data-startTime="1330">request handling is, though, </span><span class="line" data-startTime="1333">the hard it is to do that </span><span class="line" data-startTime="1333">kind of prediction. </span> <span class="line" data-startTime="1336">So if there's variance in your </span><span class="line" data-startTime="1336">request handling, the </span><span class="line" data-startTime="1340">scheduler, though it is great </span><span class="line" data-startTime="1340">and highly sophisticated, will </span><span class="line" data-startTime="1343">start to make mistakes </span><span class="line" data-startTime="1343">more often. </span> <span class="line" data-startTime="1345">And so you might get your </span><span class="line" data-startTime="1345">instances being a bit </span><span class="line" data-startTime="1348">overbalanced. </span> <span class="line" data-startTime="1348">You know, one handling 100 </span><span class="line" data-startTime="1348">requests for only two being </span><span class="line" data-startTime="1352">handled by another, and so on. </span> <span class="line" data-startTime="1354">So it might make </span><span class="line" data-startTime="1354">mistakes there. </span> <span class="line" data-startTime="1355">And this will lead to you </span><span class="line" data-startTime="1355">requiring more app instances, </span><span class="line" data-startTime="1359">more instance hours, which will </span><span class="line" data-startTime="1359">lead to a higher bill if </span><span class="line" data-startTime="1363">you've got billing enabled. </span> <span class="line" data-startTime="1365">So all we want to do </span><span class="line" data-startTime="1365">is control the </span><span class="line" data-startTime="1367">variance of our requests. </span> <span class="line" data-startTime="1368">We want to put an upper limit </span><span class="line" data-startTime="1368">on how long we're going to </span><span class="line" data-startTime="1372">spend doing certain </span><span class="line" data-startTime="1372">operations. </span></p>

<p><span class="line" data-startTime="1374">I'll point you at this paper </span><span class="line" data-startTime="1374">publishing the ACM by two guys </span><span class="line" data-startTime="1380">from Google. </span> <span class="line" data-startTime="1381">This goes into a lot of detail </span><span class="line" data-startTime="1381">about some techniques for </span><span class="line" data-startTime="1384">controlling this kind of </span><span class="line" data-startTime="1384">variance, in particular, long </span><span class="line" data-startTime="1389">tail latency. </span> <span class="line" data-startTime="1390">And it's geared around machines </span><span class="line" data-startTime="1390">in a data center </span><span class="line" data-startTime="1394">doing server processing. </span> <span class="line" data-startTime="1395">But the same techniques apply </span><span class="line" data-startTime="1395">to web apps that are </span><span class="line" data-startTime="1399">processing requests as well. </span> <span class="line" data-startTime="1401">So I'm going to discuss just </span><span class="line" data-startTime="1401">one way of doing this. </span> <span class="line" data-startTime="1407">So I'll point you to that paper </span><span class="line" data-startTime="1407">to go into more detail. </span> <span class="line" data-startTime="1411">Storing in Memcache is usually </span><span class="line" data-startTime="1411">an optimization. </span> <span class="line" data-startTime="1413">So as I mentioned before, </span><span class="line" data-startTime="1413">Memcache is not perfect, and </span><span class="line" data-startTime="1417">it won't necessarily guarantee </span><span class="line" data-startTime="1417">to hold your data. </span> <span class="line" data-startTime="1419">If you need guaranteed data </span><span class="line" data-startTime="1419">storage, you need to store it </span><span class="line" data-startTime="1422">in something like Datastore. </span></p>

<p><span class="line" data-startTime="1423">But Memcache, as a result, is </span><span class="line" data-startTime="1423">usually an optimization. </span> <span class="line" data-startTime="1428">And optimizations by their </span><span class="line" data-startTime="1428">nature are usually optional. </span> <span class="line" data-startTime="1432">So what we want to do is, in our </span><span class="line" data-startTime="1432">request, we don't want to </span><span class="line" data-startTime="1437">spend huge amounts of time, </span><span class="line" data-startTime="1437">unlimited amounts of time, on </span><span class="line" data-startTime="1439">these things that aren't </span><span class="line" data-startTime="1439">strictly required. </span> <span class="line" data-startTime="1442">So in our Gopher Mart scenario, </span><span class="line" data-startTime="1442">we might be doing a </span><span class="line" data-startTime="1446">bunch of request processing, and </span><span class="line" data-startTime="1446">then we might not want to </span><span class="line" data-startTime="1449">store those fresh fruit items </span><span class="line" data-startTime="1449">that we've looked up out of </span><span class="line" data-startTime="1453">the booklet in Memcache. </span> <span class="line" data-startTime="1454">But we don't want to spend </span><span class="line" data-startTime="1454">an infinite amount </span><span class="line" data-startTime="1456">of time doing that. </span> <span class="line" data-startTime="1457">You know, Memcache might be </span><span class="line" data-startTime="1457">briefly down, or it might be </span><span class="line" data-startTime="1460">running a bit slowly, </span><span class="line" data-startTime="1460">or whatever it is. </span> <span class="line" data-startTime="1463">So we want to cap the amount </span><span class="line" data-startTime="1463">of time that we'll spend </span><span class="line" data-startTime="1465">waiting on it. </span> <span class="line" data-startTime="1467">And here's the first approach </span><span class="line" data-startTime="1467">that does not work. </span></p>

<p><span class="line" data-startTime="1473">In our request handler, we </span><span class="line" data-startTime="1473">might just kick off a </span><span class="line" data-startTime="1475">memcache.Set operation at the </span><span class="line" data-startTime="1475">bottom in its own Go routine. </span> <span class="line" data-startTime="1480">We think, that's great. </span> <span class="line" data-startTime="1481">My request will immediately </span><span class="line" data-startTime="1481">return and Memcache will do </span><span class="line" data-startTime="1483">its thing behind the scenes. </span> <span class="line" data-startTime="1485">But the problem here is that, </span><span class="line" data-startTime="1485">in the App Engine model, the </span><span class="line" data-startTime="1489">scope of your context objects </span><span class="line" data-startTime="1489">are bound to the </span><span class="line" data-startTime="1492">scope of the request. </span> <span class="line" data-startTime="1493">So any API calls have to be </span><span class="line" data-startTime="1493">done while the request is </span><span class="line" data-startTime="1496">still going. </span> <span class="line" data-startTime="1498">And as soon as the HTTP handler </span><span class="line" data-startTime="1498">returns here, your </span><span class="line" data-startTime="1503">context will be invalidated, and </span><span class="line" data-startTime="1503">any outstanding API calls </span><span class="line" data-startTime="1507">will be canceled. </span></p>

<p><span class="line" data-startTime="1509">So we can't do this. </span> <span class="line" data-startTime="1511">Here's what we can do. </span> <span class="line" data-startTime="1514">We can again kick off the </span><span class="line" data-startTime="1514">Memcache operation </span><span class="line" data-startTime="1517">concurrently. </span> <span class="line" data-startTime="1518">And then we use a </span><span class="line" data-startTime="1518">done channel. </span> <span class="line" data-startTime="1520">And this done channel is going </span><span class="line" data-startTime="1520">to be signaled on as soon as </span><span class="line" data-startTime="1524">that Memcache operation </span><span class="line" data-startTime="1524">returns. </span> <span class="line" data-startTime="1527">And then down at the bottom, </span><span class="line" data-startTime="1527">we use Go's concurrency </span><span class="line" data-startTime="1530">primitive called a Select block </span><span class="line" data-startTime="1530">to wait for one of two </span><span class="line" data-startTime="1533">channel operations to happen. </span> <span class="line" data-startTime="1534">The first one, if the </span><span class="line" data-startTime="1534">Memcache operation </span><span class="line" data-startTime="1536">finishes, we go through. </span> <span class="line" data-startTime="1538">There's nothing in the select </span><span class="line" data-startTime="1538">body, so nothing's going to </span><span class="line" data-startTime="1540">happen but will just immediately </span><span class="line" data-startTime="1540">return from the </span><span class="line" data-startTime="1543">HTTP handler. </span></p>

<p><span class="line" data-startTime="1544">So in the likely event that </span><span class="line" data-startTime="1544">Memcache is its usual quick </span><span class="line" data-startTime="1548">and speedy self, this </span><span class="line" data-startTime="1548">has no overhead. </span> <span class="line" data-startTime="1553">The second case, though, </span><span class="line" data-startTime="1553">is if we end up </span><span class="line" data-startTime="1555">waiting a bit too long. </span> <span class="line" data-startTime="1556">And Memcache will usually be 1 </span><span class="line" data-startTime="1556">millisecond, 2 milliseconds, </span><span class="line" data-startTime="1560">depending on what you're doing </span><span class="line" data-startTime="1560">with it and how much data is </span><span class="line" data-startTime="1562">being sloshed around. </span> <span class="line" data-startTime="1564">If it takes more than 3 </span><span class="line" data-startTime="1564">milliseconds that we've </span><span class="line" data-startTime="1566">decided we want to wait for, </span><span class="line" data-startTime="1566">time.After will signal on the </span><span class="line" data-startTime="1570">channel the returns after </span><span class="line" data-startTime="1570">3 milliseconds. </span> <span class="line" data-startTime="1572">So at that point, if Memcache </span><span class="line" data-startTime="1572">takes too long, that second </span><span class="line" data-startTime="1576">channel will be signal on we </span><span class="line" data-startTime="1576">drop as like we've and return </span><span class="line" data-startTime="1579">and that point the Memcache </span><span class="line" data-startTime="1579">operation will be canceled. </span></p>

<p><span class="line" data-startTime="1582">It will fail. </span> <span class="line" data-startTime="1583">It will go away. </span> <span class="line" data-startTime="1584">And we've returned </span><span class="line" data-startTime="1584">to the user. </span> <span class="line" data-startTime="1586">So using these kind of </span><span class="line" data-startTime="1586">primitives to timeout waiting </span><span class="line" data-startTime="1590">for things that are optional </span><span class="line" data-startTime="1590">is a useful technique to </span><span class="line" data-startTime="1595">ensure high-performance </span><span class="line" data-startTime="1595">consistently. </span> <span class="line" data-startTime="1601">So here's an overview </span><span class="line" data-startTime="1601">of where we went. </span> <span class="line" data-startTime="1605">We started off with a very </span><span class="line" data-startTime="1605">poorly written app on my </span><span class="line" data-startTime="1608">behalf that did very </span><span class="line" data-startTime="1608">simplicity code. </span> <span class="line" data-startTime="1610">It just did a sequence of </span><span class="line" data-startTime="1610">Datastore operations, and then </span><span class="line" data-startTime="1613">a mail.send and took nearly </span><span class="line" data-startTime="1613">400 milliseconds. </span> <span class="line" data-startTime="1616">Just by applying two of the </span><span class="line" data-startTime="1616">techniques that we did today, </span><span class="line" data-startTime="1618">we got it down to only </span><span class="line" data-startTime="1618">70 milliseconds. </span> <span class="line" data-startTime="1620">So a dramatic speedup with </span><span class="line" data-startTime="1620">very little work. </span> <span class="line" data-startTime="1624">Once you've got experience </span><span class="line" data-startTime="1624">with it, these kinds of </span><span class="line" data-startTime="1625">transformations will take </span><span class="line" data-startTime="1625">5 to 10 minutes. </span></p>

<p><span class="line" data-startTime="1627">So it can very quickly done. </span> <span class="line" data-startTime="1631">So let me sum up what </span><span class="line" data-startTime="1631">we covered today. </span> <span class="line" data-startTime="1633">The first thing is to </span><span class="line" data-startTime="1633">find the performance </span><span class="line" data-startTime="1636">bottlenecks in your code. </span> <span class="line" data-startTime="1637">Don't rely on your own </span><span class="line" data-startTime="1637">intuition, because your </span><span class="line" data-startTime="1639">intuition will fool </span><span class="line" data-startTime="1639">you reliably. </span> <span class="line" data-startTime="1643">And, even if your intuition is </span><span class="line" data-startTime="1643">correct one day, it might be </span><span class="line" data-startTime="1646">incorrect down the road. </span> <span class="line" data-startTime="1647">So the important thing to note </span><span class="line" data-startTime="1647">is to measure, and measure, </span><span class="line" data-startTime="1651">and measure, and keep coming </span><span class="line" data-startTime="1651">back to measuring to </span><span class="line" data-startTime="1653">understand your app's </span><span class="line" data-startTime="1653">performance. </span> <span class="line" data-startTime="1655">Then the five techniques </span><span class="line" data-startTime="1655">that I covered &mdash; </span><span class="line" data-startTime="1657">deferring work &mdash; </span><span class="line" data-startTime="1658">moving work that doesn't have </span><span class="line" data-startTime="1658">to happen during the request </span><span class="line" data-startTime="1661">out of the scope of the request, </span><span class="line" data-startTime="1661">probably by using </span><span class="line" data-startTime="1663">Task Queue or the </span><span class="line" data-startTime="1663">delay package. </span> <span class="line" data-startTime="1666">Batching &mdash; </span><span class="line" data-startTime="1666">so doing multiple operations </span><span class="line" data-startTime="1666">in one shot. </span> <span class="line" data-startTime="1670">Caching &mdash; </span><span class="line" data-startTime="1671">so memoizing data. </span></p>

<p><span class="line" data-startTime="1673">It might be in the Datastore. </span> <span class="line" data-startTime="1675">It might be in Memcache. </span> <span class="line" data-startTime="1676">It might be in local memory. </span> <span class="line" data-startTime="1676">it might be even in other </span><span class="line" data-startTime="1678">places I haven't mentioned, so </span><span class="line" data-startTime="1678">that you can check them later </span><span class="line" data-startTime="1682">and speed up those parts </span><span class="line" data-startTime="1682">of your app. </span> <span class="line" data-startTime="1685">Concurrency &mdash; </span><span class="line" data-startTime="1686">so decomposing the work that </span><span class="line" data-startTime="1686">you're doing into independent </span><span class="line" data-startTime="1689">pieces that can be combined. </span> <span class="line" data-startTime="1692">And finally controlling variance </span><span class="line" data-startTime="1692">to cut off the long </span><span class="line" data-startTime="1696">tail of latency so that your </span><span class="line" data-startTime="1696">app requests can be </span><span class="line" data-startTime="1699">consistently quick rather than </span><span class="line" data-startTime="1699">very, very occasionally taking </span><span class="line" data-startTime="1702">a bit too much time. </span> <span class="line" data-startTime="1705">So finally here's a bunch </span><span class="line" data-startTime="1705">of links to the </span><span class="line" data-startTime="1708">Go project in general. </span></p>

<p><span class="line" data-startTime="1709">There's a heap of documentation </span><span class="line" data-startTime="1709">on there. </span> <span class="line" data-startTime="1711">You can download Go, </span><span class="line" data-startTime="1711">try it out online. </span> <span class="line" data-startTime="1714">The second link is to the </span><span class="line" data-startTime="1714">Go on App Engine docs. </span> <span class="line" data-startTime="1719">The third one links to these </span><span class="line" data-startTime="1719">talk's slides, plus my really </span><span class="line" data-startTime="1723">bad source code for the Gopher </span><span class="line" data-startTime="1723">Mart app and its revisions, </span><span class="line" data-startTime="1727">and then to the Appstats package </span><span class="line" data-startTime="1727">that was written by </span><span class="line" data-startTime="1730">Matt Jibson, who </span><span class="line" data-startTime="1730">might be here. </span> <span class="line" data-startTime="1732">He did really good </span><span class="line" data-startTime="1732">work on that. </span> <span class="line" data-startTime="1734">There's more Go sessions coming </span><span class="line" data-startTime="1734">up later today and </span><span class="line" data-startTime="1736">tomorrow, so get </span><span class="line" data-startTime="1736">along to that. </span> <span class="line" data-startTime="1738">In particular, I'll be at the </span><span class="line" data-startTime="1738">Office Hours this level at the </span><span class="line" data-startTime="1744">Cloud Sandbox if you have any </span><span class="line" data-startTime="1744">particular questions about Go </span><span class="line" data-startTime="1746">on App Engine, whether </span><span class="line" data-startTime="1746">performance or otherwise. </span> <span class="line" data-startTime="1749">So come along and have a chat. </span> <span class="line" data-startTime="1752">So with that, I'll thank you for </span><span class="line" data-startTime="1752">coming again, and we can </span><span class="line" data-startTime="1755">take questions. </span></p>

<p><span class="line" data-startTime="1756">[APPLAUSE] </span></p>

<p class="speaker"><span class="line" data-starttime="1764"><span class="speakerName">Audience</span>: Can you hear me? </span><span class="line" data-startTime="1765">OK. </span><span class="line" data-startTime="1766">So I've been using Go for a </span><span class="line" data-startTime="1766">while now, but I haven't used </span><span class="line" data-startTime="1769">App Engine yet. </span><span class="line" data-startTime="1769">So quick question on the </span><span class="line" data-startTime="1769">control variance. </span></p>

<p class="speaker"><span class="line" data-starttime="1772"><span class="speakerName">David Symonds</span>: Yep. </span></p>

<p class="speaker"><span class="line" data-starttime="1772"><span class="speakerName">Audience</span>: Instead of trying to </span><span class="line" data-startTime="1772">set it in Memcache right then </span><span class="line" data-startTime="1775">and there, could you not put it </span><span class="line" data-startTime="1775">in a global channel and do </span><span class="line" data-startTime="1779">a select on it with a timeout, </span><span class="line" data-startTime="1779">and then handle it outside? </span></p>

<p class="speaker"><span class="line" data-starttime="1785"><span class="speakerName">David Symonds</span>: In a </span><span class="line" data-startTime="1785">global channel? </span><span class="line" data-startTime="1786">You mean like in a </span><span class="line" data-startTime="1786">global variable? </span></p>

<p class="speaker"><span class="line" data-starttime="1788"><span class="speakerName">Audience</span>: Right, right. </span></p>

<p class="speaker"><span class="line" data-starttime="1789"><span class="speakerName">David Symonds</span>: Yeah, you can </span><span class="line" data-startTime="1789">store there right away. </span><span class="line" data-startTime="1792">The downside of that is that it </span><span class="line" data-startTime="1792">will only be used for that </span><span class="line" data-startTime="1795">app instance. </span><span class="line" data-startTime="1796">So the memory for each </span><span class="line" data-startTime="1796">app instance is only </span><span class="line" data-startTime="1798">accessible to the app. </span></p>

<p class="speaker"><span class="line" data-starttime="1799"><span class="speakerName">Audience</span>: That wasn't </span><span class="line" data-startTime="1799">the question, sir. </span><span class="line" data-startTime="1800">So the operation of setting it </span><span class="line" data-startTime="1800">in Memcache, instead of doing </span><span class="line" data-startTime="1803">it in that handle, could you </span><span class="line" data-startTime="1803">not put it in a channel and </span><span class="line" data-startTime="1807">then pick it up from there </span><span class="line" data-startTime="1807">with a worker? </span><span class="line" data-startTime="1809">Just set it in. </span></p>

<p class="speaker"><span class="line" data-starttime="1812"><span class="speakerName">David Symonds</span>: You could. </span><span class="line" data-startTime="1815">The only way to make API calls </span><span class="line" data-startTime="1815">is during a request. </span><span class="line" data-startTime="1818">So you can't kick off a Go </span><span class="line" data-startTime="1818">routine that does its own </span><span class="line" data-startTime="1820">thing independent of requests. </span><span class="line" data-startTime="1823">You could put it in a channel </span><span class="line" data-startTime="1823">and in a later request pull </span><span class="line" data-startTime="1825">things off the channel and do </span><span class="line" data-startTime="1825">it at that point, or use a </span><span class="line" data-startTime="1828">Task Queue or use backends </span><span class="line" data-startTime="1828">to do that kind of thing. </span><span class="line" data-startTime="1830">Yeah, that would work. </span></p>

<p class="speaker"><span class="line" data-starttime="1831"><span class="speakerName">Audience</span>: Thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="1834"><span class="speakerName">David Symonds</span>: One </span><span class="line" data-startTime="1834">from this side. </span></p>

<p class="speaker"><span class="line" data-starttime="1834"><span class="speakerName">Audience</span>: Hi. </span><span class="line" data-startTime="1835">Nelson from [INAUDIBLE]. </span><span class="line" data-startTime="1836">Can you comment on a couple </span><span class="line" data-startTime="1836">techniques people are using to </span><span class="line" data-startTime="1839">make Go applications more </span><span class="line" data-startTime="1839">efficient in pricing compared </span><span class="line" data-startTime="1844">to Java and Python? </span></p>

<p class="speaker"><span class="line" data-starttime="1847"><span class="speakerName">David Symonds</span>: So I mentioned </span><span class="line" data-startTime="1847">that Go apps get compiled to </span><span class="line" data-startTime="1851">native code. </span> <span class="line" data-startTime="1852">They're binaries. </span> <span class="line" data-startTime="1855">That results in them starting </span><span class="line" data-startTime="1855">up really quickly. </span> <span class="line" data-startTime="1857">So every time a new request </span><span class="line" data-startTime="1857">starts coming in and the </span><span class="line" data-startTime="1860">infrastructure decides to spin </span><span class="line" data-startTime="1860">up new requests, it'll be a </span><span class="line" data-startTime="1864">lot faster load. </span> <span class="line" data-startTime="1865">It's just got to run </span><span class="line" data-startTime="1865">a single program. </span> <span class="line" data-startTime="1866">It doesn't have to start a </span><span class="line" data-startTime="1866">virtual machine, page in a </span><span class="line" data-startTime="1868">bunch of modules, or </span><span class="line" data-startTime="1868">whatever it is. </span> <span class="line" data-startTime="1871">So it'll be really </span><span class="line" data-startTime="1871">fast to start. </span> <span class="line" data-startTime="1873">That means that that single </span><span class="line" data-startTime="1873">instance starts up quickly and </span><span class="line" data-startTime="1877">immediately can start </span><span class="line" data-startTime="1877">doing work. </span> <span class="line" data-startTime="1878">If you suddenly get an onslaught </span><span class="line" data-startTime="1878">of traffic, in other </span><span class="line" data-startTime="1881">runtimes, you might have to </span><span class="line" data-startTime="1881">start up a bunch of instance. </span> <span class="line" data-startTime="1883">That'll take a little while, </span><span class="line" data-startTime="1883">but then they can deal with </span><span class="line" data-startTime="1885">all the traffic that's </span><span class="line" data-startTime="1885">coming in. </span></p>

<p><span class="line" data-startTime="1887">The second main way is that you </span><span class="line" data-startTime="1887">have a lot more control </span><span class="line" data-startTime="1889">over the memory that </span><span class="line" data-startTime="1889">you are using. </span> <span class="line" data-startTime="1893">Go is a very hands-on </span><span class="line" data-startTime="1893">language. </span> <span class="line" data-startTime="1896">It gives you a lot more control </span><span class="line" data-startTime="1896">over things like </span><span class="line" data-startTime="1898">memory lag and so on. </span> <span class="line" data-startTime="1899">So you can allocate a slab of </span><span class="line" data-startTime="1899">bytes, and you've got that </span><span class="line" data-startTime="1903">slab of bytes. </span> <span class="line" data-startTime="1903">You don't have any overhead </span><span class="line" data-startTime="1903">for that. </span> <span class="line" data-startTime="1906">So using those kinds of things, </span><span class="line" data-startTime="1906">if you're intensively </span><span class="line" data-startTime="1908">using your application </span><span class="line" data-startTime="1908">instance's memory, you can </span><span class="line" data-startTime="1912">feed a lot more in, say an F1 </span><span class="line" data-startTime="1912">instance, than you can in, </span><span class="line" data-startTime="1916">say, other runtime. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="1918"><span class="speakerName">Audience</span>: Why did you use </span><span class="line" data-startTime="1918">a buffered channel </span><span class="line" data-startTime="1920">in that last example? </span></p>

<p class="speaker"><span class="line" data-starttime="1922"><span class="speakerName">David Symonds</span>: Good question. </span></p>

<p class="speaker"><span class="line" data-starttime="1925"><span class="speakerName">Audience</span>: Is that so the </span><span class="line" data-startTime="1925">Go routine dies? </span></p>

<p class="speaker"><span class="line" data-starttime="1927"><span class="speakerName">David Symonds</span>: Yeah, I use a </span><span class="line" data-startTime="1927">buffered channel in case the </span><span class="line" data-startTime="1929">timeout happens. </span><span class="line" data-startTime="1930">So if the timeout happens, </span><span class="line" data-startTime="1930">nothing's going to be reading </span><span class="line" data-startTime="1933">from that done channel. </span><span class="line" data-startTime="1935">So if the timeout happens, </span><span class="line" data-startTime="1935">nothing will be reading from </span><span class="line" data-startTime="1937">that buffered channel, which </span><span class="line" data-startTime="1937">means when the Memcache call </span><span class="line" data-startTime="1939">does return, it will block </span><span class="line" data-startTime="1939">unless I buffer it. </span><span class="line" data-startTime="1943">So I buffer it so that if that </span><span class="line" data-startTime="1943">timeout happens, the Memcache </span><span class="line" data-startTime="1946">can return and still do a </span><span class="line" data-startTime="1946">channel operation to a channel </span><span class="line" data-startTime="1949">that will just disappear. </span><span class="line" data-startTime="1950">But then that Go routine </span><span class="line" data-startTime="1950">will exit and </span><span class="line" data-startTime="1951">won't be hanging around. </span></p>

<p class="speaker"><span class="line" data-starttime="1953"><span class="speakerName">Audience</span>: So there could </span><span class="line" data-startTime="1953">be a memory leak if </span><span class="line" data-startTime="1954">you don't do that? </span></p>

<p class="speaker"><span class="line" data-starttime="1956"><span class="speakerName">David Symonds</span>: You have </span><span class="line" data-startTime="1956">a Go routine leak. </span><span class="line" data-startTime="1957">Yeah, that would be a memory </span><span class="line" data-startTime="1957">leak in that case if you </span><span class="line" data-startTime="1959">didn't have a buffered </span><span class="line" data-startTime="1959">channel. </span></p>

<p class="speaker"><span class="line" data-starttime="1959"><span class="speakerName">Audience</span>: It's not tied </span><span class="line" data-startTime="1959">to the parent channel, </span><span class="line" data-startTime="1961">or the parent request? </span></p>

<p class="speaker"><span class="line" data-starttime="1962"><span class="speakerName">David Symonds</span>: No. </span></p>

<p class="speaker"><span class="line" data-starttime="1964"><span class="speakerName">Audience</span>: I have a few </span><span class="line" data-startTime="1964">short questions. </span><span class="line" data-startTime="1966">Thank you. </span><span class="line" data-startTime="1967">NDB has caching built into it. </span><span class="line" data-startTime="1970">Is there any plan to </span><span class="line" data-startTime="1970">do that for Go? </span></p>

<p class="speaker"><span class="line" data-starttime="1973"><span class="speakerName">David Symonds</span>: Yeah, there's a </span><span class="line" data-startTime="1973">couple of external packages </span><span class="line" data-startTime="1975">that have been written that </span><span class="line" data-startTime="1975">provide an NBD-type layer. </span><span class="line" data-startTime="1979">I can't remember them off the </span><span class="line" data-startTime="1979">top of my head, but they're </span><span class="line" data-startTime="1982">out there, and I can look them </span><span class="line" data-startTime="1982">up if you want to ask me at </span><span class="line" data-startTime="1984">Office Hours. </span></p>

<p class="speaker"><span class="line" data-starttime="1985"><span class="speakerName">Audience</span>: Thank you. </span><span class="line" data-startTime="1985">And also you seem to imply &mdash; </span><span class="line" data-startTime="1988">it's only tied to </span><span class="line" data-startTime="1988">one CPU, right? </span><span class="line" data-startTime="1989">But Go is really powerful </span><span class="line" data-startTime="1989">with multiple CPUs. </span><span class="line" data-startTime="1992">You seem to imply that in the </span><span class="line" data-startTime="1992">future that won't be the case? </span></p>

<p class="speaker"><span class="line" data-starttime="1996"><span class="speakerName">David Symonds</span>: So each of your </span><span class="line" data-startTime="1996">app instances runs CPU bound </span><span class="line" data-startTime="2000">on a single thread. </span><span class="line" data-startTime="2001">So while it's doing an RPC to </span><span class="line" data-startTime="2001">do a Datastore fetch or </span><span class="line" data-startTime="2005">whatever, it will switch </span><span class="line" data-startTime="2005">to other things. </span><span class="line" data-startTime="2008">So it's got concurrency </span><span class="line" data-startTime="2008">in that respect. </span><span class="line" data-startTime="2010">But we only have one CPU </span><span class="line" data-startTime="2010">thread running at any </span><span class="line" data-startTime="2012">one time for now. </span></p>

<p class="speaker"><span class="line" data-starttime="2014"><span class="speakerName">Audience</span>: It could change </span><span class="line" data-startTime="2014">in the future? </span></p>

<p class="speaker"><span class="line" data-starttime="2016"><span class="speakerName">David Symonds</span>: Yes, yes. </span></p>

<p class="speaker"><span class="line" data-starttime="2016"><span class="speakerName">Audience</span>: Thank you. </span><span class="line" data-startTime="2017">Thank you. </span></p>

<p class="speaker"><span class="line" data-starttime="2018"><span class="speakerName">David Symonds</span>: Yep. </span></p>

<p class="speaker"><span class="line" data-starttime="2020"><span class="speakerName">Audience</span>: Python and Java </span><span class="line" data-startTime="2020">Runtime have a unit testing </span><span class="line" data-startTime="2025">package with App Engine APIs. </span><span class="line" data-startTime="2029">Now, Go has no new test package </span><span class="line" data-startTime="2029">for App Engine APIs. </span><span class="line" data-startTime="2037">Do you have any plan to? </span></p>

<p class="speaker"><span class="line" data-starttime="2039"><span class="speakerName">David Symonds</span>: Yes, we realize </span><span class="line" data-startTime="2039">the testing story for Go on </span><span class="line" data-startTime="2042">App Engine is weak, and we have </span><span class="line" data-startTime="2042">plans to improve that in </span><span class="line" data-startTime="2045">the near future. </span></p>

<p class="speaker"><span class="line" data-starttime="2046"><span class="speakerName">Audience</span>: Thank you. </span><span class="line" data-startTime="2049">Just a question again on the </span><span class="line" data-startTime="2049">multi-threading side. </span><span class="line" data-startTime="2054">If I take an instance with two </span><span class="line" data-startTime="2054">cores, what's happening there? </span><span class="line" data-startTime="2061">One of them sits idle </span><span class="line" data-startTime="2061">all the time? </span></p>

<p class="speaker"><span class="line" data-starttime="2065"><span class="speakerName">David Symonds</span>: The instance </span><span class="line" data-startTime="2065">classes are based on </span><span class="line" data-startTime="2070">virtualized CPU gigahertz rather </span><span class="line" data-startTime="2070">than number of cores. </span><span class="line" data-startTime="2077">Sorry, I'm not sure off the top </span><span class="line" data-startTime="2077">of my head what it would </span><span class="line" data-startTime="2079">do if you were on two cores </span><span class="line" data-startTime="2079">in that instance. </span><span class="line" data-startTime="2082">It's possible that you would run </span><span class="line" data-startTime="2082">multiple instances on that </span><span class="line" data-startTime="2084">machine instead. </span></p>

<p class="speaker"><span class="line" data-starttime="2086"><span class="speakerName">Audience</span>: Thanks. </span></p>

<p class="speaker"><span class="line" data-starttime="2090"><span class="speakerName">David Symonds</span>: Any </span><span class="line" data-startTime="2090">more questions? </span><span class="line" data-startTime="2094">Yup. </span><span class="line" data-startTime="2095">OK. </span><span class="line" data-startTime="2095">Thank you very much for coming. </span></p>