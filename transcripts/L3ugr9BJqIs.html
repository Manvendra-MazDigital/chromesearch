<p><span class="line" data-startTime="0">[MUSIC PLAYING] </span></p>

<p class="speaker"><span class="line" data-starttime="16"><span class="speakerName">John McCutchan</span>: Hey, everyone. </span><span class="line" data-startTime="17">I'm John McCutchan, and welcome </span><span class="line" data-startTime="17">to the Break Point. </span><span class="line" data-startTime="19">And I'm here with Loreena Lee. </span></p>

<p class="speaker"><span class="line" data-starttime="20"><span class="speakerName">Loreena Lee</span>: Hi, I'm </span><span class="line" data-startTime="20">Loreena Lee. </span></p>

<p class="speaker"><span class="line" data-starttime="23"><span class="speakerName">John McCutchan</span>: So what </span><span class="line" data-startTime="23">do you do at Google? </span></p>

<p class="speaker"><span class="line" data-starttime="24"><span class="speakerName">Loreena Lee</span>: I actually work </span><span class="line" data-startTime="24">on Gmail, and I'm focused </span><span class="line" data-startTime="27">primarily on performance, so </span><span class="line" data-startTime="27">making it faster as well as </span><span class="line" data-startTime="31">making sure we're using the </span><span class="line" data-startTime="31">right amount of memory. </span></p>

<p class="speaker"><span class="line" data-starttime="33"><span class="speakerName">John McCutchan</span>: Nice, </span><span class="line" data-startTime="33">well that's good. </span> <span class="line" data-startTime="34">Good thing you're here, because </span><span class="line" data-startTime="34">we're here today to </span><span class="line" data-startTime="37">talk about understanding the </span><span class="line" data-startTime="37">way memory works inside </span><span class="line" data-startTime="39">JavaScript and how to profile </span><span class="line" data-startTime="39">your usage of memory inside </span><span class="line" data-startTime="43">Chrome dev tools. </span> <span class="line" data-startTime="45">So I'm going to spend a little </span><span class="line" data-startTime="45">bit of time talking about the </span><span class="line" data-startTime="49">conceptual material for how </span><span class="line" data-startTime="49">JavaScript manages memory. </span> <span class="line" data-startTime="54">And then Loreena is going to </span><span class="line" data-startTime="54">show us a really cool demo of </span><span class="line" data-startTime="57">using Chrome dev tools. </span> <span class="line" data-startTime="60">So JavaScript variables can </span><span class="line" data-startTime="60">be of four primary types &mdash; </span><span class="line" data-startTime="65">the boolean type, which just </span><span class="line" data-startTime="65">true or false canonical </span><span class="line" data-startTime="68">values, the number type, which </span><span class="line" data-startTime="68">is any double precision </span><span class="line" data-startTime="73">floating point number, the </span><span class="line" data-startTime="73">string, which is a UTF-16 </span><span class="line" data-startTime="77">encoded character array, </span><span class="line" data-startTime="77">or an object, which </span><span class="line" data-startTime="80">is a key value map. </span> <span class="line" data-startTime="81">For those of you familiar </span><span class="line" data-startTime="81">with JavaScript, this </span><span class="line" data-startTime="83">is very basic stuff. </span></p>

<p><span class="line" data-startTime="84">But we're just going to start </span><span class="line" data-startTime="84">from scratch and build up. </span> <span class="line" data-startTime="87">So objects are built around </span><span class="line" data-startTime="87">key value mapping. </span> <span class="line" data-startTime="91">So the key goes in the </span><span class="line" data-startTime="91">square brackets. </span> <span class="line" data-startTime="93">And this is always a string. </span> <span class="line" data-startTime="94">No matter what you put in </span><span class="line" data-startTime="94">it, it's going to be </span><span class="line" data-startTime="97">coerced into a string. </span> <span class="line" data-startTime="98">And then use that as the </span><span class="line" data-startTime="98">look up into the table. </span> <span class="line" data-startTime="102">And then for value, you can </span><span class="line" data-startTime="102">store any JavaScript object </span><span class="line" data-startTime="107">inside of the value. </span> <span class="line" data-startTime="110">So a key fundamental concept </span><span class="line" data-startTime="110">of memory and JavaScript is </span><span class="line" data-startTime="114">the object graph. </span> <span class="line" data-startTime="116">So we're looking at a whole </span><span class="line" data-startTime="116">bunch of circles and lines on </span><span class="line" data-startTime="120">this slide. </span> <span class="line" data-startTime="121">But let's start from the left </span><span class="line" data-startTime="121">at the blue circle. </span></p>

<p><span class="line" data-startTime="124">This is the root object inside </span><span class="line" data-startTime="124">the memory management system. </span> <span class="line" data-startTime="128">This is not something that you </span><span class="line" data-startTime="128">can explicitly manipulate or </span><span class="line" data-startTime="130">do anything with, but this is </span><span class="line" data-startTime="130">just where every object that </span><span class="line" data-startTime="133">you create descends from. </span> <span class="line" data-startTime="136">And so this is called </span><span class="line" data-startTime="136">the root. </span> <span class="line" data-startTime="137">And from the root, it references </span><span class="line" data-startTime="137">global variables </span><span class="line" data-startTime="141">and other global state that's </span><span class="line" data-startTime="141">available to the browser. </span> <span class="line" data-startTime="146">The red objects are </span><span class="line" data-startTime="146">object variables. </span> <span class="line" data-startTime="148">So these can reference </span><span class="line" data-startTime="148">other variables. </span> <span class="line" data-startTime="151">And the green circles are </span><span class="line" data-startTime="151">scalar variables, like a </span><span class="line" data-startTime="154">boolean or a number that can't </span><span class="line" data-startTime="154">reference anything else. </span> <span class="line" data-startTime="158">And you can see the green note </span><span class="line" data-startTime="158">at the end there, on the upper </span><span class="line" data-startTime="162">right part of the screen with </span><span class="line" data-startTime="162">the yellow arrow, this is the </span><span class="line" data-startTime="166">terminating node in this part </span><span class="line" data-startTime="166">of the object graph. </span></p>

<p><span class="line" data-startTime="174">So objects have a concept </span><span class="line" data-startTime="174">of a retaining tree. </span> <span class="line" data-startTime="176">And this is the paths along the </span><span class="line" data-startTime="176">graph that are keeping the </span><span class="line" data-startTime="181">object from being classified </span><span class="line" data-startTime="181">as memory. </span> <span class="line" data-startTime="183">So on the slide right now, </span><span class="line" data-startTime="183">you can see a green node. </span> <span class="line" data-startTime="186">And let's look at the </span><span class="line" data-startTime="186">retaining tree </span><span class="line" data-startTime="187">for this green node. </span> <span class="line" data-startTime="189">So the retaining tree is </span><span class="line" data-startTime="189">this yellow node here &mdash; </span><span class="line" data-startTime="193">the root node &mdash; </span><span class="line" data-startTime="195">as well as this other path from </span><span class="line" data-startTime="195">the root to the other </span><span class="line" data-startTime="199">yellow node as well. </span> <span class="line" data-startTime="200">So the object actually has two </span><span class="line" data-startTime="200">paths that are keeping it </span><span class="line" data-startTime="203">pinned into memory. </span> <span class="line" data-startTime="204">If both of these paths are </span><span class="line" data-startTime="204">terminated, then the object </span><span class="line" data-startTime="207">becomes garbage and eventually </span><span class="line" data-startTime="207">is collected. </span> <span class="line" data-startTime="213">Objects have two sizes. </span></p>

<p><span class="line" data-startTime="215">They have a shallow size, which </span><span class="line" data-startTime="215">is just the size of the </span><span class="line" data-startTime="218">actual object. </span> <span class="line" data-startTime="219">And this is usually a very </span><span class="line" data-startTime="219">small constant value. </span> <span class="line" data-startTime="222">I think on my system, an </span><span class="line" data-startTime="222">object is 36 bytes. </span> <span class="line" data-startTime="226">All of the variables that the </span><span class="line" data-startTime="226">object references are </span><span class="line" data-startTime="230">accumulated together. </span> <span class="line" data-startTime="231">The sizes of those objects are </span><span class="line" data-startTime="231">accumulated, and this is the </span><span class="line" data-startTime="234">retained size of an object. </span> <span class="line" data-startTime="235">This is the amount of memory </span><span class="line" data-startTime="235">that could be freed if this </span><span class="line" data-startTime="238">object was turned </span><span class="line" data-startTime="238">into garbage. </span></p>

<p class="speaker"><span class="line" data-starttime="242"><span class="speakerName">Loreena Lee</span>: If you go back to </span><span class="line" data-startTime="242">the previous slide, we can see </span><span class="line" data-startTime="245">the retained side of the root </span><span class="line" data-startTime="245">node would be basically the </span><span class="line" data-startTime="251">whole graph except for those </span><span class="line" data-startTime="251">two disconnected </span><span class="line" data-startTime="253">nodes in the middle. </span></p>

<p class="speaker"><span class="line" data-starttime="254"><span class="speakerName">John McCutchan</span>: Yes, </span><span class="line" data-startTime="254">which are garbage. </span> <span class="line" data-startTime="256">So from the root node, the </span><span class="line" data-startTime="256">retain sizes is the size of </span><span class="line" data-startTime="260">everything that's </span><span class="line" data-startTime="260">still reachable. </span> <span class="line" data-startTime="267">So what exactly is garbage? </span><span class="line" data-startTime="269">Well, the definition of garbage </span><span class="line" data-startTime="269">is any variable and </span><span class="line" data-startTime="272">all variables which cannot be </span><span class="line" data-startTime="272">reached from the root node. </span> <span class="line" data-startTime="276">So in this diagram here, I've </span><span class="line" data-startTime="276">highlighted the two nodes </span><span class="line" data-startTime="279">which are garbage. </span> <span class="line" data-startTime="280">The red node is referencing in </span><span class="line" data-startTime="280">the green node, but there is </span><span class="line" data-startTime="283">no path from the blue root node </span><span class="line" data-startTime="283">to that red node, making </span><span class="line" data-startTime="289">both the red and the green </span><span class="line" data-startTime="289">node into garbage. </span></p>

<p><span class="line" data-startTime="294">So garbage collection happens </span><span class="line" data-startTime="294">in two phases. </span> <span class="line" data-startTime="296">First, the graph is scanned, </span><span class="line" data-startTime="296">and all garbage is found. </span> <span class="line" data-startTime="302">So we already know the garbage </span><span class="line" data-startTime="302">in this graph was the red and </span><span class="line" data-startTime="305">the green node. </span> <span class="line" data-startTime="306">And then this memory is returned </span><span class="line" data-startTime="306">to the system during </span><span class="line" data-startTime="310">the collection phase. </span> <span class="line" data-startTime="314">So it's important when </span><span class="line" data-startTime="314">optimizing for performance and </span><span class="line" data-startTime="316">memory usage to understand </span><span class="line" data-startTime="316">the cost model </span><span class="line" data-startTime="318">for allocating memory. </span> <span class="line" data-startTime="320">So every time that your </span><span class="line" data-startTime="320">JavaScript application calls </span><span class="line" data-startTime="323">new, it reserves memory from </span><span class="line" data-startTime="323">something called the young </span><span class="line" data-startTime="326">memory pool. </span> <span class="line" data-startTime="327">So memory is split into young </span><span class="line" data-startTime="327">objects and old objects. </span> <span class="line" data-startTime="331">The v8 internally decides when </span><span class="line" data-startTime="331">to promote an object from the </span><span class="line" data-startTime="335">young memory pool to the </span><span class="line" data-startTime="335">old memory pool. </span> <span class="line" data-startTime="337">You don't have any control over </span><span class="line" data-startTime="337">that, but when you call </span><span class="line" data-startTime="339">new, you're going to be scooping </span><span class="line" data-startTime="339">up memory from the </span><span class="line" data-startTime="342">young memory pool, which </span><span class="line" data-startTime="342">is very cheap. </span></p>

<p><span class="line" data-startTime="344">It's actually incredibly fast </span><span class="line" data-startTime="344">until the on memory pool runs </span><span class="line" data-startTime="349">out of memory. </span> <span class="line" data-startTime="350">And at that point, the young </span><span class="line" data-startTime="350">memory pool is scanned, and </span><span class="line" data-startTime="353">all of the garbage is collected, </span><span class="line" data-startTime="353">freeing memory, </span><span class="line" data-startTime="355">making it possible to allocate </span><span class="line" data-startTime="355">new objects. </span> <span class="line" data-startTime="358">And this could take </span><span class="line" data-startTime="358">milliseconds. </span> <span class="line" data-startTime="360">So for interactive applications, </span><span class="line" data-startTime="360">you really want </span><span class="line" data-startTime="363">to be careful about how you </span><span class="line" data-startTime="363">allocate objects and what the </span><span class="line" data-startTime="367">patterns are, and how long you </span><span class="line" data-startTime="367">hold onto them, particularly </span><span class="line" data-startTime="371">for a game. </span></p>

<p><span class="line" data-startTime="372">You pretty much need to be able </span><span class="line" data-startTime="372">to do a frame with zero </span><span class="line" data-startTime="375">allocations, because inside </span><span class="line" data-startTime="375">of a frame, you have 16 </span><span class="line" data-startTime="378">milliseconds to compute the </span><span class="line" data-startTime="378">state of the world, render it, </span><span class="line" data-startTime="381">and take input handling, </span><span class="line" data-startTime="381">play sound. </span> <span class="line" data-startTime="384">If half of that time is taken up </span><span class="line" data-startTime="384">by garbage collection, the </span><span class="line" data-startTime="389">game's not going to </span><span class="line" data-startTime="389">be very much fun. </span> <span class="line" data-startTime="395">So in summary, all variables </span><span class="line" data-startTime="395">that you have in JavaScript </span><span class="line" data-startTime="400">are part of the object graph. </span> <span class="line" data-startTime="402">And the only inner nodes </span><span class="line" data-startTime="402">in an object graph </span><span class="line" data-startTime="406">are JavaScript objects. </span> <span class="line" data-startTime="407">They're the only type of </span><span class="line" data-startTime="407">variable that can reference </span><span class="line" data-startTime="410">other variables. </span> <span class="line" data-startTime="412">And objects have two sizes &mdash; </span><span class="line" data-startTime="413">the shallow size, which is </span><span class="line" data-startTime="413">just the size of this the </span><span class="line" data-startTime="416">object itself and then the </span><span class="line" data-startTime="416">retained size, which is the </span><span class="line" data-startTime="419">size of the object itself </span><span class="line" data-startTime="419">plus all of its </span><span class="line" data-startTime="422">descendants shallow sizes. </span> <span class="line" data-startTime="425">So all variables that cannot be </span><span class="line" data-startTime="425">reached from the root are </span><span class="line" data-startTime="428">classified as garbage. </span></p>

<p><span class="line" data-startTime="429">And when v8 decides it's an </span><span class="line" data-startTime="429">appropriate time, it will do a </span><span class="line" data-startTime="433">garbage collection phase, </span><span class="line" data-startTime="433">freeing up memory and </span><span class="line" data-startTime="436">collecting all the garbage and </span><span class="line" data-startTime="436">giving it back to the system. </span> <span class="line" data-startTime="440">So allocations are really cheap </span><span class="line" data-startTime="440">until the young memory </span><span class="line" data-startTime="442">pool runs out of memory. </span> <span class="line" data-startTime="444">At that point, a garbage </span><span class="line" data-startTime="444">collection is forced, it's not </span><span class="line" data-startTime="447">just done at an opportune </span><span class="line" data-startTime="447">time. </span> <span class="line" data-startTime="449">So you have to watch out </span><span class="line" data-startTime="449">for that in interactive </span><span class="line" data-startTime="451">applications. </span> <span class="line" data-startTime="454">So Loreena, do you want </span><span class="line" data-startTime="454">to give us your demo? </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="456"><span class="speakerName">Loreena Lee</span>: Sure, so just a </span><span class="line" data-startTime="456">little bit of basics about the </span><span class="line" data-startTime="458">Chrome dev tools. </span> <span class="line" data-startTime="459">So we'll talk about how you </span><span class="line" data-startTime="459">can use the dev tools to </span><span class="line" data-startTime="462">profile what's in your heap at </span><span class="line" data-startTime="462">any given time, and then also </span><span class="line" data-startTime="466">to find situations where you may </span><span class="line" data-startTime="466">be leaving around memory </span><span class="line" data-startTime="468">allocated that you don't </span><span class="line" data-startTime="468">need anymore. </span> <span class="line" data-startTime="472">So in general, the garbage </span><span class="line" data-startTime="472">collector should be cleaning </span><span class="line" data-startTime="475">up after you. </span> <span class="line" data-startTime="475">But there are certain </span><span class="line" data-startTime="475">situations, which we'll see in </span><span class="line" data-startTime="477">a little bit, where </span><span class="line" data-startTime="477">things may not get </span><span class="line" data-startTime="480">cleaned up as expected. </span> <span class="line" data-startTime="483">So a little bit of his </span><span class="line" data-startTime="483">background on the dev tools. </span> <span class="line" data-startTime="487">We can use these now. </span> <span class="line" data-startTime="488">There are multiple tabs, and </span><span class="line" data-startTime="488">we're going to go through this </span><span class="line" data-startTime="490">in an example. </span> <span class="line" data-startTime="491">But first, you want to if you </span><span class="line" data-startTime="491">have a suspicious action, so </span><span class="line" data-startTime="495">you see that your memory is </span><span class="line" data-startTime="495">growing, or you think that </span><span class="line" data-startTime="499">your application is slowing </span><span class="line" data-startTime="499">down for some reason or </span><span class="line" data-startTime="501">another, and you think that </span><span class="line" data-startTime="501">memory might be the situation, </span><span class="line" data-startTime="503">you can use the Timeline tab to </span><span class="line" data-startTime="503">perform the action and see </span><span class="line" data-startTime="508">what's happening to memory. </span></p>

<p><span class="line" data-startTime="509">So we can see if it's </span><span class="line" data-startTime="509">growing over time. </span> <span class="line" data-startTime="510">And if so, then we can say, </span><span class="line" data-startTime="510">OK, now we need to dig a </span><span class="line" data-startTime="513">little bit deeper and see what's </span><span class="line" data-startTime="513">happening in the heap. </span> <span class="line" data-startTime="517">So we can use that to capture </span><span class="line" data-startTime="517">a heap snapshot, which will </span><span class="line" data-startTime="519">show you all the objects that </span><span class="line" data-startTime="519">are in the graph that John </span><span class="line" data-startTime="522">just talked about. </span> <span class="line" data-startTime="524">It does not capture scalar </span><span class="line" data-startTime="524">values, which were the green </span><span class="line" data-startTime="527">nodes &mdash; green nodes? </span></p>

<p class="speaker"><span class="line" data-starttime="528"><span class="speakerName">John McCutchan</span>: Yes. </span></p>

<p class="speaker"><span class="line" data-starttime="528"><span class="speakerName">Loreena Lee</span>: Green nodes in </span><span class="line" data-startTime="528">the graph that we saw. </span> <span class="line" data-startTime="531">But it does show you </span><span class="line" data-startTime="531">all the JavaScript </span><span class="line" data-startTime="534">objects that are allocated. </span> <span class="line" data-startTime="536">There are four views </span><span class="line" data-startTime="536">of a snapshot. </span> <span class="line" data-startTime="538">And you'll see these in </span><span class="line" data-startTime="538">the demo as well. </span> <span class="line" data-startTime="539">There's the summary view, which </span><span class="line" data-startTime="539">shows you everything in </span><span class="line" data-startTime="542">the heap, and you can apply a </span><span class="line" data-startTime="542">filter on the entire graph to </span><span class="line" data-startTime="547">show only certain things. </span> <span class="line" data-startTime="549">And I'll talk about that </span><span class="line" data-startTime="549">in a little bit </span><span class="line" data-startTime="550">in the demo as well. </span> <span class="line" data-startTime="552">And then there's a comparison </span><span class="line" data-startTime="552">view, where you can view the </span><span class="line" data-startTime="554">differences between two </span><span class="line" data-startTime="554">heap snapshots. </span></p>

<p><span class="line" data-startTime="555">So you take one snapshot and </span><span class="line" data-startTime="555">then take another one and see </span><span class="line" data-startTime="558">what happens to memories. </span> <span class="line" data-startTime="559">Did more things get allocated? </span><span class="line" data-startTime="561">Did a bunch of stuff </span><span class="line" data-startTime="561">get collected? </span><span class="line" data-startTime="562">What's going on there? </span><span class="line" data-startTime="564">There's a containment view, </span><span class="line" data-startTime="564">which is a bird's eye view of </span><span class="line" data-startTime="568">the app's overall object </span><span class="line" data-startTime="568">structure. </span> <span class="line" data-startTime="570">So John mentioned a little </span><span class="line" data-startTime="570">bit about memory </span><span class="line" data-startTime="574">versus retained memory. </span> <span class="line" data-startTime="578">And so in the containment view, </span><span class="line" data-startTime="578">you can see more easily </span><span class="line" data-startTime="581">what the retained memory is. </span> <span class="line" data-startTime="583">And the DOMinator's also </span><span class="line" data-startTime="583">has a different </span><span class="line" data-startTime="585">view of the same summary. </span></p>

<p class="speaker"><span class="line" data-starttime="586"><span class="speakerName">John McCutchan</span>: Yeah, so the </span><span class="line" data-startTime="586">summary and the comparison </span><span class="line" data-startTime="588">view are sorted and organized </span><span class="line" data-startTime="588">around the objects </span><span class="line" data-startTime="591">constructor, whereas the </span><span class="line" data-startTime="591">containment view is organized </span><span class="line" data-startTime="595">starting at the root. </span><span class="line" data-startTime="596">So it captures the structure </span><span class="line" data-startTime="596">of the object graph. </span></p>

<p class="speaker"><span class="line" data-starttime="603"><span class="speakerName">Loreena Lee</span>: OK, so we're not </span><span class="line" data-startTime="603">going to cover the container </span><span class="line" data-startTime="605">and DOMinator's view too </span><span class="line" data-startTime="605">much in this demo. </span> <span class="line" data-startTime="608">But there's some really great </span><span class="line" data-startTime="608">documentation online at </span><span class="line" data-startTime="611">developers.google.com, where </span><span class="line" data-startTime="611">you can see some nice demos </span><span class="line" data-startTime="615">that show you exactly </span><span class="line" data-startTime="615">what you can see by </span><span class="line" data-startTime="617">these two other views. </span> <span class="line" data-startTime="620">So we talked about comparison </span><span class="line" data-startTime="620">view and how sometimes you can </span><span class="line" data-startTime="623">take two snapshots </span><span class="line" data-startTime="623">to find leaks. </span> <span class="line" data-startTime="624">But we're going to talk </span><span class="line" data-startTime="624">about a case where two </span><span class="line" data-startTime="626">is not quite enough. </span> <span class="line" data-startTime="630">Some other good tips to know, </span><span class="line" data-startTime="630">though, are, you should always </span><span class="line" data-startTime="633">do these experiments in </span><span class="line" data-startTime="633">an incognito window. </span> <span class="line" data-startTime="636">You want to make sure that </span><span class="line" data-startTime="636">you're in a clean room </span><span class="line" data-startTime="638">environment. </span> <span class="line" data-startTime="639">You don't have your extensions </span><span class="line" data-startTime="639">that may be interacting with </span><span class="line" data-startTime="642">your app in a way that you </span><span class="line" data-startTime="642">don't understand or </span><span class="line" data-startTime="644">you don't even know. </span></p>

<p><span class="line" data-startTime="645">So something these third party </span><span class="line" data-startTime="645">extensions do all sorts of </span><span class="line" data-startTime="647">crazy things to memory, and </span><span class="line" data-startTime="647">you want to make sure that </span><span class="line" data-startTime="649">those aren't influencing </span><span class="line" data-startTime="649">your results at all. </span></p>

<p class="speaker"><span class="line" data-starttime="651"><span class="speakerName">John McCutchan</span>: Yeah, just to </span><span class="line" data-startTime="651">repeat that, any browser </span><span class="line" data-startTime="654">extension that is loaded will be </span><span class="line" data-startTime="654">part of the heap snapshot. </span><span class="line" data-startTime="657">So you're not just looking </span><span class="line" data-startTime="657">at your code. </span><span class="line" data-startTime="659">You're also looking at any </span><span class="line" data-startTime="659">extension that happens to be </span><span class="line" data-startTime="662">loaded at the same time. </span><span class="line" data-startTime="664">So an incognito windows is a </span><span class="line" data-startTime="664">quick way to avoid loading </span><span class="line" data-startTime="666">your extensions. </span></p>

<p class="speaker"><span class="line" data-starttime="670"><span class="speakerName">Loreena Lee</span>: And then you want </span><span class="line" data-startTime="670">to get your bearings. </span> <span class="line" data-startTime="671">So on the heap profile page, </span><span class="line" data-startTime="671">you'll see that when we show </span><span class="line" data-startTime="676">the heap, there's a lot </span><span class="line" data-startTime="676">of stuff in the heap. </span> <span class="line" data-startTime="678">Basically, anything in </span><span class="line" data-startTime="678">parentheses you should just </span><span class="line" data-startTime="681">filter out of your brain </span><span class="line" data-startTime="681">for a little bit. </span> <span class="line" data-startTime="682">You can just ignore them. </span> <span class="line" data-startTime="684">A lot of the things are also </span><span class="line" data-startTime="684">going to be dimmed, and those </span><span class="line" data-startTime="686">are system allocations </span><span class="line" data-startTime="686">that we can't really </span><span class="line" data-startTime="689">control from your app. </span> <span class="line" data-startTime="689">So those also should </span><span class="line" data-startTime="689">be ignored. </span> <span class="line" data-startTime="692">And then the other thing to note </span><span class="line" data-startTime="692">is, when you click that </span><span class="line" data-startTime="694">heap snapshot button, a full </span><span class="line" data-startTime="694">garbage collection right </span><span class="line" data-startTime="698">before you click it before </span><span class="line" data-startTime="698">the heap is profiled. </span></p>

<p><span class="line" data-startTime="700">So you can assume that anything </span><span class="line" data-startTime="700">that v8 decided that </span><span class="line" data-startTime="704">it should GC should already </span><span class="line" data-startTime="704">be cleaned up. </span> <span class="line" data-startTime="707">So let's move on to the demo. </span> <span class="line" data-startTime="712">Let's see. </span> <span class="line" data-startTime="714">Where are we? </span><span class="line" data-startTime="717">So we have this quick </span><span class="line" data-startTime="717">little demo. </span> <span class="line" data-startTime="720">It really doesn't </span><span class="line" data-startTime="720">do a whole lot. </span> <span class="line" data-startTime="723">There's one button. </span> <span class="line" data-startTime="724">And when I click it, it will </span><span class="line" data-startTime="724">start filling up a cache. </span> <span class="line" data-startTime="727">So I have a cache of five items </span><span class="line" data-startTime="727">that, whenever I click </span><span class="line" data-startTime="732">it, it fills in the </span><span class="line" data-startTime="732">cache of five. </span> <span class="line" data-startTime="735">So the size is five. </span></p>

<p class="speaker"><span class="line" data-starttime="736"><span class="speakerName">John McCutchan</span>: So what happens </span><span class="line" data-startTime="736">to the entries that </span><span class="line" data-startTime="738">are already in the cache? </span></p>

<p class="speaker"><span class="line" data-starttime="740"><span class="speakerName">Loreena Lee</span>: When I first </span><span class="line" data-startTime="740">click it, there's </span><span class="line" data-startTime="741">nothing in the cache. </span><span class="line" data-startTime="742">So what we want to do is, in </span><span class="line" data-startTime="742">theory, when we flush the </span><span class="line" data-startTime="747">cache &mdash; so by filling </span><span class="line" data-startTime="747">it with new stuff &mdash; </span><span class="line" data-startTime="750">in theory, all the things that </span><span class="line" data-startTime="750">were in the cache before </span><span class="line" data-startTime="753">should be evicted. </span><span class="line" data-startTime="754">And in theory, we think that </span><span class="line" data-startTime="754">they should be collected. </span><span class="line" data-startTime="757">Let's find out what happens. </span><span class="line" data-startTime="758">So let's go ahead and refresh </span><span class="line" data-startTime="758">just so we know that we're </span><span class="line" data-startTime="762">loading everything from </span><span class="line" data-startTime="762">a clean state. </span><span class="line" data-startTime="768">Let's go back to the timeline. </span><span class="line" data-startTime="769">I mentioned this earlier. </span></p>

<p class="speaker"><span class="line" data-starttime="770"><span class="speakerName">John McCutchan</span>: Yeah, that </span><span class="line" data-startTime="770">would be great, actually. </span></p>

<p class="speaker"><span class="line" data-starttime="771"><span class="speakerName">Loreena Lee</span>: So we can </span><span class="line" data-startTime="771">go to the timeline. </span><span class="line" data-startTime="773">Let's say that we think that </span><span class="line" data-startTime="773">this is causing a memory leak. </span><span class="line" data-startTime="776">So we're going to go onto </span><span class="line" data-startTime="776">the memory here. </span><span class="line" data-startTime="778">And we're going to click Record, </span><span class="line" data-startTime="778">which is this gray </span><span class="line" data-startTime="782">circle at the bottom. </span></p>

<p class="speaker"><span class="line" data-starttime="783"><span class="speakerName">John McCutchan</span>: It </span><span class="line" data-startTime="783">will be red. </span></p>

<p class="speaker"><span class="line" data-starttime="784"><span class="speakerName">Loreena Lee</span>: And now it's red. </span> <span class="line" data-startTime="785">So we're going to go ahead and </span><span class="line" data-startTime="785">say, let's do some work. </span> <span class="line" data-startTime="788">And we'll just do it a few </span><span class="line" data-startTime="788">times, click it a few times. </span> <span class="line" data-startTime="791">And then there's this little </span><span class="line" data-startTime="791">button here that looks </span><span class="line" data-startTime="793">like a trash can. </span> <span class="line" data-startTime="794">And that will force a </span><span class="line" data-startTime="794">garbage collection. </span> <span class="line" data-startTime="796">So let's just force it and </span><span class="line" data-startTime="796">say, OK, maybe it now can </span><span class="line" data-startTime="801">clean up whatever it was </span><span class="line" data-startTime="801">that I left behind. </span> <span class="line" data-startTime="803">So hopefully, all those things </span><span class="line" data-startTime="803">that I added to the cache that </span><span class="line" data-startTime="806">had been flushed out, pushed </span><span class="line" data-startTime="806">out of the cache should be </span><span class="line" data-startTime="808">cleaned up. </span> <span class="line" data-startTime="809">And we'll go and do </span><span class="line" data-startTime="809">some more work. </span> <span class="line" data-startTime="810">So you can see that at the top, </span><span class="line" data-startTime="810">the memory is growing. </span> <span class="line" data-startTime="814">So you see in blue there </span><span class="line" data-startTime="814">that there's some new </span><span class="line" data-startTime="816">memory being allocated. </span> <span class="line" data-startTime="817">And when I click the garbage </span><span class="line" data-startTime="817">can, it seemed to have dropped </span><span class="line" data-startTime="820">a little bit but not quite </span><span class="line" data-startTime="820">to the baseline. </span></p>

<p><span class="line" data-startTime="823">So let's go ahead </span><span class="line" data-startTime="823">and stop this. </span> <span class="line" data-startTime="826">And if I go and click anywhere </span><span class="line" data-startTime="826">on the top here, I can look at </span><span class="line" data-startTime="832">a specific part of the graph. </span> <span class="line" data-startTime="833">And I can widen this window here </span><span class="line" data-startTime="833">to view whatever portion </span><span class="line" data-startTime="839">of the graph I want to see. </span> <span class="line" data-startTime="841">So down below, you see this </span><span class="line" data-startTime="841">green line that kind of looks </span><span class="line" data-startTime="843">like a stair step. </span> <span class="line" data-startTime="845">And each time I push the button, </span><span class="line" data-startTime="845">that is the number of </span><span class="line" data-startTime="848">DOM nodes that are allocated. </span> <span class="line" data-startTime="849">So you can see that </span><span class="line" data-startTime="849">it goes up. </span></p>

<p class="speaker"><span class="line" data-starttime="851"><span class="speakerName">John McCutchan</span>: So it looks like </span><span class="line" data-startTime="851">we're leaking DOM nodes. </span></p>

<p class="speaker"><span class="line" data-starttime="853"><span class="speakerName">Loreena Lee</span>: Well, it </span><span class="line" data-startTime="853">looks like we're </span><span class="line" data-startTime="854">allocating DOM nodes. </span><span class="line" data-startTime="855">We aren't necessarily </span><span class="line" data-startTime="855">leaking them yet. </span><span class="line" data-startTime="857">So we don't know. </span><span class="line" data-startTime="858">The garbage collector may </span><span class="line" data-startTime="858">not have kicked in yet. </span><span class="line" data-startTime="860">And so they wouldn't </span><span class="line" data-startTime="860">get collected. </span></p>

<p class="speaker"><span class="line" data-starttime="863"><span class="speakerName">John McCutchan</span>: Oh, </span><span class="line" data-startTime="863">that's right. </span><span class="line" data-startTime="864">We're not looking at the part </span><span class="line" data-startTime="864">of the graph after you </span><span class="line" data-startTime="866">clicked, garbage. </span></p>

<p class="speaker"><span class="line" data-starttime="867"><span class="speakerName">Loreena Lee</span>: Exactly. </span><span class="line" data-startTime="869">Let's bring it out over a little </span><span class="line" data-startTime="869">bit wider so we can see </span><span class="line" data-startTime="873">what's going on. </span><span class="line" data-startTime="874">And right around where the dip </span><span class="line" data-startTime="874">is in the blue line is when I </span><span class="line" data-startTime="877">click the garbage button. </span><span class="line" data-startTime="879">And we don't see </span><span class="line" data-startTime="879">it going down. </span><span class="line" data-startTime="881">So that is the problem. </span><span class="line" data-startTime="883">And if we widen it even more, </span><span class="line" data-startTime="883">where I clicked a little bit </span><span class="line" data-startTime="885">more, you can see there's more </span><span class="line" data-startTime="885">stair steps up when I click </span><span class="line" data-startTime="890">the button. </span><span class="line" data-startTime="891">So we're pretty sure </span><span class="line" data-startTime="891">we have a leak. </span></p>

<p class="speaker"><span class="line" data-starttime="892"><span class="speakerName">John McCutchan</span>: This looks </span><span class="line" data-startTime="892">pretty suspicious. </span></p>

<p class="speaker"><span class="line" data-starttime="894"><span class="speakerName">Loreena Lee</span>: And on the left, </span><span class="line" data-startTime="894">there's the DOM node count. </span><span class="line" data-startTime="896">So it'll tell you what the range </span><span class="line" data-startTime="896">in DOM nodes allocated </span><span class="line" data-startTime="900">for the range that you're </span><span class="line" data-startTime="900">looking at. </span><span class="line" data-startTime="902">So from here, we </span><span class="line" data-startTime="902">started at 15. </span><span class="line" data-startTime="904">And now we've got 92. </span><span class="line" data-startTime="905">So that number never </span><span class="line" data-startTime="905">went down. </span><span class="line" data-startTime="907">We see that the green line </span><span class="line" data-startTime="907">pretty much never goes down. </span><span class="line" data-startTime="912">So now we can go back </span><span class="line" data-startTime="912">to the profile page. </span><span class="line" data-startTime="916">And let's refresh again, so we </span><span class="line" data-startTime="916">can flush the cache, start </span><span class="line" data-startTime="919">with a clean slate. </span><span class="line" data-startTime="920">And now we're going to </span><span class="line" data-startTime="920">take a heap snapshot. </span><span class="line" data-startTime="923">So take a heap snapshot, </span><span class="line" data-startTime="923">and click Start. </span><span class="line" data-startTime="926">So it's super fast, </span><span class="line" data-startTime="926">because this is a </span><span class="line" data-startTime="928">pretty lightweight thing. </span><span class="line" data-startTime="929">So this is our first snapshot. </span></p>

<p class="speaker"><span class="line" data-starttime="931"><span class="speakerName">John McCutchan</span>: So I see a lot </span><span class="line" data-startTime="931">of things in parentheses right </span><span class="line" data-startTime="934">up at the top. </span></p>

<p class="speaker"><span class="line" data-starttime="935"><span class="speakerName">Loreena Lee</span>: So we're going to </span><span class="line" data-startTime="935">go ahead and ignore those. </span><span class="line" data-startTime="936">These are compiled code, system </span><span class="line" data-startTime="936">arrays, things that we </span><span class="line" data-startTime="940">really can't control. </span><span class="line" data-startTime="941">So go ahead and ignore </span><span class="line" data-startTime="941">those for now. </span><span class="line" data-startTime="943">And we'll just scroll </span><span class="line" data-startTime="943">down a little bit. </span><span class="line" data-startTime="947">And you can see that we've </span><span class="line" data-startTime="947">got all sorts of </span><span class="line" data-startTime="950">stuff in our heap. </span></p>

<p class="speaker"><span class="line" data-starttime="951"><span class="speakerName">John McCutchan</span>: So everything in </span><span class="line" data-startTime="951">this table is sorted by the </span><span class="line" data-startTime="954">constructor call. </span><span class="line" data-startTime="955">So it's not the variable name </span><span class="line" data-startTime="955">or the path that you could </span><span class="line" data-startTime="961">follow to get to the variable. </span><span class="line" data-startTime="962">It is the constructor. </span></p>

<p class="speaker"><span class="line" data-starttime="966"><span class="speakerName">Loreena Lee</span>: So at the top, </span><span class="line" data-startTime="966">it says, class filter. </span><span class="line" data-startTime="968">So if you wanted to search </span><span class="line" data-startTime="968">for a certain thing &mdash; </span><span class="line" data-startTime="969">I know that we have our caches </span><span class="line" data-startTime="969">of objects called stuff. </span><span class="line" data-startTime="973">So if I type in, stuff here &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="975"><span class="speakerName">John McCutchan</span>: Very </span><span class="line" data-startTime="975">descriptive. </span></p>

<p class="speaker"><span class="line" data-starttime="976"><span class="speakerName">Loreena Lee</span>: Well, there's </span><span class="line" data-startTime="976">nothing here, because we </span><span class="line" data-startTime="977">haven't allocated </span><span class="line" data-startTime="977">anything yet. </span> <span class="line" data-startTime="979">So that's expected. </span> <span class="line" data-startTime="981">So let's clear this out. </span> <span class="line" data-startTime="983">And let's do some more work &mdash; </span><span class="line" data-startTime="985">or do some work, we haven't </span><span class="line" data-startTime="985">done any yet. </span> <span class="line" data-startTime="987">And we're going to click and </span><span class="line" data-startTime="987">collect another snapshot. </span> <span class="line" data-startTime="992">So if we click on this snapshot </span><span class="line" data-startTime="992">now, you can see that </span><span class="line" data-startTime="994">we've got a 1.3 megabyte heap, </span><span class="line" data-startTime="994">whereas before we had a 1.2. </span> <span class="line" data-startTime="999">So now we get to those different </span><span class="line" data-startTime="999">views we talked </span><span class="line" data-startTime="1001">about earlier. </span> <span class="line" data-startTime="1003">So right at the bottom here, </span><span class="line" data-startTime="1003">it says, summary. </span> <span class="line" data-startTime="1005">And right now, we're looking at </span><span class="line" data-startTime="1005">a summary view, and we're </span><span class="line" data-startTime="1007">showing all objects </span><span class="line" data-startTime="1007">in the view. </span> <span class="line" data-startTime="1009">And so that's why we see this </span><span class="line" data-startTime="1009">long, long list of things. </span></p>

<p><span class="line" data-startTime="1014">So let's go to Comparison </span><span class="line" data-startTime="1014">View. </span> <span class="line" data-startTime="1016">Let's say we want to know, </span><span class="line" data-startTime="1016">what's the difference between </span><span class="line" data-startTime="1017">snapshot two and snapshot one </span><span class="line" data-startTime="1017">when we click that button? </span><span class="line" data-startTime="1021">And so it says we're in </span><span class="line" data-startTime="1021">Comparison View, and we're </span><span class="line" data-startTime="1023">comparing with snapshot one. </span> <span class="line" data-startTime="1025">And so these are the </span><span class="line" data-startTime="1025">differences. </span> <span class="line" data-startTime="1027">And it's a much shorter list, </span><span class="line" data-startTime="1027">because we filtered out now. </span></p>

<p class="speaker"><span class="line" data-starttime="1030"><span class="speakerName">John McCutchan</span>: We really </span><span class="line" data-startTime="1030">culled a lot of it. </span></p>

<p class="speaker"><span class="line" data-starttime="1032"><span class="speakerName">Loreena Lee</span>: So these are </span><span class="line" data-startTime="1032">now showing us only the </span><span class="line" data-startTime="1038">differences between </span><span class="line" data-startTime="1038">one and two. </span><span class="line" data-startTime="1040">So you see we have this, </span><span class="line" data-startTime="1040">stuff object. </span><span class="line" data-startTime="1042">And I told you that the cache </span><span class="line" data-startTime="1042">was a five item cache. </span><span class="line" data-startTime="1045">And so there are five items. </span><span class="line" data-startTime="1047">And way over here, you can </span><span class="line" data-startTime="1047">see, if we highlight the </span><span class="line" data-startTime="1051">stuff, the delta between </span><span class="line" data-startTime="1051">snapshot two and snapshot one </span><span class="line" data-startTime="1055">is plus five. </span><span class="line" data-startTime="1056">So there's five new objects of </span><span class="line" data-startTime="1056">stuff, which is exactly what </span><span class="line" data-startTime="1058">we expected. </span></p>

<p class="speaker"><span class="line" data-starttime="1060"><span class="speakerName">John McCutchan</span>: So this column </span><span class="line" data-startTime="1060">here is the number of objects </span><span class="line" data-startTime="1064">that were created of that type, </span><span class="line" data-startTime="1064">this is the number that </span><span class="line" data-startTime="1066">were deleted, and then this is </span><span class="line" data-startTime="1066">just the sum of the two. </span></p>

<p class="speaker"><span class="line" data-starttime="1069"><span class="speakerName">Loreena Lee</span>: Correct. </span> <span class="line" data-startTime="1072">So this is expected. </span> <span class="line" data-startTime="1073">We have a cache of size five. </span> <span class="line" data-startTime="1075">We push the button. </span> <span class="line" data-startTime="1076">We filled the cache. </span> <span class="line" data-startTime="1077">So this is what we were saying </span><span class="line" data-startTime="1077">earlier is that OK, well, </span><span class="line" data-startTime="1079">there's no leak here. </span> <span class="line" data-startTime="1080">We expected to see five. </span> <span class="line" data-startTime="1082">There's five. </span> <span class="line" data-startTime="1083">So now we need a third one. </span> <span class="line" data-startTime="1085">So let's try that again. </span> <span class="line" data-startTime="1086">Let's do some work </span><span class="line" data-startTime="1086">and go ahead and </span><span class="line" data-startTime="1089">collect a third snapshot. </span> <span class="line" data-startTime="1093">Memory is going up. </span> <span class="line" data-startTime="1094">We are at 1.4 now. </span> <span class="line" data-startTime="1096">And if we diff with the second </span><span class="line" data-startTime="1096">one again, we'll see that </span><span class="line" data-startTime="1105">there are &mdash; </span><span class="line" data-startTime="1106">oops, there we go &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="1109"><span class="speakerName">John McCutchan</span>: Another </span><span class="line" data-startTime="1109">five stuff for &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="1111"><span class="speakerName">Loreena Lee</span>: And that's fine. </span><span class="line" data-startTime="1111">We allocated five. </span><span class="line" data-startTime="1112">But we didn't delete anything. </span><span class="line" data-startTime="1114">So, hmm. </span><span class="line" data-startTime="1115">So if we look back in the </span><span class="line" data-startTime="1115">Summary View here, we'll see </span><span class="line" data-startTime="1120">that there are now 10 objects </span><span class="line" data-startTime="1120">of type stuff. </span></p>

<p class="speaker"><span class="line" data-starttime="1125"><span class="speakerName">John McCutchan</span>: And this matches </span><span class="line" data-startTime="1125">what we saw in the </span><span class="line" data-startTime="1126">timeline graph, where we were </span><span class="line" data-startTime="1126">never seeing anything go down. </span><span class="line" data-startTime="1130">It just kept going up on </span><span class="line" data-startTime="1130">a fixed size, seeing </span><span class="line" data-startTime="1133">the stair step in. </span></p>

<p class="speaker"><span class="line" data-starttime="1135"><span class="speakerName">Loreena Lee</span>: So another thing </span><span class="line" data-startTime="1135">that's great to see now is </span><span class="line" data-startTime="1138">that we can go into the </span><span class="line" data-startTime="1138">Summary View again. </span><span class="line" data-startTime="1142">And we can say, show me the </span><span class="line" data-startTime="1142">objects that were allocated </span><span class="line" data-startTime="1145">before snapshot one. </span><span class="line" data-startTime="1148">And that will show you that. </span><span class="line" data-startTime="1149">And there shouldn't be any </span><span class="line" data-startTime="1149">stuff in this, because we </span><span class="line" data-startTime="1152">hadn't filled any cache. </span><span class="line" data-startTime="1154">But now you can say, show </span><span class="line" data-startTime="1154">me the objects that were </span><span class="line" data-startTime="1157">allocated between snapshots </span><span class="line" data-startTime="1157">one and two. </span></p>

<p class="speaker"><span class="line" data-starttime="1159"><span class="speakerName">John McCutchan</span>: So we should </span><span class="line" data-startTime="1159">see five stuff. </span></p>

<p class="speaker"><span class="line" data-starttime="1161"><span class="speakerName">Loreena Lee</span>: So we should see </span><span class="line" data-startTime="1161">five things that were </span><span class="line" data-startTime="1163">allocated between snapshots </span><span class="line" data-startTime="1163">one and two. </span><span class="line" data-startTime="1165">And those things we expect have </span><span class="line" data-startTime="1165">been flushed out of the </span><span class="line" data-startTime="1167">cache by the time that we </span><span class="line" data-startTime="1167">did the third snapshot. </span><span class="line" data-startTime="1170">And so if they're still hanging </span><span class="line" data-startTime="1170">around in the heap in </span><span class="line" data-startTime="1172">snapshot three, that's probably </span><span class="line" data-startTime="1172">our problem here. </span></p>

<p class="speaker"><span class="line" data-starttime="1175"><span class="speakerName">John McCutchan</span>: One thing we </span><span class="line" data-startTime="1175">should notice here is that </span><span class="line" data-startTime="1176">when we're looking for the </span><span class="line" data-startTime="1176">summary of objects allocated </span><span class="line" data-startTime="1180">between snapshots one and two, </span><span class="line" data-startTime="1180">you can tack on the sentence </span><span class="line" data-startTime="1184">that are still alive </span><span class="line" data-startTime="1184">at snapshot three. </span><span class="line" data-startTime="1187">So from the moment in time that </span><span class="line" data-startTime="1187">snapshot three was taken, </span><span class="line" data-startTime="1192">these are objects that were </span><span class="line" data-startTime="1192">allocated between one and two </span><span class="line" data-startTime="1194">that are still alive. </span><span class="line" data-startTime="1196">So we should not see any </span><span class="line" data-startTime="1196">stuff here, if we </span><span class="line" data-startTime="1199">weren't leaking memory. </span></p>

<p class="speaker"><span class="line" data-starttime="1199"><span class="speakerName">Loreena Lee</span>: Correct, exactly. </span><span class="line" data-startTime="1202">So we are leaking memory. </span><span class="line" data-startTime="1203">And we do see that there are </span><span class="line" data-startTime="1203">five objects that were </span><span class="line" data-startTime="1206">allocated between subjects one </span><span class="line" data-startTime="1206">and two that are still alive </span><span class="line" data-startTime="1210">in snapshot three. </span><span class="line" data-startTime="1211">So if we go ahead and expand </span><span class="line" data-startTime="1211">this, you can see here that </span><span class="line" data-startTime="1215">the stuff, we can click </span><span class="line" data-startTime="1215">on one of these. </span><span class="line" data-startTime="1218">And on the bottom, you'll </span><span class="line" data-startTime="1218">see the retaining path. </span><span class="line" data-startTime="1220">And it'll tell you that it's </span><span class="line" data-startTime="1220">being retained by the object </span><span class="line" data-startTime="1222">data, which is in this </span><span class="line" data-startTime="1222">HTML div element. </span><span class="line" data-startTime="1227">And this helps you figure out </span><span class="line" data-startTime="1227">where you're going to go and </span><span class="line" data-startTime="1230">fix the problem. </span><span class="line" data-startTime="1231">So you can tell exactly where </span><span class="line" data-startTime="1231">this is retained from who's </span><span class="line" data-startTime="1234">holding on to the </span><span class="line" data-startTime="1234">handle from it. </span></p>

<p class="speaker"><span class="line" data-starttime="1236"><span class="speakerName">John McCutchan</span>: So remember the </span><span class="line" data-startTime="1236">retaining path is the path </span><span class="line" data-startTime="1238">from a garbage collector </span><span class="line" data-startTime="1238">root to the variable </span><span class="line" data-startTime="1242">that's being held. </span></p>

<p class="speaker"><span class="line" data-starttime="1245"><span class="speakerName">Loreena Lee</span>: So the other thing </span><span class="line" data-startTime="1245">to note is, here, none </span><span class="line" data-startTime="1249">of these stuffs have </span><span class="line" data-startTime="1249">a background </span><span class="line" data-startTime="1251">that is colored yellow. </span><span class="line" data-startTime="1253">And if we look at the Summary </span><span class="line" data-startTime="1253">View with everything that's in </span><span class="line" data-startTime="1259">snapshot three, we can </span><span class="line" data-startTime="1259">look at stuff. </span><span class="line" data-startTime="1262">And we should see that half of </span><span class="line" data-startTime="1262">them are yellow and half of </span><span class="line" data-startTime="1266">them are not. </span></p>

<p class="speaker"><span class="line" data-starttime="1267"><span class="speakerName">John McCutchan</span>: So why </span><span class="line" data-startTime="1267">are they yellow? </span></p>

<p class="speaker"><span class="line" data-starttime="1268"><span class="speakerName">Loreena Lee</span>: So the yellow </span><span class="line" data-startTime="1268">background indicates that </span><span class="line" data-startTime="1269">there's a JavaScript handle </span><span class="line" data-startTime="1269">on this object. </span><span class="line" data-startTime="1273">So there's a way to reach this </span><span class="line" data-startTime="1273">object through the JavaScript. </span><span class="line" data-startTime="1277">And if it's not colored yellow, </span><span class="line" data-startTime="1277">there's very likely </span><span class="line" data-startTime="1279">not to be a JavaScript handle, </span><span class="line" data-startTime="1279">which means you're going to </span><span class="line" data-startTime="1283">have a hard time </span><span class="line" data-startTime="1283">cleaning it up. </span><span class="line" data-startTime="1284">You've probably lost its </span><span class="line" data-startTime="1284">reference to it. </span><span class="line" data-startTime="1285">It's still on the DOM tree, but </span><span class="line" data-startTime="1285">you lost your JavaScript </span><span class="line" data-startTime="1289">reference to it. </span></p>

<p class="speaker"><span class="line" data-starttime="1289"><span class="speakerName">John McCutchan</span>: So you could </span><span class="line" data-startTime="1289">regain a reference to this by </span><span class="line" data-startTime="1292">walking the dog. </span></p>

<p class="speaker"><span class="line" data-starttime="1292"><span class="speakerName">Loreena Lee</span>: By walking the &mdash; </span><span class="line" data-startTime="1293">right, so it's not like it was </span><span class="line" data-startTime="1293">in the previous slides where </span><span class="line" data-startTime="1298">we showed you that they were </span><span class="line" data-startTime="1298">true garbage that had zero </span><span class="line" data-startTime="1300">path to the root </span><span class="line" data-startTime="1300">from the root. </span><span class="line" data-startTime="1303">So it does have a path from the </span><span class="line" data-startTime="1303">root, but there's no way </span><span class="line" data-startTime="1304">to access it from JavaScript. </span><span class="line" data-startTime="1306">So this is why this is a </span><span class="line" data-startTime="1306">JavaScript memory leak and not </span><span class="line" data-startTime="1309">necessarily a garbage </span><span class="line" data-startTime="1309">collectible leak. </span></p>

<p class="speaker"><span class="line" data-starttime="1312"><span class="speakerName">John McCutchan</span>: So the </span><span class="line" data-startTime="1312">yellow indicates </span><span class="line" data-startTime="1314">that there is a path. </span><span class="line" data-startTime="1315">And white indicates </span><span class="line" data-startTime="1315">that there is not. </span></p>

<p class="speaker"><span class="line" data-starttime="1318"><span class="speakerName">Loreena Lee</span>: And not </span><span class="line" data-startTime="1318">a JavaScript path. </span> <span class="line" data-startTime="1320">And if it were true garbage like </span><span class="line" data-startTime="1320">we had seen in the graphs </span><span class="line" data-startTime="1325">that John presented earlier, </span><span class="line" data-startTime="1325">it would be with a red </span><span class="line" data-startTime="1328">background. </span> <span class="line" data-startTime="1329">And those are things that </span><span class="line" data-startTime="1329">are in the [INAUDIBLE] </span><span class="line" data-startTime="1332">DOM tree. </span> <span class="line" data-startTime="1332">They cannot be reached from </span><span class="line" data-startTime="1332">the root of the DOM node. </span> <span class="line" data-startTime="1334">But they're being retained </span><span class="line" data-startTime="1334">by something. </span> <span class="line" data-startTime="1336">So a lot of times </span><span class="line" data-startTime="1336">in those cases &mdash; </span><span class="line" data-startTime="1338">and there's some good examples </span><span class="line" data-startTime="1338">of this on the dev website </span><span class="line" data-startTime="1343">that have them highlighted </span><span class="line" data-startTime="1343">in red. </span> <span class="line" data-startTime="1344">And those are things that are </span><span class="line" data-startTime="1344">being retained for some reason </span><span class="line" data-startTime="1347">or another. </span></p>

<p><span class="line" data-startTime="1349">but. </span> <span class="line" data-startTime="1349">They're not reachable from </span><span class="line" data-startTime="1349">the root of the DOM tree. </span> <span class="line" data-startTime="1351">And so in those cases, you </span><span class="line" data-startTime="1351">should be able to open the </span><span class="line" data-startTime="1353">retaining path. </span> <span class="line" data-startTime="1354">And you should see something </span><span class="line" data-startTime="1354">highlighted in yellow, which </span><span class="line" data-startTime="1356">says you have a JavaScript </span><span class="line" data-startTime="1356">reference to this thing. </span> <span class="line" data-startTime="1359">But it's not in the </span><span class="line" data-startTime="1359">DOM tree at all. </span> <span class="line" data-startTime="1360">And that should help you. </span></p>

<p class="speaker"><span class="line" data-starttime="1362"><span class="speakerName">John McCutchan</span>: So these </span><span class="line" data-startTime="1362">are detached DOM nodes. </span></p>

<p class="speaker"><span class="line" data-starttime="1363"><span class="speakerName">Loreena Lee</span>: Right. </span> <span class="line" data-startTime="1365">And there's a great example of </span><span class="line" data-startTime="1365">that online as well so that we </span><span class="line" data-startTime="1368">can go through that. </span> <span class="line" data-startTime="1369">So I think that's pretty </span><span class="line" data-startTime="1369">much the demo. </span> <span class="line" data-startTime="1371">So we can recap it. </span> <span class="line" data-startTime="1373">Let's go back to the </span><span class="line" data-startTime="1373">slides and recap. </span> <span class="line" data-startTime="1381">So we presented when Comparison </span><span class="line" data-startTime="1383">View just isn't enough. </span> <span class="line" data-startTime="1384">And we showed that not all </span><span class="line" data-startTime="1384">memory leaks result in </span><span class="line" data-startTime="1387">detached DOM tree nodes. </span> <span class="line" data-startTime="1389">There are things like </span><span class="line" data-startTime="1389">unintentional unbounded array </span><span class="line" data-startTime="1392">growths, so you add things </span><span class="line" data-startTime="1392">to an array to </span><span class="line" data-startTime="1393">be processed later. </span> <span class="line" data-startTime="1394">And you forget that you need to </span><span class="line" data-startTime="1394">clean it up at some point. </span></p>

<p><span class="line" data-startTime="1396">So either you process it and </span><span class="line" data-startTime="1396">you never dumped it. </span> <span class="line" data-startTime="1399">So these kinds of things can </span><span class="line" data-startTime="1399">be caught with this three </span><span class="line" data-startTime="1401">snapshot technique that </span><span class="line" data-startTime="1401">I just presented. </span> <span class="line" data-startTime="1405">And there's one other case. </span> <span class="line" data-startTime="1406">That's lingering event handlers </span><span class="line" data-startTime="1406">retaining DOM nodes </span><span class="line" data-startTime="1408">that are otherwise detached. </span> <span class="line" data-startTime="1409">And that can be seen in the </span><span class="line" data-startTime="1409">scenario that I just </span><span class="line" data-startTime="1413">explained, where you would have </span><span class="line" data-startTime="1413">something in red with a </span><span class="line" data-startTime="1415">retaining path that has some </span><span class="line" data-startTime="1415">yellow nodes in it. </span> <span class="line" data-startTime="1419">And so that's when you would </span><span class="line" data-startTime="1419">want to bring out your three </span><span class="line" data-startTime="1422">snapshot technique. </span></p>

<p class="speaker"><span class="line" data-starttime="1423"><span class="speakerName">John McCutchan</span>: So these are </span><span class="line" data-startTime="1423">some closure function that is </span><span class="line" data-startTime="1427">attached as an event list </span><span class="line" data-startTime="1427">node to DOM node that </span><span class="line" data-startTime="1429">is out of the DOM. </span></p>

<p class="speaker"><span class="line" data-starttime="1430"><span class="speakerName">Loreena Lee</span>: Correct. </span><span class="line" data-startTime="1431">And this is just a graphical </span><span class="line" data-startTime="1431">representation of </span><span class="line" data-startTime="1434">what we just did. </span><span class="line" data-startTime="1436">But it's much better to see </span><span class="line" data-startTime="1436">that in the dev tools </span><span class="line" data-startTime="1438">themselves. </span><span class="line" data-startTime="1440">So hopefully this was helpful. </span></p>

<p class="speaker"><span class="line" data-starttime="1442"><span class="speakerName">John McCutchan</span>: Yeah, </span><span class="line" data-startTime="1442">I think so. </span><span class="line" data-startTime="1443">I learned a lot. </span></p>

<p class="speaker"><span class="line" data-starttime="1445"><span class="speakerName">Loreena Lee</span>: Sounds good. </span></p>

<p class="speaker"><span class="line" data-starttime="1447"><span class="speakerName">John McCutchan</span>: So I think we </span><span class="line" data-startTime="1447">have a little bit of time. </span> <span class="line" data-startTime="1450">So here's a little quiz, </span><span class="line" data-startTime="1450">the tale of the </span><span class="line" data-startTime="1453">missing object key. </span> <span class="line" data-startTime="1455">So if we look at the source code </span><span class="line" data-startTime="1455">on the slides here, you </span><span class="line" data-startTime="1457">see a new object </span><span class="line" data-startTime="1457">is constructed. </span> <span class="line" data-startTime="1460">It's empty. </span> <span class="line" data-startTime="1462">A key called, double was added </span><span class="line" data-startTime="1462">and assigned to double value. </span> <span class="line" data-startTime="1466">A key called, integer was added </span><span class="line" data-startTime="1466">and assigned an integer. </span> <span class="line" data-startTime="1470">Then when you look at the </span><span class="line" data-startTime="1470">object, you can see the key </span><span class="line" data-startTime="1472">double and integer are there. </span> <span class="line" data-startTime="1474">And the two values are there. </span> <span class="line" data-startTime="1476">So if you were to then take a </span><span class="line" data-startTime="1476">heap snapshot and look at the </span><span class="line" data-startTime="1479">heap snapshot and find the </span><span class="line" data-startTime="1479">object, o, inside the </span><span class="line" data-startTime="1483">containment view, you'll notice </span><span class="line" data-startTime="1483">that the integer key is </span><span class="line" data-startTime="1487">missing from the </span><span class="line" data-startTime="1487">heap snapshot. </span> <span class="line" data-startTime="1489">That seems a little weird, </span><span class="line" data-startTime="1489">because we just confirmed that </span><span class="line" data-startTime="1492">it is inside o, and it </span><span class="line" data-startTime="1492">is in fact inside o. </span> <span class="line" data-startTime="1495">But what's going on here is that </span><span class="line" data-startTime="1495">v8 has some tricks in how </span><span class="line" data-startTime="1502">it stores integers. </span></p>

<p><span class="line" data-startTime="1504">If the number fits into a signed </span><span class="line" data-startTime="1504">31-bit integer, then </span><span class="line" data-startTime="1508">it's actually stitched into the </span><span class="line" data-startTime="1508">object graph structure and </span><span class="line" data-startTime="1511">not actually part of the object </span><span class="line" data-startTime="1511">graph, which is kind of </span><span class="line" data-startTime="1514">interesting. </span> <span class="line" data-startTime="1515">So look out for that. </span> <span class="line" data-startTime="1516">There's also cases </span><span class="line" data-startTime="1516">where a property </span><span class="line" data-startTime="1518">is backed by a getter. </span> <span class="line" data-startTime="1520">And so when you do a heap </span><span class="line" data-startTime="1520">snapshot, the heap snapshot </span><span class="line" data-startTime="1526">can't call the getter because </span><span class="line" data-startTime="1526">it might alter the program </span><span class="line" data-startTime="1528">state or might be incredibly </span><span class="line" data-startTime="1528">expensive to call the getters, </span><span class="line" data-startTime="1532">because there could be many </span><span class="line" data-startTime="1532">thousands of these objects </span><span class="line" data-startTime="1534">with these getters. </span> <span class="line" data-startTime="1535">It avoids doing that. </span> <span class="line" data-startTime="1536">So you might see when you take a </span><span class="line" data-startTime="1536">heap snapshot that some keys </span><span class="line" data-startTime="1540">are missing. </span> <span class="line" data-startTime="1541">But they're still there. </span></p>

<p class="speaker"><span class="line" data-starttime="1545"><span class="speakerName">Loreena Lee</span>: Good things </span><span class="line" data-startTime="1545">to be careful. </span></p>

<p class="speaker"><span class="line" data-starttime="1546"><span class="speakerName">John McCutchan</span>: So thanks a lot </span><span class="line" data-startTime="1546">for joining us, Loreena. </span></p>

<p class="speaker"><span class="line" data-starttime="1548"><span class="speakerName">Loreena Lee</span>: No problem. </span><span class="line" data-startTime="1548">Thank you. </span><span class="line" data-startTime="1549">Thanks for having me. </span></p>

<p class="speaker"><span class="line" data-starttime="1550"><span class="speakerName">John McCutchan</span>: Bye. </span></p>

<p class="speaker"><span class="line" data-starttime="1551"><span class="speakerName">Loreena Lee</span>: Bye, everyone. </span></p>