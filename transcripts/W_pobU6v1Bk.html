<style>* {font-family: "Open Sans", sans-serif}
a {color: #77aaff}
a.video {border-bottom: 1px solid #ddd; display: block; margin: 0 0 2em 0; padding: 0 0 2em 0}
h2 {color: #444; font-size: 18px;}
span.speakerName {color: black; font-weight: 900;}
body {padding: 2em}
p {color: #444; margin: 0; text-indent: 1.5em;}
p.speaker {margin: 1em 0 0 0; text-indent: 0;}
div#transcript > p:first-child {text-indent: 0;}
</style>

<h1>Chrome Apps: In App Payments</h1>

<h2>Pete LePage</h2>

<a class="video" href="http://youtu.be/W_pobU6v1Bk">youtu.be/W_pobU6v1Bk</a><div id="transcript"><p class="speaker"><span class="line" data-starttime="65"><span class="speakerName">Pete LePage</span>: Hey, everybody, and </span><span class="line" data-startTime="65">welcome to another Chrome </span><span class="line" data-startTime="68">Apps Office Hours. </span> <span class="line" data-startTime="69">This week, I'm going to be </span><span class="line" data-startTime="69">talking about the new in-app </span><span class="line" data-startTime="72">payment system that's available </span><span class="line" data-startTime="72">for the new Chrome </span><span class="line" data-startTime="76">packaged app platform. </span> <span class="line" data-startTime="79">If you've used Chrome apps </span><span class="line" data-startTime="79">before, you know that there </span><span class="line" data-startTime="82">was a model where you could sell </span><span class="line" data-startTime="82">an app with a one-time </span><span class="line" data-startTime="85">payment up front in the store, </span><span class="line" data-startTime="85">or you could allow the user to </span><span class="line" data-startTime="91">get the app for free. </span> <span class="line" data-startTime="93">Well, with Chrome packaged </span><span class="line" data-startTime="93">apps, now you can use the </span><span class="line" data-startTime="97">in-app payment system. </span> <span class="line" data-startTime="99">The in-app payment system uses </span><span class="line" data-startTime="99">the same similar set of APIs </span><span class="line" data-startTime="103">that are used by the Google </span><span class="line" data-startTime="103">Wallet digital service system, </span><span class="line" data-startTime="108">and it allows us to just quickly </span><span class="line" data-startTime="108">and easily charge our </span><span class="line" data-startTime="112">users for digital goods. </span> <span class="line" data-startTime="115">So let's get started and take </span><span class="line" data-startTime="115">a look at our code &mdash; </span><span class="line" data-startTime="118">or take a look at some slides. </span></p>

<p><span class="line" data-startTime="120">We can switch to the </span><span class="line" data-startTime="120">slides, perfect. </span> <span class="line" data-startTime="123">So there's effectively five </span><span class="line" data-startTime="123">steps that we need to walk </span><span class="line" data-startTime="126">through in order to </span><span class="line" data-startTime="126">use the in-app </span><span class="line" data-startTime="128">payments in a Chrome app. </span> <span class="line" data-startTime="130">So step one, obvious, </span><span class="line" data-startTime="130">pretty easy. </span> <span class="line" data-startTime="133">We need to go set up our </span><span class="line" data-startTime="133">merchant account. </span> <span class="line" data-startTime="135">You can set that up either in </span><span class="line" data-startTime="135">the production or sandbox </span><span class="line" data-startTime="138">environment. </span> <span class="line" data-startTime="139">Today I'm going to be using </span><span class="line" data-startTime="139">one in the sandbox </span><span class="line" data-startTime="142">environment. </span> <span class="line" data-startTime="144">And we'll be using the </span><span class="line" data-startTime="144">sandbox environment </span><span class="line" data-startTime="146">through this whole thing. </span></p>

<p><span class="line" data-startTime="148">The second thing we need to do </span><span class="line" data-startTime="148">is create something called a </span><span class="line" data-startTime="150">JSON web token, or a JWT, that </span><span class="line" data-startTime="150">identifies each individual </span><span class="line" data-startTime="155">item that we want to sell. </span> <span class="line" data-startTime="157">So if we want to sell a gold </span><span class="line" data-startTime="157">star or later I'm going to be </span><span class="line" data-startTime="160">selling some sad pandas, if you </span><span class="line" data-startTime="160">want to sell those, you </span><span class="line" data-startTime="163">need to have a JWT for </span><span class="line" data-startTime="163">each individual item. </span> <span class="line" data-startTime="167">Third thing we need to do is </span><span class="line" data-startTime="167">include a buy.js file in our </span><span class="line" data-startTime="170">Chrome packaged app </span><span class="line" data-startTime="170">application. </span> <span class="line" data-startTime="173">Because of content security </span><span class="line" data-startTime="173">policy rules, we can't include </span><span class="line" data-startTime="179">files from outside resources. </span> <span class="line" data-startTime="180">So we need to include that </span><span class="line" data-startTime="180">buy.js file in our Chrome </span><span class="line" data-startTime="185">packaged app. </span> <span class="line" data-startTime="187">Finally, or almost finally, we </span><span class="line" data-startTime="187">need to go and add our success </span><span class="line" data-startTime="193">and failure callbacks </span><span class="line" data-startTime="193">to our packaged app. </span> <span class="line" data-startTime="195">These are the functions that </span><span class="line" data-startTime="195">are called when the </span><span class="line" data-startTime="198">application has completed the </span><span class="line" data-startTime="198">purchase or failed to complete </span><span class="line" data-startTime="202">the purchase. </span> <span class="line" data-startTime="203">And then finally, the last and </span><span class="line" data-startTime="203">most easy step, hooking up the </span><span class="line" data-startTime="207">buy API to a button or to </span><span class="line" data-startTime="207">whatever event we want to have </span><span class="line" data-startTime="211">the user click on that. </span></p>

<p><span class="line" data-startTime="214">Let's take a look at how the </span><span class="line" data-startTime="214">flow works within the app and </span><span class="line" data-startTime="218">for a user. </span> <span class="line" data-startTime="219">So I've got my app up, and the </span><span class="line" data-startTime="219">user says, hey, I want to go </span><span class="line" data-startTime="221">buy something. </span> <span class="line" data-startTime="222">So they go and click </span><span class="line" data-startTime="222">on that buy button. </span> <span class="line" data-startTime="225">And we make an API call that </span><span class="line" data-startTime="225">goes and kicks off the in-app </span><span class="line" data-startTime="233">payment service. </span> <span class="line" data-startTime="235">That in-app payment service </span><span class="line" data-startTime="235">tosses up a dialogue that </span><span class="line" data-startTime="238">allows the user to enter their </span><span class="line" data-startTime="238">name and credit card </span><span class="line" data-startTime="243">information. </span> <span class="line" data-startTime="244">And then it sends that back up </span><span class="line" data-startTime="244">to the Google servers to go </span><span class="line" data-startTime="248">and actually bill their </span><span class="line" data-startTime="248">credit card. </span> <span class="line" data-startTime="249">So it goes and checks to see. </span> <span class="line" data-startTime="252">It'll then potentially </span><span class="line" data-startTime="252">do an HTTP post </span><span class="line" data-startTime="256">request to your service. </span> <span class="line" data-startTime="257">This is an optional thing and </span><span class="line" data-startTime="257">something that I highly </span><span class="line" data-startTime="260">recommend you do so that you </span><span class="line" data-startTime="260">can use later to verify </span><span class="line" data-startTime="264">whether the purchase was made </span><span class="line" data-startTime="264">successfully or not. </span></p>

<p><span class="line" data-startTime="268">As long as the Google service </span><span class="line" data-startTime="268">gets back a 200 OK from your </span><span class="line" data-startTime="273">servers, it then does a callback </span><span class="line" data-startTime="273">into your application </span><span class="line" data-startTime="278">saying, hey, all right, great. </span> <span class="line" data-startTime="280">The user's purchased that app or </span><span class="line" data-startTime="280">purchase that digital good, </span><span class="line" data-startTime="285">whatever it happens to </span><span class="line" data-startTime="285">be, a sad panda. </span> <span class="line" data-startTime="289">And you get the call back. </span> <span class="line" data-startTime="292">Now like I said, optionally, </span><span class="line" data-startTime="292">you can have your server </span><span class="line" data-startTime="294">register and say, </span><span class="line" data-startTime="294">hey, yup, OK, I </span><span class="line" data-startTime="296">acknowledge this purchase. </span> <span class="line" data-startTime="298">You can also do a validation </span><span class="line" data-startTime="298">from the app to your server to </span><span class="line" data-startTime="303">say, hey, did this user actually </span><span class="line" data-startTime="303">make this purchase, </span><span class="line" data-startTime="307">so that you can have sort of a </span><span class="line" data-startTime="307">second line of verification, </span><span class="line" data-startTime="310">making sure that it did </span><span class="line" data-startTime="310">actually happen. </span> <span class="line" data-startTime="315">So the API to call to actually </span><span class="line" data-startTime="315">make the purchase is a </span><span class="line" data-startTime="319">relatively simple API. </span></p>

<p><span class="line" data-startTime="321">It's google.payments.inapp.buy. </span> <span class="line" data-startTime="325">And we provide a JSON object. </span> <span class="line" data-startTime="328">And in that JSON object, </span><span class="line" data-startTime="328">we need to </span><span class="line" data-startTime="329">specify a couple of things. </span> <span class="line" data-startTime="331">Parameters is one. </span> <span class="line" data-startTime="333">Today &mdash; </span><span class="line" data-startTime="334">or if you don't specify the </span><span class="line" data-startTime="334">parameters as env sandbox or </span><span class="line" data-startTime="341">env prod, it's going to use </span><span class="line" data-startTime="341">the sandbox by default. </span> <span class="line" data-startTime="346">So if you want to make sure </span><span class="line" data-startTime="346">that you're using the </span><span class="line" data-startTime="347">production environment, you need </span><span class="line" data-startTime="347">to make sure that you set </span><span class="line" data-startTime="349">the env parameter to prod. </span> <span class="line" data-startTime="354">The JWT, which is a rather long </span><span class="line" data-startTime="354">file, we'll see what one </span><span class="line" data-startTime="358">of those looks like in a sec, </span><span class="line" data-startTime="358">that specifies the item. </span> <span class="line" data-startTime="362">And then the two callbacks </span><span class="line" data-startTime="362">that get called after the </span><span class="line" data-startTime="366">purchase has finished. </span> <span class="line" data-startTime="369">So when we start to think about </span><span class="line" data-startTime="369">that JWT, well, what's a </span><span class="line" data-startTime="372">JWT stand for? </span><span class="line" data-startTime="373">JWT stands for Java Web Token. </span> <span class="line" data-startTime="377">But it's signed and encoded, so </span><span class="line" data-startTime="377">that when it's sent to the </span><span class="line" data-startTime="382">server, we can verify </span><span class="line" data-startTime="382">that yes, this is </span><span class="line" data-startTime="384">actually what it is. </span></p>

<p><span class="line" data-startTime="384">And the user can't go and change </span><span class="line" data-startTime="384">the price on whatever </span><span class="line" data-startTime="387">they're going to buy. </span> <span class="line" data-startTime="388">So in its raw form, before we've </span><span class="line" data-startTime="388">signed in and coded it, </span><span class="line" data-startTime="391">you can see a couple important </span><span class="line" data-startTime="391">things here. </span> <span class="line" data-startTime="394">We have that issue line here </span><span class="line" data-startTime="394">that you see specifies the </span><span class="line" data-startTime="403">seller name. </span> <span class="line" data-startTime="404">And that's the seller ID that </span><span class="line" data-startTime="404">we get back when we sign up </span><span class="line" data-startTime="408">for our Google Wallet merchant </span><span class="line" data-startTime="408">account for the first time. </span> <span class="line" data-startTime="412">We can then specify the price, </span><span class="line" data-startTime="412">whatever we want to give it </span><span class="line" data-startTime="417">for a name. </span> <span class="line" data-startTime="419">We have to set a creation time </span><span class="line" data-startTime="419">and an expiry time for this </span><span class="line" data-startTime="424">particular object. </span></p>

<p><span class="line" data-startTime="425">And that's what the exp and iat </span><span class="line" data-startTime="425">are for. iat for issued </span><span class="line" data-startTime="431">at, and exp, expired at. </span> <span class="line" data-startTime="433">those are a number of seconds </span><span class="line" data-startTime="433">after the epoch, so if you're </span><span class="line" data-startTime="439">familiar with that. </span> <span class="line" data-startTime="440">And then finally, that </span><span class="line" data-startTime="440">type just defines </span><span class="line" data-startTime="442">the particular type. </span> <span class="line" data-startTime="444">There are two types of JWTs </span><span class="line" data-startTime="444">that we can use to sell </span><span class="line" data-startTime="448">product within our apps. </span> <span class="line" data-startTime="450">One is just a single, one-time </span><span class="line" data-startTime="450">item, just like you see here. </span> <span class="line" data-startTime="453">But the other one is a </span><span class="line" data-startTime="453">subscription service. </span> <span class="line" data-startTime="457">And with a subscription service, </span><span class="line" data-startTime="457">you can bill the user </span><span class="line" data-startTime="460">on a regular basis. </span> <span class="line" data-startTime="462">They can be billed every month, </span><span class="line" data-startTime="462">and you charge them </span><span class="line" data-startTime="466">$0.99 every month, or maybe it's </span><span class="line" data-startTime="466">$1.99, or whatever you </span><span class="line" data-startTime="469">want to charge on a monthly, </span><span class="line" data-startTime="469">regular recurring schedule. </span> <span class="line" data-startTime="474">So there's a bunch of libraries </span><span class="line" data-startTime="474">that are available </span><span class="line" data-startTime="477">to take this JSON and </span><span class="line" data-startTime="477">package it on down. </span></p>

<p><span class="line" data-startTime="482">Once you've gone and packaged it </span><span class="line" data-startTime="482">all down, you've signed it </span><span class="line" data-startTime="485">with your key, this is </span><span class="line" data-startTime="485">what it looks like. </span> <span class="line" data-startTime="487">It's a really long, </span><span class="line" data-startTime="487">ugly string. </span> <span class="line" data-startTime="490">And there's a link there at the </span><span class="line" data-startTime="490">bottom that you can see. </span> <span class="line" data-startTime="493">And all of these links will be </span><span class="line" data-startTime="493">available in the sample that </span><span class="line" data-startTime="496">I've got, as well. </span> <span class="line" data-startTime="498">But that link there links to a </span><span class="line" data-startTime="498">Python JWT library to allow </span><span class="line" data-startTime="506">you to create and sign these. </span> <span class="line" data-startTime="508">And the sample that we've </span><span class="line" data-startTime="508">got going shows you how </span><span class="line" data-startTime="510">to do that as well. </span> <span class="line" data-startTime="512">So let's do it. </span> <span class="line" data-startTime="513">Let's give it a try. </span> <span class="line" data-startTime="517">The sample that I'm about to </span><span class="line" data-startTime="517">show you is a Chrome packaged </span><span class="line" data-startTime="520">app that's available in </span><span class="line" data-startTime="520">the GitHub repository. </span> <span class="line" data-startTime="524">So if you go to that URL, </span><span class="line" data-startTime="524">you can go grab it. </span></p>

<p><span class="line" data-startTime="527">And there's two components </span><span class="line" data-startTime="527">to it. </span> <span class="line" data-startTime="528">So let's just pop out of here, </span><span class="line" data-startTime="528">and let me bring up &mdash; </span></p></div>