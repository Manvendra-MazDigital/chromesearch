<p><span class="line" data-startTime="0">[MUSIC PLAYING] </span></p>

<p class="speaker"><span class="line" data-starttime="79"><span class="speakerName">Shawn</span>: Hi, my name is Shawn. </span> <span class="line" data-startTime="82">Today I'd like to talk about </span><span class="line" data-startTime="82">how WebCore, Blink, and </span><span class="line" data-startTime="85">WebKit, how we do compositing </span><span class="line" data-startTime="85">in WebKit. </span> <span class="line" data-startTime="89">So the way Chromium works, </span><span class="line" data-startTime="89">we actually have several </span><span class="line" data-startTime="93">different pieces that </span><span class="line" data-startTime="93">fit together. </span> <span class="line" data-startTime="95">Blink is basically our </span><span class="line" data-startTime="95">rendering engine. </span> <span class="line" data-startTime="100">We forked from WebKit </span><span class="line" data-startTime="100">recently. </span> <span class="line" data-startTime="102">And what happens is, Blink as </span><span class="line" data-startTime="102">a rendering engine uses a </span><span class="line" data-startTime="107">compositor. </span> <span class="line" data-startTime="107">The compositor is implemented </span><span class="line" data-startTime="107">in Chromium. </span></p>

<p><span class="line" data-startTime="110">What I'd like to talk about </span><span class="line" data-startTime="110">today is how Blink actually </span><span class="line" data-startTime="113">chooses what gets composited. </span> <span class="line" data-startTime="115">What does compositing </span><span class="line" data-startTime="115">really mean? </span><span class="line" data-startTime="117">And these sorts of </span><span class="line" data-startTime="117">basic concepts. </span> <span class="line" data-startTime="119">And I will also get into bits </span><span class="line" data-startTime="119">of implementation detail and </span><span class="line" data-startTime="123">code pads for those who are </span><span class="line" data-startTime="123">interested at the end. </span> <span class="line" data-startTime="126">So yeah, let's get started. </span> <span class="line" data-startTime="127">And maybe you can go </span><span class="line" data-startTime="127">to the slides now. </span> <span class="line" data-startTime="132">OK so what you're seeing here is </span><span class="line" data-startTime="132">imagine maybe this is some </span><span class="line" data-startTime="139">sort of HTML page. </span> <span class="line" data-startTime="141">These boxes could be considered </span><span class="line" data-startTime="141">as divs, and the </span><span class="line" data-startTime="145">question here is as we see this </span><span class="line" data-startTime="145">animation happening on </span><span class="line" data-startTime="148">the yellow div, what actually </span><span class="line" data-startTime="148">needs to be </span><span class="line" data-startTime="152">rerendered or repainted? </span><span class="line" data-startTime="155">If we assume the traditional </span><span class="line" data-startTime="155">rendering model where we have </span><span class="line" data-startTime="159">software just going pixel by </span><span class="line" data-startTime="159">pixel and figuring out what </span><span class="line" data-startTime="163">the color of each pixel is, and </span><span class="line" data-startTime="163">we only have one set of </span><span class="line" data-startTime="166">pixels to represent the final </span><span class="line" data-startTime="166">output image, the answer would </span><span class="line" data-startTime="169">be portions of all </span><span class="line" data-startTime="169">four layers. </span></p>

<p><span class="line" data-startTime="172">Now, yeah, if we're smart enough </span><span class="line" data-startTime="172">in WebKit or in Blink, </span><span class="line" data-startTime="177">we could say, yes, there's </span><span class="line" data-startTime="177">actually only a portion of the </span><span class="line" data-startTime="182">actual full size image that </span><span class="line" data-startTime="182">needs to be rerendered. </span> <span class="line" data-startTime="187">So I'll look again. </span> <span class="line" data-startTime="189">Yeah, only this portion needs </span><span class="line" data-startTime="189">to be rerendered. </span> <span class="line" data-startTime="192">But still all four layers really </span><span class="line" data-startTime="192">do need to be repainted </span><span class="line" data-startTime="197">in order to get that </span><span class="line" data-startTime="197">scene correct. </span> <span class="line" data-startTime="199">So what that means is, and by </span><span class="line" data-startTime="199">the way, the fourth layer here </span><span class="line" data-startTime="201">is the gray background. </span></p>

<p><span class="line" data-startTime="204">So what that really means is as </span><span class="line" data-startTime="204">this yellow div, say as it </span><span class="line" data-startTime="208">spins around, for example, it </span><span class="line" data-startTime="208">will actually expose parts of </span><span class="line" data-startTime="212">the gray element </span><span class="line" data-startTime="212">underneath it. </span> <span class="line" data-startTime="214">And that gray really does need </span><span class="line" data-startTime="214">to be repainted just as much </span><span class="line" data-startTime="218">as the yellow layer actually </span><span class="line" data-startTime="218">needs to be repainted as well. </span> <span class="line" data-startTime="221">The same would be true for the </span><span class="line" data-startTime="221">blue layer underneath the </span><span class="line" data-startTime="224">yellow one and even, possibly, </span><span class="line" data-startTime="224">unless we're very clever, </span><span class="line" data-startTime="228">which we're actually not in </span><span class="line" data-startTime="228">Blink we would also actually </span><span class="line" data-startTime="232">have to repaint portions of this </span><span class="line" data-startTime="232">red layer on top of the </span><span class="line" data-startTime="235">yellow layer. </span> <span class="line" data-startTime="238">One thing to point out is that </span><span class="line" data-startTime="238">computing these pixels, the </span><span class="line" data-startTime="241">value, the color </span><span class="line" data-startTime="241">of these pixels </span><span class="line" data-startTime="243">actually gets pretty expensive. </span> <span class="line" data-startTime="247">It's surprisingly complicated. </span> <span class="line" data-startTime="248">Not only do we have things like </span><span class="line" data-startTime="248">background colors, we </span><span class="line" data-startTime="251">also have borders. </span> <span class="line" data-startTime="252">The borders could be curved. </span> <span class="line" data-startTime="253">We need anti-aliasing </span><span class="line" data-startTime="253">for the borders. </span> <span class="line" data-startTime="256">Then we need to support things </span><span class="line" data-startTime="256">like blending for </span><span class="line" data-startTime="258">transparency. </span></p>

<p><span class="line" data-startTime="259">Text rendering, anti-alias text </span><span class="line" data-startTime="259">rendering, is a whole </span><span class="line" data-startTime="263">other beast. </span> <span class="line" data-startTime="264">All of these things add up and </span><span class="line" data-startTime="264">it becomes quite expensive to </span><span class="line" data-startTime="267">figure out what the color of </span><span class="line" data-startTime="267">each pixel is to actually </span><span class="line" data-startTime="270">render a page. </span> <span class="line" data-startTime="273">Another example here is imagine </span><span class="line" data-startTime="273">if we have a web page </span><span class="line" data-startTime="277">that we want to scroll. </span> <span class="line" data-startTime="279">I wasn't able to get this to </span><span class="line" data-startTime="279">animate or interact on the </span><span class="line" data-startTime="282">presentation, but if you just </span><span class="line" data-startTime="282">imagine this blue layer here </span><span class="line" data-startTime="287">scrolling up and down. </span> <span class="line" data-startTime="289">What that really means is that </span><span class="line" data-startTime="289">we actually have to repaint, </span><span class="line" data-startTime="292">rerender every pixel, </span><span class="line" data-startTime="292">almost every pixel </span><span class="line" data-startTime="295">on this entire view. </span> <span class="line" data-startTime="298">And, again, that's </span><span class="line" data-startTime="298">very expensive. </span> <span class="line" data-startTime="303">Now, you might be asking, well </span><span class="line" data-startTime="303">couldn't we just recognize </span><span class="line" data-startTime="307">that this layer is shifting and </span><span class="line" data-startTime="307">instead of rerendering and </span><span class="line" data-startTime="311">recomputing every pixel </span><span class="line" data-startTime="311">maybe we can just </span><span class="line" data-startTime="316">shift that pixel up. </span> <span class="line" data-startTime="318">And that is a very </span><span class="line" data-startTime="318">good observation. </span></p>

<p><span class="line" data-startTime="320">In fact, that's exactly what we </span><span class="line" data-startTime="320">would use compositing for. </span> <span class="line" data-startTime="325">And, in particular, what we </span><span class="line" data-startTime="325">would need is not just one </span><span class="line" data-startTime="329">backing store, not just one </span><span class="line" data-startTime="329">buffer of pixels, but we </span><span class="line" data-startTime="333">actually need multiple buffers </span><span class="line" data-startTime="333">of pixels so that we could </span><span class="line" data-startTime="336">store this blue layer </span><span class="line" data-startTime="336">in a separate layer, </span><span class="line" data-startTime="339">in a separate buffer. </span> <span class="line" data-startTime="342">And then when we need to, we can </span><span class="line" data-startTime="342">just copy it over to the </span><span class="line" data-startTime="346">final output image in </span><span class="line" data-startTime="346">a shifted position. </span> <span class="line" data-startTime="351">So that's basically what </span><span class="line" data-startTime="351">compositing is. </span> <span class="line" data-startTime="354">It's the use of multiple backing </span><span class="line" data-startTime="354">stores to cache and </span><span class="line" data-startTime="357">group chunks of the </span><span class="line" data-startTime="357">render tree. </span> <span class="line" data-startTime="361">So how does this help us? </span><span class="line" data-startTime="364">Well, like I just said, </span><span class="line" data-startTime="364">it can help us to </span><span class="line" data-startTime="366">avoid unnecessary repaints. </span></p>

<p><span class="line" data-startTime="369">We don't have to figure out what </span><span class="line" data-startTime="369">the color of every pixel </span><span class="line" data-startTime="372">is every time we need </span><span class="line" data-startTime="372">to change something. </span> <span class="line" data-startTime="375">Instead, we can just cache </span><span class="line" data-startTime="375">that and redraw it. </span> <span class="line" data-startTime="379">It's a little bit of a </span><span class="line" data-startTime="379">terminology thing. </span> <span class="line" data-startTime="381">Repainting, in our case, would </span><span class="line" data-startTime="381">mean that we really have to </span><span class="line" data-startTime="384">rerender every pixel and figure </span><span class="line" data-startTime="384">out what color it is. </span> <span class="line" data-startTime="387">Redrawing would be when we </span><span class="line" data-startTime="387">already know the color of the </span><span class="line" data-startTime="390">pixel and we just need to </span><span class="line" data-startTime="390">display it to the screen. </span> <span class="line" data-startTime="395">So, again, repainting would </span><span class="line" data-startTime="395">be considered very costly. </span></p>

<p><span class="line" data-startTime="398">Redrawing is very cheap. </span> <span class="line" data-startTime="403">So, for example, in this </span><span class="line" data-startTime="403">animation that you had seen </span><span class="line" data-startTime="405">already, if we had a layer for </span><span class="line" data-startTime="405">the yellow that was a separate </span><span class="line" data-startTime="409">backing store. </span> <span class="line" data-startTime="410">If we had a separate backing </span><span class="line" data-startTime="410">store for the red layer. </span> <span class="line" data-startTime="413">These two layers, both, so </span><span class="line" data-startTime="413">that we could put the red </span><span class="line" data-startTime="416">layer on top of yellow, and </span><span class="line" data-startTime="416">the yellow on top of </span><span class="line" data-startTime="418">everything else, then we would </span><span class="line" data-startTime="418">actually not need to repaint </span><span class="line" data-startTime="422">anything as that example </span><span class="line" data-startTime="422">animates. </span> <span class="line" data-startTime="426">So other benefits of </span><span class="line" data-startTime="426">compositing, it also makes </span><span class="line" data-startTime="430">some things practical </span><span class="line" data-startTime="430">that otherwise just </span><span class="line" data-startTime="432">wouldn't really work. </span> <span class="line" data-startTime="433">Especially if we use hardware </span><span class="line" data-startTime="433">accelerated compositing. </span></p>

<p><span class="line" data-startTime="438">In particular, things like </span><span class="line" data-startTime="438">WebGL or hardware video </span><span class="line" data-startTime="441">decoding they are just </span><span class="line" data-startTime="441">best done on the GPU. </span> <span class="line" data-startTime="445">And having to read back from the </span><span class="line" data-startTime="445">GPU to be able to render a </span><span class="line" data-startTime="450">final output image can get </span><span class="line" data-startTime="450">pretty costly and performance </span><span class="line" data-startTime="453">would just go out the window. </span> <span class="line" data-startTime="454">So being able to composite what </span><span class="line" data-startTime="454">we render on WebGL or </span><span class="line" data-startTime="458">what we decode from hardware </span><span class="line" data-startTime="458">video at the same time as </span><span class="line" data-startTime="462">compositing both on the GPU, </span><span class="line" data-startTime="462">it's a great enabler to make </span><span class="line" data-startTime="467">things like WebGL and hardware </span><span class="line" data-startTime="467">video decoding possible. </span> <span class="line" data-startTime="473">So what really needs to be </span><span class="line" data-startTime="473">done when we talk about </span><span class="line" data-startTime="477">compositing? </span><span class="line" data-startTime="478">It's really just three </span><span class="line" data-startTime="478">basic tasks. </span></p>

<p><span class="line" data-startTime="481">Three straightforward tasks. </span> <span class="line" data-startTime="482">One, we need to figure out what </span><span class="line" data-startTime="482">we would like to put in a </span><span class="line" data-startTime="486">separate backing store. </span> <span class="line" data-startTime="487">And I tend to call these </span><span class="line" data-startTime="487">composited layers as opposed </span><span class="line" data-startTime="491">to what WebCore rendering </span><span class="line" data-startTime="491">layers. </span> <span class="line" data-startTime="495">We also need to figure out what </span><span class="line" data-startTime="495">the contents of those </span><span class="line" data-startTime="498">layers will be, render </span><span class="line" data-startTime="498">the pixels. </span> <span class="line" data-startTime="500">And that's what we're </span><span class="line" data-startTime="500">calling painting. </span> <span class="line" data-startTime="503">And we also need to finally draw </span><span class="line" data-startTime="503">the composited layers in </span><span class="line" data-startTime="509">order to render the </span><span class="line" data-startTime="509">final webpage. </span> <span class="line" data-startTime="511">So step three is what the </span><span class="line" data-startTime="511">compositor's job is. </span> <span class="line" data-startTime="517">And we actually won't be </span><span class="line" data-startTime="517">focusing on how the compositor </span><span class="line" data-startTime="520">actually works in Chromium, but </span><span class="line" data-startTime="520">for this talk what I would </span><span class="line" data-startTime="524">like to talk about is just a </span><span class="line" data-startTime="524">small little micro slice of </span><span class="line" data-startTime="527">things where we actually </span><span class="line" data-startTime="527">figure out what gets </span><span class="line" data-startTime="530">composited and why. </span></p>

<p><span class="line" data-startTime="532">And in order to explain things </span><span class="line" data-startTime="532">clearly I will also have to </span><span class="line" data-startTime="536">talk a little bit about how </span><span class="line" data-startTime="536">things are painted. </span> <span class="line" data-startTime="540">So in case you're interested in </span><span class="line" data-startTime="540">the bigger picture and how </span><span class="line" data-startTime="544">things fit together, there's </span><span class="line" data-startTime="544">several other talks and links. </span> <span class="line" data-startTime="548">These slides will be available </span><span class="line" data-startTime="548">on dev.Chromium.org under the </span><span class="line" data-startTime="552">Tech Talks Slides link. </span> <span class="line" data-startTime="554">And these talks and these docs </span><span class="line" data-startTime="554">are also available there. </span> <span class="line" data-startTime="559">So Eric Seidel gave to talk a </span><span class="line" data-startTime="559">while ago about WebCore's guts </span><span class="line" data-startTime="565">and how rendering works, even </span><span class="line" data-startTime="565">the software world with </span><span class="line" data-startTime="568">respect to things like taking </span><span class="line" data-startTime="568">the HTML that you provide and </span><span class="line" data-startTime="573">converting it from a DOM tree </span><span class="line" data-startTime="573">to a rendering tree. </span> <span class="line" data-startTime="576">That's what Eric's </span><span class="line" data-startTime="576">talk is about. </span> <span class="line" data-startTime="578">Brett Wilson also gave a talk </span><span class="line" data-startTime="578">on some other details of how </span><span class="line" data-startTime="582">painting works. </span></p>

<p><span class="line" data-startTime="583">In particular, the API is used </span><span class="line" data-startTime="583">to actually do painting. </span> <span class="line" data-startTime="589">Chromium's compositor has </span><span class="line" data-startTime="589">quite a few docs. </span> <span class="line" data-startTime="592">This link is one that I think </span><span class="line" data-startTime="592">is the overall one. </span> <span class="line" data-startTime="597">Also available on </span><span class="line" data-startTime="597">dev.chromium.org. </span> <span class="line" data-startTime="600">And what I would do in this talk </span><span class="line" data-startTime="600">is bridge the gap between </span><span class="line" data-startTime="605">once we have a tree of render </span><span class="line" data-startTime="605">layers that we can actually </span><span class="line" data-startTime="610">render to the screen, how we </span><span class="line" data-startTime="610">go from there to a tree of </span><span class="line" data-startTime="614">composited layers that the </span><span class="line" data-startTime="614">compositor knows how to draw. </span> <span class="line" data-startTime="618">And it actually is pretty </span><span class="line" data-startTime="618">insightful for web developers </span><span class="line" data-startTime="621">to have this in mind. </span> <span class="line" data-startTime="624">Maybe it's not necessarily </span><span class="line" data-startTime="624">appropriate to develop your </span><span class="line" data-startTime="627">web to tailor to compositing, </span><span class="line" data-startTime="627">but it is very appropriate to </span><span class="line" data-startTime="632">be aware of these issues when </span><span class="line" data-startTime="632">you think about how you want </span><span class="line" data-startTime="635">to design your page. </span></p>

<p><span class="line" data-startTime="638">So in order to describe why we </span><span class="line" data-startTime="638">would choose things to become </span><span class="line" data-startTime="642">composited and how we do that, </span><span class="line" data-startTime="642">let's really, really quickly </span><span class="line" data-startTime="646">cover some CSS details. </span> <span class="line" data-startTime="651">So you might already know </span><span class="line" data-startTime="651">about positioning. </span> <span class="line" data-startTime="655">Elements can be either in what's </span><span class="line" data-startTime="655">called normal flow </span><span class="line" data-startTime="658">where layout really does </span><span class="line" data-startTime="658">position them automatically, </span><span class="line" data-startTime="662">and elements interact with each </span><span class="line" data-startTime="662">other when they're all in </span><span class="line" data-startTime="665">normal flow. </span> <span class="line" data-startTime="667">Relative position you can </span><span class="line" data-startTime="667">specify on elements. </span> <span class="line" data-startTime="670">It keeps your elements in a </span><span class="line" data-startTime="670">normal flow, but it allows you </span><span class="line" data-startTime="673">to position the element with </span><span class="line" data-startTime="673">respect to where it would've </span><span class="line" data-startTime="677">been in normal flow. </span></p>

<p><span class="line" data-startTime="680">Absolute positioned elements and </span><span class="line" data-startTime="680">fixed position elements, </span><span class="line" data-startTime="682">on the other hand, actually are </span><span class="line" data-startTime="682">taken out of normal flow. </span> <span class="line" data-startTime="685">So when this layout is computed </span><span class="line" data-startTime="685">for normal flow </span><span class="line" data-startTime="689">elements, absolute position </span><span class="line" data-startTime="689">elements and fixed position </span><span class="line" data-startTime="692">elements actually do not affect </span><span class="line" data-startTime="694">that part of the layout. </span> <span class="line" data-startTime="696">And this allows you to actually </span><span class="line" data-startTime="696">position with a bit </span><span class="line" data-startTime="698">more control your elements. </span> <span class="line" data-startTime="701">So absolute positioned elements </span><span class="line" data-startTime="701">would be positioned </span><span class="line" data-startTime="705">with respect to a containing </span><span class="line" data-startTime="705">block. </span> <span class="line" data-startTime="707">Fixed positioned elements would </span><span class="line" data-startTime="707">typically be positioned </span><span class="line" data-startTime="710">with respect to a viewport. </span> <span class="line" data-startTime="715">So from there CSS also has </span><span class="line" data-startTime="715">this concept of a Z-index </span><span class="line" data-startTime="720">which allows you to control the </span><span class="line" data-startTime="720">ordering of how elements </span><span class="line" data-startTime="723">are layered on top </span><span class="line" data-startTime="723">of each other. </span> <span class="line" data-startTime="726">And this is the beginnings of </span><span class="line" data-startTime="726">where compositing becomes </span><span class="line" data-startTime="731">interesting. </span> <span class="line" data-startTime="732">Because in order to render </span><span class="line" data-startTime="732">things that are stacked on top </span><span class="line" data-startTime="736">of each other, and they may be </span><span class="line" data-startTime="736">dynamically changing, they may </span><span class="line" data-startTime="738">have animations. </span></p>

<p><span class="line" data-startTime="740">The Z-index is what causes </span><span class="line" data-startTime="740">that, typically. </span> <span class="line" data-startTime="743">And so the compositor really </span><span class="line" data-startTime="743">relies on Z-index </span><span class="line" data-startTime="748">a lot of the time. </span> <span class="line" data-startTime="752">Yes, so one important thing to </span><span class="line" data-startTime="752">note is that if we have a </span><span class="line" data-startTime="757">positioned element that also has </span><span class="line" data-startTime="757">a Z-index according to the </span><span class="line" data-startTime="761">CSS spec, that would be defined </span><span class="line" data-startTime="761">as a stacking context. </span> <span class="line" data-startTime="772">So what is the stacking </span><span class="line" data-startTime="772">context? </span><span class="line" data-startTime="774">A stacking context, it's a very </span><span class="line" data-startTime="774">nice concept, actually. </span></p>

<p><span class="line" data-startTime="777">And I think it actually gets </span><span class="line" data-startTime="777">overlooked quite a lot from a </span><span class="line" data-startTime="780">web developer's perspective. </span> <span class="line" data-startTime="781">A stacking context is a way to </span><span class="line" data-startTime="781">flatten a group of layers into </span><span class="line" data-startTime="788">a single conceptual layer from </span><span class="line" data-startTime="788">outside of the subtree. </span> <span class="line" data-startTime="793">So here is an example where I </span><span class="line" data-startTime="793">have four different stacking </span><span class="line" data-startTime="797">contexts in this example. </span> <span class="line" data-startTime="798">The fourth, the smaller stacking </span><span class="line" data-startTime="798">context over here, is </span><span class="line" data-startTime="802">actually a stacking </span><span class="line" data-startTime="802">context within the </span><span class="line" data-startTime="805">green stacking context. </span></p>

<p><span class="line" data-startTime="808">There's no way to </span><span class="line" data-startTime="808">indicate that. </span> <span class="line" data-startTime="809">I'm just telling you that that's </span><span class="line" data-startTime="809">what I had intended </span><span class="line" data-startTime="811">when making this figure. </span> <span class="line" data-startTime="814">And you'll see that, OK, so a </span><span class="line" data-startTime="814">negative Z-index renders below </span><span class="line" data-startTime="817">a 0 is Z-index value, which </span><span class="line" data-startTime="817">renders below a </span><span class="line" data-startTime="821">Z-index value of 1. </span> <span class="line" data-startTime="823">And you note that even though I </span><span class="line" data-startTime="823">have large Z-indexes here in </span><span class="line" data-startTime="827">the blue and also in yellow </span><span class="line" data-startTime="827">layers here, these are </span><span class="line" data-startTime="831">actually inside of a stacking </span><span class="line" data-startTime="831">context which means that they </span><span class="line" data-startTime="834">are flattened to their stacking </span><span class="line" data-startTime="834">context before they </span><span class="line" data-startTime="837">are rendered with respect </span><span class="line" data-startTime="837">to everything </span><span class="line" data-startTime="840">else in the DOM tree. </span> <span class="line" data-startTime="844">So, for example, if we made </span><span class="line" data-startTime="844">the Z-index 2 on this blue </span><span class="line" data-startTime="847">stacking context, it suddenly </span><span class="line" data-startTime="847">is designated as the one on </span><span class="line" data-startTime="851">top of everything else, and </span><span class="line" data-startTime="851">that's what you would see. </span> <span class="line" data-startTime="853">So the previous example the </span><span class="line" data-startTime="853">Z-index was 0 making it 2 </span><span class="line" data-startTime="858">would actually render </span><span class="line" data-startTime="858">everything on top. </span></p>

<p><span class="line" data-startTime="862">So the way to interpret stacking </span><span class="line" data-startTime="862">contexts is they're </span><span class="line" data-startTime="867">really flattening the </span><span class="line" data-startTime="867">element's subtree. </span> <span class="line" data-startTime="868">So it forms a nice isolation </span><span class="line" data-startTime="868">between what's in the subtree </span><span class="line" data-startTime="873">of a stacking context and what's </span><span class="line" data-startTime="873">outside of the subtree. </span> <span class="line" data-startTime="876">Inside of the subtree of this </span><span class="line" data-startTime="876">stacking context, all layers </span><span class="line" data-startTime="881">think that they have their own </span><span class="line" data-startTime="881">isolated universe without </span><span class="line" data-startTime="883">knowing about anything else. </span> <span class="line" data-startTime="885">Outside of the stacking context, </span><span class="line" data-startTime="885">that stacking context </span><span class="line" data-startTime="889">is then just treated like a </span><span class="line" data-startTime="889">normal conceptual layer. </span> <span class="line" data-startTime="894">Atomic, that's the key word. </span> <span class="line" data-startTime="895">An atomic conceptual layer. </span> <span class="line" data-startTime="899">So at the end of the day, what </span><span class="line" data-startTime="899">CSS Spec found that is that </span><span class="line" data-startTime="902">this is a very nice place to </span><span class="line" data-startTime="902">define the order of how we're </span><span class="line" data-startTime="908">supposed to paint things when </span><span class="line" data-startTime="908">you give us a web page. </span></p>

<p><span class="line" data-startTime="911">And, yes, actually CSS spec </span><span class="line" data-startTime="911">does specify paint order. </span> <span class="line" data-startTime="916">It's a little bit complicated, </span><span class="line" data-startTime="916">you can see the full details </span><span class="line" data-startTime="919">in section 9.9 in Appendix </span><span class="line" data-startTime="919">E of the spec. </span> <span class="line" data-startTime="922">You can just find </span><span class="line" data-startTime="922">it on Google. </span> <span class="line" data-startTime="924">But the basic idea is that first </span><span class="line" data-startTime="924">we paint backgrounds and </span><span class="line" data-startTime="930">borders for a given element. </span> <span class="line" data-startTime="932">And then we paint the negative </span><span class="line" data-startTime="932">Z-index children. </span> <span class="line" data-startTime="936">Then, whatever contents of the </span><span class="line" data-startTime="936">layers itself or any other </span><span class="line" data-startTime="939">normal flow elements that are </span><span class="line" data-startTime="939">part of this layers subtree </span><span class="line" data-startTime="943">get painted. </span> <span class="line" data-startTime="945">After that we do absolute </span><span class="line" data-startTime="945">position and </span><span class="line" data-startTime="948">positive Z-index children. </span> <span class="line" data-startTime="951">So what this means is that we're </span><span class="line" data-startTime="951">actually creating a tree </span><span class="line" data-startTime="956">that is not quite corresponding </span><span class="line" data-startTime="956">to the DOM tree. </span></p>

<p><span class="line" data-startTime="958">There's cases where you can </span><span class="line" data-startTime="958">have an element in the DOM </span><span class="line" data-startTime="962">tree that may appear first in </span><span class="line" data-startTime="962">the list of children, but if </span><span class="line" data-startTime="968">you put the [? Craig ?] </span><span class="line" data-startTime="969">Z-index on it, it may have </span><span class="line" data-startTime="969">to paint last on top of </span><span class="line" data-startTime="971">everything else. </span> <span class="line" data-startTime="974">Another thing would be that </span><span class="line" data-startTime="974">depending on how the tree is </span><span class="line" data-startTime="978">structured, you may even get, </span><span class="line" data-startTime="978">what you had as parent-child </span><span class="line" data-startTime="981">pairs in the DOM, might be more </span><span class="line" data-startTime="981">appropriate as siblings </span><span class="line" data-startTime="986">when we talk about the order </span><span class="line" data-startTime="986">in which they paint. </span> <span class="line" data-startTime="990">And that's how things are </span><span class="line" data-startTime="990">implemented in Blink. </span></p>

<p><span class="line" data-startTime="994">Where we actually take render </span><span class="line" data-startTime="994">layers as the data structure </span><span class="line" data-startTime="999">and instead of using the tree of </span><span class="line" data-startTime="999">render layers that coarsely </span><span class="line" data-startTime="1006">approximates the DOM, instead </span><span class="line" data-startTime="1006">we actually collect layers </span><span class="line" data-startTime="1011">into a different tree. </span> <span class="line" data-startTime="1013">And I'll call that the paint </span><span class="line" data-startTime="1013">order entry in this case. </span> <span class="line" data-startTime="1017">But otherwise, it implements </span><span class="line" data-startTime="1017">equivalently the same paint </span><span class="line" data-startTime="1022">order as the CSS spec. </span> <span class="line" data-startTime="1027">So given that, how do we choose </span><span class="line" data-startTime="1027">to composite layers? </span><span class="line" data-startTime="1031">Which layers do we choose </span><span class="line" data-startTime="1031">to be composited? </span><span class="line" data-startTime="1035">Well we would choose composited </span><span class="line" data-startTime="1035">layers based on </span><span class="line" data-startTime="1037">when it benefits us or when </span><span class="line" data-startTime="1037">we really need to. </span> <span class="line" data-startTime="1039">So cases where it benefits us </span><span class="line" data-startTime="1039">is if we have transparency. </span> <span class="line" data-startTime="1044">Maybe we have a transform that </span><span class="line" data-startTime="1044">is just easier to apply by </span><span class="line" data-startTime="1047">feeding transform matrix </span><span class="line" data-startTime="1047">to the GPU. </span> <span class="line" data-startTime="1051">There may be some filters </span><span class="line" data-startTime="1051">like blur. </span> <span class="line" data-startTime="1054">Reflections where it's nice to </span><span class="line" data-startTime="1054">be able to just have that </span><span class="line" data-startTime="1059">chunk of layers or that subtree </span><span class="line" data-startTime="1059">of layers cached </span><span class="line" data-startTime="1061">before we actually reflect it. </span> <span class="line" data-startTime="1064">It's a good opportunity to make </span><span class="line" data-startTime="1064">it a composited layer so </span><span class="line" data-startTime="1066">that all we have to do instead </span><span class="line" data-startTime="1066">of rerendering it twice is </span><span class="line" data-startTime="1070">just redraw this same </span><span class="line" data-startTime="1070">pixels reflected. </span></p>

<p><span class="line" data-startTime="1074">Scrolling is another example </span><span class="line" data-startTime="1074">where instead of having to </span><span class="line" data-startTime="1079">repaint we can just put </span><span class="line" data-startTime="1079">everything into a layer and </span><span class="line" data-startTime="1082">shift the layer and give the </span><span class="line" data-startTime="1084">wonderful allusion of scrolling. </span> <span class="line" data-startTime="1086">Fixed-position elements that </span><span class="line" data-startTime="1086">need to stay fixed even though </span><span class="line" data-startTime="1089">things underneath it may change </span><span class="line" data-startTime="1089">is another example </span><span class="line" data-startTime="1092">where if we just composite this </span><span class="line" data-startTime="1092">fixed-position element we </span><span class="line" data-startTime="1097">don't have to redraw it </span><span class="line" data-startTime="1097">every time things </span><span class="line" data-startTime="1099">underneath it changed. </span> <span class="line" data-startTime="1102">And then, of course, as I said </span><span class="line" data-startTime="1102">before things, like WebGL or </span><span class="line" data-startTime="1105">hardware video coding are also </span><span class="line" data-startTime="1105">nice to make composited layers </span><span class="line" data-startTime="1111">just so that we can take </span><span class="line" data-startTime="1111">advantage of not having to </span><span class="line" data-startTime="1113">read them back into </span><span class="line" data-startTime="1113">software before we </span><span class="line" data-startTime="1115">actually render them. </span> <span class="line" data-startTime="1119">There's also a necessary evil of </span><span class="line" data-startTime="1119">having to deal with when we </span><span class="line" data-startTime="1126">really need to composite. </span> <span class="line" data-startTime="1129">Now part of this is, I have to </span><span class="line" data-startTime="1129">admit, how WebCore and Blink </span><span class="line" data-startTime="1134">are actually implemented. </span></p>

<p><span class="line" data-startTime="1135">How the compositing is </span><span class="line" data-startTime="1135">actually implemented? </span><span class="line" data-startTime="1139">But for the foreseeable future </span><span class="line" data-startTime="1139">this is going to be the way </span><span class="line" data-startTime="1141">things are. </span> <span class="line" data-startTime="1142">And these are realities </span><span class="line" data-startTime="1142">we have to live with. </span> <span class="line" data-startTime="1145">If there's a layer that overlaps </span><span class="line" data-startTime="1145">another composited </span><span class="line" data-startTime="1148">layer, and I'll show an example </span><span class="line" data-startTime="1148">of this in a second, </span><span class="line" data-startTime="1152">then we actually have to make </span><span class="line" data-startTime="1152">that composited as well. </span> <span class="line" data-startTime="1157">Another issue is that if there's </span><span class="line" data-startTime="1157">some sort of CSS </span><span class="line" data-startTime="1160">property that needs to be </span><span class="line" data-startTime="1160">propagated down to composited </span><span class="line" data-startTime="1164">layers, for example, opacity, </span><span class="line" data-startTime="1164">or maybe some transform is </span><span class="line" data-startTime="1168">inherited by an ancestor. </span> <span class="line" data-startTime="1170">Those are cases where the </span><span class="line" data-startTime="1170">parent that has that </span><span class="line" data-startTime="1174">information needs to be </span><span class="line" data-startTime="1174">composited just for the sake </span><span class="line" data-startTime="1177">of having that information in </span><span class="line" data-startTime="1177">the composited tree as well as </span><span class="line" data-startTime="1181">in the render tree. </span> <span class="line" data-startTime="1182">So that all the composited </span><span class="line" data-startTime="1182">layers actually get the </span><span class="line" data-startTime="1184">information that they need. </span> <span class="line" data-startTime="1187">So here's an example </span><span class="line" data-startTime="1187">of overlap. </span></p>

<p><span class="line" data-startTime="1190">Imagine we have one backing </span><span class="line" data-startTime="1190">store in our webpage. </span> <span class="line" data-startTime="1196">If that's all we had. </span> <span class="line" data-startTime="1197">And this backing store I'm just </span><span class="line" data-startTime="1197">representing that by a </span><span class="line" data-startTime="1200">red rectangle here. </span> <span class="line" data-startTime="1202">If that's all we had, then we </span><span class="line" data-startTime="1202">would repaint all of these </span><span class="line" data-startTime="1205">pixels in one backing </span><span class="line" data-startTime="1205">store and be </span><span class="line" data-startTime="1207">done with it, no problem. </span> <span class="line" data-startTime="1209">But suppose we thought we would </span><span class="line" data-startTime="1209">benefit for some reason </span><span class="line" data-startTime="1213">from making this blue layer a </span><span class="line" data-startTime="1213">separately composited layer. </span> <span class="line" data-startTime="1217">So what we would have is backing </span><span class="line" data-startTime="1217">store one would draw </span><span class="line" data-startTime="1220">underneath backing store two. </span></p>

<p><span class="line" data-startTime="1222">Or, actually, it might be more </span><span class="line" data-startTime="1222">appropriate to say backing </span><span class="line" data-startTime="1225">store two, depending on how we </span><span class="line" data-startTime="1225">talk about things, would </span><span class="line" data-startTime="1229">actually redraw itself into </span><span class="line" data-startTime="1229">backing store one. </span> <span class="line" data-startTime="1236">If we do that the green element </span><span class="line" data-startTime="1236">that we had intended </span><span class="line" data-startTime="1239">to be on top would not be on </span><span class="line" data-startTime="1239">top because we're painting </span><span class="line" data-startTime="1243">this into backing store one. </span> <span class="line" data-startTime="1245">This is the case where overlap </span><span class="line" data-startTime="1245">requires us to create another </span><span class="line" data-startTime="1250">composited layer so that the </span><span class="line" data-startTime="1250">green element can actually </span><span class="line" data-startTime="1255">draw on top of what we thought </span><span class="line" data-startTime="1255">we would like composite, which </span><span class="line" data-startTime="1258">was the blue layer. </span> <span class="line" data-startTime="1261">So it's interesting that </span><span class="line" data-startTime="1261">this comes up. </span> <span class="line" data-startTime="1263">In the real world this can </span><span class="line" data-startTime="1263">cause an explosion of the </span><span class="line" data-startTime="1269">number of composited layers, </span><span class="line" data-startTime="1269">which can drain GP resources </span><span class="line" data-startTime="1274">quite badly. </span> <span class="line" data-startTime="1275">So this is something </span><span class="line" data-startTime="1275">to be aware of. </span> <span class="line" data-startTime="1278">In general, personally, I </span><span class="line" data-startTime="1278">haven't found any explosion of </span><span class="line" data-startTime="1280">layer counts too badly </span><span class="line" data-startTime="1280">in the real world. </span></p>

<p><span class="line" data-startTime="1283">But it's something </span><span class="line" data-startTime="1283">to be aware of. </span> <span class="line" data-startTime="1286">If you're making a very </span><span class="line" data-startTime="1286">complicated web app that </span><span class="line" data-startTime="1289">things that overlap something </span><span class="line" data-startTime="1289">that might get composited will </span><span class="line" data-startTime="1293">probably also have to </span><span class="line" data-startTime="1293">get composited. </span> <span class="line" data-startTime="1298">So there are some other cases </span><span class="line" data-startTime="1298">where overlap becomes </span><span class="line" data-startTime="1303">interesting. </span> <span class="line" data-startTime="1304">Animations, in particular, is an </span><span class="line" data-startTime="1304">interesting one where it's </span><span class="line" data-startTime="1308">actually not really practical </span><span class="line" data-startTime="1308">to predict what will overlap </span><span class="line" data-startTime="1314">an animated layer at </span><span class="line" data-startTime="1314">any given time. </span> <span class="line" data-startTime="1316">So instead we just assume that </span><span class="line" data-startTime="1316">everything on top is going to </span><span class="line" data-startTime="1321">overlap, even if it doesn't. </span> <span class="line" data-startTime="1322">And I'll actually show </span><span class="line" data-startTime="1322">an example of </span><span class="line" data-startTime="1324">that in just a second. </span> <span class="line" data-startTime="1327">So that's another interesting </span><span class="line" data-startTime="1327">thing to be aware of is that </span><span class="line" data-startTime="1329">when you have animations you </span><span class="line" data-startTime="1329">might actually see lots of </span><span class="line" data-startTime="1332">layers suddenly pop up, </span><span class="line" data-startTime="1332">composited layers, pop up on </span><span class="line" data-startTime="1335">your page simply because </span><span class="line" data-startTime="1335">the animation </span><span class="line" data-startTime="1338">is underneath things. </span></p>

<p><span class="line" data-startTime="1339">And by bringing animation on top </span><span class="line" data-startTime="1339">you might be able to avoid </span><span class="line" data-startTime="1343">unnecessarily causing </span><span class="line" data-startTime="1343">things to be </span><span class="line" data-startTime="1346">composited in your webpage. </span> <span class="line" data-startTime="1352">This third point is also very </span><span class="line" data-startTime="1352">interesting to note. </span> <span class="line" data-startTime="1356">This is where stacking contexts </span><span class="line" data-startTime="1357">actually become very useful. </span> <span class="line" data-startTime="1359">Because if you have children </span><span class="line" data-startTime="1359">that are inside of a second </span><span class="line" data-startTime="1363">context, you know that they </span><span class="line" data-startTime="1363">are treated as atomic with </span><span class="line" data-startTime="1367">respect to everything else </span><span class="line" data-startTime="1367">outside of that subtree. </span> <span class="line" data-startTime="1371">And what that allows you to </span><span class="line" data-startTime="1371">do then, is if you made a </span><span class="line" data-startTime="1374">stacking context out of the </span><span class="line" data-startTime="1374">subtree of your DOM, you can </span><span class="line" data-startTime="1378">feel a little bit more </span><span class="line" data-startTime="1378">comfortable that you won't </span><span class="line" data-startTime="1380">have an explosion of composited </span><span class="line" data-startTime="1380">layers inside of </span><span class="line" data-startTime="1384">that subtree. </span> <span class="line" data-startTime="1384">Instead, the compositor will </span><span class="line" data-startTime="1384">recognize, OK, this is </span><span class="line" data-startTime="1387">stacking context. </span></p>

<p><span class="line" data-startTime="1388">I can make one composited </span><span class="line" data-startTime="1388">layer for this </span><span class="line" data-startTime="1391">entire stacking context. </span> <span class="line" data-startTime="1393">And I don't need to check if </span><span class="line" data-startTime="1393">everything else overlaps </span><span class="line" data-startTime="1396">inside of the subtree if it </span><span class="line" data-startTime="1396">overlaps other content. </span> <span class="line" data-startTime="1403">So basically what we do then </span><span class="line" data-startTime="1403">in Blink is we iterate over </span><span class="line" data-startTime="1407">this paint order tree, </span><span class="line" data-startTime="1407">recursively. </span> <span class="line" data-startTime="1409">And we ask, does this layer </span><span class="line" data-startTime="1409">need compositing? </span><span class="line" data-startTime="1412">Would we benefit from it? </span><span class="line" data-startTime="1414">And then we also ask, now that </span><span class="line" data-startTime="1414">we've chosen composited layers </span><span class="line" data-startTime="1419">for the subtree, once we </span><span class="line" data-startTime="1419">bubble back up from the </span><span class="line" data-startTime="1422">recursion we have to ask, well, </span><span class="line" data-startTime="1422">is there some reason </span><span class="line" data-startTime="1424">that maybe we ought to composite </span><span class="line" data-startTime="1424">this parent as well? </span><span class="line" data-startTime="1430">For example, overlap. </span> <span class="line" data-startTime="1431">Or if something in the subtree </span><span class="line" data-startTime="1431">became composited that needs </span><span class="line" data-startTime="1434">some properties like transform </span><span class="line" data-startTime="1434">or opacity. </span> <span class="line" data-startTime="1438">And at the end, once we've </span><span class="line" data-startTime="1438">decided if something change </span><span class="line" data-startTime="1441">its state whether a subtree </span><span class="line" data-startTime="1441">needs to be composited or not </span><span class="line" data-startTime="1445">composited we also have </span><span class="line" data-startTime="1445">to issue that </span><span class="line" data-startTime="1447">it needs to be repainted. </span> <span class="line" data-startTime="1450">OK, let's go to some demos. </span></p>

<p><span class="line" data-startTime="1451">See some examples of this </span><span class="line" data-startTime="1451">stuff in action. </span> <span class="line" data-startTime="1454">If you'd like to try this on </span><span class="line" data-startTime="1454">your own, there's probably </span><span class="line" data-startTime="1458">four essential &mdash; </span><span class="line" data-startTime="1460">or maybe these first three are </span><span class="line" data-startTime="1460">the most essential command </span><span class="line" data-startTime="1465">line flags that you'd </span><span class="line" data-startTime="1465">like to use. </span> <span class="line" data-startTime="1468">First, force-compositing mode. </span> <span class="line" data-startTime="1470">Just in case. </span> <span class="line" data-startTime="1471">For example, if you're on </span><span class="line" data-startTime="1471">Linux or if you're in a </span><span class="line" data-startTime="1474">situation where it seems like </span><span class="line" data-startTime="1474">you might be running software </span><span class="line" data-startTime="1478">mode instead, force-compositing </span><span class="line" data-startTime="1478">mode will </span><span class="line" data-startTime="1480">ensure that you're actually </span><span class="line" data-startTime="1480">using accelerated compositing </span><span class="line" data-startTime="1484">on all your pages, even if they </span><span class="line" data-startTime="1484">didn't really require it. </span></p>

<p><span class="line" data-startTime="1487">So just in case you actually </span><span class="line" data-startTime="1487">don't see what you expect, try </span><span class="line" data-startTime="1492">force-compositing mode. </span> <span class="line" data-startTime="1493">Show composited layer </span><span class="line" data-startTime="1493">borders is probably </span><span class="line" data-startTime="1496">the most useful one. </span> <span class="line" data-startTime="1497">This allows you to visualize </span><span class="line" data-startTime="1497">orange and some other color </span><span class="line" data-startTime="1501">borders around layers that </span><span class="line" data-startTime="1501">become composited. </span> <span class="line" data-startTime="1504">And it's very insightful. </span> <span class="line" data-startTime="1507">Show paint rects is also </span><span class="line" data-startTime="1507">very valuable. </span> <span class="line" data-startTime="1509">What this shows is regions of </span><span class="line" data-startTime="1509">the page and regions of </span><span class="line" data-startTime="1513">various layers that actually </span><span class="line" data-startTime="1513">needed to be repainted. </span> <span class="line" data-startTime="1517">That implies that we had to do </span><span class="line" data-startTime="1517">very expensive paint process </span><span class="line" data-startTime="1521">to figure out the pixels </span><span class="line" data-startTime="1521">of that region. </span> <span class="line" data-startTime="1525">And generally what you would </span><span class="line" data-startTime="1525">like to do to get really </span><span class="line" data-startTime="1527">performant web apps is minimize </span><span class="line" data-startTime="1527">the amount of paint </span><span class="line" data-startTime="1530">rects that you see if you </span><span class="line" data-startTime="1530">were to visualize this. </span></p>

<p><span class="line" data-startTime="1534">Another one that we have, it's </span><span class="line" data-startTime="1534">not really as useful, but it </span><span class="line" data-startTime="1537">is still there, is show </span><span class="line" data-startTime="1537">property change recs. </span> <span class="line" data-startTime="1540">What you'll see here is these </span><span class="line" data-startTime="1540">will be layers that, for </span><span class="line" data-startTime="1544">example, have an animation </span><span class="line" data-startTime="1544">where, yes, they did not need </span><span class="line" data-startTime="1547">repainting, but they had some </span><span class="line" data-startTime="1547">property that changed on them </span><span class="line" data-startTime="1550">that does require them </span><span class="line" data-startTime="1550">to be redrawn. </span> <span class="line" data-startTime="1552">If you see these sorts of recs </span><span class="line" data-startTime="1552">then chances are you're in a </span><span class="line" data-startTime="1557">good state because you didn't </span><span class="line" data-startTime="1557">need to repaint. </span></p>

<p><span class="line" data-startTime="1559">But rather, you can just </span><span class="line" data-startTime="1559">quickly redraw them. </span> <span class="line" data-startTime="1562">So, for example, in animation </span><span class="line" data-startTime="1562">you might actually see that. </span> <span class="line" data-startTime="1565">So yeah let's run some demos </span><span class="line" data-startTime="1565">and see how this looks. </span> <span class="line" data-startTime="1570">So I have a script of my </span><span class="line" data-startTime="1570">own called runtest. </span> <span class="line" data-startTime="1574">This is basically just my way </span><span class="line" data-startTime="1574">of running Chrome from the </span><span class="line" data-startTime="1577">command line. </span> <span class="line" data-startTime="1578">I have a command line [? rx ?] </span><span class="line" data-startTime="1578">show composite layer borders. </span> <span class="line" data-startTime="1583">Let's see, we can go to Poster </span><span class="line" data-startTime="1583">Circle is it as one of the </span><span class="line" data-startTime="1587">standard examples for </span><span class="line" data-startTime="1587">looking at 3D CSS. </span> <span class="line" data-startTime="1592">And what you see here </span><span class="line" data-startTime="1592">is orange borders. </span> <span class="line" data-startTime="1595">This is the composited layer </span><span class="line" data-startTime="1595">borders flag showing you that </span><span class="line" data-startTime="1598">all of these layers here that </span><span class="line" data-startTime="1598">are being animated in 3D, </span><span class="line" data-startTime="1602">they're getting composited so </span><span class="line" data-startTime="1602">that the GPU can do 3D stuff </span><span class="line" data-startTime="1606">much faster and much </span><span class="line" data-startTime="1606">more easily. </span></p>

<p><span class="line" data-startTime="1609">It also happens, it looks like </span><span class="line" data-startTime="1609">we have a scroll bar here on </span><span class="line" data-startTime="1611">the right even though, </span><span class="line" data-startTime="1611">OK, there it is. </span> <span class="line" data-startTime="1615">Yeah, so we have a scroll </span><span class="line" data-startTime="1615">bar here on the right. </span> <span class="line" data-startTime="1617">This gets separately </span><span class="line" data-startTime="1617">composited as </span><span class="line" data-startTime="1619">well for various reasons. </span> <span class="line" data-startTime="1623">For example, when we scroll it's </span><span class="line" data-startTime="1623">easier to have the scroll </span><span class="line" data-startTime="1627">bar as a separate layer. </span> <span class="line" data-startTime="1629">So that we don't have to change </span><span class="line" data-startTime="1629">any contents of this </span><span class="line" data-startTime="1632">huge root layer, so to speak, </span><span class="line" data-startTime="1632">underneath it, as we shift </span><span class="line" data-startTime="1637">that layer up and down. </span> <span class="line" data-startTime="1639">So another interesting </span><span class="line" data-startTime="1639">thing we can do </span><span class="line" data-startTime="1641">is, let's go to Inspector. </span></p>

<p><span class="line" data-startTime="1647">And what I'd like to do is, </span><span class="line" data-startTime="1647">you can see that basically </span><span class="line" data-startTime="1654">this text here, they're </span><span class="line" data-startTime="1654">really just </span><span class="line" data-startTime="1656">simple paragraph elements. </span> <span class="line" data-startTime="1658">There's nothing special </span><span class="line" data-startTime="1658">about them. </span> <span class="line" data-startTime="1661">And there's this animation going </span><span class="line" data-startTime="1661">on that is completely </span><span class="line" data-startTime="1664">unrelated to these paragraphs. </span> <span class="line" data-startTime="1667">However, if I create some layer </span><span class="line" data-startTime="1667">here with a Z-index </span><span class="line" data-startTime="1671">that's positive. </span> <span class="line" data-startTime="1683">And I also need to actually </span><span class="line" data-startTime="1683">make it a stacking context </span><span class="line" data-startTime="1687">just so that the render tree </span><span class="line" data-startTime="1687">recognizes it as a separate </span><span class="line" data-startTime="1690">render layer. </span> <span class="line" data-startTime="1691">So I'll just make a </span><span class="line" data-startTime="1691">position relative. </span> <span class="line" data-startTime="1693">So I'm not actually changing </span><span class="line" data-startTime="1693">its position. </span> <span class="line" data-startTime="1695">But what you see now is suddenly </span><span class="line" data-startTime="1695">this paragraph </span><span class="line" data-startTime="1699">becomes composited. </span> <span class="line" data-startTime="1701">Why is that? </span><span class="line" data-startTime="1702">Well the answer is that because </span><span class="line" data-startTime="1702">of this animation we </span><span class="line" data-startTime="1706">weren't able to assume where </span><span class="line" data-startTime="1706">this text is with respect to </span><span class="line" data-startTime="1711">the animation. </span> <span class="line" data-startTime="1712">And so we have to </span><span class="line" data-startTime="1712">assume that it </span><span class="line" data-startTime="1715">might overlap the animation. </span></p>

<p><span class="line" data-startTime="1717">And therefore we create a </span><span class="line" data-startTime="1717">composited layer out of it. </span> <span class="line" data-startTime="1720">Now, in this case, we would </span><span class="line" data-startTime="1720">judge that this layer is </span><span class="line" data-startTime="1723">really unnecessary. </span> <span class="line" data-startTime="1725">And the way we could avoid that </span><span class="line" data-startTime="1725">is change the Z-index so </span><span class="line" data-startTime="1730">that it's actually underneath </span><span class="line" data-startTime="1730">this animation. </span> <span class="line" data-startTime="1733">So here what I have a Z-index </span><span class="line" data-startTime="1733">of one on that paragraph, it </span><span class="line" data-startTime="1738">actually is stacked on </span><span class="line" data-startTime="1738">top of the animation. </span> <span class="line" data-startTime="1742">And we have to assume </span><span class="line" data-startTime="1742">that it overlaps. </span> <span class="line" data-startTime="1744">So we make it a composited </span><span class="line" data-startTime="1744">layer. </span> <span class="line" data-startTime="1747">If I made a Z-index that was </span><span class="line" data-startTime="1747">underneath the animation, then </span><span class="line" data-startTime="1751">there would be no reason to </span><span class="line" data-startTime="1751">composite it because it does </span><span class="line" data-startTime="1753">not overlap. </span></p>

<p><span class="line" data-startTime="1754">In fact, it's underneath </span><span class="line" data-startTime="1754">the animation. </span> <span class="line" data-startTime="1757">So that's example number one. </span> <span class="line" data-startTime="1759">Let's see. </span> <span class="line" data-startTime="1761">A few other examples. </span> <span class="line" data-startTime="1775">MapsGL is a fun example. </span> <span class="line" data-startTime="1779">Not only does it show off WebGL, </span><span class="line" data-startTime="1779">but it also shows off </span><span class="line" data-startTime="1785">how a compositor is smart </span><span class="line" data-startTime="1785">enough to render </span><span class="line" data-startTime="1787">stuff on top of WebGL. </span> <span class="line" data-startTime="1789">So what I have here is using </span><span class="line" data-startTime="1789">the vector form of MapGL. </span> <span class="line" data-startTime="1794">So this map is actually a WebGL </span><span class="line" data-startTime="1794">canvas on the page. </span> <span class="line" data-startTime="1801">And these elements on top </span><span class="line" data-startTime="1801">are overlapping a </span><span class="line" data-startTime="1804">composited WebGL element. </span> <span class="line" data-startTime="1807">And so they also have </span><span class="line" data-startTime="1807">to get composited. </span> <span class="line" data-startTime="1812">Let's see. </span></p>

<p><span class="line" data-startTime="1813">Any other interesting? </span><span class="line" data-startTime="1814">Android apps is also </span><span class="line" data-startTime="1814">a fun example. </span> <span class="line" data-startTime="1817">Here you can see animations in </span><span class="line" data-startTime="1817">action that actually cause </span><span class="line" data-startTime="1821">other layers to get created. </span> <span class="line" data-startTime="1825">So what you see here is as I </span><span class="line" data-startTime="1825">interact, as I mouse over the </span><span class="line" data-startTime="1830">shadow, the halo around </span><span class="line" data-startTime="1830">this [? holes ?] </span><span class="line" data-startTime="1834">changes some of these highlight </span><span class="line" data-startTime="1834">elements like the </span><span class="line" data-startTime="1837">brackets that are focusing </span><span class="line" data-startTime="1837">on different </span><span class="line" data-startTime="1840">elements as I mouse over. </span> <span class="line" data-startTime="1842">They animate. </span> <span class="line" data-startTime="1843">And what you see is that </span><span class="line" data-startTime="1843">depending on what needs to </span><span class="line" data-startTime="1846">animate, it might actually have </span><span class="line" data-startTime="1846">a lot of things on top. </span></p>

<p><span class="line" data-startTime="1851">And those a lot of things on top </span><span class="line" data-startTime="1851">then also need to become </span><span class="line" data-startTime="1854">composited. </span> <span class="line" data-startTime="1855">Because we can't assume that the </span><span class="line" data-startTime="1855">animation is not actually </span><span class="line" data-startTime="1859">overlapping. </span> <span class="line" data-startTime="1860">We have to assume that </span><span class="line" data-startTime="1860">it might overlap. </span> <span class="line" data-startTime="1862">And so this is a pitfall that, </span><span class="line" data-startTime="1862">in this case, it's actually </span><span class="line" data-startTime="1866">very reasonable. </span> <span class="line" data-startTime="1867">The number of layers </span><span class="line" data-startTime="1867">is not too bad. </span> <span class="line" data-startTime="1869">The animations are </span><span class="line" data-startTime="1869">very controlled. </span></p>

<p><span class="line" data-startTime="1872">The layer explosion disappears </span><span class="line" data-startTime="1872">after the animations are done, </span><span class="line" data-startTime="1876">which is generally </span><span class="line" data-startTime="1876">a good thing. </span> <span class="line" data-startTime="1880">But it's still interesting to </span><span class="line" data-startTime="1880">note that it can accidentally </span><span class="line" data-startTime="1883">get out of hand if you're </span><span class="line" data-startTime="1883">not careful in </span><span class="line" data-startTime="1886">making your web page. </span> <span class="line" data-startTime="1888">It's also interesting to note </span><span class="line" data-startTime="1888">that we have some 3D layers </span><span class="line" data-startTime="1890">here that get composited. </span> <span class="line" data-startTime="1894">There's a flip card </span><span class="line" data-startTime="1894">animation here. </span> <span class="line" data-startTime="1897">If you see the purple </span><span class="line" data-startTime="1897">composited </span><span class="line" data-startTime="1902">layer flipping around. </span> <span class="line" data-startTime="1905">The reason that it's purple is </span><span class="line" data-startTime="1905">because in our compositor we </span><span class="line" data-startTime="1908">actually have to create a </span><span class="line" data-startTime="1908">secondary intermediate thing </span><span class="line" data-startTime="1911">where we render a bunch of </span><span class="line" data-startTime="1911">composited layers into another </span><span class="line" data-startTime="1915">intermediate surface. </span> <span class="line" data-startTime="1916">That's what this purple is. </span> <span class="line" data-startTime="1918">The reason we have to do that </span><span class="line" data-startTime="1918">is because we have something </span><span class="line" data-startTime="1921">like this 3D composited </span><span class="line" data-startTime="1921">layer inside of it. </span> <span class="line" data-startTime="1924">But we're going to want </span><span class="line" data-startTime="1924">to do something 3D to </span><span class="line" data-startTime="1926">this outside layer. </span></p>

<p><span class="line" data-startTime="1928">Like a flip card animation. </span> <span class="line" data-startTime="1931">And so what that requires is </span><span class="line" data-startTime="1931">that we actually have to </span><span class="line" data-startTime="1934">render a bunch of composited </span><span class="line" data-startTime="1934">layers down to an </span><span class="line" data-startTime="1936">intermediate surface. </span> <span class="line" data-startTime="1937">And that's what this blue </span><span class="line" data-startTime="1937">layer actually is. </span> <span class="line" data-startTime="1941">In our Chromium compositor </span><span class="line" data-startTime="1941">terminology we call that a </span><span class="line" data-startTime="1944">render surface. </span> <span class="line" data-startTime="1945">If you encounter that. </span> <span class="line" data-startTime="1948">Let me go back to the command </span><span class="line" data-startTime="1948">line here really quickly and </span><span class="line" data-startTime="1953">show you what it looks like </span><span class="line" data-startTime="1953">to see paper rects. </span> <span class="line" data-startTime="1962">So here is poster </span><span class="line" data-startTime="1962">circle again. </span></p>

<p><span class="line" data-startTime="1965">Now notice that you're not </span><span class="line" data-startTime="1965">seeing any visualizations on </span><span class="line" data-startTime="1968">top of the page itself yet. </span> <span class="line" data-startTime="1971">And the reason is is </span><span class="line" data-startTime="1971">because nothing is </span><span class="line" data-startTime="1973">actually being repainted. </span> <span class="line" data-startTime="1974">And that's a very </span><span class="line" data-startTime="1974">wonderful thing. </span> <span class="line" data-startTime="1976">That's a great place to </span><span class="line" data-startTime="1976">be on your web page as </span><span class="line" data-startTime="1978">often as you can. </span> <span class="line" data-startTime="1980">If I actually select some text, </span><span class="line" data-startTime="1980">though, you can actually </span><span class="line" data-startTime="1982">see that there's this red </span><span class="line" data-startTime="1982">visualization that comes up on </span><span class="line" data-startTime="1987">top showing that, oh, actually </span><span class="line" data-startTime="1987">this is a region of the page </span><span class="line" data-startTime="1992">that needed to be repainted </span><span class="line" data-startTime="1992">at that particular frame. </span></p>

<p><span class="line" data-startTime="1995">And the reason it's flickering </span><span class="line" data-startTime="1995">on and off is because the </span><span class="line" data-startTime="1997">animation is actually going on </span><span class="line" data-startTime="1997">as well, at the same time. </span> <span class="line" data-startTime="2001">And so the next frame is so soon </span><span class="line" data-startTime="2001">after that the paint rect </span><span class="line" data-startTime="2005">for the previous frame </span><span class="line" data-startTime="2005">disappears. </span> <span class="line" data-startTime="2007">That's why it's flickering. </span> <span class="line" data-startTime="2008">If you had a more static page </span><span class="line" data-startTime="2008">and you selected some text, </span><span class="line" data-startTime="2012">you would see that visualization </span><span class="line" data-startTime="2012">stick because no </span><span class="line" data-startTime="2014">other frame has been rendered </span><span class="line" data-startTime="2014">after that yet. </span> <span class="line" data-startTime="2019">So that's interesting. </span> <span class="line" data-startTime="2020">Maybe one last thing to show </span><span class="line" data-startTime="2020">is property change rects. </span> <span class="line" data-startTime="2024">Again, show paint rects is </span><span class="line" data-startTime="2024">probably the most important, </span><span class="line" data-startTime="2029">especially to get web apps. </span> <span class="line" data-startTime="2031">You want to avoid paint rects </span><span class="line" data-startTime="2031">showing up if you use that </span><span class="line" data-startTime="2037">visualization. </span></p>

<p><span class="line" data-startTime="2038">But in the case of property </span><span class="line" data-startTime="2038">change rects. </span> <span class="line" data-startTime="2047">In the case of property </span><span class="line" data-startTime="2047">change rects, it's </span><span class="line" data-startTime="2049">actually a good thing. </span> <span class="line" data-startTime="2051">And so what you're seeing here </span><span class="line" data-startTime="2051">is that well the animations </span><span class="line" data-startTime="2054">here are actually animating the </span><span class="line" data-startTime="2054">CSS transform property. </span> <span class="line" data-startTime="2058">And so that property is </span><span class="line" data-startTime="2058">changing every frame. </span> <span class="line" data-startTime="2061">And these rects are just a rough </span><span class="line" data-startTime="2061">visualization to show </span><span class="line" data-startTime="2064">that here the layers that </span><span class="line" data-startTime="2064">actually did need to be </span><span class="line" data-startTime="2067">redrawn even though nothing </span><span class="line" data-startTime="2067">needed to be repainted. </span></p>

<p><span class="line" data-startTime="2070">That's what this visualization </span><span class="line" data-startTime="2070">shows. </span> <span class="line" data-startTime="2076">OK back to the slides. </span> <span class="line" data-startTime="2084">So I just want to briefly go </span><span class="line" data-startTime="2084">over some of how WebCore and </span><span class="line" data-startTime="2089">Blink actually implement the </span><span class="line" data-startTime="2089">choice of how composited </span><span class="line" data-startTime="2093">layers work. </span> <span class="line" data-startTime="2095">It turns out there's actually </span><span class="line" data-startTime="2095">lots of levels of abstraction </span><span class="line" data-startTime="2097">here just to get different </span><span class="line" data-startTime="2097">pieces of </span><span class="line" data-startTime="2100">software clumped together. </span> <span class="line" data-startTime="2102">So at the bottom of this stack </span><span class="line" data-startTime="2102">here we sort of have the </span><span class="line" data-startTime="2106">output of the Blink side </span><span class="line" data-startTime="2106">of compositing. </span> <span class="line" data-startTime="2110">The output is a tree of </span><span class="line" data-startTime="2110">composited layers. </span> <span class="line" data-startTime="2115">CC is the name space for </span><span class="line" data-startTime="2115">Chromium's compositor. </span></p>

<p><span class="line" data-startTime="2120">So ultimately the output of </span><span class="line" data-startTime="2120">Blink deciding what's </span><span class="line" data-startTime="2125">composite is a tree of these </span><span class="line" data-startTime="2125">CC layer data structures. </span> <span class="line" data-startTime="2129">For each CC layer, then, what </span><span class="line" data-startTime="2129">the compositor will do is it </span><span class="line" data-startTime="2132">will actually hook back into </span><span class="line" data-startTime="2132">Blink asking Blink, when it's </span><span class="line" data-startTime="2135">ready it will say Blink please </span><span class="line" data-startTime="2135">repeat this composited layer. </span> <span class="line" data-startTime="2139">Blink then has the knowledge </span><span class="line" data-startTime="2139">of what render layers and </span><span class="line" data-startTime="2143">render objects and just how to </span><span class="line" data-startTime="2143">render what's inside of that </span><span class="line" data-startTime="2147">particular composited layer. </span> <span class="line" data-startTime="2149">So just to bridge the gap </span><span class="line" data-startTime="2149">between Chromium and Blink we </span><span class="line" data-startTime="2153">have several levels of </span><span class="line" data-startTime="2153">interaction where they're </span><span class="line" data-startTime="2158">really just essentially </span><span class="line" data-startTime="2158">wrappers to CC layer. </span></p>

<p><span class="line" data-startTime="2164">But it's just necessary for the </span><span class="line" data-startTime="2164">fact that these are two </span><span class="line" data-startTime="2166">separate pieces of software that </span><span class="line" data-startTime="2166">are interacting with each </span><span class="line" data-startTime="2169">other and they need to </span><span class="line" data-startTime="2169">talk back and forth. </span> <span class="line" data-startTime="2171">So we have this interface </span><span class="line" data-startTime="2171">called web layer. </span> <span class="line" data-startTime="2174">And web layer impl is the </span><span class="line" data-startTime="2174">implementation of that. </span> <span class="line" data-startTime="2179">From there on the Blink side, </span><span class="line" data-startTime="2179">then, we have graphics layer </span><span class="line" data-startTime="2184">Chromium is the actual </span><span class="line" data-startTime="2184">Chromium-specific </span><span class="line" data-startTime="2187">implementation of a </span><span class="line" data-startTime="2187">graphics layer. </span> <span class="line" data-startTime="2191">And a graphics layer, then, </span><span class="line" data-startTime="2191">this is really Blink's </span><span class="line" data-startTime="2195">representation of a single </span><span class="line" data-startTime="2195">individual composited layer. </span> <span class="line" data-startTime="2200">Not all of these will actually </span><span class="line" data-startTime="2200">draw things. </span></p>

<p><span class="line" data-startTime="2202">They may exist in the tree just </span><span class="line" data-startTime="2202">to represent a transform </span><span class="line" data-startTime="2206">or maybe a clipping region. </span> <span class="line" data-startTime="2209">But the idea is that a tree of </span><span class="line" data-startTime="2209">graphics layer generally </span><span class="line" data-startTime="2214">corresponds to a tree of </span><span class="line" data-startTime="2214">Chromium compositor layers. </span> <span class="line" data-startTime="2220">Basically one to one. </span> <span class="line" data-startTime="2222">Not quite, but basically. </span> <span class="line" data-startTime="2225">So the real interesting stuff is </span><span class="line" data-startTime="2225">actually at the top of the </span><span class="line" data-startTime="2228">stack here. </span> <span class="line" data-startTime="2229">It's these top three things. </span> <span class="line" data-startTime="2231">So we have graphics layer as our </span><span class="line" data-startTime="2231">Blink representation of a </span><span class="line" data-startTime="2235">composited layer. </span> <span class="line" data-startTime="2236">Then we have this bridge call </span><span class="line" data-startTime="2236">render layer backing. </span></p>

<p><span class="line" data-startTime="2242">Render layer backing is the </span><span class="line" data-startTime="2242">bridge between render layers </span><span class="line" data-startTime="2246">and graphics layers. </span> <span class="line" data-startTime="2247">So render layers, I'll just </span><span class="line" data-startTime="2247">assume that this is the input </span><span class="line" data-startTime="2252">to our problem statement </span><span class="line" data-startTime="2252">in this talk here. </span> <span class="line" data-startTime="2255">But it actually came from taking </span><span class="line" data-startTime="2255">the DOM tree, computing </span><span class="line" data-startTime="2260">render tree of render objects, </span><span class="line" data-startTime="2260">that's another class in </span><span class="line" data-startTime="2263">WebCore name space is </span><span class="line" data-startTime="2263">render objects. </span> <span class="line" data-startTime="2266">These render objects, </span><span class="line" data-startTime="2266">some of them become </span><span class="line" data-startTime="2269">promoted to render layers. </span> <span class="line" data-startTime="2272">And so we have a tree of render </span><span class="line" data-startTime="2272">layers that some of </span><span class="line" data-startTime="2276">these render layers will have, </span><span class="line" data-startTime="2276">we would decide to be </span><span class="line" data-startTime="2279">composited. </span> <span class="line" data-startTime="2280">And those composited render </span><span class="line" data-startTime="2280">layers will have </span><span class="line" data-startTime="2283">render layer backings. </span> <span class="line" data-startTime="2284">The render layer backings then </span><span class="line" data-startTime="2284">will have a small chunk of </span><span class="line" data-startTime="2288">graphics layers that it puts </span><span class="line" data-startTime="2288">together to create the entire </span><span class="line" data-startTime="2292">composited layer tree. </span> <span class="line" data-startTime="2294">So I know that might be a little </span><span class="line" data-startTime="2294">confusing, yet here's a </span><span class="line" data-startTime="2297">visualization that hopefully </span><span class="line" data-startTime="2297">clears up a bit of it. </span> <span class="line" data-startTime="2300">On the left-hand side we start </span><span class="line" data-startTime="2300">with the render layer paint </span><span class="line" data-startTime="2303">order tree. </span></p>

<p><span class="line" data-startTime="2305">So the idea would be that here </span><span class="line" data-startTime="2305">where my mouse is is actually </span><span class="line" data-startTime="2310">maybe the root, the root render </span><span class="line" data-startTime="2310">view of the page. </span> <span class="line" data-startTime="2315">These other layers are not </span><span class="line" data-startTime="2315">necessarily composited, but </span><span class="line" data-startTime="2319">let's say over here this next </span><span class="line" data-startTime="2319">red circle is also we chose to </span><span class="line" data-startTime="2323">make a composited layer </span><span class="line" data-startTime="2323">in the paint order. </span> <span class="line" data-startTime="2327">What would happen then is these </span><span class="line" data-startTime="2327">composited layers would </span><span class="line" data-startTime="2332">have a reference, or actually </span><span class="line" data-startTime="2332">they would own a </span><span class="line" data-startTime="2336">render layer backing. </span> <span class="line" data-startTime="2337">Which is represented in these </span><span class="line" data-startTime="2337">blue circles here. </span> <span class="line" data-startTime="2340">By themselves the render layer </span><span class="line" data-startTime="2340">backings are not the final </span><span class="line" data-startTime="2344">output that we can actually </span><span class="line" data-startTime="2344">take in the </span><span class="line" data-startTime="2346">compositor and renderer. </span></p>

<p><span class="line" data-startTime="2348">Instead, the render layer </span><span class="line" data-startTime="2348">backings each manage a small </span><span class="line" data-startTime="2353">chunk of graphics layers. </span> <span class="line" data-startTime="2357">And I'll show you in a second </span><span class="line" data-startTime="2357">what the purpose of some of </span><span class="line" data-startTime="2360">these graphics layers are. </span> <span class="line" data-startTime="2361">But basically what happens </span><span class="line" data-startTime="2361">then is that these render </span><span class="line" data-startTime="2365">layer backings will stitch </span><span class="line" data-startTime="2365">together their chunks of </span><span class="line" data-startTime="2368">graphics layers to create the </span><span class="line" data-startTime="2368">actual graphics layer tree. </span> <span class="line" data-startTime="2371">So the graphics layer tree, that </span><span class="line" data-startTime="2371">would basically be output </span><span class="line" data-startTime="2375">to the Chromium compositor, is </span><span class="line" data-startTime="2375">this tree of gray squares that </span><span class="line" data-startTime="2380">you see here. </span> <span class="line" data-startTime="2383">And so it's interesting to </span><span class="line" data-startTime="2383">note that from the render </span><span class="line" data-startTime="2386">layer tree to the graphics layer </span><span class="line" data-startTime="2386">tree, it's not really a </span><span class="line" data-startTime="2390">direct correspondence. </span> <span class="line" data-startTime="2391">You can't quite easily say that </span><span class="line" data-startTime="2391">this layer on the render </span><span class="line" data-startTime="2395">layer tree corresponds </span><span class="line" data-startTime="2395">to this layer in the </span><span class="line" data-startTime="2397">graphics layer tree. </span></p>

<p><span class="line" data-startTime="2399">What you have to say is that </span><span class="line" data-startTime="2399">this chunk of the render layer </span><span class="line" data-startTime="2402">tree corresponds to this chunk </span><span class="line" data-startTime="2402">of the graphics layer tree. </span> <span class="line" data-startTime="2407">That's the way to more easily </span><span class="line" data-startTime="2407">see what's going on here. </span> <span class="line" data-startTime="2413">So inside the render layer </span><span class="line" data-startTime="2413">backing, there's actually a </span><span class="line" data-startTime="2417">fairly complicated, hopefully </span><span class="line" data-startTime="2417">we can simplify this over </span><span class="line" data-startTime="2419">time, but for now the way it's </span><span class="line" data-startTime="2419">implemented, it's a fairly </span><span class="line" data-startTime="2422">complicated set of layers that </span><span class="line" data-startTime="2422">are used just for convenience. </span> <span class="line" data-startTime="2428">That we can more easily handle </span><span class="line" data-startTime="2428">things like clipping or </span><span class="line" data-startTime="2432">containment of a separate </span><span class="line" data-startTime="2432">background in a foreground if </span><span class="line" data-startTime="2436">we found that while we're </span><span class="line" data-startTime="2436">computing what should be </span><span class="line" data-startTime="2439">composited, there's some cases </span><span class="line" data-startTime="2439">where it's actually reasonable </span><span class="line" data-startTime="2443">to separate the background </span><span class="line" data-startTime="2443">from the foreground. </span> <span class="line" data-startTime="2446">And so that's what it is </span><span class="line" data-startTime="2446">represented here inside a </span><span class="line" data-startTime="2449">render layer backing. </span> <span class="line" data-startTime="2451">Clip layers and container </span><span class="line" data-startTime="2451">layers </span><span class="line" data-startTime="2454">generally won't draw anything. </span></p>

<p><span class="line" data-startTime="2456">Instead their purpose is simply </span><span class="line" data-startTime="2456">to be a little bit </span><span class="line" data-startTime="2459">easier to represent something </span><span class="line" data-startTime="2459">in the tree. </span> <span class="line" data-startTime="2461">So the clip layer would </span><span class="line" data-startTime="2461">basically clip its entire </span><span class="line" data-startTime="2464">subtree from the composited </span><span class="line" data-startTime="2464">layer tree's perspective. </span> <span class="line" data-startTime="2468">And then, of course, once we </span><span class="line" data-startTime="2468">reach this end game here at </span><span class="line" data-startTime="2472">the bottom of the chunk of tree </span><span class="line" data-startTime="2472">here, we would have a </span><span class="line" data-startTime="2475">container that actually contains </span><span class="line" data-startTime="2475">the other render </span><span class="line" data-startTime="2478">layer children as needed. </span> <span class="line" data-startTime="2485">So I basically just said </span><span class="line" data-startTime="2485">already, why do we need so </span><span class="line" data-startTime="2489">many layers? </span><span class="line" data-startTime="2489">Well scroll bars is one </span><span class="line" data-startTime="2489">I didn't mention. </span> <span class="line" data-startTime="2492">It's always nice to keep scroll </span><span class="line" data-startTime="2492">bars separate so that </span><span class="line" data-startTime="2494">you don't have to change the </span><span class="line" data-startTime="2494">contents of a layer just </span><span class="line" data-startTime="2497">because you scrolled it. </span></p>

<p><span class="line" data-startTime="2498">All you have to do is then just </span><span class="line" data-startTime="2498">repaint the scroll bar as </span><span class="line" data-startTime="2501">things scroll around. </span> <span class="line" data-startTime="2504">And then, yes, as I said clips, </span><span class="line" data-startTime="2504">background, foreground. </span> <span class="line" data-startTime="2508">Grouping things together, such </span><span class="line" data-startTime="2508">as when you have contents that </span><span class="line" data-startTime="2511">would scroll you want </span><span class="line" data-startTime="2511">to group them. </span> <span class="line" data-startTime="2513">Masks, reflections, these are </span><span class="line" data-startTime="2513">actually implicit if you look </span><span class="line" data-startTime="2517">at the code. </span> <span class="line" data-startTime="2517">These are not actually </span><span class="line" data-startTime="2517">represented as part of this </span><span class="line" data-startTime="2521">tree, but rather each individual </span><span class="line" data-startTime="2521">layer might contain </span><span class="line" data-startTime="2526">a reference to mask or a </span><span class="line" data-startTime="2526">reference to a reflection. </span></p>

<p><span class="line" data-startTime="2533">So in terms of code paths, I'm </span><span class="line" data-startTime="2533">going to go over this quickly. </span> <span class="line" data-startTime="2536">The slides will be </span><span class="line" data-startTime="2536">available online. </span> <span class="line" data-startTime="2540">It's really something that </span><span class="line" data-startTime="2540">you just have to </span><span class="line" data-startTime="2541">read and look through. </span> <span class="line" data-startTime="2544">This is more of a reference than </span><span class="line" data-startTime="2544">anything that is really </span><span class="line" data-startTime="2547">worth explaining in a talk. </span> <span class="line" data-startTime="2549">But I will at least quickly say, </span><span class="line" data-startTime="2549">what we have then is we </span><span class="line" data-startTime="2554">have a paint code path which </span><span class="line" data-startTime="2554">Chromium asks Blink to paint. </span> <span class="line" data-startTime="2560">And basically what happens is </span><span class="line" data-startTime="2560">each graphics layer here has </span><span class="line" data-startTime="2570">an associated paint </span><span class="line" data-startTime="2570">face with it. </span> <span class="line" data-startTime="2572">And that paint phase is the way </span><span class="line" data-startTime="2572">that a render layer knows </span><span class="line" data-startTime="2577">how to paint itself. </span> <span class="line" data-startTime="2580">So when we actually ask Blink, </span><span class="line" data-startTime="2580">please paint this composited </span><span class="line" data-startTime="2583">layer using your subtree of </span><span class="line" data-startTime="2583">render layers, the render </span><span class="line" data-startTime="2588">layers will then paint based on </span><span class="line" data-startTime="2588">if they contribute to that </span><span class="line" data-startTime="2592">particular graphics layer. </span></p>

<p><span class="line" data-startTime="2593">And the way they recognize </span><span class="line" data-startTime="2593">whether they contribute is </span><span class="line" data-startTime="2596">through this phase. </span> <span class="line" data-startTime="2597">So they kind of filter </span><span class="line" data-startTime="2597">themselves out. </span> <span class="line" data-startTime="2599">And they don't paint themselves </span><span class="line" data-startTime="2599">to composited </span><span class="line" data-startTime="2603">layers that they don't actually </span><span class="line" data-startTime="2603">contribute to. </span> <span class="line" data-startTime="2608">So it's this phase mechanism </span><span class="line" data-startTime="2608">that couples that. </span> <span class="line" data-startTime="2612">If you're asking how a render </span><span class="line" data-startTime="2612">layer paints into a graphics </span><span class="line" data-startTime="2615">layer the answer is it uses a </span><span class="line" data-startTime="2615">phase to recognize which layer </span><span class="line" data-startTime="2620">it paints into. </span> <span class="line" data-startTime="2622">And then we have the code path </span><span class="line" data-startTime="2622">which actually computes what </span><span class="line" data-startTime="2624">actually gets composited. </span> <span class="line" data-startTime="2626">This is the recursive algorithm </span><span class="line" data-startTime="2626">I mentioned earlier. </span> <span class="line" data-startTime="2629">There's basically two </span><span class="line" data-startTime="2629">parts to this. </span></p>

<p><span class="line" data-startTime="2630">One is you want to determine </span><span class="line" data-startTime="2630">what gets composited. </span> <span class="line" data-startTime="2633">And the second part is you </span><span class="line" data-startTime="2633">actually need to stitch </span><span class="line" data-startTime="2636">together these data structures </span><span class="line" data-startTime="2636">and initialize these data </span><span class="line" data-startTime="2639">structures. </span> <span class="line" data-startTime="2640">So that second part is rebuild </span><span class="line" data-startTime="2640">compositing layer tree. </span> <span class="line" data-startTime="2648">And it's worth mentioning if you </span><span class="line" data-startTime="2648">do look at this code, when </span><span class="line" data-startTime="2652">you paint, knowing what you </span><span class="line" data-startTime="2652">paint into is actually </span><span class="line" data-startTime="2657">implicitly represented </span><span class="line" data-startTime="2657">by a context. </span> <span class="line" data-startTime="2659">This graphics context is </span><span class="line" data-startTime="2659">basically the 2D drawing </span><span class="line" data-startTime="2663">library that is given to a set </span><span class="line" data-startTime="2663">of render layers which was </span><span class="line" data-startTime="2668">then used to actually draw. </span></p>

<p><span class="line" data-startTime="2670">So in this 2D library what's </span><span class="line" data-startTime="2670">implied underneath is that you </span><span class="line" data-startTime="2675">already know what is the buffer </span><span class="line" data-startTime="2675">of pixels that you're </span><span class="line" data-startTime="2677">going to be painting into. </span> <span class="line" data-startTime="2678">And so all you have to do is </span><span class="line" data-startTime="2678">use this pointer, use this </span><span class="line" data-startTime="2681">reference, this context, to </span><span class="line" data-startTime="2681">actually invoke your 2D </span><span class="line" data-startTime="2685">drawing commands. </span> <span class="line" data-startTime="2687">And it will draw into </span><span class="line" data-startTime="2687">the correct buffer. </span> <span class="line" data-startTime="2689">So this is the context that's </span><span class="line" data-startTime="2689">passed from the compositor to </span><span class="line" data-startTime="2696">Blink to identify your painting </span><span class="line" data-startTime="2696">into this correct </span><span class="line" data-startTime="2701">buffer of pixels. </span> <span class="line" data-startTime="2703">And then as I mentioned before, </span><span class="line" data-startTime="2703">it uses the painting </span><span class="line" data-startTime="2705">phase mechanism for render </span><span class="line" data-startTime="2705">layers to identify which </span><span class="line" data-startTime="2708">composited layers </span><span class="line" data-startTime="2708">it paints into. </span></p>

<p><span class="line" data-startTime="2712">So these are basically the two </span><span class="line" data-startTime="2712">pieces of data that need to be </span><span class="line" data-startTime="2715">passed from the compositor to </span><span class="line" data-startTime="2715">the render layer in order to </span><span class="line" data-startTime="2719">paint correctly. </span> <span class="line" data-startTime="2726">Yes and I think I'll let you </span><span class="line" data-startTime="2726">all look at these slides on </span><span class="line" data-startTime="2730">your own afterwards. </span> <span class="line" data-startTime="2732">Let's talk about some of the </span><span class="line" data-startTime="2732">issues that come up with </span><span class="line" data-startTime="2737">compositing. </span> <span class="line" data-startTime="2738">Compositing seems like it may </span><span class="line" data-startTime="2738">solve the world's problems, </span><span class="line" data-startTime="2742">but it actually doesn't. </span> <span class="line" data-startTime="2744">And it has its own set of </span><span class="line" data-startTime="2744">problems that gets created. </span> <span class="line" data-startTime="2747">Ideally, what we would like is </span><span class="line" data-startTime="2747">the compositor to be super </span><span class="line" data-startTime="2751">intelligent and it knows </span><span class="line" data-startTime="2751">what can we composite. </span></p>

<p><span class="line" data-startTime="2755">What would be the cost </span><span class="line" data-startTime="2755">of doing so? </span><span class="line" data-startTime="2758">What would be the memory cost, </span><span class="line" data-startTime="2758">the computation cost? </span><span class="line" data-startTime="2761">What do we gain? </span><span class="line" data-startTime="2762">And it would be able to optimize </span><span class="line" data-startTime="2762">between the trade off </span><span class="line" data-startTime="2766">of what we gain by compositing, </span><span class="line" data-startTime="2766">in particular </span><span class="line" data-startTime="2769">avoiding repainting, versus the </span><span class="line" data-startTime="2769">cost of actually computing </span><span class="line" data-startTime="2772">all that stuff in </span><span class="line" data-startTime="2772">the first place. </span> <span class="line" data-startTime="2774">Realistically, that's </span><span class="line" data-startTime="2774">a very hard problem. </span> <span class="line" data-startTime="2778">And it's not always clear that </span><span class="line" data-startTime="2778">there is actually an ideal </span><span class="line" data-startTime="2781">answer for various algorithms </span><span class="line" data-startTime="2781">or various policies or </span><span class="line" data-startTime="2784">heuristics we choose, we may </span><span class="line" data-startTime="2784">be trading off making some </span><span class="line" data-startTime="2788">pages better and other </span><span class="line" data-startTime="2788">pages worse. </span> <span class="line" data-startTime="2790">So, in reality, what we really </span><span class="line" data-startTime="2790">do is just we composite when </span><span class="line" data-startTime="2795">we believe that we need it, or </span><span class="line" data-startTime="2795">when we really do need it. </span></p>

<p><span class="line" data-startTime="2799">For example, 3D transforms are </span><span class="line" data-startTime="2799">not supported unless you have </span><span class="line" data-startTime="2802">the accelerated compositor </span><span class="line" data-startTime="2802">enabled. </span> <span class="line" data-startTime="2806">And once we do that and we </span><span class="line" data-startTime="2806">accept that it is what it is, </span><span class="line" data-startTime="2812">whatever we've composited </span><span class="line" data-startTime="2812">blindly, we just accept that </span><span class="line" data-startTime="2816">the overhead exists. </span> <span class="line" data-startTime="2819">And we rely on ourselves as </span><span class="line" data-startTime="2819">architects of this to add </span><span class="line" data-startTime="2825">heuristics or to identify cases </span><span class="line" data-startTime="2825">where the overhead can </span><span class="line" data-startTime="2828">be reduced. </span> <span class="line" data-startTime="2829">But as an algorithm itself, </span><span class="line" data-startTime="2829">the principal and the </span><span class="line" data-startTime="2833">fundamental design of the </span><span class="line" data-startTime="2833">algorithm is basically blind. </span> <span class="line" data-startTime="2839">What are the overheads </span><span class="line" data-startTime="2839">of compositing? </span><span class="line" data-startTime="2840">Well there's the computational </span><span class="line" data-startTime="2840">cost of actually checking for </span><span class="line" data-startTime="2844">overlap, iterating over </span><span class="line" data-startTime="2844">all the render layers. </span></p>

<p><span class="line" data-startTime="2847">Where they are there can be </span><span class="line" data-startTime="2847">hundreds, even thousands on </span><span class="line" data-startTime="2849">some pages. </span> <span class="line" data-startTime="2851">Most of them won't get </span><span class="line" data-startTime="2851">composited, but they all have </span><span class="line" data-startTime="2854">to be visited in order to </span><span class="line" data-startTime="2854">determine whether we might </span><span class="line" data-startTime="2858">need to composite them. </span> <span class="line" data-startTime="2861">That can get pretty costly. </span> <span class="line" data-startTime="2863">There's the cost of actually </span><span class="line" data-startTime="2863">managing several more layer </span><span class="line" data-startTime="2866">tree data structures. </span> <span class="line" data-startTime="2868">We have the composited layer </span><span class="line" data-startTime="2868">tree structure in Chromium. </span> <span class="line" data-startTime="2872">We have the graphics later </span><span class="line" data-startTime="2872">composited layer tree </span><span class="line" data-startTime="2874">structure in Blink. </span> <span class="line" data-startTime="2876">We have the paint order </span><span class="line" data-startTime="2876">render layer tree. </span> <span class="line" data-startTime="2880">There's actually a few extra </span><span class="line" data-startTime="2880">layer trees inside of the </span><span class="line" data-startTime="2884">Chromium compositor itself. </span> <span class="line" data-startTime="2888">And mostly I think the worst </span><span class="line" data-startTime="2888">issue is that when we choose </span><span class="line" data-startTime="2895">to create a composite layer out </span><span class="line" data-startTime="2895">of a render layer, we are </span><span class="line" data-startTime="2899">saying that we intend to </span><span class="line" data-startTime="2899">allocate pixels to represent </span><span class="line" data-startTime="2904">that layer or that group of </span><span class="line" data-startTime="2904">layers, that subtree. </span> <span class="line" data-startTime="2908">And that greatly increases </span><span class="line" data-startTime="2908">memory cost </span><span class="line" data-startTime="2912">for rendering a page. </span></p>

<p><span class="line" data-startTime="2919">There's also some issues for </span><span class="line" data-startTime="2919">just rendering in general. </span> <span class="line" data-startTime="2925">In theory you should not know if </span><span class="line" data-startTime="2925">we are actually compositing </span><span class="line" data-startTime="2929">things or not. </span> <span class="line" data-startTime="2930">But realistically there are </span><span class="line" data-startTime="2930">some things that you, </span><span class="line" data-startTime="2932">especially as a web developer, </span><span class="line" data-startTime="2932">might want to be aware of. </span> <span class="line" data-startTime="2937">Anti-aliasing we would actually </span><span class="line" data-startTime="2937">do around the edges </span><span class="line" data-startTime="2941">of our composited layers. </span> <span class="line" data-startTime="2943">But we wouldn't necessarily be </span><span class="line" data-startTime="2943">able to anti-alias as nicely </span><span class="line" data-startTime="2947">the contents inside </span><span class="line" data-startTime="2947">of a layer. </span> <span class="line" data-startTime="2950">So, for example, if you had </span><span class="line" data-startTime="2950">elements with a border inside </span><span class="line" data-startTime="2955">of a composited layer and then </span><span class="line" data-startTime="2955">you maybe rotated that layer, </span><span class="line" data-startTime="2958">the edges of the composited </span><span class="line" data-startTime="2958">layer outside would look </span><span class="line" data-startTime="2963">smooth because we are able </span><span class="line" data-startTime="2963">to anti-alias those. </span> <span class="line" data-startTime="2965">But the border on the inside </span><span class="line" data-startTime="2965">that renders in that layer may </span><span class="line" data-startTime="2969">not necessarily look smooth </span><span class="line" data-startTime="2969">because it's actually just </span><span class="line" data-startTime="2972">pixel data that's rendered into </span><span class="line" data-startTime="2972">the composited layer. </span></p>

<p><span class="line" data-startTime="2977">Another issue that comes up is </span><span class="line" data-startTime="2977">the difference between LCD </span><span class="line" data-startTime="2980">text anti-aliasing and non LCD </span><span class="line" data-startTime="2980">text anti-aliasing, which </span><span class="line" data-startTime="2986">looks a bit blurrier. </span> <span class="line" data-startTime="2989">Unless we know for sure that </span><span class="line" data-startTime="2989">the composited layer is </span><span class="line" data-startTime="2994">completely opaque, we </span><span class="line" data-startTime="2994">actually cannot. </span> <span class="line" data-startTime="2998">There's just some fundamental </span><span class="line" data-startTime="2998">limitations that solving them </span><span class="line" data-startTime="3002">is actually bit costly. </span> <span class="line" data-startTime="3003">And it's an open problem of how </span><span class="line" data-startTime="3003">we might eventually solve </span><span class="line" data-startTime="3005">this, but we actually </span><span class="line" data-startTime="3005">cannot do LCD text </span><span class="line" data-startTime="3008">anti-aliasing in that case. </span> <span class="line" data-startTime="3011">The best we can do then is </span><span class="line" data-startTime="3011">resort to the blurry text </span><span class="line" data-startTime="3014">anti-aliasiing. </span> <span class="line" data-startTime="3016">And for devices that don't </span><span class="line" data-startTime="3016">have a high resolution, </span><span class="line" data-startTime="3022">switching between these two </span><span class="line" data-startTime="3022">actually becomes very </span><span class="line" data-startTime="3024">noticeable and unpleasing. </span> <span class="line" data-startTime="3026">And in many cases it's not </span><span class="line" data-startTime="3026">even just the switching </span><span class="line" data-startTime="3029">between the two that would look </span><span class="line" data-startTime="3029">like the text is sort of </span><span class="line" data-startTime="3031">flickering or wiggling a little, </span><span class="line" data-startTime="3031">but also just the fact </span><span class="line" data-startTime="3036">that you might get blurry text </span><span class="line" data-startTime="3036">where you would prefer to have </span><span class="line" data-startTime="3038">very nicely anti-alias text. </span></p>

<p><span class="line" data-startTime="3041">A good example of this is in </span><span class="line" data-startTime="3041">menus, nav bars at the top </span><span class="line" data-startTime="3045">that you might make fixed </span><span class="line" data-startTime="3045">position, for example. </span> <span class="line" data-startTime="3047">If they become composited </span><span class="line" data-startTime="3047">for some reason. </span> <span class="line" data-startTime="3050">Maybe they overlap some other </span><span class="line" data-startTime="3050">composited stuff, their text </span><span class="line" data-startTime="3053">might not be able to get nice </span><span class="line" data-startTime="3053">LCD text anti-aliasing. </span> <span class="line" data-startTime="3059">In theory we also want </span><span class="line" data-startTime="3059">to render at </span><span class="line" data-startTime="3061">least as fast as software. </span> <span class="line" data-startTime="3064">And generally we do. </span> <span class="line" data-startTime="3066">It is usually quite successful </span><span class="line" data-startTime="3066">at rendering very fast. </span> <span class="line" data-startTime="3070">But there's often cases where </span><span class="line" data-startTime="3070">once a page becomes </span><span class="line" data-startTime="3074">complicated enough, especially </span><span class="line" data-startTime="3074">if we cannot benefit from </span><span class="line" data-startTime="3078">avoiding repainting. </span> <span class="line" data-startTime="3079">If we still really need to </span><span class="line" data-startTime="3079">repaint layers every frame, </span><span class="line" data-startTime="3084">then compositing actually is not </span><span class="line" data-startTime="3084">going to be as beneficial. </span> <span class="line" data-startTime="3090">We would have to </span><span class="line" data-startTime="3090">repaint anyway. </span> <span class="line" data-startTime="3092">We would have to not only do the </span><span class="line" data-startTime="3092">repainting whether we were </span><span class="line" data-startTime="3095">in software or in composited </span><span class="line" data-startTime="3095">mode, but we would also then </span><span class="line" data-startTime="3098">with composited mode have </span><span class="line" data-startTime="3098">potentially a larger number of </span><span class="line" data-startTime="3102">layers that cost more memory. </span></p>

<p><span class="line" data-startTime="3104">And sometimes the bandwidth of </span><span class="line" data-startTime="3104">just drawing these layers on a </span><span class="line" data-startTime="3109">lightweight mobile GPU, for </span><span class="line" data-startTime="3109">example, can actually become </span><span class="line" data-startTime="3112">the bottleneck that maybe is </span><span class="line" data-startTime="3112">just more costly than the </span><span class="line" data-startTime="3116">painting itself in </span><span class="line" data-startTime="3116">some rare cases. </span> <span class="line" data-startTime="3122">So I think that's about it. </span> <span class="line" data-startTime="3124">If you have any questions I'd </span><span class="line" data-startTime="3124">be happy to taking them over </span><span class="line" data-startTime="3128">the graphics dev at chromium.org </span><span class="line" data-startTime="3128">discussion list. </span> <span class="line" data-startTime="3133">My LDAP is Shawn Singh. </span> <span class="line" data-startTime="3134">That's spelled S-H-A-WN </span><span class="line" data-startTime="3134">S-I-N-G-H @chromium.org. </span></p>

<p><span class="line" data-startTime="3139">Chromium I'm happy to receive </span><span class="line" data-startTime="3139">emails as well. </span> <span class="line" data-startTime="3142">And thank you for your time. </span> <span class="line" data-startTime="3143">Thank you for listening. </span> <span class="line" data-startTime="3144">I hope you enjoyed it. </span> <span class="line" data-startTime="3158">[MUSIC PLAYING] </span></p>