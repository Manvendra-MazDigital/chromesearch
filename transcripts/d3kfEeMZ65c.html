<p class="speaker"><span class="line" data-starttime="0"><span class="speakerName">Ian Ni-Lewis</span>: Welcome, </span><span class="line" data-startTime="0">audio diehards. </span> <span class="line" data-startTime="2">We're so happy to </span><span class="line" data-startTime="2">have you here. </span> <span class="line" data-startTime="6">It's great to see that more </span><span class="line" data-startTime="6">than 10 or 15 people would </span><span class="line" data-startTime="9">like to hear about high </span><span class="line" data-startTime="9">performance audio on Android. </span> <span class="line" data-startTime="12">We were running bets. </span> <span class="line" data-startTime="15">So I'm Ian Ni-Lewis. </span> <span class="line" data-startTime="17">I'm the developer relations </span><span class="line" data-startTime="17">contact for audio. </span> <span class="line" data-startTime="19">If you send audio questions to </span><span class="line" data-startTime="19">our developers support email, </span><span class="line" data-startTime="23">probably I will answer them. </span> <span class="line" data-startTime="26">But today, it's my great </span><span class="line" data-startTime="26">pleasure to introduce a couple </span><span class="line" data-startTime="29">friends of mine from the </span><span class="line" data-startTime="29">engineering team, Glenn Kasten </span><span class="line" data-startTime="32">and Raph Levien, who have </span><span class="line" data-startTime="32">actually done a huge amount of </span><span class="line" data-startTime="36">work in the last couple of years </span><span class="line" data-startTime="36">to set the standard for </span><span class="line" data-startTime="41">Android audio and </span><span class="line" data-startTime="41">make it better. </span></p>

<p><span class="line" data-startTime="44">And you're going to be hearing </span><span class="line" data-startTime="44">today some happy stories and </span><span class="line" data-startTime="47">some sad stories just </span><span class="line" data-startTime="47">to prep you on that. </span> <span class="line" data-startTime="53">But believe me, these guys have </span><span class="line" data-startTime="53">advanced to state of the </span><span class="line" data-startTime="57">art for Android audio more than </span><span class="line" data-startTime="57">anyone else and also Raph </span><span class="line" data-startTime="62">did some, too. </span> <span class="line" data-startTime="64">I know you were going </span><span class="line" data-startTime="64">to call me on that. </span> <span class="line" data-startTime="67">Anyway, I start stop talking. </span> <span class="line" data-startTime="68">Let's go ahead and welcome Glenn </span><span class="line" data-startTime="68">Kasten to begin High </span><span class="line" data-startTime="72">Performance Audio on Android. </span> <span class="line" data-startTime="74">[APPLAUSE] </span></p>

<p class="speaker"><span class="line" data-starttime="79"><span class="speakerName">Glenn Kasten</span>: Hi, everyone. </span> <span class="line" data-startTime="80">I'm Glenn Kasten. </span> <span class="line" data-startTime="81">I'm on the Android audio team, </span><span class="line" data-startTime="81">and my job is to provide great </span><span class="line" data-startTime="85">Android audio performance. </span> <span class="line" data-startTime="88">I work with our OEMs and silicon </span><span class="line" data-startTime="88">chip vendors to help </span><span class="line" data-startTime="95">them build devices that have </span><span class="line" data-startTime="95">really great audio. </span> <span class="line" data-startTime="98">And my goal is to provide </span><span class="line" data-startTime="98">you developers </span><span class="line" data-startTime="100">really top notch audio. </span> <span class="line" data-startTime="102">That's what I'm working on. </span> <span class="line" data-startTime="104">I know what you want to hear. </span> <span class="line" data-startTime="105">So let me disappoint you first, </span><span class="line" data-startTime="105">as Ian was hinting at. </span> <span class="line" data-startTime="109">We're not quite there yet. </span> <span class="line" data-startTime="111">But the good news is we are </span><span class="line" data-startTime="111">definitely making progress. </span> <span class="line" data-startTime="116">So today, we're going to tell </span><span class="line" data-startTime="116">you the story of what we've </span><span class="line" data-startTime="119">been doing so far and how you </span><span class="line" data-startTime="119">can take advantage of the work </span><span class="line" data-startTime="122">we've done so far. </span></p>

<p><span class="line" data-startTime="123">We're also going to tell you </span><span class="line" data-startTime="123">about what's coming up in the </span><span class="line" data-startTime="125">future in terms of our </span><span class="line" data-startTime="125">performance goals. </span> <span class="line" data-startTime="127">Now, performance could mean a </span><span class="line" data-startTime="127">lot of different things to </span><span class="line" data-startTime="129">different people. </span> <span class="line" data-startTime="130">But today, we're </span><span class="line" data-startTime="130">going to focus. </span> <span class="line" data-startTime="133">We're going to focus among all </span><span class="line" data-startTime="133">these different things on just </span><span class="line" data-startTime="137">one area, which is </span><span class="line" data-startTime="137">output latency. </span> <span class="line" data-startTime="142">If you're interested in input </span><span class="line" data-startTime="142">latency or other kinds of </span><span class="line" data-startTime="145">audio performance, definitely </span><span class="line" data-startTime="145">check us out at office hours. </span> <span class="line" data-startTime="150">Actually, check us out at office </span><span class="line" data-startTime="150">hours anyway even if </span><span class="line" data-startTime="152">you're not interested </span><span class="line" data-startTime="152">in something else. </span></p>

<p><span class="line" data-startTime="154">We want to talk to you about </span><span class="line" data-startTime="154">the other things. </span> <span class="line" data-startTime="155">But today, we're just going to </span><span class="line" data-startTime="155">focus on output latency, </span><span class="line" data-startTime="158">because that's the area we've </span><span class="line" data-startTime="158">made the most progress over </span><span class="line" data-startTime="160">the last two years. </span> <span class="line" data-startTime="162">So with regards to latency, this </span><span class="line" data-startTime="162">is a mock slide showing </span><span class="line" data-startTime="167">where we were, where we are now, </span><span class="line" data-startTime="167">and where we want to be. </span> <span class="line" data-startTime="171">But it doesn't really tell the </span><span class="line" data-startTime="171">whole story of why did it take </span><span class="line" data-startTime="174">us on to get to this point, </span><span class="line" data-startTime="174">what's the work that's been </span><span class="line" data-startTime="177">done, what's the work ahead, </span><span class="line" data-startTime="177">what can you do as audio </span><span class="line" data-startTime="180">developers? </span><span class="line" data-startTime="181">So today, we're going </span><span class="line" data-startTime="181">to really get into </span><span class="line" data-startTime="183">this in more detail. </span></p>

<p><span class="line" data-startTime="186">Explaining that is a really </span><span class="line" data-startTime="186">big job, and so I brought </span><span class="line" data-startTime="189">along my buddy, Raph, who's </span><span class="line" data-startTime="189">going to help me out. </span></p>

<p class="speaker"><span class="line" data-starttime="193"><span class="speakerName">Raph Levien</span>: Hi, my name is Raph </span><span class="line" data-startTime="193">Levien, and I work on the </span><span class="line" data-startTime="195">Android Frameworks team. </span><span class="line" data-startTime="197">You may know me &mdash; </span><span class="line" data-startTime="199">Glenn, next slide &mdash; </span><span class="line" data-startTime="201">from such features </span><span class="line" data-startTime="201">as Inconsolata, </span><span class="line" data-startTime="204">the programming font. </span><span class="line" data-startTime="205">Now, my day job &mdash; </span><span class="line" data-startTime="207">next slide &mdash; my day job </span><span class="line" data-startTime="207">is font and text </span><span class="line" data-startTime="210">rendering on Android. </span><span class="line" data-startTime="211">But in my spare time, I've </span><span class="line" data-startTime="211">been building a software </span><span class="line" data-startTime="213">emulation of the Yamaha </span><span class="line" data-startTime="213">DX7 synthesizer. </span><span class="line" data-startTime="216">I actually brought the original </span><span class="line" data-startTime="216">with me today. </span><span class="line" data-startTime="220">But I've been building software </span><span class="line" data-startTime="220">emulation, and I </span><span class="line" data-startTime="224">really wanted the emulation </span><span class="line" data-startTime="224">to be as beautiful as the </span><span class="line" data-startTime="227">original synthesizer. </span><span class="line" data-startTime="229">And in fact, that's </span><span class="line" data-startTime="229">how I met Glenn. </span><span class="line" data-startTime="231">I was trying to figure out </span><span class="line" data-startTime="231">why I couldn't get better </span><span class="line" data-startTime="232">performance running my synth </span><span class="line" data-startTime="232">engine on Android. </span><span class="line" data-startTime="235">And Glenn's name kept popping </span><span class="line" data-startTime="235">up in email threads about </span><span class="line" data-startTime="239">audio latency. </span></p>

<p class="speaker"><span class="line" data-starttime="240"><span class="speakerName">Glenn Kasten</span>: And I fixed </span><span class="line" data-startTime="240">all of his problems. </span></p>

<p class="speaker"><span class="line" data-starttime="243"><span class="speakerName">Raph Levien</span>: Well, let's </span><span class="line" data-startTime="243">just tell the story. </span><span class="line" data-startTime="245">It's a good story. </span></p>

<p class="speaker"><span class="line" data-starttime="248"><span class="speakerName">Glenn Kasten</span>: When Raph first </span><span class="line" data-startTime="248">contacted me, we were already </span><span class="line" data-startTime="250">looking into audio </span><span class="line" data-startTime="250">performance. </span><span class="line" data-startTime="252">The Android Frameworks team, </span><span class="line" data-startTime="252">the graphics team, and the </span><span class="line" data-startTime="255">apps team, they were all looking </span><span class="line" data-startTime="255">into performance, too, </span><span class="line" data-startTime="257">mostly on the touch side and </span><span class="line" data-startTime="257">on the graphic side. </span><span class="line" data-startTime="261">But the audio team was </span><span class="line" data-startTime="261">definitely looking into </span><span class="line" data-startTime="262">performance, too. </span><span class="line" data-startTime="263">And overall, we were calling </span><span class="line" data-startTime="263">this Project Butter. </span><span class="line" data-startTime="268">We were all thinking, how </span><span class="line" data-startTime="268">can we make things </span><span class="line" data-startTime="270">more fast, more smooth? </span><span class="line" data-startTime="274">But when it came to audio, </span><span class="line" data-startTime="274">there was really only one </span><span class="line" data-startTime="276">thing that everybody </span><span class="line" data-startTime="276">knew for certain. </span><span class="line" data-startTime="279">The latency was just </span><span class="line" data-startTime="279">too darn high &mdash; </span><span class="line" data-startTime="283">no question about that. </span></p>

<p class="speaker"><span class="line" data-starttime="284"><span class="speakerName">Raph Levien</span>: I think I was </span><span class="line" data-startTime="284">in same situation as </span><span class="line" data-startTime="286">a lot of you guys. </span> <span class="line" data-startTime="287">I was writing a musical </span><span class="line" data-startTime="287">instrument that was supposed </span><span class="line" data-startTime="290">to be responsive. </span> <span class="line" data-startTime="291">But I could hear a noticeable </span><span class="line" data-startTime="291">delay between the time I hit a </span><span class="line" data-startTime="293">key and the time my </span><span class="line" data-startTime="293">app responded. </span> <span class="line" data-startTime="297">Latency is the delay as a signal </span><span class="line" data-startTime="297">passes through the </span><span class="line" data-startTime="300">system, from your </span><span class="line" data-startTime="300">app to sound. </span> <span class="line" data-startTime="304">Some musicians, like organists, </span><span class="line" data-startTime="304">are trained to deal </span><span class="line" data-startTime="306">with high latencies if </span><span class="line" data-startTime="306">it's consistent. </span> <span class="line" data-startTime="308">But most people are sensitive </span><span class="line" data-startTime="308">to latencies greater than </span><span class="line" data-startTime="311">about 20 milliseconds. </span> <span class="line" data-startTime="312">And some can't deal with </span><span class="line" data-startTime="312">any latency at all. </span> <span class="line" data-startTime="314">Any percussionists </span><span class="line" data-startTime="314">or singers here? </span><span class="line" data-startTime="317">I wasn't asking for </span><span class="line" data-startTime="317">zero latency. </span> <span class="line" data-startTime="320">I would've been happy with 10, </span><span class="line" data-startTime="320">maybe even 20 milliseconds. </span> <span class="line" data-startTime="322">But I was hearing noticeable </span><span class="line" data-startTime="322">delays &mdash; over 100 milliseconds </span><span class="line" data-startTime="325">on some devices. </span> <span class="line" data-startTime="328">This story is about how Glenn </span><span class="line" data-startTime="328">helped me get my app's latency </span><span class="line" data-startTime="330">down to where it became a </span><span class="line" data-startTime="330">truly playable synth. </span></p>

<p><span class="line" data-startTime="333">As you'll see, it took us some </span><span class="line" data-startTime="333">work on both the Android side </span><span class="line" data-startTime="336">and the app side. </span> <span class="line" data-startTime="337">So as we tell the story, we're </span><span class="line" data-startTime="337">going to keep a running to do </span><span class="line" data-startTime="340">list of things we've done, </span><span class="line" data-startTime="340">things we still need to do, </span><span class="line" data-startTime="342">and things you need to do in </span><span class="line" data-startTime="342">your app to get low latency </span><span class="line" data-startTime="345">audio to work. </span></p>

<p class="speaker"><span class="line" data-starttime="346"><span class="speakerName">Glenn Kasten</span>: Now, I know you're </span><span class="line" data-startTime="346">all dragging out your </span><span class="line" data-startTime="348">notebooks now to start writing </span><span class="line" data-startTime="348">down this to do list. </span><span class="line" data-startTime="350">But don't worry. </span><span class="line" data-startTime="351">We are going to show the to </span><span class="line" data-startTime="351">do list at the end also. </span><span class="line" data-startTime="356">The first thing, the most </span><span class="line" data-startTime="356">important thing, and you're </span><span class="line" data-startTime="358">going to see this throughout </span><span class="line" data-startTime="358">the whole talk. </span><span class="line" data-startTime="359">It's going to keep coming up </span><span class="line" data-startTime="359">over and over and over again, </span><span class="line" data-startTime="362">is measure everything. </span><span class="line" data-startTime="365">We do it, and we hope </span><span class="line" data-startTime="365">you will too. </span></p>

<p class="speaker"><span class="line" data-starttime="366"><span class="speakerName">Raph Levien</span>: Before you can </span><span class="line" data-startTime="366">make changes to improve </span><span class="line" data-startTime="368">performance, you have to have </span><span class="line" data-startTime="368">an objective measurement of </span><span class="line" data-startTime="371">how bad it is. </span><span class="line" data-startTime="371">Otherwise, you're </span><span class="line" data-startTime="371">flying blind. </span></p>

<p class="speaker"><span class="line" data-starttime="373"><span class="speakerName">Glenn Kasten</span>: My brother, Steven </span><span class="line" data-startTime="373">was a musician, and he </span><span class="line" data-startTime="376">also built electronics. </span><span class="line" data-startTime="378">And I told them about </span><span class="line" data-startTime="378">my project working </span><span class="line" data-startTime="380">here on audio latency. </span><span class="line" data-startTime="382">And he encouraged me to get an </span><span class="line" data-startTime="382">oscilloscope, because, lets </span><span class="line" data-startTime="386">face it, real engineers </span><span class="line" data-startTime="386">have scopes. </span><span class="line" data-startTime="390">So even though I worked at </span><span class="line" data-startTime="390">Google, I do have a budget. </span><span class="line" data-startTime="394">So I got the cheapest </span><span class="line" data-startTime="394">oscilloscope I could find. </span><span class="line" data-startTime="397">And it's definitely not anything </span><span class="line" data-startTime="397">fancy, not good for </span><span class="line" data-startTime="401">high speed communications. </span><span class="line" data-startTime="402">But it was certainly perfectly </span><span class="line" data-startTime="402">adequate for audio. </span></p>

<p class="speaker"><span class="line" data-starttime="405"><span class="speakerName">Raph Levien</span>: The scope makes </span><span class="line" data-startTime="405">it possible to get precise </span><span class="line" data-startTime="407">measurements, but the really </span><span class="line" data-startTime="407">tricky part is getting </span><span class="line" data-startTime="409">accurately and reproducable </span><span class="line" data-startTime="409">measurements, especially if we </span><span class="line" data-startTime="412">want to hopefully someday make </span><span class="line" data-startTime="412">this part of the Android </span><span class="line" data-startTime="414">compatibility testing suite. </span><span class="line" data-startTime="416">We also need to make sure we </span><span class="line" data-startTime="416">isolate audio output latency </span><span class="line" data-startTime="419">from the other sources of delay </span><span class="line" data-startTime="419">in a system, like the </span><span class="line" data-startTime="421">audio input or the </span><span class="line" data-startTime="421">touch panel. </span><span class="line" data-startTime="423">Glenn came up with a cool </span><span class="line" data-startTime="423">way to do that. </span></p>

<p class="speaker"><span class="line" data-starttime="427"><span class="speakerName">Glenn Kasten</span>: So besides the </span><span class="line" data-startTime="427">scope, another great tool that </span><span class="line" data-startTime="429">I love is the LED, or lighting </span><span class="line" data-startTime="429">emitting diode. </span> <span class="line" data-startTime="433">I remember discovering the LED </span><span class="line" data-startTime="433">when I was 12 years old, and </span><span class="line" data-startTime="435">I've been in love </span><span class="line" data-startTime="435">ever since then. </span> <span class="line" data-startTime="437">I think one of the greatest </span><span class="line" data-startTime="437">things about a phone is the </span><span class="line" data-startTime="439">notification LED. </span> <span class="line" data-startTime="441">It's so useful, so fast, and </span><span class="line" data-startTime="441">yet it's really underused. </span> <span class="line" data-startTime="446">I can measure audio latency with </span><span class="line" data-startTime="446">an LED, a photo diode, </span><span class="line" data-startTime="450">and an oscilloscope. </span></p>

<p><span class="line" data-startTime="451">Basically, you just turn on the </span><span class="line" data-startTime="451">LED at the same time as </span><span class="line" data-startTime="454">your application is outputting </span><span class="line" data-startTime="454">audio data. </span> <span class="line" data-startTime="458">Then measure the difference in </span><span class="line" data-startTime="458">time between when you can </span><span class="line" data-startTime="460">detect the light from the LED </span><span class="line" data-startTime="460">and when you can detect the </span><span class="line" data-startTime="464">audio signal. </span> <span class="line" data-startTime="466">That difference is latency. </span> <span class="line" data-startTime="468">So my brother was into </span><span class="line" data-startTime="468">electronics. </span> <span class="line" data-startTime="471">I was, too, especially </span><span class="line" data-startTime="471">when I was younger. </span> <span class="line" data-startTime="473">So I brought back my electronics </span><span class="line" data-startTime="473">kit, and I started </span><span class="line" data-startTime="476">with a bread board design. </span> <span class="line" data-startTime="477">This is it. </span> <span class="line" data-startTime="479">Later on, one of our hardware </span><span class="line" data-startTime="479">engineers, Clinton, helped me </span><span class="line" data-startTime="482">out, and he made be a real live </span><span class="line" data-startTime="482">printed circuit board, </span><span class="line" data-startTime="485">which you can see here. </span> <span class="line" data-startTime="487">No, it does not actually have </span><span class="line" data-startTime="487">a red border on it. </span> <span class="line" data-startTime="489">That's just a highlight. </span> <span class="line" data-startTime="491">And here's the result with </span><span class="line" data-startTime="491">an oscilloscope. </span></p>

<p><span class="line" data-startTime="493">Basically, the yellow trace is </span><span class="line" data-startTime="493">the light detector from the </span><span class="line" data-startTime="496">LED to the photo diode. </span> <span class="line" data-startTime="499">And the blue trace </span><span class="line" data-startTime="499">is the audio. </span> <span class="line" data-startTime="501">I unfortunately can't really </span><span class="line" data-startTime="501">get into exact numbers. </span> <span class="line" data-startTime="504">They don't let me here. </span> <span class="line" data-startTime="505">But let's just say that it </span><span class="line" data-startTime="505">was a really big number &mdash; </span><span class="line" data-startTime="507">way too big. </span> <span class="line" data-startTime="509">So let's talk about why. </span></p>

<p class="speaker"><span class="line" data-starttime="511"><span class="speakerName">Raph Levien</span>: Latency in the real </span><span class="line" data-startTime="511">world is complex, but in </span><span class="line" data-startTime="514">software, it generally boils </span><span class="line" data-startTime="514">down to one thing &mdash; </span><span class="line" data-startTime="516">chains of buffers. </span></p>

<p class="speaker"><span class="line" data-starttime="519"><span class="speakerName">Glenn Kasten</span>: Here's a typical </span><span class="line" data-startTime="519">un-optimized audio pipeline, </span><span class="line" data-startTime="522">the kind that I found when I </span><span class="line" data-startTime="522">first started looking at this </span><span class="line" data-startTime="524">problem a couple years ago. </span><span class="line" data-startTime="526">As you can see from this </span><span class="line" data-startTime="526">diagram, we have four buffers </span><span class="line" data-startTime="529">of 1,024 frames or 23 </span><span class="line" data-startTime="532">milliseconds each at 44 kilohertz. </span><span class="line" data-startTime="535">And that's just in the audio </span><span class="line" data-startTime="535">hardware abstraction layer, or </span><span class="line" data-startTime="538">HAL, and the kernel driver. </span><span class="line" data-startTime="540">That doesn't even count the </span><span class="line" data-startTime="540">buffers in the media server, </span><span class="line" data-startTime="543">in the DSP, in the mixer, </span><span class="line" data-startTime="543">certainly not in the </span><span class="line" data-startTime="547">application. </span></p>

<p class="speaker"><span class="line" data-starttime="549"><span class="speakerName">Raph Levien</span>: In case that's </span><span class="line" data-startTime="549">not clear, that's a huge </span><span class="line" data-startTime="551">amount of buffering. </span><span class="line" data-startTime="552">There's 92 milliseconds of </span><span class="line" data-startTime="552">latency right there. </span><span class="line" data-startTime="555">If you're an audio developer, </span><span class="line" data-startTime="555">you've got to be asking </span><span class="line" data-startTime="556">yourself, why are the </span><span class="line" data-startTime="556">buffers so big? </span><span class="line" data-startTime="558">And why are there </span><span class="line" data-startTime="558">so many of them? </span></p>

<p class="speaker"><span class="line" data-starttime="560"><span class="speakerName">Glenn Kasten</span>: So there is a </span><span class="line" data-startTime="560">technical explanation, which </span><span class="line" data-startTime="563">we're going to get into today. </span><span class="line" data-startTime="564">But I also think there's a </span><span class="line" data-startTime="564">social explanation, and we'll </span><span class="line" data-startTime="567">hint at it throughout the </span><span class="line" data-startTime="567">talk today, too, also. </span></p>

<p class="speaker"><span class="line" data-starttime="570"><span class="speakerName">Raph Levien</span>: Let's start </span><span class="line" data-startTime="570">with the technical. </span><span class="line" data-startTime="571">It has to do with power </span><span class="line" data-startTime="571">consumption. </span><span class="line" data-startTime="573">The larger the interval between </span><span class="line" data-startTime="573">CPU core wake ups, the </span><span class="line" data-startTime="576">less power needed. </span></p>

<p class="speaker"><span class="line" data-starttime="578"><span class="speakerName">Glenn Kasten</span>: As you </span><span class="line" data-startTime="578">know, mobile </span><span class="line" data-startTime="579">phones run on batteries. </span> <span class="line" data-startTime="581">Batteries have limited life. </span> <span class="line" data-startTime="582">So the CPU switches on and off </span><span class="line" data-startTime="582">very, very frequently between </span><span class="line" data-startTime="586">normal state and low </span><span class="line" data-startTime="586">power state. </span> <span class="line" data-startTime="588">The size of each audio buffer </span><span class="line" data-startTime="588">basically puts a lower bound </span><span class="line" data-startTime="591">on the amount of time that the </span><span class="line" data-startTime="591">CPU can be asleep before it </span><span class="line" data-startTime="594">has to wake up again and process </span><span class="line" data-startTime="594">the next audio buffer. </span> <span class="line" data-startTime="597">To a certain extent, that </span><span class="line" data-startTime="597">defines both your power </span><span class="line" data-startTime="601">consumption and your </span><span class="line" data-startTime="601">potential latency. </span> <span class="line" data-startTime="604">And if you want to reduce power, </span><span class="line" data-startTime="604">you have to add more </span><span class="line" data-startTime="607">buffering so the CPU doesn't </span><span class="line" data-startTime="607">have to wake up as often. </span> <span class="line" data-startTime="611">As for the social component, my </span><span class="line" data-startTime="611">theory is that buffering is </span><span class="line" data-startTime="614">just a really quick and easy </span><span class="line" data-startTime="614">way to fix audio glitches. </span> <span class="line" data-startTime="618">If you hear a glitch, almost </span><span class="line" data-startTime="618">always it seems that if you </span><span class="line" data-startTime="621">just make your buffers bigger, </span><span class="line" data-startTime="621">it'll make it go away. </span> <span class="line" data-startTime="625">And unless you actively police </span><span class="line" data-startTime="625">buffer sizes, they're going to </span><span class="line" data-startTime="629">continue to increase </span><span class="line" data-startTime="629">over time. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="631"><span class="speakerName">Raph Levien</span>: And other than a </span><span class="line" data-startTime="631">devoted band of developers, </span><span class="line" data-startTime="633">like you and me, it didn't </span><span class="line" data-startTime="633">seem like anyone in the </span><span class="line" data-startTime="636">Android world has had a </span><span class="line" data-startTime="636">compelling incentive to reduce </span><span class="line" data-startTime="639">buffer sizes. </span><span class="line" data-startTime="640">I think a lot of us suspected </span><span class="line" data-startTime="640">that there wasn't actually any </span><span class="line" data-startTime="642">particularly good reason </span><span class="line" data-startTime="642">for latency to be </span><span class="line" data-startTime="644">as high as it was. </span><span class="line" data-startTime="645">Maybe the buffers were just </span><span class="line" data-startTime="645">bigger than they had to be. </span></p>

<p class="speaker"><span class="line" data-starttime="648"><span class="speakerName">Glenn Kasten</span>: Sounds </span><span class="line" data-startTime="648">simple, huh? </span><span class="line" data-startTime="650">Well, this turned out </span><span class="line" data-startTime="650">to be a pretty easy </span><span class="line" data-startTime="652">hypothesis to disprove. </span><span class="line" data-startTime="655">I tried an experiment. </span><span class="line" data-startTime="656">Remember, we started with </span><span class="line" data-startTime="656">four buffers of 23 </span><span class="line" data-startTime="658">milliseconds each. </span><span class="line" data-startTime="659">So I just said, OK, let's </span><span class="line" data-startTime="659">make them smaller. </span><span class="line" data-startTime="662">Let's have fewer of them. </span><span class="line" data-startTime="663">Instead of four of 23, I went </span><span class="line" data-startTime="663">down to two of 12 or 13, then </span><span class="line" data-startTime="667">two of six. </span><span class="line" data-startTime="668">And eventually, on one device, I </span><span class="line" data-startTime="668">was even able to get down to </span><span class="line" data-startTime="670">two buffers of three </span><span class="line" data-startTime="670">milliseconds. </span><span class="line" data-startTime="672">I didn't try to change the </span><span class="line" data-startTime="672">system architecture or </span><span class="line" data-startTime="674">anything else, just </span><span class="line" data-startTime="674">the buffers. </span><span class="line" data-startTime="676">And amazingly, it worked. </span><span class="line" data-startTime="682">Audio still played. </span><span class="line" data-startTime="683">The latency went down </span><span class="line" data-startTime="683">dramatically. </span><span class="line" data-startTime="685">I was done. </span></p>

<p class="speaker"><span class="line" data-starttime="687"><span class="speakerName">Raph Levien</span>: You were done? </span><span class="line" data-startTime="689">Are you sure? </span></p>

<p class="speaker"><span class="line" data-starttime="689"><span class="speakerName">Glenn Kasten</span>: Well, you knew the </span><span class="line" data-startTime="689">talk wouldn't be over now. </span><span class="line" data-startTime="694">It did work most of the time. </span><span class="line" data-startTime="696">But every once in awhile, </span><span class="line" data-startTime="696">I heard a </span><span class="line" data-startTime="698">click, a pop, an underrun. </span><span class="line" data-startTime="701">And this really did make </span><span class="line" data-startTime="701">me sick to my stomach. </span><span class="line" data-startTime="704">I know it's hard for me to </span><span class="line" data-startTime="704">show it today, but I felt </span><span class="line" data-startTime="708">awful every time I heard </span><span class="line" data-startTime="708">those clicks. </span><span class="line" data-startTime="710">And I knew this was not </span><span class="line" data-startTime="710">going to be so easy. </span></p>

<p class="speaker"><span class="line" data-starttime="712"><span class="speakerName">Raph Levien</span>: And I've have </span><span class="line" data-startTime="712">a lot of experience with </span><span class="line" data-startTime="714">underruns myself. </span><span class="line" data-startTime="715">I heard them on my synthesizer </span><span class="line" data-startTime="715">when I had </span><span class="line" data-startTime="717">too many voices playing. </span><span class="line" data-startTime="718">I think it's worth talking a </span><span class="line" data-startTime="718">little bit about the methods </span><span class="line" data-startTime="721">we used to detect them. </span></p>

<p class="speaker"><span class="line" data-starttime="723"><span class="speakerName">Glenn Kasten</span>: Definitely. </span><span class="line" data-startTime="723">But first, let's listen to </span><span class="line" data-startTime="723">some underruns together. </span><span class="line" data-startTime="727">Don't worry. </span><span class="line" data-startTime="727">It's only a few seconds, but we </span><span class="line" data-startTime="727">want all of us to use the </span><span class="line" data-startTime="731">same terminology. </span><span class="line" data-startTime="732">In this clip, we're going </span><span class="line" data-startTime="732">to first hear </span><span class="line" data-startTime="734">a few shorter clicks. </span><span class="line" data-startTime="735">Followed by some longer </span><span class="line" data-startTime="735">dropouts. </span><span class="line" data-startTime="738">They're all underruns. </span><span class="line" data-startTime="740">[MUSIC PLAYING] </span></p>

<p class="speaker"><span class="line" data-starttime="758"><span class="speakerName">Glenn Kasten</span>: Did everybody </span><span class="line" data-startTime="758">hear those? </span><span class="line" data-startTime="761">We're a little worried, because </span><span class="line" data-startTime="761">in a room this large, </span><span class="line" data-startTime="763">there's quite a bit of reverb. </span><span class="line" data-startTime="764">And what Raph and I have found </span><span class="line" data-startTime="764">is that when you're listening </span><span class="line" data-startTime="768">with speakers, and especially </span><span class="line" data-startTime="768">in a room with a lot of </span><span class="line" data-startTime="771">reverb, that it's harder to </span><span class="line" data-startTime="771">hear those underruns. </span><span class="line" data-startTime="774">So that's one reason why we </span><span class="line" data-startTime="774">personally prefer to listen </span><span class="line" data-startTime="777">for audio problems </span><span class="line" data-startTime="777">with headphones. </span><span class="line" data-startTime="778">Or as you'll soon see, we </span><span class="line" data-startTime="778">actually like to look for them </span><span class="line" data-startTime="781">visually, too. </span><span class="line" data-startTime="786">So we heard the underruns. </span><span class="line" data-startTime="788">Let's look at them visually. </span><span class="line" data-startTime="789">I mentioned we were going to. </span><span class="line" data-startTime="791">Here is a long 15 millisecond </span><span class="line" data-startTime="791">underrun in the audio editor </span><span class="line" data-startTime="794">tool called Audacity. </span></p>

<p class="speaker"><span class="line" data-starttime="796"><span class="speakerName">Raph Levien</span>: Those long </span><span class="line" data-startTime="796">underruns are </span><span class="line" data-startTime="797">pretty easy to spot. </span></p>

<p class="speaker"><span class="line" data-starttime="799"><span class="speakerName">Glenn Kasten</span>: Yeah, but </span><span class="line" data-startTime="799">unfortunately, I wasn't just </span><span class="line" data-startTime="800">hearing those long ones. </span><span class="line" data-startTime="801">I was also hearing </span><span class="line" data-startTime="801">short clicks. </span><span class="line" data-startTime="803">And those were really hard </span><span class="line" data-startTime="803">to find with Audacity. </span><span class="line" data-startTime="808">Here's one here. </span><span class="line" data-startTime="809">This is only 64 frames, I </span><span class="line" data-startTime="809">believe, which is 1 and 1/2 </span><span class="line" data-startTime="812">milliseconds, I think at either </span><span class="line" data-startTime="812">44 or 48 kilohertz. </span><span class="line" data-startTime="817">And it took me a long time </span><span class="line" data-startTime="817">to find this one. </span><span class="line" data-startTime="819">I just didn't have </span><span class="line" data-startTime="819">the patience to </span><span class="line" data-startTime="821">keep looking for these. </span></p>

<p class="speaker"><span class="line" data-starttime="822"><span class="speakerName">Raph Levien</span>: Yeah, they're </span><span class="line" data-startTime="822">tricky to spot in time domain. </span><span class="line" data-startTime="824">But in the frequency domain, </span><span class="line" data-startTime="824">underruns pop out. </span><span class="line" data-startTime="827">Here's that same area after </span><span class="line" data-startTime="827">a Fourier transform. </span><span class="line" data-startTime="830">See those spikes on the right? </span><span class="line" data-startTime="831">Those regularly spaced </span><span class="line" data-startTime="831">spikes mean trouble. </span><span class="line" data-startTime="834">You use Frequency Domain View, </span><span class="line" data-startTime="834">and then you can binary search </span><span class="line" data-startTime="837">to help zoom in on the </span><span class="line" data-startTime="837">shortest underruns. </span></p>

<p class="speaker"><span class="line" data-starttime="840"><span class="speakerName">Glenn Kasten</span>: So let's </span><span class="line" data-startTime="840">get back to my </span><span class="line" data-startTime="841">problem, my latency problem. </span><span class="line" data-startTime="843">I notice that when I reduced </span><span class="line" data-startTime="843">buffer sizes, the latency went </span><span class="line" data-startTime="845">down, but I also was hearing </span><span class="line" data-startTime="845">these clicks. </span></p>

<p class="speaker"><span class="line" data-starttime="848"><span class="speakerName">Raph Levien</span>: So we were wrong. </span><span class="line" data-startTime="849">The buffers were just about as </span><span class="line" data-startTime="849">big as they had to be to keep </span><span class="line" data-startTime="852">the audio from glitching. </span><span class="line" data-startTime="854">They weren't just about </span><span class="line" data-startTime="854">saving power. </span><span class="line" data-startTime="855">They were also keeping </span><span class="line" data-startTime="855">it clean. </span><span class="line" data-startTime="857">GLENN KASTEN: </span></p>

<p class="speaker"><span class="line" data-starttime="857"><span class="speakerName">Glenn Kasten</span>: Now we needed to </span><span class="line" data-startTime="857">figure out why, why those </span><span class="line" data-startTime="860">glitches were happening. </span><span class="line" data-startTime="861">And while I was working on the </span><span class="line" data-startTime="861">system problem, it turned out </span><span class="line" data-startTime="864">Raph had also collected some </span><span class="line" data-startTime="864">data of his own, which we're </span><span class="line" data-startTime="866">going to look at right now. </span></p>

<p class="speaker"><span class="line" data-starttime="868"><span class="speakerName">Raph Levien</span>: That's right. </span><span class="line" data-startTime="868">Isn't this beautiful? </span><span class="line" data-startTime="870">Maybe I should take a couple </span><span class="line" data-startTime="870">of minutes and explain what </span><span class="line" data-startTime="872">this plot is showing. </span><span class="line" data-startTime="874">What I was measuring is the </span><span class="line" data-startTime="874">start time and the end time of </span><span class="line" data-startTime="877">every open SL callback. </span><span class="line" data-startTime="879">This is by far the most useful </span><span class="line" data-startTime="879">information you can log. </span><span class="line" data-startTime="882">At first, I was doing this to </span><span class="line" data-startTime="882">profile how long my own code </span><span class="line" data-startTime="885">took to run. </span><span class="line" data-startTime="885">But I ended up learning </span><span class="line" data-startTime="885">a lot about how the </span><span class="line" data-startTime="887">system worked as well. </span><span class="line" data-startTime="889">So let's start with a little </span><span class="line" data-startTime="889">bit of background. </span></p>

<p class="speaker"><span class="line" data-starttime="892"><span class="speakerName">Glenn Kasten</span>: So we used Open </span><span class="line" data-startTime="892">SLES from Cronos Group. </span><span class="line" data-startTime="896">And in our implementation, the </span><span class="line" data-startTime="896">audio runs on a separate </span><span class="line" data-startTime="900">thread inside of your </span><span class="line" data-startTime="900">application process. </span><span class="line" data-startTime="902">And the thread runs in a tight </span><span class="line" data-startTime="902">little loop that looks a lot </span><span class="line" data-startTime="904">like a helix, like a spring. </span><span class="line" data-startTime="907">Each time through the loop, our </span><span class="line" data-startTime="907">Open SLES implementation </span><span class="line" data-startTime="910">will call your buffer completion </span><span class="line" data-startTime="910">callback handler to </span><span class="line" data-startTime="914">generate the next buffer. </span></p>

<p class="speaker"><span class="line" data-starttime="915"><span class="speakerName">Raph Levien</span>: The time between </span><span class="line" data-startTime="915">two successive callbacks is </span><span class="line" data-startTime="918">the cycle time. </span></p>

<p class="speaker"><span class="line" data-starttime="919"><span class="speakerName">Glenn Kasten</span>: And ideally, </span><span class="line" data-startTime="919">the cycle time should be </span><span class="line" data-startTime="920">consistent. </span><span class="line" data-startTime="921">In part, it should be equal </span><span class="line" data-startTime="921">to the size of one buffer. </span></p>

<p class="speaker"><span class="line" data-starttime="925"><span class="speakerName">Raph Levien</span>: So in an ideal </span><span class="line" data-startTime="925">world, if we plotted the </span><span class="line" data-startTime="927">callback time against the </span><span class="line" data-startTime="927">expected callback time, we'd </span><span class="line" data-startTime="930">see a perfectly straight line. </span> <span class="line" data-startTime="931">Of course, nothing is perfect. </span> <span class="line" data-startTime="933">If we plot the time that </span><span class="line" data-startTime="933">callbacks actually arrive </span><span class="line" data-startTime="935">against the expected time of </span><span class="line" data-startTime="935">arrival, we're going to see </span><span class="line" data-startTime="937">some deviations. </span> <span class="line" data-startTime="939">Each little squiggle in this </span><span class="line" data-startTime="939">graph represents a deviation </span><span class="line" data-startTime="942">from the ideal callback </span><span class="line" data-startTime="942">timing. </span> <span class="line" data-startTime="944">But to tell the truth, I have </span><span class="line" data-startTime="944">a hard time using this graph </span><span class="line" data-startTime="946">to tell exactly how bad </span><span class="line" data-startTime="946">the deviation is. </span></p>

<p><span class="line" data-startTime="948">Instead, I like to view the </span><span class="line" data-startTime="948">data a little differently. </span> <span class="line" data-startTime="951">Instead of looking at callback </span><span class="line" data-startTime="951">times, I just look at how </span><span class="line" data-startTime="954">early or late each </span><span class="line" data-startTime="954">callback arrived. </span> <span class="line" data-startTime="957">Here, the y-axis is a </span><span class="line" data-startTime="957">measurement of deviation from </span><span class="line" data-startTime="960">ideal timing amplified, so </span><span class="line" data-startTime="960">we can see it better. </span> <span class="line" data-startTime="964">You can think this as </span><span class="line" data-startTime="964">a measurement of </span><span class="line" data-startTime="965">the system's jitter. </span> <span class="line" data-startTime="966">I've also changed the </span><span class="line" data-startTime="966">x-axis a bit. </span> <span class="line" data-startTime="968">Instead of being measured in </span><span class="line" data-startTime="968">time, it's simply a count of </span><span class="line" data-startTime="970">how many callbacks </span><span class="line" data-startTime="970">have arrived. </span></p>

<p><span class="line" data-startTime="972">That way, I can compare the </span><span class="line" data-startTime="972">jitter of two different </span><span class="line" data-startTime="975">systems, even if they </span><span class="line" data-startTime="975">have different </span><span class="line" data-startTime="976">callback cycle times. </span></p>

<p class="speaker"><span class="line" data-starttime="978"><span class="speakerName">Glenn Kasten</span>: So now that we </span><span class="line" data-startTime="978">know how we're measuring and </span><span class="line" data-startTime="980">displaying this jitter, let's </span><span class="line" data-startTime="980">look at some real world data. </span></p>

<p class="speaker"><span class="line" data-starttime="984"><span class="speakerName">Raph Levien</span>: So this is taken </span><span class="line" data-startTime="984">from a build of Ice Cream </span><span class="line" data-startTime="986">Sandwich that's close to </span><span class="line" data-startTime="986">the one Glenn used. </span></p>

<p class="speaker"><span class="line" data-starttime="989"><span class="speakerName">Glenn Kasten</span>: It looks </span><span class="line" data-startTime="989">interesting. </span><span class="line" data-startTime="991">But why does it slope down </span><span class="line" data-startTime="991">and to the right? </span></p>

<p class="speaker"><span class="line" data-starttime="993"><span class="speakerName">Raph Levien</span>: That downward trend </span><span class="line" data-startTime="993">is actually a difference </span><span class="line" data-startTime="997">in timing between the audio </span><span class="line" data-startTime="997">clock and the system clock. </span><span class="line" data-startTime="1000">So let's look at the </span><span class="line" data-startTime="1000">corrected version. </span><span class="line" data-startTime="1003">Now remember an ideal system </span><span class="line" data-startTime="1003">would show all zeros on the </span><span class="line" data-startTime="1006">y-axis, meaning that every </span><span class="line" data-startTime="1006">buffer completion callback had </span><span class="line" data-startTime="1009">arrived exactly on time. </span><span class="line" data-startTime="1010">Of course, no system </span><span class="line" data-startTime="1010">is perfect. </span><span class="line" data-startTime="1012">So what you'd expect to see in a </span><span class="line" data-startTime="1012">good, real world system is a </span><span class="line" data-startTime="1015">tight cluster of values right </span><span class="line" data-startTime="1015">around the zero mark. </span></p>

<p class="speaker"><span class="line" data-starttime="1019"><span class="speakerName">Glenn Kasten</span>: It looks kind of </span><span class="line" data-startTime="1019">like that, mostly, at least </span><span class="line" data-startTime="1023">the green part. </span></p>

<p class="speaker"><span class="line" data-starttime="1025"><span class="speakerName">Raph Levien</span>: Yeah, but you also </span><span class="line" data-startTime="1025">see a lot of callbacks </span><span class="line" data-startTime="1028">arriving five or 10 </span><span class="line" data-startTime="1028">milliseconds late. </span><span class="line" data-startTime="1030">That's manageable, even </span><span class="line" data-startTime="1030">if it's not ideal. </span></p>

<p class="speaker"><span class="line" data-starttime="1033"><span class="speakerName">Glenn Kasten</span>: But I don't like </span><span class="line" data-startTime="1033">those red ones there, </span><span class="line" data-startTime="1035">especially at the beginning &mdash; </span><span class="line" data-startTime="1037">those outliers. </span><span class="line" data-startTime="1038">They look like 20, 30, </span><span class="line" data-startTime="1038">35 milliseconds late. </span></p>

<p class="speaker"><span class="line" data-starttime="1043"><span class="speakerName">Raph Levien</span>: Dang. </span><span class="line" data-startTime="1043">That's with those giant buffers </span><span class="line" data-startTime="1043">were for, not just to </span><span class="line" data-startTime="1047">save power, but to cover for the </span><span class="line" data-startTime="1047">fact that the audio system </span><span class="line" data-startTime="1050">was delivering some of these </span><span class="line" data-startTime="1050">callbacks really late. </span></p>

<p class="speaker"><span class="line" data-starttime="1053"><span class="speakerName">Glenn Kasten</span>: Now, this really </span><span class="line" data-startTime="1053">bothered me, because Android </span><span class="line" data-startTime="1055">is not a real time system. </span> <span class="line" data-startTime="1056">But we had configured the thread </span><span class="line" data-startTime="1056">priorities for audio to </span><span class="line" data-startTime="1060">be nice little minus 19 for the </span><span class="line" data-startTime="1060">system mixer and then nice </span><span class="line" data-startTime="1064">little minus 16 for application </span><span class="line" data-startTime="1064">threads. </span> <span class="line" data-startTime="1067">And the schedule really should </span><span class="line" data-startTime="1067">not have been doing this. </span> <span class="line" data-startTime="1070">It just didn't make sense. </span> <span class="line" data-startTime="1073">Just to give you background on </span><span class="line" data-startTime="1073">nice values, basically, if </span><span class="line" data-startTime="1076">this pie is all the available </span><span class="line" data-startTime="1076">CPU time, than numerically low </span><span class="line" data-startTime="1080">or nice values, like minus 19 </span><span class="line" data-startTime="1080">and minus 16 should get more </span><span class="line" data-startTime="1083">of the CPU pie. </span> <span class="line" data-startTime="1084">And they should be scheduled </span><span class="line" data-startTime="1084">on a regular cadence, not </span><span class="line" data-startTime="1088">waiting 10s of milliseconds </span><span class="line" data-startTime="1088">and certainly not 35. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="1091"><span class="speakerName">Raph Levien</span>: So those jitter </span><span class="line" data-startTime="1091">outliers who saw in the </span><span class="line" data-startTime="1093">previous slide, those are going </span><span class="line" data-startTime="1093">to cause underruns. </span><span class="line" data-startTime="1095">What was happening in the </span><span class="line" data-startTime="1095">system to cause them? </span></p>

<p class="speaker"><span class="line" data-starttime="1097"><span class="speakerName">Glenn Kasten</span>: That's exactly </span><span class="line" data-startTime="1097">what I wanted to know. </span> <span class="line" data-startTime="1100">So I dug a lot deeper. </span> <span class="line" data-startTime="1101">Now, I'm not a Linux Kernel </span><span class="line" data-startTime="1101">expert, but I do have a </span><span class="line" data-startTime="1104">background in real time </span><span class="line" data-startTime="1104">operating systems. </span> <span class="line" data-startTime="1105">I used to write real </span><span class="line" data-startTime="1105">time Kernels. </span> <span class="line" data-startTime="1107">And so I feel very comfortable </span><span class="line" data-startTime="1107">jumping in and doing some </span><span class="line" data-startTime="1110">system measurements at </span><span class="line" data-startTime="1110">the current level. </span> <span class="line" data-startTime="1112">At the time, we didn't have the </span><span class="line" data-startTime="1112">sys trace tool, which you </span><span class="line" data-startTime="1115">may have heard of. </span> <span class="line" data-startTime="1116">And I didn't know about the </span><span class="line" data-startTime="1116">existing Linux tools for </span><span class="line" data-startTime="1120">tracing, like f trace. </span> <span class="line" data-startTime="1121">So instead, I just built </span><span class="line" data-startTime="1121">my own custom </span><span class="line" data-startTime="1123">context switch tracer. </span> <span class="line" data-startTime="1125">This is what it looked like. </span></p>

<p><span class="line" data-startTime="1127">Basically, every time there was </span><span class="line" data-startTime="1127">a context switch, it would </span><span class="line" data-startTime="1129">log information about </span><span class="line" data-startTime="1129">this context </span><span class="line" data-startTime="1132">switch into a ring buffer. </span> <span class="line" data-startTime="1133">The information was basically </span><span class="line" data-startTime="1133">the next thread about to run </span><span class="line" data-startTime="1136">and whatever was the current </span><span class="line" data-startTime="1136">system monotonic time. </span> <span class="line" data-startTime="1141">Then what I would do is </span><span class="line" data-startTime="1141">I would play audio. </span> <span class="line" data-startTime="1143">And at the same time, I would </span><span class="line" data-startTime="1143">run my context switch tracer. </span> <span class="line" data-startTime="1146">And whenever I heard a glitch, </span><span class="line" data-startTime="1146">I would look and see what was </span><span class="line" data-startTime="1150">happening in the system at </span><span class="line" data-startTime="1150">the time of that glitch. </span> <span class="line" data-startTime="1152">And it took me a long, </span><span class="line" data-startTime="1152">long time. </span> <span class="line" data-startTime="1155">But eventually, I found </span><span class="line" data-startTime="1155">what looked to me to </span><span class="line" data-startTime="1157">be the smoking gun. </span></p>

<p class="speaker"><span class="line" data-starttime="1163"><span class="speakerName">Raph Levien</span>: This an excerpt of </span><span class="line" data-startTime="1163">Glenn's context switch log. </span><span class="line" data-startTime="1166">The first 12 lines are exactly </span><span class="line" data-startTime="1166">what we want to see. </span><span class="line" data-startTime="1168">The playback thread and the </span><span class="line" data-startTime="1168">audio track thread wake up, do </span><span class="line" data-startTime="1171">their thing, and then go back to </span><span class="line" data-startTime="1171">sleep on a regular cadence. </span><span class="line" data-startTime="1173">Those last four lines </span><span class="line" data-startTime="1173">look wrong. </span></p>

<p class="speaker"><span class="line" data-starttime="1176"><span class="speakerName">Glenn Kasten</span>: And by the </span><span class="line" data-startTime="1176">way, this is real data. </span><span class="line" data-startTime="1177">All the data you're seeing </span><span class="line" data-startTime="1177">here today is real. </span><span class="line" data-startTime="1180">This was the smoking gun. </span><span class="line" data-startTime="1182">So let's look at that same data </span><span class="line" data-startTime="1182">as a sequence diagram. </span></p>

<p class="speaker"><span class="line" data-starttime="1185"><span class="speakerName">Raph Levien</span>: You can see the </span><span class="line" data-startTime="1185">pattern here &mdash; first, playback </span><span class="line" data-startTime="1187">runs, then audio track </span><span class="line" data-startTime="1187">runs, and then </span><span class="line" data-startTime="1189">lather, rinse, and repeat. </span> <span class="line" data-startTime="1191">But what happens near the </span><span class="line" data-startTime="1191">end of the trace? </span><span class="line" data-startTime="1193">Right when the playback thread </span><span class="line" data-startTime="1193">was supposed to wake up, </span><span class="line" data-startTime="1195">another task gets scheduled </span><span class="line" data-startTime="1195">instead. </span> <span class="line" data-startTime="1197">This is in spite of the fact </span><span class="line" data-startTime="1197">that the audio has a higher </span><span class="line" data-startTime="1200">priority &mdash; nice minus 19. </span> <span class="line" data-startTime="1201">How could that have happened? </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="1202"><span class="speakerName">Glenn Kasten</span>: Well, it all comes </span><span class="line" data-startTime="1202">down to a Linux Kernel </span><span class="line" data-startTime="1204">module, which is called </span><span class="line" data-startTime="1204">the completely fair </span><span class="line" data-startTime="1206">scheduler, or CFS. </span><span class="line" data-startTime="1209">Earlier, I showed this </span><span class="line" data-startTime="1209">slide showing nice </span><span class="line" data-startTime="1211">values in the CPU pie. </span><span class="line" data-startTime="1212">If you look really closely, </span><span class="line" data-startTime="1212">there's a very important </span><span class="line" data-startTime="1215">caveat there. </span><span class="line" data-startTime="1216">It says huge oversimplification. </span><span class="line" data-startTime="1219">Nice values are not </span><span class="line" data-startTime="1219">a quota system. </span></p>

<p class="speaker"><span class="line" data-starttime="1221"><span class="speakerName">Raph Levien</span>: The CFS scheduler </span><span class="line" data-startTime="1221">allocates CPU time fairly and </span><span class="line" data-startTime="1225">proportionally to the nice </span><span class="line" data-startTime="1225">level in the long term. </span><span class="line" data-startTime="1228">But it does not guarantee </span><span class="line" data-startTime="1228">wake up time. </span><span class="line" data-startTime="1232">In these two timing diagrams, </span><span class="line" data-startTime="1232">the dark bars ar e audio </span><span class="line" data-startTime="1235">threads, and the light bars </span><span class="line" data-startTime="1235">are other threads. </span><span class="line" data-startTime="1237">To CFS, the top and bottom </span><span class="line" data-startTime="1237">diagrams are completely </span><span class="line" data-startTime="1240">equivalent, but to an </span><span class="line" data-startTime="1240">audio programmer, </span><span class="line" data-startTime="1242">they're completely different. </span><span class="line" data-startTime="1243">We want the pattern on top. </span></p>

<p class="speaker"><span class="line" data-starttime="1249"><span class="speakerName">Glenn Kasten</span>: So I tried </span><span class="line" data-startTime="1249">working around CFS. </span><span class="line" data-startTime="1252">CFS has a lot of tuning </span><span class="line" data-startTime="1252">parameters. </span><span class="line" data-startTime="1254">The most important one is the </span><span class="line" data-startTime="1254">scheduling interval or </span><span class="line" data-startTime="1258">scheduling quantum. </span><span class="line" data-startTime="1259">There are other parameters, </span><span class="line" data-startTime="1259">such as how often it will </span><span class="line" data-startTime="1262">check for fairness. </span><span class="line" data-startTime="1263">And when I turned those down to </span><span class="line" data-startTime="1263">really small numbers, I was </span><span class="line" data-startTime="1266">able to get rid of most of </span><span class="line" data-startTime="1266">the audio underruns. </span><span class="line" data-startTime="1269">But it turned out that all that </span><span class="line" data-startTime="1269">messing around with CFS </span><span class="line" data-startTime="1271">parameter used a </span><span class="line" data-startTime="1271">lot more power. </span><span class="line" data-startTime="1274">And even worse, it caused the </span><span class="line" data-startTime="1274">overall system throughput for </span><span class="line" data-startTime="1277">non-audio threads to </span><span class="line" data-startTime="1277">go down because of </span><span class="line" data-startTime="1279">excessive context switching. </span><span class="line" data-startTime="1281">And worst of all, it didn't even </span><span class="line" data-startTime="1281">solve my audio underrun </span><span class="line" data-startTime="1285">problem completely. </span><span class="line" data-startTime="1286">It just reduced the frequency. </span></p>

<p class="speaker"><span class="line" data-starttime="1289"><span class="speakerName">Raph Levien</span>: The most effective </span><span class="line" data-startTime="1289">tweaks just reduce </span><span class="line" data-startTime="1291">the time slice that each </span><span class="line" data-startTime="1291">thread gets before the </span><span class="line" data-startTime="1292">scheduler reevaluates. </span><span class="line" data-startTime="1294">It doesn't change the core </span><span class="line" data-startTime="1294">algorithm, which is to try to </span><span class="line" data-startTime="1296">be fair to every thread. </span><span class="line" data-startTime="1298">But in our case, we don't </span><span class="line" data-startTime="1298">want to be fair. </span><span class="line" data-startTime="1300">We want audio to go to the front </span><span class="line" data-startTime="1300">of the line every time. </span><span class="line" data-startTime="1303">Reducing the time slice just </span><span class="line" data-startTime="1303">causes more content switching, </span><span class="line" data-startTime="1305">which uses more power. </span></p>

<p class="speaker"><span class="line" data-starttime="1307"><span class="speakerName">Glenn Kasten</span>: So from my real </span><span class="line" data-startTime="1307">time operating system </span><span class="line" data-startTime="1309">background working on kernels, </span><span class="line" data-startTime="1309">I knew about fixed priority </span><span class="line" data-startTime="1311">scheduling &mdash; </span><span class="line" data-startTime="1312">it's a very old concept &mdash; </span><span class="line" data-startTime="1313">and I desperately wanted </span><span class="line" data-startTime="1313">to use it. </span><span class="line" data-startTime="1316">The basic idea is that you </span><span class="line" data-startTime="1316">always run the highest </span><span class="line" data-startTime="1319">priority ready to run task, </span><span class="line" data-startTime="1319">no matter what. </span><span class="line" data-startTime="1321">And if you assign your </span><span class="line" data-startTime="1321">priorities correctly and </span><span class="line" data-startTime="1325">appropriately, your system will </span><span class="line" data-startTime="1325">work, no matter what. </span></p>

<p class="speaker"><span class="line" data-starttime="1328"><span class="speakerName">Raph Levien</span>: In Linux, this </span><span class="line" data-startTime="1328">means using a scheduling </span><span class="line" data-startTime="1330">policy called SCHED FIFO. </span><span class="line" data-startTime="1331">A lot of audio developers know </span><span class="line" data-startTime="1331">about SCHED FIFO, and we know </span><span class="line" data-startTime="1334">that there are plenty of Linux </span><span class="line" data-startTime="1334">desktop programs that use it, </span><span class="line" data-startTime="1337">and Android apps that try. </span><span class="line" data-startTime="1339">But it doesn't work </span><span class="line" data-startTime="1339">in Android. </span><span class="line" data-startTime="1340">On Ice Cream Sandwich, </span><span class="line" data-startTime="1340">it did nothing. </span><span class="line" data-startTime="1342">And in Jelly Bean, been asking </span><span class="line" data-startTime="1342">for SCHED FIFO causes thread </span><span class="line" data-startTime="1344">creation to fail. </span></p>

<p class="speaker"><span class="line" data-starttime="1346"><span class="speakerName">Glenn Kasten</span>: That's because </span><span class="line" data-startTime="1346">we disabled it </span><span class="line" data-startTime="1348">for user mode threads. </span></p>

<p class="speaker"><span class="line" data-starttime="1349"><span class="speakerName">Raph Levien</span>: Why did </span><span class="line" data-startTime="1349">you do that? </span></p>

<p class="speaker"><span class="line" data-starttime="1351"><span class="speakerName">Glenn Kasten</span>: Not me. </span> <span class="line" data-startTime="1352">Our assistant team was afraid of </span><span class="line" data-startTime="1352">denial of service, because </span><span class="line" data-startTime="1355">basically, one errant SCHED FIFO </span><span class="line" data-startTime="1355">thread could hog the CPU </span><span class="line" data-startTime="1359">and take down the </span><span class="line" data-startTime="1359">whole system. </span> <span class="line" data-startTime="1360">And yet we still handled </span><span class="line" data-startTime="1360">our callbacks on time. </span> <span class="line" data-startTime="1364">So I went back to our system </span><span class="line" data-startTime="1364">team, and I tried to make </span><span class="line" data-startTime="1367">another case for SCHED FIFO. </span> <span class="line" data-startTime="1373">I showed them slides with </span><span class="line" data-startTime="1373">numbers and statistics and </span><span class="line" data-startTime="1376">power measurements. </span> <span class="line" data-startTime="1377">And this time, they sent me a </span><span class="line" data-startTime="1377">buddy, a Kernel expert named </span><span class="line" data-startTime="1380">Dima, who you may </span><span class="line" data-startTime="1380">run into today. </span> <span class="line" data-startTime="1384">He's here. </span></p>

<p><span class="line" data-startTime="1384">Dima helped me navigate the </span><span class="line" data-startTime="1384">issue and figure out how to </span><span class="line" data-startTime="1387">mitigate the denial </span><span class="line" data-startTime="1387">of service risk. </span> <span class="line" data-startTime="1389">The answer turned out to be </span><span class="line" data-startTime="1389">based on a Kernel feature that </span><span class="line" data-startTime="1391">actually Google started working </span><span class="line" data-startTime="1391">on several years ago </span><span class="line" data-startTime="1393">in 2006 called Control </span><span class="line" data-startTime="1393">Groups, or C Groups. </span></p>

<p class="speaker"><span class="line" data-starttime="1397"><span class="speakerName">Raph Levien</span>: Cgroups is </span><span class="line" data-startTime="1397">a system for resource </span><span class="line" data-startTime="1399">accounting. </span><span class="line" data-startTime="1399">You can use it for all kinds </span><span class="line" data-startTime="1399">of things, like setting CPU </span><span class="line" data-startTime="1401">and memory quotas for different </span><span class="line" data-startTime="1401">processes or </span><span class="line" data-startTime="1403">charging for cloud servers </span><span class="line" data-startTime="1403">by the CPU hour. </span><span class="line" data-startTime="1406">In the case of Android, it lets </span><span class="line" data-startTime="1406">us prevent audio threads </span><span class="line" data-startTime="1409">from ever exceeding </span><span class="line" data-startTime="1409">its CPU budget. </span><span class="line" data-startTime="1411">And that mitigates the denial </span><span class="line" data-startTime="1411">of service attack. </span></p>

<p class="speaker"><span class="line" data-starttime="1415"><span class="speakerName">Glenn Kasten</span>: So in the end, the </span><span class="line" data-startTime="1415">system team did agree we </span><span class="line" data-startTime="1417">could run audio threads at a </span><span class="line" data-startTime="1417">fixed priority if we used </span><span class="line" data-startTime="1420">Cgroups to stay within the </span><span class="line" data-startTime="1420">budget they gave us, which was </span><span class="line" data-startTime="1423">a whopping 5% of the CPU. </span><span class="line" data-startTime="1427">Later on, we got that budget </span><span class="line" data-startTime="1427">increased, but actually </span><span class="line" data-startTime="1429">starting with only 5% turned </span><span class="line" data-startTime="1429">out to be a really good </span><span class="line" data-startTime="1432">constraint for us. </span><span class="line" data-startTime="1434">It forced us to reduce the CPU </span><span class="line" data-startTime="1434">footprint of the audio system. </span></p>

<p class="speaker"><span class="line" data-starttime="1438"><span class="speakerName">Raph Levien</span>: Keep that number </span><span class="line" data-startTime="1438">in mind for later. </span><span class="line" data-startTime="1440">For now, it's important to </span><span class="line" data-startTime="1440">understand that SCHED FIFO </span><span class="line" data-startTime="1442">priority only applies to threads </span><span class="line" data-startTime="1442">that are created by </span><span class="line" data-startTime="1445">the audio system. </span><span class="line" data-startTime="1445">You can't do it for </span><span class="line" data-startTime="1445">your own threads. </span><span class="line" data-startTime="1448">So that means if you want the </span><span class="line" data-startTime="1448">lowest latency, you need to </span><span class="line" data-startTime="1450">run your audio code on </span><span class="line" data-startTime="1450">an audio thread. </span><span class="line" data-startTime="1453">In practice, that means you need </span><span class="line" data-startTime="1453">to do your processing in </span><span class="line" data-startTime="1455">a buffer callback. </span><span class="line" data-startTime="1457">That means writing your </span><span class="line" data-startTime="1457">sound engine in C++ </span><span class="line" data-startTime="1459">and using Open SLES. </span><span class="line" data-startTime="1461">And of course, not doing your </span><span class="line" data-startTime="1461">engine in Java means you don't </span><span class="line" data-startTime="1464">have to worry about pauses from </span><span class="line" data-startTime="1464">the Garbage Collector. </span></p>

<p class="speaker"><span class="line" data-starttime="1466"><span class="speakerName">Glenn Kasten</span>: But you are still </span><span class="line" data-startTime="1466">subject to the audio </span><span class="line" data-startTime="1468">Cgroup budget. </span><span class="line" data-startTime="1470">We'll discuss budgets </span><span class="line" data-startTime="1470">later on. </span><span class="line" data-startTime="1472">But first, Raph, show us </span><span class="line" data-startTime="1472">some more numbers. </span></p>

<p class="speaker"><span class="line" data-starttime="1474"><span class="speakerName">Raph Levien</span>: Sure. </span><span class="line" data-startTime="1475">Let's see how well that change </span><span class="line" data-startTime="1475">to SCHED FIFO worked. </span><span class="line" data-startTime="1478">This is a little misleading. </span><span class="line" data-startTime="1479">But the build I measured </span><span class="line" data-startTime="1479">contains some other fixes </span><span class="line" data-startTime="1484">besides SCHED FIFO. </span><span class="line" data-startTime="1485">But it's essentially accurate. </span><span class="line" data-startTime="1487">You can see that where Ice Cream </span><span class="line" data-startTime="1487">Sandwich jitter was all </span><span class="line" data-startTime="1490">over the place, on Jelly Bean, </span><span class="line" data-startTime="1490">it's clumped in a tight band </span><span class="line" data-startTime="1492">right around zero. </span><span class="line" data-startTime="1493">The problem is solved. </span></p>

<p class="speaker"><span class="line" data-starttime="1495"><span class="speakerName">Glenn Kasten</span>: Woo-hoo! </span><span class="line" data-startTime="1497">Well, not so fast. </span> <span class="line" data-startTime="1499">Remember that in order to get </span><span class="line" data-startTime="1499">that reduction in jitter, we </span><span class="line" data-startTime="1501">had agreed to a really tight </span><span class="line" data-startTime="1501">budget for audio, at the time </span><span class="line" data-startTime="1505">only 5% of the CPU. </span> <span class="line" data-startTime="1507">Unfortunately, when I profiled </span><span class="line" data-startTime="1507">the audio subsystem, on some </span><span class="line" data-startTime="1511">devices, it took longer than </span><span class="line" data-startTime="1511">5% just to run our mixer or </span><span class="line" data-startTime="1514">our sample reconverter </span><span class="line" data-startTime="1514">and audio effects, </span><span class="line" data-startTime="1517">like reverb and EQ. </span> <span class="line" data-startTime="1519">And it looked like I had a </span><span class="line" data-startTime="1519">massive optimization task in </span><span class="line" data-startTime="1522">front of me, because we had that </span><span class="line" data-startTime="1522">5% for his application. </span></p>

<p class="speaker"><span class="line" data-starttime="1526"><span class="speakerName">Raph Levien</span>: And to be fair, </span><span class="line" data-startTime="1526">that subsystem is doing a lot </span><span class="line" data-startTime="1529">of work, especially if effects </span><span class="line" data-startTime="1529">are turned on. </span><span class="line" data-startTime="1530">What was frustrating to </span><span class="line" data-startTime="1530">me is that it was work </span><span class="line" data-startTime="1533">that I didn't want. </span><span class="line" data-startTime="1534">I'm not dependent on any </span><span class="line" data-startTime="1534">one sample rate. </span><span class="line" data-startTime="1536">I can do my own mixing. </span><span class="line" data-startTime="1538">And I spent weeks with a signal </span><span class="line" data-startTime="1538">analyzer determining </span><span class="line" data-startTime="1541">the exact physical properties of </span><span class="line" data-startTime="1541">that synthesizer's digital </span><span class="line" data-startTime="1545">to analog converter hardware to </span><span class="line" data-startTime="1545">build a precise emulation. </span><span class="line" data-startTime="1549">I didn't want to add any </span><span class="line" data-startTime="1549">one size fits all </span><span class="line" data-startTime="1551">effects on top of that. </span></p>

<p class="speaker"><span class="line" data-starttime="1553"><span class="speakerName">Glenn Kasten</span>: My big aha moment </span><span class="line" data-startTime="1553">was when I realized </span><span class="line" data-startTime="1556">that pretty much every audio </span><span class="line" data-startTime="1556">developer feels the same way, </span><span class="line" data-startTime="1559">every developer who's interested </span><span class="line" data-startTime="1559">in low latency </span><span class="line" data-startTime="1561">audio, anyway. </span><span class="line" data-startTime="1563">So instead of trying to optimize </span><span class="line" data-startTime="1563">our system audio </span><span class="line" data-startTime="1567">path, I just bypassed it. </span><span class="line" data-startTime="1569">And I call this the fast path. </span><span class="line" data-startTime="1571">Here's how it works. </span><span class="line" data-startTime="1572">The top section basically </span><span class="line" data-startTime="1572">is running </span><span class="line" data-startTime="1575">under the old CFS scheduler. </span><span class="line" data-startTime="1577">That includes our normal mixer, </span><span class="line" data-startTime="1577">normal track switch, </span><span class="line" data-startTime="1581">support resampling, they support </span><span class="line" data-startTime="1581">mixing, they support </span><span class="line" data-startTime="1584">effects, things like that. </span><span class="line" data-startTime="1586">The bottom is the fast path. </span><span class="line" data-startTime="1587">And here, the low latency </span><span class="line" data-startTime="1587">applications send their audio </span><span class="line" data-startTime="1591">directly into the fast mixer, </span><span class="line" data-startTime="1591">which then drive the hardware </span><span class="line" data-startTime="1596">abstraction layer. </span><span class="line" data-startTime="1597">And they all run under the </span><span class="line" data-startTime="1597">SCHED FIFO policy. </span></p>

<p class="speaker"><span class="line" data-starttime="1601"><span class="speakerName">Raph Levien</span>: And they're </span><span class="line" data-startTime="1601">limited to the </span><span class="line" data-startTime="1603">audio budget of 5%. </span></p>

<p class="speaker"><span class="line" data-starttime="1605"><span class="speakerName">Glenn Kasten</span>: Yeah, 5%. </span><span class="line" data-startTime="1607">We're actually able to negotiate </span><span class="line" data-startTime="1607">that up a little bit </span><span class="line" data-startTime="1609">later, but there still </span><span class="line" data-startTime="1609">is a budget. </span><span class="line" data-startTime="1612">Now remember, earlier we were </span><span class="line" data-startTime="1612">talking about power. </span><span class="line" data-startTime="1615">And one of the reasons why </span><span class="line" data-startTime="1615">buffers were so big was to </span><span class="line" data-startTime="1619">reduce the CPU wake </span><span class="line" data-startTime="1619">up frequency. </span><span class="line" data-startTime="1622">So when we used the low latency </span><span class="line" data-startTime="1622">path, it does increase </span><span class="line" data-startTime="1626">power consumption. </span><span class="line" data-startTime="1627">Fortunately, one of our audio </span><span class="line" data-startTime="1627">engineers, our audio tech </span><span class="line" data-startTime="1630">lead, Eric, added another </span><span class="line" data-startTime="1630">feature called the Deep Buffer </span><span class="line" data-startTime="1634">Path, which is used, for </span><span class="line" data-startTime="1634">example, music playback when </span><span class="line" data-startTime="1637">your phone is in your pocket. </span><span class="line" data-startTime="1639">And that is recommended when </span><span class="line" data-startTime="1639">you're trying to conserve </span><span class="line" data-startTime="1643">power instead of latency. </span></p>

<p class="speaker"><span class="line" data-starttime="1645"><span class="speakerName">Raph Levien</span>: So at this point </span><span class="line" data-startTime="1645">in time, I'd been following </span><span class="line" data-startTime="1647">Glenn's work pretty closely, I </span><span class="line" data-startTime="1647">was very excited to try out </span><span class="line" data-startTime="1650">this new fast path. </span><span class="line" data-startTime="1651">I had just gotten a shiny new </span><span class="line" data-startTime="1651">Nexus 4, so I flashed a build </span><span class="line" data-startTime="1654">onto my device, loaded </span><span class="line" data-startTime="1654">up my synthesizer, </span><span class="line" data-startTime="1656">and nothing, no change. </span></p>

<p class="speaker"><span class="line" data-starttime="1659"><span class="speakerName">Glenn Kasten</span>: No change? </span></p>

<p class="speaker"><span class="line" data-starttime="1660"><span class="speakerName">Raph Levien</span>: Well, </span><span class="line" data-startTime="1660">almost no change. </span><span class="line" data-startTime="1662">There was some reduction in </span><span class="line" data-startTime="1662">latency, but nowhere nearly as </span><span class="line" data-startTime="1665">much as I would have liked. </span><span class="line" data-startTime="1666">Keep in mind, I'd already made </span><span class="line" data-startTime="1666">all of the obvious changes. </span><span class="line" data-startTime="1669">I had rewritten my synthesis </span><span class="line" data-startTime="1669">engine in C++. </span><span class="line" data-startTime="1671">I was running in the open SL </span><span class="line" data-startTime="1671">callback, so my code would run </span><span class="line" data-startTime="1674">at that same high priority </span><span class="line" data-startTime="1674">scheduling. </span><span class="line" data-startTime="1676">The obvious conclusion was </span><span class="line" data-startTime="1676">that my app was to blame. </span><span class="line" data-startTime="1679">So I started profiling. </span><span class="line" data-startTime="1681">What I found surprised </span><span class="line" data-startTime="1681">me a little bit. </span><span class="line" data-startTime="1682">When I looked at my jitter </span><span class="line" data-startTime="1682">measurements in the new build, </span><span class="line" data-startTime="1685">they were terrible. </span><span class="line" data-startTime="1686">I knew Glenn had measured much </span><span class="line" data-startTime="1686">better jitter than this in his </span><span class="line" data-startTime="1689">build, so I asked him </span><span class="line" data-startTime="1689">what was going on. </span></p>

<p class="speaker"><span class="line" data-starttime="1691"><span class="speakerName">Glenn Kasten</span>: I was really </span><span class="line" data-startTime="1691">stumped too until I asked Raph </span><span class="line" data-startTime="1694">was sample rate he was using, </span><span class="line" data-startTime="1694">and he said 44.1, which is </span><span class="line" data-startTime="1696">what was used on the Nexus </span><span class="line" data-startTime="1696">7 and the Galaxy Nexus. </span><span class="line" data-startTime="1700">But it turns out the Nexus 4 </span><span class="line" data-startTime="1700">runs natively at 48 kilohertz. </span></p>

<p class="speaker"><span class="line" data-starttime="1704"><span class="speakerName">Raph Levien</span>: So my buffers </span><span class="line" data-startTime="1704">had to go through </span><span class="line" data-startTime="1706">the sample rate converter. </span><span class="line" data-startTime="1707">And the sample rate converter </span><span class="line" data-startTime="1707">is not on the fast path. </span><span class="line" data-startTime="1712">Here's another plot that </span><span class="line" data-startTime="1712">shows a related issue. </span><span class="line" data-startTime="1715">This isn't as bad as </span><span class="line" data-startTime="1715">the first one. </span><span class="line" data-startTime="1716">There's only about a five </span><span class="line" data-startTime="1716">millisecond variation </span><span class="line" data-startTime="1718">in start time here. </span><span class="line" data-startTime="1719">But there's something </span><span class="line" data-startTime="1719">weird about it. </span><span class="line" data-startTime="1720">The stripes in the data make me </span><span class="line" data-startTime="1720">think I'm looking at some </span><span class="line" data-startTime="1722">kind of periodic process, </span><span class="line" data-startTime="1722">not just random noise. </span><span class="line" data-startTime="1725">Let's zoom in and see if </span><span class="line" data-startTime="1725">we can find a pattern. </span></p>

<p class="speaker"><span class="line" data-starttime="1728"><span class="speakerName">Glenn Kasten</span>: Yeah, that looks </span><span class="line" data-startTime="1728">like a pattern to me. </span></p>

<p class="speaker"><span class="line" data-starttime="1730"><span class="speakerName">Raph Levien</span>: It's </span><span class="line" data-startTime="1730">pretty regular. </span><span class="line" data-startTime="1732">Looks like every 16 buffers, </span><span class="line" data-startTime="1732">I get my callback late. </span><span class="line" data-startTime="1735">It turns out this was because </span><span class="line" data-startTime="1735">of another assumption I had </span><span class="line" data-startTime="1737">made that didn't hold </span><span class="line" data-startTime="1737">true on the Nexus 4. </span><span class="line" data-startTime="1740">I had set my buffer size </span><span class="line" data-startTime="1740">to 256, which was </span><span class="line" data-startTime="1742">a convenient size. </span></p>

<p class="speaker"><span class="line" data-starttime="1743"><span class="speakerName">Glenn Kasten</span>: What Raph didn't </span><span class="line" data-startTime="1743">know at the time was that on </span><span class="line" data-startTime="1746">the Nexus 4, our native buffer </span><span class="line" data-startTime="1746">size was 240 frames, not 256. </span><span class="line" data-startTime="1751">And the greatest common divisor </span><span class="line" data-startTime="1751">of those two is &mdash; </span></p>

<p class="speaker"><span class="line" data-starttime="1754"><span class="speakerName">Raph Levien</span>: 16. </span><span class="line" data-startTime="1757">So that's the next item on your </span><span class="line" data-startTime="1757">to do list &mdash; adapt your </span><span class="line" data-startTime="1760">buffer size and sample </span><span class="line" data-startTime="1760">rate to match what </span><span class="line" data-startTime="1762">the system is using. </span><span class="line" data-startTime="1763">But how do you know what </span><span class="line" data-startTime="1763">buffer size and </span><span class="line" data-startTime="1765">sample rate to use? </span><span class="line" data-startTime="1768">This is something &mdash; </span><span class="line" data-startTime="1768">next slide &mdash; </span><span class="line" data-startTime="1770">this is something that not </span><span class="line" data-startTime="1770">only is there variation </span><span class="line" data-startTime="1772">between devices, but </span><span class="line" data-startTime="1772">it can change even </span><span class="line" data-startTime="1775">across Android versions. </span><span class="line" data-startTime="1776">In the early days, I struggled </span><span class="line" data-startTime="1776">with this a lot. </span></p>

<p class="speaker"><span class="line" data-starttime="1779"><span class="speakerName">Glenn Kasten</span>: I asked Raph what </span><span class="line" data-startTime="1779">does he want in the next </span><span class="line" data-startTime="1782">version of the Android </span><span class="line" data-startTime="1782">audio platform to </span><span class="line" data-startTime="1785">better support apps. </span><span class="line" data-startTime="1786">And the top of this list was an </span><span class="line" data-startTime="1786">API to return this kind of </span><span class="line" data-startTime="1789">information &mdash; </span><span class="line" data-startTime="1789">native buffer size, native </span><span class="line" data-startTime="1789">sample rate. </span><span class="line" data-startTime="1792">And that shift in </span><span class="line" data-startTime="1792">API level 17 &mdash; </span><span class="line" data-startTime="1795">we'll give you a link </span><span class="line" data-startTime="1795">to how to do that at </span><span class="line" data-startTime="1797">the end of this talk. </span></p>

<p class="speaker"><span class="line" data-starttime="1799"><span class="speakerName">Raph Levien</span>: Here's a snippet </span><span class="line" data-startTime="1799">from my app showing how I use </span><span class="line" data-startTime="1801">a new sample rate and buffer </span><span class="line" data-startTime="1801">size properties to set up my </span><span class="line" data-startTime="1803">synth engine. </span><span class="line" data-startTime="1804">After I hooked it up, I found </span><span class="line" data-startTime="1804">that my synth went from eight </span><span class="line" data-startTime="1807">voices to 20. </span><span class="line" data-startTime="1808">Finally, I was beating the </span><span class="line" data-startTime="1808">30-year-old synthesizer I was </span><span class="line" data-startTime="1811">trying to emulate. </span><span class="line" data-startTime="1814">Now, let's take a look at an </span><span class="line" data-startTime="1814">audible glitch that was really </span><span class="line" data-startTime="1817">difficult to track down. </span></p>

<p class="speaker"><span class="line" data-starttime="1818"><span class="speakerName">Glenn Kasten</span>: You're going to </span><span class="line" data-startTime="1818">want to pay special attention </span><span class="line" data-startTime="1819">to this, because even though </span><span class="line" data-startTime="1819">we are going to be using </span><span class="line" data-startTime="1822">Raph's code as an example here </span><span class="line" data-startTime="1822">today, we've seen similar </span><span class="line" data-startTime="1825">issues to this throughout the </span><span class="line" data-startTime="1825">audio platform and in other </span><span class="line" data-startTime="1830">applications. </span><span class="line" data-startTime="1831">And it's really hard </span><span class="line" data-startTime="1831">to track down. </span></p>

<p class="speaker"><span class="line" data-starttime="1834"><span class="speakerName">Raph Levien</span>: Here's a plot </span><span class="line" data-startTime="1834">of the bug in action. </span> <span class="line" data-startTime="1836">What you're seeing is the start </span><span class="line" data-startTime="1836">and end times of each </span><span class="line" data-startTime="1838">buffer callback. </span> <span class="line" data-startTime="1839">Start time is blue, the </span><span class="line" data-startTime="1839">end time is red. </span> <span class="line" data-startTime="1841">Most of the time the start and </span><span class="line" data-startTime="1841">end times are so close that </span><span class="line" data-startTime="1844">you almost can't tell </span><span class="line" data-startTime="1844">them apart. </span> <span class="line" data-startTime="1846">What's happening at the </span><span class="line" data-startTime="1846">beginning here? </span><span class="line" data-startTime="1847">Let's zoom in and </span><span class="line" data-startTime="1847">check it out. </span> <span class="line" data-startTime="1849">Here's a closer look. </span> <span class="line" data-startTime="1850">The callback started </span><span class="line" data-startTime="1850">right on time. </span> <span class="line" data-startTime="1852">But the end time is </span><span class="line" data-startTime="1852">way out there. </span> <span class="line" data-startTime="1855">It looks like the callback </span><span class="line" data-startTime="1855">took about 16 </span><span class="line" data-startTime="1858">milliseconds to process. </span> <span class="line" data-startTime="1860">That was enough to cause a </span><span class="line" data-startTime="1860">dropout and skip a couple of </span><span class="line" data-startTime="1862">buffers, which is what all of </span><span class="line" data-startTime="1862">the subsequent callbacks that </span><span class="line" data-startTime="1864">recorded is showing up </span><span class="line" data-startTime="1864">10 milliseconds late. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="1867"><span class="speakerName">Glenn Kasten</span>: This time </span><span class="line" data-startTime="1867">I didn't have an </span><span class="line" data-startTime="1868">easy answer for Raph. </span> <span class="line" data-startTime="1869">But we did have a new tool for </span><span class="line" data-startTime="1869">investigating performance </span><span class="line" data-startTime="1872">problems, sys trace. </span> <span class="line" data-startTime="1874">And I know that that </span><span class="line" data-startTime="1874">would be good for </span><span class="line" data-startTime="1875">investigating this problem. </span> <span class="line" data-startTime="1879">Sys trace basically collects the </span><span class="line" data-startTime="1879">same kind of data that I'd </span><span class="line" data-startTime="1882">been collecting with </span><span class="line" data-startTime="1882">my manual home brew </span><span class="line" data-startTime="1885">context switch recorder. </span> <span class="line" data-startTime="1886">But it's much easier to use and </span><span class="line" data-startTime="1886">has a really attractive </span><span class="line" data-startTime="1889">user interface. </span> <span class="line" data-startTime="1892">We're going to show you a sys </span><span class="line" data-startTime="1892">trace first of some good audio </span><span class="line" data-startTime="1895">playback and then </span><span class="line" data-startTime="1895">a bad sys trace. </span> <span class="line" data-startTime="1897">First, here's a sys </span><span class="line" data-startTime="1897">trace of audio </span><span class="line" data-startTime="1899">playback working correctly. </span> <span class="line" data-startTime="1901">You're going to see every five </span><span class="line" data-startTime="1901">milliseconds the fast mixer </span><span class="line" data-startTime="1903">thread is the one in red. </span></p>

<p><span class="line" data-startTime="1907">It writes out a buffer of audio </span><span class="line" data-startTime="1907">to the hardware, then it </span><span class="line" data-startTime="1910">wakes up the audio track </span><span class="line" data-startTime="1910">thread, which </span><span class="line" data-startTime="1912">is part of the client. </span> <span class="line" data-startTime="1913">And that's the one in green, </span><span class="line" data-startTime="1913">which is actually part of your </span><span class="line" data-startTime="1916">application. </span> <span class="line" data-startTime="1918">And that's the thread that's </span><span class="line" data-startTime="1918">generating the </span><span class="line" data-startTime="1919">next buffer of audio. </span> <span class="line" data-startTime="1921">Then that computes beautiful </span><span class="line" data-startTime="1921">FM sounds for a couple </span><span class="line" data-startTime="1924">milliseconds and queues </span><span class="line" data-startTime="1924">its buffer, which </span><span class="line" data-startTime="1926">goes to the fast mixer. </span></p>

<p><span class="line" data-startTime="1927">And then it goes back to sleep </span><span class="line" data-startTime="1927">for the next callback. </span></p>

<p class="speaker"><span class="line" data-starttime="1931"><span class="speakerName">Raph Levien</span>: So around </span><span class="line" data-startTime="1931">here, we see </span><span class="line" data-startTime="1932">something else happening. </span><span class="line" data-startTime="1933">The UI thread of the </span><span class="line" data-startTime="1933">synthesizer, which is purple, </span><span class="line" data-startTime="1936">wakes up and starts computing. </span><span class="line" data-startTime="1937">But both the fast mixer and the </span><span class="line" data-startTime="1937">audio track threads are </span><span class="line" data-startTime="1939">higher priorities. </span><span class="line" data-startTime="1940">So when it's time for them </span><span class="line" data-startTime="1940">to wake up, the scheduler </span><span class="line" data-startTime="1944">suspends the UI thread and lets </span><span class="line" data-startTime="1944">the high priority audio </span><span class="line" data-startTime="1946">threads run. </span><span class="line" data-startTime="1947">So that's good. </span><span class="line" data-startTime="1948">No audible glitch here. </span></p>

<p class="speaker"><span class="line" data-starttime="1951"><span class="speakerName">Glenn Kasten</span>: But something </span><span class="line" data-startTime="1951">still looks a </span><span class="line" data-startTime="1952">little funny here. </span><span class="line" data-startTime="1953">The audio track thread looks </span><span class="line" data-startTime="1953">like it's been split in two. </span><span class="line" data-startTime="1958">Zooming in, we see our UI thread </span><span class="line" data-startTime="1958">being scheduled, even </span><span class="line" data-startTime="1961">though the audio thread should </span><span class="line" data-startTime="1961">be higher priority. </span><span class="line" data-startTime="1963">What's going on? </span></p>

<p class="speaker"><span class="line" data-starttime="1965"><span class="speakerName">Raph Levien</span>: Turns out that </span><span class="line" data-startTime="1965">when that thread went to </span><span class="line" data-startTime="1966">sleep, it was holding a mutex </span><span class="line" data-startTime="1966">belonging to the allocator. </span> <span class="line" data-startTime="1969">Then when the audio callback </span><span class="line" data-startTime="1969">went to allocate some memory, </span><span class="line" data-startTime="1972">it tried to take the </span><span class="line" data-startTime="1972">mutex and blocked. </span> <span class="line" data-startTime="1974">The only other thread to </span><span class="line" data-startTime="1974">run is the UI thread. </span> <span class="line" data-startTime="1977">So the scheduler wakes it up. </span> <span class="line" data-startTime="1978">Then it releases the mutex. </span> <span class="line" data-startTime="1979">And boom &mdash; the audio thread </span><span class="line" data-startTime="1979">is runnable again. </span> <span class="line" data-startTime="1982">It's higher priority, so the </span><span class="line" data-startTime="1982">scheduler bumps the UI thread </span><span class="line" data-startTime="1985">and lets the audio thread </span><span class="line" data-startTime="1985">run to completion. </span> <span class="line" data-startTime="1987">And we get our buffer </span><span class="line" data-startTime="1987">to the mixer with </span><span class="line" data-startTime="1989">plenty of time to spare. </span> <span class="line" data-startTime="1990">This time we were lucky. </span></p>

<p class="speaker"><span class="line" data-starttime="1993"><span class="speakerName">Glenn Kasten</span>: This time. </span> <span class="line" data-startTime="1993">This wasn't our audible </span><span class="line" data-startTime="1993">glitch. </span> <span class="line" data-startTime="1995">But let's keep looking. </span> <span class="line" data-startTime="1996">So to help us out, I added a new </span><span class="line" data-startTime="1996">sys trace counter for us </span><span class="line" data-startTime="1999">for audio called f ready, which </span><span class="line" data-startTime="1999">basically is the number </span><span class="line" data-startTime="2002">of frames that the application </span><span class="line" data-startTime="2002">is providing </span><span class="line" data-startTime="2004">to the audio mixer. </span> <span class="line" data-startTime="2005">You want that to always be </span><span class="line" data-startTime="2005">high, high enough for the </span><span class="line" data-startTime="2009">mixture to be able to read </span><span class="line" data-startTime="2009">the next data from the </span><span class="line" data-startTime="2011">application. </span> <span class="line" data-startTime="2012">And as you can see, most of the </span><span class="line" data-startTime="2012">time it's 480, which is </span><span class="line" data-startTime="2014">two buffers worth. </span> <span class="line" data-startTime="2017">But around 1.1 seconds into the </span><span class="line" data-startTime="2017">sys trace, we can see it </span><span class="line" data-startTime="2020">dropping down to zero. </span> <span class="line" data-startTime="2021">That's definitely going </span><span class="line" data-startTime="2021">to cause a glitch &mdash; </span><span class="line" data-startTime="2023">no question. </span></p>

<p><span class="line" data-startTime="2024">Sys traces is a great tool </span><span class="line" data-startTime="2024">for finding these kind of </span><span class="line" data-startTime="2027">performance problems. </span> <span class="line" data-startTime="2028">It's much easier to see them </span><span class="line" data-startTime="2028">than to listen for them. </span> <span class="line" data-startTime="2033">So we have a glitch. </span> <span class="line" data-startTime="2035">Let's zoom in and see </span><span class="line" data-startTime="2035">if we can figure out </span><span class="line" data-startTime="2037">exactly what's happening. </span> <span class="line" data-startTime="2039">At the arrow here, our </span><span class="line" data-startTime="2039">user interface </span><span class="line" data-startTime="2041">thread, UI, stop running. </span> <span class="line" data-startTime="2043">And it turns out it's holding </span><span class="line" data-startTime="2043">a mutex for a memory </span><span class="line" data-startTime="2046">allocation. </span></p>

<p><span class="line" data-startTime="2047">Then a whole bunch of </span><span class="line" data-startTime="2047">other stuff runs. </span> <span class="line" data-startTime="2049">And it looks like </span><span class="line" data-startTime="2049">UEventObserver &mdash; </span><span class="line" data-startTime="2052">then the usual. </span> <span class="line" data-startTime="2054">Fast mixer wakes up. </span> <span class="line" data-startTime="2057">That wakes up audio track. </span> <span class="line" data-startTime="2059">But at the arrow, the </span><span class="line" data-startTime="2059">audio track tries to </span><span class="line" data-startTime="2061">allocate some memory. </span> <span class="line" data-startTime="2062">And that's going to block. </span> <span class="line" data-startTime="2064">The UI thread was holding </span><span class="line" data-startTime="2064">the mutex </span><span class="line" data-startTime="2066">for the memory allocator. </span></p>

<p class="speaker"><span class="line" data-starttime="2068"><span class="speakerName">Raph Levien</span>: Remember the last </span><span class="line" data-startTime="2068">time this happened, the UI </span><span class="line" data-startTime="2070">thread was the only thing </span><span class="line" data-startTime="2070">ready to run. </span><span class="line" data-startTime="2071">That's why we were so lucky </span><span class="line" data-startTime="2071">there was nothing else for the </span><span class="line" data-startTime="2074">kernel to schedule. </span><span class="line" data-startTime="2075">So the UI thread did its 30 </span><span class="line" data-startTime="2075">microseconds worth of work and </span><span class="line" data-startTime="2078">unblocked this. </span><span class="line" data-startTime="2079">This time, we're not nearly as </span><span class="line" data-startTime="2079">lucky, because there's tons of </span><span class="line" data-startTime="2081">other threads that want to run, </span><span class="line" data-startTime="2081">and the scheduler isn't </span><span class="line" data-startTime="2084">smart enough to realize that it </span><span class="line" data-startTime="2084">needs to run the UI thread </span><span class="line" data-startTime="2086">in order to unblock </span><span class="line" data-startTime="2086">the audio thread. </span><span class="line" data-startTime="2089">The fast mixer keeps waking up, </span><span class="line" data-startTime="2089">but every time it does, </span><span class="line" data-startTime="2092">there's no audio. </span><span class="line" data-startTime="2093">We were blocked. </span><span class="line" data-startTime="2094">So f radio runs out, and </span><span class="line" data-startTime="2094">we hear a glitch. </span><span class="line" data-startTime="2097">It isn't until 1141 milliseconds </span><span class="line" data-startTime="2097">in this trace </span><span class="line" data-startTime="2100">that the UI thread finally gets </span><span class="line" data-startTime="2100">scheduled again, then </span><span class="line" data-startTime="2103">releases a mutex and the </span><span class="line" data-startTime="2103">callback can run. </span></p>

<p class="speaker"><span class="line" data-starttime="2106"><span class="speakerName">Glenn Kasten</span>: So this is known </span><span class="line" data-startTime="2106">as classic priority inversion. </span><span class="line" data-startTime="2108">Basically, it means that a high </span><span class="line" data-startTime="2108">priority thread is being </span><span class="line" data-startTime="2110">blocked by a lower priority </span><span class="line" data-startTime="2110">thread that's holding a </span><span class="line" data-startTime="2113">resource, such as a mutex. </span><span class="line" data-startTime="2116">And some operating systems have </span><span class="line" data-startTime="2116">special logic, especially </span><span class="line" data-startTime="2119">in their mutexes, to </span><span class="line" data-startTime="2119">handle this case. </span><span class="line" data-startTime="2121">But Android is not using </span><span class="line" data-startTime="2121">that feature. </span></p>

<p class="speaker"><span class="line" data-starttime="2123"><span class="speakerName">Raph Levien</span>: Here's </span><span class="line" data-startTime="2123">the funny thing. </span><span class="line" data-startTime="2124">I know about priority </span><span class="line" data-startTime="2124">inversions. </span><span class="line" data-startTime="2126">I wrote my code very </span><span class="line" data-startTime="2126">carefully. </span><span class="line" data-startTime="2127">I didn't take any mutexes, or </span><span class="line" data-startTime="2127">allocate any memory &mdash; anything </span><span class="line" data-startTime="2130">they could block. </span><span class="line" data-startTime="2131">Yet the sys trace clearly showed </span><span class="line" data-startTime="2131">that the thread was </span><span class="line" data-startTime="2133">blocking on the mutex. </span><span class="line" data-startTime="2135">Tracing further, I found that </span><span class="line" data-startTime="2135">the sprintf call I was using </span><span class="line" data-startTime="2138">to generate a log line </span><span class="line" data-startTime="2138">was blocking. </span></p>

<p class="speaker"><span class="line" data-starttime="2141"><span class="speakerName">Glenn Kasten</span>: Sprintf </span><span class="line" data-startTime="2141">of all things. </span><span class="line" data-startTime="2146">So turns out I ran into a </span><span class="line" data-startTime="2146">similar issue when I was </span><span class="line" data-startTime="2149">working on the audio </span><span class="line" data-startTime="2149">fast path. </span><span class="line" data-startTime="2151">I had a thread that was calling </span><span class="line" data-startTime="2151">into another server by </span><span class="line" data-startTime="2155">IPC, inter-process </span><span class="line" data-startTime="2155">communication, via binder. </span><span class="line" data-startTime="2158">And I knew about classic mutex </span><span class="line" data-startTime="2158">priority inversion. </span><span class="line" data-startTime="2161">It's a well known issue. </span><span class="line" data-startTime="2163">But I didn't think about </span><span class="line" data-startTime="2163">the risks of IPC. </span></p>

<p class="speaker"><span class="line" data-starttime="2166"><span class="speakerName">Raph Levien</span>: There are </span><span class="line" data-startTime="2166">a bunch of ways to </span><span class="line" data-startTime="2167">deal with this problem. </span><span class="line" data-startTime="2168">But for this kind of thing, </span><span class="line" data-startTime="2168">the simplest is to use </span><span class="line" data-startTime="2170">non-blocking techniques. </span><span class="line" data-startTime="2171">Don't ever take a mutex on </span><span class="line" data-startTime="2171">the audio callback either </span><span class="line" data-startTime="2174">explicitly or implicitly through </span><span class="line" data-startTime="2174">things like memory </span><span class="line" data-startTime="2177">allocation. </span></p>

<p class="speaker"><span class="line" data-starttime="2179"><span class="speakerName">Glenn Kasten</span>: One really simple </span><span class="line" data-startTime="2179">among the non-blocking </span><span class="line" data-startTime="2182">techniques is, way of avoiding </span><span class="line" data-startTime="2182">blocking, is single reader, </span><span class="line" data-startTime="2187">single writer ring buffers. </span><span class="line" data-startTime="2188">It's really easy to write. </span><span class="line" data-startTime="2189">It's simple to understand, and </span><span class="line" data-startTime="2189">it works really well for </span><span class="line" data-startTime="2192">shuttling either small </span><span class="line" data-startTime="2192">or large amounts of </span><span class="line" data-startTime="2194">data between threads. </span><span class="line" data-startTime="2195">It's commonly used in audio </span><span class="line" data-startTime="2195">applications for this reason. </span></p>

<p class="speaker"><span class="line" data-starttime="2198"><span class="speakerName">Raph Levien</span>: Here's how </span><span class="line" data-startTime="2198">I used it in my app. </span><span class="line" data-startTime="2200">A Java app puts its MIDI bytes </span><span class="line" data-startTime="2200">into the ring buffer. </span><span class="line" data-startTime="2203">Then the C++ takes </span><span class="line" data-startTime="2203">the bytes out. </span><span class="line" data-startTime="2205">Checking how many bytes are </span><span class="line" data-startTime="2205">available and reading them can </span><span class="line" data-startTime="2208">both be done without blocking. </span><span class="line" data-startTime="2209">If you weren't in a soft real </span><span class="line" data-startTime="2209">time context, you'd probably </span><span class="line" data-startTime="2212">use a mutex for this instead. </span><span class="line" data-startTime="2214">Do keep in mind, though, that </span><span class="line" data-startTime="2214">you still need to use memory </span><span class="line" data-startTime="2216">barriers because ARM has a </span><span class="line" data-startTime="2216">weekly ordered memory model. </span><span class="line" data-startTime="2219">X86 has a total store order, </span><span class="line" data-startTime="2219">so if you've implemented a </span><span class="line" data-startTime="2222">ring buffer there, you </span><span class="line" data-startTime="2222">may not be aware </span><span class="line" data-startTime="2223">you need these barriers. </span><span class="line" data-startTime="2225">If none of this makes sense </span><span class="line" data-startTime="2225">to you, just use </span><span class="line" data-startTime="2226">existing correct code. </span></p>

<p class="speaker"><span class="line" data-starttime="2228"><span class="speakerName">Glenn Kasten</span>: And definitely </span><span class="line" data-startTime="2228">don't call sprintf. </span><span class="line" data-startTime="2231">So let's see what your new graph </span><span class="line" data-startTime="2231">looks like now that you </span><span class="line" data-startTime="2233">fixed your priority inversion. </span></p>

<p class="speaker"><span class="line" data-starttime="2234"><span class="speakerName">Raph Levien</span>: You bet. </span><span class="line" data-startTime="2235">Here it is. </span><span class="line" data-startTime="2236">And here it is contracted </span><span class="line" data-startTime="2236">for drift. </span><span class="line" data-startTime="2238">Now, it's looking clean. </span><span class="line" data-startTime="2239">The outliers are gone. </span><span class="line" data-startTime="2241">All of the code is strictly </span><span class="line" data-startTime="2241">non-blocking. </span><span class="line" data-startTime="2243">You do see some weird little </span><span class="line" data-startTime="2243">ups and down because of the </span><span class="line" data-startTime="2245">power management system changing </span><span class="line" data-startTime="2245">the clock frequency, </span><span class="line" data-startTime="2247">but that's OK. </span><span class="line" data-startTime="2249">Even at the lowest clock </span><span class="line" data-startTime="2249">frequency, everything is </span><span class="line" data-startTime="2250">happening under two </span><span class="line" data-startTime="2250">milliseconds, which is </span><span class="line" data-startTime="2252">properly quick. </span><span class="line" data-startTime="2253">This might not seem like it </span><span class="line" data-startTime="2253">looks better than the previous </span><span class="line" data-startTime="2255">plot, but take a look </span><span class="line" data-startTime="2255">at the scale. </span></p>

<p class="speaker"><span class="line" data-starttime="2258"><span class="speakerName">Glenn Kasten</span>: That's </span><span class="line" data-startTime="2258">a one and a two. </span><span class="line" data-startTime="2260">The start times are all </span><span class="line" data-startTime="2260">clustered together </span><span class="line" data-startTime="2262">the way we like them. </span><span class="line" data-startTime="2263">But the end times are still </span><span class="line" data-startTime="2263">a little bit weird. </span><span class="line" data-startTime="2266">It looks like there's </span><span class="line" data-startTime="2266">two bands. </span><span class="line" data-startTime="2268">What's going on there? </span></p>

<p class="speaker"><span class="line" data-starttime="2268"><span class="speakerName">Raph Levien</span>: My synth was </span><span class="line" data-startTime="2268">doing its computation in </span><span class="line" data-startTime="2270">blocks of 64 samples because </span><span class="line" data-startTime="2270">it's convenient. </span> <span class="line" data-startTime="2273">Lots of other libraries </span><span class="line" data-startTime="2273">do that too. </span> <span class="line" data-startTime="2275">Remember, the Nexus 4 buffer </span><span class="line" data-startTime="2275">is 240 samples long. </span> <span class="line" data-startTime="2278">So sometimes we'd compute </span><span class="line" data-startTime="2278">256, other times, 192. </span> <span class="line" data-startTime="2282">That variation explains </span><span class="line" data-startTime="2282">the two bands. </span> <span class="line" data-startTime="2284">This is a nice optimization, </span><span class="line" data-startTime="2284">and it took my synth from </span><span class="line" data-startTime="2286">about 20 to 30 voices </span><span class="line" data-startTime="2286">of polyphony. </span> <span class="line" data-startTime="2289">After this, I took it the rest </span><span class="line" data-startTime="2289">of the way with some old </span><span class="line" data-startTime="2292">fashioned cache optimization </span><span class="line" data-startTime="2292">and SIMD magic. </span> <span class="line" data-startTime="2295">So now it's up to 64 voices. </span> <span class="line" data-startTime="2297">Between Glenn's work on the </span><span class="line" data-startTime="2297">system and my optimizations in </span><span class="line" data-startTime="2300">this synth engine, my </span><span class="line" data-startTime="2300">DX7 app is starting </span><span class="line" data-startTime="2301">to look pretty good. </span></p>

<p></p>

<p class="speaker"><span class="line" data-starttime="2303"><span class="speakerName">Glenn Kasten</span>: This is where </span><span class="line" data-startTime="2303">things stand for some devices. </span><span class="line" data-startTime="2307">That's right. </span><span class="line" data-startTime="2308">You knew there had to be a </span><span class="line" data-startTime="2308">catch, because as soon as we </span><span class="line" data-startTime="2311">started testing this design on </span><span class="line" data-startTime="2311">a wider variety of devices, </span><span class="line" data-startTime="2314">things started to get </span><span class="line" data-startTime="2314">more complicated. </span></p>

<p class="speaker"><span class="line" data-starttime="2316"><span class="speakerName">Raph Levien</span>: The core </span><span class="line" data-startTime="2316">of what Glenn did is </span><span class="line" data-startTime="2318">valid on every device. </span><span class="line" data-startTime="2319">But each device has its own set </span><span class="line" data-startTime="2319">of bugs &mdash; power management </span><span class="line" data-startTime="2322">issues, driver bugs, or </span><span class="line" data-startTime="2322">scheduling snafus. </span><span class="line" data-startTime="2325">And each one of those has to </span><span class="line" data-startTime="2325">be solved individually. </span></p>

<p class="speaker"><span class="line" data-starttime="2327"><span class="speakerName">Glenn Kasten</span>: If you want to, </span><span class="line" data-startTime="2327">catch me during office hours. </span><span class="line" data-startTime="2329">I'll tell you some </span><span class="line" data-startTime="2329">war stories. </span><span class="line" data-startTime="2332">So that's the last thing on my </span><span class="line" data-startTime="2332">to do list is to work with our </span><span class="line" data-startTime="2335">hardware partners to track down </span><span class="line" data-startTime="2335">these crazy kernel driver </span><span class="line" data-startTime="2338">and hardware issues that can </span><span class="line" data-startTime="2338">affect audio performance. </span><span class="line" data-startTime="2341">I'm committed to it. </span><span class="line" data-startTime="2342">We're committed to it. </span><span class="line" data-startTime="2344">But we're not there yet. </span></p>

<p class="speaker"><span class="line" data-starttime="2345"><span class="speakerName">Raph Levien</span>: But we are moving </span><span class="line" data-startTime="2345">in the right direction. </span></p>

<p class="speaker"><span class="line" data-starttime="2347"><span class="speakerName">Glenn Kasten</span>: Yes we are. </span></p>

<p class="speaker"><span class="line" data-starttime="2349"><span class="speakerName">Raph Levien</span>: If you have some </span><span class="line" data-startTime="2349">questions or would like to see </span><span class="line" data-startTime="2351">more data, come see us in the </span><span class="line" data-startTime="2351">Android office hours area </span><span class="line" data-startTime="2354">right after this presentation. </span></p>

<p class="speaker"><span class="line" data-starttime="2358"><span class="speakerName">Glenn Kasten</span>: We put together a </span><span class="line" data-startTime="2358">website for all of you with </span><span class="line" data-startTime="2362">a lot of good audio performance </span><span class="line" data-startTime="2362">resources. </span><span class="line" data-startTime="2365">So this QR code has a short link </span><span class="line" data-startTime="2365">to it, and there's also </span><span class="line" data-startTime="2368">the long link there </span><span class="line" data-startTime="2368">if you prefer &mdash; </span><span class="line" data-startTime="2371">codegoogle.com/p </span><span class="line" data-startTime="2371">/high-performance-audio. </span><span class="line" data-startTime="2375">Lots and lots of resources </span><span class="line" data-startTime="2375">there. </span><span class="line" data-startTime="2376">And we do plan on continuing </span><span class="line" data-startTime="2376">to keep that website up to </span><span class="line" data-startTime="2379">date with more things as </span><span class="line" data-startTime="2379">we come across some. </span><span class="line" data-startTime="2383">So thank you all for coming. </span><span class="line" data-startTime="2385">[APPLAUSE] </span></p>

<p class="speaker"><span class="line" data-starttime="2390"><span class="speakerName">Glenn Kasten</span>: And again, please </span><span class="line" data-startTime="2390">fill the review forms. </span><span class="line" data-startTime="2394">And let's talk at </span><span class="line" data-startTime="2394">office hours. </span></p>

<p class="speaker"><span class="line" data-starttime="2396"><span class="speakerName">Raph Levien</span>: See you there. </span><span class="line" data-startTime="2397">Thank you. </span></p>